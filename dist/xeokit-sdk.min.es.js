/**
 * xeokit-sdk v2.6.87
 *  Commit: 8fcdaeda55a3bd75b49a6cc6fe5d950fa3251f38
 *  Built: 2025-07-31T17:46:22.388Z
 */

class e{constructor(e,t){this.items=e||[],this._lastUniqueId=(t||0)+1}addItem(){let e;if(2===arguments.length){const t=arguments[0];if(e=arguments[1],this.items[t])throw"ID clash: '"+t+"'";return this.items[t]=e,t}for(e=arguments[0]||{};;){const t=this._lastUniqueId++;if(!this.items[t])return this.items[t]=e,t}}removeItem(e){const t=this.items[e];return delete this.items[e],t}}const t=new e;class i{constructor(e){this.id=e,this.parentItem=null,this.groups=[],this.menuElement=null,this.shown=!1,this.mouseOver=0}}class s{constructor(){this.items=[]}}class r{constructor(e,t,i,s,r){this.id=e,this.getTitle=t,this.doAction=i,this.getEnabled=s,this.getShown=r,this.itemElement=null,this.subMenu=null,this.enabled=!0}}class o{constructor(e={}){this._id=t.addItem(),this._context=null,this._enabled=!1,this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={},this._shown=!1,this._nextId=0,this._parentNode=e.parentNode||document.body,this._offsetParent=this._parentNode instanceof ShadowRoot?this._parentNode.host:this._parentNode,this._eventSubs={},!1!==e.hideOnMouseDown&&(this._parentNode.addEventListener("mousedown",(e=>{e.target.classList.contains("xeokit-context-menu-item")||this.hide()})),this._parentNode.addEventListener("touchstart",this._canvasTouchStartHandler=e=>{e.target.classList.contains("xeokit-context-menu-item")||this.hide()})),e.items&&(this.items=e.items),this._hideOnAction=!1!==e.hideOnAction,this.context=e.context,this.enabled=!1!==e.enabled,this.hide()}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let e=0,s=i.length;e<s;e++)i[e](t)}set items(e){this._clear(),this._itemsCfg=e||[],this._parseItems(e),this._createUI()}get items(){return this._itemsCfg}set enabled(e){(e=!!e)!==this._enabled&&(this._enabled=e,this._enabled||this.hide())}get enabled(){return this._enabled}set context(e){this._context=e}get context(){return this._context}show(e,t){this._context?this._enabled&&(this._shown||(this._hideAllMenus(),this._updateItemsTitles(),this._updateItemsEnabledStatus(),this._showMenu(this._rootMenu.id,e,t),this._updateSubMenuInfo(),this._shown=!0,this.fire("shown",{}))):console.error("ContextMenu cannot be shown without a context - set context first")}get shown(){return this._shown}hide(){this._enabled&&this._shown&&(this._hideAllMenus(),this._shown=!1,this.fire("hidden",{}))}destroy(){this._context=null,this._clear(),null!==this._id&&(t.removeItem(this._id),this._id=null)}_clear(){for(let e=0,t=this._menuList.length;e<t;e++){this._menuList[e].menuElement.remove()}this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={}}_parseItems(e){const t=e=>{const o=this._getNextId(),n=new i(o);for(let i=0,o=e.length;i<o;i++){const o=e[i],a=new s;n.groups.push(a);for(let e=0,i=o.length;e<i;e++){const i=o[e],s=i.items,l=s&&s.length>0,A=this._getNextId(),c=i.getTitle||(()=>i.title||""),h=i.doAction||i.callback||(()=>{}),u=i.getEnabled||(()=>!0),d=i.getShown||(()=>!0),p=new r(A,c,h,u,d);if(p.parentMenu=n,a.items.push(p),l){const e=t(s);p.subMenu=e,e.parentItem=p}this._itemList.push(p),this._itemMap[p.id]=p}}return this._menuList.push(n),this._menuMap[n.id]=n,n};this._rootMenu=t(e)}_getNextId(){return"ContextMenu_"+this._id+"_"+this._nextId++}_createUI(){const e=t=>{this._createMenuUI(t);const i=t.groups;for(let t=0,s=i.length;t<s;t++){const s=i[t].items;for(let t=0,i=s.length;t<i;t++){const i=s[t].subMenu;i&&e(i)}}};e(this._rootMenu)}_createMenuUI(e){const t=e.groups,i=[],s=document.createElement("div");if(s.classList.add("xeokit-context-menu",e.id),s.style.zIndex=3e5,s.style.position="absolute",i.push("<ul>"),t)for(let e=0,s=t.length;e<s;e++){const r=e,o=s,n=t[e].items;if(n)for(let e=0,t=n.length;e<t;e++){const s=n[e],a=s.subMenu,l=s.title||"";a?(i.push('<li id="'+s.id+'" class="xeokit-context-menu-item xeokit-context-menu-submenu">'+l+"</li>"),r===o-1||e<t-1||i.push('<li id="'+s.id+'" class="xeokit-context-menu-item-separator"></li>')):(i.push('<li id="'+s.id+'" class="xeokit-context-menu-item">'+l+"</li>"),r===o-1||e<t-1||i.push('<li id="'+s.id+'" class="xeokit-context-menu-item-separator"></li>'))}}i.push("</ul>");const r=i.join("");s.innerHTML=r,this._parentNode.appendChild(s),e.menuElement=s,s.style["border-radius"]="4px",s.style.display="none",s.style["z-index"]=3e5,s.style.background="white",s.style.border="1px solid black",s.style["box-shadow"]="0 4px 5px 0 gray",s.oncontextmenu=e=>{e.preventDefault()};const o=this;let n=null;if(t)for(let e=0,i=t.length;e<i;e++){const i=t[e].items;if(i)for(let e=0,t=i.length;e<t;e++){const t=i[e],s=t.subMenu;t.itemElement=this._parentNode.querySelector(`#${t.id}`),t.itemElement?(t.itemElement.addEventListener("mouseenter",(e=>{e.preventDefault();const i=t.subMenu;if(!i)return void(n&&(o._hideMenu(n.id),n=null));if(n&&n.id!==i.id&&(o._hideMenu(n.id),n=null),!1===t.enabled)return;const s=t.itemElement,r=i.menuElement,a=s.getBoundingClientRect();r.getBoundingClientRect();const l=o._offsetParent.getBoundingClientRect(),A=200,c=a.right+A<l.right,h=a.left-A>l.left;if(c)o._showMenu(i.id,a.right+window.scrollX-5,a.top+window.scrollY-1);else if(h)o._showMenu(i.id,a.left-A+window.scrollX,a.top+window.scrollY-1);else{const e=a.left-l.left,t=l.right-a.right;t>e?o._showMenu(i.id,a.right-5-(A-t),a.top+window.scrollY-1):o._showMenu(i.id,a.left-e,a.top+window.scrollY-1)}n=i})),s||(t.itemElement.addEventListener("click",(e=>{e.preventDefault(),o._context&&!1!==t.enabled&&(t.doAction&&t.doAction(o._context),this._hideOnAction?o.hide():(o._updateItemsTitles(),o._updateItemsEnabledStatus()))})),t.itemElement.addEventListener("mouseup",(e=>{3===e.which&&(e.preventDefault(),o._context&&!1!==t.enabled&&(t.doAction&&t.doAction(o._context),this._hideOnAction?o.hide():(o._updateItemsTitles(),o._updateItemsEnabledStatus())))})),t.itemElement.addEventListener("mouseenter",(e=>{e.preventDefault(),!1!==t.enabled&&t.doHover&&t.doHover(o._context)})))):console.error("ContextMenu item element not found: "+t.id)}}}_updateItemsTitles(){if(this._context)for(let e=0,t=this._itemList.length;e<t;e++){const t=this._itemList[e],i=t.itemElement;if(!i)continue;const s=t.getShown;if(!s||!s(this._context))continue;const r=t.getTitle(this._context);t.subMenu,i.innerText=r}}_updateItemsEnabledStatus(){if(this._context)for(let e=0,t=this._itemList.length;e<t;e++){const t=this._itemList[e],i=t.itemElement;if(!i)continue;const s=t.getEnabled;if(!s)continue;const r=t.getShown;if(!r)continue;const o=r(this._context);if(t.shown=o,!o){i.style.display="none";continue}i.style.display="";const n=s(this._context);t.enabled=n,n?i.classList.remove("disabled"):i.classList.add("disabled")}}_updateSubMenuInfo(){if(!this._context)return;let e,t,i,s,r,o;this._itemList.forEach((n=>{n.subMenu&&(e=n.itemElement,t=e.getBoundingClientRect(),i=n.subMenu.menuElement,s={visibility:i.style.visibility,display:i.style.display},i.style.display="block",i.style.visibility="hidden",o=n.subMenu.menuElement.getBoundingClientRect().width,i.style.visibility=s.visibility,i.style.display=s.display,r=t.right+o>window.innerWidth,e.setAttribute("data-submenuposition",r?"left":"right"))}))}_showMenu(e,t,i){const s=this._menuMap[e];if(!s)return void console.error("Menu not found: "+e);if(s.shown)return;const r=s.menuElement;r&&(this._showMenuElement(r,t,i),s.shown=!0)}_hideMenu(e){const t=this._menuMap[e];if(!t)return void console.error("Menu not found: "+e);if(!t.shown)return;const i=t.menuElement;i&&(this._hideMenuElement(i),t.shown=!1)}_hideAllMenus(){for(let e=0,t=this._menuList.length;e<t;e++){const t=this._menuList[e];this._hideMenu(t.id)}}_showMenuElement(e,t,i){e.style.display="block";const s=e.offsetHeight,r=e.offsetWidth,o=this._offsetParent.getBoundingClientRect(),n=this._offsetParent===window.document.body&&0===o.bottom?window.innerHeight:o.bottom+window.scrollY,a=o.right+window.scrollX;i+s>n&&(i=n-s),t+r>a&&(t=a-r),e.style.left=t-o.left-window.scrollX+"px",e.style.top=i-o.top-window.scrollY+"px"}_hideMenuElement(e){e.style.display="none"}}class n{constructor(e,t={}){this.viewer=e,this.scene=this.viewer.scene,this._lensCursorDiv=document.createElement("div"),this._lensParams={canvasSize:300,cursorBorder:2,cursorSize:10},this._lensCursorDiv.style.borderRadius="50%",this._lensCursorDiv.style.width=this._lensParams.cursorSize+"px",this._lensCursorDiv.style.height=this._lensParams.cursorSize+"px",this._lensCursorDiv.style.zIndex="100000",this._lensCursorDiv.style.position="absolute",this._lensCursorDiv.style.pointerEvents="none",this._lensContainer=document.createElement("div"),this._lensContainerId=t.containerId||"xeokit-lens",this._lensContainer.setAttribute("id",this._lensContainerId),this._lensContainer.style.border="1px solid black",this._lensContainer.style.background="white",this._lensContainer.style.borderRadius="50%",this._lensContainer.style.width=this._lensParams.canvasSize+"px",this._lensContainer.style.height=this._lensParams.canvasSize+"px",this._lensContainer.style.zIndex="15000",this._lensContainer.style.position="absolute",this._lensContainer.style.pointerEvents="none",this._lensContainer.style.visibility="hidden",this._lensCanvas=document.createElement("canvas"),this._lensCanvas.id=`${this._lensContainerId}-canvas`,this._lensCanvas.style.borderRadius="50%",this._lensCanvas.style.width=this._lensParams.canvasSize+"px",this._lensCanvas.style.height=this._lensParams.canvasSize+"px",this._lensCanvas.style.zIndex="15000",this._lensCanvas.style.pointerEvents="none",document.body.appendChild(this._lensContainer),this._lensContainer.appendChild(this._lensCanvas),this._lensContainer.appendChild(this._lensCursorDiv),this._lensCanvasContext=this._lensCanvas.getContext("2d"),this._canvasElement=this.viewer.scene.canvas.canvas,this._canvasPos=null,this._snappedCanvasPos=null,this._lensPosToggle=t.lensPosToggle||!0,this._lensPosToggleAmount=t.lensPosToggleAmount||85,this._lensPosMarginLeft=t.lensPosMarginLeft||85,this._lensPosMarginTop=t.lensPosMarginTop||25,this._lensContainer.style.marginTop=`${this._lensPosMarginTop}px`,this._lensContainer.style.marginLeft=`${this._lensPosMarginLeft}px`,this._zoomLevel=t.zoomLevel||2,this._active=!1!==t.active,this._visible=!1,this.snapped=!1,this._onViewerRendering=this.viewer.scene.on("rendering",(()=>{this._active&&this._visible&&this.update()}))}update(){if(!this._active||!this._visible)return;if(!this._canvasPos)return;const e=this._lensContainer.getBoundingClientRect(),t=this._canvasElement.getBoundingClientRect(),i=this._canvasPos[0]<e.right&&this._canvasPos[0]>e.left&&this._canvasPos[1]<e.bottom&&this._canvasPos[1]>e.top;this._lensContainer.style.marginLeft=`${this._lensPosMarginLeft}px`,i&&(this._lensPosToggle?this._lensContainer.style.marginTop=t.bottom-t.top-this._lensCanvas.height-this._lensPosToggleAmount+"px":this._lensContainer.style.marginTop=`${this._lensPosMarginTop}px`,this._lensPosToggle=!this._lensPosToggle),this._lensCanvasContext.clearRect(0,0,this._lensCanvas.width,this._lensCanvas.height);const s=Math.max(this._lensCanvas.width,this._lensCanvas.height)/this._zoomLevel;this._lensCanvasContext.drawImage(this._canvasElement,this._canvasPos[0]-s/2,this._canvasPos[1]-s/2,s,s,0,0,this._lensCanvas.width,this._lensCanvas.height);const r=this._lensParams.canvasSize/2-this._lensParams.cursorSize/2-this._lensParams.cursorBorder,o=this._snappedCanvasPos?this._snappedCanvasPos[0]-this._canvasPos[0]:0,n=this._snappedCanvasPos?this._snappedCanvasPos[1]-this._canvasPos[1]:0;this._lensCursorDiv.style.left=`${r+o*this._zoomLevel}px`,this._lensCursorDiv.style.top=`${r+n*this._zoomLevel}px`}set zoomFactor(e){this._zoomFactor=e,this.update()}get zoomFactor(){return this._zoomFactor}set canvasPos(e){this._canvasPos=e,this.update()}get canvasPos(){return this._canvasPos}set snappedCanvasPos(e){this._snappedCanvasPos=e,this.update()}get snappedCanvasPos(){return this._snappedCanvasPos}set snapped(e){this._snapped=e;const[t,i]=e?["greenyellow","green"]:["pink","red"];this._lensCursorDiv.style.background=t,this._lensCursorDiv.style.border=this._lensParams.cursorBorder+"px solid "+i}get snapped(){return this._snapped}_updateActiveVisible(){this._lensContainer.style.visibility=this._active&&this._visible?"visible":"hidden",this.update()}set active(e){this._active=e,this._updateActiveVisible()}get active(){return this._active}set visible(e){this._visible=e,this._updateActiveVisible()}get visible(){return this._visible}destroy(){this._destroyed||(this.viewer.scene.off(this._onViewerRendering),this._lensContainer.removeChild(this._lensCanvas),document.body.removeChild(this._lensContainer),this._destroyed=!0)}}let a=!0,l=a?Float64Array:Float32Array;const A=new l(3),c=new l(16),h=new l(16),u=new l(4),d={setDoublePrecisionEnabled(e){a=e,l=a?Float64Array:Float32Array},getDoublePrecisionEnabled:()=>a,MIN_DOUBLE:-Number.MAX_SAFE_INTEGER,MAX_DOUBLE:Number.MAX_SAFE_INTEGER,MAX_INT:1e7,DEGTORAD:.0174532925,RADTODEG:57.295779513,unglobalizeObjectId(e,t){const i=t.indexOf("#");return i===e.length&&t.startsWith(e)?t.substring(i+1):t},globalizeObjectId:(e,t)=>e+"#"+t,safeInv(e){const t=1/e;return isNaN(t)||!isFinite(t)?1:t},vec2:e=>new l(e||2),vec3:e=>new l(e||3),vec4:e=>new l(e||4),mat3:e=>new l(e||9),mat3ToMat4:(e,t=new l(16))=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=0,t[4]=e[3],t[5]=e[4],t[6]=e[5],t[7]=0,t[8]=e[6],t[9]=e[7],t[10]=e[8],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t),mat4:e=>new l(e||16),mat4ToMat3:(e,t=new l(9))=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t),doublesToFloats(e,t,i){const s=new l(2);for(let r=0,o=e.length;r<o;r++)d.splitDouble(e[r],s),t[r]=s[0],i[r]=s[1]},splitDouble(e,t){const i=l.from([e])[0],s=e-i;t[0]=i,t[1]=s},createUUID:(()=>{const e=[];for(let t=0;t<256;t++)e[t]=(t<16?"0":"")+t.toString(16);return()=>{const t=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return`${e[255&t]+e[t>>8&255]+e[t>>16&255]+e[t>>24&255]}-${e[255&i]}${e[i>>8&255]}-${e[i>>16&15|64]}${e[i>>24&255]}-${e[63&s|128]}${e[s>>8&255]}-${e[s>>16&255]}${e[s>>24&255]}${e[255&r]}${e[r>>8&255]}${e[r>>16&255]}${e[r>>24&255]}`}})(),clamp:(e,t,i)=>Math.max(t,Math.min(i,e)),fmod(e,t){if(e<t)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),e;for(;t<=e;)e-=t;return e},compareVec3:(e,t)=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2],compareVec4:(e,t)=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3],negateVec3:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t),negateVec4:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t),addVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i),addVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i),addVec3:(e,t,i)=>(i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i),addVec3Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i),subVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i),subVec3:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i),subVec2:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i),geometricMeanVec2(...e){const t=new l(e[0]);for(let i=1;i<e.length;i++)t[0]+=e[i][0],t[1]+=e[i][1];return t[0]/=e.length,t[1]/=e.length,t},subVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i),subScalarVec4:(e,t,i)=>(i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i),mulVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]*t[0],i[1]=e[1]*t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3],i),mulVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i),mulVec3Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i),mulVec2Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i),divVec3:(e,t,i)=>(i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i),divVec4:(e,t,i)=>(i||(i=e),i[0]=e[0]/t[0],i[1]=e[1]/t[1],i[2]=e[2]/t[2],i[3]=e[3]/t[3],i),divScalarVec3:(e,t,i)=>(i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i),divVec3Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i),divVec4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]/t,i[1]=e[1]/t,i[2]=e[2]/t,i[3]=e[3]/t,i),divScalarVec4:(e,t,i)=>(i||(i=t),i[0]=e/t[0],i[1]=e/t[1],i[2]=e/t[2],i[3]=e/t[3],i),dotVec4:(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3],cross3Vec4(e,t){const i=e[0],s=e[1],r=e[2],o=t[0],n=t[1],a=t[2];return[s*a-r*n,r*o-i*a,i*n-s*o,0]},cross3Vec3(e,t,i){i||(i=e);const s=e[0],r=e[1],o=e[2],n=t[0],a=t[1],l=t[2];return i[0]=r*l-o*a,i[1]=o*n-s*l,i[2]=s*a-r*n,i},sqLenVec4:e=>d.dotVec4(e,e),lenVec4:e=>Math.sqrt(d.sqLenVec4(e)),dotVec3:(e,t)=>e[0]*t[0]+e[1]*t[1]+e[2]*t[2],dotVec2:(e,t)=>e[0]*t[0]+e[1]*t[1],sqLenVec3:e=>d.dotVec3(e,e),sqLenVec2:e=>d.dotVec2(e,e),lenVec3:e=>Math.sqrt(d.sqLenVec3(e)),distVec3:(()=>{const e=new l(3);return(t,i)=>d.lenVec3(d.subVec3(t,i,e))})(),lenVec2:e=>Math.sqrt(d.sqLenVec2(e)),distVec2:(()=>{const e=new l(2);return(t,i)=>d.lenVec2(d.subVec2(t,i,e))})(),rcpVec3:(e,t)=>d.divScalarVec3(1,e,t),normalizeVec4(e,t){const i=1/d.lenVec4(e);return d.mulVec4Scalar(e,i,t)},normalizeVec3(e,t){const i=1/d.lenVec3(e);return d.mulVec3Scalar(e,i,t)},normalizeVec2(e,t){const i=1/d.lenVec2(e);return d.mulVec2Scalar(e,i,t)},angleVec3(e,t){let i=d.dotVec3(e,t)/Math.sqrt(d.sqLenVec3(e)*d.sqLenVec3(t));return i=i<-1?-1:i>1?1:i,Math.acos(i)},vec3FromMat4Scale:(()=>{const e=new l(3);return(t,i)=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],i[0]=d.lenVec3(e),e[0]=t[4],e[1]=t[5],e[2]=t[6],i[1]=d.lenVec3(e),e[0]=t[8],e[1]=t[9],e[2]=t[10],i[2]=d.lenVec3(e),i)})(),vecToArray:(()=>{function e(e){return Math.round(1e5*e)/1e5}return t=>{for(let i=0,s=(t=Array.prototype.slice.call(t)).length;i<s;i++)t[i]=e(t[i]);return t}})(),xyzArrayToObject:e=>({x:e[0],y:e[1],z:e[2]}),xyzObjectToArray:(e,t)=>((t=t||d.vec3())[0]=e.x,t[1]=e.y,t[2]=e.z,t),dupMat4:e=>e.slice(0,16),mat4To3:e=>[e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10]],m4s:e=>[e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e],setMat4ToZeroes:()=>d.m4s(0),setMat4ToOnes:()=>d.m4s(1),diagonalMat4v:e=>new l([e[0],0,0,0,0,e[1],0,0,0,0,e[2],0,0,0,0,e[3]]),diagonalMat4c:(e,t,i,s)=>d.diagonalMat4v([e,t,i,s]),diagonalMat4s:e=>d.diagonalMat4c(e,e,e,e),identityMat4:(e=new l(16))=>(e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e),identityMat3:(e=new l(9))=>(e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e),isIdentityMat4:e=>1===e[0]&&0===e[1]&&0===e[2]&&0===e[3]&&0===e[4]&&1===e[5]&&0===e[6]&&0===e[7]&&0===e[8]&&0===e[9]&&1===e[10]&&0===e[11]&&0===e[12]&&0===e[13]&&0===e[14]&&1===e[15],negateMat4:(e,t)=>(t||(t=e),t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=-e[7],t[8]=-e[8],t[9]=-e[9],t[10]=-e[10],t[11]=-e[11],t[12]=-e[12],t[13]=-e[13],t[14]=-e[14],t[15]=-e[15],t),addMat4:(e,t,i)=>(i||(i=e),i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i[3]=e[3]+t[3],i[4]=e[4]+t[4],i[5]=e[5]+t[5],i[6]=e[6]+t[6],i[7]=e[7]+t[7],i[8]=e[8]+t[8],i[9]=e[9]+t[9],i[10]=e[10]+t[10],i[11]=e[11]+t[11],i[12]=e[12]+t[12],i[13]=e[13]+t[13],i[14]=e[14]+t[14],i[15]=e[15]+t[15],i),addMat4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t,i[3]=e[3]+t,i[4]=e[4]+t,i[5]=e[5]+t,i[6]=e[6]+t,i[7]=e[7]+t,i[8]=e[8]+t,i[9]=e[9]+t,i[10]=e[10]+t,i[11]=e[11]+t,i[12]=e[12]+t,i[13]=e[13]+t,i[14]=e[14]+t,i[15]=e[15]+t,i),addScalarMat4:(e,t,i)=>d.addMat4Scalar(t,e,i),subMat4:(e,t,i)=>(i||(i=e),i[0]=e[0]-t[0],i[1]=e[1]-t[1],i[2]=e[2]-t[2],i[3]=e[3]-t[3],i[4]=e[4]-t[4],i[5]=e[5]-t[5],i[6]=e[6]-t[6],i[7]=e[7]-t[7],i[8]=e[8]-t[8],i[9]=e[9]-t[9],i[10]=e[10]-t[10],i[11]=e[11]-t[11],i[12]=e[12]-t[12],i[13]=e[13]-t[13],i[14]=e[14]-t[14],i[15]=e[15]-t[15],i),subMat4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]-t,i[1]=e[1]-t,i[2]=e[2]-t,i[3]=e[3]-t,i[4]=e[4]-t,i[5]=e[5]-t,i[6]=e[6]-t,i[7]=e[7]-t,i[8]=e[8]-t,i[9]=e[9]-t,i[10]=e[10]-t,i[11]=e[11]-t,i[12]=e[12]-t,i[13]=e[13]-t,i[14]=e[14]-t,i[15]=e[15]-t,i),subScalarMat4:(e,t,i)=>(i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i[4]=e-t[4],i[5]=e-t[5],i[6]=e-t[6],i[7]=e-t[7],i[8]=e-t[8],i[9]=e-t[9],i[10]=e-t[10],i[11]=e-t[11],i[12]=e-t[12],i[13]=e-t[13],i[14]=e-t[14],i[15]=e-t[15],i),mulMat4(e,t,i){i||(i=e);const s=e[0],r=e[1],o=e[2],n=e[3],a=e[4],l=e[5],A=e[6],c=e[7],h=e[8],u=e[9],d=e[10],p=e[11],f=e[12],m=e[13],g=e[14],_=e[15],v=t[0],b=t[1],y=t[2],w=t[3],B=t[4],P=t[5],x=t[6],C=t[7],M=t[8],E=t[9],F=t[10],I=t[11],T=t[12],D=t[13],S=t[14],R=t[15];return i[0]=v*s+b*a+y*h+w*f,i[1]=v*r+b*l+y*u+w*m,i[2]=v*o+b*A+y*d+w*g,i[3]=v*n+b*c+y*p+w*_,i[4]=B*s+P*a+x*h+C*f,i[5]=B*r+P*l+x*u+C*m,i[6]=B*o+P*A+x*d+C*g,i[7]=B*n+P*c+x*p+C*_,i[8]=M*s+E*a+F*h+I*f,i[9]=M*r+E*l+F*u+I*m,i[10]=M*o+E*A+F*d+I*g,i[11]=M*n+E*c+F*p+I*_,i[12]=T*s+D*a+S*h+R*f,i[13]=T*r+D*l+S*u+R*m,i[14]=T*o+D*A+S*d+R*g,i[15]=T*n+D*c+S*p+R*_,i},mulMat3(e,t,i){i||(i=new l(9));const s=e[0],r=e[3],o=e[6],n=e[1],a=e[4],A=e[7],c=e[2],h=e[5],u=e[8],d=t[0],p=t[3],f=t[6],m=t[1],g=t[4],_=t[7],v=t[2],b=t[5],y=t[8];return i[0]=s*d+r*m+o*v,i[3]=s*p+r*g+o*b,i[6]=s*f+r*_+o*y,i[1]=n*d+a*m+A*v,i[4]=n*p+a*g+A*b,i[7]=n*f+a*_+A*y,i[2]=c*d+h*m+u*v,i[5]=c*p+h*g+u*b,i[8]=c*f+h*_+u*y,i},mulMat4Scalar:(e,t,i)=>(i||(i=e),i[0]=e[0]*t,i[1]=e[1]*t,i[2]=e[2]*t,i[3]=e[3]*t,i[4]=e[4]*t,i[5]=e[5]*t,i[6]=e[6]*t,i[7]=e[7]*t,i[8]=e[8]*t,i[9]=e[9]*t,i[10]=e[10]*t,i[11]=e[11]*t,i[12]=e[12]*t,i[13]=e[13]*t,i[14]=e[14]*t,i[15]=e[15]*t,i),mulMat4v4(e,t,i=d.vec4()){const s=t[0],r=t[1],o=t[2],n=t[3];return i[0]=e[0]*s+e[4]*r+e[8]*o+e[12]*n,i[1]=e[1]*s+e[5]*r+e[9]*o+e[13]*n,i[2]=e[2]*s+e[6]*r+e[10]*o+e[14]*n,i[3]=e[3]*s+e[7]*r+e[11]*o+e[15]*n,i},transposeMat4(e,t){const i=e[4],s=e[14],r=e[8],o=e[13],n=e[12],a=e[9];if(!t||e===t){const t=e[1],l=e[2],A=e[3],c=e[6],h=e[7],u=e[11];return e[1]=i,e[2]=r,e[3]=n,e[4]=t,e[6]=a,e[7]=o,e[8]=l,e[9]=c,e[11]=s,e[12]=A,e[13]=h,e[14]=u,e}return t[0]=e[0],t[1]=i,t[2]=r,t[3]=n,t[4]=e[1],t[5]=e[5],t[6]=a,t[7]=o,t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=s,t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15],t},transposeMat3(e,t){if(t===e){const i=e[1],s=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=i,t[5]=e[7],t[6]=s,t[7]=r}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t},determinantMat4(e){const t=e[0],i=e[1],s=e[2],r=e[3],o=e[4],n=e[5],a=e[6],l=e[7],A=e[8],c=e[9],h=e[10],u=e[11],d=e[12],p=e[13],f=e[14],m=e[15];return d*c*a*r-A*p*a*r-d*n*h*r+o*p*h*r+A*n*f*r-o*c*f*r-d*c*s*l+A*p*s*l+d*i*h*l-t*p*h*l-A*i*f*l+t*c*f*l+d*n*s*u-o*p*s*u-d*i*a*u+t*p*a*u+o*i*f*u-t*n*f*u-A*n*s*m+o*c*s*m+A*i*a*m-t*c*a*m-o*i*h*m+t*n*h*m},inverseMat4(e,t){t||(t=e);const i=e[0],s=e[1],r=e[2],o=e[3],n=e[4],a=e[5],l=e[6],A=e[7],c=e[8],h=e[9],u=e[10],d=e[11],p=e[12],f=e[13],m=e[14],g=e[15],_=i*a-s*n,v=i*l-r*n,b=i*A-o*n,y=s*l-r*a,w=s*A-o*a,B=r*A-o*l,P=c*f-h*p,x=c*m-u*p,C=c*g-d*p,M=h*m-u*f,E=h*g-d*f,F=u*g-d*m,I=1/(_*F-v*E+b*M+y*C-w*x+B*P);return t[0]=(a*F-l*E+A*M)*I,t[1]=(-s*F+r*E-o*M)*I,t[2]=(f*B-m*w+g*y)*I,t[3]=(-h*B+u*w-d*y)*I,t[4]=(-n*F+l*C-A*x)*I,t[5]=(i*F-r*C+o*x)*I,t[6]=(-p*B+m*b-g*v)*I,t[7]=(c*B-u*b+d*v)*I,t[8]=(n*E-a*C+A*P)*I,t[9]=(-i*E+s*C-o*P)*I,t[10]=(p*w-f*b+g*_)*I,t[11]=(-c*w+h*b-d*_)*I,t[12]=(-n*M+a*x-l*P)*I,t[13]=(i*M-s*x+r*P)*I,t[14]=(-p*y+f*v-m*_)*I,t[15]=(c*y-h*v+u*_)*I,t},traceMat4:e=>e[0]+e[5]+e[10]+e[15],translationMat4v(e,t){const i=t||d.identityMat4();return i[12]=e[0],i[13]=e[1],i[14]=e[2],i},translationMat3v(e,t){const i=t||d.identityMat3();return i[6]=e[0],i[7]=e[1],i},translationMat4c:(()=>{const e=new l(3);return(t,i,s,r)=>(e[0]=t,e[1]=i,e[2]=s,d.translationMat4v(e,r))})(),translationMat4s:(e,t)=>d.translationMat4c(e,e,e,t),translateMat4v:(e,t)=>d.translateMat4c(e[0],e[1],e[2],t),translateMat4c(e,t,i,s){const r=s[3];s[0]+=r*e,s[1]+=r*t,s[2]+=r*i;const o=s[7];s[4]+=o*e,s[5]+=o*t,s[6]+=o*i;const n=s[11];s[8]+=n*e,s[9]+=n*t,s[10]+=n*i;const a=s[15];return s[12]+=a*e,s[13]+=a*t,s[14]+=a*i,s},setMat4Translation:(e,t,i)=>(i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=e[4],i[5]=e[5],i[6]=e[6],i[7]=e[7],i[8]=e[8],i[9]=e[9],i[10]=e[10],i[11]=e[11],i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=e[15],i),rotationMat4v(e,t,i){const s=d.normalizeVec4([t[0],t[1],t[2],0],[]),r=Math.sin(e),o=Math.cos(e),n=1-o,a=s[0],l=s[1],A=s[2];let c,h,u,p,f,m;return c=a*l,h=l*A,u=A*a,p=a*r,f=l*r,m=A*r,(i=i||d.mat4())[0]=n*a*a+o,i[1]=n*c+m,i[2]=n*u-f,i[3]=0,i[4]=n*c-m,i[5]=n*l*l+o,i[6]=n*h+p,i[7]=0,i[8]=n*u+f,i[9]=n*h-p,i[10]=n*A*A+o,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:(e,t,i,s,r)=>d.rotationMat4v(e,[t,i,s],r),scalingMat4v:(e,t=d.identityMat4())=>(t[0]=e[0],t[5]=e[1],t[10]=e[2],t),scalingMat3v:(e,t=d.identityMat3())=>(t[0]=e[0],t[4]=e[1],t),scalingMat4c:(()=>{const e=new l(3);return(t,i,s,r)=>(e[0]=t,e[1]=i,e[2]=s,d.scalingMat4v(e,r))})(),scaleMat4c:(e,t,i,s)=>(s[0]*=e,s[4]*=t,s[8]*=i,s[1]*=e,s[5]*=t,s[9]*=i,s[2]*=e,s[6]*=t,s[10]*=i,s[3]*=e,s[7]*=t,s[11]*=i,s),scaleMat4v(e,t){const i=e[0],s=e[1],r=e[2];return t[0]*=i,t[4]*=s,t[8]*=r,t[1]*=i,t[5]*=s,t[9]*=r,t[2]*=i,t[6]*=s,t[10]*=r,t[3]*=i,t[7]*=s,t[11]*=r,t},scalingMat4s:e=>d.scalingMat4c(e,e,e),rotationTranslationMat4(e,t,i=d.mat4()){const s=e[0],r=e[1],o=e[2],n=e[3],a=s+s,l=r+r,A=o+o,c=s*a,h=s*l,u=s*A,p=r*l,f=r*A,m=o*A,g=n*a,_=n*l,v=n*A;return i[0]=1-(p+m),i[1]=h+v,i[2]=u-_,i[3]=0,i[4]=h-v,i[5]=1-(c+m),i[6]=f+g,i[7]=0,i[8]=u+_,i[9]=f-g,i[10]=1-(c+p),i[11]=0,i[12]=t[0],i[13]=t[1],i[14]=t[2],i[15]=1,i},mat4ToEuler(e,t,i=d.vec4()){const s=d.clamp,r=e[0],o=e[4],n=e[8],a=e[1],l=e[5],A=e[9],c=e[2],h=e[6],u=e[10];return"XYZ"===t?(i[1]=Math.asin(s(n,-1,1)),Math.abs(n)<.99999?(i[0]=Math.atan2(-A,u),i[2]=Math.atan2(-o,r)):(i[0]=Math.atan2(h,l),i[2]=0)):"YXZ"===t?(i[0]=Math.asin(-s(A,-1,1)),Math.abs(A)<.99999?(i[1]=Math.atan2(n,u),i[2]=Math.atan2(a,l)):(i[1]=Math.atan2(-c,r),i[2]=0)):"ZXY"===t?(i[0]=Math.asin(s(h,-1,1)),Math.abs(h)<.99999?(i[1]=Math.atan2(-c,u),i[2]=Math.atan2(-o,l)):(i[1]=0,i[2]=Math.atan2(a,r))):"ZYX"===t?(i[1]=Math.asin(-s(c,-1,1)),Math.abs(c)<.99999?(i[0]=Math.atan2(h,u),i[2]=Math.atan2(a,r)):(i[0]=0,i[2]=Math.atan2(-o,l))):"YZX"===t?(i[2]=Math.asin(s(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(-A,l),i[1]=Math.atan2(-c,r)):(i[0]=0,i[1]=Math.atan2(n,u))):"XZY"===t&&(i[2]=Math.asin(-s(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(h,l),i[1]=Math.atan2(n,r)):(i[0]=Math.atan2(-A,u),i[1]=0)),i[0]*=d.RADTODEG,i[1]*=d.RADTODEG,i[2]*=d.RADTODEG,i},composeMat4:(e,t,i,s=d.mat4())=>(d.quaternionToRotationMat4(t,s),d.scaleMat4v(i,s),d.translateMat4v(e,s),s),decomposeMat4:(()=>{const e=new l(3),t=new l(16);return function(i,s,r,o){e[0]=i[0],e[1]=i[1],e[2]=i[2];let n=d.lenVec3(e);e[0]=i[4],e[1]=i[5],e[2]=i[6];const a=d.lenVec3(e);e[8]=i[8],e[9]=i[9],e[10]=i[10];const l=d.lenVec3(e);d.determinantMat4(i)<0&&(n=-n),s[0]=i[12],s[1]=i[13],s[2]=i[14],t.set(i);const A=1/n,c=1/a,h=1/l;return t[0]*=A,t[1]*=A,t[2]*=A,t[4]*=c,t[5]*=c,t[6]*=c,t[8]*=h,t[9]*=h,t[10]*=h,d.mat4ToQuaternion(t,r),o[0]=n,o[1]=a,o[2]=l,this}})(),getColMat4(e,t){const i=4*t;return[e[i],e[i+1],e[i+2],e[i+3]]},setRowMat4(e,t,i){e[t]=i[0],e[t+4]=i[1],e[t+8]=i[2],e[t+12]=i[3]},lookAtMat4v(e,t,i,s){s||(s=d.mat4());const r=e[0],o=e[1],n=e[2],a=i[0],l=i[1],A=i[2],c=t[0],h=t[1],u=t[2];if(r===c&&o===h&&n===u)return d.identityMat4();let p,f,m,g,_,v,b,y,w,B;return p=r-c,f=o-h,m=n-u,B=1/Math.sqrt(p*p+f*f+m*m),p*=B,f*=B,m*=B,g=l*m-A*f,_=A*p-a*m,v=a*f-l*p,B=Math.sqrt(g*g+_*_+v*v),B?(B=1/B,g*=B,_*=B,v*=B):(g=0,_=0,v=0),b=f*v-m*_,y=m*g-p*v,w=p*_-f*g,B=Math.sqrt(b*b+y*y+w*w),B?(B=1/B,b*=B,y*=B,w*=B):(b=0,y=0,w=0),s[0]=g,s[1]=b,s[2]=p,s[3]=0,s[4]=_,s[5]=y,s[6]=f,s[7]=0,s[8]=v,s[9]=w,s[10]=m,s[11]=0,s[12]=-(g*r+_*o+v*n),s[13]=-(b*r+y*o+w*n),s[14]=-(p*r+f*o+m*n),s[15]=1,s},lookAtMat4c:(e,t,i,s,r,o,n,a,l)=>d.lookAtMat4v([e,t,i],[s,r,o],[n,a,l],[]),orthoMat4c(e,t,i,s,r,o,n){n||(n=d.mat4());const a=t-e,l=s-i,A=o-r;return n[0]=2/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2/l,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=-2/A,n[11]=0,n[12]=-(e+t)/a,n[13]=-(s+i)/l,n[14]=-(o+r)/A,n[15]=1,n},frustumMat4v(e,t,i){i||(i=d.mat4());const s=[e[0],e[1],e[2],0],r=[t[0],t[1],t[2],0];d.addVec4(r,s,c),d.subVec4(r,s,h);const o=2*s[2],n=h[0],a=h[1],l=h[2];return i[0]=o/n,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=o/a,i[6]=0,i[7]=0,i[8]=c[0]/n,i[9]=c[1]/a,i[10]=-c[2]/l,i[11]=-1,i[12]=0,i[13]=0,i[14]=-o*r[2]/l,i[15]=0,i},frustumMat4(e,t,i,s,r,o,n){n||(n=d.mat4());const a=t-e,l=s-i,A=o-r;return n[0]=2*r/a,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=2*r/l,n[6]=0,n[7]=0,n[8]=(t+e)/a,n[9]=(s+i)/l,n[10]=-(o+r)/A,n[11]=-1,n[12]=0,n[13]=0,n[14]=-o*r*2/A,n[15]=0,n},perspectiveMat4(e,t,i,s,r){const o=[],n=[];return o[2]=i,n[2]=s,n[1]=o[2]*Math.tan(e/2),o[1]=-n[1],n[0]=n[1]*t,o[0]=-n[0],d.frustumMat4v(o,n,r)},compareMat4:(e,t)=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15],transformPoint3(e,t,i=d.vec3()){const s=t[0],r=t[1],o=t[2];return i[0]=e[0]*s+e[4]*r+e[8]*o+e[12],i[1]=e[1]*s+e[5]*r+e[9]*o+e[13],i[2]=e[2]*s+e[6]*r+e[10]*o+e[14],i},transformPoint4:(e,t,i=d.vec4())=>(i[0]=e[0]*t[0]+e[4]*t[1]+e[8]*t[2]+e[12]*t[3],i[1]=e[1]*t[0]+e[5]*t[1]+e[9]*t[2]+e[13]*t[3],i[2]=e[2]*t[0]+e[6]*t[1]+e[10]*t[2]+e[14]*t[3],i[3]=e[3]*t[0]+e[7]*t[1]+e[11]*t[2]+e[15]*t[3],i),transformPoints3(e,t,i){const s=i||[],r=t.length;let o,n,a,l;const A=e[0],c=e[1],h=e[2],u=e[3],d=e[4],p=e[5],f=e[6],m=e[7],g=e[8],_=e[9],v=e[10],b=e[11],y=e[12],w=e[13],B=e[14],P=e[15];let x;for(let e=0;e<r;++e)l=t[e],o=l[0],n=l[1],a=l[2],x=s[e]||(s[e]=[0,0,0]),x[0]=A*o+d*n+g*a+y,x[1]=c*o+p*n+_*a+w,x[2]=h*o+f*n+v*a+B,x[3]=u*o+m*n+b*a+P;return s.length=r,s},transformPositions3(e,t,i=t){let s;const r=t.length;let o,n,a;const l=e[0],A=e[1],c=e[2];e[3];const h=e[4],u=e[5],d=e[6];e[7];const p=e[8],f=e[9],m=e[10];e[11];const g=e[12],_=e[13],v=e[14];for(e[15],s=0;s<r;s+=3)o=t[s+0],n=t[s+1],a=t[s+2],i[s+0]=l*o+h*n+p*a+g,i[s+1]=A*o+u*n+f*a+_,i[s+2]=c*o+d*n+m*a+v;return i},transformPositions4(e,t,i=t){let s;const r=t.length;let o,n,a;const l=e[0],A=e[1],c=e[2],h=e[3],u=e[4],d=e[5],p=e[6],f=e[7],m=e[8],g=e[9],_=e[10],v=e[11],b=e[12],y=e[13],w=e[14],B=e[15];for(s=0;s<r;s+=4)o=t[s+0],n=t[s+1],a=t[s+2],i[s+0]=l*o+u*n+m*a+b,i[s+1]=A*o+d*n+g*a+y,i[s+2]=c*o+p*n+_*a+w,i[s+3]=h*o+f*n+v*a+B;return i},transformVec3(e,t,i){const s=t[0],r=t[1],o=t[2];return(i=i||this.vec3())[0]=e[0]*s+e[4]*r+e[8]*o,i[1]=e[1]*s+e[5]*r+e[9]*o,i[2]=e[2]*s+e[6]*r+e[10]*o,i},transformVec4(e,t,i){const s=t[0],r=t[1],o=t[2],n=t[3];return(i=i||d.vec4())[0]=e[0]*s+e[4]*r+e[8]*o+e[12]*n,i[1]=e[1]*s+e[5]*r+e[9]*o+e[13]*n,i[2]=e[2]*s+e[6]*r+e[10]*o+e[14]*n,i[3]=e[3]*s+e[7]*r+e[11]*o+e[15]*n,i},rotateVec2(e,t,i,s=e){const r=Math.cos(i),o=Math.sin(i),n=e[0]-t[0],a=e[1]-t[1];return s[0]=n*r-a*o+t[0],s[1]=n*o+a*r+t[1],e},rotateVec3X(e,t,i,s){const r=[],o=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],o[0]=r[0],o[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),o[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s},rotateVec3Y(e,t,i,s){const r=[],o=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],o[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),o[1]=r[1],o[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s},rotateVec3Z(e,t,i,s){const r=[],o=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],o[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),o[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),o[2]=r[2],s[0]=o[0]+t[0],s[1]=o[1]+t[1],s[2]=o[2]+t[2],s},projectVec4(e,t){const i=1/e[3];return(t=t||d.vec2())[0]=e[0]*i,t[1]=e[1]*i,t},unprojectVec3:(()=>{const e=new l(16),t=new l(16),i=new l(16);return function(s,r,o,n){return this.transformVec3(this.mulMat4(this.inverseMat4(r,e),this.inverseMat4(o,t),i),s,n)}})(),lerpVec3(e,t,i,s,r,o){const n=o||d.vec3(),a=(e-t)/(i-t);return n[0]=s[0]+a*(r[0]-s[0]),n[1]=s[1]+a*(r[1]-s[1]),n[2]=s[2]+a*(r[2]-s[2]),n},lerpMat4(e,t,i,s,r,o){const n=o||d.mat4(),a=(e-t)/(i-t);return n[0]=s[0]+a*(r[0]-s[0]),n[1]=s[1]+a*(r[1]-s[1]),n[2]=s[2]+a*(r[2]-s[2]),n[3]=s[3]+a*(r[3]-s[3]),n[4]=s[4]+a*(r[4]-s[4]),n[5]=s[5]+a*(r[5]-s[5]),n[6]=s[6]+a*(r[6]-s[6]),n[7]=s[7]+a*(r[7]-s[7]),n[8]=s[8]+a*(r[8]-s[8]),n[9]=s[9]+a*(r[9]-s[9]),n[10]=s[10]+a*(r[10]-s[10]),n[11]=s[11]+a*(r[11]-s[11]),n[12]=s[12]+a*(r[12]-s[12]),n[13]=s[13]+a*(r[13]-s[13]),n[14]=s[14]+a*(r[14]-s[14]),n[15]=s[15]+a*(r[15]-s[15]),n},flatten(e){const t=[];let i,s,r,o,n;for(i=0,s=e.length;i<s;i++)for(n=e[i],r=0,o=n.length;r<o;r++)t.push(n[r]);return t},identityQuaternion:(e=d.vec4())=>(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e),eulerToQuaternion(e,t,i=d.vec4()){const s=e[0]*d.DEGTORAD/2,r=e[1]*d.DEGTORAD/2,o=e[2]*d.DEGTORAD/2,n=Math.cos(s),a=Math.cos(r),l=Math.cos(o),A=Math.sin(s),c=Math.sin(r),h=Math.sin(o);return"XYZ"===t?(i[0]=A*a*l+n*c*h,i[1]=n*c*l-A*a*h,i[2]=n*a*h+A*c*l,i[3]=n*a*l-A*c*h):"YXZ"===t?(i[0]=A*a*l+n*c*h,i[1]=n*c*l-A*a*h,i[2]=n*a*h-A*c*l,i[3]=n*a*l+A*c*h):"ZXY"===t?(i[0]=A*a*l-n*c*h,i[1]=n*c*l+A*a*h,i[2]=n*a*h+A*c*l,i[3]=n*a*l-A*c*h):"ZYX"===t?(i[0]=A*a*l-n*c*h,i[1]=n*c*l+A*a*h,i[2]=n*a*h-A*c*l,i[3]=n*a*l+A*c*h):"YZX"===t?(i[0]=A*a*l+n*c*h,i[1]=n*c*l+A*a*h,i[2]=n*a*h-A*c*l,i[3]=n*a*l-A*c*h):"XZY"===t&&(i[0]=A*a*l-n*c*h,i[1]=n*c*l-A*a*h,i[2]=n*a*h+A*c*l,i[3]=n*a*l+A*c*h),i},mat4ToQuaternion(e,t=d.vec4()){const i=e[0],s=e[4],r=e[8],o=e[1],n=e[5],a=e[9],l=e[2],A=e[6],c=e[10];let h;const u=i+n+c;return u>0?(h=.5/Math.sqrt(u+1),t[3]=.25/h,t[0]=(A-a)*h,t[1]=(r-l)*h,t[2]=(o-s)*h):i>n&&i>c?(h=2*Math.sqrt(1+i-n-c),t[3]=(A-a)/h,t[0]=.25*h,t[1]=(s+o)/h,t[2]=(r+l)/h):n>c?(h=2*Math.sqrt(1+n-i-c),t[3]=(r-l)/h,t[0]=(s+o)/h,t[1]=.25*h,t[2]=(a+A)/h):(h=2*Math.sqrt(1+c-i-n),t[3]=(o-s)/h,t[0]=(r+l)/h,t[1]=(a+A)/h,t[2]=.25*h),t},vec3PairToQuaternion(e,t,i=d.vec4()){const s=Math.sqrt(d.dotVec3(e,e)*d.dotVec3(t,t));let r=s+d.dotVec3(e,t);return r<1e-8*s?(r=0,Math.abs(e[0])>Math.abs(e[2])?(i[0]=-e[1],i[1]=e[0],i[2]=0):(i[0]=0,i[1]=-e[2],i[2]=e[1])):d.cross3Vec3(e,t,i),i[3]=r,d.normalizeQuaternion(i)},angleAxisToQuaternion(e,t=d.vec4()){const i=e[3]/2,s=Math.sin(i);return t[0]=s*e[0],t[1]=s*e[1],t[2]=s*e[2],t[3]=Math.cos(i),t},quaternionToEuler:(()=>{const e=new l(16);return(t,i,s)=>(s=s||d.vec3(),d.quaternionToRotationMat4(t,e),d.mat4ToEuler(e,i,s),s)})(),mulQuaternions(e,t,i=d.vec4()){const s=e[0],r=e[1],o=e[2],n=e[3],a=t[0],l=t[1],A=t[2],c=t[3];return i[0]=n*a+s*c+r*A-o*l,i[1]=n*l+r*c+o*a-s*A,i[2]=n*A+o*c+s*l-r*a,i[3]=n*c-s*a-r*l-o*A,i},vec3ApplyQuaternion(e,t,i=d.vec3()){const s=t[0],r=t[1],o=t[2],n=e[0],a=e[1],l=e[2],A=e[3],c=A*s+a*o-l*r,h=A*r+l*s-n*o,u=A*o+n*r-a*s,p=-n*s-a*r-l*o;return i[0]=c*A+p*-n+h*-l-u*-a,i[1]=h*A+p*-a+u*-n-c*-l,i[2]=u*A+p*-l+c*-a-h*-n,i},quaternionToMat4(e,t){t=d.identityMat4(t);const i=e[0],s=e[1],r=e[2],o=e[3],n=2*i,a=2*s,l=2*r,A=n*o,c=a*o,h=l*o,u=n*i,p=a*i,f=l*i,m=a*s,g=l*s,_=l*r;return t[0]=1-(m+_),t[1]=p+h,t[2]=f-c,t[4]=p-h,t[5]=1-(u+_),t[6]=g+A,t[8]=f+c,t[9]=g-A,t[10]=1-(u+m),t},quaternionToRotationMat4(e,t){const i=e[0],s=e[1],r=e[2],o=e[3],n=i+i,a=s+s,l=r+r,A=i*n,c=i*a,h=i*l,u=s*a,d=s*l,p=r*l,f=o*n,m=o*a,g=o*l;return t[0]=1-(u+p),t[4]=c-g,t[8]=h+m,t[1]=c+g,t[5]=1-(A+p),t[9]=d-f,t[2]=h-m,t[6]=d+f,t[10]=1-(A+u),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},normalizeQuaternion(e,t=e){const i=d.lenVec4([e[0],e[1],e[2],e[3]]);return t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i,t[3]=e[3]/i,t},conjugateQuaternion:(e,t=e)=>(t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t),inverseQuaternion:(e,t)=>d.normalizeQuaternion(d.conjugateQuaternion(e,t)),quaternionToAngleAxis(e,t=d.vec4()){const i=(e=d.normalizeQuaternion(e,u))[3],s=2*Math.acos(i),r=Math.sqrt(1-i*i);return r<.001?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=e[0]/r,t[1]=e[1]/r,t[2]=e[2]/r),t[3]=s,t},AABB3:e=>new l(e||6),AABB2:e=>new l(e||4),OBB3:e=>new l(e||32),OBB2:e=>new l(e||16),Sphere3:(e,t,i,s)=>new l([e,t,i,s]),transformOBB3(e,t,i=t){let s;const r=t.length;let o,n,a;const l=e[0],A=e[1],c=e[2],h=e[3],u=e[4],d=e[5],p=e[6],f=e[7],m=e[8],g=e[9],_=e[10],v=e[11],b=e[12],y=e[13],w=e[14],B=e[15];for(s=0;s<r;s+=4)o=t[s+0],n=t[s+1],a=t[s+2],i[s+0]=l*o+u*n+m*a+b,i[s+1]=A*o+d*n+g*a+y,i[s+2]=c*o+p*n+_*a+w,i[s+3]=h*o+f*n+v*a+B;return i},containsAABB3:function(e,t){return e[0]<=t[0]&&t[3]<=e[3]&&e[1]<=t[1]&&t[4]<=e[4]&&e[2]<=t[2]&&t[5]<=e[5]},getAABB3Diag:(()=>{const e=new l(3),t=new l(3),i=new l(3);return s=>(e[0]=s[0],e[1]=s[1],e[2]=s[2],t[0]=s[3],t[1]=s[4],t[2]=s[5],d.subVec3(t,e,i),Math.abs(d.lenVec3(i)))})(),getAABB3DiagPoint:(()=>{const e=new l(3),t=new l(3),i=new l(3);return(s,r)=>{e[0]=s[0],e[1]=s[1],e[2]=s[2],t[0]=s[3],t[1]=s[4],t[2]=s[5];const o=d.subVec3(t,e,i),n=r[0]-s[0],a=s[3]-r[0],l=r[1]-s[1],A=s[4]-r[1],c=r[2]-s[2],h=s[5]-r[2];return o[0]+=n>a?n:a,o[1]+=l>A?l:A,o[2]+=c>h?c:h,Math.abs(d.lenVec3(o))}})(),getAABB3Area:e=>(e[3]-e[0])*(e[4]-e[1])*(e[5]-e[2]),getAABB3Center(e,t){const i=t||d.vec3();return i[0]=(e[0]+e[3])/2,i[1]=(e[1]+e[4])/2,i[2]=(e[2]+e[5])/2,i},getAABB2Center(e,t){const i=t||d.vec2();return i[0]=(e[2]+e[0])/2,i[1]=(e[3]+e[1])/2,i},collapseAABB3:(e=d.AABB3())=>(e[0]=d.MAX_DOUBLE,e[1]=d.MAX_DOUBLE,e[2]=d.MAX_DOUBLE,e[3]=d.MIN_DOUBLE,e[4]=d.MIN_DOUBLE,e[5]=d.MIN_DOUBLE,e),AABB3ToOBB3:(e,t=d.OBB3())=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,t[4]=e[3],t[5]=e[1],t[6]=e[2],t[7]=1,t[8]=e[3],t[9]=e[4],t[10]=e[2],t[11]=1,t[12]=e[0],t[13]=e[4],t[14]=e[2],t[15]=1,t[16]=e[0],t[17]=e[1],t[18]=e[5],t[19]=1,t[20]=e[3],t[21]=e[1],t[22]=e[5],t[23]=1,t[24]=e[3],t[25]=e[4],t[26]=e[5],t[27]=1,t[28]=e[0],t[29]=e[4],t[30]=e[5],t[31]=1,t),positions3ToAABB3:(()=>{const e=new l(3);return(t,i,s)=>{i=i||d.AABB3();let r,o,n,a=d.MAX_DOUBLE,l=d.MAX_DOUBLE,A=d.MAX_DOUBLE,c=d.MIN_DOUBLE,h=d.MIN_DOUBLE,u=d.MIN_DOUBLE;for(let i=0,p=t.length;i<p;i+=3)s?(e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2],d.decompressPosition(e,s,e),r=e[0],o=e[1],n=e[2]):(r=t[i+0],o=t[i+1],n=t[i+2]),r<a&&(a=r),o<l&&(l=o),n<A&&(A=n),r>c&&(c=r),o>h&&(h=o),n>u&&(u=n);return i[0]=a,i[1]=l,i[2]=A,i[3]=c,i[4]=h,i[5]=u,i}})(),OBB3ToAABB3(e,t=d.AABB3()){let i,s,r,o=d.MAX_DOUBLE,n=d.MAX_DOUBLE,a=d.MAX_DOUBLE,l=d.MIN_DOUBLE,A=d.MIN_DOUBLE,c=d.MIN_DOUBLE;for(let t=0,h=e.length;t<h;t+=4)i=e[t+0],s=e[t+1],r=e[t+2],i<o&&(o=i),s<n&&(n=s),r<a&&(a=r),i>l&&(l=i),s>A&&(A=s),r>c&&(c=r);return t[0]=o,t[1]=n,t[2]=a,t[3]=l,t[4]=A,t[5]=c,t},points3ToAABB3(e,t=d.AABB3()){let i,s,r,o=d.MAX_DOUBLE,n=d.MAX_DOUBLE,a=d.MAX_DOUBLE,l=d.MIN_DOUBLE,A=d.MIN_DOUBLE,c=d.MIN_DOUBLE;for(let t=0,h=e.length;t<h;t++)i=e[t][0],s=e[t][1],r=e[t][2],i<o&&(o=i),s<n&&(n=s),r<a&&(a=r),i>l&&(l=i),s>A&&(A=s),r>c&&(c=r);return t[0]=o,t[1]=n,t[2]=a,t[3]=l,t[4]=A,t[5]=c,t},points3ToSphere3:(()=>{const e=new l(3);return(t,i)=>{i=i||d.vec4();let s,r=0,o=0,n=0;const a=t.length;for(s=0;s<a;s++)r+=t[s][0],o+=t[s][1],n+=t[s][2];i[0]=r/a,i[1]=o/a,i[2]=n/a;let l,A=0;for(s=0;s<a;s++)l=Math.abs(d.lenVec3(d.subVec3(t[s],i,e))),l>A&&(A=l);return i[3]=A,i}})(),positions3ToSphere3:(()=>{const e=new l(3),t=new l(3);return(i,s)=>{s=s||d.vec4();let r,o=0,n=0,a=0;const l=i.length;let A=0;for(r=0;r<l;r+=3)o+=i[r],n+=i[r+1],a+=i[r+2];const c=l/3;let h;for(s[0]=o/c,s[1]=n/c,s[2]=a/c,r=0;r<l;r+=3)e[0]=i[r],e[1]=i[r+1],e[2]=i[r+2],h=Math.abs(d.lenVec3(d.subVec3(e,s,t))),h>A&&(A=h);return s[3]=A,s}})(),OBB3ToSphere3:(()=>{const e=new l(3),t=new l(3);return(i,s)=>{s=s||d.vec4();let r,o=0,n=0,a=0;const l=i.length,A=l/4;for(r=0;r<l;r+=4)o+=i[r+0],n+=i[r+1],a+=i[r+2];s[0]=o/A,s[1]=n/A,s[2]=a/A;let c,h=0;for(r=0;r<l;r+=4)e[0]=i[r+0],e[1]=i[r+1],e[2]=i[r+2],c=Math.abs(d.lenVec3(d.subVec3(e,s,t))),c>h&&(h=c);return s[3]=h,s}})(),getSphere3Center:(e,t=d.vec3())=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],t),getPositionsCenter(e,t=d.vec3()){let i=0,s=0,r=0;for(var o=0,n=e.length;o<n;o+=3)i+=e[o+0],s+=e[o+1],r+=e[o+2];const a=e.length/3;return t[0]=i/a,t[1]=s/a,t[2]=r/a,t},expandAABB3:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e[4]<t[4]&&(e[4]=t[4]),e[5]<t[5]&&(e[5]=t[5]),e),expandAABB3Point3:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]>t[2]&&(e[2]=t[2]),e[3]<t[0]&&(e[3]=t[0]),e[4]<t[1]&&(e[4]=t[1]),e[5]<t[2]&&(e[5]=t[2]),e),expandAABB3Points3(e,t){for(var i,s,r,o=0,n=t.length;o<n;o+=3)i=t[o],s=t[o+1],r=t[o+2],e[0]>i&&(e[0]=i),e[1]>s&&(e[1]=s),e[2]>r&&(e[2]=r),e[3]<i&&(e[3]=i),e[4]<s&&(e[4]=s),e[5]<r&&(e[5]=r);return e},collapseAABB2:(e=d.AABB2())=>(e[0]=d.MAX_DOUBLE,e[1]=d.MAX_DOUBLE,e[2]=d.MIN_DOUBLE,e[3]=d.MIN_DOUBLE,e),point3AABB3Intersect:(e,t)=>e[0]>t[0]||e[3]<t[0]||e[1]>t[1]||e[4]<t[1]||e[2]>t[2]||e[5]<t[2],point3AABB3AbsoluteIntersect:(e,t)=>e[0]<=t[0]&&e[3]>=t[0]&&e[1]<=t[1]&&e[4]>=t[1]&&e[2]<=t[2]&&e[5]>=t[2],planeAABB3Intersect(e,t,i){let s,r;e[0]>0?(s=e[0]*i[0],r=e[0]*i[3]):(s=e[0]*i[3],r=e[0]*i[0]),e[1]>0?(s+=e[1]*i[1],r+=e[1]*i[4]):(s+=e[1]*i[4],r+=e[1]*i[1]),e[2]>0?(s+=e[2]*i[2],r+=e[2]*i[5]):(s+=e[2]*i[5],r+=e[2]*i[2]);if(s<=-t&&r<=-t)return-1;return s>=-t&&r>=-t?1:0},OBB3ToAABB2(e,t=d.AABB2()){let i,s,r,o,n=d.MAX_DOUBLE,a=d.MAX_DOUBLE,l=d.MIN_DOUBLE,A=d.MIN_DOUBLE;for(let t=0,c=e.length;t<c;t+=4)i=e[t+0],s=e[t+1],r=e[t+3]||1,o=1/r,i*=o,s*=o,i<n&&(n=i),s<a&&(a=s),i>l&&(l=i),s>A&&(A=s);return t[0]=n,t[1]=a,t[2]=l,t[3]=A,t},expandAABB2:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[2]&&(e[2]=t[2]),e[3]<t[3]&&(e[3]=t[3]),e),expandAABB2Point2:(e,t)=>(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1]),e),AABB2ToCanvas(e,t,i,s=e){const r=.5*(e[0]+1),o=.5*(e[1]+1),n=.5*(e[2]+1),a=.5*(e[3]+1);return s[0]=Math.floor(r*t),s[1]=i-Math.floor(a*i),s[2]=Math.floor(n*t),s[3]=i-Math.floor(o*i),s},tangentQuadraticBezier:(e,t,i,s)=>2*(1-e)*(i-t)+2*e*(s-i),tangentQuadraticBezier3:(e,t,i,s,r)=>-3*t*(1-e)*(1-e)+3*i*(1-e)*(1-e)-6*e*i*(1-e)+6*e*s*(1-e)-3*e*e*s+3*e*e*r,tangentSpline:e=>6*e*e-6*e+(3*e*e-4*e+1)+(-6*e*e+6*e)+(3*e*e-2*e),catmullRomInterpolate(e,t,i,s,r){const o=.5*(i-e),n=.5*(s-t),a=r*r;return(2*t-2*i+o+n)*(r*a)+(-3*t+3*i-2*o-n)*a+o*r+t},b2p0(e,t){const i=1-e;return i*i*t},b2p1:(e,t)=>2*(1-e)*e*t,b2p2:(e,t)=>e*e*t,b2(e,t,i,s){return this.b2p0(e,t)+this.b2p1(e,i)+this.b2p2(e,s)},b3p0(e,t){const i=1-e;return i*i*i*t},b3p1(e,t){const i=1-e;return 3*i*i*e*t},b3p2:(e,t)=>3*(1-e)*e*e*t,b3p3:(e,t)=>e*e*e*t,b3(e,t,i,s,r){return this.b3p0(e,t)+this.b3p1(e,i)+this.b3p2(e,s)+this.b3p3(e,r)},triangleNormal(e,t,i,s=d.vec3()){const r=t[0]-e[0],o=t[1]-e[1],n=t[2]-e[2],a=i[0]-e[0],l=i[1]-e[1],A=i[2]-e[2],c=o*A-n*l,h=n*a-r*A,u=r*l-o*a,p=Math.sqrt(c*c+h*h+u*u);return 0===p?(s[0]=0,s[1]=0,s[2]=0):(s[0]=c/p,s[1]=h/p,s[2]=u/p),s},rayTriangleIntersect:(()=>{const e=new l(3),t=new l(3),i=new l(3),s=new l(3),r=new l(3);return(o,n,a,l,A,c)=>{c=c||d.vec3();const h=d.subVec3(l,a,e),u=d.subVec3(A,a,t),p=d.cross3Vec3(n,u,i),f=d.dotVec3(h,p);if(f<1e-6)return null;const m=d.subVec3(o,a,s),g=d.dotVec3(m,p);if(g<0||g>f)return null;const _=d.cross3Vec3(m,h,r),v=d.dotVec3(n,_);if(v<0||g+v>f)return null;const b=d.dotVec3(u,_)/f;return c[0]=o[0]+b*n[0],c[1]=o[1]+b*n[1],c[2]=o[2]+b*n[2],c}})(),rayPlaneIntersect:(()=>{const e=new l(3),t=new l(3),i=new l(3),s=new l(3);return(r,o,n,a,l,A)=>{A=A||d.vec3(),o=d.normalizeVec3(o,e);const c=d.subVec3(a,n,t),h=d.subVec3(l,n,i),u=d.cross3Vec3(c,h,s);d.normalizeVec3(u,u);const p=-d.dotVec3(n,u),f=-(d.dotVec3(r,u)+p)/d.dotVec3(o,u);return A[0]=r[0]+f*o[0],A[1]=r[1]+f*o[1],A[2]=r[2]+f*o[2],A}})(),cartesianToBarycentric:(()=>{const e=new l(3),t=new l(3),i=new l(3);return(s,r,o,n,a)=>{const l=d.subVec3(n,r,e),A=d.subVec3(o,r,t),c=d.subVec3(s,r,i),h=d.dotVec3(l,l),u=d.dotVec3(l,A),p=d.dotVec3(l,c),f=d.dotVec3(A,A),m=d.dotVec3(A,c),g=h*f-u*u;if(0===g)return null;const _=1/g,v=(f*p-u*m)*_,b=(h*m-u*p)*_;return a[0]=1-v-b,a[1]=b,a[2]=v,a}})(),barycentricInsideTriangle(e){const t=e[1],i=e[2];return i>=0&&t>=0&&i+t<1},barycentricToCartesian(e,t,i,s,r=d.vec3()){const o=e[0],n=e[1],a=e[2];return r[0]=t[0]*o+i[0]*n+s[0]*a,r[1]=t[1]*o+i[1]*n+s[1]*a,r[2]=t[2]*o+i[2]*n+s[2]*a,r},mergeVertices(e,t,i,s){const r={},o=[],n=[],a=t?[]:null,l=i?[]:null,A=[];let c,h,u,d;const p=1e4;let f,m,g=0;for(f=0,m=e.length;f<m;f+=3)c=e[f],h=e[f+1],u=e[f+2],d=`${Math.round(c*p)}_${Math.round(h*p)}_${Math.round(u*p)}`,void 0===r[d]&&(r[d]=n.length/3,n.push(c),n.push(h),n.push(u),t&&(a.push(t[f]),a.push(t[f+1]),a.push(t[f+2])),i&&(l.push(i[g]),l.push(i[g+1]))),o[f/3]=r[d],g+=2;for(f=0,m=s.length;f<m;f++)A[f]=o[s[f]];const _={positions:n,indices:A};return a&&(_.normals=a),l&&(_.uv=l),_},buildNormals:(()=>{const e=new l(3),t=new l(3),i=new l(3),s=new l(3),r=new l(3),o=new l(3);return(n,a,l)=>{let A,c;const h=new Array(n.length/3);let u,p,f,m,g,_,v;for(A=0,c=a.length;A<c;A+=3){u=a[A],p=a[A+1],f=a[A+2],e[0]=n[3*u],e[1]=n[3*u+1],e[2]=n[3*u+2],t[0]=n[3*p],t[1]=n[3*p+1],t[2]=n[3*p+2],i[0]=n[3*f],i[1]=n[3*f+1],i[2]=n[3*f+2],d.subVec3(t,e,s),d.subVec3(i,e,r);const l=d.vec3();d.normalizeVec3(d.cross3Vec3(s,r,o),l),h[u]||(h[u]=[]),h[p]||(h[p]=[]),h[f]||(h[f]=[]),h[u].push(l),h[p].push(l),h[f].push(l)}for(l=l&&l.length===n.length?l:new Float32Array(n.length),A=0,c=h.length;A<c;A++){m=h[A].length,g=0,_=0,v=0;for(let e=0;e<m;e++)g+=h[A][e][0],_+=h[A][e][1],v+=h[A][e][2];l[3*A]=g/m,l[3*A+1]=_/m,l[3*A+2]=v/m}return l}})(),buildTangents:(()=>{const e=new l(3),t=new l(3),i=new l(3),s=new l(3),r=new l(3),o=new l(3),n=new l(3);return(a,l,A)=>{const c=new Float32Array(a.length);for(let h=0;h<l.length;h+=3){let u=l[h];const p=a.subarray(3*u,3*u+3),f=A.subarray(2*u,2*u+2);u=l[h+1];const m=a.subarray(3*u,3*u+3),g=A.subarray(2*u,2*u+2);u=l[h+2];const _=a.subarray(3*u,3*u+3),v=A.subarray(2*u,2*u+2),b=d.subVec3(m,p,e),y=d.subVec3(_,p,t),w=d.subVec2(g,f,i),B=d.subVec2(v,f,s),P=1/(w[0]*B[1]-w[1]*B[0]),x=d.mulVec3Scalar(d.subVec3(d.mulVec3Scalar(b,B[1],r),d.mulVec3Scalar(y,w[1],o),n),P,o);let C;for(let e=0;e<3;e++)C=3*l[h+e],c[C]+=x[0],c[C+1]+=x[1],c[C+2]+=x[2]}return c}})(),buildPickTriangles(e,t,i){const s=t.length,r=i?new Uint16Array(9*s):new Float32Array(9*s),o=new Uint8Array(12*s);let n,a,l,A,c,h,u=0,d=0,p=0;for(let i=0;i<s;i+=3)h=u>>24&255,c=u>>16&255,A=u>>8&255,l=255&u,a=t[i],n=3*a,r[d++]=e[n],r[d++]=e[n+1],r[d++]=e[n+2],o[p++]=l,o[p++]=A,o[p++]=c,o[p++]=h,a=t[i+1],n=3*a,r[d++]=e[n],r[d++]=e[n+1],r[d++]=e[n+2],o[p++]=l,o[p++]=A,o[p++]=c,o[p++]=h,a=t[i+2],n=3*a,r[d++]=e[n],r[d++]=e[n+1],r[d++]=e[n+2],o[p++]=l,o[p++]=A,o[p++]=c,o[p++]=h,u++;return{positions:r,colors:o}},faceToVertexNormals(e,t,i={}){const s=i.smoothNormalsAngleThreshold||20,r={},o=[],n={};let a,l,A,c,h;const u=1e4;let p,f,m,g,_,v;for(f=0,g=e.length;f<g;f+=3){p=f/3,l=e[f],A=e[f+1],c=e[f+2],h=`${Math.round(l*u)}_${Math.round(A*u)}_${Math.round(c*u)}`,void 0===r[h]?r[h]=[p]:r[h].push(p);const i=d.normalizeVec3([t[f],t[f+1],t[f+2]]);o[p]=i,a=d.vec4([i[0],i[1],i[2],1]),n[p]=a}for(h in r)if(r.hasOwnProperty(h)){const e=r[h],t=e.length;for(f=0;f<t;f++){const i=e[f];for(a=n[i],m=0;m<t;m++){if(f===m)continue;const t=e[m];_=o[i],v=o[t];Math.abs(d.angleVec3(_,v)/d.DEGTORAD)<s&&(a[0]+=v[0],a[1]+=v[1],a[2]+=v[2],a[3]+=1)}}}for(f=0,g=t.length;f<g;f+=3)a=n[f/3],t[f+0]=a[0]/a[3],t[f+1]=a[1]/a[3],t[f+2]=a[2]/a[3]},transformRay:(()=>{const e=new l(4),t=new l(4);return(i,s,r,o,n)=>{e[0]=s[0],e[1]=s[1],e[2]=s[2],e[3]=1,d.transformVec4(i,e,t),o[0]=t[0],o[1]=t[1],o[2]=t[2],e[0]=r[0],e[1]=r[1],e[2]=r[2],d.transformVec3(i,e,t),d.normalizeVec3(t),n[0]=t[0],n[1]=t[1],n[2]=t[2]}})(),canvasPosToWorldRay:(()=>{const e=new l(16),t=new l(4),i=new l(4),s=(t,i,s,r,o)=>{o[0]=t,o[1]=i,o[2]=s,o[3]=1,d.transformVec4(e,o,o),r||d.mulVec4Scalar(o,1/o[3])};return(r,o,n,a,l,A,c)=>{const h="ortho"===a;d.mulMat4(n,o,e),d.inverseMat4(e,e);const u=2*l[0]/r.clientWidth-1,p=1-2*l[1]/r.clientHeight;s(u,p,-1,h,t),s(u,p,1,h,i),A[0]=t[0],A[1]=t[1],A[2]=t[2],d.subVec3(i,t,c),d.normalizeVec3(c)}})(),canvasPosToLocalRay:(()=>{const e=new l(3),t=new l(3);return(i,s,r,o,n,a,l,A)=>{d.canvasPosToWorldRay(i,s,r,o,a,e,t),d.worldRayToLocalRay(n,e,t,l,A)}})(),worldRayToLocalRay:(()=>{const e=new l(16),t=new l(4),i=new l(4);return(s,r,o,n,a)=>{const l=d.inverseMat4(s,e);t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=1,d.transformVec4(l,t,i),n[0]=i[0],n[1]=i[1],n[2]=i[2],d.transformVec3(l,o,a)}})(),buildKDTree:(()=>{const e=new Float32Array;function t(i,s,r,o){const n=new l(6),a={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:n};let A,c;for(n[0]=n[1]=n[2]=Number.POSITIVE_INFINITY,n[3]=n[4]=n[5]=Number.NEGATIVE_INFINITY,A=0,c=i.length;A<c;++A){var h=3*i[A];for(let e=0;e<3;++e){const t=3*s[h+e];r[t]<n[0]&&(n[0]=r[t]),r[t]>n[3]&&(n[3]=r[t]),r[t+1]<n[1]&&(n[1]=r[t+1]),r[t+1]>n[4]&&(n[4]=r[t+1]),r[t+2]<n[2]&&(n[2]=r[t+2]),r[t+2]>n[5]&&(n[5]=r[t+2])}}if(i.length<20||o>10)return a.triangles=i,a.leaf=!0,a;e[0]=n[3]-n[0],e[1]=n[4]-n[1],e[2]=n[5]-n[2];let u=0;e[1]>e[u]&&(u=1),e[2]>e[u]&&(u=2),a.splitDim=u;const d=(n[u]+n[u+3])/2,p=new Array(i.length);let f=0;const m=new Array(i.length);let g=0;for(A=0,c=i.length;A<c;++A){const e=s[h=3*i[A]],t=3*s[h+1],o=3*s[h+2];r[3*e+u]<=d||r[t+u]<=d||r[o+u]<=d?p[f++]=i[A]:m[g++]=i[A]}return p.length=f,m.length=g,a.left=t(p,s,r,o+1),a.right=t(m,s,r,o+1),a}return(e,i)=>{const s=e.length/3,r=new Array(s);for(let e=0;e<s;++e)r[e]=e;return t(r,e,i,0)}})(),decompressPosition(e,t,i){(i=i||e)[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14]},decompressPositions(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[12],i[s+1]=e[s+1]*t[5]+t[13],i[s+2]=e[s+2]*t[10]+t[14];return i},decompressUV(e,t,i){i[0]=e[0]*t[0]+t[6],i[1]=e[1]*t[4]+t[7]},decompressUVs(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[6],i[s+1]=e[s+1]*t[4]+t[7];return i},octDecodeVec2(e,t){let i=e[0],s=e[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const o=Math.sqrt(i*i+s*s+r*r);return t[0]=i/o,t[1]=s/o,t[2]=r/o,t},octDecodeVec2s(e,t){for(let i=0,s=0,r=e.length;i<r;i+=2){let r=e[i+0],o=e[i+1];r=(2*r+1)/255,o=(2*o+1)/255;const n=1-Math.abs(r)-Math.abs(o);n<0&&(r=(1-Math.abs(o))*(r>=0?1:-1),o=(1-Math.abs(r))*(o>=0?1:-1));const a=Math.sqrt(r*r+o*o+n*n);t[s+0]=r/a,t[s+1]=o/a,t[s+2]=n/a,s+=3}return t}};d.buildEdgeIndices=function(){const e=[],t=[],i=[],s=[],r=[];let o=0;const n=new Uint16Array(3),a=new Uint16Array(3),l=new Uint16Array(3),A=d.vec3(),c=d.vec3(),h=d.vec3(),u=d.vec3(),p=d.vec3(),f=d.vec3(),m=d.vec3();return function(g,_,v,b){!function(r,o){const n={};let a,l,A,c;const h=Math.pow(10,4);let u,d,p=0;for(u=0,d=r.length;u<d;u+=3)a=r[u],l=r[u+1],A=r[u+2],c=Math.round(a*h)+"_"+Math.round(l*h)+"_"+Math.round(A*h),void 0===n[c]&&(n[c]=p/3,e[p++]=a,e[p++]=l,e[p++]=A),t[u/3]=n[c];for(u=0,d=o.length;u<d;u++)s[u]=t[o[u]],i[s[u]]=o[u]}(g,_),function(t,i){o=0;for(let g=0,_=t;g<_;g+=3){const t=3*s[g],_=3*s[g+1],v=3*s[g+2];i?(n[0]=e[t],n[1]=e[t+1],n[2]=e[t+2],a[0]=e[_],a[1]=e[_+1],a[2]=e[_+2],l[0]=e[v],l[1]=e[v+1],l[2]=e[v+2],d.decompressPosition(n,i,A),d.decompressPosition(a,i,c),d.decompressPosition(l,i,h)):(A[0]=e[t],A[1]=e[t+1],A[2]=e[t+2],c[0]=e[_],c[1]=e[_+1],c[2]=e[_+2],h[0]=e[v],h[1]=e[v+1],h[2]=e[v+2]),d.subVec3(h,c,u),d.subVec3(A,c,p),d.cross3Vec3(u,p,f),d.normalizeVec3(f,m);const b=r[o]||(r[o]={normal:d.vec3()});b.normal[0]=m[0],b.normal[1]=m[1],b.normal[2]=m[2],o++}}(_.length,v);const y=[],w=Math.cos(d.DEGTORAD*b),B={};let P,x,C,M,E,F,I,T,D,S,R,U=!1;for(let e=0,t=_.length;e<t;e+=3){const t=e/3;for(let i=0;i<3;i++)P=s[e+i],x=s[e+(i+1)%3],C=Math.min(P,x),M=Math.max(P,x),E=C+","+M,void 0===B[E]?B[E]={index1:C,index2:M,face1:t,face2:void 0}:B[E].face2=t}for(E in B)F=B[E],void 0!==F.face2&&(I=r[F.face1].normal,T=r[F.face2].normal,D=d.dotVec3(I,T),D>w)||(S=i[F.index1],R=i[F.index2],(!U&&S>65535||R>65535)&&(U=!0),y.push(S),y.push(R));return U?new Uint32Array(y):new Uint16Array(y)}}(),d.planeClipsPositions3=function(e,t,i,s=3){for(let r=0,o=i.length;r<o;r+=s){if(A[0]=i[r+0]-e[0],A[1]=i[r+1]-e[1],A[2]=i[r+2]-e[2],A[0]*t[0]+A[1]*t[1]+A[2]*t[2]<0)return!0}return!1};const p=new Float32Array(3);class f{constructor(e){if(!e)throw"Parameter expected: cfg";if(!e.viewer)throw"Parameter expected: cfg.viewer";this.viewer=e.viewer,this._maxTreeDepth=e.maxTreeDepth||15,this._root=null,this._needsRebuild=!0,this._onModelLoaded=this.viewer.scene.on("modelLoaded",(e=>{this._needsRebuild=!0})),this._onModelUnloaded=this.viewer.scene.on("modelUnloaded",(e=>{this._needsRebuild=!0}))}get root(){return this._needsRebuild&&this._rebuild(),this._root}_rebuild(){const e=this.viewer.scene;this._root={aabb:e.getAABB()};for(let t in e.objects){const i=e.objects[t];this._insertEntity(this._root,i,1)}this._needsRebuild=!1}_insertEntity(e,t,i){const s=t.aabb;if(i>=this._maxTreeDepth)return e.entities=e.entities||[],void e.entities.push(t);if(e.left&&d.containsAABB3(e.left.aabb,s))return void this._insertEntity(e.left,t,i+1);if(e.right&&d.containsAABB3(e.right.aabb,s))return void this._insertEntity(e.right,t,i+1);const r=e.aabb;p[0]=r[3]-r[0],p[1]=r[4]-r[1],p[2]=r[5]-r[2];let o=0;if(p[1]>p[o]&&(o=1),p[2]>p[o]&&(o=2),!e.left){const n=r.slice();if(n[o+3]=(r[o]+r[o+3])/2,e.left={aabb:n},d.containsAABB3(n,s))return void this._insertEntity(e.left,t,i+1)}if(!e.right){const n=r.slice();if(n[o]=(r[o]+r[o+3])/2,e.right={aabb:n},d.containsAABB3(n,s))return void this._insertEntity(e.right,t,i+1)}e.entities=e.entities||[],e.entities.push(t)}destroy(){const e=this.viewer.scene;e.off(this._onModelLoaded),e.off(this._onModelUnloaded),this._root=null,this._needsRebuild=!0}}class m{constructor(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}get length(){return this._length}shift(){if(this._index>=this._headLength){const e=this._head;if(e.length=0,this._head=this._tail,this._tail=e,this._index=0,this._headLength=this._head.length,!this._headLength)return}const e=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,e}push(e){return this._length++,this._tail.push(e),this}unshift(e){return this._head[--this._index]=e,this._length++,this}}const g={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};var _=[["0",10],["A",26],["a",26],["_",1],["$",1]].map((function(e){for(var t=[],i=e[0].charCodeAt(0),s=i+e[1],r=i;r<s;++r)t.push(r);return String.fromCharCode.apply(null,t)})).join("");function v(e,t){return(t&&4!==t?[0,6]:[0,6,12,18]).map((function(t){return _.substr(parseInt(e/(1<<t))%64,1)})).reverse().join("")}const b=function(){for(var e={},t=window.location.search.substring(1).split("&"),i=0;i<t.length;i++){var s=t[i].split("=");if(void 0===e[s[0]])e[s[0]]=decodeURIComponent(s[1]);else if("string"==typeof e[s[0]]){var r=[e[s[0]],decodeURIComponent(s[1])];e[s[0]]=r}else e[s[0]].push(decodeURIComponent(s[1]))}return e}();const y={xmlToJson:function e(t,i){if(t.nodeType===t.TEXT_NODE){var s=t.nodeValue;if(null===s.match(/^\s+$/))return s}else if(t.nodeType===t.ELEMENT_NODE||t.nodeType===t.DOCUMENT_NODE){var r={type:t.nodeName,children:[]};if(t.nodeType===t.ELEMENT_NODE)for(var o=0;o<t.attributes.length;o++){var n=t.attributes[o];r[i[n.nodeName]||n.nodeName]=n.nodeValue}for(var a=0;a<t.childNodes.length;a++){(o=e(t.childNodes[a],i))&&r.children.push(o)}return r}},clone:function(e){return JSON.parse(JSON.stringify(e))},compressGuid:function(e){var t=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map((function(t){return parseInt(e.substr(t,2),16)}));return v(t[0],2)+[1,4,7,10,13].map((function(e){return v((t[e]<<16)+(t[e+1]<<8)+t[e+2])})).join("")},findNodeOfType:function(e,t){var i=[],s=function(e){e.type===t&&i.push(e),(e.children||[]).forEach((function(e){s(e)}))};return s(e),i},timeout:function(e){return new Promise((function(t,i){setTimeout(t,e)}))},httpRequest:function(e){return new Promise((function(t,i){var s=new XMLHttpRequest;s.open(e.method||"GET",e.url,!0),s.onload=function(e){4===s.readyState&&(200===s.status?t(s.responseXML):i(s.statusText))},s.send(null)}))},loadJSON:function(e,t,i){var s=e=>{};t=t||s,i=i||s;var r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.open("GET",e,!0),r.addEventListener("load",(function(e){var s=e.target.response;if(200===this.status){var r;try{r=JSON.parse(s)}catch(e){i(`utils.loadJSON(): Failed to parse JSON response - ${e}`)}t(r)}else if(0===this.status){console.warn("loadFile: HTTP Status 0 received.");try{t(JSON.parse(s))}catch(e){i(`utils.loadJSON(): Failed to parse JSON response - ${e}`)}}else i(e)}),!1),r.addEventListener("error",(function(e){i(e)}),!1),r.send(null)},loadArraybuffer:function(e,t,i){var s=e=>{};t=t||s,i=i||s;const r=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const e=!!r[2];var o=r[3];o=window.decodeURIComponent(o),e&&(o=window.atob(o));try{const e=new ArrayBuffer(o.length),i=new Uint8Array(e);for(var n=0;n<o.length;n++)i[n]=o.charCodeAt(n);I.scheduleTask((()=>{t(e)}))}catch(e){I.scheduleTask((()=>{i(e)}))}}else{const s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?t(s.response):i("loadArrayBuffer error : "+s.response))},s.send(null)}},queryString:b,isArray:function(e){return e&&!e.propertyIsEnumerable("length")&&"object"==typeof e&&"number"==typeof e.length},isString:function(e){return"string"==typeof e||e instanceof String},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},isID:function(e){return y.isString(e)||y.isNumeric(e)},isSameComponent:function(e,t){return!(!e||!t)&&(y.isNumeric(e)||y.isString(e)?`${e}`:e.id)===(y.isNumeric(t)||y.isString(t)?`${t}`:t.id)},isFunction:function(e){return"function"==typeof e},isObject:function(e){const t={}.constructor;return!!e&&e.constructor===t},copy:function(e){return y.apply(e,{})},apply:function(e,t){for(const i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t},apply2:function(e,t){for(const i in e)e.hasOwnProperty(i)&&void 0!==e[i]&&null!==e[i]&&(t[i]=e[i]);return t},applyIf:function(e,t){for(const i in e)e.hasOwnProperty(i)&&(void 0!==t[i]&&null!==t[i]||(t[i]=e[i]));return t},isEmptyObject:function(e){for(const t in e)if(e.hasOwnProperty(t))return!1;return!0},inQuotes:function(e){return y.isNumeric(e)?`${e}`:`'${e}'`},concat:function(e,t){const i=new e.constructor(e.length+t.length);return i.set(e),i.set(t,e.length),i},flattenParentChildHierarchy:function(e){var t=[];return function e(i){i.id=i.uuid,delete i.oid,t.push(i);var s=i.children;if(s)for(var r=0,o=s.length;r<o;r++){s[r].parent=i.id,e(s[r])}i.children=[]}(e),t}},w={},B=new e,P=new m,x={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},C=[];let M,E=0,F=0;const I=new function(){this.version="1.0.0",this.scenes={},this._superTypes={},this._addScene=function(e){if(e.id){if(I.scenes[e.id])return void console.error(`[ERROR] Scene ${y.inQuotes(e.id)} already exists`)}else e.id=B.addItem({});I.scenes[e.id]=e;const t=e.ticksPerOcclusionTest,i=e.ticksPerRender;w[e.id]={ticksPerOcclusionTest:t,ticksPerRender:i,renderCountdown:i},g.components.scenes++,e.once("destroyed",(()=>{B.removeItem(e.id),delete I.scenes[e.id],delete w[e.id],g.components.scenes--}))},this.clear=function(){let e;for(const t in I.scenes)I.scenes.hasOwnProperty(t)&&(e=I.scenes[t],"default.scene"===t?e.clear():(e.destroy(),delete I.scenes[e.id]))},this.scheduleTask=function(e,t=null){P.push(e),P.push(t)},this.runTasks=function(e=-1){let t,i,s=(new Date).getTime(),r=0;for(;P.length>0&&(e<0||s<e);)t=P.shift(),i=P.shift(),i?t.call(i):t(),s=(new Date).getTime(),r++;return r},this.getNumTasks=function(){return P.length}},T=function(){let e=Date.now();if(M=e-E,E>0&&M>0){var t=1e3/M;F+=t,C.push(t),C.length>=30&&(F-=C.shift()),g.frame.fps=Math.round(F/C.length)}for(let e in I.scenes)I.scenes[e].compile();S(e),E=e};!function(e,t){let i=Date.now()+t;(function s(){const r=Date.now()-i;e(),i+=t,setTimeout(s,Math.max(0,t-r))})()}((()=>{T()}),100);const D=function(){let e=Date.now();if(M=e-E,E>0&&M>0){var t=1e3/M;F+=t,C.push(t),C.length>=30&&(F-=C.shift()),g.frame.fps=Math.round(F/C.length)}S(e),function(e){for(var t in x.time=e,I.scenes)if(I.scenes.hasOwnProperty(t)){var i=I.scenes[t];x.sceneId=t,x.startTime=i.startTime,x.deltaTime=null!=x.prevTime?x.time-x.prevTime:0,i.fire("tick",x,!0)}x.prevTime=e}(e),function(){const e=I.scenes,t=!1;let i,s,r,o,n;for(n in e)e.hasOwnProperty(n)&&(i=e[n],s=w[n],s||(s=w[n]={}),r=i.ticksPerOcclusionTest,s.ticksPerOcclusionTest!==r&&(s.ticksPerOcclusionTest=r,s.renderCountdown=r),--i.occlusionTestCountdown<=0&&(i.doOcclusionTest(),i.occlusionTestCountdown=r),o=i.ticksPerRender,s.ticksPerRender!==o&&(s.ticksPerRender=o,s.renderCountdown=o),0==--s.renderCountdown&&(i.render(t),s.renderCountdown=o))}(),void 0!==window.requestPostAnimationFrame?window.requestPostAnimationFrame(T):requestAnimationFrame(D)};function S(e){const t=I.runTasks(e+10),i=I.getNumTasks();g.frame.tasksRun=t,g.frame.tasksScheduled=i,g.frame.tasksBudget=10}D();class R{get type(){return"Component"}get isComponent(){return!0}constructor(e=null,t={}){if(this.scene=null,"Scene"===this.type)this.scene=this,this.viewer=t.viewer;else{if("Scene"===e.type)this.scene=e;else{if(!(e instanceof R))throw"Invalid param: owner must be a Component";this.scene=e.scene}this._owner=e}this._dontClear=!!t.dontClear,this._renderer=this.scene._renderer,this.meta=t.meta||{},this.id=t.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,e&&e._own(this)}glRedraw(){this._renderer&&(this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty())}glResort(){this._renderer&&this._renderer.needStateSort()}get owner(){return this._owner}isType(e){return this.type===e}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),!0!==i&&(this._events[e]=t||!0);const s=this._eventSubs[e];let r;if(s)for(const i in s)s.hasOwnProperty(i)&&(r=s[i],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(t,i,s){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new e),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let r=this._eventSubs[t];r?this._eventSubsNum[t]++:(r={},this._eventSubs[t]=r,this._eventSubsNum[t]=1);const o=this._subIdMap.addItem();r[o]={callback:i,scope:s||this},this._subIdEvents[o]=t;const n=this._events[t];return void 0!==n&&i.call(s||this,n),o}off(e){if(null==e)return;if(!this._subIdEvents)return;const t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];const i=this._eventSubs[t];i&&(delete i[e],this._eventSubsNum[t]--),this._subIdMap.removeItem(e)}}once(e,t,i){const s=this,r=this.on(e,(function(e){s.off(r),t.call(i||this,e)}),i)}hasSubs(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}log(e){e="[LOG]"+this._message(e),window.console.log(e),this.scene.fire("log",e)}_message(e){return" ["+this.type+" "+y.inQuotes(this.id)+"]: "+e}warn(e){e="[WARN]"+this._message(e),window.console.warn(e),this.scene.fire("warn",e)}error(e){e="[ERROR]"+this._message(e),window.console.error(e),this.scene.fire("error",e)}_attach(e){const t=e.name;if(!t)return void this.error("Component 'name' expected");let i=e.component;const s=e.sceneDefault,r=e.sceneSingleton,o=e.type,n=e.on,a=!1!==e.recompiles;if(i&&(y.isNumeric(i)||y.isString(i))){const e=i;if(i=this.scene.components[e],!i)return void this.error("Component not found: "+y.inQuotes(e))}if(!i)if(!0===r){const e=this.scene.types[o];for(const t in e)if(e.hasOwnProperty){i=e[t];break}if(!i)return this.error("Scene has no default component for '"+t+"'"),null}else if(!0===s&&(i=this.scene[t],!i))return this.error("Scene has no default component for '"+t+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+y.inQuotes(i.id));if(o&&!i.isType(o))return void this.error("Expected a "+o+" type or subtype: "+i.type+" "+y.inQuotes(i.id))}this._attachments||(this._attachments={});const l=this._attached[t];let A,c,h;if(l){if(i&&l.id===i.id)return;const e=this._attachments[l.id];for(A=e.subs,c=0,h=A.length;c<h;c++)l.off(A[c]);delete this._attached[t],delete this._attachments[l.id];const s=e.params.onDetached;s&&(y.isFunction(s)?s(l):s.scope?s.callback.call(s.scope,l):s.callback(l)),e.managingLifecycle&&l.destroy()}if(i){const s={params:e,component:i,subs:[],managingLifecycle:false};s.subs.push(i.once("destroyed",(function(){s.params.component=null,this._attach(s.params)}),this)),a&&s.subs.push(i.on("dirty",(function(){this.fire("dirty",this)}),this)),this._attached[t]=i,this._attachments[i.id]=s;const r=e.onAttached;if(r&&(y.isFunction(r)?r(i):r.scope?r.callback.call(r.scope,i):r.callback(i)),n){let e,t,r,o;for(e in n)if(n.hasOwnProperty(e)){if(t=n[e],y.isFunction(t)?(r=t,o=null):(r=t.callback,o=t.scope),!r)continue;s.subs.push(i.on(e,r,o))}}}return a&&this.fire("dirty",this),this.fire(t,i),i}_checkComponent(e,t){if(!t.isComponent){if(!y.isID(t))return void this.error("Expected a Component or ID");{const e=t;if(!(t=this.scene.components[e]))return void this.error("Component not found: "+e)}}if(e===t.type){if(t.scene.id===this.scene.id)return t;this.error("Not in same scene: "+t.type)}else this.error("Expected a "+e+" Component")}_checkComponent2(e,t){if(!t.isComponent){if(!y.isID(t))return void this.error("Expected a Component or ID");{const e=t;if(!(t=this.scene.components[e]))return void this.error("Component not found: "+e)}}if(t.scene.id===this.scene.id){for(var i=0,s=e.length;i<s;i++)if(e[i]===t.type)return t;return this.error("Expected component types: "+e),null}this.error("Not in same scene: "+t.type)}_own(e){this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[e.id]||(this._ownedComponents[e.id]=e),e.once("destroyed",(()=>{delete this._ownedComponents[e.id]}),this)}_needUpdate(e){this._updateScheduled||(this._updateScheduled=!0,0===e?this._doUpdate():I.scheduleTask(this._doUpdate,this))}_doUpdate(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())}scheduleTask(e){I.scheduleTask(e,null)}_update(){}clear(){if(this._ownedComponents)for(var e in this._ownedComponents)if(this._ownedComponents.hasOwnProperty(e)){this._ownedComponents[e].destroy(),delete this._ownedComponents[e]}}destroy(){if(this.destroyed)return;let e,t,i,s,r,o;if(this.fire("destroyed",this.destroyed=!0),this._attachments)for(e in this._attachments)if(this._attachments.hasOwnProperty(e)){for(t=this._attachments[e],i=t.component,s=t.subs,r=0,o=s.length;r<o;r++)i.off(s[r]);t.managingLifecycle&&i.destroy()}if(this._ownedComponents)for(e in this._ownedComponents)this._ownedComponents.hasOwnProperty(e)&&(i=this._ownedComponents[e],i.destroy(),delete this._ownedComponents[e]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1}}const U=d.vec3(),L=d.vec3(),k=d.mat4();class O{constructor(){this.normal=d.vec3(),this.offset=0,this.testVertex=d.vec3()}set(e,t,i,s){const r=1/Math.sqrt(e*e+t*t+i*i);this.normal[0]=e*r,this.normal[1]=t*r,this.normal[2]=i*r,this.offset=s*r,this.testVertex[0]=this.normal[0]>=0?1:0,this.testVertex[1]=this.normal[1]>=0?1:0,this.testVertex[2]=this.normal[2]>=0?1:0}}class N{constructor(){this.planes=[new O,new O,new O,new O,new O,new O]}}function V(e,t,i){const s=d.mulMat4(i,t,k),r=s[0],o=s[1],n=s[2],a=s[3],l=s[4],A=s[5],c=s[6],h=s[7],u=s[8],p=s[9],f=s[10],m=s[11],g=s[12],_=s[13],v=s[14],b=s[15];e.planes[0].set(a-r,h-l,m-u,b-g),e.planes[1].set(a+r,h+l,m+u,b+g),e.planes[2].set(a-o,h-A,m-p,b-_),e.planes[3].set(a+o,h+A,m+p,b+_),e.planes[4].set(a-n,h-c,m-f,b-v),e.planes[5].set(a+n,h+c,m+f,b+v)}function Q(e,t){let i=N.INSIDE;const s=U,r=L;s[0]=t[0],s[1]=t[1],s[2]=t[2],r[0]=t[3],r[1]=t[4],r[2]=t[5];const o=[s,r];for(let t=0;t<6;++t){const s=e.planes[t];if(s.normal[0]*o[s.testVertex[0]][0]+s.normal[1]*o[s.testVertex[1]][1]+s.normal[2]*o[s.testVertex[2]][2]+s.offset<0)return N.OUTSIDE;s.normal[0]*o[1-s.testVertex[0]][0]+s.normal[1]*o[1-s.testVertex[1]][1]+s.normal[2]*o[1-s.testVertex[2]][2]+s.offset<0&&(i=N.INTERSECT)}return i}N.INSIDE=0,N.INTERSECT=1,N.OUTSIDE=2;class H extends R{constructor(e={}){if(!e.viewer)throw"[MarqueePicker] Missing config: viewer";if(!e.objectsKdTree3)throw"[MarqueePicker] Missing config: objectsKdTree3";super(e.viewer.scene,e),this.viewer=e.viewer,this._objectsKdTree3=e.objectsKdTree3,this._canvasMarqueeCorner1=d.vec2(),this._canvasMarqueeCorner2=d.vec2(),this._canvasMarquee=d.AABB2(),this._marqueeFrustum=new N,this._marqueeFrustumProjMat=d.mat4(),this._pickMode=!1,this._marqueeElement=document.createElement("div"),document.body.appendChild(this._marqueeElement),this._marqueeElement.style.position="absolute",this._marqueeElement.style["z-index"]="40000005",this._marqueeElement.style.width="8px",this._marqueeElement.style.height="8px",this._marqueeElement.style.visibility="hidden",this._marqueeElement.style.top="0px",this._marqueeElement.style.left="0px",this._marqueeElement.style["box-shadow"]="0 2px 5px 0 #182A3D;",this._marqueeElement.style.opacity=1,this._marqueeElement.style["pointer-events"]="none"}setMarqueeCorner1(e){this._canvasMarqueeCorner1.set(e),this._canvasMarqueeCorner2.set(e),this._updateMarquee()}setMarqueeCorner2(e){this._canvasMarqueeCorner2.set(e),this._updateMarquee()}setMarquee(e,t){this._canvasMarqueeCorner1.set(e),this._canvasMarqueeCorner2.set(t),this._updateMarquee()}setMarqueeVisible(e){this._marqueVisible=e,this._marqueeElement.style.visibility=e?"visible":"hidden"}getMarqueeVisible(){return this._marqueVisible}setPickMode(e){if(e!==H.PICK_MODE_INSIDE&&e!==H.PICK_MODE_INTERSECTS)throw"Illegal MarqueePicker pickMode: must be MarqueePicker.PICK_MODE_INSIDE or MarqueePicker.PICK_MODE_INTERSECTS";e!==this._pickMode&&(this._marqueeElement.style["background-image"]=e===H.PICK_MODE_INSIDE?"url(\"data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='6' ry='6' stroke='%23333' stroke-width='4'/%3e%3c/svg%3e\")":"url(\"data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='6' ry='6' stroke='%23333' stroke-width='4' stroke-dasharray='6%2c 14' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e\")",this._pickMode=e)}getPickMode(){return this._pickMode}clear(){this.fire("clear",{})}pick(){this._updateMarquee(),this._buildMarqueeFrustum();const e=[],t=(i,s=N.INTERSECT)=>{if(s===N.INTERSECT&&(s=Q(this._marqueeFrustum,i.aabb)),s!==N.OUTSIDE){if(i.entities){const t=i.entities;for(let i=0,s=t.length;i<s;i++){const s=t[i];if(!s.visible)continue;const r=s.aabb;if(this._pickMode===H.PICK_MODE_INSIDE){Q(this._marqueeFrustum,r)===N.INSIDE&&e.push(s.id)}else{Q(this._marqueeFrustum,r)!==N.OUTSIDE&&e.push(s.id)}}}i.left&&t(i.left,s),i.right&&t(i.right,s)}};return(this._canvasMarquee[2]-this._canvasMarquee[0]>3||this._canvasMarquee[3]-this._canvasMarquee[1]>3)&&t(this._objectsKdTree3.root),this.fire("picked",e),e}_updateMarquee(){this._canvasMarquee[0]=Math.min(this._canvasMarqueeCorner1[0],this._canvasMarqueeCorner2[0]),this._canvasMarquee[1]=Math.min(this._canvasMarqueeCorner1[1],this._canvasMarqueeCorner2[1]),this._canvasMarquee[2]=Math.max(this._canvasMarqueeCorner1[0],this._canvasMarqueeCorner2[0]),this._canvasMarquee[3]=Math.max(this._canvasMarqueeCorner1[1],this._canvasMarqueeCorner2[1]),this._marqueeElement.style.width=this._canvasMarquee[2]-this._canvasMarquee[0]+"px",this._marqueeElement.style.height=this._canvasMarquee[3]-this._canvasMarquee[1]+"px",this._marqueeElement.style.left=`${this._canvasMarquee[0]}px`,this._marqueeElement.style.top=`${this._canvasMarquee[1]}px`}_buildMarqueeFrustum(){const e=this.viewer.scene.canvas.canvas,t=e.clientWidth,i=e.clientHeight,s=e.clientLeft,r=e.clientTop,o=2/t,n=2/i,a=e.clientHeight/e.clientWidth,l=(this._canvasMarquee[0]-s)*o-1,A=(this._canvasMarquee[2]-s)*o-1,c=-(this._canvasMarquee[3]-r)*n+1,h=-(this._canvasMarquee[1]-r)*n+1,u=this.viewer.scene.camera.frustum.near*(17*a);d.frustumMat4(l,A,c*a,h*a,u,1e4,this._marqueeFrustumProjMat),V(this._marqueeFrustum,this.viewer.scene.camera.viewMatrix,this._marqueeFrustumProjMat)}destroy(){super.destroy(),this._marqueeElement.parentElement&&(this._marqueeElement.parentElement.removeChild(this._marqueeElement),this._marqueeElement=null,this._objectsKdTree3=null)}}H.PICK_MODE_INTERSECTS=0,H.PICK_MODE_INSIDE=1;class j extends R{constructor(e){super(e.marqueePicker,e);const t=e.marqueePicker,i=t.viewer.scene.canvas.canvas;let s,r,o,n,a,l,A,c=!1,h=!1,u=!1;i.addEventListener("mousedown",(e=>{this.getActive()&&0===e.button&&(A=setTimeout((function(){const o=t.viewer.scene.input;o.keyDown[o.KEY_CTRL]||t.clear(),s=e.pageX,r=e.pageY,a=e.offsetX,t.setMarqueeCorner1([s,r]),c=!0,t.viewer.cameraControl.pointerEnabled=!1,t.setMarqueeVisible(!0),i.style.cursor="crosshair"}),400),h=!0)})),i.addEventListener("mouseup",(e=>{if(!this.getActive())return;if(!c&&!u)return;if(0!==e.button)return;clearTimeout(A),o=e.pageX,n=e.pageY;const i=Math.abs(o-s),a=Math.abs(n-r);c=!1,t.viewer.cameraControl.pointerEnabled=!0,u&&(u=!1),(i>3||a>3)&&t.pick()})),document.addEventListener("mouseup",(e=>{this.getActive()&&0===e.button&&(clearTimeout(A),c&&(t.setMarqueeVisible(!1),c=!1,h=!1,u=!0,t.viewer.cameraControl.pointerEnabled=!0))}),!0),i.addEventListener("mousemove",(e=>{this.getActive()&&0===e.button&&h&&(clearTimeout(A),c&&(o=e.pageX,n=e.pageY,l=e.offsetX,t.setMarqueeVisible(!0),t.setMarqueeCorner2([o,n]),t.setPickMode(a<l?H.PICK_MODE_INSIDE:H.PICK_MODE_INTERSECTS)))}))}setActive(e){this._active!==e&&(this._active=e,this.fire("active",this._active))}getActive(){return this._active}destroy(){}}class G{constructor(e,t={}){this.viewer=e,this.scene=this.viewer.scene,this._circleDiv=document.createElement("div"),this.viewer.scene.canvas.canvas.parentNode.insertBefore(this._circleDiv,this.viewer.scene.canvas.canvas),this._circleDiv.style.backgroundColor="transparent",this._circleDiv.style.border="2px solid green",this._circleDiv.style.borderRadius="50px",this._circleDiv.style.width="50px",this._circleDiv.style.height="50px",this._circleDiv.style.margin="-200px -200px",this._circleDiv.style.zIndex="100000",this._circleDiv.style.position="absolute",this._circleDiv.style.pointerEvents="none",this._circlePos=null,this._circleMaxRadius=200,this._circleMinRadius=2,this._active=!1!==t.active,this._visible=!1,this._running=!1,this._destroyed=!1}start(e){if(this._destroyed)return;this._circlePos=e,this._running=!1,this._circleRadius=this._circleMaxRadius,this._circleDiv.style.borderRadius=`${this._circleRadius}px`,this._circleDiv.style.marginLeft=this._circlePos[0]-this._circleRadius+"px",this._circleDiv.style.marginTop=this._circlePos[1]-this._circleRadius+"px";const t=this._circleMaxRadius;let i;const s=e=>{if(!this._running)return;i||(i=e);const r=e-i,o=Math.min(r/300,1),n=t+(2-t)*o;this._circleRadius=n,this._circleDiv.style.width=`${this._circleRadius}px`,this._circleDiv.style.height=`${this._circleRadius}px`,this._circleDiv.style.marginLeft=this._circlePos[0]-this._circleRadius/2+"px",this._circleDiv.style.marginTop=this._circlePos[1]-this._circleRadius/2+"px",o<1&&requestAnimationFrame(s)};this._running=!0,requestAnimationFrame(s),this._circleDiv.style.visibility="visible"}stop(){this._destroyed||(this._running=!1,this._circleRadius=this._circleMaxRadius,this._circleDiv.style.borderRadius=`${this._circleRadius}px`,this._circleDiv.style.visibility="hidden")}set durationMs(e){this.stop(),this._durationMs=e}get durationMs(){return this._durationMs}destroy(){this._destroyed||(this.stop(),this._circleDiv.parentElement.removeChild(this._circleDiv),this._destroyed=!0)}}class z{constructor(e={}){this._eventSubIDMap=null,this._eventSubEvents=null,this._eventSubs=null,this._events=null,this._locale="en",this._messages={},this._locales=[],this._locale="en",this.messages=e.messages,this.locale=e.locale}set messages(e){this._messages=e||{},this._locales=Object.keys(this._messages),this.fire("updated",this)}loadMessages(e={}){for(let t in e)this._messages[t]=e[t];this.messages=this._messages}clearMessages(){this.messages={}}get locales(){return this._locales}set locale(e){e=e||"de",this._locale!==e&&(this._locale=e,this.fire("updated",e))}get locale(){return this._locale}translate(e,t){const i=this._messages[this._locale];if(!i)return null;const s=W(e,i);return s?t?X(s,t):s:null}translatePlurals(e,t,i){const s=this._messages[this._locale];if(!s)return null;let r=W(e,s);return r=0===(t=parseInt(""+t,10))?r.zero:t>1?r.other:r.one,r?(r=X(r,[t]),i&&(r=X(r,i)),r):null}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[e]=t||!0);const s=this._eventSubs[e];if(s)for(const e in s)if(s.hasOwnProperty(e)){s[e].callback(t)}}on(t,i){this._events||(this._events={}),this._eventSubIDMap||(this._eventSubIDMap=new e),this._eventSubEvents||(this._eventSubEvents={}),this._eventSubs||(this._eventSubs={});let s=this._eventSubs[t];s||(s={},this._eventSubs[t]=s);const r=this._eventSubIDMap.addItem();s[r]={callback:i},this._eventSubEvents[r]=t;const o=this._events[t];return void 0!==o&&i(o),r}off(e){if(null==e)return;if(!this._eventSubEvents)return;const t=this._eventSubEvents[e];if(t){delete this._eventSubEvents[e];const i=this._eventSubs[t];i&&delete i[e],this._eventSubIDMap.removeItem(e)}}}function W(e,t){if(t[e])return t[e];const i=e.split(".");let s=t;for(let e=0,t=i.length;s&&e<t;e++){s=s[i[e]]}return s}function X(e,t=[]){return e.replace(/\{\{|\}\}|\{(\d+)\}/g,(function(e,i){return"{{"===e?"{":"}}"===e?"}":t[i]}))}class K extends R{constructor(e,t={}){super(e,t),this.t=t.t}set t(e){e=e||0,this._t=e<0?0:e>1?1:e}get t(){return this._t}get tangent(){return this.getTangent(this._t)}get length(){var e=this._getLengths();return e[e.length-1]}getTangent(e){var t=1e-4;void 0===e&&(e=this._t);var i=e-t,s=e+t;i<0&&(i=0),s>1&&(s=1);var r=this.getPoint(i),o=this.getPoint(s),n=d.subVec3(o,r,[]);return d.normalizeVec3(n,[])}getPointAt(e){var t=this.getUToTMapping(e);return this.getPoint(t)}getPoints(e){e||(e=5);var t,i=[];for(t=0;t<=e;t++)i.push(this.getPoint(t/e));return i}_getLengths(e){if(e||(e=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,i,s=[],r=this.getPoint(0),o=0;for(s.push(0),i=1;i<=e;i++)t=this.getPoint(i/e),o+=d.lenVec3(d.subVec3(t,r,[])),s.push(o),r=t;return this.cacheArcLengths=s,s}_updateArcLengths(){this.needsUpdate=!0,this._getLengths()}getUToTMapping(e,t){var i,s=this._getLengths(),r=0,o=s.length;i=t||e*s[o-1];for(var n,a=0,l=o-1;a<=l;)if((n=s[r=Math.floor(a+(l-a)/2)]-i)<0)a=r+1;else{if(!(n>0)){l=r;break}l=r-1}if(s[r=l]===i)return r/(o-1);var A=s[r];return(r+(i-A)/(s[r+1]-A))/(o-1)}}class Z extends K{constructor(e,t={}){super(e,t),this.points=t.points,this.t=t.t}set points(e){this._points=e||[]}get points(){return this._points}set t(e){e=e||0,this._t=e<0?0:e>1?1:e}get t(){return this._t}get point(){return this.getPoint(this._t)}getPoint(e){var t=this.points;if(!(t.length<3)){var i=(t.length-1)*e,s=Math.floor(i),r=i-s,o=t[0===s?s:s-1],n=t[s],a=t[s>t.length-2?t.length-1:s+1],l=t[s>t.length-3?t.length-1:s+2],A=d.vec3();return A[0]=d.catmullRomInterpolate(o[0],n[0],a[0],l[0],r),A[1]=d.catmullRomInterpolate(o[1],n[1],a[1],l[1],r),A[2]=d.catmullRomInterpolate(o[2],n[2],a[2],l[2],r),A}this.error("Can't sample point from SplineCurve - not enough points on curve - returning [0,0,0].")}getJSON(){return{points:points,t:this._t}}}const J=d.vec3();class Y extends R{get type(){return"CameraPath"}constructor(e,t={}){super(e,t),this._frames=[],this._eyeCurve=new Z(this),this._lookCurve=new Z(this),this._upCurve=new Z(this),t.frames&&(this.addFrames(t.frames),this.smoothFrameTimes(1))}get frames(){return this._frames}get eyeCurve(){return this._eyeCurve}get lookCurve(){return this._lookCurve}get upCurve(){return this._upCurve}saveFrame(e){const t=this.scene.camera;this.addFrame(e,t.eye,t.look,t.up)}addFrame(e,t,i,s){const r={t:e,eye:t.slice(0),look:i.slice(0),up:s.slice(0)};this._frames.push(r),this._eyeCurve.points.push(r.eye),this._lookCurve.points.push(r.look),this._upCurve.points.push(r.up)}addFrames(e){let t;for(let i=0,s=e.length;i<s;i++)t=e[i],this.addFrame(t.t||0,t.eye,t.look,t.up)}loadFrame(e){const t=this.scene.camera;e=(e/=this._frames[this._frames.length-1].t-this._frames[0].t)<0?0:e>1?1:e,t.eye=this._eyeCurve.getPoint(e,J),t.look=this._lookCurve.getPoint(e,J),t.up=this._upCurve.getPoint(e,J)}sampleFrame(e,t,i,s){e=e<0?0:e>1?1:e,this._eyeCurve.getPoint(e,t),this._lookCurve.getPoint(e,i),this._upCurve.getPoint(e,s)}smoothFrameTimes(e){if(0===this._frames.length)return;const t=d.vec3();var i=0;this._frames[0].t=0;const s=[];for(let e=1,o=this._frames.length;e<o;e++){var r=d.lenVec3(d.subVec3(this._frames[e].eye,this._frames[e-1].eye,t));s[e]=r,i+=r}for(let t=1,r=this._frames.length;t<r;t++){const r=s[t]/i*e;this._frames[t].t=this._frames[t-1].t+r}}clearFrames(){this._frames=[],this._eyeCurve.points=[],this._lookCurve.points=[],this._upCurve.points=[]}}const q=d.vec3(),$=d.vec3(),ee=d.vec3(),te=d.vec3(),ie=d.vec3();class se extends R{get type(){return"CameraFlightAnimation"}constructor(e,t={}){super(e,t),this._look1=d.vec3(),this._eye1=d.vec3(),this._up1=d.vec3(),this._look2=d.vec3(),this._eye2=d.vec3(),this._up2=d.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=!1!==t.easing,this.duration=t.duration,this.fit=t.fit,this.fitFOV=t.fitFOV,this.trail=t.trail}flyTo(e,t,i){e=e||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=t,this._callbackScope=i;const s=this.scene.camera,r=!!e.projection&&e.projection!==s.projection;let o,n,a,l,A;if(this._eye1[0]=s.eye[0],this._eye1[1]=s.eye[1],this._eye1[2]=s.eye[2],this._look1[0]=s.look[0],this._look1[1]=s.look[1],this._look1[2]=s.look[2],this._up1[0]=s.up[0],this._up1[1]=s.up[1],this._up1[2]=s.up[2],this._orthoScale1=s.ortho.scale,this._orthoScale2=e.orthoScale||this._orthoScale1,e.aabb)o=e.aabb;else if(6===e.length)o=e;else if(e.eye&&e.look||e.up)n=e.eye,a=e.look,l=e.up;else if(e.eye)n=e.eye;else if(e.look)a=e.look;else{let s=e;if((y.isNumeric(s)||y.isString(s))&&(A=s,s=this.scene.components[A],!s))return this.error("Component not found: "+y.inQuotes(A)),void(t&&(i?t.call(i):t()));r||(o=s.aabb||this.scene.aabb)}const c=e.poi;if(o){if(o[3]<o[0]||o[4]<o[1]||o[5]<o[2])return;if(o[3]===o[0]&&o[4]===o[1]&&o[5]===o[2])return;o=o.slice();const t=d.getAABB3Center(o);this._look2=c||t;const i=d.subVec3(this._eye1,this._look1,q),s=d.normalizeVec3(i),r=c?d.getAABB3DiagPoint(o,c):d.getAABB3Diag(o),n=e.fitFOV||this._fitFOV,a=Math.abs(r/Math.tan(n*d.DEGTORAD));this._orthoScale2=1.1*r,this._eye2[0]=this._look2[0]+s[0]*a,this._eye2[1]=this._look2[1]+s[1]*a,this._eye2[2]=this._look2[2]+s[2]*a,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(n||a||l)&&(this._flyingEyeLookUp=!!n&&!!a&&!!l,this._flyingEye=!!n&&!a,this._flyingLook=!!a&&!n,n&&(this._eye2[0]=n[0],this._eye2[1]=n[1],this._eye2[2]=n[2]),a&&(this._look2[0]=a[0],this._look2[1]=a[1],this._look2[2]=a[2]),l&&(this._up2[0]=l[0],this._up2[1]=l[1],this._up2[2]=l[2]));r?("ortho"===e.projection&&"ortho"!==s.projection&&(this._projection2="ortho",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.ortho.matrix.slice(),s.projection="customProjection"),"perspective"===e.projection&&"perspective"!==s.projection&&(this._projection2="perspective",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.perspective.matrix.slice(),s.projection="customProjection")):this._projection2=null,this.fire("started",e,!0),this._time1=Date.now(),this._time2=this._time1+(Number.isFinite(e.duration)?1e3*e.duration:this._duration),this._flying=!0,I.scheduleTask(this._update,this)}jumpTo(e){this._jumpTo(e)}_jumpTo(e){this._flying&&this.stop();const t=this.scene.camera;var i,s,r,o,n;if(e.aabb)i=e.aabb;else if(6===e.length)i=e;else if(e.eye||e.look||e.up)r=e.eye,o=e.look,n=e.up;else{let t=e;if((y.isNumeric(t)||y.isString(t))&&(s=t,t=this.scene.components[s],!t))return void this.error("Component not found: "+y.inQuotes(s));i=t.aabb||this.scene.aabb}const a=e.poi;if(i){if(i[3]<=i[0]||i[4]<=i[1]||i[5]<=i[2])return;var l=a?d.getAABB3DiagPoint(i,a):d.getAABB3Diag(i);let s;o=a||d.getAABB3Center(i,o),this._trail?d.subVec3(t.look,o,ie):d.subVec3(t.eye,t.look,ie),d.normalizeVec3(ie);s=(void 0!==e.fit?e.fit:this._fit)?Math.abs(l/Math.tan((e.fitFOV||this._fitFOV)*d.DEGTORAD)):d.lenVec3(d.subVec3(t.eye,t.look,q)),d.mulVec3Scalar(ie,s),t.eye=d.addVec3(o,ie,q),t.look=o,this.scene.camera.ortho.scale=1.1*l}else(r||o||n)&&(r&&(t.eye=r),o&&(t.look=o),n&&(t.up=n));e.projection&&(t.projection=e.projection)}_update(){if(!this._flying)return;let e=(Date.now()-this._time1)/(this._time2-this._time1);const t=e>=1;e>1&&(e=1);const i=this.easing?se._ease(e,0,1,1):e,s=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(d.subVec3(s.eye,s.look,ie),s.eye=d.lerpVec3(i,0,1,this._eye1,this._eye2,ee),s.look=d.subVec3(ee,ie,$)):this._flyingLook&&(s.look=d.lerpVec3(i,0,1,this._look1,this._look2,$),s.up=d.lerpVec3(i,0,1,this._up1,this._up2,te)):this._flyingEyeLookUp&&(s.eye=d.lerpVec3(i,0,1,this._eye1,this._eye2,ee),s.look=d.lerpVec3(i,0,1,this._look1,this._look2,$),s.up=d.lerpVec3(i,0,1,this._up1,this._up2,te)),this._projection2){const t="ortho"===this._projection2?se._easeOutExpo(e,0,1,1):se._easeInCubic(e,0,1,1);s.customProjection.matrix=d.lerpMat4(t,0,1,this._projMatrix1,this._projMatrix2)}else s.ortho.scale=this._orthoScale1+e*(this._orthoScale2-this._orthoScale1);if(t)return s.ortho.scale=this._orthoScale2,void this.stop();I.scheduleTask(this._update,this)}static _ease(e,t,i,s){return-i*(e/=s)*(e-2)+t}static _easeInCubic(e,t,i,s){return i*(e/=s)*e*e+t}static _easeOutExpo(e,t,i,s){return i*(1-Math.pow(2,-10*e/s))+t}stop(){if(!this._flying)return;this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);const e=this._callback;e&&(this._callback=null,this._callbackScope?e.call(this._callbackScope):e()),this.fire("stopped",!0,!0)}cancel(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}set duration(e){this._duration=Number.isFinite(e)?1e3*e:500,this.stop()}get duration(){return this._duration/1e3}set fit(e){this._fit=!1!==e}get fit(){return this._fit}set fitFOV(e){this._fitFOV=e||45}get fitFOV(){return this._fitFOV}set trail(e){this._trail=!!e}get trail(){return this._trail}destroy(){this.stop(),super.destroy()}}class re extends R{get type(){return"CameraPathAnimation"}constructor(e,t={}){super(e,t),this._cameraFlightAnimation=new se(this),this._t=0,this.state=re.SCRUBBING,this._playingFromT=0,this._playingToT=0,this._playingRate=t.playingRate||1,this._playingDir=1,this._lastTime=null,this.cameraPath=t.cameraPath,this._tick=this.scene.on("tick",this._updateT,this)}_updateT(){const e=this._cameraPath;if(!e)return;let t,i;const s=performance.now(),r=this._lastTime?.001*(s-this._lastTime):0;if(this._lastTime=s,0!==r)switch(this.state){case re.SCRUBBING:return;case re.PLAYING:if(this._t+=this._playingRate*r,t=this._cameraPath.frames.length,0===t||this._playingDir<0&&this._t<=0||this._playingDir>0&&this._t>=this._cameraPath.frames[t-1].t)return this.state=re.SCRUBBING,this._t=this._cameraPath.frames[t-1].t,void this.fire("stopped");e.loadFrame(this._t);break;case re.PLAYING_TO:i=this._t+this._playingRate*r*this._playingDir,(this._playingDir<0&&i<=this._playingToT||this._playingDir>0&&i>=this._playingToT)&&(i=this._playingToT,this.state=re.SCRUBBING,this.fire("stopped")),this._t=i,e.loadFrame(this._t)}}_ease(e,t,i,s){return-i*(e/=s)*(e-2)+t}set cameraPath(e){this._cameraPath=e}get cameraPath(){return this._cameraPath}set rate(e){this._playingRate=e}get rate(){return this._playingRate}play(){this._cameraPath&&(this._lastTime=null,this.state=re.PLAYING)}playToT(e){this._cameraPath&&(this._playingFromT=this._t,this._playingToT=e,this._playingDir=this._playingToT-this._playingFromT<0?-1:1,this._lastTime=null,this.state=re.PLAYING_TO)}playToFrame(e){const t=this._cameraPath;if(!t)return;const i=t.frames[e];i?this.playToT(i.t):this.error("playToFrame - frame index out of range: "+e)}flyToFrame(e,t){const i=this._cameraPath;if(!i)return;const s=i.frames[e];s?(this.state=re.SCRUBBING,this._cameraFlightAnimation.flyTo(s,t)):this.error("flyToFrame - frame index out of range: "+e)}scrubToT(e){const t=this._cameraPath;if(!t)return;this.scene.camera&&(this._t=e,t.loadFrame(this._t),this.state=re.SCRUBBING)}scrubToFrame(e){const t=this._cameraPath;if(!t)return;if(!this.scene.camera)return;t.frames[e]?(t.loadFrame(this._t),this.state=re.SCRUBBING):this.error("playToFrame - frame index out of range: "+e)}stop(){this.state=re.SCRUBBING,this.fire("stopped")}destroy(){super.destroy(),this.scene.off(this._tick)}}re.STOPPED=0,re.SCRUBBING=1,re.PLAYING=2,re.PLAYING_TO=3;class oe extends R{get type(){return"Geometry"}get isGeometry(){return!0}constructor(e,t={}){super(e,t),g.memory.meshes++}destroy(){super.destroy(),g.memory.meshes--}}const ne=new e({});class ae{constructor(e){this.id=ne.addItem({});for(const t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}destroy(){ne.removeItem(this.id)}}class le{constructor(e,t,i,s,r,o,n,a,l){switch(this._gl=e,this.type=t,this.allocated=!1,this.ConstructorType=i.constructor,i.constructor){case Uint8Array:this.itemType=e.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=e.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=e.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=e.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=e.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=e.INT,this.itemByteSize=4;break;default:this.itemType=e.FLOAT,this.itemByteSize=4}this.usage=o,this.length=0,this.dataLength=s,this.numItems=0,this.itemSize=r,this.normalized=!!n,this.stride=a||0,this.offset=l||0,this._allocate(i)}_allocate(e){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,e.length>this.dataLength?e.slice(0,this.dataLength):e,this.usage),this._gl.bindBuffer(this.type,null),this.length=e.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}setData(e,t){this.allocated&&(e.length+(t||0)>this.length?(this.destroy(),this._allocate(e)):(this._gl.bindBuffer(this.type,this._handle),t||0===t?this._gl.bufferSubData(this.type,t*this.itemByteSize,e):this._gl.bufferData(this.type,e,this.usage),this._gl.bindBuffer(this.type,null)))}getData(e=0,t=this.numItems-e){if(!this.allocated)return[];const i=new this.ConstructorType(t*this.itemSize);return this._gl.bindBuffer(this.type,this._handle),this._gl.getBufferSubData(this.type,e*this.itemByteSize*this.itemSize,i,0,t*this.itemSize),i}bind(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)}unbind(){this.allocated&&this._gl.bindBuffer(this.type,null)}destroy(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}var Ae=function(){const e=[],t=[],i=[],s=[],r=[];let o=0;const n=new Uint16Array(3),a=new Uint16Array(3),l=new Uint16Array(3),A=d.vec3(),c=d.vec3(),h=d.vec3(),u=d.vec3(),p=d.vec3(),f=d.vec3(),m=d.vec3();return function(g,_,v,b){!function(r,o){const n={};let a,l,A,c;const h=Math.pow(10,4);let u,d,p=0;for(u=0,d=r.length;u<d;u+=3)a=r[u],l=r[u+1],A=r[u+2],c=Math.round(a*h)+"_"+Math.round(l*h)+"_"+Math.round(A*h),void 0===n[c]&&(n[c]=p/3,e[p++]=a,e[p++]=l,e[p++]=A),t[u/3]=n[c];for(u=0,d=o.length;u<d;u++)s[u]=t[o[u]],i[s[u]]=o[u]}(g,_),function(t,i){o=0;for(let g=0,_=t;g<_;g+=3){const t=3*s[g],_=3*s[g+1],v=3*s[g+2];i?(n[0]=e[t],n[1]=e[t+1],n[2]=e[t+2],a[0]=e[_],a[1]=e[_+1],a[2]=e[_+2],l[0]=e[v],l[1]=e[v+1],l[2]=e[v+2],d.decompressPosition(n,i,A),d.decompressPosition(a,i,c),d.decompressPosition(l,i,h)):(A[0]=e[t],A[1]=e[t+1],A[2]=e[t+2],c[0]=e[_],c[1]=e[_+1],c[2]=e[_+2],h[0]=e[v],h[1]=e[v+1],h[2]=e[v+2]),d.subVec3(h,c,u),d.subVec3(A,c,p),d.cross3Vec3(u,p,f),d.normalizeVec3(f,m);const b=r[o]||(r[o]={normal:d.vec3()});b.normal[0]=m[0],b.normal[1]=m[1],b.normal[2]=m[2],o++}}(_.length,v);const y=[],w=Math.cos(d.DEGTORAD*b),B={};let P,x,C,M,E,F,I,T,D,S,R,U=!1;for(let e=0,t=_.length;e<t;e+=3){const t=e/3;for(let i=0;i<3;i++)P=s[e+i],x=s[e+(i+1)%3],C=Math.min(P,x),M=Math.max(P,x),E=C+","+M,void 0===B[E]?B[E]={index1:C,index2:M,face1:t,face2:void 0}:B[E].face2=t}for(E in B)F=B[E],void 0!==F.face2&&(I=r[F.face1].normal,T=r[F.face2].normal,D=d.dotVec3(I,T),D>w)||(S=i[F.index1],R=i[F.index2],(!U&&S>65535||R>65535)&&(U=!0),y.push(S),y.push(R));return U?new Uint32Array(y):new Uint16Array(y)}}();const ce=function(){const e=d.mat4(),t=d.mat4();return function(i,s){s=s||d.mat4();const r=i[0],o=i[1],n=i[2],a=i[3]-r,l=i[4]-o,A=i[5]-n,c=65535;return d.identityMat4(e),d.translationMat4v(i,e),d.identityMat4(t),d.scalingMat4v([a/c,l/c,A/c],t),d.mulMat4(e,t,s),s}}();var he=function(){const e=d.mat4(),t=d.mat4();return function(i,s,r){const o=new Uint16Array(i.length),n=new Float32Array([r[0]!==s[0]?65535/(r[0]-s[0]):0,r[1]!==s[1]?65535/(r[1]-s[1]):0,r[2]!==s[2]?65535/(r[2]-s[2]):0]);let a;for(a=0;a<i.length;a+=3)o[a+0]=Math.max(0,Math.min(65535,Math.floor((i[a+0]-s[0])*n[0]))),o[a+1]=Math.max(0,Math.min(65535,Math.floor((i[a+1]-s[1])*n[1]))),o[a+2]=Math.max(0,Math.min(65535,Math.floor((i[a+2]-s[2])*n[2])));d.identityMat4(e),d.translationMat4v(s,e),d.identityMat4(t),d.scalingMat4v([(r[0]-s[0])/65535,(r[1]-s[1])/65535,(r[2]-s[2])/65535],t);return{quantized:o,decodeMatrix:d.mulMat4(e,t,d.identityMat4())}}}();var ue=function(){const e=d.mat3(),t=d.mat3();return function(i,s,r){const o=new Uint16Array(i.length),n=new Float32Array([65535/(r[0]-s[0]),65535/(r[1]-s[1])]);let a;for(a=0;a<i.length;a+=2)o[a+0]=Math.max(0,Math.min(65535,Math.floor((i[a+0]-s[0])*n[0]))),o[a+1]=Math.max(0,Math.min(65535,Math.floor((i[a+1]-s[1])*n[1])));d.identityMat3(e),d.translationMat3v(s,e),d.identityMat3(t),d.scalingMat3v([(r[0]-s[0])/65535,(r[1]-s[1])/65535],t);return{quantized:o,decodeMatrix:d.mulMat3(e,t,d.identityMat3())}}}();function de(e,t,i,s){let r=e[t]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2])),o=e[t+1]/(Math.abs(e[t])+Math.abs(e[t+1])+Math.abs(e[t+2]));if(e[t+2]<0){let e=(1-Math.abs(o))*(r>=0?1:-1),t=(1-Math.abs(r))*(o>=0?1:-1);r=e,o=t}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*o+(o<0?-1:0))])}function pe(e){let t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;const s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));const r=Math.sqrt(t*t+i*i+s*s);return[t/r,i/r,s/r]}function fe(e,t,i){return e[t]*i[0]+e[t+1]*i[1]+e[t+2]*i[2]}const me={getPositionsBounds:function(e){const t=new Float32Array(3),i=new Float32Array(3);let s,r;for(s=0;s<3;s++)t[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<e.length;s+=3)for(r=0;r<3;r++)t[r]=Math.min(t[r],e[s+r]),i[r]=Math.max(i[r],e[s+r]);return{min:t,max:i}},createPositionsDecodeMatrix:ce,compressPositions:he,compressPosition:function(e,t,i){const s=new Float32Array([t[3]!==t[0]?65535/(t[3]-t[0]):0,t[4]!==t[1]?65535/(t[4]-t[1]):0,t[5]!==t[2]?65535/(t[5]-t[2]):0]);i[0]=Math.max(0,Math.min(65535,Math.floor((e[0]-t[0])*s[0]))),i[1]=Math.max(0,Math.min(65535,Math.floor((e[1]-t[1])*s[1]))),i[2]=Math.max(0,Math.min(65535,Math.floor((e[2]-t[2])*s[2])))},decompressPositions:function(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[12],i[s+1]=e[s+1]*t[5]+t[13],i[s+2]=e[s+2]*t[10]+t[14];return i},decompressPosition:function(e,t,i){return i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14],i},decompressAABB:function(e,t,i=e){return i[0]=e[0]*t[0]+t[12],i[1]=e[1]*t[5]+t[13],i[2]=e[2]*t[10]+t[14],i[3]=e[3]*t[0]+t[12],i[4]=e[4]*t[5]+t[13],i[5]=e[5]*t[10]+t[14],i},getUVBounds:function(e){const t=new Float32Array(2),i=new Float32Array(2);let s,r;for(s=0;s<2;s++)t[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<e.length;s+=2)for(r=0;r<2;r++)t[r]=Math.min(t[r],e[s+r]),i[r]=Math.max(i[r],e[s+r]);return{min:t,max:i}},compressUVs:ue,decompressUVs:function(e,t,i=new Float32Array(e.length)){for(let s=0,r=e.length;s<r;s+=3)i[s+0]=e[s+0]*t[0]+t[6],i[s+1]=e[s+1]*t[4]+t[7];return i},decompressUV:function(e,t,i){i[0]=e[0]*t[0]+t[6],i[1]=e[1]*t[4]+t[7]},compressNormals:function(e){const t=new Int8Array(e.length);let i,s,r,o,n;for(let a=0;a<e.length;a+=3)r=i=de(e,a,"floor","floor"),s=pe(i),o=n=fe(e,a,s),i=de(e,a,"ceil","floor"),s=pe(i),o=fe(e,a,s),o>n&&(r=i,n=o),i=de(e,a,"floor","ceil"),s=pe(i),o=fe(e,a,s),o>n&&(r=i,n=o),i=de(e,a,"ceil","ceil"),s=pe(i),o=fe(e,a,s),o>n&&(r=i,n=o),t[a]=r[0],t[a+1]=r[1];return t},decompressNormals:function(e,t){for(let i=0,s=0,r=e.length;i<r;i+=2){let r=e[i+0],o=e[i+1];r=(2*r+1)/255,o=(2*o+1)/255;const n=1-Math.abs(r)-Math.abs(o);n<0&&(r=(1-Math.abs(o))*(r>=0?1:-1),o=(1-Math.abs(r))*(o>=0?1:-1));const a=Math.sqrt(r*r+o*o+n*n);t[s+0]=r/a,t[s+1]=o/a,t[s+2]=n/a,s+=3}return t},decompressNormal:function(e,t){let i=e[0],s=e[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const o=Math.sqrt(i*i+s*s+r*r);return t[0]=i/o,t[1]=s/o,t[2]=r/o,t}},ge=g.memory,_e=d.AABB3();class ve extends oe{get type(){return"ReadableGeometry"}get isReadableGeometry(){return!0}constructor(e,t={}){super(e,t),this._state=new ae({compressGeometry:!!t.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=t.edgeThreshold||10,this._edgeIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._aabbDirty=!0,this._boundingSphere=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;const i=this._state,s=this.scene.canvas.gl;switch(t.primitive=t.primitive||"triangles",t.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=t.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=t.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=t.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=t.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=t.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=t.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=t.primitive;break;default:this.error("Unsupported value for 'primitive': '"+t.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=t.primitive}if(t.positions)if(this._state.compressGeometry){const e=me.getPositionsBounds(t.positions),s=me.compressPositions(t.positions,e.min,e.max);i.positions=s.quantized,i.positionsDecodeMatrix=s.decodeMatrix}else i.positions=t.positions.constructor===Float32Array?t.positions:new Float32Array(t.positions);if(t.colors&&(i.colors=t.colors.constructor===Float32Array?t.colors:new Float32Array(t.colors)),t.uv)if(this._state.compressGeometry){const e=me.getUVBounds(t.uv),s=me.compressUVs(t.uv,e.min,e.max);i.uv=s.quantized,i.uvDecodeMatrix=s.decodeMatrix}else i.uv=t.uv.constructor===Float32Array?t.uv:new Float32Array(t.uv);t.normals&&(this._state.compressGeometry?i.normals=me.compressNormals(t.normals):i.normals=t.normals.constructor===Float32Array?t.normals:new Float32Array(t.normals)),t.indices&&(i.indices=t.indices.constructor===Uint32Array||t.indices.constructor===Uint16Array?t.indices:new Uint32Array(t.indices),"triangles"===this._state.primitiveName&&(this._numTriangles=t.indices.length/3)),this._buildHash(),ge.meshes++,this._buildVBOs()}_buildVBOs(){const e=this._state,t=this.scene.canvas.gl;if(e.indices&&(e.indicesBuf=new le(t,t.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,t.STATIC_DRAW),ge.indices+=e.indicesBuf.numItems),e.positions&&(e.positionsBuf=new le(t,t.ARRAY_BUFFER,e.positions,e.positions.length,3,t.STATIC_DRAW),ge.positions+=e.positionsBuf.numItems),e.normals){let i=e.compressGeometry;e.normalsBuf=new le(t,t.ARRAY_BUFFER,e.normals,e.normals.length,3,t.STATIC_DRAW,i),ge.normals+=e.normalsBuf.numItems}e.colors&&(e.colorsBuf=new le(t,t.ARRAY_BUFFER,e.colors,e.colors.length,4,t.STATIC_DRAW),ge.colors+=e.colorsBuf.numItems),e.uv&&(e.uvBuf=new le(t,t.ARRAY_BUFFER,e.uv,e.uv.length,2,t.STATIC_DRAW),ge.uvs+=e.uvBuf.numItems)}_buildHash(){const e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positions&&t.push("p"),e.colors&&t.push("c"),(e.normals||e.autoVertexNormals)&&t.push("n"),e.uv&&t.push("u"),e.compressGeometry&&t.push("cp"),t.push(";"),e.hash=t.join("")}_getEdgeIndices(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf}_getPickTrianglePositions(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}_getPickTriangleColors(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}_buildEdgeIndices(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,i=Ae(e.positions,e.indices,e.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new le(t,t.ELEMENT_ARRAY_BUFFER,i,i.length,1,t.STATIC_DRAW),ge.indices+=this._edgeIndicesBuf.numItems}_buildPickTriangleVBOs(){const e=this._state;if(!e.positions||!e.indices)return;const t=this.scene.canvas.gl,i=d.buildPickTriangles(e.positions,e.indices,e.compressGeometry),s=i.positions,r=i.colors;this._pickTrianglePositionsBuf=new le(t,t.ARRAY_BUFFER,s,s.length,3,t.STATIC_DRAW),this._pickTriangleColorsBuf=new le(t,t.ARRAY_BUFFER,r,r.length,4,t.STATIC_DRAW,!0),ge.positions+=this._pickTrianglePositionsBuf.numItems,ge.colors+=this._pickTriangleColorsBuf.numItems}_buildPickVertexVBOs(){}_webglContextLost(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()}_webglContextRestored(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null}get primitive(){return this._state.primitiveName}get compressGeometry(){return this._state.compressGeometry}get positions(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),me.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null}set positions(e){const t=this._state,i=t.positions;if(i)if(i.length===e.length){if(this._state.compressGeometry){const i=me.getPositionsBounds(e),s=me.compressPositions(e,i.min,i.max);e=s.quantized,t.positionsDecodeMatrix=s.decodeMatrix}i.set(e),t.positionsBuf&&t.positionsBuf.setData(i),this._setAABBDirty(),this.glRedraw()}else this.error("can't update geometry positions - new positions are wrong length");else this.error("can't update geometry positions - geometry has no positions")}get normals(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){const e=this._state.normals.length,t=e+e/2;this._decompressedNormals=new Float32Array(t),me.decompressNormals(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}}set normals(e){if(this._state.compressGeometry)return void this.error("can't update geometry normals - quantized geometry is immutable");const t=this._state,i=t.normals;i?i.length===e.length?(i.set(e),t.normalsBuf&&t.normalsBuf.setData(i),this.glRedraw()):this.error("can't update geometry normals - new normals are wrong length"):this.error("can't update geometry normals - geometry has no normals")}get uv(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),me.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null}set uv(e){if(this._state.compressGeometry)return void this.error("can't update geometry UVs - quantized geometry is immutable");const t=this._state,i=t.uv;i?i.length===e.length?(i.set(e),t.uvBuf&&t.uvBuf.setData(i),this.glRedraw()):this.error("can't update geometry UVs - new UVs are wrong length"):this.error("can't update geometry UVs - geometry has no UVs")}get colors(){return this._state.colors}set colors(e){if(this._state.compressGeometry)return void this.error("can't update geometry colors - quantized geometry is immutable");const t=this._state,i=t.colors;i?i.length===e.length?(i.set(e),t.colorsBuf&&t.colorsBuf.setData(i),this.glRedraw()):this.error("can't update geometry colors - new colors are wrong length"):this.error("can't update geometry colors - geometry has no colors")}get indices(){return this._state.indices}get aabb(){return this._aabbDirty&&(this._aabb||(this._aabb=d.AABB3()),d.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}get obb(){return this._obbDirty&&(this._obb||(this._obb=d.OBB3()),d.positions3ToAABB3(this._state.positions,_e,this._state.positionsDecodeMatrix),d.AABB3ToOBB3(_e,this._obb),this._obbDirty=!1),this._obb}_getMetrics(){if(!("_metrics"in this))switch(this._state.primitiveName){case"solid":case"surface":case"triangles":{const e=this._state.indices,t=this._state.positions,i=(i,s)=>{const r=3*e[i];for(let e=0;e<3;++e)s[e]=t[r+e];return s},s=[d.vec3(),d.vec3(),d.vec3(),d.vec3()];let r=0;const o=d.vec3([0,0,0]);for(let t=0;t<e.length;t+=3){const e=i(t,s[0]),n=i(t+1,s[1]),a=i(t+2,s[2]);d.addVec3(e,n,s[3]),d.addVec3(a,s[3],s[3]);const l=d.lenVec3(d.cross3Vec3(d.subVec3(n,e,s[1]),d.subVec3(a,e,s[2]),s[0]))/2;r+=l,d.mulVec3Scalar(s[3],l,s[3]),d.addVec3(o,s[3],o)}this._metrics={surfaceArea:r,centroid:d.mulVec3Scalar(o,1/r/3,o)};break}default:this._metrics={surfaceArea:0}}return this._metrics}get surfaceArea(){return this._getMetrics().surfaceArea}get centroid(){return this._getMetrics().centroid}get numTriangles(){return this._numTriangles}_setAABBDirty(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0)}_getState(){return this._state}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),e.destroy(),ge.meshes--}}const be=g.memory,ye=d.AABB3();class we extends oe{get type(){return"VBOGeometry"}get isVBOGeometry(){return!0}constructor(e,t={}){super(e,t),this._state=new ae({compressGeometry:!0,primitive:null,primitiveName:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=t.edgeThreshold||10,this._aabb=null,this._obb=d.OBB3();const i=this._state,s=this.scene.canvas.gl;switch(t.primitive=t.primitive||"triangles",t.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=t.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=t.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=t.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=t.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=t.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=t.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=t.primitive;break;default:this.error("Unsupported value for 'primitive': '"+t.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=t.primitive}if(t.positions)if(t.indices){var r;if(t.positionsDecodeMatrix);else{const e=me.getPositionsBounds(t.positions),o=me.compressPositions(t.positions,e.min,e.max);r=o.quantized,i.positionsDecodeMatrix=o.decodeMatrix,i.positionsBuf=new le(s,s.ARRAY_BUFFER,r,r.length,3,s.STATIC_DRAW),be.positions+=i.positionsBuf.numItems,d.positions3ToAABB3(t.positions,this._aabb),d.positions3ToAABB3(r,ye,i.positionsDecodeMatrix),d.AABB3ToOBB3(ye,this._obb)}if(t.colors){const e=t.colors.constructor===Float32Array?t.colors:new Float32Array(t.colors);i.colorsBuf=new le(s,s.ARRAY_BUFFER,e,e.length,4,s.STATIC_DRAW),be.colors+=i.colorsBuf.numItems}if(t.uv){const e=me.getUVBounds(t.uv),r=me.compressUVs(t.uv,e.min,e.max),o=r.quantized;i.uvDecodeMatrix=r.decodeMatrix,i.uvBuf=new le(s,s.ARRAY_BUFFER,o,o.length,2,s.STATIC_DRAW),be.uvs+=i.uvBuf.numItems}if(t.normals){const e=me.compressNormals(t.normals);let r=i.compressGeometry;i.normalsBuf=new le(s,s.ARRAY_BUFFER,e,e.length,3,s.STATIC_DRAW,r),be.normals+=i.normalsBuf.numItems}{const e=t.indices.constructor===Uint32Array||t.indices.constructor===Uint16Array?t.indices:new Uint32Array(t.indices);i.indicesBuf=new le(s,s.ELEMENT_ARRAY_BUFFER,e,e.length,1,s.STATIC_DRAW),be.indices+=i.indicesBuf.numItems;const o=Ae(r,e,i.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new le(s,s.ELEMENT_ARRAY_BUFFER,o,o.length,1,s.STATIC_DRAW),"triangles"===this._state.primitiveName&&(this._numTriangles=t.indices.length/3)}this._buildHash(),be.meshes++}else this.error("Config expected: indices");else this.error("Config expected: positions")}_buildHash(){const e=this._state,t=["/g"];t.push("/"+e.primitive+";"),e.positionsBuf&&t.push("p"),e.colorsBuf&&t.push("c"),(e.normalsBuf||e.autoVertexNormals)&&t.push("n"),e.uvBuf&&t.push("u"),t.push("cp"),t.push(";"),e.hash=t.join("")}_getEdgeIndices(){return this._edgeIndicesBuf}get primitive(){return this._state.primitiveName}get aabb(){return this._aabb}get obb(){return this._obb}get numTriangles(){return this._numTriangles}_getState(){return this._state}destroy(){super.destroy();const e=this._state;e.indicesBuf&&e.indicesBuf.destroy(),e.positionsBuf&&e.positionsBuf.destroy(),e.normalsBuf&&e.normalsBuf.destroy(),e.uvBuf&&e.uvBuf.destroy(),e.colorsBuf&&e.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),e.destroy(),be.meshes--}}var Be={};function Pe(e,t={}){return new Promise((function(i,s){t.src||(console.error("load3DSGeometry: Parameter expected: src"),s());var r=e.canvas.spinner;r.processes++,y.loadArraybuffer(t.src,(function(e){e.byteLength||(console.error("load3DSGeometry: no data loaded"),r.processes--,s());var o=Be.parse.from3DS(e).edit.objects[0].mesh,n=o.vertices,a=o.uvt,l=o.indices;r.processes--,i(y.apply(t,{primitive:"triangles",positions:n,normals:null,uv:a,indices:l}))}),(function(e){console.error("load3DSGeometry: "+e),r.processes--,s()}))}))}function xe(e,t={}){return new Promise((function(i,s){t.src||(console.error("loadOBJGeometry: Parameter expected: src"),s());var r=e.canvas.spinner;r.processes++,y.loadArraybuffer(t.src,(function(e){e.byteLength||(console.error("loadOBJGeometry: no data loaded"),r.processes--,s());for(var o=Be.parse.fromOBJ(e),n=Be.edit.unwrap(o.i_verts,o.c_verts,3),a=Be.edit.unwrap(o.i_norms,o.c_norms,3),l=Be.edit.unwrap(o.i_uvt,o.c_uvt,2),A=new Int32Array(o.i_verts.length),c=0;c<o.i_verts.length;c++)A[c]=c;r.processes--,i(y.apply(t,{primitive:"triangles",positions:n,normals:a.length>0?a:null,autoNormals:0===a.length,uv:l,indices:A}))}),(function(e){console.error("loadOBJGeometry: "+e),r.processes--,s()}))}))}function Ce(e={}){let t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);let i=e.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);let s=e.zSize||1;s<0&&(console.error("negative zSize not allowed - will invert"),s*=-1);const r=e.center,o=r?r[0]:0,n=r?r[1]:0,a=r?r[2]:0,l=-t+o,A=-i+n,c=-s+a,h=t+o,u=i+n,d=s+a;return y.apply(e,{positions:[h,u,d,l,u,d,l,A,d,h,A,d,h,u,d,h,A,d,h,A,c,h,u,c,h,u,d,h,u,c,l,u,c,l,u,d,l,u,d,l,u,c,l,A,c,l,A,d,l,A,c,h,A,c,h,A,d,l,A,d,h,A,c,l,A,c,l,u,c,h,u,c],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}function Me(e={}){let t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);let i=e.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);let s=e.zSize||1;s<0&&(console.error("negative zSize not allowed - will invert"),s*=-1);const r=e.center,o=r?r[0]:0,n=r?r[1]:0,a=r?r[2]:0,l=-t+o,A=-i+n,c=-s+a,h=t+o,u=i+n,d=s+a;return y.apply(e,{primitive:"lines",positions:[l,A,c,l,A,d,l,u,c,l,u,d,h,A,c,h,A,d,h,u,c,h,u,d],indices:[0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,2,6,3,7]})}function Ee(e={}){return Me({id:e.id,center:[(e.aabb[0]+e.aabb[3])/2,(e.aabb[1]+e.aabb[4])/2,(e.aabb[2]+e.aabb[5])/2],xSize:Math.abs(e.aabb[3]-e.aabb[0])/2,ySize:Math.abs(e.aabb[4]-e.aabb[1])/2,zSize:Math.abs(e.aabb[5]-e.aabb[2])/2})}function Fe(e={}){let t=e.radiusTop||1;t<0&&(console.error("negative radiusTop not allowed - will invert"),t*=-1);let i=e.radiusBottom||1;i<0&&(console.error("negative radiusBottom not allowed - will invert"),i*=-1);let s=e.height||1;s<0&&(console.error("negative height not allowed - will invert"),s*=-1);let r=e.radialSegments||32;r<0&&(console.error("negative radialSegments not allowed - will invert"),r*=-1),r<3&&(r=3);let o=e.heightSegments||1;o<0&&(console.error("negative heightSegments not allowed - will invert"),o*=-1),o<1&&(o=1);const n=!!e.openEnded;let a=e.center;const l=a?a[0]:0,A=a?a[1]:0,c=a?a[2]:0,h=s/2,u=s/o,d=2*Math.PI/r,p=1/r,f=(t-i)/o,m=[],g=[],_=[],v=[];let b,w,B,P,x,C,M,E,F,I,T;const D=(90-180*Math.atan(s/(i-t))/Math.PI)/90;for(b=0;b<=o;b++)for(x=t-b*f,C=h-b*u,w=0;w<=r;w++)B=Math.sin(w*d),P=Math.cos(w*d),g.push(x*B),g.push(D),g.push(x*P),_.push(w*p),_.push(1*b/o),m.push(x*B+l),m.push(C+A),m.push(x*P+c);for(b=0;b<o;b++)for(w=0;w<=r;w++)M=b*(r+1)+w,E=M+r,v.push(M),v.push(E),v.push(E+1),v.push(M),v.push(E+1),v.push(M+1);if(!n&&t>0){for(F=m.length/3,g.push(0),g.push(1),g.push(0),_.push(.5),_.push(.5),m.push(0+l),m.push(h+A),m.push(0+c),w=0;w<=r;w++)B=Math.sin(w*d),P=Math.cos(w*d),I=.5*Math.sin(w*d)+.5,T=.5*Math.cos(w*d)+.5,g.push(t*B),g.push(1),g.push(t*P),_.push(I),_.push(T),m.push(t*B+l),m.push(h+A),m.push(t*P+c);for(w=0;w<r;w++)a=F,M=F+1+w,v.push(M),v.push(M+1),v.push(a)}if(!n&&i>0){for(F=m.length/3,g.push(0),g.push(-1),g.push(0),_.push(.5),_.push(.5),m.push(0+l),m.push(0-h+A),m.push(0+c),w=0;w<=r;w++)B=Math.sin(w*d),P=Math.cos(w*d),I=.5*Math.sin(w*d)+.5,T=.5*Math.cos(w*d)+.5,g.push(i*B),g.push(-1),g.push(i*P),_.push(I),_.push(T),m.push(i*B+l),m.push(0-h+A),m.push(i*P+c);for(w=0;w<r;w++)a=F,M=F+1+w,v.push(a),v.push(M+1),v.push(M)}return y.apply(e,{positions:m,normals:g,uv:_,indices:v})}function Ie(e={}){let t=e.size||1;t<0&&(console.error("negative size not allowed - will invert"),t*=-1);let i=e.divisions||1;i<0&&(console.error("negative divisions not allowed - will invert"),i*=-1),i<1&&(i=1),t=t||10,i=i||10;const s=t/i,r=t/2,o=[],n=[];let a=0;for(let e=0,t=-r;e<=i;e++,t+=s)o.push(-r),o.push(0),o.push(t),o.push(r),o.push(0),o.push(t),o.push(t),o.push(0),o.push(-r),o.push(t),o.push(0),o.push(r),n.push(a++),n.push(a++),n.push(a++),n.push(a++);return y.apply(e,{primitive:"lines",positions:o,indices:n})}function Te(e={}){let t=e.xSize||1;t<0&&(console.error("negative xSize not allowed - will invert"),t*=-1);let i=e.zSize||1;i<0&&(console.error("negative zSize not allowed - will invert"),i*=-1);let s=e.xSegments||1;s<0&&(console.error("negative xSegments not allowed - will invert"),s*=-1),s<1&&(s=1);let r=e.xSegments||1;r<0&&(console.error("negative zSegments not allowed - will invert"),r*=-1),r<1&&(r=1);const o=e.center,n=o?o[0]:0,a=o?o[1]:0,l=o?o[2]:0,A=t/2,c=i/2,h=Math.floor(s)||1,u=Math.floor(r)||1,d=h+1,p=u+1,f=t/h,m=i/u,g=new Float32Array(d*p*3),_=new Float32Array(d*p*3),v=new Float32Array(d*p*2);let b,w,B,P,x,C,M,E=0,F=0;for(b=0;b<p;b++){const e=b*m-c;for(w=0;w<d;w++)B=w*f-A,g[E]=B+n,g[E+1]=a,g[E+2]=-e+l,_[E+1]=1,v[F]=w/h,v[F+1]=(u-b)/u,E+=3,F+=2}E=0;const I=new(g.length/3>65535?Uint32Array:Uint16Array)(h*u*6);for(b=0;b<u;b++)for(w=0;w<h;w++)P=w+d*b,x=w+d*(b+1),C=w+1+d*(b+1),M=w+1+d*b,I[E]=M,I[E+1]=x,I[E+2]=P,I[E+3]=M,I[E+4]=C,I[E+5]=x,E+=6;return y.apply(e,{positions:g,normals:_,uv:v,indices:I})}function De(e={}){const t=e.lod||1,i=e.center?e.center[0]:0,s=e.center?e.center[1]:0,r=e.center?e.center[2]:0;let o=e.radius||1;o<0&&(console.error("negative radius not allowed - will invert"),o*=-1);let n=e.heightSegments||18;n<0&&(console.error("negative heightSegments not allowed - will invert"),n*=-1),n=Math.floor(t*n),n<18&&(n=18);let a=e.widthSegments||18;a<0&&(console.error("negative widthSegments not allowed - will invert"),a*=-1),a=Math.floor(t*a),a<18&&(a=18);const l=[],A=[],c=[],h=[];let u,d,p,f,m,g,_,v,b,w,B,P,x,C,M;for(u=0;u<=n;u++)for(p=u*Math.PI/n,f=Math.sin(p),m=Math.cos(p),d=0;d<=a;d++)g=2*d*Math.PI/a,_=Math.sin(g),v=Math.cos(g),b=v*f,w=m,B=_*f,P=1-d/a,x=u/n,A.push(b),A.push(w),A.push(B),c.push(P),c.push(x),l.push(i+o*b),l.push(s+o*w),l.push(r+o*B);for(u=0;u<n;u++)for(d=0;d<a;d++)C=u*(a+1)+d,M=C+a+1,h.push(C+1),h.push(M+1),h.push(M),h.push(C+1),h.push(M),h.push(C);return y.apply(e,{positions:l,normals:A,uv:c,indices:h})}function Se(e={}){let t=e.radius||1;t<0&&(console.error("negative radius not allowed - will invert"),t*=-1),t*=.5;let i=e.tube||.3;i<0&&(console.error("negative tube not allowed - will invert"),i*=-1);let s=e.radialSegments||32;s<0&&(console.error("negative radialSegments not allowed - will invert"),s*=-1),s<4&&(s=4);let r=e.tubeSegments||24;r<0&&(console.error("negative tubeSegments not allowed - will invert"),r*=-1),r<4&&(r=4);let o=e.arc||2*Math.PI;o<0&&(console.warn("negative arc not allowed - will invert"),o*=-1),o>360&&(o=360);const n=e.center;let a=n?n[0]:0,l=n?n[1]:0;const A=n?n[2]:0,c=[],h=[],u=[],p=[];let f,m,g,_,v,b,w,B,P,x,C,M;for(B=0;B<=r;B++)for(w=0;w<=s;w++)f=w/s*o,m=.785398+B/r*Math.PI*2,a=t*Math.cos(f),l=t*Math.sin(f),g=(t+i*Math.cos(m))*Math.cos(f),_=(t+i*Math.cos(m))*Math.sin(f),v=i*Math.sin(m),c.push(g+a),c.push(_+l),c.push(v+A),u.push(1-w/s),u.push(B/r),b=d.normalizeVec3(d.subVec3([g,_,v],[a,l,A],[]),[]),h.push(b[0]),h.push(b[1]),h.push(b[2]);for(B=1;B<=r;B++)for(w=1;w<=s;w++)P=(s+1)*B+w-1,x=(s+1)*(B-1)+w-1,C=(s+1)*(B-1)+w,M=(s+1)*B+w,p.push(P),p.push(x),p.push(C),p.push(C),p.push(M),p.push(P);return y.apply(e,{positions:c,normals:h,uv:u,indices:p})}Be.load=function(e,t){var i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=function(e){t(e.target.response)},i.send()},Be.save=function(e,t){var i="data:application/octet-stream;base64,"+btoa(Be.parse._buffToStr(e));window.location.href=i},Be.clone=function(e){return JSON.parse(JSON.stringify(e))},Be.bin={},Be.bin.f=new Float32Array(1),Be.bin.fb=new Uint8Array(Be.bin.f.buffer),Be.bin.rf=function(e,t){for(var i=Be.bin.f,s=Be.bin.fb,r=0;r<4;r++)s[r]=e[t+r];return i[0]},Be.bin.rsl=function(e,t){return e[t]|e[t+1]<<8},Be.bin.ril=function(e,t){return e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24},Be.bin.rASCII0=function(e,t){for(var i="";0!=e[t];)i+=String.fromCharCode(e[t++]);return i},Be.bin.wf=function(e,t,i){new Float32Array(e.buffer,t,1)[0]=i},Be.bin.wsl=function(e,t,i){e[t]=i,e[t+1]=i>>8},Be.bin.wil=function(e,t,i){e[t]=i,e[t+1]=i>>8,e[t+2]=i>>16,e[t+3]},Be.parse={},Be.parse._buffToStr=function(e){for(var t=new Uint8Array(e),i="",s=0;s<t.length;s++)i=i.concat(String.fromCharCode(t[s]));return i},Be.parse._strToBuff=function(e){for(var t=new ArrayBuffer(e.length),i=new Uint8Array(t),s=0;s<e.length;s++)i[s]=e.charCodeAt(s);return t},Be.parse._readLine=function(e,t){for(var i="";10!=e[t];)i+=String.fromCharCode(e[t++]);return i},Be.parse.fromJSON=function(e){return JSON.parse(Be.parse._buffToStr(e))},Be.parse.toJSON=function(e){var t=JSON.stringify(e);return Be.parse._strToBuff(t)},Be.parse.fromOBJ=function(e){for(var t={groups:{},c_verts:[],c_uvt:[],c_norms:[],i_verts:[],i_uvt:[],i_norms:[]},i={from:0,to:0},s=0,r=new Uint8Array(e);s<r.length;){var o=Be.parse._readLine(r,s);s+=o.length+1;var n=(o=(o=o.replace(/ +(?= )/g,"")).replace(/(^\s+|\s+$)/g,"")).split(" ");if("g"==n[0]&&(i.to=t.i_verts.length,null==t.groups[n[1]]&&(t.groups[n[1]]={from:t.i_verts.length,to:0}),i=t.groups[n[1]]),"v"==n[0]){var a=parseFloat(n[1]),l=parseFloat(n[2]),A=parseFloat(n[3]);t.c_verts.push(a,l,A)}if("vt"==n[0]){a=parseFloat(n[1]),l=1-parseFloat(n[2]);t.c_uvt.push(a,l)}if("vn"==n[0]){a=parseFloat(n[1]),l=parseFloat(n[2]),A=parseFloat(n[3]);t.c_norms.push(a,l,A)}if("f"==n[0]){var c=n[1].split("/"),h=n[2].split("/"),u=n[3].split("/"),d=parseInt(c[0])-1,p=parseInt(h[0])-1,f=parseInt(u[0])-1,m=parseInt(c[1])-1,g=parseInt(h[1])-1,_=parseInt(u[1])-1,v=parseInt(c[2])-1,b=parseInt(h[2])-1,y=parseInt(u[2])-1,w=t.c_verts.length/3,B=t.c_uvt.length/2,P=t.c_norms.length/3;if(d<0&&(d=w+d+1),p<0&&(p=w+p+1),f<0&&(f=w+f+1),m<0&&(m=B+m+1),g<0&&(g=B+g+1),_<0&&(_=B+_+1),v<0&&(v=P+v+1),b<0&&(b=P+b+1),y<0&&(y=P+y+1),t.i_verts.push(d,p,f),t.i_uvt.push(m,g,_),t.i_norms.push(v,b,y),5==n.length){var x=n[4].split("/"),C=parseInt(x[0])-1,M=parseInt(x[1])-1,E=parseInt(x[2])-1;C<0&&(C=w+C+1),M<0&&(M=B+M+1),E<0&&(E=P+E+1),t.i_verts.push(d,f,C),t.i_uvt.push(m,_,M),t.i_norms.push(v,y,E)}}}return i.to=t.i_verts.length,t},Be.parse.fromMD2=function(e){e=new Uint8Array(e);var t={},i={};i.ident=Be.bin.ril(e,0),i.version=Be.bin.ril(e,4),i.skinwidth=Be.bin.ril(e,8),i.skinheight=Be.bin.ril(e,12),i.framesize=Be.bin.ril(e,16),i.num_skins=Be.bin.ril(e,20),i.num_vertices=Be.bin.ril(e,24),i.num_st=Be.bin.ril(e,28),i.num_tris=Be.bin.ril(e,32),i.num_glcmds=Be.bin.ril(e,36),i.num_frames=Be.bin.ril(e,40),i.offset_skins=Be.bin.ril(e,44),i.offset_st=Be.bin.ril(e,48),i.offset_tris=Be.bin.ril(e,52),i.offset_frames=Be.bin.ril(e,56),i.offset_glcmds=Be.bin.ril(e,60),i.offset_end=Be.bin.ril(e,64);var s=i.offset_st;t.c_uvt=[];for(var r=0;r<i.num_st;r++){var o=Be.bin.rsl(e,s)/i.skinwidth,n=Be.bin.rsl(e,s+2)/i.skinheight;t.c_uvt.push(o,n),s+=4}s=i.offset_tris;var a=[],l=[];t.i_verts=a,t.i_uvt=l;for(r=0;r<i.num_tris;r++)a.push(Be.bin.rsl(e,s),Be.bin.rsl(e,s+2),Be.bin.rsl(e,s+4)),l.push(Be.bin.rsl(e,s+6),Be.bin.rsl(e,s+8),Be.bin.rsl(e,s+10)),s+=12;s=i.offset_skins;t.skins=[];for(r=0;r<i.num_skins;r++)t.skins.push(Be.bin.rASCII0(e,s)),s+=64;s=i.offset_frames;t.frames=[];var A=Be.parse.fromMD2._normals;for(r=0;r<i.num_frames;r++){var c={},h=Be.bin.rf(e,s),u=Be.bin.rf(e,s+4),d=Be.bin.rf(e,s+8);s+=12;var p=Be.bin.rf(e,s),f=Be.bin.rf(e,s+4),m=Be.bin.rf(e,s+8);s+=12,c.name=Be.bin.rASCII0(e,s),s+=16,c.verts=[],c.norms=[];for(var g=0;g<i.num_vertices;g++)c.verts.push(e[s]*h+p,e[s+1]*u+f,e[s+2]*d+m),c.norms.push(A[3*e[s+3]],A[3*e[s+3]+1],A[3*e[s+3]+2]),s+=4;t.frames.push(c)}return t},Be.parse.fromMD2._normals=[-.525731,0,.850651,-.442863,.238856,.864188,-.295242,0,.955423,-.309017,.5,.809017,-.16246,.262866,.951056,0,0,1,0,.850651,.525731,-.147621,.716567,.681718,.147621,.716567,.681718,0,.525731,.850651,.309017,.5,.809017,.525731,0,.850651,.295242,0,.955423,.442863,.238856,.864188,.16246,.262866,.951056,-.681718,.147621,.716567,-.809017,.309017,.5,-.587785,.425325,.688191,-.850651,.525731,0,-.864188,.442863,.238856,-.716567,.681718,.147621,-.688191,.587785,.425325,-.5,.809017,.309017,-.238856,.864188,.442863,-.425325,.688191,.587785,-.716567,.681718,-.147621,-.5,.809017,-.309017,-.525731,.850651,0,0,.850651,-.525731,-.238856,.864188,-.442863,0,.955423,-.295242,-.262866,.951056,-.16246,0,1,0,0,.955423,.295242,-.262866,.951056,.16246,.238856,.864188,.442863,.262866,.951056,.16246,.5,.809017,.309017,.238856,.864188,-.442863,.262866,.951056,-.16246,.5,.809017,-.309017,.850651,.525731,0,.716567,.681718,.147621,.716567,.681718,-.147621,.525731,.850651,0,.425325,.688191,.587785,.864188,.442863,.238856,.688191,.587785,.425325,.809017,.309017,.5,.681718,.147621,.716567,.587785,.425325,.688191,.955423,.295242,0,1,0,0,.951056,.16246,.262866,.850651,-.525731,0,.955423,-.295242,0,.864188,-.442863,.238856,.951056,-.16246,.262866,.809017,-.309017,.5,.681718,-.147621,.716567,.850651,0,.525731,.864188,.442863,-.238856,.809017,.309017,-.5,.951056,.16246,-.262866,.525731,0,-.850651,.681718,.147621,-.716567,.681718,-.147621,-.716567,.850651,0,-.525731,.809017,-.309017,-.5,.864188,-.442863,-.238856,.951056,-.16246,-.262866,.147621,.716567,-.681718,.309017,.5,-.809017,.425325,.688191,-.587785,.442863,.238856,-.864188,.587785,.425325,-.688191,.688191,.587785,-.425325,-.147621,.716567,-.681718,-.309017,.5,-.809017,0,.525731,-.850651,-.525731,0,-.850651,-.442863,.238856,-.864188,-.295242,0,-.955423,-.16246,.262866,-.951056,0,0,-1,.295242,0,-.955423,.16246,.262866,-.951056,-.442863,-.238856,-.864188,-.309017,-.5,-.809017,-.16246,-.262866,-.951056,0,-.850651,-.525731,-.147621,-.716567,-.681718,.147621,-.716567,-.681718,0,-.525731,-.850651,.309017,-.5,-.809017,.442863,-.238856,-.864188,.16246,-.262866,-.951056,.238856,-.864188,-.442863,.5,-.809017,-.309017,.425325,-.688191,-.587785,.716567,-.681718,-.147621,.688191,-.587785,-.425325,.587785,-.425325,-.688191,0,-.955423,-.295242,0,-1,0,.262866,-.951056,-.16246,0,-.850651,.525731,0,-.955423,.295242,.238856,-.864188,.442863,.262866,-.951056,.16246,.5,-.809017,.309017,.716567,-.681718,.147621,.525731,-.850651,0,-.238856,-.864188,-.442863,-.5,-.809017,-.309017,-.262866,-.951056,-.16246,-.850651,-.525731,0,-.716567,-.681718,-.147621,-.716567,-.681718,.147621,-.525731,-.850651,0,-.5,-.809017,.309017,-.238856,-.864188,.442863,-.262866,-.951056,.16246,-.864188,-.442863,.238856,-.809017,-.309017,.5,-.688191,-.587785,.425325,-.681718,-.147621,.716567,-.442863,-.238856,.864188,-.587785,-.425325,.688191,-.309017,-.5,.809017,-.147621,-.716567,.681718,-.425325,-.688191,.587785,-.16246,-.262866,.951056,.442863,-.238856,.864188,.16246,-.262866,.951056,.309017,-.5,.809017,.147621,-.716567,.681718,0,-.525731,.850651,.425325,-.688191,.587785,.587785,-.425325,.688191,.688191,-.587785,.425325,-.955423,.295242,0,-.951056,.16246,.262866,-1,0,0,-.850651,0,.525731,-.955423,-.295242,0,-.951056,-.16246,.262866,-.864188,.442863,-.238856,-.951056,.16246,-.262866,-.809017,.309017,-.5,-.864188,-.442863,-.238856,-.951056,-.16246,-.262866,-.809017,-.309017,-.5,-.681718,.147621,-.716567,-.681718,-.147621,-.716567,-.850651,0,-.525731,-.688191,.587785,-.425325,-.587785,.425325,-.688191,-.425325,.688191,-.587785,-.425325,-.688191,-.587785,-.587785,-.425325,-.688191,-.688191,-.587785,-.425325],Be.parse.fromCollada=function(e){var t=Be.parse._buffToStr(e),i=(new DOMParser).parseFromString(t,"text/xml"),s={},r=(i=i.childNodes[0]).getElementsByTagName("asset")[0],o=i.getElementsByTagName("library_geometries")[0],n=i.getElementsByTagName("library_images")[0],a=i.getElementsByTagName("library_materials")[0],l=i.getElementsByTagName("library_effects")[0];return r&&(s.asset=Be.parse.fromCollada._asset(r)),o&&(s.geometries=Be.parse.fromCollada._libGeometries(o)),n&&(s.images=Be.parse.fromCollada._libImages(n)),a&&(s.materials=Be.parse.fromCollada._libMaterials(a)),l&&(s.effects=Be.parse.fromCollada._libEffects(l)),s},Be.parse.fromCollada._asset=function(e){return{created:e.getElementsByTagName("created")[0].textContent,modified:e.getElementsByTagName("modified")[0].textContent,up_axis:e.getElementsByTagName("up_axis")[0].textContent}},Be.parse.fromCollada._libGeometries=function(e){e=e.getElementsByTagName("geometry");for(var t=[],i=0;i<e.length;i++){var s=e[i],r=Be.parse.fromCollada._getMesh(s.getElementsByTagName("mesh")[0]);t.push(r)}return t},Be.parse.fromCollada._getMesh=function(e){for(var t={},i=e.getElementsByTagName("source"),s=t.sources={},r=0;r<i.length;r++){for(var o=i[r].getElementsByTagName("float_array")[0].textContent.split(" "),n=o.length-(""==o[o.length-1]?1:0),a=new Array(n),l=0;l<n;l++)a[l]=parseFloat(o[l]);s[i[r].getAttribute("id")]=a}t.triangles=[];var A=e.getElementsByTagName("triangles");if(null==A)return t;for(r=0;r<A.length;r++){var c={},h=A[r];c.material=h.getAttribute("material");var u=h.getElementsByTagName("input"),d=[];for(l=0;l<u.length;l++){var p=u[l];a=[];d[parseInt(p.getAttribute("offset"))]=a;var f=p.getAttribute("semantic");c["s_"+f]="VERTEX"==f?e.getElementsByTagName("vertices")[0].getElementsByTagName("input")[0].getAttribute("source").substring(1):p.getAttribute("source").substring(1),c["i_"+f]=a,s[c["s_"+f]]}var m=h.getElementsByTagName("p")[0].textContent.split(" "),g=3*Math.floor(m.length/3);for(l=0;l<g;l++)d[l%u.length].push(parseInt(m[l]));t.triangles.push(c)}return t},Be.parse.fromCollada._libImages=function(e){e=e.getElementsByTagName("image");for(var t={},i=0;i<e.length;i++)t[e[i].getAttribute("id")]=e[i].getElementsByTagName("init_from")[0].textContent;return t},Be.parse.fromCollada._libMaterials=function(e){e=e.getElementsByTagName("material");for(var t={},i=0;i<e.length;i++)t[e[i].getAttribute("name")]=e[i].getElementsByTagName("instance_effect")[0].getAttribute("url").substring(1);return t},Be.parse.fromCollada._libEffects=function(e){e=e.getElementsByTagName("effect");for(var t={},i=0;i<e.length;i++){for(var s={},r=e[i].getElementsByTagName("newparam"),o=0;o<r.length;o++){var n=r[o].getElementsByTagName("surface")[0];n&&(s.surface=n.getElementsByTagName("init_from")[0].textContent)}t[e[i].getAttribute("id")]=s}return t},Be.parse.from3DS=function(e){e=new Uint8Array(e);var t={};if(19789!=Be.bin.rsl(e,0))return null;for(var i=Be.bin.ril(e,2),s=6;s<i;){var r=Be.bin.rsl(e,s),o=Be.bin.ril(e,s+2);15677==r&&(t.edit=Be.parse.from3DS._edit3ds(e,s,o)),45056==r&&(t.keyf=Be.parse.from3DS._keyf3ds(e,s,o)),s+=o}return t},Be.parse.from3DS._edit3ds=function(e,t,i){for(var s={},r=t+6;r<t+i;){var o=Be.bin.rsl(e,r),n=Be.bin.ril(e,r+2);16384==o&&(null==s.objects&&(s.objects=[]),s.objects.push(Be.parse.from3DS._edit_object(e,r,n))),r+=n}return s},Be.parse.from3DS._keyf3ds=function(e,t,i){for(var s={},r=t+6;r<t+i;){var o=Be.bin.rsl(e,r),n=Be.bin.ril(e,r+2);45058==o&&(null==s.desc&&(s.desc=[]),s.desc.push(Be.parse.from3DS._keyf_objdes(e,r,n))),r+=n}return s},Be.parse.from3DS._keyf_objdes=function(e,t,i){for(var s={},r=t+6;r<t+i;){var o=Be.bin.rsl(e,r),n=Be.bin.ril(e,r+2);45072==o&&(s.hierarchy=Be.parse.from3DS._keyf_objhierarch(e,r,n)),45073==o&&(s.dummy_name=Be.bin.rASCII0(e,r+6)),r+=n}return s},Be.parse.from3DS._keyf_objhierarch=function(e,t,i){var s={},r=t+6;return s.name=Be.bin.rASCII0(e,r),r+=s.name.length+1,s.hierarchy=Be.bin.rsl(e,r+4),s},Be.parse.from3DS._edit_object=function(e,t,i){var s={},r=t+6;for(s.name=Be.bin.rASCII0(e,r),r+=s.name.length+1;r<t+i;){var o=Be.bin.rsl(e,r),n=Be.bin.ril(e,r+2);16640==o&&(s.mesh=Be.parse.from3DS._obj_trimesh(e,r,n)),r+=n}return s},Be.parse.from3DS._obj_trimesh=function(e,t,i){for(var s={},r=t+6;r<t+i;){var o=Be.bin.rsl(e,r),n=Be.bin.ril(e,r+2);16656==o&&(s.vertices=Be.parse.from3DS._tri_vertexl(e,r,n)),16672==o&&(s.indices=Be.parse.from3DS._tri_facel1(e,r,n)),16704==o&&(s.uvt=Be.parse.from3DS._tri_mappingcoors(e,r,n)),16736==o&&(s.local=Be.parse.from3DS._tri_local(e,r,n)),r+=n}return s},Be.parse.from3DS._tri_vertexl=function(e,t,i){var s=[],r=t+6,o=Be.bin.rsl(e,r);r+=2;for(var n=0;n<o;n++)s.push(Be.bin.rf(e,r)),s.push(Be.bin.rf(e,r+4)),s.push(Be.bin.rf(e,r+8)),r+=12;return s},Be.parse.from3DS._tri_facel1=function(e,t,i){var s=[],r=t+6,o=Be.bin.rsl(e,r);r+=2;for(var n=0;n<o;n++)s.push(Be.bin.rsl(e,r)),s.push(Be.bin.rsl(e,r+2)),s.push(Be.bin.rsl(e,r+4)),r+=8;return s},Be.parse.from3DS._tri_mappingcoors=function(e,t,i){var s=[],r=t+6,o=Be.bin.rsl(e,r);r+=2;for(var n=0;n<o;n++)s.push(Be.bin.rf(e,r)),s.push(1-Be.bin.rf(e,r+4)),r+=8;return s},Be.parse.from3DS._tri_local=function(e,t,i){var s={},r=t+6;return s.X=[Be.bin.rf(e,r),Be.bin.rf(e,r+4),Be.bin.rf(e,r+8)],r+=12,s.Y=[Be.bin.rf(e,r),Be.bin.rf(e,r+4),Be.bin.rf(e,r+8)],r+=12,s.Z=[Be.bin.rf(e,r),Be.bin.rf(e,r+4),Be.bin.rf(e,r+8)],r+=12,s.C=[Be.bin.rf(e,r),Be.bin.rf(e,r+4),Be.bin.rf(e,r+8)],r+=12,s},Be.parse.fromBIV=function(e){e=new Uint8Array(e);var t={},i={};return i.id=Be.bin.ril(e,0),i.verS=Be.bin.ril(e,4),i.texS=Be.bin.ril(e,8),i.indS=Be.bin.ril(e,12),i.verO=Be.bin.ril(e,16),i.verL=Be.bin.ril(e,20),i.texO=Be.bin.ril(e,24),i.texL=Be.bin.ril(e,28),i.indO=Be.bin.ril(e,32),i.indL=Be.bin.ril(e,36),0!=i.verO&&(t.vertices=Be.parse.fromBIV._readFloats(e,i.verO,i.verL)),0!=i.texO&&(t.uvt=Be.parse.fromBIV._readFloats(e,i.texO,i.texL)),0!=i.indO&&(t.indices=Be.parse.fromBIV._readInts(e,i.indO,i.indL,i.indS)),t},Be.parse.toBIV=function(e){for(var t=0,i=0;i<e.indices.length;i++)t=Math.max(t,e.indices[i]);var s=32;t<=65535&&(s=16);var r=40;e.vertices&&(r+=4*e.vertices.length),e.uvt&&(r+=4*e.uvt.length),e.indices&&(r+=e.indices.length*s/8);var o=new Uint8Array(r);Be.bin.wil(o,0,1769365870),Be.bin.wil(o,4,32),Be.bin.wil(o,8,32),Be.bin.wil(o,12,s);var n=40;return e.vertices&&(Be.bin.wil(o,16,n),Be.bin.wil(o,20,4*e.vertices.length),Be.parse.fromBIV._writeFloats(o,n,e.vertices),n+=4*e.vertices.length),e.uvt&&(Be.bin.wil(o,24,n),Be.bin.wil(o,28,4*e.uvt.length),Be.parse.fromBIV._writeFloats(o,n,e.uvt),n+=4*e.uvt.length),e.indices&&(Be.bin.wil(o,32,n),Be.bin.wil(o,36,4*e.indices.length),Be.parse.fromBIV._writeInts(o,n,e.indices,s)),o.buffer},Be.parse.fromBIV._readFloats=function(e,t,i){for(var s=[],r=0;r<i/4;r++)s.push(Be.bin.rf(e,t+4*r));return s},Be.parse.fromBIV._writeFloats=function(e,t,i){for(var s=0;s<i.length;s++)Be.bin.wf(e,t+4*s,i[s])},Be.parse.fromBIV._readInts=function(e,t,i,s){for(var r=[],o=0;o<i/4;o++)16==s&&r.push(Be.bin.rsl(e,t+2*o)),32==s&&r.push(Be.bin.ril(e,t+4*o));return r},Be.parse.fromBIV._writeInts=function(e,t,i,s){for(var r=0;r<i.length;r++)16==s&&Be.bin.wsl(e,t+2*r,i[r]),32==s&&Be.bin.wil(e,t+4*r,i[r])},Be.gen={},Be.gen.Plane=function(e,t,i,s){i||(i=1),s||(s=1);for(var r={verts:[],inds:[],uvt:[]},o=e+1,n=t+1,a=0;a<n;a++)for(var l=0;l<o;l++){var A=l*(2/e)-1,c=a*(2/t)-1;r.verts.push(A,c,0),r.uvt.push(i*l/e,s*a/t),a<t&&l<e&&r.inds.push(a*o+l,a*o+l+1,(a+1)*o+l,a*o+l+1,(a+1)*o+l,(a+1)*o+l+1)}return r},Be.gen.Cube=function(){return{verts:[-1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],inds:[0,1,2,1,2,3,4,5,6,5,6,7,8,9,10,9,10,11,12,13,14,13,14,15,16,17,18,17,18,19,20,21,22,21,22,23],uvt:[1/4,1/4,.5,1/4,1/4,.5,.5,.5,1,1/4,3/4,1/4,1,.5,3/4,.5,0,1/4,1/4,1/4,0,.5,1/4,.5,3/4,1/4,.5,1/4,3/4,.5,.5,.5,1/4,1/4,.5,1/4,1/4,0,.5,0,1/4,.5,.5,.5,1/4,3/4,.5,3/4]}},Be.gen.Sphere=function(e,t){for(var i={verts:[],inds:[],uvt:[]},s=e+1,r=t+1,o=0;o<r;o++)for(var n=0;n<s;n++){var a=-Math.PI/2+o*Math.PI/t,l=2*n*Math.PI/e,A=Math.cos(a)*Math.cos(l),c=Math.sin(a),h=Math.cos(a)*Math.sin(l);i.verts.push(A,c,h),i.uvt.push(n/e,o/t),o<t&&n<e&&i.inds.push(s*o+n,s*o+n+1,s*(o+1)+n,s*o+n+1,s*(o+1)+n,s*(o+1)+n+1)}return i},Be.mat={},Be.mat.scale=function(e,t,i){return[e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1]},Be.mat.translate=function(e,t,i){return[1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1]},Be.mat.rotateDeg=function(e,t,i){var s=Math.PI/180;return Be.mat.rotate(e*s,t*s,i*s)},Be.mat.rotate=function(e,t,i){var s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],r=e,o=t,n=i,a=Math.cos(r),l=Math.cos(o),A=Math.cos(n),c=Math.sin(r),h=Math.sin(o),u=Math.sin(n);return s[0]=l*A,s[1]=-l*u,s[2]=h,s[4]=a*u+c*h*A,s[5]=a*A-c*h*u,s[6]=-c*l,s[8]=c*u-a*h*A,s[9]=c*A+a*h*u,s[10]=a*l,s},Be.edit={},Be.edit.interpolate=function(e,t,i,s){for(var r=0;r<e.length;r++)i[r]=e[r]+s*(t[r]-e[r])},Be.edit.transform=function(e,t){for(var i=0;i<e.length;i+=3){var s=e[i],r=e[i+1],o=e[i+2];e[i+0]=t[0]*s+t[4]*r+t[8]*o+t[12],e[i+1]=t[1]*s+t[5]*r+t[9]*o+t[13],e[i+2]=t[2]*s+t[6]*r+t[10]*o+t[14]}},Be.edit.unwrap=function(e,t,i){for(var s=new Array(Math.floor(e.length/3)*i),r=0;r<e.length;r++)for(var o=0;o<i;o++)s[r*i+o]=t[e[r]*i+o];return s},Be.edit.remap=function(e,t,i,s){for(var r=new Array(i.length),o=0;o<e.length;o++)for(var n=0;n<s;n++)r[t[o]*s+n]=i[e[o]*s+n];return r},Be.utils={},Be.utils.getAABB=function(e){var t,i,s,r,o,n;r=o=n=-(t=i=s=999999999);for(var a=0;a<e.length;a+=3){var l=e[a+0],A=e[a+1],c=e[a+2];l<t&&(t=l),l>r&&(r=l),A<i&&(i=A),A>o&&(o=A),c<s&&(s=c),A>n&&(n=c)}return{min:{x:t,y:i,z:s},max:{x:r,y:o,z:n}}};const Re={" ":{width:16,points:[]},"!":{width:10,points:[[5,21],[5,7],[-1,-1],[5,2],[4,1],[5,0],[6,1],[5,2]]},'"':{width:16,points:[[4,21],[4,14],[-1,-1],[12,21],[12,14]]},"#":{width:21,points:[[11,25],[4,-7],[-1,-1],[17,25],[10,-7],[-1,-1],[4,12],[18,12],[-1,-1],[3,6],[17,6]]},$:{width:20,points:[[8,25],[8,-4],[-1,-1],[12,25],[12,-4],[-1,-1],[17,18],[15,20],[12,21],[8,21],[5,20],[3,18],[3,16],[4,14],[5,13],[7,12],[13,10],[15,9],[16,8],[17,6],[17,3],[15,1],[12,0],[8,0],[5,1],[3,3]]},"%":{width:24,points:[[21,21],[3,0],[-1,-1],[8,21],[10,19],[10,17],[9,15],[7,14],[5,14],[3,16],[3,18],[4,20],[6,21],[8,21],[10,20],[13,19],[16,19],[19,20],[21,21],[-1,-1],[17,7],[15,6],[14,4],[14,2],[16,0],[18,0],[20,1],[21,3],[21,5],[19,7],[17,7]]},"&":{width:26,points:[[23,12],[23,13],[22,14],[21,14],[20,13],[19,11],[17,6],[15,3],[13,1],[11,0],[7,0],[5,1],[4,2],[3,4],[3,6],[4,8],[5,9],[12,13],[13,14],[14,16],[14,18],[13,20],[11,21],[9,20],[8,18],[8,16],[9,13],[11,10],[16,3],[18,1],[20,0],[22,0],[23,1],[23,2]]},"'":{width:10,points:[[5,19],[4,20],[5,21],[6,20],[6,18],[5,16],[4,15]]},"(":{width:14,points:[[11,25],[9,23],[7,20],[5,16],[4,11],[4,7],[5,2],[7,-2],[9,-5],[11,-7]]},")":{width:14,points:[[3,25],[5,23],[7,20],[9,16],[10,11],[10,7],[9,2],[7,-2],[5,-5],[3,-7]]},"*":{width:16,points:[[8,21],[8,9],[-1,-1],[3,18],[13,12],[-1,-1],[13,18],[3,12]]},"+":{width:26,points:[[13,18],[13,0],[-1,-1],[4,9],[22,9]]},",":{width:10,points:[[6,1],[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},"-":{width:26,points:[[4,9],[22,9]]},".":{width:10,points:[[5,2],[4,1],[5,0],[6,1],[5,2]]},"/":{width:22,points:[[20,25],[2,-7]]},0:{width:20,points:[[9,21],[6,20],[4,17],[3,12],[3,9],[4,4],[6,1],[9,0],[11,0],[14,1],[16,4],[17,9],[17,12],[16,17],[14,20],[11,21],[9,21]]},1:{width:20,points:[[6,17],[8,18],[11,21],[11,0]]},2:{width:20,points:[[4,16],[4,17],[5,19],[6,20],[8,21],[12,21],[14,20],[15,19],[16,17],[16,15],[15,13],[13,10],[3,0],[17,0]]},3:{width:20,points:[[5,21],[16,21],[10,13],[13,13],[15,12],[16,11],[17,8],[17,6],[16,3],[14,1],[11,0],[8,0],[5,1],[4,2],[3,4]]},4:{width:20,points:[[13,21],[3,7],[18,7],[-1,-1],[13,21],[13,0]]},5:{width:20,points:[[15,21],[5,21],[4,12],[5,13],[8,14],[11,14],[14,13],[16,11],[17,8],[17,6],[16,3],[14,1],[11,0],[8,0],[5,1],[4,2],[3,4]]},6:{width:20,points:[[16,18],[15,20],[12,21],[10,21],[7,20],[5,17],[4,12],[4,7],[5,3],[7,1],[10,0],[11,0],[14,1],[16,3],[17,6],[17,7],[16,10],[14,12],[11,13],[10,13],[7,12],[5,10],[4,7]]},7:{width:20,points:[[17,21],[7,0],[-1,-1],[3,21],[17,21]]},8:{width:20,points:[[8,21],[5,20],[4,18],[4,16],[5,14],[7,13],[11,12],[14,11],[16,9],[17,7],[17,4],[16,2],[15,1],[12,0],[8,0],[5,1],[4,2],[3,4],[3,7],[4,9],[6,11],[9,12],[13,13],[15,14],[16,16],[16,18],[15,20],[12,21],[8,21]]},9:{width:20,points:[[16,14],[15,11],[13,9],[10,8],[9,8],[6,9],[4,11],[3,14],[3,15],[4,18],[6,20],[9,21],[10,21],[13,20],[15,18],[16,14],[16,9],[15,4],[13,1],[10,0],[8,0],[5,1],[4,3]]},":":{width:10,points:[[5,14],[4,13],[5,12],[6,13],[5,14],[-1,-1],[5,2],[4,1],[5,0],[6,1],[5,2]]},";":{width:10,points:[[5,14],[4,13],[5,12],[6,13],[5,14],[-1,-1],[6,1],[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},"<":{width:24,points:[[20,18],[4,9],[20,0]]},"=":{width:26,points:[[4,12],[22,12],[-1,-1],[4,6],[22,6]]},">":{width:24,points:[[4,18],[20,9],[4,0]]},"?":{width:18,points:[[3,16],[3,17],[4,19],[5,20],[7,21],[11,21],[13,20],[14,19],[15,17],[15,15],[14,13],[13,12],[9,10],[9,7],[-1,-1],[9,2],[8,1],[9,0],[10,1],[9,2]]},"@":{width:27,points:[[18,13],[17,15],[15,16],[12,16],[10,15],[9,14],[8,11],[8,8],[9,6],[11,5],[14,5],[16,6],[17,8],[-1,-1],[12,16],[10,14],[9,11],[9,8],[10,6],[11,5],[-1,-1],[18,16],[17,8],[17,6],[19,5],[21,5],[23,7],[24,10],[24,12],[23,15],[22,17],[20,19],[18,20],[15,21],[12,21],[9,20],[7,19],[5,17],[4,15],[3,12],[3,9],[4,6],[5,4],[7,2],[9,1],[12,0],[15,0],[18,1],[20,2],[21,3],[-1,-1],[19,16],[18,8],[18,6],[19,5]]},A:{width:18,points:[[9,21],[1,0],[-1,-1],[9,21],[17,0],[-1,-1],[4,7],[14,7]]},B:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,15],[17,13],[16,12],[13,11],[-1,-1],[4,11],[13,11],[16,10],[17,9],[18,7],[18,4],[17,2],[16,1],[13,0],[4,0]]},C:{width:21,points:[[18,16],[17,18],[15,20],[13,21],[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5]]},D:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[11,21],[14,20],[16,18],[17,16],[18,13],[18,8],[17,5],[16,3],[14,1],[11,0],[4,0]]},E:{width:19,points:[[4,21],[4,0],[-1,-1],[4,21],[17,21],[-1,-1],[4,11],[12,11],[-1,-1],[4,0],[17,0]]},F:{width:18,points:[[4,21],[4,0],[-1,-1],[4,21],[17,21],[-1,-1],[4,11],[12,11]]},G:{width:21,points:[[18,16],[17,18],[15,20],[13,21],[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[18,8],[-1,-1],[13,8],[18,8]]},H:{width:22,points:[[4,21],[4,0],[-1,-1],[18,21],[18,0],[-1,-1],[4,11],[18,11]]},I:{width:8,points:[[4,21],[4,0]]},J:{width:16,points:[[12,21],[12,5],[11,2],[10,1],[8,0],[6,0],[4,1],[3,2],[2,5],[2,7]]},K:{width:21,points:[[4,21],[4,0],[-1,-1],[18,21],[4,7],[-1,-1],[9,12],[18,0]]},L:{width:17,points:[[4,21],[4,0],[-1,-1],[4,0],[16,0]]},M:{width:24,points:[[4,21],[4,0],[-1,-1],[4,21],[12,0],[-1,-1],[20,21],[12,0],[-1,-1],[20,21],[20,0]]},N:{width:22,points:[[4,21],[4,0],[-1,-1],[4,21],[18,0],[-1,-1],[18,21],[18,0]]},O:{width:22,points:[[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[19,8],[19,13],[18,16],[17,18],[15,20],[13,21],[9,21]]},P:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,14],[17,12],[16,11],[13,10],[4,10]]},Q:{width:22,points:[[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[19,8],[19,13],[18,16],[17,18],[15,20],[13,21],[9,21],[-1,-1],[12,4],[18,-2]]},R:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,15],[17,13],[16,12],[13,11],[4,11],[-1,-1],[11,11],[18,0]]},S:{width:20,points:[[17,18],[15,20],[12,21],[8,21],[5,20],[3,18],[3,16],[4,14],[5,13],[7,12],[13,10],[15,9],[16,8],[17,6],[17,3],[15,1],[12,0],[8,0],[5,1],[3,3]]},T:{width:16,points:[[8,21],[8,0],[-1,-1],[1,21],[15,21]]},U:{width:22,points:[[4,21],[4,6],[5,3],[7,1],[10,0],[12,0],[15,1],[17,3],[18,6],[18,21]]},V:{width:18,points:[[1,21],[9,0],[-1,-1],[17,21],[9,0]]},W:{width:24,points:[[2,21],[7,0],[-1,-1],[12,21],[7,0],[-1,-1],[12,21],[17,0],[-1,-1],[22,21],[17,0]]},X:{width:20,points:[[3,21],[17,0],[-1,-1],[17,21],[3,0]]},Y:{width:18,points:[[1,21],[9,11],[9,0],[-1,-1],[17,21],[9,11]]},Z:{width:20,points:[[17,21],[3,0],[-1,-1],[3,21],[17,21],[-1,-1],[3,0],[17,0]]},"[":{width:14,points:[[4,25],[4,-7],[-1,-1],[5,25],[5,-7],[-1,-1],[4,25],[11,25],[-1,-1],[4,-7],[11,-7]]},"\\":{width:14,points:[[0,21],[14,-3]]},"]":{width:14,points:[[9,25],[9,-7],[-1,-1],[10,25],[10,-7],[-1,-1],[3,25],[10,25],[-1,-1],[3,-7],[10,-7]]},"^":{width:16,points:[[6,15],[8,18],[10,15],[-1,-1],[3,12],[8,17],[13,12],[-1,-1],[8,17],[8,0]]},_:{width:16,points:[[0,-2],[16,-2]]},"`":{width:10,points:[[6,21],[5,20],[4,18],[4,16],[5,15],[6,16],[5,17]]},a:{width:19,points:[[15,14],[15,0],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},b:{width:19,points:[[4,21],[4,0],[-1,-1],[4,11],[6,13],[8,14],[11,14],[13,13],[15,11],[16,8],[16,6],[15,3],[13,1],[11,0],[8,0],[6,1],[4,3]]},c:{width:18,points:[[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},d:{width:19,points:[[15,21],[15,0],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},e:{width:18,points:[[3,8],[15,8],[15,10],[14,12],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},f:{width:12,points:[[10,21],[8,21],[6,20],[5,17],[5,0],[-1,-1],[2,14],[9,14]]},g:{width:19,points:[[15,14],[15,-2],[14,-5],[13,-6],[11,-7],[8,-7],[6,-6],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},h:{width:19,points:[[4,21],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0]]},i:{width:8,points:[[3,21],[4,20],[5,21],[4,22],[3,21],[-1,-1],[4,14],[4,0]]},j:{width:10,points:[[5,21],[6,20],[7,21],[6,22],[5,21],[-1,-1],[6,14],[6,-3],[5,-6],[3,-7],[1,-7]]},k:{width:17,points:[[4,21],[4,0],[-1,-1],[14,14],[4,4],[-1,-1],[8,8],[15,0]]},l:{width:8,points:[[4,21],[4,0]]},m:{width:30,points:[[4,14],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0],[-1,-1],[15,10],[18,13],[20,14],[23,14],[25,13],[26,10],[26,0]]},n:{width:19,points:[[4,14],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0]]},o:{width:19,points:[[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3],[16,6],[16,8],[15,11],[13,13],[11,14],[8,14]]},p:{width:19,points:[[4,14],[4,-7],[-1,-1],[4,11],[6,13],[8,14],[11,14],[13,13],[15,11],[16,8],[16,6],[15,3],[13,1],[11,0],[8,0],[6,1],[4,3]]},q:{width:19,points:[[15,14],[15,-7],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},r:{width:13,points:[[4,14],[4,0],[-1,-1],[4,8],[5,11],[7,13],[9,14],[12,14]]},s:{width:17,points:[[14,11],[13,13],[10,14],[7,14],[4,13],[3,11],[4,9],[6,8],[11,7],[13,6],[14,4],[14,3],[13,1],[10,0],[7,0],[4,1],[3,3]]},t:{width:12,points:[[5,21],[5,4],[6,1],[8,0],[10,0],[-1,-1],[2,14],[9,14]]},u:{width:19,points:[[4,14],[4,4],[5,1],[7,0],[10,0],[12,1],[15,4],[-1,-1],[15,14],[15,0]]},v:{width:16,points:[[2,14],[8,0],[-1,-1],[14,14],[8,0]]},w:{width:22,points:[[3,14],[7,0],[-1,-1],[11,14],[7,0],[-1,-1],[11,14],[15,0],[-1,-1],[19,14],[15,0]]},x:{width:17,points:[[3,14],[14,0],[-1,-1],[14,14],[3,0]]},y:{width:16,points:[[2,14],[8,0],[-1,-1],[14,14],[8,0],[6,-4],[4,-6],[2,-7],[1,-7]]},z:{width:17,points:[[14,14],[3,0],[-1,-1],[3,14],[14,14],[-1,-1],[3,0],[14,0]]},"{":{width:14,points:[[9,25],[7,24],[6,23],[5,21],[5,19],[6,17],[7,16],[8,14],[8,12],[6,10],[-1,-1],[7,24],[6,22],[6,20],[7,18],[8,17],[9,15],[9,13],[8,11],[4,9],[8,7],[9,5],[9,3],[8,1],[7,0],[6,-2],[6,-4],[7,-6],[-1,-1],[6,8],[8,6],[8,4],[7,2],[6,1],[5,-1],[5,-3],[6,-5],[7,-6],[9,-7]]},"|":{width:8,points:[[4,25],[4,-7]]},"}":{width:14,points:[[5,25],[7,24],[8,23],[9,21],[9,19],[8,17],[7,16],[6,14],[6,12],[8,10],[-1,-1],[7,24],[8,22],[8,20],[7,18],[6,17],[5,15],[5,13],[6,11],[10,9],[6,7],[5,5],[5,3],[6,1],[7,0],[8,-2],[8,-4],[7,-6],[-1,-1],[8,8],[6,6],[6,4],[7,2],[8,1],[9,-1],[9,-3],[8,-5],[7,-6],[5,-7]]},"~":{width:24,points:[[3,6],[3,8],[4,11],[6,12],[8,12],[10,11],[14,8],[16,7],[18,7],[20,8],[21,10],[-1,-1],[3,8],[4,10],[6,11],[8,11],[10,10],[14,7],[16,6],[18,6],[20,7],[21,10],[21,12]]}};function Ue(e={}){var t=e.origin||[0,0,0],i=t[0],s=t[1],r=t[2],o=e.size||1,n=[],a=[],l=e.text;y.isNumeric(l)&&(l=""+l);for(var A,c,h,u,d,p,f,m,g,_=(l||"").split("\n"),v=0,b=0,w=.04,B=0;B<_.length;B++){A=0,h=(c=_[B]).length;for(var P=0;P<h;P++)if(u=Re[c.charAt(P)]){d=1,p=-1,f=-1,m=u.points.length;for(var x=0;x<m;x++)-1!==(g=u.points[x])[0]||-1!==g[1]?(n.push(A+g[0]*o*w+i),n.push(b+g[1]*o*w+s),n.push(0+r),-1===p?p=v:(-1===f||(p=f),f=v),v++,d?d=!1:(a.push(p),a.push(f))):d=1;A+=u.width*w*o}b-=35*w*o}return y.apply(e,{primitive:"lines",positions:n,indices:a})}function Le(e={}){if(e.points.length%3!=0)throw"Size of points array for given polyline should be divisible by 3";let t=e.points.length/3;if(t<2)throw"There should be at least 2 points to create a polyline";let i=[];for(let e=0;e<t-1;e++)i.push(e),i.push(e+1);return y.apply(e,{primitive:"lines",positions:e.points,indices:i})}function ke(e={}){let t=e.curve.getPoints(e.divisions).map((e=>[...e])).flat();return Le({id:e.id,points:t})}function Oe(e={}){if(3!==e.startPoint.length)throw"Start point should contain 3 elements in array: x, y and z";if(3!==e.endPoint.length)throw"End point should contain 3 elements in array: x, y and z";let t=[],i=[],s=e.startPoint[0],r=e.startPoint[1],o=e.startPoint[2],n=e.endPoint[0],a=e.endPoint[1],l=e.endPoint[2],A=Math.sqrt((n-s)**2+(a-r)**2+(l-o)**2),c=[(n-s)/A,(a-r)/A,(l-o)/A];if(e.pattern){let h=e.pattern.length,u=!1,d=0,p=0,f=0,m=[s,r,o],g=e.pattern[p];for(i.push(m[0],m[1],m[2]);g<=A-d;){let s=[c[0]*g,c[1]*g,c[2]*g],r=[m[0]+s[0],m[1]+s[1],m[2]+s[2]];i.push(r[0],r[1],r[2]),u||(t.push(f),t.push(f+1)),u=!u,f+=1,m=r,p+=1,p>=h&&(p=0),d+=g,g=e.pattern[p]}e.extendToEnd&&(i.push(n,a,l),t.push(t.length-2),t.push(t.length-1))}else t.push(0),t.push(1),i.push(s,r,o,n,a,l);return y.apply(e,{primitive:"lines",positions:i,indices:t})}const Ne=d.vec4(4),Ve=d.vec4(),Qe=d.vec4(),He=d.vec3([1,0,0]),je=d.vec3([0,1,0]),Ge=d.vec3([0,0,1]),ze=d.vec3(3),We=d.vec3(3),Xe=d.identityMat4();class Ke extends R{constructor(e,t={}){if(super(e,t),this._parentNode=null,this._children=[],this._aabb=null,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._numTriangles=0,this._scale=d.vec3(),this._quaternion=d.identityQuaternion(),this._rotation=d.vec3(),this._position=d.vec3(),this._offset=d.vec3(),this._localMatrix=d.identityMat4(),this._worldMatrix=d.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this._isObject=t.isObject,this._isObject&&this.scene._registerObject(this),this.origin=t.origin,this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.colorize=t.colorize,this.opacity=t.opacity,this.offset=t.offset,t.children){const e=t.children;for(let i=0,s=e.length;i<s;i++)this.addChild(e[i],t.inheritStates)}if(t.parentId){const e=this.scene.components[t.parentId];e?e.isNode?e.addChild(this):this.error("Parent is not a Node: '"+t.parentId+"'"):this.error("Parent not found: '"+t.parentId+"'")}else t.parent&&(t.parent.isNode||this.error("Parent is not a Node"),t.parent.addChild(this))}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}set origin(e){e?(this._origin||(this._origin=d.vec3()),this._origin.set(e)):this._origin&&(this._origin=null);for(let t=0,i=this._children.length;t<i;t++)this._children[t].origin=e;this.glRedraw()}get origin(){return this._origin}set rtcCenter(e){this.origin=e}get rtcCenter(){return this.origin}get numTriangles(){return this._numTriangles}set visible(e){e=!1!==e,this._visible=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].visible=e;this._isObject&&this.scene._objectVisibilityUpdated(this,e)}get visible(){return this._visible}set xrayed(e){e=!!e,this._xrayed=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].xrayed=e;this._isObject&&this.scene._objectXRayedUpdated(this,e)}get xrayed(){return this._xrayed}set highlighted(e){e=!!e,this._highlighted=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].highlighted=e;this._isObject&&this.scene._objectHighlightedUpdated(this,e)}get highlighted(){return this._highlighted}set selected(e){e=!!e,this._selected=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].selected=e;this._isObject&&this.scene._objectSelectedUpdated(this,e)}get selected(){return this._selected}set edges(e){e=!!e,this._edges=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].edges=e}get edges(){return this._edges}set culled(e){e=!!e,this._culled=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].culled=e}get culled(){return this._culled}set clippable(e){e=!1!==e,this._clippable=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].clippable=e}get clippable(){return this._clippable}set collidable(e){e=!1!==e,this._collidable=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].collidable=e}get collidable(){return this._collidable}set pickable(e){e=!1!==e,this._pickable=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].pickable=e}get pickable(){return this._pickable}set colorize(e){let t=this._colorize;t||(t=this._colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);for(let e=0,i=this._children.length;e<i;e++)this._children[e].colorize=t;if(this._isObject){const t=!!e;this.scene._objectColorizeUpdated(this,t)}}get colorize(){return this._colorize.slice(0,3)}set opacity(e){let t=this._colorize;t||(t=this._colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1),t[3]=null!=e?e:1;for(let t=0,i=this._children.length;t<i;t++)this._children[t].opacity=e;if(this._isObject){const t=null!=e;this.scene._objectOpacityUpdated(this,t)}}get opacity(){return this._colorize[3]}set castsShadow(e){e=!!e,this._castsShadow=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].castsShadow=e}get castsShadow(){return this._castsShadow}set receivesShadow(e){e=!!e,this._receivesShadow=e;for(let t=0,i=this._children.length;t<i;t++)this._children[t].receivesShadow=e}get receivesShadow(){return this._receivesShadow}get saoEnabled(){return!1}set offset(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let e=0,t=this._children.length;e<t;e++)this._children[e].offset=this._offset;this._isObject&&this.scene._objectOffsetUpdated(this,e)}get offset(){return this._offset}get isNode(){return!0}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._setWorldMatrixDirty()}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)d.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_setSubtreeAABBsDirty(e){if(e._aabbDirty=!0,e._children)for(let t=0,i=e._children.length;t<i;t++)this._setSubtreeAABBsDirty(e._children[t])}_setAABBDirty(){if(this._setSubtreeAABBsDirty(this),this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0}_updateAABB(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=d.AABB3()),this._buildAABB)this._buildAABB(this.worldMatrix,this._aabb);else{let e;d.collapseAABB3(this._aabb);for(let t=0,i=this._children.length;t<i;t++)e=this._children[t],e.collidable&&d.expandAABB3(this._aabb,e.aabb)}this._aabbDirty=!1}addChild(e,t){if(y.isNumeric(e)||y.isString(e)){const t=e;if(!(e=this.scene.component[t]))return void this.warn("Component not found: "+y.inQuotes(t));if(!e.isNode&&!e.isMesh)return void this.error("Not a Node or Mesh: "+t)}else{if(!e.isNode&&!e.isMesh)return void this.error("Not a Node or Mesh: "+e.id);if(e._parentNode){if(e._parentNode.id===this.id)return void this.warn("Already a child: "+e.id);e._parentNode.removeChild(e)}}if(e.id,e.scene.id===this.scene.id)return this._children.push(e),e._parentNode=this,t&&(e.visible=this.visible,e.culled=this.culled,e.xrayed=this.xrayed,e.highlited=this.highlighted,e.selected=this.selected,e.edges=this.edges,e.clippable=this.clippable,e.pickable=this.pickable,e.collidable=this.collidable,e.castsShadow=this.castsShadow,e.receivesShadow=this.receivesShadow,e.colorize=this.colorize,e.opacity=this.opacity,e.offset=this.offset),e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles+=e.numTriangles,e;this.error("Child not in same Scene: "+e.id)}removeChild(e){for(let t=0,i=this._children.length;t<i;t++)if(this._children[t].id===e.id)return e._parentNode=null,this._children=this._children.splice(t,1),e._setWorldMatrixDirty(),e._setAABBDirty(),this._setAABBDirty(),void(this._numTriangles-=e.numTriangles)}removeChildren(){let e;for(let t=0,i=this._children.length;t<i;t++)e=this._children[t],e._parentNode=null,e._setWorldMatrixDirty(),e._setAABBDirty(),this._numTriangles-=e.numTriangles;this._children=[],this._setAABBDirty()}get numChildren(){return this._children.length}get children(){return this._children}set parent(e){if(y.isNumeric(e)||y.isString(e)){const t=e;if(!(e=this.scene.components[t]))return void this.warn("Node not found: "+y.inQuotes(t));if(!e.isNode)return void this.error("Not a Node: "+e.id)}e.scene.id===this.scene.id?this._parentNode&&this._parentNode.id===e.id?this.warn("Already a child of Node: "+e.id):e.addChild(this):this.error("Node not in same Scene: "+e.id)}get parent(){return this._parentNode}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),d.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),d.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set matrix(e){this._localMatrix||(this._localMatrix=d.identityMat4()),this._localMatrix.set(e||Xe),d.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=d.identityMat4()),d.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}rotate(e,t){return Ne[0]=e[0],Ne[1]=e[1],Ne[2]=e[2],Ne[3]=t*d.DEGTORAD,d.angleAxisToQuaternion(Ne,Ve),d.mulQuaternions(this.quaternion,Ve,Qe),this.quaternion=Qe,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,t){return Ne[0]=e[0],Ne[1]=e[1],Ne[2]=e[2],Ne[3]=t*d.DEGTORAD,d.angleAxisToQuaternion(Ne,Ve),d.mulQuaternions(Ve,this.quaternion,Ve),this}rotateX(e){return this.rotate(He,e)}rotateY(e){return this.rotate(je,e)}rotateZ(e){return this.rotate(Ge,e)}translate(e,t){return d.vec3ApplyQuaternion(this.quaternion,e,ze),d.mulVec3Scalar(ze,t,We),d.addVec3(this.position,We,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(He,e)}translateY(e){return this.translate(je,e)}translateZ(e){return this.translate(Ge,e)}get type(){return"Node"}destroy(){if(super.destroy(),this._parentNode&&this._parentNode.removeChild(this),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.offset.some((e=>0!==e))&&this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this._children.length){const e=this._children.splice(0);let t;for(let i=0,s=e.length;i<s;i++)t=e[i],t.destroy()}this._children=[],this._setAABBDirty(),this.scene._aabbDirty=!0}}const Ze=d.vec3(),Je=d.vec4(),Ye=function(){const e=new Float64Array(16),t=new Float64Array(4),i=new Float64Array(4);return function(s,r,o){return o=o||e,t[0]=r[0],t[1]=r[1],t[2]=r[2],t[3]=1,d.transformVec4(s,t,i),d.setMat4Translation(s,i,o),o.slice()}}();function qe(e,t,i){const s=Float32Array.from([e[0]])[0],r=e[0]-s,o=Float32Array.from([e[1]])[0],n=e[1]-o,a=Float32Array.from([e[2]])[0],l=e[2]-a;t[0]=s,t[1]=o,t[2]=a,i[0]=r,i[1]=n,i[2]=l}function $e(e,t,i,s=1e3){const r=d.getPositionsCenter(e,Ze),o=Math.round(r[0]/s)*s,n=Math.round(r[1]/s)*s,a=Math.round(r[2]/s)*s;i[0]=o,i[1]=n,i[2]=a;const l=0!==i[0]||0!==i[1]||0!==i[2];if(l)for(let i=0,s=e.length;i<s;i+=3)t[i+0]=e[i+0]-o,t[i+1]=e[i+1]-n,t[i+2]=e[i+2]-a;return l}function et(e,t,i){return i[0]=e[0]+t[0],i[1]=e[1]+t[1],i[2]=e[2]+t[2],i}function tt(e,t,i,s,r){const o=r?(Je.set(i,0),Je[3]=1,d.mulMat4v4(r,Je,Je)):i,n=d.dotVec3(t,o)+e,a=d.normalizeVec3(t,Ze);return d.mulVec3Scalar(a,-n,s),s}const it=1e3,st=1001,rt=1002,ot=1003,nt=1004,at=1004,lt=1005,At=1005,ct=1006,ht=1007,ut=1007,dt=1008,pt=1008,ft=1009,mt=1010,gt=1011,_t=1012,vt=1013,bt=1014,yt=1015,wt=1016,Bt=1017,Pt=1018,xt=1020,Ct=1021,Mt=1022,Et=1023,Ft=1024,It=1025,Tt=1026,Dt=1027,St=1028,Rt=1029,Ut=1030,Lt=1031,kt=1033,Ot=33776,Nt=33777,Vt=33778,Qt=33779,Ht=35840,jt=35841,Gt=35842,zt=35843,Wt=36196,Xt=37492,Kt=37496,Zt=37808,Jt=37809,Yt=37810,qt=37811,$t=37812,ei=37813,ti=37814,ii=37815,si=37816,ri=37817,oi=37818,ni=37819,ai=37820,li=37821,Ai=36492,ci=3e3,hi=3001,ui=1e4,di=10001,pi=10002,fi=10003,mi=function(e){"LambertMaterial"===e._material._state.type?(this.vertex=function(e){const t=e.scene,i=e.scene._sectionPlanesState,s=e.scene._lightsState,r=e._geometry._state,o=e._state.billboard,n=e._state.stationary,a=i.getNumAllocatedSectionPlanes()>0,l=!!r.compressGeometry,A=[];A.push("#version 300 es"),A.push("// Lambertian drawing vertex shader"),A.push("in vec3 position;"),A.push("uniform mat4 modelMatrix;"),A.push("uniform mat4 viewMatrix;"),A.push("uniform mat4 projMatrix;"),A.push("uniform vec4 colorize;"),A.push("uniform vec3 offset;"),A.push("uniform vec3 scale;"),l&&A.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(A.push("uniform float logDepthBufFC;"),A.push("out float vFragDepth;"),A.push("bool isPerspectiveMatrix(mat4 m) {"),A.push("    return (m[2][3] == - 1.0);"),A.push("}"),A.push("out float isPerspective;"));a&&A.push("out vec4 vWorldPosition;");if(A.push("uniform vec4 lightAmbient;"),A.push("uniform vec4 materialColor;"),A.push("uniform vec3 materialEmissive;"),r.normalsBuf){A.push("in vec3 normal;"),A.push("uniform mat4 modelNormalMatrix;"),A.push("uniform mat4 viewNormalMatrix;");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];"ambient"!==t.type&&(A.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&A.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&A.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(A.push("uniform vec3 lightPos"+e+";"),A.push("uniform vec3 lightDir"+e+";")))}l&&(A.push("vec3 octDecode(vec2 oct) {"),A.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),A.push("    if (v.z < 0.0) {"),A.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),A.push("    }"),A.push("    return normalize(v);"),A.push("}"))}A.push("out vec4 vColor;"),"points"===r.primitiveName&&A.push("uniform float pointSize;");"spherical"!==o&&"cylindrical"!==o||(A.push("void billboard(inout mat4 mat) {"),A.push("   mat[0][0] = scale[0];"),A.push("   mat[0][1] = 0.0;"),A.push("   mat[0][2] = 0.0;"),"spherical"===o&&(A.push("   mat[1][0] = 0.0;"),A.push("   mat[1][1] = scale[1];"),A.push("   mat[1][2] = 0.0;")),A.push("   mat[2][0] = 0.0;"),A.push("   mat[2][1] = 0.0;"),A.push("   mat[2][2] =1.0;"),A.push("}"));A.push("void main(void) {"),A.push("vec4 localPosition = vec4(position, 1.0); "),A.push("vec4 worldPosition;"),l&&A.push("localPosition = positionsDecodeMatrix * localPosition;");r.normalsBuf&&(l?A.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):A.push("vec4 localNormal = vec4(normal, 0.0); "),A.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),A.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));A.push("mat4 viewMatrix2 = viewMatrix;"),A.push("mat4 modelMatrix2 = modelMatrix;"),n&&A.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===o||"cylindrical"===o?(A.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),A.push("billboard(modelMatrix2);"),A.push("billboard(viewMatrix2);"),A.push("billboard(modelViewMatrix);"),r.normalsBuf&&(A.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),A.push("billboard(modelNormalMatrix2);"),A.push("billboard(viewNormalMatrix2);"),A.push("billboard(modelViewNormalMatrix);")),A.push("worldPosition = modelMatrix2 * localPosition;"),A.push("worldPosition.xyz = worldPosition.xyz + offset;"),A.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(A.push("worldPosition = modelMatrix2 * localPosition;"),A.push("worldPosition.xyz = worldPosition.xyz + offset;"),A.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));r.normalsBuf&&A.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(A.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),A.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),A.push("float lambertian = 1.0;"),r.normalsBuf)for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?A.push("viewLightDir = normalize(lightDir"+e+");"):A.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?A.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):A.push("viewLightDir = -normalize((viewMatrix2 * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==t.type)continue;"view"===t.space?A.push("viewLightDir = normalize(lightDir"+e+");"):A.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+e+", 0.0)).xyz);")}A.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),A.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}}A.push("vColor = vec4((lightAmbient.rgb * lightAmbient.a * materialColor.rgb) + materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),a&&A.push("vWorldPosition = worldPosition;");"points"===r.primitiveName&&A.push("gl_PointSize = pointSize;");A.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(A.push("vFragDepth = 1.0 + clipPos.w;"),A.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return A.push("gl_Position = clipPos;"),A.push("}"),A}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState;e._material._state;const s=e._geometry._state,r=i.getNumAllocatedSectionPlanes()>0,o=t.gammaOutput,n=[];n.push("#version 300 es"),n.push("// Lambertian drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),t.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;"));if(r){n.push("in vec4 vWorldPosition;"),n.push("uniform bool clippable;");for(let e=0,t=i.getNumAllocatedSectionPlanes();e<t;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";")}n.push("in vec4 vColor;"),o&&(n.push("uniform float gammaFactor;"),n.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}"));if(n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,t=i.getNumAllocatedSectionPlanes();e<t;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > 0.0) { discard; }"),n.push("}")}"points"===s.primitiveName&&(n.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),n.push("float r = dot(cxy, cxy);"),n.push("if (r > 1.0) {"),n.push("   discard;"),n.push("}"));t.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");o?n.push("outColor = linearToGamma(vColor, gammaFactor);"):n.push("outColor = vColor;");return n.push("}"),n}(e)):(this.vertex=function(e){const t=e.scene;e._material;const i=e._state,s=t._sectionPlanesState,r=e._geometry._state,o=t._lightsState;let n;const a=i.billboard,l=i.background,A=i.stationary,c=function(e){if(!e._geometry._state.uvBuf)return!1;const t=e._material;return!!(t._ambientMap||t._occlusionMap||t._baseColorMap||t._diffuseMap||t._alphaMap||t._specularMap||t._glossinessMap||t._specularGlossinessMap||t._emissiveMap||t._metallicMap||t._roughnessMap||t._metallicRoughnessMap||t._reflectivityMap||t._normalMap)}(e),h=vi(e),u=s.getNumAllocatedSectionPlanes()>0,d=_i(e),p=!!r.compressGeometry,f=[];f.push("#version 300 es"),f.push("// Drawing vertex shader"),f.push("in  vec3 position;"),p&&f.push("uniform mat4 positionsDecodeMatrix;");f.push("uniform  mat4 modelMatrix;"),f.push("uniform  mat4 viewMatrix;"),f.push("uniform  mat4 projMatrix;"),f.push("out  vec3 vViewPosition;"),f.push("uniform  vec3 offset;"),f.push("uniform  vec3 scale;"),u&&f.push("out vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(f.push("uniform float logDepthBufFC;"),f.push("out float vFragDepth;"),f.push("bool isPerspectiveMatrix(mat4 m) {"),f.push("    return (m[2][3] == - 1.0);"),f.push("}"),f.push("out float isPerspective;"));o.lightMaps.length>0&&f.push("out    vec3 vWorldNormal;");if(h){f.push("in  vec3 normal;"),f.push("uniform    mat4 modelNormalMatrix;"),f.push("uniform    mat4 viewNormalMatrix;"),f.push("out    vec3 vViewNormal;");for(let e=0,t=o.lights.length;e<t;e++)n=o.lights[e],"ambient"!==n.type&&("dir"===n.type&&f.push("uniform vec3 lightDir"+e+";"),"point"===n.type&&f.push("uniform vec3 lightPos"+e+";"),"spot"===n.type&&(f.push("uniform vec3 lightPos"+e+";"),f.push("uniform vec3 lightDir"+e+";")),"dir"===n.type&&"view"===n.space||f.push("out vec4 vViewLightReverseDirAndDist"+e+";"));p&&(f.push("vec3 octDecode(vec2 oct) {"),f.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),f.push("    if (v.z < 0.0) {"),f.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),f.push("    }"),f.push("    return normalize(v);"),f.push("}"))}c&&(f.push("in vec2 uv;"),f.push("out vec2 vUV;"),p&&f.push("uniform mat3 uvDecodeMatrix;"));r.colors&&(f.push("in vec4 color;"),f.push("out vec4 vColor;"));"points"===r.primitiveName&&f.push("uniform float pointSize;");"spherical"!==a&&"cylindrical"!==a||(f.push("void billboard(inout mat4 mat) {"),f.push("   mat[0][0] = scale[0];"),f.push("   mat[0][1] = 0.0;"),f.push("   mat[0][2] = 0.0;"),"spherical"===a&&(f.push("   mat[1][0] = 0.0;"),f.push("   mat[1][1] = scale[1];"),f.push("   mat[1][2] = 0.0;")),f.push("   mat[2][0] = 0.0;"),f.push("   mat[2][1] = 0.0;"),f.push("   mat[2][2] =1.0;"),f.push("}"));if(d){f.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");for(let e=0,t=o.lights.length;e<t;e++)o.lights[e].castsShadow&&(f.push("uniform mat4 shadowViewMatrix"+e+";"),f.push("uniform mat4 shadowProjMatrix"+e+";"),f.push("out vec4 vShadowPosFromLight"+e+";"))}f.push("void main(void) {"),f.push("vec4 localPosition = vec4(position, 1.0); "),f.push("vec4 worldPosition;"),p&&f.push("localPosition = positionsDecodeMatrix * localPosition;");h&&(p?f.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):f.push("vec4 localNormal = vec4(normal, 0.0); "),f.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),f.push("mat4 viewNormalMatrix2     = viewNormalMatrix;"));f.push("mat4 viewMatrix2           = viewMatrix;"),f.push("mat4 modelMatrix2          = modelMatrix;"),A?f.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"):l&&f.push("viewMatrix2[3] = vec4(0.0, 0.0, 0.0 ,1.0);");"spherical"===a||"cylindrical"===a?(f.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),f.push("billboard(modelMatrix2);"),f.push("billboard(viewMatrix2);"),f.push("billboard(modelViewMatrix);"),h&&(f.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),f.push("billboard(modelNormalMatrix2);"),f.push("billboard(viewNormalMatrix2);"),f.push("billboard(modelViewNormalMatrix);")),f.push("worldPosition = modelMatrix2 * localPosition;"),f.push("worldPosition.xyz = worldPosition.xyz + offset;"),f.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(f.push("worldPosition = modelMatrix2 * localPosition;"),f.push("worldPosition.xyz = worldPosition.xyz + offset;"),f.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));if(h){f.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),o.lightMaps.length>0&&f.push("vWorldNormal = worldNormal;"),f.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),f.push("vec3 tmpVec3;"),f.push("float lightDist;");for(let e=0,t=o.lights.length;e<t;e++)n=o.lights[e],"ambient"!==n.type&&("dir"===n.type&&"world"===n.space&&(f.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+e+", 0.0) ).xyz;"),f.push("vViewLightReverseDirAndDist"+e+" = vec4(-tmpVec3, 0.0);")),"point"===n.type&&("world"===n.space?(f.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+e+", 1.0)).xyz - viewPosition.xyz;"),f.push("lightDist = abs(length(tmpVec3));")):(f.push("tmpVec3 = lightPos"+e+".xyz - viewPosition.xyz;"),f.push("lightDist = abs(length(tmpVec3));")),f.push("vViewLightReverseDirAndDist"+e+" = vec4(tmpVec3, lightDist);")))}c&&(p?f.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):f.push("vUV = uv;"));r.colors&&f.push("vColor = color;");"points"===r.primitiveName&&f.push("gl_PointSize = pointSize;");u&&f.push("vWorldPosition = worldPosition;");f.push("   vViewPosition = viewPosition.xyz;"),f.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(f.push("vFragDepth = 1.0 + clipPos.w;"),f.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));l&&f.push("clipPos.z = clipPos.w;");if(f.push("gl_Position = clipPos;"),d){f.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),f.push("vec4 tempx; ");for(let e=0,t=o.lights.length;e<t;e++)o.lights[e].castsShadow&&f.push("vShadowPosFromLight"+e+" = texUnitConverter * shadowProjMatrix"+e+" * (shadowViewMatrix"+e+" * worldPosition); ")}return f.push("}"),f}(e),this.fragment=function(e){const t=e.scene;t.canvas.gl;const i=e._material,s=e._geometry._state,r=e.scene._sectionPlanesState,o=e.scene._lightsState,n=e._material._state,a=r.getNumAllocatedSectionPlanes()>0,l=vi(e),A=s.uvBuf,c="PhongMaterial"===n.type,h="MetallicMaterial"===n.type,u="SpecularMaterial"===n.type,d=_i(e);t.gammaInput;const p=t.gammaOutput,f=[];f.push("#version 300 es"),f.push("// Drawing fragment shader"),f.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),f.push("precision highp float;"),f.push("precision highp int;"),f.push("#else"),f.push("precision mediump float;"),f.push("precision mediump int;"),f.push("#endif"),t.logarithmicDepthBufferEnabled&&(f.push("in float isPerspective;"),f.push("uniform float logDepthBufFC;"),f.push("in float vFragDepth;"));d&&(f.push("float unpackDepth (vec4 color) {"),f.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),f.push("  return dot(color, bitShift);"),f.push("}"));f.push("uniform float gammaFactor;"),f.push("vec4 linearToLinear( in vec4 value ) {"),f.push("  return value;"),f.push("}"),f.push("vec4 sRGBToLinear( in vec4 value ) {"),f.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),f.push("}"),f.push("vec4 gammaToLinear( in vec4 value) {"),f.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),f.push("}"),p&&(f.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),f.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),f.push("}"));if(a){f.push("in vec4 vWorldPosition;"),f.push("uniform bool clippable;");for(var m=0;m<r.getNumAllocatedSectionPlanes();m++)f.push("uniform bool sectionPlaneActive"+m+";"),f.push("uniform vec3 sectionPlanePos"+m+";"),f.push("uniform vec3 sectionPlaneDir"+m+";")}l&&(o.lightMaps.length>0&&(f.push("uniform samplerCube lightMap;"),f.push("uniform mat4 viewNormalMatrix;")),o.reflectionMaps.length>0&&f.push("uniform samplerCube reflectionMap;"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&f.push("uniform mat4 viewMatrix;"),f.push("#define PI 3.14159265359"),f.push("#define RECIPROCAL_PI 0.31830988618"),f.push("#define RECIPROCAL_PI2 0.15915494"),f.push("#define EPSILON 1e-6"),f.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),f.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),f.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),f.push("}"),f.push("struct IncidentLight {"),f.push("   vec3 color;"),f.push("   vec3 direction;"),f.push("};"),f.push("struct ReflectedLight {"),f.push("   vec3 diffuse;"),f.push("   vec3 specular;"),f.push("};"),f.push("struct Geometry {"),f.push("   vec3 position;"),f.push("   vec3 viewNormal;"),f.push("   vec3 worldNormal;"),f.push("   vec3 viewEyeDir;"),f.push("};"),f.push("struct Material {"),f.push("   vec3    diffuseColor;"),f.push("   float   specularRoughness;"),f.push("   vec3    specularColor;"),f.push("   float   shine;"),f.push("};"),c&&((o.lightMaps.length>0||o.reflectionMaps.length>0)&&(f.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(f.push("   vec3 irradiance = "+gi[o.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),f.push("   irradiance *= PI;"),f.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(f.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),f.push("   vec3 radiance               = texture(reflectionMap, reflectVec).rgb * 0.2;"),f.push("   radiance *= PI;"),f.push("   reflectedLight.specular     += radiance;")),f.push("}")),f.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),f.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),f.push("   vec3 irradiance = dotNL * directLight.color * PI;"),f.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),f.push("}")),(h||u)&&(f.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),f.push("   float r = ggxRoughness + 0.0001;"),f.push("   return (2.0 / (r * r) - 2.0);"),f.push("}"),f.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),f.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),f.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),f.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),f.push("}"),o.reflectionMaps.length>0&&(f.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),f.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),f.push("   vec3 envMapColor = "+gi[o.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),f.push("  return envMapColor;"),f.push("}")),f.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),f.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),f.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),f.push("}"),f.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),f.push("   float a2 = ( alpha * alpha );"),f.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),f.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),f.push("   return 1.0 / ( gl * gv );"),f.push("}"),f.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),f.push("   float a2 = ( alpha * alpha );"),f.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),f.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),f.push("   return 0.5 / max( gv + gl, EPSILON );"),f.push("}"),f.push("float D_GGX(const in float alpha, const in float dotNH) {"),f.push("   float a2 = ( alpha * alpha );"),f.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),f.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),f.push("}"),f.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),f.push("   float alpha = ( roughness * roughness );"),f.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),f.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),f.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),f.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),f.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),f.push("   vec3  F = F_Schlick( specularColor, dotLH );"),f.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),f.push("   float D = D_GGX( alpha, dotNH );"),f.push("   return F * (G * D);"),f.push("}"),f.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),f.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),f.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),f.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),f.push("   vec4 r = roughness * c0 + c1;"),f.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),f.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),f.push("   return specularColor * AB.x + AB.y;"),f.push("}"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&(f.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(f.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),f.push("   irradiance *= PI;"),f.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(f.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),f.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),f.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),f.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),f.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),f.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),f.push("}")),f.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),f.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),f.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),f.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),f.push("}")));f.push("in vec3 vViewPosition;"),s.colors&&f.push("in vec4 vColor;");A&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._occlusionMap||i._alphaMap)&&f.push("in vec2 vUV;");l&&(o.lightMaps.length>0&&f.push("in vec3 vWorldNormal;"),f.push("in vec3 vViewNormal;"));n.ambient&&f.push("uniform vec3 materialAmbient;");n.baseColor&&f.push("uniform vec3 materialBaseColor;");void 0!==n.alpha&&null!==n.alpha&&f.push("uniform vec4 materialAlphaModeCutoff;");n.emissive&&f.push("uniform vec3 materialEmissive;");n.diffuse&&f.push("uniform vec3 materialDiffuse;");void 0!==n.glossiness&&null!==n.glossiness&&f.push("uniform float materialGlossiness;");void 0!==n.shininess&&null!==n.shininess&&f.push("uniform float materialShininess;");n.specular&&f.push("uniform vec3 materialSpecular;");void 0!==n.metallic&&null!==n.metallic&&f.push("uniform float materialMetallic;");void 0!==n.roughness&&null!==n.roughness&&f.push("uniform float materialRoughness;");void 0!==n.specularF0&&null!==n.specularF0&&f.push("uniform float materialSpecularF0;");A&&i._ambientMap&&(f.push("uniform sampler2D ambientMap;"),i._ambientMap._state.matrix&&f.push("uniform mat4 ambientMapMatrix;"));A&&i._baseColorMap&&(f.push("uniform sampler2D baseColorMap;"),i._baseColorMap._state.matrix&&f.push("uniform mat4 baseColorMapMatrix;"));A&&i._diffuseMap&&(f.push("uniform sampler2D diffuseMap;"),i._diffuseMap._state.matrix&&f.push("uniform mat4 diffuseMapMatrix;"));A&&i._emissiveMap&&(f.push("uniform sampler2D emissiveMap;"),i._emissiveMap._state.matrix&&f.push("uniform mat4 emissiveMapMatrix;"));l&&A&&i._metallicMap&&(f.push("uniform sampler2D metallicMap;"),i._metallicMap._state.matrix&&f.push("uniform mat4 metallicMapMatrix;"));l&&A&&i._roughnessMap&&(f.push("uniform sampler2D roughnessMap;"),i._roughnessMap._state.matrix&&f.push("uniform mat4 roughnessMapMatrix;"));l&&A&&i._metallicRoughnessMap&&(f.push("uniform sampler2D metallicRoughnessMap;"),i._metallicRoughnessMap._state.matrix&&f.push("uniform mat4 metallicRoughnessMapMatrix;"));l&&i._normalMap&&(f.push("uniform sampler2D normalMap;"),i._normalMap._state.matrix&&f.push("uniform mat4 normalMapMatrix;"),f.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),f.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),f.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),f.push("      vec2 st0 = dFdx( uv.st );"),f.push("      vec2 st1 = dFdy( uv.st );"),f.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),f.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),f.push("      vec3 N = normalize( surf_norm );"),f.push("      vec3 mapN = texture( normalMap, uv ).xyz * 2.0 - 1.0;"),f.push("      mat3 tsn = mat3( S, T, N );"),f.push("      return normalize( tsn * mapN );"),f.push("}"));A&&i._occlusionMap&&(f.push("uniform sampler2D occlusionMap;"),i._occlusionMap._state.matrix&&f.push("uniform mat4 occlusionMapMatrix;"));A&&i._alphaMap&&(f.push("uniform sampler2D alphaMap;"),i._alphaMap._state.matrix&&f.push("uniform mat4 alphaMapMatrix;"));l&&A&&i._specularMap&&(f.push("uniform sampler2D specularMap;"),i._specularMap._state.matrix&&f.push("uniform mat4 specularMapMatrix;"));l&&A&&i._glossinessMap&&(f.push("uniform sampler2D glossinessMap;"),i._glossinessMap._state.matrix&&f.push("uniform mat4 glossinessMapMatrix;"));l&&A&&i._specularGlossinessMap&&(f.push("uniform sampler2D materialSpecularGlossinessMap;"),i._specularGlossinessMap._state.matrix&&f.push("uniform mat4 materialSpecularGlossinessMapMatrix;"));l&&(i._diffuseFresnel||i._specularFresnel||i._alphaFresnel||i._emissiveFresnel||i._reflectivityFresnel)&&(f.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),f.push("    float fr = abs(dot(eyeDir, normal));"),f.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),f.push("    return pow(finalFr, power);"),f.push("}"),i._diffuseFresnel&&(f.push("uniform float  diffuseFresnelCenterBias;"),f.push("uniform float  diffuseFresnelEdgeBias;"),f.push("uniform float  diffuseFresnelPower;"),f.push("uniform vec3   diffuseFresnelCenterColor;"),f.push("uniform vec3   diffuseFresnelEdgeColor;")),i._specularFresnel&&(f.push("uniform float  specularFresnelCenterBias;"),f.push("uniform float  specularFresnelEdgeBias;"),f.push("uniform float  specularFresnelPower;"),f.push("uniform vec3   specularFresnelCenterColor;"),f.push("uniform vec3   specularFresnelEdgeColor;")),i._alphaFresnel&&(f.push("uniform float  alphaFresnelCenterBias;"),f.push("uniform float  alphaFresnelEdgeBias;"),f.push("uniform float  alphaFresnelPower;"),f.push("uniform vec3   alphaFresnelCenterColor;"),f.push("uniform vec3   alphaFresnelEdgeColor;")),i._reflectivityFresnel&&(f.push("uniform float  materialSpecularF0FresnelCenterBias;"),f.push("uniform float  materialSpecularF0FresnelEdgeBias;"),f.push("uniform float  materialSpecularF0FresnelPower;"),f.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),f.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),i._emissiveFresnel&&(f.push("uniform float  emissiveFresnelCenterBias;"),f.push("uniform float  emissiveFresnelEdgeBias;"),f.push("uniform float  emissiveFresnelPower;"),f.push("uniform vec3   emissiveFresnelCenterColor;"),f.push("uniform vec3   emissiveFresnelEdgeColor;")));if(f.push("uniform vec4   lightAmbient;"),l)for(let e=0,t=o.lights.length;e<t;e++){const t=o.lights[e];"ambient"!==t.type&&(f.push("uniform vec4 lightColor"+e+";"),"point"===t.type&&f.push("uniform vec3 lightAttenuation"+e+";"),"dir"===t.type&&"view"===t.space&&f.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&"view"===t.space?f.push("uniform vec3 lightPos"+e+";"):f.push("in vec4 vViewLightReverseDirAndDist"+e+";"))}if(d)for(let e=0,t=o.lights.length;e<t;e++)o.lights[e].castsShadow&&(f.push("in vec4 vShadowPosFromLight"+e+";"),f.push("uniform sampler2D shadowMap"+e+";"));if(f.push("uniform vec4 colorize;"),f.push("out vec4 outColor;"),f.push("void main(void) {"),a){f.push("if (clippable) {"),f.push("  float dist = 0.0;");for(m=0;m<r.getNumAllocatedSectionPlanes();m++)f.push("if (sectionPlaneActive"+m+") {"),f.push("   dist += clamp(dot(-sectionPlaneDir"+m+".xyz, vWorldPosition.xyz - sectionPlanePos"+m+".xyz), 0.0, 1000.0);"),f.push("}");f.push("  if (dist > 0.0) { discard; }"),f.push("}")}"points"===s.primitiveName&&(f.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),f.push("float r = dot(cxy, cxy);"),f.push("if (r > 1.0) {"),f.push("   discard;"),f.push("}"));f.push("float occlusion = 1.0;"),n.ambient?f.push("vec3 ambientColor = materialAmbient;"):f.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);");n.diffuse?f.push("vec3 diffuseColor = materialDiffuse;"):n.baseColor?f.push("vec3 diffuseColor = materialBaseColor;"):f.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);");s.colors&&f.push("diffuseColor *= vColor.rgb;");n.emissive?f.push("vec3 emissiveColor = materialEmissive;"):f.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);");n.specular?f.push("vec3 specular = materialSpecular;"):f.push("vec3 specular = vec3(1.0, 1.0, 1.0);");void 0!==n.alpha?f.push("float alpha = materialAlphaModeCutoff[0];"):f.push("float alpha = 1.0;");s.colors&&f.push("alpha *= vColor.a;");void 0!==n.glossiness?f.push("float glossiness = materialGlossiness;"):f.push("float glossiness = 1.0;");void 0!==n.metallic?f.push("float metallic = materialMetallic;"):f.push("float metallic = 1.0;");void 0!==n.roughness?f.push("float roughness = materialRoughness;"):f.push("float roughness = 1.0;");void 0!==n.specularF0?f.push("float specularF0 = materialSpecularF0;"):f.push("float specularF0 = 1.0;");A&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._occlusionMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._alphaMap)&&(f.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),f.push("vec2 textureCoord;"));A&&i._ambientMap&&(i._ambientMap._state.matrix?f.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 ambientTexel = texture(ambientMap, textureCoord).rgb;"),f.push("ambientTexel = "+gi[i._ambientMap._state.encoding]+"(ambientTexel);"),f.push("ambientColor *= ambientTexel.rgb;"));A&&i._diffuseMap&&(i._diffuseMap._state.matrix?f.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 diffuseTexel = texture(diffuseMap, textureCoord);"),f.push("diffuseTexel = "+gi[i._diffuseMap._state.encoding]+"(diffuseTexel);"),f.push("diffuseColor *= diffuseTexel.rgb;"),f.push("alpha *= diffuseTexel.a;"));A&&i._baseColorMap&&(i._baseColorMap._state.matrix?f.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 baseColorTexel = texture(baseColorMap, textureCoord);"),f.push("baseColorTexel = "+gi[i._baseColorMap._state.encoding]+"(baseColorTexel);"),f.push("diffuseColor *= baseColorTexel.rgb;"),f.push("alpha *= baseColorTexel.a;"));A&&i._emissiveMap&&(i._emissiveMap._state.matrix?f.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 emissiveTexel = texture(emissiveMap, textureCoord);"),f.push("emissiveTexel = "+gi[i._emissiveMap._state.encoding]+"(emissiveTexel);"),f.push("emissiveColor = emissiveTexel.rgb;"));A&&i._alphaMap&&(i._alphaMap._state.matrix?f.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("alpha *= texture(alphaMap, textureCoord).r;"));A&&i._occlusionMap&&(i._occlusionMap._state.matrix?f.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("occlusion *= texture(occlusionMap, textureCoord).r;"));if(l&&(o.lights.length>0||o.lightMaps.length>0||o.reflectionMaps.length>0)){A&&i._normalMap?(i._normalMap._state.matrix?f.push("textureCoord = (normalMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):f.push("vec3 viewNormal = normalize(vViewNormal);"),A&&i._specularMap&&(i._specularMap._state.matrix?f.push("textureCoord = (specularMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("specular *= texture(specularMap, textureCoord).rgb;")),A&&i._glossinessMap&&(i._glossinessMap._state.matrix?f.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("glossiness *= texture(glossinessMap, textureCoord).r;")),A&&i._specularGlossinessMap&&(i._specularGlossinessMap._state.matrix?f.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 specGlossRGB = texture(materialSpecularGlossinessMap, textureCoord).rgba;"),f.push("specular *= specGlossRGB.rgb;"),f.push("glossiness *= specGlossRGB.a;")),A&&i._metallicMap&&(i._metallicMap._state.matrix?f.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("metallic *= texture(metallicMap, textureCoord).r;")),A&&i._roughnessMap&&(i._roughnessMap._state.matrix?f.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("roughness *= texture(roughnessMap, textureCoord).r;")),A&&i._metallicRoughnessMap&&(i._metallicRoughnessMap._state.matrix?f.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec3 metalRoughRGB = texture(metallicRoughnessMap, textureCoord).rgb;"),f.push("metallic *= metalRoughRGB.b;"),f.push("roughness *= metalRoughRGB.g;")),f.push("vec3 viewEyeDir = normalize(-vViewPosition);"),i._diffuseFresnel&&(f.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),f.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),i._specularFresnel&&(f.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),f.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),i._alphaFresnel&&(f.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),f.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),i._emissiveFresnel&&(f.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),f.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),f.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),f.push("   discard;"),f.push("}"),f.push("IncidentLight  light;"),f.push("Material       material;"),f.push("Geometry       geometry;"),f.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),f.push("vec3           viewLightDir;"),c&&(f.push("material.diffuseColor      = diffuseColor;"),f.push("material.specularColor     = specular;"),f.push("material.shine             = materialShininess;")),u&&(f.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),f.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),f.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),f.push("material.specularColor     = specular;")),h&&(f.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),f.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),f.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),f.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),f.push("geometry.position      = vViewPosition;"),o.lightMaps.length>0&&f.push("geometry.worldNormal   = normalize(vWorldNormal);"),f.push("geometry.viewNormal    = viewNormal;"),f.push("geometry.viewEyeDir    = viewEyeDir;"),c&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&f.push("computePhongLightMapping(geometry, material, reflectedLight);"),(u||h)&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&f.push("computePBRLightMapping(geometry, material, reflectedLight);"),f.push("float shadow = 1.0;"),f.push("float shadowAcneRemover = 0.007;"),f.push("vec3 fragmentDepth;"),f.push("float texelSize = 1.0 / 1024.0;"),f.push("float amountInLight = 0.0;"),f.push("vec3 shadowCoord;"),f.push("vec4 rgbaDepth;"),f.push("float depth;");for(let e=0,t=o.lights.length;e<t;e++){const t=o.lights[e];"ambient"!==t.type&&("dir"===t.type&&"view"===t.space?f.push("viewLightDir = -normalize(lightDir"+e+");"):"point"===t.type&&"view"===t.space?f.push("viewLightDir = normalize(lightPos"+e+" - vViewPosition);"):f.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+e+".xyz);"),d&&t.castsShadow?(f.push("shadow = 0.0;"),f.push("fragmentDepth = vShadowPosFromLight"+e+".xyz;"),f.push("fragmentDepth.z -= shadowAcneRemover;"),f.push("for (int x = -3; x <= 3; x++) {"),f.push("  for (int y = -3; y <= 3; y++) {"),f.push("      float texelDepth = unpackDepth(texture(shadowMap"+e+", fragmentDepth.xy + vec2(x, y) * texelSize));"),f.push("      if (fragmentDepth.z < texelDepth) {"),f.push("          shadow += 1.0;"),f.push("      }"),f.push("  }"),f.push("}"),f.push("shadow = shadow / 9.0;"),f.push("light.color =  lightColor"+e+".rgb * (lightColor"+e+".a * shadow);")):f.push("light.color =  lightColor"+e+".rgb * (lightColor"+e+".a );"),f.push("light.direction = viewLightDir;"),c&&f.push("computePhongLighting(light, geometry, material, reflectedLight);"),(u||h)&&f.push("computePBRLighting(light, geometry, material, reflectedLight);"))}c?f.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * diffuseColor) + ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;"):f.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;")}else f.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),f.push("vec3 outgoingLight = emissiveColor + ambientColor;");f.push("vec4 fragColor = vec4(outgoingLight, alpha) * colorize;"),p&&f.push("fragColor = linearToGamma(fragColor, gammaFactor);");f.push("outColor = fragColor;"),t.logarithmicDepthBufferEnabled&&f.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return f.push("}"),f}(e))},gi={};function _i(e){if(!e.receivesShadow)return!1;const t=e.scene._lightsState.lights;if(!t||0===t.length)return!1;for(let e=0,i=t.length;e<i;e++)if(t[e].castsShadow)return!0;return!1}function vi(e){const t=e._geometry._state.primitiveName;return!(!e._geometry._state.autoVertexNormals&&!e._geometry._state.normalsBuf||"triangles"!==t&&"triangle-strip"!==t&&"triangle-fan"!==t)}gi[3e3]="linearToLinear",gi[3001]="sRGBToLinear";class bi{constructor(e,t,i){if(this.allocated=!1,this.compiled=!1,this.handle=e.createShader(t),this.handle){if(this.allocated=!0,e.shaderSource(this.handle,i),e.compileShader(this.handle),this.compiled=e.getShaderParameter(this.handle,e.COMPILE_STATUS),!this.compiled&&!e.isContextLost()){const t=i.split("\n"),s=[];for(let e=0;e<t.length;e++)s.push(e+1+": "+t[e]+"\n");this.errors=[],this.errors.push(""),this.errors.push(e.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(s.join(""))}}else this.errors=["Failed to allocate"]}destroy(){}}class yi{constructor(e,t){this.bindTexture=function(i,s){return!!i.bind(s)&&(e.uniform1i(t,s),!0)}}}class wi{constructor(e,t){this._gl=e,this.location=t}bindArrayBuffer(e){e&&(e.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,e.itemSize,e.itemType,e.normalized,e.stride,e.offset))}}const Bi=new e({});function Pi(e){const t=[];let i,s;for(let r=0,o=e.length;r<o;r++)i=e[r],s=i.indexOf("/"),s>0&&"/"===i.charAt(s+1)&&(i=i.substring(0,s)),t.push(i);return t.join("\n")}function xi(e){console.error(e.join("\n"))}class Ci{constructor(e,t){this.id=Bi.addItem({}),this.source=t,this.init(e)}init(e){if(this.gl=e,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new bi(e,e.VERTEX_SHADER,Pi(this.source.vertex)),this._fragmentShader=new bi(e,e.FRAGMENT_SHADER,Pi(this.source.fragment)),!this._vertexShader.allocated)return this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors),void xi(this.errors);if(!this._fragmentShader.allocated)return this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors),void xi(this.errors);if(this.allocated=!0,!this._vertexShader.compiled)return this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors),void xi(this.errors);if(!this._fragmentShader.compiled)return this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors),void xi(this.errors);let t,i,s,r,o;if(this.compiled=!0,this.handle=e.createProgram(),!this.handle)return void(this.errors=["Failed to allocate program"]);if(e.attachShader(this.handle,this._vertexShader.handle),e.attachShader(this.handle,this._fragmentShader.handle),e.linkProgram(this.handle),this.linked=e.getProgramParameter(this.handle,e.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(e.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(this.source.vertex),this.errors.push("\nFragment shader:\n"),this.errors=this.errors.concat(this.source.fragment),void xi(this.errors);const n=e.getProgramParameter(this.handle,e.ACTIVE_UNIFORMS);for(i=0;i<n;++i)s=e.getActiveUniform(this.handle,i),s&&(r=s.name,"\0"===r[r.length-1]&&(r=r.substr(0,r.length-1)),o=e.getUniformLocation(this.handle,r),s.type===e.SAMPLER_2D||s.type===e.SAMPLER_CUBE||35682===s.type||e instanceof WebGL2RenderingContext&&(s.type===e.UNSIGNED_INT_SAMPLER_2D||s.type===e.INT_SAMPLER_2D)?this.samplers[r]=new yi(e,o):this.uniforms[r]=o);const a=e.getProgramParameter(this.handle,e.ACTIVE_ATTRIBUTES);for(i=0;i<a;i++)t=e.getActiveAttrib(this.handle,i),t&&(o=e.getAttribLocation(this.handle,t.name),this.attributes[t.name]=new wi(e,o));this.allocated=!0}bind(){this.allocated&&this.gl.useProgram(this.handle)}getLocation(e){if(this.allocated)return this.uniforms[e]}getAttribute(e){if(this.allocated)return this.attributes[e]}bindTexture(e,t,i){if(!this.allocated)return!1;const s=this.samplers[e];return!!s&&s.bindTexture(t,i)}destroy(){this.allocated&&(Bi.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}const Mi={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},Ei=document.createElement("canvas");if(Ei){const e=Ei.getContext("webgl",{antialias:!0})||Ei.getContext("experimental-webgl",{antialias:!0});Mi.WEBGL=!!e,Mi.WEBGL&&(Mi.ANTIALIAS=e.getContextAttributes().antialias,e.getShaderPrecisionFormat?e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0?Mi.FS_MAX_FLOAT_PRECISION="highp":e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?Mi.FS_MAX_FLOAT_PRECISION="mediump":Mi.FS_MAX_FLOAT_PRECISION="lowp":Mi.FS_MAX_FLOAT_PRECISION="mediump",Mi.DEPTH_BUFFER_BITS=e.getParameter(e.DEPTH_BITS),Mi.MAX_TEXTURE_SIZE=e.getParameter(e.MAX_TEXTURE_SIZE),Mi.MAX_CUBE_MAP_SIZE=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),Mi.MAX_RENDERBUFFER_SIZE=e.getParameter(e.MAX_RENDERBUFFER_SIZE),Mi.MAX_TEXTURE_UNITS=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS),Mi.MAX_TEXTURE_IMAGE_UNITS=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),Mi.MAX_VERTEX_ATTRIBS=e.getParameter(e.MAX_VERTEX_ATTRIBS),Mi.MAX_VERTEX_UNIFORM_VECTORS=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),Mi.MAX_FRAGMENT_UNIFORM_VECTORS=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),Mi.MAX_VARYING_VECTORS=e.getParameter(e.MAX_VARYING_VECTORS),e.getSupportedExtensions().forEach((function(e){Mi.SUPPORTED_EXTENSIONS[e]=!0})))}const Fi=d.vec3(),Ii=new e({}),Ti=function(e,t){this.id=Ii.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new mi(t),this._allocate(t)},Di={};Ti.get=function(e){const t=e.scene,i=[t.canvas.canvas.id,(t.gammaInput?"gi;":";")+(t.gammaOutput?"go":""),t._lightsState.getHash(),t._sectionPlanesState.getHash(),e._geometry._state.hash,e._material._state.hash,e._state.drawHash].join(";");let s=Di[i];if(!s){if(s=new Ti(i,e),s.errors)return console.log(s.errors.join("\n")),null;Di[i]=s,g.memory.programs++}return s._useCount++,s},Ti.prototype.put=function(){0==--this._useCount&&(Ii.removeItem(this.id),this._program&&this._program.destroy(),delete Di[this._hash],g.memory.programs--)},Ti.prototype.webglContextRestored=function(){this._program=null},Ti.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=Mi.MAX_TEXTURE_UNITS,s=t.scene,r=t._material,o=s.canvas.gl,n=this._program,a=t._state,l=t._material._state,A=t._geometry._state,c=s.camera,h=t.origin,u=a.background;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,u&&o.depthFunc(o.LEQUAL),this._bindProgram(e)),o.uniformMatrix4fv(this._uViewMatrix,!1,h?e.getRTCViewMatrix(a.originHash,h):c.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,c.viewNormalMatrix),a.clippable){const e=s._sectionPlanesState.getNumAllocatedSectionPlanes(),i=s._sectionPlanesState.sectionPlanes.length;if(e>0){const r=s._sectionPlanesState.sectionPlanes,n=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e)if(t<i){const i=n.sectionPlanesActivePerLayer[t];if(o.uniform1i(e.active,i?1:0),i){const i=r[t];if(h){const t=tt(i.dist,i.dir,h,Fi);o.uniform3fv(e.pos,t)}else o.uniform3fv(e.pos,i.pos);o.uniform3fv(e.dir,i.dir)}}else o.uniform1i(e.active,0)}}}if(l.id!==this._lastMaterialId){e.textureUnit=this._baseTextureUnit;const t=l.backfaces;e.backfaces!==t&&(t?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),e.backfaces=t);const s=l.frontface;switch(e.frontface!==s&&(s?o.frontFace(o.CCW):o.frontFace(o.CW),e.frontface=s),e.lineWidth!==l.lineWidth&&(o.lineWidth(l.lineWidth),e.lineWidth=l.lineWidth),this._uPointSize&&o.uniform1f(this._uPointSize,l.pointSize),l.type){case"LambertMaterial":this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialColor&&o.uniform4f(this._uMaterialColor,l.color[0],l.color[1],l.color[2],l.alpha),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive);break;case"PhongMaterial":this._uMaterialShininess&&o.uniform1f(this._uMaterialShininess,l.shininess),this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0),r._ambientMap&&r._ambientMap._state.texture&&this._uMaterialAmbientMap&&(n.bindTexture(this._uMaterialAmbientMap,r._ambientMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMaterialAmbientMapMatrix&&o.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,r._ambientMap._state.matrix)),r._diffuseMap&&r._diffuseMap._state.texture&&this._uDiffuseMap&&(n.bindTexture(this._uDiffuseMap,r._diffuseMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,r._diffuseMap._state.matrix)),r._specularMap&&r._specularMap._state.texture&&this._uSpecularMap&&(n.bindTexture(this._uSpecularMap,r._specularMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,r._specularMap._state.matrix)),r._emissiveMap&&r._emissiveMap._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,r._emissiveMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,r._emissiveMap._state.matrix)),r._alphaMap&&r._alphaMap._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,r._alphaMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,r._alphaMap._state.matrix)),r._reflectivityMap&&r._reflectivityMap._state.texture&&this._uReflectivityMap&&(n.bindTexture(this._uReflectivityMap,r._reflectivityMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,this._uReflectivityMapMatrix&&o.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,r._reflectivityMap._state.matrix)),r._normalMap&&r._normalMap._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,r._normalMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,r._normalMap._state.matrix)),r._occlusionMap&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,r._occlusionMap._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,r._occlusionMap._state.matrix)),r._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&o.uniform1f(this._uDiffuseFresnelEdgeBias,r._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&o.uniform1f(this._uDiffuseFresnelCenterBias,r._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&o.uniform3fv(this._uDiffuseFresnelEdgeColor,r._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&o.uniform3fv(this._uDiffuseFresnelCenterColor,r._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&o.uniform1f(this._uDiffuseFresnelPower,r._diffuseFresnel.power)),r._specularFresnel&&(this._uSpecularFresnelEdgeBias&&o.uniform1f(this._uSpecularFresnelEdgeBias,r._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&o.uniform1f(this._uSpecularFresnelCenterBias,r._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&o.uniform3fv(this._uSpecularFresnelEdgeColor,r._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&o.uniform3fv(this._uSpecularFresnelCenterColor,r._specularFresnel.centerColor),this._uSpecularFresnelPower&&o.uniform1f(this._uSpecularFresnelPower,r._specularFresnel.power)),r._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&o.uniform1f(this._uAlphaFresnelEdgeBias,r._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&o.uniform1f(this._uAlphaFresnelCenterBias,r._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&o.uniform3fv(this._uAlphaFresnelEdgeColor,r._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&o.uniform3fv(this._uAlphaFresnelCenterColor,r._alphaFresnel.centerColor),this._uAlphaFresnelPower&&o.uniform1f(this._uAlphaFresnelPower,r._alphaFresnel.power)),r._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&o.uniform1f(this._uReflectivityFresnelEdgeBias,r._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&o.uniform1f(this._uReflectivityFresnelCenterBias,r._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&o.uniform3fv(this._uReflectivityFresnelEdgeColor,r._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&o.uniform3fv(this._uReflectivityFresnelCenterColor,r._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&o.uniform1f(this._uReflectivityFresnelPower,r._reflectivityFresnel.power)),r._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&o.uniform1f(this._uEmissiveFresnelEdgeBias,r._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&o.uniform1f(this._uEmissiveFresnelCenterBias,r._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&o.uniform3fv(this._uEmissiveFresnelEdgeColor,r._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&o.uniform3fv(this._uEmissiveFresnelCenterColor,r._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&o.uniform1f(this._uEmissiveFresnelPower,r._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&o.uniform3fv(this._uBaseColor,l.baseColor),this._uMaterialMetallic&&o.uniform1f(this._uMaterialMetallic,l.metallic),this._uMaterialRoughness&&o.uniform1f(this._uMaterialRoughness,l.roughness),this._uMaterialSpecularF0&&o.uniform1f(this._uMaterialSpecularF0,l.specularF0),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);const t=r._baseColorMap;t&&t._state.texture&&this._uBaseColorMap&&(n.bindTexture(this._uBaseColorMap,t._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uBaseColorMapMatrix&&o.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,t._state.matrix));const s=r._metallicMap;s&&s._state.texture&&this._uMetallicMap&&(n.bindTexture(this._uMetallicMap,s._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicMapMatrix&&o.uniformMatrix4fv(this._uMetallicMapMatrix,!1,s._state.matrix));const a=r._roughnessMap;a&&a._state.texture&&this._uRoughnessMap&&(n.bindTexture(this._uRoughnessMap,a._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uRoughnessMapMatrix&&o.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,a._state.matrix));const A=r._metallicRoughnessMap;A&&A._state.texture&&this._uMetallicRoughnessMap&&(n.bindTexture(this._uMetallicRoughnessMap,A._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uMetallicRoughnessMapMatrix&&o.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,A._state.matrix)),(d=r._emissiveMap)&&d._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,d._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,d._state.matrix)),(p=r._occlusionMap)&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,p._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,p._state.matrix)),(f=r._alphaMap)&&f._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,f._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,f._state.matrix)),(m=r._normalMap)&&m._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,m._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,m._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialGlossiness&&o.uniform1f(this._uMaterialGlossiness,l.glossiness),this._uMaterialReflectivity&&o.uniform1f(this._uMaterialReflectivity,l.reflectivity),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);const c=r._diffuseMap;c&&c._state.texture&&this._uDiffuseMap&&(n.bindTexture(this._uDiffuseMap,c._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,c._state.matrix));const h=r._specularMap;h&&h._state.texture&&this._uSpecularMap&&(n.bindTexture(this._uSpecularMap,h._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,h._state.matrix));const u=r._glossinessMap;u&&u._state.texture&&this._uGlossinessMap&&(n.bindTexture(this._uGlossinessMap,u._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uGlossinessMapMatrix&&o.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,u._state.matrix));const g=r._specularGlossinessMap;var d,p,f,m;g&&g._state.texture&&this._uSpecularGlossinessMap&&(n.bindTexture(this._uSpecularGlossinessMap,g._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uSpecularGlossinessMapMatrix&&o.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,g._state.matrix)),(d=r._emissiveMap)&&d._state.texture&&this._uEmissiveMap&&(n.bindTexture(this._uEmissiveMap,d._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,d._state.matrix)),(p=r._occlusionMap)&&p._state.texture&&this._uOcclusionMap&&(n.bindTexture(this._uOcclusionMap,p._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,p._state.matrix)),(f=r._alphaMap)&&f._state.texture&&this._uAlphaMap&&(n.bindTexture(this._uAlphaMap,f._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,f._state.matrix)),(m=r._normalMap)&&m._state.texture&&this._uNormalMap&&(n.bindTexture(this._uNormalMap,m._state.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%i,e.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,m._state.matrix))}this._lastMaterialId=l.id}if(o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,t.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,t.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),this._uColorize){const e=a.colorize,t=this._lastColorize;t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]||(o.uniform4fv(this._uColorize,e),t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3])}o.uniform3fv(this._uOffset,a.offset),o.uniform3fv(this._uScale,t.scale),A.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,A.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,A.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(A.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(A.normalsBuf),e.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(A.uvBuf),e.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(A.colorsBuf),e.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(A.flagsBuf),e.bindArray++),A.indicesBuf&&(A.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=A.id),A.indicesBuf?(o.drawElements(A.primitive,A.indicesBuf.numItems,A.indicesBuf.itemType,0),e.drawElements++):A.positions&&(o.drawArrays(o.TRIANGLES,0,A.positions.numItems),e.drawArrays++),u&&o.depthFunc(o.LESS)},Ti.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl,s=e._material,r=t._lightsState,o=t._sectionPlanesState,n=e._material._state;if(this._program=new Ci(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const a=this._program;this._uPositionsDecodeMatrix=a.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=a.getLocation("uvDecodeMatrix"),this._uModelMatrix=a.getLocation("modelMatrix"),this._uModelNormalMatrix=a.getLocation("modelNormalMatrix"),this._uViewMatrix=a.getLocation("viewMatrix"),this._uViewNormalMatrix=a.getLocation("viewNormalMatrix"),this._uProjMatrix=a.getLocation("projMatrix"),this._uGammaFactor=a.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[],t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=a.getLocation("logDepthBufFC"));const l=r.lights;let A;for(var c=0,h=l.length;c<h;c++){switch(A=l[c],A.type){case"ambient":this._uLightAmbient[c]=a.getLocation("lightAmbient");break;case"dir":this._uLightColor[c]=a.getLocation("lightColor"+c),this._uLightPos[c]=null,this._uLightDir[c]=a.getLocation("lightDir"+c);break;case"point":this._uLightColor[c]=a.getLocation("lightColor"+c),this._uLightPos[c]=a.getLocation("lightPos"+c),this._uLightDir[c]=null,this._uLightAttenuation[c]=a.getLocation("lightAttenuation"+c);break;case"spot":this._uLightColor[c]=a.getLocation("lightColor"+c),this._uLightPos[c]=a.getLocation("lightPos"+c),this._uLightDir[c]=a.getLocation("lightDir"+c),this._uLightAttenuation[c]=a.getLocation("lightAttenuation"+c)}A.castsShadow&&(this._uShadowViewMatrix[c]=a.getLocation("shadowViewMatrix"+c),this._uShadowProjMatrix[c]=a.getLocation("shadowProjMatrix"+c))}r.lightMaps.length>0&&(this._uLightMap="lightMap"),r.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];for(c=0,h=o.sectionPlanes.length;c<h;c++)this._uSectionPlanes.push({active:a.getLocation("sectionPlaneActive"+c),pos:a.getLocation("sectionPlanePos"+c),dir:a.getLocation("sectionPlaneDir"+c)});switch(this._uPointSize=a.getLocation("pointSize"),n.type){case"LambertMaterial":this._uMaterialColor=a.getLocation("materialColor"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=a.getLocation("materialAmbient"),this._uMaterialDiffuse=a.getLocation("materialDiffuse"),this._uMaterialSpecular=a.getLocation("materialSpecular"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=a.getLocation("materialShininess"),s._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=a.getLocation("ambientMapMatrix")),s._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=a.getLocation("diffuseMapMatrix")),s._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=a.getLocation("specularMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),s._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=a.getLocation("reflectivityMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),s._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=a.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=a.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=a.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=a.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=a.getLocation("diffuseFresnelPower")),s._specularFresnel&&(this._uSpecularFresnelEdgeBias=a.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=a.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=a.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=a.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=a.getLocation("specularFresnelPower")),s._alphaFresnel&&(this._uAlphaFresnelEdgeBias=a.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=a.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=a.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=a.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=a.getLocation("alphaFresnelPower")),s._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=a.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=a.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=a.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=a.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=a.getLocation("reflectivityFresnelPower")),s._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=a.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=a.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=a.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=a.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=a.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=a.getLocation("materialBaseColor"),this._uMaterialMetallic=a.getLocation("materialMetallic"),this._uMaterialRoughness=a.getLocation("materialRoughness"),this._uMaterialSpecularF0=a.getLocation("materialSpecularF0"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),s._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=a.getLocation("baseColorMapMatrix")),s._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=a.getLocation("metallicMapMatrix")),s._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=a.getLocation("roughnessMapMatrix")),s._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=a.getLocation("metallicRoughnessMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=a.getLocation("materialDiffuse"),this._uMaterialSpecular=a.getLocation("materialSpecular"),this._uMaterialGlossiness=a.getLocation("materialGlossiness"),this._uMaterialReflectivity=a.getLocation("reflectivityFresnel"),this._uMaterialEmissive=a.getLocation("materialEmissive"),this._uAlphaModeCutoff=a.getLocation("materialAlphaModeCutoff"),s._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=a.getLocation("diffuseMapMatrix")),s._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=a.getLocation("specularMapMatrix")),s._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=a.getLocation("glossinessMapMatrix")),s._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=a.getLocation("materialSpecularGlossinessMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=a.getLocation("emissiveMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=a.getLocation("occlusionMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=a.getLocation("alphaMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=a.getLocation("normalMapMatrix"))}this._aPosition=a.getAttribute("position"),this._aNormal=a.getAttribute("normal"),this._aUV=a.getAttribute("uv"),this._aColor=a.getAttribute("color"),this._aFlags=a.getAttribute("flags"),this._uClippable=a.getLocation("clippable"),this._uColorize=a.getLocation("colorize"),this._uOffset=a.getLocation("offset"),this._uScale=a.getLocation("scale"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0},Ti.prototype._bindProgram=function(e){const t=Mi.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,r=i._lightsState,o=i.camera.project;let n;const a=this._program;if(a.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,s.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),i.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}for(var l=0,A=r.lights.length;l<A;l++)if(n=r.lights[l],this._uLightAmbient[l])s.uniform4f(this._uLightAmbient[l],n.color[0],n.color[1],n.color[2],n.intensity);else if(this._uLightColor[l]&&s.uniform4f(this._uLightColor[l],n.color[0],n.color[1],n.color[2],n.intensity),this._uLightPos[l]&&(s.uniform3fv(this._uLightPos[l],n.pos),this._uLightAttenuation[l]&&s.uniform1f(this._uLightAttenuation[l],n.attenuation)),this._uLightDir[l]&&s.uniform3fv(this._uLightDir[l],n.dir),n.castsShadow){this._uShadowViewMatrix[l]&&s.uniformMatrix4fv(this._uShadowViewMatrix[l],!1,n.getShadowViewMatrix()),this._uShadowProjMatrix[l]&&s.uniformMatrix4fv(this._uShadowProjMatrix[l],!1,n.getShadowProjMatrix());const i=n.getShadowRenderBuf();i&&(a.bindTexture("shadowMap"+l,i.getTexture(),e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++)}r.lightMaps.length>0&&r.lightMaps[0].texture&&this._uLightMap&&(a.bindTexture(this._uLightMap,r.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),r.reflectionMaps.length>0&&r.reflectionMaps[0].texture&&this._uReflectionMap&&(a.bindTexture(this._uReflectionMap,r.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%t,e.bindTexture++),this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor),this._baseTextureUnit=e.textureUnit};class Si{constructor(e){this.vertex=function(e){const t=e.scene,i=t._lightsState,s=function(e){const t=e._geometry._state.primitiveName;if((e._geometry._state.autoVertexNormals||e._geometry._state.normalsBuf)&&("triangles"===t||"triangle-strip"===t||"triangle-fan"===t))return!0;return!1}(e),r=t._sectionPlanesState.getNumAllocatedSectionPlanes()>0,o=!!e._geometry._state.compressGeometry,n=e._state.billboard,a=e._state.stationary,l=[];l.push("#version 300 es"),l.push("// EmphasisFillShaderSource vertex shader"),l.push("in vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec3 offset;"),l.push("uniform vec3 scale;"),o&&l.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),l.push("out float vFragDepth;"),l.push("bool isPerspectiveMatrix(mat4 m) {"),l.push("    return (m[2][3] == - 1.0);"),l.push("}"),l.push("out float isPerspective;"));r&&l.push("out vec4 vWorldPosition;");if(l.push("uniform vec4   lightAmbient;"),l.push("uniform vec4   fillColor;"),s){l.push("in vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];"ambient"!==t.type&&(l.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&l.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&l.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&l.push("uniform vec3 lightPos"+e+";"))}o&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}l.push("out vec4 vColor;"),("spherical"===n||"cylindrical"===n)&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = scale[0];"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),"spherical"===n&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = scale[1];"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}"));l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),o&&l.push("localPosition = positionsDecodeMatrix * localPosition;");s&&(o?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),a&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===n||"cylindrical"===n?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),s&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));s&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),s)for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?l.push("viewLightDir = normalize(lightDir"+e+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+e+", 0.0)).xyz);");else{if("point"!==t.type)continue;"view"===t.space?l.push("viewLightDir = normalize(lightPos"+e+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+e+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}}l.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),r&&l.push("vWorldPosition = worldPosition;");"points"===e._geometry._state.primitiveName&&l.push("gl_PointSize = pointSize;");l.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(l.push("vFragDepth = 1.0 + clipPos.w;"),l.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return l.push("gl_Position = clipPos;"),l.push("}"),l}(e),this.fragment=function(e){const t=e.scene,i=e.scene._sectionPlanesState,s=e.scene.gammaOutput,r=i.getNumAllocatedSectionPlanes()>0,o=[];o.push("#version 300 es"),o.push("// Lambertian drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;"));s&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(r){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let e=0,t=i.getNumAllocatedSectionPlanes();e<t;e++)o.push("uniform bool sectionPlaneActive"+e+";"),o.push("uniform vec3 sectionPlanePos"+e+";"),o.push("uniform vec3 sectionPlaneDir"+e+";")}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let e=0,t=i.getNumAllocatedSectionPlanes();e<t;e++)o.push("if (sectionPlaneActive"+e+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}"points"===e._geometry._state.primitiveName&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}"));t.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");s?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;");return o.push("}"),o}(e)}}const Ri=new e({}),Ui=d.vec3(),Li=function(e,t){this.id=Ri.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new Si(t),this._allocate(t)},ki={};Li.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.normalsBuf?"n":"",e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let i=ki[t];return i||(i=new Li(t,e),ki[t]=i,g.memory.programs++),i._useCount++,i},Li.prototype.put=function(){0==--this._useCount&&(Ri.removeItem(this.id),this._program&&this._program.destroy(),delete ki[this._hash],g.memory.programs--)},Li.prototype.webglContextRestored=function(){this._program=null},Li.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);const s=this._scene,r=s.camera,o=s.canvas.gl,n=0===i?t._xrayMaterial._state:1===i?t._highlightMaterial._state:t._selectedMaterial._state,a=t._state,l=t._geometry._state,A=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),o.uniformMatrix4fv(this._uViewMatrix,!1,A?e.getRTCViewMatrix(a.originHash,A):r.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.viewNormalMatrix),a.clippable){const e=s._sectionPlanesState.getNumAllocatedSectionPlanes(),i=s._sectionPlanesState.sectionPlanes.length;if(e>0){const r=s._sectionPlanesState.sectionPlanes,n=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e)if(t<i){const i=n.sectionPlanesActivePerLayer[t];if(o.uniform1i(e.active,i?1:0),i){const i=r[t];if(A){const t=tt(i.dist,i.dir,A,Ui);o.uniform3fv(e.pos,t)}else o.uniform3fv(e.pos,i.pos);o.uniform3fv(e.dir,i.dir)}}else o.uniform1i(e.active,0)}}}if(n.id!==this._lastMaterialId){const t=n.fillColor,i=n.backfaces;e.backfaces!==i&&(i?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),e.backfaces=i),o.uniform4f(this._uFillColor,t[0],t[1],t[2],n.fillAlpha),this._lastMaterialId=n.id}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,t.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,t.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),o.uniform3fv(this._uOffset,a.offset),l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf),e.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(l.normalsBuf),e.bindArray++),l.indicesBuf?(l.indicesBuf.bind(),e.bindArray++):l.positionsBuf,this._lastGeometryId=l.id),l.indicesBuf?(o.drawElements(l.primitive,l.indicesBuf.numItems,l.indicesBuf.itemType,0),e.drawElements++):l.positionsBuf&&(o.drawArrays(o.TRIANGLES,0,l.positionsBuf.numItems),e.drawArrays++)},Li.prototype._allocate=function(e){const t=e.scene,i=t._lightsState,s=t._sectionPlanesState,r=t.canvas.gl;if(this._program=new Ci(r,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const o=this._program;this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uModelMatrix=o.getLocation("modelMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(let e=0,t=i.lights.length;e<t;e++){switch(i.lights[e].type){case"ambient":this._uLightAmbient[e]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[e]=o.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=o.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=o.getLocation("lightColor"+e),this._uLightPos[e]=o.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=o.getLocation("lightAttenuation"+e)}}this._uSectionPlanes=[];for(let e=0,t=s.getNumAllocatedSectionPlanes();e<t;e++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+e),pos:o.getLocation("sectionPlanePos"+e),dir:o.getLocation("sectionPlaneDir"+e)});this._uFillColor=o.getLocation("fillColor"),this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._uClippable=o.getLocation("clippable"),this._uGammaFactor=o.getLocation("gammaFactor"),this._uOffset=o.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=o.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Li.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=t._lightsState,r=t.camera,o=r.project;if(this._program.bind(),e.useProgram++,e.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,i.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.normalMatrix),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];this._uLightAmbient[e]?i.uniform4f(this._uLightAmbient[e],t.color[0],t.color[1],t.color[2],t.intensity):(this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir))}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor)};class Oi{constructor(e){this.vertex=function(e){const t=e.scene,i=t._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!e._geometry._state.compressGeometry,r=e._state.billboard,o=e._state.stationary,n=[];n.push("#version 300 es"),n.push("// Edges drawing vertex shader"),n.push("in vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform vec4 edgeColor;"),n.push("uniform vec3 offset;"),n.push("uniform vec3 scale;"),s&&n.push("uniform mat4 positionsDecodeMatrix;");t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;"));i&&n.push("out vec4 vWorldPosition;");n.push("out vec4 vColor;"),("spherical"===r||"cylindrical"===r)&&(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = scale[0];"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),"spherical"===r&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = scale[1];"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}"));n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),n.push("vec4 worldPosition;"),s&&n.push("localPosition = positionsDecodeMatrix * localPosition;");n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),o&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"),n.push("billboard(modelViewMatrix);"),n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));n.push("vColor = edgeColor;"),i&&n.push("vWorldPosition = worldPosition;");n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return n.push("gl_Position = clipPos;"),n.push("}"),n}(e),this.fragment=function(e){const t=e.scene,i=e.scene._sectionPlanesState,s=e.scene.gammaOutput,r=i.getNumAllocatedSectionPlanes()>0,o=[];o.push("#version 300 es"),o.push("// Edges drawing fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;"));s&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(r){o.push("in vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let e=0,t=i.getNumAllocatedSectionPlanes();e<t;e++)o.push("uniform bool sectionPlaneActive"+e+";"),o.push("uniform vec3 sectionPlanePos"+e+";"),o.push("uniform vec3 sectionPlaneDir"+e+";")}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let e=0,t=i.getNumAllocatedSectionPlanes();e<t;e++)o.push("if (sectionPlaneActive"+e+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}t.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");s?o.push("outColor = linearToGamma(vColor, gammaFactor);"):o.push("outColor = vColor;");return o.push("}"),o}(e)}}const Ni=new e({}),Vi=d.vec3(),Qi=function(e,t){this.id=Ni.addItem({}),this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new Oi(t),this._allocate(t)},Hi={};Qi.get=function(e){const t=[e.scene.id,e.scene.gammaOutput?"go":"",e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let i=Hi[t];return i||(i=new Qi(t,e),Hi[t]=i,g.memory.programs++),i._useCount++,i},Qi.prototype.put=function(){0==--this._useCount&&(Ni.removeItem(this.id),this._program&&this._program.destroy(),delete Hi[this._hash],g.memory.programs--)},Qi.prototype.webglContextRestored=function(){this._program=null},Qi.prototype.drawMesh=function(e,t,i){this._program||this._allocate(t);const s=this._scene,r=s.camera,o=s.canvas.gl;let n;const a=t._state,l=t._geometry,A=l._state,c=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),o.uniformMatrix4fv(this._uViewMatrix,!1,c?e.getRTCViewMatrix(a.originHash,c):r.viewMatrix),a.clippable){const e=s._sectionPlanesState.getNumAllocatedSectionPlanes(),i=s._sectionPlanesState.sectionPlanes.length;if(e>0){const r=s._sectionPlanesState.sectionPlanes,n=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e)if(t<i){const i=n.sectionPlanesActivePerLayer[t];if(o.uniform1i(e.active,i?1:0),i){const i=r[t];if(c){const t=tt(i.dist,i.dir,c,Vi);o.uniform3fv(e.pos,t)}else o.uniform3fv(e.pos,i.pos);o.uniform3fv(e.dir,i.dir)}}else o.uniform1i(e.active,0)}}}switch(i){case 0:n=t._xrayMaterial._state;break;case 1:n=t._highlightMaterial._state;break;case 2:n=t._selectedMaterial._state;break;default:n=t._edgeMaterial._state}if(n.id!==this._lastMaterialId){const t=n.backfaces;if(e.backfaces!==t&&(t?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),e.backfaces=t),e.lineWidth!==n.edgeWidth&&(o.lineWidth(n.edgeWidth),e.lineWidth=n.edgeWidth),this._uEdgeColor){const e=n.edgeColor,t=n.edgeAlpha;o.uniform4f(this._uEdgeColor,e[0],e[1],e[2],t)}this._lastMaterialId=n.id}let h;o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,t.worldMatrix),this._uClippable&&o.uniform1i(this._uClippable,a.clippable),o.uniform3fv(this._uOffset,a.offset),A.primitive===o.TRIANGLES?h=l._getEdgeIndices():A.primitive===o.LINES&&(h=A.indicesBuf),h&&(A.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,A.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(A.positionsBuf,A.compressGeometry?o.UNSIGNED_SHORT:o.FLOAT),e.bindArray++),h.bind(),e.bindArray++,this._lastGeometryId=A.id),o.drawElements(o.LINES,h.numItems,h.itemType,0),e.drawElements++)},Qi.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl,s=t._sectionPlanesState;if(this._program=new Ci(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=s.getNumAllocatedSectionPlanes();e<t;e++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+e),pos:r.getLocation("sectionPlanePos"+e),dir:r.getLocation("sectionPlaneDir"+e)});this._uEdgeColor=r.getLocation("edgeColor"),this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uGammaFactor=r.getLocation("gammaFactor"),this._uOffset=r.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Qi.prototype._bindProgram=function(e){const t=this._program,i=this._scene,s=i.canvas.gl,r=i.camera.project;if(t.bind(),e.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),i.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)};class ji{constructor(e){this.vertex=function(e){const t=e.scene,i=t._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!e._geometry._state.compressGeometry,r=e._state.billboard,o=e._state.stationary,n=[];n.push("#version 300 es"),n.push("// Mesh picking vertex shader"),n.push("in vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("out vec4 vViewPosition;"),n.push("uniform vec3 offset;"),n.push("uniform vec3 scale;"),s&&n.push("uniform mat4 positionsDecodeMatrix;");i&&n.push("out vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;"));"spherical"!==r&&"cylindrical"!==r||(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = scale[0];"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),"spherical"===r&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = scale[1];"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}"));n.push("uniform vec2 pickClipPos;"),n.push("vec4 remapClipPos(vec4 clipPos) {"),n.push("    clipPos.xy /= clipPos.w;"),n.push("    clipPos.xy -= pickClipPos;"),n.push("    clipPos.xy *= clipPos.w;"),n.push("    return clipPos;"),n.push("}"),n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),s&&n.push("localPosition = positionsDecodeMatrix * localPosition;");n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),o&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==r&&"cylindrical"!==r||(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"));n.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),n.push("   worldPosition.xyz = worldPosition.xyz + offset;"),n.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&n.push("   vWorldPosition = worldPosition;");n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return n.push("gl_Position = remapClipPos(clipPos);"),n.push("}"),n}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,r=[];r.push("#version 300 es"),r.push("// Mesh picking fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;"));if(r.push("uniform vec4 pickColor;"),s){r.push("uniform bool clippable;"),r.push("in vec4 vWorldPosition;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";")}if(r.push("out vec4 outColor;"),r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<i.getNumAllocatedSectionPlanes();o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}t.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("   outColor = pickColor; "),r.push("}"),r}(e)}}const Gi=d.vec3(),zi=function(e,t){this._hash=e,this._shaderSource=new ji(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},Wi={};zi.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let i=Wi[t];if(!i){if(i=new zi(t,e),i.errors)return console.log(i.errors.join("\n")),null;Wi[t]=i,g.memory.programs++}return i._useCount++,i},zi.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Wi[this._hash],g.memory.programs--)},zi.prototype.webglContextRestored=function(){this._program=null},zi.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene,s=i.canvas.gl,r=t._state,o=t._material._state,n=t._geometry._state,a=t.origin;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.uniformMatrix4fv(this._uViewMatrix,!1,a?e.getRTCPickViewMatrix(r.originHash,a):e.pickViewMatrix),r.clippable){const e=i._sectionPlanesState.getNumAllocatedSectionPlanes(),r=i._sectionPlanesState.sectionPlanes.length;if(e>0){const o=i._sectionPlanesState.sectionPlanes,n=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e)if(t<r){const i=n.sectionPlanesActivePerLayer[t];if(s.uniform1i(e.active,i?1:0),i){const i=o[t];if(a){const t=tt(i.dist,i.dir,a,Gi);s.uniform3fv(e.pos,t)}else s.uniform3fv(e.pos,i.pos);s.uniform3fv(e.dir,i.dir)}}else s.uniform1i(e.active,0)}}}if(o.id!==this._lastMaterialId){const t=o.backfaces;e.backfaces!==t&&(t?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=t);const i=o.frontface;e.frontface!==i&&(i?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=i),this._lastMaterialId=o.id}s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),s.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),s.uniform3fv(this._uOffset,t._state.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),n.indicesBuf&&(n.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=n.id);var l=t._state.pickID;const A=l>>24&255,c=l>>16&255,h=l>>8&255,u=255&l;s.uniform4f(this._uPickColor,u/255,h/255,c/255,A/255),s.uniform2fv(this._uPickClipPos,e.pickClipPos),n.indicesBuf?(s.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),e.drawElements++):n.positions&&s.drawArrays(s.TRIANGLES,0,n.positions.numItems)},zi.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl;if(this._program=new Ci(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uPickColor=s.getLocation("pickColor"),this._uPickClipPos=s.getLocation("pickClipPos"),this._uOffset=s.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastGeometryId=null},zi.prototype._bindProgram=function(e){const t=this._scene,i=t.canvas.gl,s=t.camera.project;if(this._program.bind(),e.useProgram++,t.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}this._lastMaterialId=null,this._lastGeometryId=null};class Xi{constructor(e){this.vertex=function(e){const t=e.scene,i=t._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!e._geometry._state.compressGeometry,r=[];r.push("#version 300 es"),r.push("// Surface picking vertex shader"),r.push("in vec3 position;"),r.push("in vec4 color;"),r.push("uniform mat4 modelMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform vec3 offset;"),i&&(r.push("uniform bool clippable;"),r.push("out vec4 vWorldPosition;"));t.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),r.push("out float vFragDepth;"),r.push("bool isPerspectiveMatrix(mat4 m) {"),r.push("    return (m[2][3] == - 1.0);"),r.push("}"),r.push("out float isPerspective;"));r.push("uniform vec2 pickClipPos;"),r.push("vec4 remapClipPos(vec4 clipPos) {"),r.push("    clipPos.xy /= clipPos.w;"),r.push("    clipPos.xy -= pickClipPos;"),r.push("    clipPos.xy *= clipPos.w;"),r.push("    return clipPos;"),r.push("}"),r.push("out vec4 vColor;"),s&&r.push("uniform mat4 positionsDecodeMatrix;");r.push("void main(void) {"),r.push("vec4 localPosition = vec4(position, 1.0); "),s&&r.push("localPosition = positionsDecodeMatrix * localPosition;");r.push("   vec4 worldPosition = modelMatrix * localPosition; "),r.push("   worldPosition.xyz = worldPosition.xyz + offset;"),r.push("   vec4 viewPosition = viewMatrix * worldPosition;"),i&&r.push("   vWorldPosition = worldPosition;");r.push("   vColor = color;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(r.push("vFragDepth = 1.0 + clipPos.w;"),r.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return r.push("gl_Position = remapClipPos(clipPos);"),r.push("}"),r}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,r=[];r.push("#version 300 es"),r.push("// Surface picking fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),r.push("in vec4 vColor;"),t.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;"));if(s){r.push("uniform bool clippable;"),r.push("in vec4 vWorldPosition;");for(let e=0;e<i.getNumAllocatedSectionPlanes();e++)r.push("uniform bool sectionPlaneActive"+e+";"),r.push("uniform vec3 sectionPlanePos"+e+";"),r.push("uniform vec3 sectionPlaneDir"+e+";")}if(r.push("out vec4 outColor;"),r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(let e=0;e<i.getNumAllocatedSectionPlanes();e++)r.push("if (sectionPlaneActive"+e+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}t.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("   outColor = vColor;"),r.push("}"),r}(e)}}const Ki=d.vec3(),Zi=function(e,t){this._hash=e,this._scene=t.scene,this._useCount=0,this._shaderSource=new Xi(t),this._allocate(t)},Ji={};Zi.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.compressGeometry?"cp":"",e._state.hash].join(";");let i=Ji[t];if(!i){if(i=new Zi(t,e),i.errors)return console.log(i.errors.join("\n")),null;Ji[t]=i,g.memory.programs++}return i._useCount++,i},Zi.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Ji[this._hash],g.memory.programs--)},Zi.prototype.webglContextRestored=function(){this._program=null},Zi.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene,s=i.canvas.gl,r=t._state,o=t._material._state,n=t._geometry,a=t._geometry._state,l=t.origin,A=o.backfaces,c=o.frontface,h=i.camera.project,u=n._getPickTrianglePositions(),d=n._getPickTriangleColors();if(this._program.bind(),e.useProgram++,i.logarithmicDepthBufferEnabled){const e=2/(Math.log(h.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}if(s.uniformMatrix4fv(this._uViewMatrix,!1,l?e.getRTCPickViewMatrix(r.originHash,l):e.pickViewMatrix),r.clippable){const e=i._sectionPlanesState.getNumAllocatedSectionPlanes(),r=i._sectionPlanesState.sectionPlanes.length;if(e>0){const o=i._sectionPlanesState.sectionPlanes,n=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e)if(t<r){const i=n.sectionPlanesActivePerLayer[t];if(s.uniform1i(e.active,i?1:0),i){const i=o[t];if(l){const t=tt(i.dist,i.dir,l,Ki);s.uniform3fv(e.pos,t)}else s.uniform3fv(e.pos,i.pos);s.uniform3fv(e.dir,i.dir)}}else s.uniform1i(e.active,0)}}}s.uniformMatrix4fv(this._uProjMatrix,!1,e.pickProjMatrix),i.logarithmicDepthBufferEnabled&&s.uniform1f(this._uZFar,i.camera.project.far),e.backfaces!==A&&(A?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=A),e.frontface!==c&&(c?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=c),s.uniformMatrix4fv(this._uModelMatrix,!1,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),s.uniform3fv(this._uOffset,t._state.offset),this._uPositionsDecodeMatrix?(s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(u,a.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT)):this._aPosition.bindArrayBuffer(u),s.uniform2fv(this._uPickClipPos,e.pickClipPos),d.bind(),s.enableVertexAttribArray(this._aColor.location),s.vertexAttribPointer(this._aColor.location,d.itemSize,d.itemType,!0,0,0),s.drawArrays(a.primitive,0,u.numItems/3)},Zi.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl;if(this._program=new Ci(i,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._uPickClipPos=s.getLocation("pickClipPos"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))};class Yi{constructor(e){this.vertex=function(e){const t=e.scene,i=t._sectionPlanesState.getNumAllocatedSectionPlanes()>0,s=!!e._geometry._state.compressGeometry,r=e._state.billboard,o=e._state.stationary,n=[];n.push("#version 300 es"),n.push("// Mesh occlusion vertex shader"),n.push("in vec3 position;"),n.push("uniform mat4 modelMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform vec3 offset;"),n.push("uniform vec3 scale;"),s&&n.push("uniform mat4 positionsDecodeMatrix;");i&&n.push("out vec4 vWorldPosition;");t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),n.push("out float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("out float isPerspective;"));"spherical"!==r&&"cylindrical"!==r||(n.push("void billboard(inout mat4 mat) {"),n.push("   mat[0][0] = scale[0];"),n.push("   mat[0][1] = 0.0;"),n.push("   mat[0][2] = 0.0;"),"spherical"===r&&(n.push("   mat[1][0] = 0.0;"),n.push("   mat[1][1] = scale[1];"),n.push("   mat[1][2] = 0.0;")),n.push("   mat[2][0] = 0.0;"),n.push("   mat[2][1] = 0.0;"),n.push("   mat[2][2] =1.0;"),n.push("}"));n.push("void main(void) {"),n.push("vec4 localPosition = vec4(position, 1.0); "),n.push("vec4 worldPosition;"),s&&n.push("localPosition = positionsDecodeMatrix * localPosition;");n.push("mat4 viewMatrix2 = viewMatrix;"),n.push("mat4 modelMatrix2 = modelMatrix;"),o&&n.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(n.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),n.push("billboard(modelMatrix2);"),n.push("billboard(viewMatrix2);"),n.push("billboard(modelViewMatrix);"),n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(n.push("worldPosition = modelMatrix2 * localPosition;"),n.push("worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));i&&n.push("   vWorldPosition = worldPosition;");n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(n.push("vFragDepth = 1.0 + clipPos.w;"),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return n.push("gl_Position = clipPos;"),n.push("}"),n}(e),this.fragment=function(e){const t=e.scene,i=t._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,r=[];r.push("#version 300 es"),r.push("// Mesh occlusion fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;"));if(s){r.push("uniform bool clippable;"),r.push("in vec4 vWorldPosition;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";")}if(r.push("out vec4 outColor;"),r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<i.getNumAllocatedSectionPlanes();o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}r.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.logarithmicDepthBufferEnabled&&r.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("}"),r}(e)}}const qi=d.vec3(),$i=function(e,t){this._hash=e,this._shaderSource=new Yi(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},es={};$i.get=function(e){const t=[e.scene.canvas.canvas.id,e.scene._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.occlusionHash].join(";");let i=es[t];if(!i){if(i=new $i(t,e),i.errors)return console.log(i.errors.join("\n")),null;es[t]=i,g.memory.programs++}return i._useCount++,i},$i.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete es[this._hash],g.memory.programs--)},$i.prototype.webglContextRestored=function(){this._program=null},$i.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene,s=i.canvas.gl,r=t._material._state,o=t._state,n=t._geometry._state,a=t.origin;if(r.alpha<1)return;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),r.id!==this._lastMaterialId){const t=r.backfaces;e.backfaces!==t&&(t?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),e.backfaces=t);const i=r.frontface;e.frontface!==i&&(i?s.frontFace(s.CCW):s.frontFace(s.CW),e.frontface=i),this._lastMaterialId=r.id}const l=i.camera;if(s.uniformMatrix4fv(this._uViewMatrix,!1,a?e.getRTCViewMatrix(o.originHash,a):l.viewMatrix),o.clippable){const e=i._sectionPlanesState.getNumAllocatedSectionPlanes(),r=i._sectionPlanesState.sectionPlanes.length;if(e>0){const o=i._sectionPlanesState.sectionPlanes,n=t.renderFlags;for(let t=0;t<e;t++){const e=this._uSectionPlanes[t];if(e)if(t<r){const i=n.sectionPlanesActivePerLayer[t];if(s.uniform1i(e.active,i?1:0),i){const i=o[t];if(a){const t=tt(i.dist,i.dir,a,qi);s.uniform3fv(e.pos,t)}else s.uniform3fv(e.pos,i.pos);s.uniform3fv(e.dir,i.dir)}}else s.uniform1i(e.active,0)}}}s.uniformMatrix4fv(this._uProjMatrix,!1,l._project._state.matrix),s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,t.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,t._state.clippable),s.uniform3fv(this._uOffset,t._state.offset),n.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(n.positionsBuf,n.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),e.bindArray++),n.indicesBuf&&(n.indicesBuf.bind(),e.bindArray++),this._lastGeometryId=n.id),n.indicesBuf?(s.drawElements(n.primitive,n.indicesBuf.numItems,n.indicesBuf.itemType,0),e.drawElements++):n.positions&&s.drawArrays(s.TRIANGLES,0,n.positions.numItems)},$i.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl;if(this._program=new Ci(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},$i.prototype._bindProgram=function(e){const t=this._scene,i=t.camera.project,s=t.canvas.gl;if(this._program.bind(),e.useProgram++,s.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,e)}this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};class ts{constructor(e){this.vertex=function(e){const t=e.scene._sectionPlanesState.sectionPlanes.length>0,i=!!e._geometry._state.compressGeometry,s=[];s.push("// Mesh shadow vertex shader"),s.push("in vec3 position;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),s.push("uniform vec3 offset;"),i&&s.push("uniform mat4 positionsDecodeMatrix;");t&&s.push("out vec4 vWorldPosition;");s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),s.push("vec4 worldPosition;"),i&&s.push("localPosition = positionsDecodeMatrix * localPosition;");s.push("worldPosition = modelMatrix * localPosition;"),s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&s.push("vWorldPosition = worldPosition;");return s.push("   gl_Position = shadowProjMatrix * viewPosition;"),s.push("}"),s}(e),this.fragment=function(e){const t=e.scene;t.canvas.gl;const i=t._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("// Mesh shadow fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),s){r.push("uniform bool clippable;"),r.push("in vec4 vWorldPosition;");for(var o=0;o<i.getNumAllocatedSectionPlanes();o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";")}if(r.push("vec4 encodeFloat( const in float depth ) {"),r.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),r.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),r.push("  vec4 comp = fract(depth * bitShift);"),r.push("  comp -= comp.xxyz * bitMask;"),r.push("  return comp;"),r.push("}"),r.push("out vec4 outColor;"),r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<i.getNumAllocatedSectionPlanes();o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return r.push("outColor = encodeFloat(gl_FragCoord.z);"),r.push("}"),r}(e)}}const is=function(e,t){this._hash=e,this._shaderSource=new ts(t),this._scene=t.scene,this._useCount=0,this._allocate(t)},ss={};is.get=function(e){const t=e.scene,i=[t.canvas.canvas.id,t._sectionPlanesState.getHash(),e._geometry._state.hash,e._state.hash].join(";");let s=ss[i];if(!s){if(s=new is(i,e),s.errors)return console.log(s.errors.join("\n")),null;ss[i]=s,g.memory.programs++}return s._useCount++,s},is.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete ss[this._hash],g.memory.programs--)},is.prototype.webglContextRestored=function(){this._program=null},is.prototype.drawMesh=function(e,t){this._program||this._allocate(t);const i=this._scene.canvas.gl,s=t._material._state,r=t._geometry._state;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),s.id!==this._lastMaterialId){const t=s.backfaces;e.backfaces!==t&&(t?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),e.backfaces=t);const r=s.frontface;e.frontface!==r&&(r?i.frontFace(i.CCW):i.frontFace(i.CW),e.frontface=r),e.lineWidth!==s.lineWidth&&(i.lineWidth(s.lineWidth),e.lineWidth=s.lineWidth),this._uPointSize&&i.uniform1i(this._uPointSize,s.pointSize),this._lastMaterialId=s.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,t.worldMatrix),r.combineGeometry){const s=t.vertexBufs;s.id!==this._lastVertexBufsId&&(s.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(s.positionsBuf,s.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),this._lastVertexBufsId=s.id)}this._uClippable&&i.uniform1i(this._uClippable,t._state.clippable),i.uniform3fv(this._uOffset,t._state.offset),r.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,r.positionsDecodeMatrix),r.combineGeometry?r.indicesBufCombined&&(r.indicesBufCombined.bind(),e.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(r.positionsBuf,r.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),e.bindArray++),r.indicesBuf&&(r.indicesBuf.bind(),e.bindArray++)),this._lastGeometryId=r.id),r.combineGeometry?r.indicesBufCombined&&(i.drawElements(r.primitive,r.indicesBufCombined.numItems,r.indicesBufCombined.itemType,0),e.drawElements++):r.indicesBuf?(i.drawElements(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0),e.drawElements++):r.positions&&(i.drawArrays(i.TRIANGLES,0,r.positions.numItems),e.drawArrays++)},is.prototype._allocate=function(e){const t=e.scene,i=t.canvas.gl;if(this._program=new Ci(i,this._shaderSource),this._scene=t,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),this._uSectionPlanes={};for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},is.prototype._bindProgram=function(e){this._program||this._allocate(mesh);const t=this._scene,i=t.canvas.gl,s=t._sectionPlanesState;if(this._program.bind(),e.useProgram++,i.uniformMatrix4fv(this._uShadowViewMatrix,!1,e.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,e.shadowProjMatrix),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.getNumAllocatedSectionPlanes()>0){let e,t,r,o,n;for(let a=0,l=this._uSectionPlanes.length;a<l;a++)e=this._uSectionPlanes[a],t=e.active,r=s.sectionPlanes[a],t&&i.uniform1i(t,r.active),o=e.pos,o&&i.uniform3fv(e.pos,r.pos),n=e.dir,n&&i.uniform3fv(e.dir,r.dir)}};class rs{constructor(){this.visibleLayers=[],this.sectionPlanesActivePerLayer=[],this.reset()}reset(){this.culled=!1,this.sectioned=!1,this.numLayers=0,this.numVisibleLayers=0,this.colorOpaque=!1,this.colorTransparent=!1,this.edgesOpaque=!1,this.edgesTransparent=!1,this.xrayedSilhouetteOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedSilhouetteTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedSilhouetteOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedSilhouetteTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedSilhouetteOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedSilhouetteTransparent=!1,this.selectedEdgesTransparent=!1}}const os=d.OBB3(),ns=d.vec4(),as=d.vec4(),ls=d.vec4(),As=d.vec3([1,0,0]),cs=d.vec3([0,1,0]),hs=d.vec3([0,0,1]),us=d.vec3(3),ds=d.vec3(3),ps=d.identityMat4();class fs extends R{constructor(e,t={}){super(e,t),this.renderOrder=t.renderOrder||0,this.originalSystemId=t.originalSystemId||this.id,this.renderFlags=new rs,this._state=new ae({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,occluder:!1!==t.occluder,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!t.stationary,background:!!t.background,billboard:this._checkBillboard(t.billboard),layer:null,colorize:null,pickID:this.scene._renderer.getPickID(this),drawHash:"",pickHash:"",offset:d.vec3(),origin:null,originHash:null,isUI:t.isUI}),this._drawRenderer=null,this._shadowRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._occlusionRenderer=null,this._geometry=t.geometry?this._checkComponent2(["ReadableGeometry","VBOGeometry"],t.geometry):this.scene.geometry,this._material=t.material?this._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],t.material):this.scene.material,this._xrayMaterial=t.xrayMaterial?this._checkComponent("EmphasisMaterial",t.xrayMaterial):this.scene.xrayMaterial,this._highlightMaterial=t.highlightMaterial?this._checkComponent("EmphasisMaterial",t.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=t.selectedMaterial?this._checkComponent("EmphasisMaterial",t.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=t.edgeMaterial?this._checkComponent("EdgeMaterial",t.edgeMaterial):this.scene.edgeMaterial,this._parentNode=null,this._aabb=null,this._aabbDirty=!0,this._numTriangles=this._geometry?this._geometry.numTriangles:0,this.scene._aabbDirty=!0,this._scale=d.vec3(),this._quaternion=d.identityQuaternion(),this._rotation=d.vec3(),this._position=d.vec3(),this._worldMatrix=d.identityMat4(),this._worldNormalMatrix=d.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0;const i=t.origin||t.rtcCenter;if(i&&(this._state.origin=d.vec3(i),this._state.originHash=i.join()),t.matrix?this.matrix=t.matrix:(this.scale=t.scale,this.position=t.position,t.quaternion||(this.rotation=t.rotation)),this._isObject=t.isObject,this._isObject&&this.scene._registerObject(this),this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.layer=t.layer,this.colorize=t.colorize,this.opacity=t.opacity,this.offset=t.offset,t.parentId){const e=this.scene.components[t.parentId];e?e.isNode?e.addChild(this):this.error("Parent is not a Node: '"+t.parentId+"'"):this.error("Parent not found: '"+t.parentId+"'"),this._parentNode=e}else t.parent&&(t.parent.isNode||this.error("Parent is not a Node"),t.parent.addChild(this),this._parentNode=t.parent);this.compile()}get type(){return"Mesh"}get isMesh(){return!0}get parent(){return this._parentNode}get geometry(){return this._geometry}get material(){return this._material}get position(){return this._position}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set rotation(e){this._rotation.set(e||[0,0,0]),d.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),d.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=d.identityMat4()),d.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}set matrix(e){this.__localMatrix||(this.__localMatrix=d.identityMat4()),this.__localMatrix.set(e||ps),d.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get isUI(){return this._state.isUI}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}get origin(){return this._state.origin}set origin(e){e?(this._state.origin||(this._state.origin=d.vec3()),this._state.origin.set(e),this._state.originHash=e.join(),this._setAABBDirty(),this.scene._aabbDirty=!0):this._state.origin&&(this._state.origin=null,this._state.originHash=null,this._setAABBDirty(),this.scene._aabbDirty=!0)}get rtcCenter(){return this.origin}set rtcCenter(e){this.origin=e}get numTriangles(){return this._numTriangles}get visible(){return this._state.visible}set visible(e){e=!1!==e,this._state.visible=e,this._isObject&&this.scene._objectVisibilityUpdated(this,e),this.glRedraw()}get xrayed(){return this._state.xrayed}set xrayed(e){e=!!e,this._state.xrayed!==e&&(this._state.xrayed=e,this._isObject&&this.scene._objectXRayedUpdated(this,e),this.glRedraw())}get highlighted(){return this._state.highlighted}set highlighted(e){(e=!!e)!==this._state.highlighted&&(this._state.highlighted=e,this._isObject&&this.scene._objectHighlightedUpdated(this,e),this.glRedraw())}get selected(){return this._state.selected}set selected(e){(e=!!e)!==this._state.selected&&(this._state.selected=e,this._isObject&&this.scene._objectSelectedUpdated(this,e),this.glRedraw())}get edges(){return this._state.edges}set edges(e){(e=!!e)!==this._state.edges&&(this._state.edges=e,this.glRedraw())}get culled(){return this._state.culled}set culled(e){this._state.culled=!!e,this.glRedraw()}get clippable(){return this._state.clippable}set clippable(e){e=!1!==e,this._state.clippable!==e&&(this._state.clippable=e,this.glRedraw())}get collidable(){return this._state.collidable}set collidable(e){(e=!1!==e)!==this._state.collidable&&(this._state.collidable=e,this._setAABBDirty(),this.scene._aabbDirty=!0)}get pickable(){return this._state.pickable}set pickable(e){e=!1!==e,this._state.pickable!==e&&(this._state.pickable=e)}get castsShadow(){return this._state.castsShadow}set castsShadow(e){(e=!1!==e)!==this._state.castsShadow&&(this._state.castsShadow=e,this.glRedraw())}get receivesShadow(){return this._state.receivesShadow}set receivesShadow(e){(e=!1!==e)!==this._state.receivesShadow&&(this._state.receivesShadow=e,this._state.hash=e?"/mod/rs;":"/mod;",this.fire("dirty",this))}get saoEnabled(){return!1}get colorize(){return this._state.colorize}set colorize(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[3]=1),e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1);const i=!!e;this.scene._objectColorizeUpdated(this,i),this.glRedraw()}get opacity(){return this._state.colorize[3]}set opacity(e){let t=this._state.colorize;t||(t=this._state.colorize=new Float32Array(4),t[0]=1,t[1]=1,t[2]=1);const i=null!=e;t[3]=i?e:1,this.scene._objectOpacityUpdated(this,i),this.glRedraw()}get transparent(){return 2===this._material.alphaMode||this._state.colorize[3]<1}get layer(){return this._state.layer}set layer(e){e=e||0,(e=Math.round(e))!==this._state.layer&&(this._state.layer=e,this._renderer.needStateSort())}get stationary(){return this._state.stationary}get billboard(){return this._state.billboard}get offset(){return this._state.offset}set offset(e){this._state.offset.set(e||[0,0,0]),this._setAABBDirty(),this.glRedraw()}get isDrawable(){return!0}get isStateSortable(){return!0}get xrayMaterial(){return this._xrayMaterial}get highlightMaterial(){return this._highlightMaterial}get selectedMaterial(){return this._selectedMaterial}get edgeMaterial(){return this._edgeMaterial}_checkBillboard(e){return"spherical"!==(e=e||"none")&&"cylindrical"!==e&&"none"!==e&&(this.error("Unsupported value for 'billboard': "+e+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),e="none"),e}compile(){const e=this._makeDrawHash();this._state.drawHash!==e&&(this._state.drawHash=e,this._putDrawRenderers(),this._drawRenderer=Ti.get(this),this._emphasisFillRenderer=Li.get(this),this._emphasisEdgesRenderer=Qi.get(this));const t=this._makePickHash();if(this._state.pickHash!==t&&(this._state.pickHash=t,this._putPickRenderers(),this._pickMeshRenderer=zi.get(this)),this._state.occluder){const e=this._makeOcclusionHash();this._state.occlusionHash!==e&&(this._state.occlusionHash=e,this._putOcclusionRenderer(),this._occlusionRenderer=$i.get(this))}}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0}_buildWorldMatrix(){const e=this.matrix;if(this._parentNode)d.mulMat4(this._parentNode.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_buildWorldNormalMatrix(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=d.mat4()),d.transposeMat4(this._worldMatrix,this._worldNormalMatrix),d.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1}_setAABBDirty(){if(this.collidable)for(let e=this;e;e=e._parentNode)e._aabbDirty=!0}_updateAABB(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=d.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1}_webglContextRestored(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored()}_makeDrawHash(){const e=this.scene,t=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),i.receivesShadow&&t.push("/rs"),t.push(";"),t.join("")}_makePickHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),t.push(";"),t.join("")}_makeOcclusionHash(){const e=this.scene,t=[e.canvas.canvas.id,e._sectionPlanesState.getHash()],i=this._state;return i.stationary&&t.push("/s"),"none"===i.billboard?t.push("/n"):"spherical"===i.billboard?t.push("/s"):"cylindrical"===i.billboard&&t.push("/c"),t.push(";"),t.join("")}_buildAABB(e,t){d.transformOBB3(e,this._geometry.obb,os),d.OBB3ToAABB3(os,t);const i=this._state.offset;if(t[0]+=i[0],t[1]+=i[1],t[2]+=i[2],t[3]+=i[0],t[4]+=i[1],t[5]+=i[2],this._state.origin){const e=this._state.origin;t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[0],t[4]+=e[1],t[5]+=e[2]}}rotate(e,t){return ns[0]=e[0],ns[1]=e[1],ns[2]=e[2],ns[3]=t*d.DEGTORAD,d.angleAxisToQuaternion(ns,as),d.mulQuaternions(this.quaternion,as,ls),this.quaternion=ls,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(e,t){return ns[0]=e[0],ns[1]=e[1],ns[2]=e[2],ns[3]=t*d.DEGTORAD,d.angleAxisToQuaternion(ns,as),d.mulQuaternions(as,this.quaternion,as),this}rotateX(e){return this.rotate(As,e)}rotateY(e){return this.rotate(cs,e)}rotateZ(e){return this.rotate(hs,e)}translate(e,t){return d.vec3ApplyQuaternion(this.quaternion,e,us),d.mulVec3Scalar(us,t,ds),d.addVec3(this.position,ds,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(e){return this.translate(As,e)}translateY(e){return this.translate(cs,e)}translateZ(e){return this.translate(hs,e)}_putDrawRenderers(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null)}_putPickRenderers(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null)}_putOcclusionRenderer(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null)}stateSortCompare(e,t){return e._state.layer-t._state.layer||e._drawRenderer.id-t._drawRenderer.id||e._material._state.id-t._material._state.id||e._geometry._state.id-t._geometry._state.id}rebuildRenderFlags(){this.renderFlags.reset(),this._getActiveSectionPlanes()?(this.renderFlags.numLayers=1,this.renderFlags.numVisibleLayers=1,this.renderFlags.visibleLayers[0]=0,this._updateRenderFlags()):this.renderFlags.culled=!0}_updateRenderFlags(){const e=this.renderFlags,t=this._state;if(t.xrayed){const t=this._xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}else{if(this._material._state.alpha<1||t.colorize[3]<1?e.colorTransparent=!0:e.colorOpaque=!0,t.edges){this._edgeMaterial._state.alpha<1?e.edgesTransparent=!0:e.edgesOpaque=!0}if(t.selected){const t=this._selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}else if(t.highlighted){const t=this._highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}}_getActiveSectionPlanes(){if(this._state.clippable){const e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(let i=0;i<t;i++){const t=e[i],s=this.renderFlags;if(t.active)if(this._state.origin){const e=d.planeAABB3Intersect(t.dir,t.dist,this.aabb);if(-1===e)return!1;const r=0===e;s.sectionPlanesActivePerLayer[i]=r}else s.sectionPlanesActivePerLayer[i]=!0;else s.sectionPlanesActivePerLayer[i]=!1}}return!0}drawColorOpaque(e){(this._drawRenderer||(this._drawRenderer=Ti.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawColorTransparent(e){(this._drawRenderer||(this._drawRenderer=Ti.get(this)))&&this._drawRenderer.drawMesh(e,this)}drawSilhouetteXRayed(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Li.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,0)}drawSilhouetteHighlighted(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Li.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,1)}drawSilhouetteSelected(e){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Li.get(this)))&&this._emphasisFillRenderer.drawMesh(e,this,2)}drawEdgesColorOpaque(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Qi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawEdgesColorTransparent(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Qi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,3)}drawEdgesXRayed(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Qi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,0)}drawEdgesHighlighted(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Qi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,1)}drawEdgesSelected(e){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=Qi.get(this)))&&this._emphasisEdgesRenderer.drawMesh(e,this,2)}drawOcclusion(e){(this._state.occluder&&this._occlusionRenderer||(this._occlusionRenderer=$i.get(this)))&&this._occlusionRenderer.drawMesh(e,this)}drawShadow(e){(this._shadowRenderer||(this._shadowRenderer=is.get(this)))&&this._shadowRenderer.drawMesh(e,this)}drawPickMesh(e){(this._pickMeshRenderer||(this._pickMeshRenderer=zi.get(this)))&&this._pickMeshRenderer.drawMesh(e,this)}canPickTriangle(){return this._geometry.isReadableGeometry}drawPickTriangles(e){(this._pickTriangleRenderer||(this._pickTriangleRenderer=Zi.get(this)))&&this._pickTriangleRenderer.drawMesh(e,this)}pickTriangleSurface(e,t,i,s){ms(this,e,t,i,s)}drawPickVertices(e){}delegatePickedEntity(){return this}destroy(){super.destroy(),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.offset.some((e=>0!==e))&&this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw()}}const ms=function(){const e=d.vec3(),t=d.vec3(),i=d.vec3(),s=d.vec3(),r=d.vec3(),o=d.vec3(),n=d.vec4(),a=d.vec3(),l=d.vec3(),A=d.vec3(),c=d.vec3(),h=d.vec3(),u=d.vec3(),p=d.vec3(),f=d.vec3(),m=d.vec3(),g=d.vec4(),_=d.vec4(),v=d.vec4(),b=d.vec3(),y=d.vec3(),w=d.vec3(),B=d.vec3(),P=d.vec3(),x=d.vec3(),C=d.vec3(),M=d.vec3(),E=d.vec3(),F=d.vec3(),I=d.vec3();return function(T,D,S,R,U){var L=U.primIndex;if(null!=L&&L>-1){const V=T.geometry._state,Q=T.scene,H=Q.camera,j=Q.canvas;if("triangles"===V.primitiveName){U.primitive="triangle";const Q=L,G=V.indices,z=V.positions;let W,X,K;if(G){var k=G[Q+0],O=G[Q+1],N=G[Q+2];o[0]=k,o[1]=O,o[2]=N,U.indices=o,W=3*k,X=3*O,K=3*N}else W=3*Q,X=W+3,K=X+3;if(i[0]=z[W+0],i[1]=z[W+1],i[2]=z[W+2],s[0]=z[X+0],s[1]=z[X+1],s[2]=z[X+2],r[0]=z[K+0],r[1]=z[K+1],r[2]=z[K+2],V.compressGeometry){const e=V.positionsDecodeMatrix;e&&(me.decompressPosition(i,e,i),me.decompressPosition(s,e,s),me.decompressPosition(r,e,r))}U.canvasPos?d.canvasPosToLocalRay(j.canvas,T.origin?Ye(D,T.origin):D,S,R,T.worldMatrix,U.canvasPos,e,t):U.origin&&U.direction&&d.worldRayToLocalRay(T.worldMatrix,U.origin,U.direction,e,t),d.normalizeVec3(t),d.rayPlaneIntersect(e,t,i,s,r,n),U.localPos=n,U.position=n,g[0]=n[0],g[1]=n[1],g[2]=n[2],g[3]=1,d.transformVec4(T.worldMatrix,g,_),a[0]=_[0],a[1]=_[1],a[2]=_[2],U.canvasPos&&T.origin&&(a[0]+=T.origin[0],a[1]+=T.origin[1],a[2]+=T.origin[2]),U.worldPos=a,d.transformVec4(H.matrix,_,v),l[0]=v[0],l[1]=v[1],l[2]=v[2],U.viewPos=l,d.cartesianToBarycentric(n,i,s,r,A),U.bary=A;const Z=V.normals;if(Z){if(V.compressGeometry){const e=3*k,t=3*O,i=3*N;me.decompressNormal(Z.subarray(e,e+2),c),me.decompressNormal(Z.subarray(t,t+2),h),me.decompressNormal(Z.subarray(i,i+2),u)}else c[0]=Z[W],c[1]=Z[W+1],c[2]=Z[W+2],h[0]=Z[X],h[1]=Z[X+1],h[2]=Z[X+2],u[0]=Z[K],u[1]=Z[K+1],u[2]=Z[K+2];const e=d.addVec3(d.addVec3(d.mulVec3Scalar(c,A[0],b),d.mulVec3Scalar(h,A[1],y),w),d.mulVec3Scalar(u,A[2],B),P);U.worldNormal=d.normalizeVec3(d.transformVec3(T.worldNormalMatrix,e,x))}const J=V.uv;if(J){if(p[0]=J[2*k],p[1]=J[2*k+1],f[0]=J[2*O],f[1]=J[2*O+1],m[0]=J[2*N],m[1]=J[2*N+1],V.compressGeometry){const e=V.uvDecodeMatrix;e&&(me.decompressUV(p,e,p),me.decompressUV(f,e,f),me.decompressUV(m,e,m))}U.uv=d.addVec3(d.addVec3(d.mulVec2Scalar(p,A[0],C),d.mulVec2Scalar(f,A[1],M),E),d.mulVec2Scalar(m,A[2],F),I)}}}}}();class gs extends R{get type(){return"Material"}constructor(e,t={}){super(e,t),g.memory.materials++}destroy(){super.destroy(),g.memory.materials--}}const _s={opaque:0,mask:1,blend:2},vs=["opaque","mask","blend"];class bs extends gs{get type(){return"PhongMaterial"}constructor(e,t={}){super(e,t),this._state=new ae({type:"PhongMaterial",ambient:d.vec3([1,1,1]),diffuse:d.vec3([1,1,1]),specular:d.vec3([1,1,1]),emissive:d.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=t.ambient,this.diffuse=t.diffuse,this.specular=t.specular,this.emissive=t.emissive,this.alpha=t.alpha,this.shininess=t.shininess,this.reflectivity=t.reflectivity,this.lineWidth=t.lineWidth,this.pointSize=t.pointSize,t.ambientMap&&(this._ambientMap=this._checkComponent("Texture",t.ambientMap)),t.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",t.diffuseMap)),t.specularMap&&(this._specularMap=this._checkComponent("Texture",t.specularMap)),t.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",t.emissiveMap)),t.alphaMap&&(this._alphaMap=this._checkComponent("Texture",t.alphaMap)),t.reflectivityMap&&(this._reflectivityMap=this._checkComponent("Texture",t.reflectivityMap)),t.normalMap&&(this._normalMap=this._checkComponent("Texture",t.normalMap)),t.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",t.occlusionMap)),t.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("Fresnel",t.diffuseFresnel)),t.specularFresnel&&(this._specularFresnel=this._checkComponent("Fresnel",t.specularFresnel)),t.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("Fresnel",t.emissiveFresnel)),t.alphaFresnel&&(this._alphaFresnel=this._checkComponent("Fresnel",t.alphaFresnel)),t.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("Fresnel",t.reflectivityFresnel)),this.alphaMode=t.alphaMode,this.alphaCutoff=t.alphaCutoff,this.backfaces=t.backfaces,this.frontface=t.frontface,this._makeHash()}_makeHash(){const e=this._state,t=["/p"];this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._ambientMap&&(t.push("/am"),this._ambientMap.hasMatrix&&t.push("/mat"),t.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat"),t.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),this._reflectivityMap&&(t.push("/rm"),this._reflectivityMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._diffuseFresnel&&t.push("/df"),this._specularFresnel&&t.push("/sf"),this._emissiveFresnel&&t.push("/ef"),this._alphaFresnel&&t.push("/of"),this._reflectivityFresnel&&t.push("/rf"),t.push(";"),e.hash=t.join("")}set ambient(e){let t=this._state.ambient;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.ambient=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get ambient(){return this._state.ambient}set diffuse(e){let t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get diffuse(){return this._state.diffuse}set specular(e){let t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get specular(){return this._state.specular}set emissive(e){let t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}set alpha(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}get alpha(){return this._state.alpha}set shininess(e){this._state.shininess=void 0!==e?e:80,this.glRedraw()}get shininess(){return this._state.shininess}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this.glRedraw()}get pointSize(){return this._state.pointSize}set reflectivity(e){this._state.reflectivity=void 0!==e?e:1,this.glRedraw()}get reflectivity(){return this._state.reflectivity}get normalMap(){return this._normalMap}get ambientMap(){return this._ambientMap}get diffuseMap(){return this._diffuseMap}get specularMap(){return this._specularMap}get emissiveMap(){return this._emissiveMap}get alphaMap(){return this._alphaMap}get reflectivityMap(){return this._reflectivityMap}get occlusionMap(){return this._occlusionMap}get diffuseFresnel(){return this._diffuseFresnel}get specularFresnel(){return this._specularFresnel}get emissiveFresnel(){return this._emissiveFresnel}get alphaFresnel(){return this._alphaFresnel}get reflectivityFresnel(){return this._reflectivityFresnel}set alphaMode(e){let t=_s[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" - defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}get alphaMode(){return vs[this._state.alphaMode]}set alphaCutoff(e){null==e&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}destroy(){super.destroy(),this._state.destroy()}}function ys(e,t){if(void 0===e._cachedExtensions&&(e._cachedExtensions={}),void 0!==e._cachedExtensions[t])return e._cachedExtensions[t];let i;switch(t){case"WEBGL_depth_texture":i=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:i=e.getExtension(t)}return e._cachedExtensions[t]=i,i}function ws(e,t,i=null){let s;const r=t;if(1009===r)return e.UNSIGNED_BYTE;if(1017===r)return e.UNSIGNED_SHORT_4_4_4_4;if(1018===r)return e.UNSIGNED_SHORT_5_5_5_1;if(1010===r)return e.BYTE;if(1011===r)return e.SHORT;if(1012===r)return e.UNSIGNED_SHORT;if(1013===r)return e.INT;if(1014===r)return e.UNSIGNED_INT;if(1015===r)return e.FLOAT;if(1016===r)return e.HALF_FLOAT;if(1021===r)return e.ALPHA;if(1023===r)return e.RGBA;if(1024===r)return e.LUMINANCE;if(1025===r)return e.LUMINANCE_ALPHA;if(1026===r)return e.DEPTH_COMPONENT;if(1027===r)return e.DEPTH_STENCIL;if(1028===r)return e.RED;if(1022===r)return e.RGBA;if(1029===r)return e.RED_INTEGER;if(1030===r)return e.RG;if(1031===r)return e.RG_INTEGER;if(1033===r)return e.RGBA_INTEGER;if(33776===r||33777===r||33778===r||33779===r)if(3001===i){const t=ys(e,"WEBGL_compressed_texture_s3tc_srgb");if(null===t)return null;if(33776===r)return t.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(33777===r)return t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(33778===r)return t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(33779===r)return t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(s=ys(e,"WEBGL_compressed_texture_s3tc"),null===s)return null;if(33776===r)return s.COMPRESSED_RGB_S3TC_DXT1_EXT;if(33777===r)return s.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(33778===r)return s.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(33779===r)return s.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(35840===r||35841===r||35842===r||35843===r){const t=ys(e,"WEBGL_compressed_texture_pvrtc");if(null===t)return null;if(35840===r)return t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(35841===r)return t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(35842===r)return t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(35843===r)return t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(36196===r){const t=ys(e,"WEBGL_compressed_texture_etc1");return null!==t?t.COMPRESSED_RGB_ETC1_WEBGL:null}if(37492===r||37496===r){const t=ys(e,"WEBGL_compressed_texture_etc");if(null===t)return null;if(37492===r)return 3001===i?t.COMPRESSED_SRGB8_ETC2:t.COMPRESSED_RGB8_ETC2;if(37496===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t.COMPRESSED_RGBA8_ETC2_EAC}if(37808===r||37809===r||37810===r||37811===r||37812===r||37813===r||37814===r||37815===r||37816===r||37817===r||37818===r||37819===r||37820===r||37821===r){const t=ys(e,"WEBGL_compressed_texture_astc");if(null===t)return null;if(37808===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:t.COMPRESSED_RGBA_ASTC_4x4_KHR;if(37809===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:t.COMPRESSED_RGBA_ASTC_5x4_KHR;if(37810===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:t.COMPRESSED_RGBA_ASTC_5x5_KHR;if(37811===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:t.COMPRESSED_RGBA_ASTC_6x5_KHR;if(37812===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:t.COMPRESSED_RGBA_ASTC_6x6_KHR;if(37813===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:t.COMPRESSED_RGBA_ASTC_8x5_KHR;if(37814===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:t.COMPRESSED_RGBA_ASTC_8x6_KHR;if(37815===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:t.COMPRESSED_RGBA_ASTC_8x8_KHR;if(37816===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:t.COMPRESSED_RGBA_ASTC_10x5_KHR;if(37817===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:t.COMPRESSED_RGBA_ASTC_10x6_KHR;if(37818===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:t.COMPRESSED_RGBA_ASTC_10x8_KHR;if(37819===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:t.COMPRESSED_RGBA_ASTC_10x10_KHR;if(37820===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:t.COMPRESSED_RGBA_ASTC_12x10_KHR;if(37821===r)return 3001===i?t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:t.COMPRESSED_RGBA_ASTC_12x12_KHR}if(36492===r){const t=ys(e,"EXT_texture_compression_bptc");if(null===t)return null;if(36492===r)return 3001===i?t.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:t.COMPRESSED_RGBA_BPTC_UNORM_EXT}return 1020===r?e.UNSIGNED_INT_24_8:1e3===r?e.REPEAT:1001===r?e.CLAMP_TO_EDGE:1004===r||1005===r?e.NEAREST_MIPMAP_LINEAR:1007===r?e.LINEAR_MIPMAP_NEAREST:1008===r?e.LINEAR_MIPMAP_LINEAR:1003===r?e.NEAREST:1006===r?e.LINEAR:null}const Bs=new Uint8Array([0,0,0,1]);class Ps{constructor({gl:e,target:t,format:i,type:s,wrapS:r,wrapT:o,wrapR:n,encoding:a,preloadColor:l,premultiplyAlpha:A,flipY:c}){this.gl=e,this.target=t||e.TEXTURE_2D,this.format=i||1023,this.type=s||1009,this.internalFormat=null,this.premultiplyAlpha=!!A,this.flipY=!!c,this.unpackAlignment=4,this.wrapS=r||1e3,this.wrapT=o||1e3,this.wrapR=n||1e3,this.encoding=a||3001,this.texture=e.createTexture(),l&&this.setPreloadColor(l),this.allocated=!0}setPreloadColor(e){e?(Bs[0]=Math.floor(255*e[0]),Bs[1]=Math.floor(255*e[1]),Bs[2]=Math.floor(255*e[2]),Bs[3]=Math.floor(255*(void 0!==e[3]?e[3]:1))):(Bs[0]=0,Bs[1]=0,Bs[2]=0,Bs[3]=255);const t=this.gl;if(t.bindTexture(this.target,this.texture),this.target===t.TEXTURE_CUBE_MAP){const e=[t.TEXTURE_CUBE_MAP_POSITIVE_X,t.TEXTURE_CUBE_MAP_NEGATIVE_X,t.TEXTURE_CUBE_MAP_POSITIVE_Y,t.TEXTURE_CUBE_MAP_NEGATIVE_Y,t.TEXTURE_CUBE_MAP_POSITIVE_Z,t.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let i=0,s=e.length;i<s;i++)t.texImage2D(e[i],0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,Bs)}else t.texImage2D(this.target,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,Bs);t.bindTexture(this.target,null)}setTarget(e){this.target=e||this.gl.TEXTURE_2D}setImage(e,t={}){const i=this.gl;void 0!==t.format&&(this.format=t.format),void 0!==t.internalFormat&&(this.internalFormat=t.internalFormat),void 0!==t.encoding&&(this.encoding=t.encoding),void 0!==t.type&&(this.type=t.type),void 0!==t.flipY&&(this.flipY=t.flipY),void 0!==t.premultiplyAlpha&&(this.premultiplyAlpha=t.premultiplyAlpha),void 0!==t.unpackAlignment&&(this.unpackAlignment=t.unpackAlignment),void 0!==t.minFilter&&(this.minFilter=t.minFilter),void 0!==t.magFilter&&(this.magFilter=t.magFilter),void 0!==t.wrapS&&(this.wrapS=t.wrapS),void 0!==t.wrapT&&(this.wrapT=t.wrapT),void 0!==t.wrapR&&(this.wrapR=t.wrapR);let s=!1;i.bindTexture(this.target,this.texture);const r=i.getParameter(i.UNPACK_FLIP_Y_WEBGL);i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this.flipY);const o=i.getParameter(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL);i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha);const n=i.getParameter(i.UNPACK_ALIGNMENT);i.pixelStorei(i.UNPACK_ALIGNMENT,this.unpackAlignment);const a=i.getParameter(i.UNPACK_COLORSPACE_CONVERSION_WEBGL);i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE);const l=ws(i,this.minFilter);i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,l),l!==i.NEAREST_MIPMAP_NEAREST&&l!==i.LINEAR_MIPMAP_NEAREST&&l!==i.NEAREST_MIPMAP_LINEAR&&l!==i.LINEAR_MIPMAP_LINEAR||(s=!0);const A=ws(i,this.magFilter);A&&i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,A);const c=ws(i,this.wrapS);c&&i.texParameteri(this.target,i.TEXTURE_WRAP_S,c);const h=ws(i,this.wrapT);h&&i.texParameteri(this.target,i.TEXTURE_WRAP_T,h);const u=ws(i,this.format,this.encoding),d=ws(i,this.type),p=xs(i,this.internalFormat,u,d,this.encoding,!1);if(this.target===i.TEXTURE_CUBE_MAP){if(y.isArray(e)){const t=e,s=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let e=0,r=s.length;e<r;e++)i.texImage2D(s[e],0,p,u,d,t[e])}}else i.texImage2D(i.TEXTURE_2D,0,p,u,d,e);s&&i.generateMipmap(this.target),i.bindTexture(this.target,null),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,r),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o),i.pixelStorei(i.UNPACK_ALIGNMENT,n),i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,a)}setCompressedData({mipmaps:e,props:t={}}){const i=this.gl,s=e.length;void 0!==t.format&&(this.format=t.format),void 0!==t.internalFormat&&(this.internalFormat=t.internalFormat),void 0!==t.encoding&&(this.encoding=t.encoding),void 0!==t.type&&(this.type=t.type),void 0!==t.flipY&&(this.flipY=t.flipY),void 0!==t.premultiplyAlpha&&(this.premultiplyAlpha=t.premultiplyAlpha),void 0!==t.unpackAlignment&&(this.unpackAlignment=t.unpackAlignment),void 0!==t.minFilter&&(this.minFilter=t.minFilter),void 0!==t.magFilter&&(this.magFilter=t.magFilter),void 0!==t.wrapS&&(this.wrapS=t.wrapS),void 0!==t.wrapT&&(this.wrapT=t.wrapT),void 0!==t.wrapR&&(this.wrapR=t.wrapR),i.activeTexture(i.TEXTURE0+0),i.bindTexture(this.target,this.texture);let r=e.length>1;i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,this.flipY),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),i.pixelStorei(i.UNPACK_ALIGNMENT,this.unpackAlignment),i.pixelStorei(i.UNPACK_COLORSPACE_CONVERSION_WEBGL,i.NONE);const o=ws(i,this.wrapS);o&&i.texParameteri(this.target,i.TEXTURE_WRAP_S,o);const n=ws(i,this.wrapT);if(n&&i.texParameteri(this.target,i.TEXTURE_WRAP_T,n),this.type===i.TEXTURE_3D||this.type===i.TEXTURE_2D_ARRAY){const e=ws(i,this.wrapR);e&&i.texParameteri(this.target,i.TEXTURE_WRAP_R,e),i.texParameteri(this.type,i.TEXTURE_WRAP_R,e)}r?(i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,Cs(i,this.minFilter)),i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,Cs(i,this.magFilter))):(i.texParameteri(this.target,i.TEXTURE_MIN_FILTER,ws(i,this.minFilter)),i.texParameteri(this.target,i.TEXTURE_MAG_FILTER,ws(i,this.magFilter)));const a=ws(i,this.format,this.encoding),l=ws(i,this.type),A=xs(i,this.internalFormat,a,l,this.encoding,!1);i.texStorage2D(i.TEXTURE_2D,s,A,e[0].width,e[0].height);for(let t=0,s=e.length;t<s;t++){const s=e[t];1023!==this.format?null!==a?i.compressedTexSubImage2D(i.TEXTURE_2D,t,0,0,s.width,s.height,a,s.data):console.warn("Attempt to load unsupported compressed texture format in .setCompressedData()"):i.texSubImage2D(i.TEXTURE_2D,t,0,0,s.width,s.height,a,l,s.data)}i.bindTexture(this.target,null)}setProps(e){const t=this.gl;t.bindTexture(this.target,this.texture),this._uploadProps(e),t.bindTexture(this.target,null)}_uploadProps(e){const t=this.gl;if(void 0!==e.format&&(this.format=e.format),void 0!==e.internalFormat&&(this.internalFormat=e.internalFormat),void 0!==e.encoding&&(this.encoding=e.encoding),void 0!==e.type&&(this.type=e.type),void 0!==e.minFilter){const i=ws(t,e.minFilter);i&&(this.minFilter=e.minFilter,t.texParameteri(this.target,t.TEXTURE_MIN_FILTER,i),i!==t.NEAREST_MIPMAP_NEAREST&&i!==t.LINEAR_MIPMAP_NEAREST&&i!==t.NEAREST_MIPMAP_LINEAR&&i!==t.LINEAR_MIPMAP_LINEAR||t.generateMipmap(this.target))}if(void 0!==e.magFilter){const i=ws(t,e.magFilter);i&&(this.magFilter=e.magFilter,t.texParameteri(this.target,t.TEXTURE_MAG_FILTER,i))}if(void 0!==e.wrapS){const i=ws(t,e.wrapS);i&&(this.wrapS=e.wrapS,t.texParameteri(this.target,t.TEXTURE_WRAP_S,i))}if(void 0!==e.wrapT){const i=ws(t,e.wrapT);i&&(this.wrapT=e.wrapT,t.texParameteri(this.target,t.TEXTURE_WRAP_T,i))}}bind(e){if(this.allocated){if(this.texture){const t=this.gl;return t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,this.texture),!0}return!1}}unbind(e){if(this.allocated&&this.texture){const t=this.gl;t.activeTexture(t["TEXTURE"+e]),t.bindTexture(this.target,null)}}destroy(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}function xs(e,t,i,s,r,o=!1){if(null!==t){if(void 0!==e[t])return e[t];console.warn("Attempt to use non-existing WebGL internal format '"+t+"'")}let n=i;return i===e.RED&&(s===e.FLOAT&&(n=e.R32F),s===e.HALF_FLOAT&&(n=e.R16F),s===e.UNSIGNED_BYTE&&(n=e.R8)),i===e.RG&&(s===e.FLOAT&&(n=e.RG32F),s===e.HALF_FLOAT&&(n=e.RG16F),s===e.UNSIGNED_BYTE&&(n=e.RG8)),i===e.RGBA&&(s===e.FLOAT&&(n=e.RGBA32F),s===e.HALF_FLOAT&&(n=e.RGBA16F),s===e.UNSIGNED_BYTE&&(n=3001===r&&!1===o?e.SRGB8_ALPHA8:e.RGBA8),s===e.UNSIGNED_SHORT_4_4_4_4&&(n=e.RGBA4),s===e.UNSIGNED_SHORT_5_5_5_1&&(n=e.RGB5_A1)),n!==e.R16F&&n!==e.R32F&&n!==e.RG16F&&n!==e.RG32F&&n!==e.RGBA16F&&n!==e.RGBA32F||ys(e,"EXT_color_buffer_float"),n}function Cs(e,t){return 1003===t||1004===t||1005===t?e.NEAREST:e.LINEAR}function Ms(e){if(!Es(e.width)||!Es(e.height)){const t=document.createElement("canvas");t.width=Fs(e.width),t.height=Fs(e.height);t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e}function Es(e){return 0==(e&e-1)}function Fs(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1}class Is extends R{get type(){return"Texture"}constructor(e,t={}){super(e,t),this._state=new ae({texture:new Ps({gl:this.scene.canvas.gl}),matrix:d.identityMat4(),hasMatrix:t.translate&&(0!==t.translate[0]||0!==t.translate[1])||!!t.rotate||t.scale&&(0!==t.scale[0]||0!==t.scale[1]),minFilter:this._checkMinFilter(t.minFilter),magFilter:this._checkMagFilter(t.magFilter),wrapS:this._checkWrapS(t.wrapS),wrapT:this._checkWrapT(t.wrapT),flipY:this._checkFlipY(t.flipY),encoding:this._checkEncoding(t.encoding)}),this._src=null,this._image=null,this._translate=d.vec2([0,0]),this._scale=d.vec2([1,1]),this._rotate=d.vec2([0,0]),this._matrixDirty=!1,this.translate=t.translate,this.scale=t.scale,this.rotate=t.rotate,t.src?this.src=t.src:t.image&&(this.image=t.image),g.memory.textures++}_checkMinFilter(e){return 1006!==(e=e||1008)&&1007!==e&&1008!==e&&1005!==e&&1004!==e&&(this.error("Unsupported value for 'minFilter' - supported values are LinearFilter, LinearMipMapNearestFilter, NearestMipMapNearestFilter, NearestMipMapLinearFilter and LinearMipMapLinearFilter. Defaulting to LinearMipMapLinearFilter."),e=1008),e}_checkMagFilter(e){return 1006!==(e=e||1006)&&1003!==e&&(this.error("Unsupported value for 'magFilter' - supported values are LinearFilter and NearestFilter. Defaulting to LinearFilter."),e=1006),e}_checkWrapS(e){return 1001!==(e=e||1e3)&&1002!==e&&1e3!==e&&(this.error("Unsupported value for 'wrapS' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),e=1e3),e}_checkWrapT(e){return 1001!==(e=e||1e3)&&1002!==e&&1e3!==e&&(this.error("Unsupported value for 'wrapT' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),e=1e3),e}_checkFlipY(e){return!!e}_checkEncoding(e){return 3e3!==(e=e||3e3)&&3001!==e&&(this.error("Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),e=3e3),e}_webglContextRestored(){this._state.texture=new Ps({gl:this.scene.canvas.gl}),this._image?this.image=this._image:this._src&&(this.src=this._src)}_update(){const e=this._state;if(this._matrixDirty){let t,i;0===this._translate[0]&&0===this._translate[1]||(t=d.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(i=d.scalingMat4v([this._scale[0],this._scale[1],1]),t=t?d.mulMat4(t,i):i),0!==this._rotate&&(i=d.rotationMat4v(.0174532925*this._rotate,[0,0,1]),t=t?d.mulMat4(t,i):i),t&&(e.matrix=t),this._matrixDirty=!1}this.glRedraw()}set image(e){this._image=Ms(e),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._src=null,this.glRedraw()}get image(){return this._image}set src(e){this.scene.loading++,this.scene.canvas.spinner.processes++;const t=this;let i=new Image;i.onload=function(){i=Ms(i),t._state.texture.setImage(i,t._state),t.scene.loading--,t.glRedraw(),t.scene.canvas.spinner.processes--},i.src=e,this._src=e,this._image=null}get src(){return this._src}set translate(e){this._translate.set(e||[0,0]),this._matrixDirty=!0,this._needUpdate()}get translate(){return this._translate}set scale(e){this._scale.set(e||[1,1]),this._matrixDirty=!0,this._needUpdate()}get scale(){return this._scale}set rotate(e){e=e||0,this._rotate!==e&&(this._rotate=e,this._matrixDirty=!0,this._needUpdate())}get rotate(){return this._rotate}get minFilter(){return this._state.minFilter}get magFilter(){return this._state.magFilter}get wrapS(){return this._state.wrapS}get wrapT(){return this._state.wrapT}get flipY(){return this._state.flipY}get encoding(){return this._state.encoding}destroy(){super.destroy(),this._state.texture&&this._state.texture.destroy(),this._state.destroy(),g.memory.textures--}}const Ts=d.vec3(),Ds=d.vec3();d.vec3();const Ss=d.vec3([0,-1,0]),Rs=d.vec4([0,0,0,1]);class Us extends R{constructor(e,t={}){super(e,t),this._src=null,this._image=null,this._pos=d.vec3(),this._origin=d.vec3(),this._rtcPos=d.vec3(),this._dir=d.vec3(),this._size=1,this._imageSize=d.vec2(),this._texture=new Is(this),this._plane=new fs(this,{geometry:new ve(this,Te({center:[0,0,0],xSize:1,zSize:1,xSegments:10,zSegments:10})),material:new bs(this,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],diffuseMap:this._texture,emissiveMap:this._texture,backfaces:!0}),clippable:t.clippable}),this._grid=new fs(this,{geometry:new ve(this,Ie({size:1,divisions:10})),material:new bs(this,{diffuse:[0,0,0],ambient:[0,0,0],emissive:[.2,.8,.2]}),position:[0,.001,0],clippable:t.clippable}),this._node=new Ke(this,{rotation:[0,0,0],position:[0,0,0],scale:[1,1,1],clippable:!1,children:[this._plane,this._grid]}),this._gridVisible=!1,this.visible=!0,this.gridVisible=t.gridVisible,this.position=t.position,this.rotation=t.rotation,this.dir=t.dir,this.size=t.size,this.collidable=t.collidable,this.clippable=t.clippable,this.pickable=t.pickable,this.opacity=t.opacity,t.image?this.image=t.image:this.src=t.src}set visible(e){this._plane.visible=e,this._grid.visible=this._gridVisible&&e}get visible(){return this._plane.visible}set gridVisible(e){e=!1!==e,this._gridVisible=e,this._grid.visible=this._gridVisible&&this.visible}get gridVisible(){return this._gridVisible}set image(e){this._image=e,this._image&&(this._imageSize[0]=e.width,this._imageSize[1]=e.height,this._updatePlaneSizeFromImage(),this._src=null,this._texture.image=this._image)}get image(){return this._image}set src(e){if(this._src=e,this._src){this._image=null;const e=new Image;e.onload=()=>{this._texture.image=e,this._imageSize[0]=e.width,this._imageSize[1]=e.height,this._updatePlaneSizeFromImage()},e.src=this._src}}get src(){return this._src}set position(e){this._pos.set(e||[0,0,0]),qe(this._pos,this._origin,this._rtcPos),this._node.origin=this._origin,this._node.position=this._rtcPos}get position(){return this._pos}set rotation(e){this._node.rotation=e}get rotation(){return this._node.rotation}set size(e){this._size=null==e?1:e,this._image&&this._updatePlaneSizeFromImage()}get size(){return this._size}set dir(e){if(this._dir.set(e||[0,0,-1]),e){const t=this.scene.center,i=[-this._dir[0],-this._dir[1],-this._dir[2]];d.subVec3(t,this.position,Ts);const s=-d.dotVec3(i,Ts);d.normalizeVec3(i),d.mulVec3Scalar(i,s,Ds),d.vec3PairToQuaternion(Ss,e,Rs),this._node.quaternion=Rs}}get dir(){return this._dir}set collidable(e){this._node.collidable=!1!==e}get collidable(){return this._node.collidable}set clippable(e){this._node.clippable=!1!==e}get clippable(){return this._node.clippable}set pickable(e){this._node.pickable=!1!==e}get pickable(){return this._node.pickable}set opacity(e){this._node.opacity=e}get opacity(){return this._node.opacity}destroy(){super.destroy()}_updatePlaneSizeFromImage(){const e=this._size,t=this._imageSize[0],i=this._imageSize[1];if(t>i){const s=i/t;this._node.scale=[e,1,e*s]}else{const s=t/i;this._node.scale=[e*s,1,e]}}}class Ls extends gs{get type(){return"LambertMaterial"}constructor(e,t={}){super(e,t),this._state=new ae({type:"LambertMaterial",ambient:d.vec3([1,1,1]),color:d.vec3([1,1,1]),emissive:d.vec3([0,0,0]),alpha:null,alphaMode:0,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:"/lam;"}),this.ambient=t.ambient,this.color=t.color,this.emissive=t.emissive,this.alpha=t.alpha,this.lineWidth=t.lineWidth,this.pointSize=t.pointSize,this.backfaces=t.backfaces,this.frontface=t.frontface}set ambient(e){let t=this._state.ambient;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.ambient=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get ambient(){return this._state.ambient}set color(e){let t=this._state.color;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.color=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get color(){return this._state.color}set emissive(e){let t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}set alpha(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this._state.alphaMode=e<1?2:0,this.glRedraw())}get alpha(){return this._state.alpha}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this.glRedraw()}get pointSize(){return this._state.pointSize}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}const ks={opaque:0,mask:1,blend:2},Os=["opaque","mask","blend"];class Ns extends gs{get type(){return"MetallicMaterial"}constructor(e,t={}){super(e,t),this._state=new ae({type:"MetallicMaterial",baseColor:d.vec4([1,1,1]),emissive:d.vec4([0,0,0]),metallic:null,roughness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.baseColor=t.baseColor,this.metallic=t.metallic,this.roughness=t.roughness,this.specularF0=t.specularF0,this.emissive=t.emissive,this.alpha=t.alpha,t.baseColorMap&&(this._baseColorMap=this._checkComponent("Texture",t.baseColorMap)),t.metallicMap&&(this._metallicMap=this._checkComponent("Texture",t.metallicMap)),t.roughnessMap&&(this._roughnessMap=this._checkComponent("Texture",t.roughnessMap)),t.metallicRoughnessMap&&(this._metallicRoughnessMap=this._checkComponent("Texture",t.metallicRoughnessMap)),t.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",t.emissiveMap)),t.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",t.occlusionMap)),t.alphaMap&&(this._alphaMap=this._checkComponent("Texture",t.alphaMap)),t.normalMap&&(this._normalMap=this._checkComponent("Texture",t.normalMap)),this.alphaMode=t.alphaMode,this.alphaCutoff=t.alphaCutoff,this.backfaces=t.backfaces,this.frontface=t.frontface,this.lineWidth=t.lineWidth,this.pointSize=t.pointSize,this._makeHash()}_makeHash(){const e=this._state,t=["/met"];this._baseColorMap&&(t.push("/bm"),this._baseColorMap._state.hasMatrix&&t.push("/mat"),t.push("/"+this._baseColorMap._state.encoding)),this._metallicMap&&(t.push("/mm"),this._metallicMap._state.hasMatrix&&t.push("/mat")),this._roughnessMap&&(t.push("/rm"),this._roughnessMap._state.hasMatrix&&t.push("/mat")),this._metallicRoughnessMap&&(t.push("/mrm"),this._metallicRoughnessMap._state.hasMatrix&&t.push("/mat")),this._emissiveMap&&(t.push("/em"),this._emissiveMap._state.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap._state.hasMatrix&&t.push("/mat")),this._alphaMap&&(t.push("/am"),this._alphaMap._state.hasMatrix&&t.push("/mat")),this._normalMap&&(t.push("/nm"),this._normalMap._state.hasMatrix&&t.push("/mat")),t.push(";"),e.hash=t.join("")}set baseColor(e){let t=this._state.baseColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.baseColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get baseColor(){return this._state.baseColor}get baseColorMap(){return this._baseColorMap}set metallic(e){e=null!=e?e:1,this._state.metallic!==e&&(this._state.metallic=e,this.glRedraw())}get metallic(){return this._state.metallic}get metallicMap(){return this._attached.metallicMap}set roughness(e){e=null!=e?e:1,this._state.roughness!==e&&(this._state.roughness=e,this.glRedraw())}get roughness(){return this._state.roughness}get roughnessMap(){return this._attached.roughnessMap}get metallicRoughnessMap(){return this._attached.metallicRoughnessMap}set specularF0(e){e=null!=e?e:0,this._state.specularF0!==e&&(this._state.specularF0=e,this.glRedraw())}get specularF0(){return this._state.specularF0}set emissive(e){let t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}get emissiveMap(){return this._attached.emissiveMap}get occlusionMap(){return this._attached.occlusionMap}set alpha(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}get alpha(){return this._state.alpha}get alphaMap(){return this._attached.alphaMap}get normalMap(){return this._attached.normalMap}set alphaMode(e){let t=ks[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}get alphaMode(){return Os[this._state.alphaMode]}set alphaCutoff(e){null==e&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this.glRedraw()}get pointSize(){return this._state.pointSize}destroy(){super.destroy(),this._state.destroy()}}const Vs={opaque:0,mask:1,blend:2},Qs=["opaque","mask","blend"];class Hs extends gs{get type(){return"SpecularMaterial"}constructor(e,t={}){super(e,t),this._state=new ae({type:"SpecularMaterial",diffuse:d.vec3([1,1,1]),emissive:d.vec3([0,0,0]),specular:d.vec3([1,1,1]),glossiness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.diffuse=t.diffuse,this.specular=t.specular,this.glossiness=t.glossiness,this.specularF0=t.specularF0,this.emissive=t.emissive,this.alpha=t.alpha,t.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",t.diffuseMap)),t.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",t.emissiveMap)),t.specularMap&&(this._specularMap=this._checkComponent("Texture",t.specularMap)),t.glossinessMap&&(this._glossinessMap=this._checkComponent("Texture",t.glossinessMap)),t.specularGlossinessMap&&(this._specularGlossinessMap=this._checkComponent("Texture",t.specularGlossinessMap)),t.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",t.occlusionMap)),t.alphaMap&&(this._alphaMap=this._checkComponent("Texture",t.alphaMap)),t.normalMap&&(this._normalMap=this._checkComponent("Texture",t.normalMap)),this.alphaMode=t.alphaMode,this.alphaCutoff=t.alphaCutoff,this.backfaces=t.backfaces,this.frontface=t.frontface,this.lineWidth=t.lineWidth,this.pointSize=t.pointSize,this._makeHash()}_makeHash(){const e=this._state,t=["/spe"];this._diffuseMap&&(t.push("/dm"),this._diffuseMap.hasMatrix&&t.push("/mat"),t.push("/"+this._diffuseMap.encoding)),this._emissiveMap&&(t.push("/em"),this._emissiveMap.hasMatrix&&t.push("/mat")),this._glossinessMap&&(t.push("/gm"),this._glossinessMap.hasMatrix&&t.push("/mat")),this._specularMap&&(t.push("/sm"),this._specularMap.hasMatrix&&t.push("/mat")),this._specularGlossinessMap&&(t.push("/sgm"),this._specularGlossinessMap.hasMatrix&&t.push("/mat")),this._occlusionMap&&(t.push("/ocm"),this._occlusionMap.hasMatrix&&t.push("/mat")),this._normalMap&&(t.push("/nm"),this._normalMap.hasMatrix&&t.push("/mat")),this._alphaMap&&(t.push("/opm"),this._alphaMap.hasMatrix&&t.push("/mat")),t.push(";"),e.hash=t.join("")}set diffuse(e){let t=this._state.diffuse;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.diffuse=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get diffuse(){return this._state.diffuse}get diffuseMap(){return this._diffuseMap}set specular(e){let t=this._state.specular;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.specular=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=1,t[1]=1,t[2]=1),this.glRedraw()}get specular(){return this._state.specular}get specularMap(){return this._specularMap}get specularGlossinessMap(){return this._specularGlossinessMap}set glossiness(e){e=null!=e?e:1,this._state.glossiness!==e&&(this._state.glossiness=e,this.glRedraw())}get glossiness(){return this._state.glossiness}get glossinessMap(){return this._glossinessMap}set specularF0(e){e=null!=e?e:0,this._state.specularF0!==e&&(this._state.specularF0=e,this.glRedraw())}get specularF0(){return this._state.specularF0}set emissive(e){let t=this._state.emissive;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.emissive=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=0,t[1]=0,t[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}get emissiveMap(){return this._emissiveMap}set alpha(e){e=null!=e?e:1,this._state.alpha!==e&&(this._state.alpha=e,this.glRedraw())}get alpha(){return this._state.alpha}get alphaMap(){return this._alphaMap}get normalMap(){return this._normalMap}get occlusionMap(){return this._occlusionMap}set alphaMode(e){let t=Vs[e=e||"opaque"];void 0===t&&(this.error("Unsupported value for 'alphaMode': "+e+" defaulting to 'opaque'"),t="opaque"),this._state.alphaMode!==t&&(this._state.alphaMode=t,this.glRedraw())}get alphaMode(){return Qs[this._state.alphaMode]}set alphaCutoff(e){null==e&&(e=.5),this._state.alphaCutoff!==e&&(this._state.alphaCutoff=e)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(e){e="cw"!==e,this._state.frontface!==e&&(this._state.frontface=e,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(e){this._state.pointSize=e||1,this.glRedraw()}get pointSize(){return this._state.pointSize}destroy(){super.destroy(),this._state.destroy()}}const js={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}};class Gs extends gs{get type(){return"EmphasisMaterial"}get presets(){return js}constructor(e,t={}){super(e,t),this._state=new ae({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0,glowThrough:!0}),this._preset="default",t.preset?(this.preset=t.preset,void 0!==t.fill&&(this.fill=t.fill),t.fillColor&&(this.fillColor=t.fillColor),void 0!==t.fillAlpha&&(this.fillAlpha=t.fillAlpha),void 0!==t.edges&&(this.edges=t.edges),t.edgeColor&&(this.edgeColor=t.edgeColor),void 0!==t.edgeAlpha&&(this.edgeAlpha=t.edgeAlpha),void 0!==t.edgeWidth&&(this.edgeWidth=t.edgeWidth),void 0!==t.backfaces&&(this.backfaces=t.backfaces),void 0!==t.glowThrough&&(this.glowThrough=t.glowThrough)):(this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.backfaces=t.backfaces,this.glowThrough=t.glowThrough)}set fill(e){e=!1!==e,this._state.fill!==e&&(this._state.fill=e,this.glRedraw())}get fill(){return this._state.fill}set fillColor(e){let t=this._state.fillColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.fillColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.4,t[1]=.4,t[2]=.4),this.glRedraw()}get fillColor(){return this._state.fillColor}set fillAlpha(e){e=null!=e?e:.2,this._state.fillAlpha!==e&&(this._state.fillAlpha=e,this.glRedraw())}get fillAlpha(){return this._state.fillAlpha}set edges(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(e){let t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=null!=e?e:.5,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set backfaces(e){e=!!e,this._state.backfaces!==e&&(this._state.backfaces=e,this.glRedraw())}get backfaces(){return this._state.backfaces}set glowThrough(e){e=!1!==e,this._state.glowThrough!==e&&(this._state.glowThrough=e,this.glRedraw())}get glowThrough(){return this._state.glowThrough}set preset(e){if(console.warn("EmphasisMaterial.preset is deprecated and will be removed in future versions."),e=e||"default",this._preset===e)return;const t=js[e];t?(this.fill=t.fill,this.fillColor=t.fillColor,this.fillAlpha=t.fillAlpha,this.edges=t.edges,this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this.glowThrough=t.glowThrough,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(js).join(", "))}get preset(){return console.warn("EmphasisMaterial.preset is deprecated and will be removed in future versions."),this._preset}destroy(){super.destroy(),this._state.destroy()}}const zs={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}};class Ws extends gs{get type(){return"EdgeMaterial"}get presets(){return zs}constructor(e,t={}){super(e,t),this._state=new ae({type:"EdgeMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",t.preset?(this.preset=t.preset,t.edgeColor&&(this.edgeColor=t.edgeColor),void 0!==t.edgeAlpha&&(this.edgeAlpha=t.edgeAlpha),void 0!==t.edgeWidth&&(this.edgeWidth=t.edgeWidth)):(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth),this.edges=!1!==t.edges}set edges(e){e=!1!==e,this._state.edges!==e&&(this._state.edges=e,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(e){let t=this._state.edgeColor;if(t){if(e&&t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2])return}else t=this._state.edgeColor=new Float32Array(3);e?(t[0]=e[0],t[1]=e[1],t[2]=e[2]):(t[0]=.2,t[1]=.2,t[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(e){e=null!=e?e:1,this._state.edgeAlpha!==e&&(this._state.edgeAlpha=e,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(e){this._state.edgeWidth=e||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set preset(e){if(e=e||"default",this._preset===e)return;const t=zs[e];t?(this.edgeColor=t.edgeColor,this.edgeAlpha=t.edgeAlpha,this.edgeWidth=t.edgeWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(zs).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}class Xs extends R{get type(){return"Fresnel"}constructor(e,t={}){super(e,t),this._state=new ae({edgeColor:d.vec3([0,0,0]),centerColor:d.vec3([1,1,1]),edgeBias:0,centerBias:1,power:1}),this.edgeColor=t.edgeColor,this.centerColor=t.centerColor,this.edgeBias=t.edgeBias,this.centerBias=t.centerBias,this.power=t.power}set edgeColor(e){this._state.edgeColor.set(e||[0,0,0]),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set centerColor(e){this._state.centerColor.set(e||[1,1,1]),this.glRedraw()}get centerColor(){return this._state.centerColor}set edgeBias(e){this._state.edgeBias=e||0,this.glRedraw()}get edgeBias(){return this._state.edgeBias}set centerBias(e){this._state.centerBias=null!=e?e:1,this.glRedraw()}get centerBias(){return this._state.centerBias}set power(e){this._state.power=null!=e?e:1,this.glRedraw()}get power(){return this._state.power}destroy(){super.destroy(),this._state.destroy()}}class Ks extends R{constructor(e,t={}){super(e,t),this._type=t.type||(t.src?t.src.split(".").pop():null)||"jpg",this._pos=d.vec3(t.pos||[0,0,0]),this._up=d.vec3(t.up||[0,1,0]),this._normal=d.vec3(t.normal||[0,0,1]),this._height=t.height||1,this._origin=d.vec3(),this._rtcPos=d.vec3(),this._imageSize=d.vec2(),this._texture=new Is(this,{flipY:!0}),this._image=new Image,"jpg"!==this._type&&"png"!==this._type&&(this.error('Unsupported type - defaulting to "jpg"'),this._type="jpg"),this._node=new Ke(this,{matrix:d.inverseMat4(d.lookAtMat4v(this._pos,d.subVec3(this._pos,this._normal,d.mat4()),this._up,d.mat4())),children:[this._bitmapMesh=new fs(this,{scale:[1,1,1],rotation:[-90,0,0],collidable:t.collidable,pickable:t.pickable,opacity:t.opacity,clippable:t.clippable,geometry:new ve(this,Te({center:[0,0,0],xSize:1,zSize:1,xSegments:2,zSegments:2})),material:new bs(this,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],diffuseMap:this._texture,emissiveMap:this._texture,backfaces:!0})})]}),t.image?this.image=t.image:t.src?this.src=t.src:t.imageData&&(this.imageData=t.imageData),this.scene._bitmapCreated(this)}set visible(e){this._bitmapMesh.visible=e}get visible(){return this._bitmapMesh.visible}set image(e){this._image=e,this._image&&(this._texture.image=this._image,this._imageSize[0]=this._image.width,this._imageSize[1]=this._image.height,this._updateBitmapMeshScale())}get image(){return this._image}set src(e){if(e){this._image.onload=()=>{this._texture.image=this._image,this._imageSize[0]=this._image.width,this._imageSize[1]=this._image.height,this._updateBitmapMeshScale()},this._image.src=e;switch(e.split(".").pop()){case"jpeg":case"jpg":this._type="jpg";break;case"png":this._type="png"}}}get src(){return this._image.src}set imageData(e){this._image.onload=()=>{this._texture.image=image,this._imageSize[0]=image.width,this._imageSize[1]=image.height,this._updateBitmapMeshScale()},this._image.src=e}get imageData(){const e=document.createElement("canvas"),t=e.getContext("2d");return e.width=this._image.width,e.height=this._image.height,t.drawImage(this._image,0,0),e.toDataURL("jpg"===this._type?"image/jpeg":"image/png")}set type(e){"png"===(e=e||"jpg")&&"jpg"===e||(this.error("Unsupported value for `type` - supported types are `jpg` and `png` - defaulting to `jpg`"),e="jpg"),this._type=e}get type(){return this._type}get pos(){return this._pos}get normal(){return this._normal}get up(){return this._up}set height(e){this._height=null==e?1:e,this._image&&this._updateBitmapMeshScale()}get height(){return this._height}set collidable(e){this._bitmapMesh.collidable=!1!==e}get collidable(){return this._bitmapMesh.collidable}set clippable(e){this._bitmapMesh.clippable=!1!==e}get clippable(){return this._bitmapMesh.clippable}set pickable(e){this._bitmapMesh.pickable=!1!==e}get pickable(){return this._bitmapMesh.pickable}set opacity(e){this._bitmapMesh.opacity=e}get opacity(){return this._bitmapMesh.opacity}destroy(){super.destroy(),this.scene._bitmapDestroyed(this)}_updateBitmapMeshScale(){const e=this._imageSize[1]/this._imageSize[0];this._bitmapMesh.scale=[this._height/e,1,this._height]}}const Zs=(e,t)=>{const i=[];let s=[];function r(e,i){let s,r;for(let o=0;o<3;o++)if(s=t[3*e+o],r=t[3*i+o],s!==r)return r-s;return 0}let o=e.slice().sort(r),n=null;for(let e=0,t=o.length;e<t;e++)0!==e&&0===r(o[e],o[e-1])||(n=o[e]),i[o[e]]=n;for(let t=0,r=e.length;t<r;t+=3){const r=i[e[t]],o=i[e[t+1]],n=i[e[t+2]];let a=r,l=o,A=n;if(r>o&&r>n?o>n?(a=r,l=o,A=n):(a=r,l=n,A=o):o>r&&o>n?r>n?(a=o,l=r,A=n):(a=o,l=n,A=r):n>r&&n>o&&(r>o?(a=n,l=r,A=o):(a=n,l=o,A=r)),s[t+0]=[a,l],s[t+1]=[l,A],a>A){const e=A;A=a,a=e}s[t+2]=[A,a]}function a(e,t){let i,s;for(let r=0;r<2;r++)if(i=e[r],s=t[r],s!==i)return s-i;return 0}s=s.slice(0,e.length),s.sort(a);let l=0;for(let e=0;e<s.length;e++)if(0===e||0!==a(s[e],s[e-1])){if(0!==e&&2!==l)return!1;l=1}else l++;return!(s.length>0&&2!==l)},Js=d.vec3(),Ys=d.vec3(),qs=d.vec3();class $s{constructor(){this.vertices=[],this.indices=[],this.reset()}reset(){this.lenVertices=0,this.lenIndices=0,this.primitive=null}setPrimitive(e){this.primitive=e}addVertex(e){this.vertices[this.lenVertices++]=e[0],this.vertices[this.lenVertices++]=e[1],this.vertices[this.lenVertices++]=e[2]}addIndex(e){this.indices[this.lenIndices++]=e}get volume(){const e=this.vertices,t=this.indices;if("solid"!==this.primitive&&"surface"!==this.primitive&&"triangles"!==this.primitive)return-1;if("solid"!==this.primitive&&!Zs(t,e))return-1;let i=0;for(let s=0;s<this.lenIndices;s+=3){const r=3*t[s],o=3*t[s+1],n=3*t[s+2];Js[0]=e[r],Js[1]=e[r+1],Js[2]=e[r+2],Ys[0]=e[o],Ys[1]=e[o+1],Ys[2]=e[o+2],qs[0]=e[n],qs[1]=e[n+1],qs[2]=e[n+2],d.cross3Vec3(Js,Ys,Js),i+=d.dotVec3(Js,qs)}return i/6}}const er=new $s,tr=d.vec3(),ir=d.vec3(),sr=d.vec3(),rr=d.vec3(),or=d.vec3(),nr=d.vec3();class ar{constructor(){this.vertices=[],this.indices=[],this.reset()}reset(){this.lenVertices=0,this.lenIndices=0}addVertex(e){this.vertices[this.lenVertices++]=e[0],this.vertices[this.lenVertices++]=e[1],this.vertices[this.lenVertices++]=e[2]}addIndex(e){this.indices[this.lenIndices++]=e}get surfaceArea(){const e=this.vertices,t=this.indices;let i=0;for(let s=0;s<this.lenIndices;s+=3){const r=3*t[s],o=3*t[s+1],n=3*t[s+2];tr[0]=e[r],tr[1]=e[r+1],tr[2]=e[r+2],ir[0]=e[o],ir[1]=e[o+1],ir[2]=e[o+2],sr[0]=e[n],sr[1]=e[n+1],sr[2]=e[n+2],d.subVec3(tr,ir,rr),d.subVec3(sr,ir,or),i+=.5*d.lenVec3(d.cross3Vec3(rr,or,nr))}return i}}const lr=new ar,Ar=d.OBB3(),cr=d.OBB3(),hr=d.OBB3();class ur{constructor(e,t,i,s,r,o,n=null,a=0){this.model=e,this.object=null,this.parent=null,this.transform=r,this.textureSet=o,this._matrixDirty=!1,this._matrixUpdateScheduled=!1,this.id=t,this.obb=null,this._aabbLocal=null,this._aabbWorld=d.AABB3(),this._aabbWorldDirty=!1,this.layer=n,this.portionId=a,this._color=new Uint8Array([i[0],i[1],i[2],s]),this._colorize=new Uint8Array([i[0],i[1],i[2],s]),this._colorizing=!1,this._transparent=s<255,this.numTriangles=0,this.origin=null,this.entity=null,r&&r._addMesh(this),this._volume=null,this._surfaceArea=null}_sceneModelDirty(){this._aabbWorldDirty=!0,this.layer.aabbDirty=!0}_transformDirty(){this._matrixDirty||this._matrixUpdateScheduled||(this.model._meshMatrixDirty(this),this._matrixDirty=!0,this._matrixUpdateScheduled=!0),this._aabbWorldDirty=!0,this.layer.aabbDirty=!0,this.entity&&this.entity._transformDirty()}_updateMatrix(){this.transform&&this._matrixDirty&&this.layer.setMatrix(this.portionId,this.transform.worldMatrix),this._matrixDirty=!1,this._matrixUpdateScheduled=!1}_finalize(e){this.layer.initFlags(this.portionId,e,this._transparent)}_finalize2(){this.layer.flushInitFlags&&this.layer.flushInitFlags()}_setVisible(e){this.layer.setVisible(this.portionId,e,this._transparent)}_setColor(e){this._color[0]=e[0],this._color[1]=e[1],this._color[2]=e[2],this._colorizing||this.layer.setColor(this.portionId,this._color,!1)}_setColorize(e){e?(this._colorize[0]=e[0],this._colorize[1]=e[1],this._colorize[2]=e[2],this.layer.setColor(this.portionId,this._colorize,false),this._colorizing=!0):(this.layer.setColor(this.portionId,this._color,false),this._colorizing=!1)}_setOpacity(e,t){const i=e<255,s=this._transparent!==i;this._color[3]=e,this._colorize[3]=e,this._transparent=i,this._colorizing?this.layer.setColor(this.portionId,this._colorize):this.layer.setColor(this.portionId,this._color),s&&this.layer.setTransparent(this.portionId,t,i)}_setOffset(e){this.layer.setOffset(this.portionId,e)}_setHighlighted(e){this.layer.setHighlighted(this.portionId,e,this._transparent)}_setXRayed(e){this.layer.setXRayed(this.portionId,e,this._transparent)}_setSelected(e){this.layer.setSelected(this.portionId,e,this._transparent)}_setEdges(e){this.layer.setEdges(this.portionId,e,this._transparent)}_setClippable(e){this.layer.setClippable(this.portionId,e,this._transparent)}_setCollidable(e){this.layer.setCollidable(this.portionId,e)}_setPickable(e){this.layer.setPickable(this.portionId,e,this._transparent)}_setCulled(e){this.layer.setCulled(this.portionId,e,this._transparent)}canPickTriangle(){return!1}drawPickTriangles(e,t){}pickTriangleSurface(e){}precisionRayPickSurface(e,t,i,s){return!!this.layer.precisionRayPickSurface&&this.layer.precisionRayPickSurface(this.portionId,e,t,i,s)}canPickWorldPos(){return!0}drawPickDepths(e){this.model.drawPickDepths(e)}drawPickNormals(e){this.model.drawPickNormals(e)}delegatePickedEntity(){return this.parent}getEachVertex(e){this.layer.getEachVertex&&this.layer.getEachVertex(this.portionId,e)}getEachIndex(e){this.layer.getEachIndex&&this.layer.getEachIndex(this.portionId,e)}isSolid(){return this.layer.solid}get volume(){if(null!==this._volume)return this._volume;switch(this.layer.primitive){case"solid":case"surface":case"triangles":er.reset(),er.setPrimitive(this.layer.primitive),this.getEachVertex((e=>{er.addVertex(e)})),this.getEachIndex((e=>{er.addIndex(e)})),this._volume=er.volume;break;default:this._volume=0}return this._volume}get surfaceArea(){if(null!==this._surfaceArea)return this._surfaceArea;switch(this.layer.primitive){case"solid":case"surface":case"triangles":lr.reset(),this.getEachVertex((e=>{lr.addVertex(e)})),this.getEachIndex((e=>{lr.addIndex(e)})),this._surfaceArea=lr.surfaceArea;break;default:this._surfaceArea=0}return this._surfaceArea}set aabb(e){if(this._aabbLocal=e,this.origin){this._aabbLocal=e.slice(0);const t=this.origin;this._aabbLocal[0]+=t[0],this._aabbLocal[1]+=t[1],this._aabbLocal[2]+=t[2],this._aabbLocal[3]+=t[0],this._aabbLocal[4]+=t[1],this._aabbLocal[5]+=t[2]}}get aabb(){return this._aabbWorldDirty&&(d.AABB3ToOBB3(this._aabbLocal,Ar),this.transform?(d.transformOBB3(this.transform.worldMatrix,Ar,cr),d.transformOBB3(this.model.worldMatrix,cr,hr),d.OBB3ToAABB3(hr,this._aabbWorld)):(d.transformOBB3(this.model.worldMatrix,Ar,cr),d.OBB3ToAABB3(cr,this._aabbWorld)),this._aabbWorldDirty=!1),this._aabbWorld}_destroy(){this.model.scene._renderer.putPickID(this.pickId)}}const dr=new class{constructor(){this._uint8Arrays={},this._float32Arrays={}}_clear(){this._uint8Arrays={},this._float32Arrays={}}getUInt8Array(e){let t=this._uint8Arrays[e];return t||(t=new Uint8Array(e),this._uint8Arrays[e]=t),t}getFloat32Array(e){let t=this._float32Arrays[e];return t||(t=new Float32Array(e),this._float32Arrays[e]=t),t}};let pr=0;const fr=1,mr=4,gr=8,_r=16,vr=32,br=256,yr=512,wr=1024,Br=2048,Pr={NOT_RENDERED:0,COLOR_OPAQUE:1,COLOR_TRANSPARENT:2,SILHOUETTE_HIGHLIGHTED:3,SILHOUETTE_SELECTED:4,SILHOUETTE_XRAYED:5,EDGES_COLOR_OPAQUE:6,EDGES_COLOR_TRANSPARENT:7,EDGES_HIGHLIGHTED:8,EDGES_SELECTED:9,EDGES_XRAYED:10,PICK:11},xr=new Float32Array([1,1,1,1]),Cr=new Float32Array([0,0,0,1]),Mr=d.vec4(),Er=d.vec3(),Fr=d.vec3(),Ir=d.mat4();class Tr{constructor(e,t=!1,{instancing:i=!1,edges:s=!1,useAlphaCutoff:r=!1}={}){this._scene=e,this._withSAO=t,this._instancing=i,this._edges=s,this._useAlphaCutoff=r,this._hash=this._getHash(),this._matricesUniformBlockBufferBindingPoint=0,this._matricesUniformBlockBuffer=this._scene.canvas.gl.createBuffer(),this._matricesUniformBlockBufferData=new Float32Array(96),this._vaoCache=new WeakMap,this._allocate()}_getHash(){return this._scene._sectionPlanesState.getHash()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){return[""]}_buildFragmentShader(){return[""]}_addMatricesUniformBlockLines(e,t=!1){return e.push("uniform Matrices {"),e.push("    mat4 worldMatrix;"),e.push("    mat4 viewMatrix;"),e.push("    mat4 projMatrix;"),e.push("    mat4 positionsDecodeMatrix;"),t&&(e.push("    mat4 worldNormalMatrix;"),e.push("    mat4 viewNormalMatrix;")),e.push("};"),e}_addRemapClipPosLines(e,t=1){return e.push("uniform vec2 drawingBufferSize;"),e.push("uniform vec2 pickClipPos;"),e.push("vec4 remapClipPos(vec4 clipPos) {"),e.push("    clipPos.xy /= clipPos.w;"),1===t?e.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"):e.push(`    clipPos.xy = (clipPos.xy - pickClipPos) * (drawingBufferSize / float(${t}));`),e.push("    clipPos.xy *= clipPos.w;"),e.push("    return clipPos;"),e.push("}"),e}getValid(){return this._hash===this._getHash()}setSectionPlanesStateUniforms(e){const t=this._scene,{gl:i}=t.canvas,{model:s,layerIndex:r}=e,o=t._sectionPlanesState.getNumAllocatedSectionPlanes(),n=t._sectionPlanesState.sectionPlanes.length;if(o>0){const a=t._sectionPlanesState.sectionPlanes,l=r*n,A=s.renderFlags;t.crossSections&&(i.uniform4fv(this._uSliceColor,t.crossSections.sliceColor),i.uniform1f(this._uSliceThickness,t.crossSections.sliceThickness));for(let t=0;t<o;t++){const r=this._uSectionPlanes[t];if(r)if(t<n){const o=A.sectionPlanesActivePerLayer[l+t];if(i.uniform1i(r.active,o?1:0),o){const o=a[t],n=e._state.origin;if(n){const e=tt(o.dist,o.dir,n,Er,s.matrix);i.uniform3fv(r.pos,e)}else i.uniform3fv(r.pos,o.pos);i.uniform3fv(r.dir,o.dir)}}else i.uniform1i(r.active,0)}}}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uColor=s.getLocation("color"),this._uColor||(this._uColor=s.getLocation("silhouetteColor")),this._uUVDecodeMatrix=s.getLocation("uvDecodeMatrix"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uGammaFactor=s.getLocation("gammaFactor"),t.uniformBlockBinding(s.handle,t.getUniformBlockIndex(s.handle,"Matrices"),this._matricesUniformBlockBufferBindingPoint),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),e.logarithmicDepthBufferEnabled&&(this._uZFar=s.getLocation("zFar")),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=s.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=s.getLocation("lightDir"+e),this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aUV=s.getAttribute("uv"),this._aColor=s.getAttribute("color"),this._aMetallicRoughness=s.getAttribute("metallicRoughness"),this._aFlags=s.getAttribute("flags"),this._aPickColor=s.getAttribute("pickColor"),this._uPickZNear=s.getLocation("pickZNear"),this._uPickZFar=s.getLocation("pickZFar"),this._uPickClipPos=s.getLocation("pickClipPos"),this._uDrawingBufferSize=s.getLocation("drawingBufferSize"),this._uColorMap="uColorMap",this._uMetallicRoughMap="uMetallicRoughMap",this._uEmissiveMap="uEmissiveMap",this._uNormalMap="uNormalMap",this._uAOMap="uAOMap",this._instancing&&(this._aModelMatrix=s.getAttribute("modelMatrix"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=s.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=s.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=s.getAttribute("modelNormalMatrixCol2")),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),this._useAlphaCutoff&&(this._alphaCutoffLocation=s.getLocation("materialAlphaCutoff")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),e.pointsMaterial._state.filterIntensity&&(this._uIntensityRange=s.getLocation("intensityRange")),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.crossSections&&(this._uSliceColor=s.getLocation("sliceColor"),this._uSliceThickness=s.getLocation("sliceThickness"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t._lightsState,o=r.lights;s.bind(),e.textureUnit=0,this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,r.getAmbientColorAndIntensity()),this._uGammaFactor&&i.uniform1f(this._uGammaFactor,t.gammaFactor);for(let e=0,t=o.length;e<t;e++){const t=o[e];this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir)}}_makeVAO(e){const t=this._scene.canvas.gl,i=t.createVertexArray();return t.bindVertexArray(i),this._instancing&&(this._aModelMatrixCol0.bindArrayBuffer(e.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(e.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(e.modelMatrixCol2Buf),t.vertexAttribDivisor(this._aModelMatrixCol0.location,1),t.vertexAttribDivisor(this._aModelMatrixCol1.location,1),t.vertexAttribDivisor(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0&&(this._aModelNormalMatrixCol0.bindArrayBuffer(e.modelNormalMatrixCol0Buf),t.vertexAttribDivisor(this._aModelNormalMatrixCol0.location,1)),this._aModelNormalMatrixCol1&&(this._aModelNormalMatrixCol1.bindArrayBuffer(e.modelNormalMatrixCol1Buf),t.vertexAttribDivisor(this._aModelNormalMatrixCol1.location,1)),this._aModelNormalMatrixCol2&&(this._aModelNormalMatrixCol2.bindArrayBuffer(e.modelNormalMatrixCol2Buf),t.vertexAttribDivisor(this._aModelNormalMatrixCol2.location,1))),this._aPosition.bindArrayBuffer(e.positionsBuf),this._aUV&&this._aUV.bindArrayBuffer(e.uvBuf),this._aNormal&&this._aNormal.bindArrayBuffer(e.normalsBuf),this._aMetallicRoughness&&(this._aMetallicRoughness.bindArrayBuffer(e.metallicRoughnessBuf),this._instancing&&t.vertexAttribDivisor(this._aMetallicRoughness.location,1)),this._aColor&&(this._aColor.bindArrayBuffer(e.colorsBuf),this._instancing&&e.colorsBuf&&t.vertexAttribDivisor(this._aColor.location,1)),this._aFlags&&(this._aFlags.bindArrayBuffer(e.flagsBuf),this._instancing&&t.vertexAttribDivisor(this._aFlags.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(e.offsetsBuf),this._instancing&&t.vertexAttribDivisor(this._aOffset.location,1)),this._aPickColor&&(this._aPickColor.bindArrayBuffer(e.pickColorsBuf),this._instancing&&t.vertexAttribDivisor(this._aPickColor.location,1)),this._instancing,this._edges&&e.edgeIndicesBuf?e.edgeIndicesBuf.bind():e.indicesBuf&&e.indicesBuf.bind(),i}drawLayer(e,t,i,{colorUniform:s=!1,incrementDrawState:r=!1}={}){const o=Mi.MAX_TEXTURE_IMAGE_UNITS,n=this._scene,a=n.canvas.gl,{_state:l,model:A}=t,{textureSet:c,origin:h,positionsDecodeMatrix:u}=l,p=n._lightsState,f=n.pointsMaterial,{camera:m}=A.scene,{viewNormalMatrix:g,project:_}=m,v=e.pickViewMatrix||m.viewMatrix,{position:b,rotationMatrix:y,worldNormalMatrix:w}=A;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e)),this._vaoCache.has(t)?a.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(l));let B=0;const P=16;this._matricesUniformBlockBufferData.set(y,0);const x=0!==h[0]||0!==h[1]||0!==h[2],C=0!==b[0]||0!==b[1]||0!==b[2];if(x||C){const e=Er;if(x){const t=d.transformPoint3(y,h,Fr);e[0]=t[0],e[1]=t[1],e[2]=t[2]}else e[0]=0,e[1]=0,e[2]=0;e[0]+=b[0],e[1]+=b[1],e[2]+=b[2],this._matricesUniformBlockBufferData.set(Ye(v,e,Ir),B+=P)}else this._matricesUniformBlockBufferData.set(v,B+=P);if(this._matricesUniformBlockBufferData.set(e.pickProjMatrix||_.matrix,B+=P),this._matricesUniformBlockBufferData.set(u,B+=P),this._matricesUniformBlockBufferData.set(w,B+=P),this._matricesUniformBlockBufferData.set(g,B+=P),a.bindBuffer(a.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),a.bufferData(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,a.DYNAMIC_DRAW),a.bindBufferBase(a.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer),a.uniform1i(this._uRenderPass,i),this.setSectionPlanesStateUniforms(t),n.logarithmicDepthBufferEnabled){if(this._uLogDepthBufFC){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}this._uZFar&&a.uniform1f(this._uZFar,n.camera.project.far)}if(this._uPickInvisible&&a.uniform1i(this._uPickInvisible,e.pickInvisible),this._uPickZNear&&a.uniform1f(this._uPickZNear,e.pickZNear),this._uPickZFar&&a.uniform1f(this._uPickZFar,e.pickZFar),this._uPickClipPos&&a.uniform2fv(this._uPickClipPos,e.pickClipPos),this._uDrawingBufferSize&&a.uniform2f(this._uDrawingBufferSize,a.drawingBufferWidth,a.drawingBufferHeight),this._uUVDecodeMatrix&&a.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._uIntensityRange&&f.filterIntensity&&a.uniform2f(this._uIntensityRange,f.minIntensity,f.maxIntensity),this._uPointSize&&a.uniform1f(this._uPointSize,f.pointSize),this._uNearPlaneHeight){const e="ortho"===n.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*n.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,e)}if(c){const{colorTexture:t,metallicRoughnessTexture:i,emissiveTexture:s,normalsTexture:r,occlusionTexture:n}=c;this._uColorMap&&t&&(this._program.bindTexture(this._uColorMap,t.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%o),this._uMetallicRoughMap&&i&&(this._program.bindTexture(this._uMetallicRoughMap,i.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%o),this._uEmissiveMap&&s&&(this._program.bindTexture(this._uEmissiveMap,s.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%o),this._uNormalMap&&r&&(this._program.bindTexture(this._uNormalMap,r.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%o),this._uAOMap&&n&&(this._program.bindTexture(this._uAOMap,n.texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%o)}if(p.reflectionMaps.length>0&&p.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,p.reflectionMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%o,e.bindTexture++),p.lightMaps.length>0&&p.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,p.lightMaps[0].texture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%o,e.bindTexture++),this._withSAO){const t=n.sao;if(t.possible){const i=a.drawingBufferWidth,s=a.drawingBufferHeight;Mr[0]=i,Mr[1]=s,Mr[2]=t.blendCutoff,Mr[3]=t.blendFactor,a.uniform4fv(this._uSAOParams,Mr),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,e.textureUnit),e.textureUnit=(e.textureUnit+1)%o,e.bindTexture++}}if(this._useAlphaCutoff&&a.uniform1f(this._alphaCutoffLocation,c.alphaCutoff),s){const e=this._edges?"edgeColor":"fillColor",t=this._edges?"edgeAlpha":"fillAlpha";if(i===Pr[(this._edges?"EDGES":"SILHOUETTE")+"_XRAYED"]){const i=n.xrayMaterial._state,s=i[e],r=i[t];a.uniform4f(this._uColor,s[0],s[1],s[2],r)}else if(i===Pr[(this._edges?"EDGES":"SILHOUETTE")+"_HIGHLIGHTED"]){const i=n.highlightMaterial._state,s=i[e],r=i[t];a.uniform4f(this._uColor,s[0],s[1],s[2],r)}else if(i===Pr[(this._edges?"EDGES":"SILHOUETTE")+"_SELECTED"]){const i=n.selectedMaterial._state,s=i[e],r=i[t];a.uniform4f(this._uColor,s[0],s[1],s[2],r)}else a.uniform4fv(this._uColor,this._edges?Cr:xr)}this._draw({state:l,frameCtx:e,incrementDrawState:r}),a.bindVertexArray(null)}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null,g.memory.programs--}}class Dr extends Tr{constructor(e,t,{edges:i=!1,useAlphaCutoff:s=!1}={}){super(e,t,{instancing:!1,edges:i,useAlphaCutoff:s})}_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:r}=e;if(this._edges)i.edgeIndicesBuf&&t.drawElements(t.LINES,i.edgeIndicesBuf.numItems,i.edgeIndicesBuf.itemType,0);else{const e=s.pickElementsCount||i.indicesBuf.numItems,o=s.pickElementsOffset?s.pickElementsOffset*i.indicesBuf.itemByteSize:0;t.drawElements(t.TRIANGLES,e,i.indicesBuf.itemType,o),r&&s.drawElements++}}}class Sr extends Dr{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0;let r;const o=[];o.push("#version 300 es"),o.push("// Triangles batching draw vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec3 normal;"),o.push("in vec4 color;"),o.push("in float flags;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),this._addMatricesUniformBlockLines(o,!0),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;")),o.push("uniform vec4 lightAmbient;");for(let e=0,t=i.lights.length;e<t;e++)r=i.lights[e],"ambient"!==r.type&&(o.push("uniform vec4 lightColor"+e+";"),"dir"===r.type&&o.push("uniform vec3 lightDir"+e+";"),"point"===r.type&&o.push("uniform vec3 lightPos"+e+";"),"spot"===r.type&&(o.push("uniform vec3 lightPos"+e+";"),o.push("uniform vec3 lightDir"+e+";")));o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),s&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;");for(let e=0,t=i.lights.length;e<t;e++)if(r=i.lights[e],"ambient"!==r.type){if("dir"===r.type)"view"===r.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===r.type)"view"===r.space?o.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==r.type)continue;"view"===r.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}return o.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),o.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;")),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching draw fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";");s.push("uniform float sliceThickness;"),s.push("uniform vec4 sliceColor;")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec4 newColor;"),s.push("  newColor = vColor;"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > sliceThickness) { "),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      newColor = sliceColor;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled?(s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;")):(s.push("    float dx = dFdx(gl_FragCoord.z);"),s.push("    float dy = dFdy(gl_FragCoord.z);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = gl_FragCoord.z + diff;")),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor            = vec4(newColor.rgb * ambient, 1.0);")):s.push("   outColor            = newColor;"),s.push("}"),s}}class Rr extends Dr{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching flat-shading draw vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in float flags;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._lightsState,i=e._sectionPlanesState,s=i.getNumAllocatedSectionPlanes()>0,r=[];if(r.push("#version 300 es"),r.push("// Triangles batching flat-shading draw fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&(r.push("in float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("in float vFragDepth;")),this._withSAO&&(r.push("uniform sampler2D uOcclusionTexture;"),r.push("uniform vec4      uSAOParams;"),r.push("const float       packUpscale = 256. / 255.;"),r.push("const float       unpackDownScale = 255. / 256.;"),r.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),r.push("float unpackRGBToFloat( const in vec4 v ) {"),r.push("    return dot( v, unPackFactors );"),r.push("}")),s){r.push("in vec4 vWorldPosition;"),r.push("in float vFlags;");for(let e=0,t=i.getNumAllocatedSectionPlanes();e<t;e++)r.push("uniform bool sectionPlaneActive"+e+";"),r.push("uniform vec3 sectionPlanePos"+e+";"),r.push("uniform vec3 sectionPlaneDir"+e+";");r.push("uniform float sliceThickness;"),r.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(r),r.push("uniform vec4 lightAmbient;");for(let e=0,i=t.lights.length;e<i;e++){const i=t.lights[e];"ambient"!==i.type&&(r.push("uniform vec4 lightColor"+e+";"),"dir"===i.type&&r.push("uniform vec3 lightDir"+e+";"),"point"===i.type&&r.push("uniform vec3 lightPos"+e+";"),"spot"===i.type&&(r.push("uniform vec3 lightPos"+e+";"),r.push("uniform vec3 lightDir"+e+";")))}if(r.push("in vec4 vViewPosition;"),r.push("in vec4 vColor;"),r.push("out vec4 outColor;"),r.push("void main(void) {"),r.push("  vec4 newColor;"),r.push("  newColor = vColor;"),s){r.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(let e=0,t=i.getNumAllocatedSectionPlanes();e<t;e++)r.push("if (sectionPlaneActive"+e+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > sliceThickness) { "),r.push("      discard;"),r.push("  }"),r.push("  if (dist > 0.0) { "),r.push("      newColor = sliceColor;"),r.push("  }"),r.push("}")}r.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),r.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),r.push("float lambertian = 1.0;"),r.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),r.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),r.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let e=0,i=t.lights.length;e<i;e++){const i=t.lights[e];if("ambient"!==i.type){if("dir"===i.type)"view"===i.space?r.push("viewLightDir = normalize(lightDir"+e+");"):r.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===i.type)"view"===i.space?r.push("viewLightDir = -normalize(lightPos"+e+" - vViewPosition.xyz);"):r.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==i.type)continue;"view"===i.space?r.push("viewLightDir = normalize(lightDir"+e+");"):r.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}r.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),r.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}}return r.push("vec4 fragColor =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),this._withSAO?(r.push("   float viewportWidth     = uSAOParams[0];"),r.push("   float viewportHeight    = uSAOParams[1];"),r.push("   float blendCutoff       = uSAOParams[2];"),r.push("   float blendFactor       = uSAOParams[3];"),r.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),r.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),r.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):r.push("   outColor            = fragColor;"),e.logarithmicDepthBufferEnabled?r.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"):(r.push("    float dx = dFdx(gl_FragCoord.z);"),r.push("    float dy = dFdy(gl_FragCoord.z);"),r.push("    float diff = sqrt(dx*dx+dy*dy);"),r.push("    gl_FragDepth = gl_FragCoord.z + diff;")),r.push("}"),r}}class Ur extends Dr{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 color;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec4 silhouetteColor;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),i.push("if (silhouetteFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vColor = vec4(silhouetteColor.r, silhouetteColor.g, silhouetteColor.b, min(silhouetteColor.a, color.a ));"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const r=t.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Triangles batching silhouette fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r){for(o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");o.push("uniform float sliceThickness;"),o.push("uniform vec4 sliceColor;")}if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),o.push("  vec4 newColor;"),o.push("  newColor = vColor;"),r){o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)o.push("if (sectionPlaneActive"+e+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > sliceThickness) { "),o.push("      discard;"),o.push("  }"),o.push("  if (dist > 0.0) { "),o.push("      newColor = sliceColor;"),o.push("  }"),o.push("}")}return e.logarithmicDepthBufferEnabled&&o.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("outColor = newColor;"),o.push("}"),o}}class Lr extends Dr{constructor(e){super(e,!1,{instancing:!1,edges:!0})}}class kr extends Lr{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// EdgesEmphasisRenderer vertex shader"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeFlag = int(flags) >> 8 & 0xF;"),i.push("if (edgeFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// EdgesEmphasisRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class Or extends Lr{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!1})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry edges drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeFlag = int(flags) >> 8 & 0xF;"),i.push("if (edgeFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry edges drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class Nr extends Dr{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry picking vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 pickColor;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),this._addRemapClipPosLines(i),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(var r=0;r<t.getNumAllocatedSectionPlanes();r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("      if (sectionPlaneActive"+e+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vPickColor; "),s.push("}"),s}}class Vr extends Dr{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),this._addRemapClipPosLines(i),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(var r=0;r<t.getNumAllocatedSectionPlanes();r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("      if (sectionPlaneActive"+e+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}}class Qr extends Dr{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i,3),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec3 vWorldNormal;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vec3 worldNormal =  octDecode(normal.xy); "),i.push("      vWorldNormal = worldNormal;"),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching pick normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(var r=0;r<t.getNumAllocatedSectionPlanes();r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("in vec3 vWorldNormal;"),s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("      if (sectionPlaneActive"+e+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push(`    outNormal = ivec4(vWorldNormal * float(${d.MAX_INT}), 1.0);`),s.push("}"),s}}class Hr extends Dr{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching occlusion vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles batching occlusion fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("      if (sectionPlaneActive"+t+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),i.push("}"),i}}class jr extends Dr{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching depth fragment shader"),s.push("precision highp float;"),s.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec2 vHighPrecisionZW;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<t.getNumAllocatedSectionPlanes();r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),s.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),s.push("}"),s}}class Gr extends Dr{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in vec4 color;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i,!0),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec3 vViewNormal;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags         = flags;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<t.getNumAllocatedSectionPlanes();r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}}class zr extends Dr{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry shadow vertex shader"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(i),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("  int colorFlag = int(flags) & 0xF;"),i.push("  bool visible        = (colorFlag > 0);"),i.push("  bool transparent    = ((float(color.a) / 255.0) < 1.0);"),i.push("  if (!visible || transparent) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("      vViewPosition = viewPosition;"),i.push("      gl_Position = shadowProjMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry shadow fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in vec4 vViewPosition;"),i.push("vec4 encodeFloat( const in float v ) {"),i.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),i.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),i.push("  vec4 comp = fract(v * bitShift);"),i.push("  comp -= comp.xxyz * bitMask;"),i.push("  return comp;"),i.push("}"),i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    outColor = encodeFloat( gl_FragCoord.z); "),i.push("}"),i}}class Wr extends Dr{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0,r=t.clippingCaps,o=[];return o.push("#version 300 es"),o.push("// Triangles batching quality draw vertex shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("precision highp usampler2D;"),o.push("precision highp isampler2D;"),o.push("precision highp sampler2D;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("precision mediump usampler2D;"),o.push("precision mediump isampler2D;"),o.push("precision mediump sampler2D;"),o.push("#endif"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec3 normal;"),o.push("in vec4 color;"),o.push("in vec2 uv;"),o.push("in vec2 metallicRoughness;"),o.push("in float flags;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),this._addMatricesUniformBlockLines(o,!0),o.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("out vec4 vViewPosition;"),o.push("out vec3 vViewNormal;"),o.push("out vec4 vColor;"),o.push("out vec2 vUV;"),o.push("out vec2 vMetallicRoughness;"),i.lightMaps.length>0&&o.push("out vec3 vWorldNormal;"),s&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;"),r&&o.push("out vec4 vClipPosition;")),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),o.push("vFragDepth = 1.0 + clipPos.w;")),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;"),r&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),o.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,s=e._lightsState,r=i.getNumAllocatedSectionPlanes()>0,o=i.clippingCaps,n=[];n.push("#version 300 es"),n.push("// Triangles batching quality draw fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uColorMap;"),n.push("uniform sampler2D uMetallicRoughMap;"),n.push("uniform sampler2D uEmissiveMap;"),n.push("uniform sampler2D uNormalMap;"),n.push("uniform sampler2D uAOMap;"),n.push("in vec4 vViewPosition;"),n.push("in vec3 vViewNormal;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("in vec2 vMetallicRoughness;"),s.lightMaps.length>0&&n.push("in vec3 vWorldNormal;"),this._addMatricesUniformBlockLines(n,!0),s.reflectionMaps.length>0&&n.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&n.push("uniform samplerCube lightMap;"),n.push("uniform vec4 lightAmbient;");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];"ambient"!==t.type&&(n.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&n.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&n.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(n.push("uniform vec3 lightPos"+e+";"),n.push("uniform vec3 lightDir"+e+";")))}if(this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),r){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),o&&n.push("in vec4 vClipPosition;");for(let e=0,t=i.getNumAllocatedSectionPlanes();e<t;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";")}if(n.push("#define PI 3.14159265359"),n.push("#define RECIPROCAL_PI 0.31830988618"),n.push("#define RECIPROCAL_PI2 0.15915494"),n.push("#define EPSILON 1e-6"),n.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),n.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),n.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),n.push("       if (texel.x == 0.0 && texel.y == 0.0 && texel.z == 0.0) {"),n.push("              return surf_norm;"),n.push("       }"),n.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),n.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),n.push("      vec2 st0 = dFdx( uv.st );"),n.push("      vec2 st1 = dFdy( uv.st );"),n.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),n.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),n.push("      vec3 N = normalize( surf_norm );"),n.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),n.push("      mat3 tsn = mat3( S, T, N );"),n.push("      return normalize( tsn * mapN );"),n.push("}"),n.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),n.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),n.push("}"),n.push("struct IncidentLight {"),n.push("   vec3 color;"),n.push("   vec3 direction;"),n.push("};"),n.push("struct ReflectedLight {"),n.push("   vec3 diffuse;"),n.push("   vec3 specular;"),n.push("};"),n.push("struct Geometry {"),n.push("   vec3 position;"),n.push("   vec3 viewNormal;"),n.push("   vec3 worldNormal;"),n.push("   vec3 viewEyeDir;"),n.push("};"),n.push("struct Material {"),n.push("   vec3  diffuseColor;"),n.push("   float specularRoughness;"),n.push("   vec3  specularColor;"),n.push("   float shine;"),n.push("};"),n.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),n.push("   float r = ggxRoughness + 0.0001;"),n.push("   return (2.0 / (r * r) - 2.0);"),n.push("}"),n.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),n.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),n.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),n.push("}"),s.reflectionMaps.length>0&&(n.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),n.push("   vec3 envMapColor = sRGBToLinear(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),n.push("  return envMapColor;"),n.push("}")),n.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),n.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),n.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),n.push("}"),n.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   return 1.0 / ( gl * gv );"),n.push("}"),n.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   return 0.5 / max( gv + gl, EPSILON );"),n.push("}"),n.push("float D_GGX(const in float alpha, const in float dotNH) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),n.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float alpha = ( roughness * roughness );"),n.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),n.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),n.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),n.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),n.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),n.push("   vec3  F = F_Schlick( specularColor, dotLH );"),n.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),n.push("   float D = D_GGX( alpha, dotNH );"),n.push("   return F * (G * D);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),n.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),n.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),n.push("   vec4 r = roughness * c0 + c1;"),n.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),n.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),n.push("   return specularColor * AB.x + AB.y;"),n.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(n.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(n.push("   vec3 irradiance = sRGBToLinear(texture(lightMap, geometry.worldNormal)).rgb;"),n.push("   irradiance *= PI;"),n.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.diffuse +=  irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(n.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),n.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),n.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),n.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),n.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),n.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),n.push("}")),n.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),n.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),n.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),n.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),n.push("}"),n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,t=i.getNumAllocatedSectionPlanes();e<t;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");o?(n.push("  if (dist > (0.002 * vClipPosition.w)) {"),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&n.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("  return;"),n.push("}")):(n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }")),n.push("}")}n.push("IncidentLight  light;"),n.push("Material       material;"),n.push("Geometry       geometry;"),n.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),n.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),n.push("float opacity = float(vColor.a) / 255.0;"),n.push("vec3  baseColor = rgb;"),n.push("float specularF0 = 1.0;"),n.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),n.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),n.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),n.push("vec4 colorTexel = sRGBToLinear(texture(uColorMap, vUV));"),n.push("baseColor *= colorTexel.rgb;"),n.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),n.push("metallic *= metalRoughTexel.b;"),n.push("roughness *= metalRoughTexel.g;"),n.push("vec3 viewNormal = perturbNormal2Arb(vViewPosition.xyz, normalize(vViewNormal), vUV );"),n.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),n.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),n.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),n.push("geometry.position      = vViewPosition.xyz;"),n.push("geometry.viewNormal    = -normalize(viewNormal);"),n.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&n.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&n.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?n.push("light.direction =  normalize(lightDir"+e+");"):n.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?n.push("light.direction =  normalize(lightPos"+e+" - vViewPosition.xyz);"):n.push("light.direction =  normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==t.type)continue;"view"===t.space?n.push("light.direction =  normalize(lightDir"+e+");"):n.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}n.push("light.color =  lightColor"+e+".rgb * lightColor"+e+".a;"),n.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return n.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),n.push("float aoFactor = texture(uAOMap, vUV).r;"),n.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),n.push("vec4 fragColor;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   fragColor               = vec4(outgoingLight.rgb * ambient * aoFactor, opacity);")):n.push("   fragColor            = vec4(outgoingLight.rgb * aoFactor, opacity);"),t&&n.push("fragColor = linearToGamma(fragColor, gammaFactor);"),n.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}class Xr extends Dr{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching pick flat normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i,3),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Triangles batching pick flat normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("in vec4 vWorldPosition;"),i){s.push("in float vFlags;");for(var r=0;r<t.getNumAllocatedSectionPlanes();r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("      if (sectionPlaneActive"+e+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`  outNormal = ivec4(worldNormal * float(${d.MAX_INT}), 1.0);`),s.push("}"),s}}class Kr extends Dr{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles batching color texture vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in vec2 uv;"),i.push("in float flags;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),this._addMatricesUniformBlockLines(i),i.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 vColor;"),i.push("out vec2 vUV;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._lightsState,s=e._sectionPlanesState,r=s.getNumAllocatedSectionPlanes()>0,o=this._useAlphaCutoff,n=[];if(n.push("#version 300 es"),n.push("// Triangles batching color texture fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uColorMap;"),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),r){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;");for(let e=0,t=s.getNumAllocatedSectionPlanes();e<t;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";");n.push("uniform float sliceThickness;"),n.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(n),n.push("uniform vec4 lightAmbient;");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];"ambient"!==t.type&&(n.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&n.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&n.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(n.push("uniform vec3 lightPos"+e+";"),n.push("uniform vec3 lightDir"+e+";")))}if(o&&n.push("uniform float materialAlphaCutoff;"),n.push("in vec4 vViewPosition;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),n.push("  vec4 newColor;"),n.push("  newColor = vColor;"),r){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,t=s.getNumAllocatedSectionPlanes();e<t;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > sliceThickness) { "),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      newColor = sliceColor;"),n.push("  }"),n.push("}")}n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?n.push("viewLightDir = normalize(lightDir"+e+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?n.push("viewLightDir = -normalize(lightPos"+e+" - vViewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==t.type)continue;"view"===t.space?n.push("viewLightDir = normalize(lightDir"+e+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}}return n.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),n.push("vec4 sampleColor = texture(uColorMap, vUV);"),o&&(n.push("if (sampleColor.a < materialAlphaCutoff) {"),n.push("   discard;"),n.push("}")),t&&n.push("sampleColor = sRGBToLinear(sampleColor);"),n.push("vec4 colorTexel = color * sampleColor;"),n.push("float opacity = color.a;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor                = vec4(colorTexel.rgb * ambient, opacity);")):n.push("   outColor                = vec4(colorTexel.rgb, opacity);"),t&&n.push("outColor = linearToGamma(outColor, gammaFactor);"),e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}const Zr=d.vec3(),Jr=d.vec3(),Yr=d.vec3(),qr=d.vec3(),$r=d.mat4();class eo extends Tr{drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=t.aabb,u=e.pickViewMatrix||o.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));const p=Zr;let f,m;if(p[0]=d.safeInv(h[3]-h[0])*d.MAX_INT,p[1]=d.safeInv(h[4]-h[1])*d.MAX_INT,p[2]=d.safeInv(h[5]-h[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(p[0]),e.snapPickCoordinateScale[1]=d.safeInv(p[1]),e.snapPickCoordinateScale[2]=d.safeInv(p[2]),l||0!==A[0]||0!==A[1]||0!==A[2]){const t=Jr;if(l){const e=Yr;d.transformPoint3(c,l,e),t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=A[0],t[1]+=A[1],t[2]+=A[2],f=Ye(u,t,$r),m=qr,m[0]=o.eye[0]-t[0],m[1]=o.eye[1]-t[1],m[2]=o.eye[2]-t[2],e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else f=u,m=o.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,m),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,p),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let g=0;this._matricesUniformBlockBufferData.set(c,0),this._matricesUniformBlockBufferData.set(f,g+=16),this._matricesUniformBlockBufferData.set(o.projMatrix,g+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,g+=16),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}this.setSectionPlanesStateUniforms(t),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0),a.indicesBuf.unbind(),n.bindVertexArray(null)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// VBO SnapBatchingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// VBO SnapBatchingDepthBufInitRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),i.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push(`outNormal = ivec4(worldNormal * float(${d.MAX_INT}), 1.0);`),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const to=d.vec3(),io=d.vec3(),so=d.vec3(),ro=d.vec3(),oo=d.mat4();class no extends Tr{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=t.aabb,u=e.pickViewMatrix||o.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));const p=to;let f,m;if(p[0]=d.safeInv(h[3]-h[0])*d.MAX_INT,p[1]=d.safeInv(h[4]-h[1])*d.MAX_INT,p[2]=d.safeInv(h[5]-h[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(p[0]),e.snapPickCoordinateScale[1]=d.safeInv(p[1]),e.snapPickCoordinateScale[2]=d.safeInv(p[2]),l||0!==A[0]||0!==A[1]||0!==A[2]){const t=io;if(l){const e=so;d.transformPoint3(c,l,e),t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=A[0],t[1]+=A[1],t[2]+=A[2],f=Ye(u,t,oo),m=ro,m[0]=o.eye[0]-t[0],m[1]=o.eye[1]-t[1],m[2]=o.eye[2]-t[2],e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else f=u,m=o.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,m),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,p),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let g=0;this._matricesUniformBlockBufferData.set(c,0),this._matricesUniformBlockBufferData.set(f,g+=16),this._matricesUniformBlockBufferData.set(o.projMatrix,g+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,g+=16),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}this.setSectionPlanesStateUniforms(t),"edge"===e.snapMode?a.edgeIndicesBuf&&(a.edgeIndicesBuf.bind(),n.drawElements(n.LINES,a.edgeIndicesBuf.numItems,a.edgeIndicesBuf.itemType,0),a.edgeIndicesBuf.unbind()):n.drawArrays(n.POINTS,0,a.positionsBuf.numItems),n.bindVertexArray(null)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;const i=[];return i.push("#version 300 es"),i.push("// SnapBatchingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(2.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// SnapBatchingDepthRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class ao{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._colorTextureRendererAlphaCutoff&&!this._colorTextureRendererAlphaCutoff.getValid()&&(this._colorTextureRendererAlphaCutoff.destroy(),this._colorTextureRendererAlphaCutoff=null),this._colorTextureRendererWithSAOAlphaCutoff&&!this._colorTextureRendererWithSAOAlphaCutoff.getValid()&&(this._colorTextureRendererWithSAOAlphaCutoff.destroy(),this._colorTextureRendererWithSAOAlphaCutoff=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!1===this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}eagerCreateRenders(){this._silhouetteRenderer||(this._silhouetteRenderer=new Ur(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new Nr(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new Vr(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new eo(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new no(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Sr(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Sr(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new Rr(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new Rr(this._scene,!0)),this._flatColorRendererWithSAO}get colorTextureRenderer(){return this._colorTextureRenderer||(this._colorTextureRenderer=new Kr(this._scene,!1)),this._colorTextureRenderer}get colorTextureRendererWithSAO(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new Kr(this._scene,!0)),this._colorTextureRendererWithSAO}get colorTextureRendererAlphaCutoff(){return this._colorTextureRendererAlphaCutoff||(this._colorTextureRendererAlphaCutoff=new Kr(this._scene,!1,{useAlphaCutoff:!0})),this._colorTextureRendererAlphaCutoff}get colorTextureRendererWithSAOAlphaCutoff(){return this._colorTextureRendererWithSAOAlphaCutoff||(this._colorTextureRendererWithSAOAlphaCutoff=new Kr(this._scene,!0,{useAlphaCutoff:!0})),this._colorTextureRendererWithSAOAlphaCutoff}get pbrRenderer(){return this._pbrRenderer||(this._pbrRenderer=new Wr(this._scene,!1)),this._pbrRenderer}get pbrRendererWithSAO(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new Wr(this._scene,!0)),this._pbrRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Ur(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new jr(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new Gr(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new kr(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Or(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Nr(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Qr(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Xr(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Vr(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Hr(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new zr(this._scene)),this._shadowRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new no(this._scene)),this._snapRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new eo(this._scene)),this._snapInitRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererAlphaCutoff&&this._colorTextureRendererAlphaCutoff.destroy(),this._colorTextureRendererWithSAOAlphaCutoff&&this._colorTextureRendererWithSAOAlphaCutoff.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const lo={};let Ao=65536,co=5e6;class ho{constructor(){}set doublePrecisionEnabled(e){d.setDoublePrecisionEnabled(e)}get doublePrecisionEnabled(){return d.getDoublePrecisionEnabled()}set maxDataTextureHeight(e){(e=1024*Math.ceil(e/1024))>4096?e=4096:e<1024&&(e=1024),Ao=e}get maxDataTextureHeight(){return Ao}set maxGeometryBatchSize(e){e<1e5?e=1e5:e>5e6&&(e=5e6),co=e}get maxGeometryBatchSize(){return co}}const uo=new ho;class po{constructor(e=uo.maxGeometryBatchSize){this.maxVerts=e,this.maxIndices=3*e,this.positions=[],this.colors=[],this.uv=[],this.metallicRoughness=[],this.normals=[],this.pickColors=[],this.offsets=[],this.indices=[],this.edgeIndices=[]}}const fo=d.mat4(),mo=d.mat4();function go(e,t,i){const s=e.length,r=new Uint16Array(s),o=t[0],n=t[1],a=t[2],l=t[3]-o,A=t[4]-n,c=t[5]-a,h=65525,u=h/l,p=h/A,f=h/c,m=e=>e>=0?e:0;for(let t=0;t<s;t+=3)r[t+0]=Math.floor(m(e[t+0]-o)*u),r[t+1]=Math.floor(m(e[t+1]-n)*p),r[t+2]=Math.floor(m(e[t+2]-a)*f);return d.identityMat4(fo),d.translationMat4v(t,fo),d.identityMat4(mo),d.scalingMat4v([l/h,A/h,c/h],mo),d.mulMat4(fo,mo,i),r}function _o(e,t){const i=e[0],s=e[1],r=e[2],o=e[3]-i,n=e[4]-s,a=e[5]-r,l=65525;return d.identityMat4(fo),d.translationMat4v(e,fo),d.identityMat4(mo),d.scalingMat4v([o/l,n/l,a/l],mo),d.mulMat4(fo,mo,t),t}function vo(e,t,i){let s=e[0]/(Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2])),r=e[1]/(Math.abs(e[0])+Math.abs(e[1])+Math.abs(e[2]));if(e[2]<0){let e=s,t=r;e=(1-Math.abs(r))*(s>=0?1:-1),t=(1-Math.abs(s))*(r>=0?1:-1),s=e,r=t}return new Int8Array([Math[t](127.5*s+(s<0?-1:0)),Math[i](127.5*r+(r<0?-1:0))])}function bo(e){let t=e[0],i=e[1];t/=t<0?127:128,i/=i<0?127:128;const s=1-Math.abs(t)-Math.abs(i);s<0&&(t=(1-Math.abs(i))*(t>=0?1:-1),i=(1-Math.abs(t))*(i>=0?1:-1));const r=Math.sqrt(t*t+i*i+s*s);return[t/r,i/r,s/r]}const yo=d.mat4(),wo=d.mat4(),Bo=d.vec4([0,0,0,1]),Po=d.vec3(),xo=d.vec3(),Co=d.vec3(),Mo=d.vec3(),Eo=d.vec3(),Fo=d.vec3(),Io=d.vec3();class To{constructor(e){this.model=e.model,this.sortId="TrianglesBatchingLayer"+(e.solid?"-solid":"-surface")+(e.autoNormals?"-autonormals":"-normals")+(e.textureSet&&e.textureSet.colorTexture?"-colorTexture":"")+(e.textureSet&&e.textureSet.metallicRoughnessTexture?"-metallicRoughnessTexture":""),this.layerIndex=e.layerIndex,this._renderers=function(e){const t=e.id;let i=lo[t];return i||(i=new ao(e),lo[t]=i,i._compile(),i.eagerCreateRenders(),e.on("compile",(()=>{i._compile(),i.eagerCreateRenders()})),e.on("destroyed",(()=>{delete lo[t],i._destroy()}))),i}(e.model.scene),this._buffer=new po(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new ae({origin:d.vec3(),positionsBuf:null,offsetsBuf:null,normalsBuf:null,colorsBuf:null,uvBuf:null,metallicRoughnessBuf:null,flagsBuf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,textureSet:e.textureSet,pbrSupported:!1}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=d.collapseAABB3(),this._portions=[],this._meshes=[],this._numVerts=0,this._aabb=d.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,e.positionsDecodeMatrix&&(this._state.positionsDecodeMatrix=d.mat4(e.positionsDecodeMatrix)),e.uvDecodeMatrix?(this._state.uvDecodeMatrix=d.mat3(e.uvDecodeMatrix),this._preCompressedUVsExpected=!0):this._preCompressedUVsExpected=!1,e.origin&&this._state.origin.set(e.origin),this.solid=!!e.solid,this.primitive=e.primitive}get aabb(){if(this.aabbDirty){d.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)d.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e,t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts&&this._buffer.indices.length+t<this._buffer.maxIndices}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=t.positions,s=t.positionsCompressed,r=t.normals,o=t.normalsCompressed,n=t.uv,a=t.uvCompressed,l=t.colors,A=t.colorsCompressed,c=t.indices,h=t.edgeIndices,u=t.color,p=t.metallic,f=t.roughness,m=t.opacity,g=t.meshMatrix,_=t.pickColor,v=this.model.scene,b=this._buffer,y=b.positions.length/3;let w;if(d.expandAABB3(this._modelAABB,t.aabb),this._state.positionsDecodeMatrix){if(!s)throw"positionsCompressed expected";w=s.length/3;for(let e=0,t=s.length;e<t;e++)b.positions.push(s[e])}else{if(!i)throw"positions expected";w=i.length/3;for(let e=0,t=i.length;e<t;e++)b.positions.push(i[e])}if(o&&o.length>0)for(let e=0,t=o.length;e<t;e++)b.normals.push(o[e]);else if(r&&r.length>0){const e=yo;g?d.inverseMat4(d.transposeMat4(g,wo),e):d.identityMat4(e,e),function(e,t,i,s,r){function o(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}let n,a,l,A,c,h,u=new Float32Array([0,0,0,0]),p=new Float32Array([0,0,0,0]);for(h=0;h<i;h+=3)u[0]=t[h],u[1]=t[h+1],u[2]=t[h+2],d.transformVec3(e,u,p),d.normalizeVec3(p,p),l=n=vo(p,"floor","floor"),a=bo(n),A=c=o(p,a),n=vo(p,"ceil","floor"),a=bo(n),A=o(p,a),A>c&&(l=n,c=A),n=vo(p,"floor","ceil"),a=bo(n),A=o(p,a),A>c&&(l=n,c=A),n=vo(p,"ceil","ceil"),a=bo(n),A=o(p,a),A>c&&(l=n,c=A),s[r+h+0]=l[0],s[r+h+1]=l[1],s[r+h+2]=0}(e,r,r.length,b.normals,b.normals.length)}if(l)for(let e=0,t=l.length;e<t;e+=3)b.colors.push(255*l[e]),b.colors.push(255*l[e+1]),b.colors.push(255*l[e+2]),b.colors.push(255);else if(A)for(let e=0,t=l.length;e<t;e+=3)b.colors.push(l[e]),b.colors.push(l[e+1]),b.colors.push(l[e+2]),b.colors.push(255);else if(u){const e=u[0],t=u[1],i=u[2],s=m;for(let r=0;r<w;r++)b.colors.push(e),b.colors.push(t),b.colors.push(i),b.colors.push(s)}const B=null!=p?p:0,P=null!=f?f:255;for(let e=0;e<w;e++)b.metallicRoughness.push(B),b.metallicRoughness.push(P);if(n&&n.length>0)for(let e=0,t=n.length;e<t;e++)b.uv.push(n[e]);else if(a&&a.length>0)for(let e=0,t=a.length;e<t;e++)b.uv.push(a[e]);for(let e=0,t=c.length;e<t;e++)b.indices.push(y+c[e]);if(h)for(let e=0,t=h.length;e<t;e++)b.edgeIndices.push(y+h[e]);{const e=b.pickColors.length;for(let t=e,i=e+4*w;t<i;t+=4)b.pickColors.push(_[0]),b.pickColors.push(_[1]),b.pickColors.push(_[2]),b.pickColors.push(_[3])}if(v.entityOffsetsEnabled)for(let e=0;e<w;e++)b.offsets.push(0),b.offsets.push(0),b.offsets.push(0);const x=this._portions.length,C={vertsBaseIndex:y,numVerts:w,indicesBaseIndex:b.indices.length-c.length,numIndices:c.length};return v.readableGeometryEnabled&&(C.indices=c,v.entityOffsetsEnabled&&(C.offset=new Float32Array(3))),this._portions.push(C),this._numPortions++,this.model.numPortions++,this._numVerts+=C.numVerts,this._meshes.push(e),x}finalize(){if(this._finalized)return;const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0){const s=this._state.positionsDecodeMatrix?new Uint16Array(i.positions):go(i.positions,this._modelAABB,this._state.positionsDecodeMatrix=d.mat4());if(e.positionsBuf=new le(t,t.ARRAY_BUFFER,s,s.length,3,t.STATIC_DRAW),this.model.scene.readableGeometryEnabled)for(let e=0,t=this._portions.length;e<t;e++){const t=this._portions[e],i=3*t.vertsBaseIndex,r=i+3*t.numVerts;t.quantizedPositions=s.slice(i,r)}}if(i.normals.length>0){const s=new Int8Array(i.normals);let r=!0;e.normalsBuf=new le(t,t.ARRAY_BUFFER,s,i.normals.length,3,t.STATIC_DRAW,r)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let r=!1;e.colorsBuf=new le(t,t.ARRAY_BUFFER,s,i.colors.length,4,t.DYNAMIC_DRAW,r)}if(i.uv.length>0)if(e.uvDecodeMatrix){let s=!1;e.uvBuf=new le(t,t.ARRAY_BUFFER,i.uv,i.uv.length,2,t.STATIC_DRAW,s)}else{const s=me.getUVBounds(i.uv),r=me.compressUVs(i.uv,s.min,s.max),o=r.quantized;let n=!1;e.uvDecodeMatrix=d.mat3(r.decodeMatrix),e.uvBuf=new le(t,t.ARRAY_BUFFER,o,o.length,2,t.STATIC_DRAW,n)}if(i.metallicRoughness.length>0){const s=new Uint8Array(i.metallicRoughness);let r=!1;e.metallicRoughnessBuf=new le(t,t.ARRAY_BUFFER,s,i.metallicRoughness.length,2,t.STATIC_DRAW,r)}if(i.positions.length>0){const s=i.positions.length/3,r=new Float32Array(s),o=!1;e.flagsBuf=new le(t,t.ARRAY_BUFFER,r,r.length,1,t.DYNAMIC_DRAW,o)}if(i.pickColors.length>0){const s=new Uint8Array(i.pickColors);let r=!1;e.pickColorsBuf=new le(t,t.ARRAY_BUFFER,s,i.pickColors.length,4,t.STATIC_DRAW,r)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);e.offsetsBuf=new le(t,t.ARRAY_BUFFER,s,i.offsets.length,3,t.DYNAMIC_DRAW)}if(i.indices.length>0){const s=new Uint32Array(i.indices);e.indicesBuf=new le(t,t.ELEMENT_ARRAY_BUFFER,s,i.indices.length,1,t.STATIC_DRAW)}if(i.edgeIndices.length>0){const s=new Uint32Array(i.edgeIndices);e.edgeIndicesBuf=new le(t,t.ELEMENT_ARRAY_BUFFER,s,i.edgeIndices.length,1,t.STATIC_DRAW)}this._state.pbrSupported=!!(e.metallicRoughnessBuf&&e.uvBuf&&e.normalsBuf&&e.textureSet&&e.textureSet.colorTexture&&e.textureSet.metallicRoughnessTexture),this._state.colorTextureSupported=!!e.uvBuf&&!!e.textureSet&&!!e.textureSet.colorTexture,this._buffer=null,this._finalized=!0}isEmpty(){return!this._state.indicesBuf}initFlags(e,t,i){t&fr&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&yr&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&br&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&wr&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&_r&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Br&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&gr&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&mr&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,i,!0)}flushInitFlags(){this._setDeferredFlags()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&fr?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&yr?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&br?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&wr?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&Br?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&_r?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&mr?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&gr?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";const i=e,s=this._portions[i],r=4*s.vertsBaseIndex,o=4*s.numVerts,n=this._scratchMemory.getUInt8Array(o),a=t[0],l=t[1],A=t[2],c=t[3];for(let e=0;e<o;e+=4)n[e+0]=a,n[e+1]=l,n[e+2]=A,n[e+3]=c;this._state.colorsBuf&&this._state.colorsBuf.setData(n,r,o)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const r=e,o=this._portions[r],n=o.vertsBaseIndex,a=o.numVerts,l=!!(t&fr),A=!!(t&br),c=!!(t&yr),h=!!(t&wr),u=!!(t&Br),d=!!(t&gr),p=!!(t&mr);let f,m;f=!l||p||A||c&&!this.model.scene.highlightMaterial.glowThrough||h&&!this.model.scene.selectedMaterial.glowThrough?Pr.NOT_RENDERED:i?Pr.COLOR_TRANSPARENT:Pr.COLOR_OPAQUE,m=!l||p?Pr.NOT_RENDERED:h?Pr.SILHOUETTE_SELECTED:c?Pr.SILHOUETTE_HIGHLIGHTED:A?Pr.SILHOUETTE_XRAYED:Pr.NOT_RENDERED;let g=0;g=!l||p?Pr.NOT_RENDERED:h?Pr.EDGES_SELECTED:c?Pr.EDGES_HIGHLIGHTED:A?Pr.EDGES_XRAYED:u?i?Pr.EDGES_COLOR_TRANSPARENT:Pr.EDGES_COLOR_OPAQUE:Pr.NOT_RENDERED;let _=l&&!p&&d?Pr.PICK:Pr.NOT_RENDERED;const v=t&_r?1:0;if(s){this._deferredFlagValues||(this._deferredFlagValues=new Float32Array(this._numVerts));for(let e=n,t=n+a;e<t;e++){let t=0;t|=f,t|=m<<4,t|=g<<8,t|=_<<12,t|=v<<16,this._deferredFlagValues[e]=t}}else if(this._state.flagsBuf){const e=this._scratchMemory.getFloat32Array(a);for(let t=0;t<a;t++){let i=0;i|=f,i|=m<<4,i|=g<<8,i|=_<<12,i|=v<<16,e[t]=i}this._state.flagsBuf.setData(e,n,a)}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const i=e,s=this._portions[i],r=3*s.vertsBaseIndex,o=3*s.numVerts,n=this._scratchMemory.getFloat32Array(o),a=t[0],l=t[1],A=t[2];for(let e=0;e<o;e+=3)n[e+0]=a,n[e+1]=l,n[e+2]=A;this._state.offsetsBuf&&this._state.offsetsBuf.setData(n,r,o),this.model.scene.readableGeometryEnabled&&(s.offset[0]=t[0],s.offset[1]=t[1],s.offset[2]=t[2])}getEachVertex(e,t){if(!this.model.scene.readableGeometryEnabled)return;const i=this._state,s=this._portions[e];if(!s)return void this.model.error("portion not found: "+e);const r=s.quantizedPositions,o=this.model.matrix,n=d.vec4();n.set(i.origin,0),n[3]=1,d.mulMat4v4(o,n,n);const a=n[0],l=n[1],A=n[2],c=Bo,h=i.positionsDecodeMatrix;for(let e=0,i=r.length;e<i;e+=3)c[0]=r[e],c[1]=r[e+1],c[2]=r[e+2],c[3]=1,d.decompressPosition(c,h),c[3]=1,d.mulMat4v4(o,c,c),c[0]+=a,c[1]+=l,c[2]+=A,t(c)}getEachIndex(e,t){if(!this.model.scene.readableGeometryEnabled)return;const i=this._portions[e];if(!i)return void this.model.error("portion not found: "+e);const s=i.indices;for(let e=0,i=s.length;e<i;e++)t(s[e])}getElementsCountAndOffset(e){let t=null,i=null;const s=this._portions[e];return s&&(t=s.numIndices,i=s.indicesBaseIndex),{count:t,offset:i}}readGeometryData(e){if(!this._finalized)throw"Not finalized";const t=this._portions[e],i=this._state,s=this.model.matrix,r=i.positionsDecodeMatrix,o=d.vec4();o.set(i.origin,0),o[3]=1,d.mulMat4v4(s,o,o);const n=i.indicesBuf.getData(t.indicesBaseIndex,t.numIndices).map((e=>e-t.vertsBaseIndex)),a=d.mulMat4(s,r,new Array(16));a[12]+=o[0],a[13]+=o[1],a[14]+=o[2];const l=i.positionsBuf.getData(t.vertsBaseIndex,t.numVerts);return{indices:n,positions:d.transformPositions3(a,l,new Array(l.length))}}drawColorOpaque(e,t){if(this._numCulledLayerPortions===this._numPortions||0===this._numVisibleLayerPortions||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions)return;this._updateBackfaceCull(e,t);const i=this._state.textureSet&&"number"==typeof this._state.textureSet.alphaCutoff;t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRendererWithSAO&&this._renderers.pbrRendererWithSAO.drawLayer(t,this,Pr.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?i?this._renderers.colorTextureRendererWithSAOAlphaCutoff&&this._renderers.colorTextureRendererWithSAOAlphaCutoff.drawLayer(t,this,Pr.COLOR_OPAQUE):this._renderers.colorTextureRendererWithSAO&&this._renderers.colorTextureRendererWithSAO.drawLayer(t,this,Pr.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(t,this,Pr.COLOR_OPAQUE):this._renderers.flatColorRendererWithSAO&&this._renderers.flatColorRendererWithSAO.drawLayer(t,this,Pr.COLOR_OPAQUE):t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?i?this._renderers.colorTextureRendererAlphaCutoff&&this._renderers.colorTextureRendererAlphaCutoff.drawLayer(t,this,Pr.COLOR_OPAQUE):this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE)}_updateBackfaceCull(e,t){if(true!==t.backfaces){const e=t.gl;e.disable(e.CULL_FACE),t.backfaces=true}}drawColorTransparent(e,t){if(this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions)if(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported)this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT);else if(t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported){this._state.textureSet&&"number"==typeof this._state.textureSet.alphaCutoff?this._renderers.colorTextureRendererAlphaCutoff&&this._renderers.colorTextureRendererAlphaCutoff.drawLayer(t,this,Pr.COLOR_TRANSPARENT):this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT)}else this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT)}drawDepth(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}drawNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_XRAYED))}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_HIGHLIGHTED))}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_SELECTED))}drawEdgesColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,Pr.EDGES_COLOR_OPAQUE)}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,Pr.EDGES_COLOR_TRANSPARENT)}drawEdgesHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Pr.EDGES_HIGHLIGHTED)}drawEdgesSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Pr.EDGES_SELECTED)}drawEdgesXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Pr.EDGES_XRAYED)}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}drawShadow(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,Pr.PICK))}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,Pr.PICK))}drawPickNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickNormalsFlatRenderer&&this._renderers.pickNormalsFlatRenderer.drawLayer(t,this,Pr.PICK))}drawSnapInit(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Pr.PICK))}drawSnap(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Pr.PICK))}precisionRayPickSurface(e,t,i,s,r){if(!this.model.scene.readableGeometryEnabled)return!1;const o=this._state,n=this._portions[e];if(!n)return this.model.error("portion not found: "+e),!1;const a=n.quantizedPositions,l=n.indices,A=o.origin,c=n.offset,h=Po,u=xo;h.set(A?d.subVec3(t,A,Co):t),u.set(i),c&&d.subVec3(h,c),d.transformRay(this.model.worldNormalMatrix,h,u,h,u);const p=Mo,f=Eo,m=Fo;let g=!1,_=0;const v=Io;for(let e=0,i=l.length;e<i;e+=3){const i=3*l[e],n=3*l[e+1],b=3*l[e+2];if(p[0]=a[i],p[1]=a[i+1],p[2]=a[i+2],f[0]=a[n],f[1]=a[n+1],f[2]=a[n+2],m[0]=a[b],m[1]=a[b+1],m[2]=a[b+2],d.decompressPosition(p,o.positionsDecodeMatrix),d.decompressPosition(f,o.positionsDecodeMatrix),d.decompressPosition(m,o.positionsDecodeMatrix),d.rayTriangleIntersect(h,u,p,f,m,v)){d.transformPoint3(this.model.worldMatrix,v,v),c&&d.addVec3(v,c),A&&d.addVec3(v,A);const e=Math.abs(d.lenVec3(d.subVec3(v,t,[])));(!g||e>_)&&(_=e,s.set(v),r&&d.triangleNormal(p,f,m,r),g=!0)}}return g&&r&&(d.transformVec3(this.model.worldNormalMatrix,r,r),d.normalizeVec3(r)),g}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.normalsBuf&&(e.normalsBuf.destroy(),e.normalsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicessBuf=null),e.edgeIndicesBuf&&(e.edgeIndicesBuf.destroy(),e.edgeIndicessBuf=null),e.destroy()}}class Do extends Tr{constructor(e,t,{edges:i=!1,useAlphaCutoff:s=!1}={}){super(e,t,{instancing:!0,edges:i,useAlphaCutoff:s})}_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:r}=e;this._edges?i.edgeIndicesBuf&&t.drawElementsInstanced(t.LINES,i.edgeIndicesBuf.numItems,i.edgeIndicesBuf.itemType,0,i.numInstances):(t.drawElementsInstanced(t.TRIANGLES,i.indicesBuf.numItems,i.indicesBuf.itemType,0,i.numInstances),r&&s.drawElements++)}}class So extends Do{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0;let r,o,n;const a=[];for(a.push("#version 300 es"),a.push("// Instancing geometry drawing vertex shader"),a.push("uniform int renderPass;"),a.push("in vec3 position;"),a.push("in vec2 normal;"),a.push("in vec4 color;"),a.push("in float flags;"),e.entityOffsetsEnabled&&a.push("in vec3 offset;"),a.push("in vec4 modelMatrixCol0;"),a.push("in vec4 modelMatrixCol1;"),a.push("in vec4 modelMatrixCol2;"),a.push("in vec4 modelNormalMatrixCol0;"),a.push("in vec4 modelNormalMatrixCol1;"),a.push("in vec4 modelNormalMatrixCol2;"),this._addMatricesUniformBlockLines(a,!0),e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),a.push("out float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("out float isPerspective;")),a.push("uniform vec4 lightAmbient;"),r=0,o=i.lights.length;r<o;r++)n=i.lights[r],"ambient"!==n.type&&(a.push("uniform vec4 lightColor"+r+";"),"dir"===n.type&&a.push("uniform vec3 lightDir"+r+";"),"point"===n.type&&a.push("uniform vec3 lightPos"+r+";"),"spot"===n.type&&(a.push("uniform vec3 lightPos"+r+";"),a.push("uniform vec3 lightDir"+r+";")));for(a.push("vec3 octDecode(vec2 oct) {"),a.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),a.push("    if (v.z < 0.0) {"),a.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),a.push("    }"),a.push("    return normalize(v);"),a.push("}"),s&&(a.push("out vec4 vWorldPosition;"),a.push("out float vFlags;")),a.push("out vec4 vColor;"),a.push("void main(void) {"),a.push("int colorFlag = int(flags) & 0xF;"),a.push("if (colorFlag != renderPass) {"),a.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),a.push("} else {"),a.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),a.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix * worldPosition; "),a.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),a.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),a.push("vec3 viewNormal = normalize(vec4(viewNormalMatrix * worldNormal).xyz);"),a.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),a.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),a.push("float lambertian = 1.0;"),r=0,o=i.lights.length;r<o;r++)if(n=i.lights[r],"ambient"!==n.type){if("dir"===n.type)"view"===n.space?a.push("viewLightDir = normalize(lightDir"+r+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+r+", 0.0)).xyz);");else if("point"===n.type)"view"===n.space?a.push("viewLightDir = -normalize(lightPos"+r+" - viewPosition.xyz);"):a.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+r+", 0.0)).xyz);");else{if("spot"!==n.type)continue;"view"===n.space?a.push("viewLightDir = normalize(lightDir"+r+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+r+", 0.0)).xyz);")}a.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),a.push("reflectedColor += lambertian * (lightColor"+r+".rgb * lightColor"+r+".a);")}return a.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),a.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(a.push("vFragDepth = 1.0 + clipPos.w;"),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(a.push("vWorldPosition = worldPosition;"),a.push("vFlags = flags;")),a.push("gl_Position = clipPos;"),a.push("}"),a.push("}"),a}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";");s.push("uniform float sliceThickness;"),s.push("uniform vec4 sliceColor;")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec4 newColor;"),s.push("  newColor = vColor;"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > sliceThickness) { "),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      newColor = sliceColor;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled?(s.push("    float dx = dFdx(vFragDepth);"),s.push("    float dy = dFdy(vFragDepth);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;")):(s.push("    float dx = dFdx(gl_FragCoord.z);"),s.push("    float dy = dFdy(gl_FragCoord.z);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = gl_FragCoord.z + diff;")),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor                = vec4(newColor.rgb * ambient, 1.0);")):s.push("    outColor           = newColor;"),s.push("}"),s}}class Ro extends Do{_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry flat-shading drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in float flags;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState;let s,r;const o=t.getNumAllocatedSectionPlanes()>0,n=[];if(n.push("#version 300 es"),n.push("// Instancing geometry flat-shading drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),o){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";");n.push("uniform float sliceThickness;"),n.push("uniform vec4 sliceColor;")}for(this._addMatricesUniformBlockLines(n),n.push("uniform vec4 lightAmbient;"),s=0,r=i.lights.length;s<r;s++){const e=i.lights[s];"ambient"!==e.type&&(n.push("uniform vec4 lightColor"+s+";"),"dir"===e.type&&n.push("uniform vec3 lightDir"+s+";"),"point"===e.type&&n.push("uniform vec3 lightPos"+s+";"),"spot"===e.type&&(n.push("uniform vec3 lightPos"+s+";"),n.push("uniform vec3 lightDir"+s+";")))}if(n.push("in vec4 vViewPosition;"),n.push("in vec4 vColor;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),n.push("  vec4 newColor;"),n.push("  newColor = vColor;"),o){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > sliceThickness) { "),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      newColor = sliceColor;"),n.push("  }"),n.push("}")}for(n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),s=0,r=i.lights.length;s<r;s++){const e=i.lights[s];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?n.push("viewLightDir = normalize(lightDir"+s+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+s+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?n.push("viewLightDir = -normalize(lightPos"+s+" - vViewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+s+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?n.push("viewLightDir = normalize(lightDir"+s+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+s+", 0.0)).xyz);")}n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+s+".rgb * lightColor"+s+".a);")}}return n.push("vec4 fragColor = vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor            = vec4(fragColor.rgb * ambient, 1.0);")):n.push("    outColor           = fragColor;"),e.logarithmicDepthBufferEnabled?n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"):(n.push("    float dx = dFdx(gl_FragCoord.z);"),n.push("    float dy = dFdy(gl_FragCoord.z);"),n.push("    float diff = sqrt(dx*dx+dy*dy);"),n.push("    gl_FragDepth = gl_FragCoord.z + diff;")),n.push("}"),n}}class Uo extends Do{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 color;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec4 silhouetteColor;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),i.push("if (silhouetteFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vColor = vec4(silhouetteColor.r, silhouetteColor.g, silhouetteColor.b, min(silhouetteColor.a, float(color.a) / 255.0));"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing fill fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";");s.push("uniform float sliceThickness;"),s.push("uniform vec4 sliceColor;")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec4 newColor;"),s.push("  newColor = vColor;"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > sliceThickness) { "),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      newColor = sliceColor;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = newColor;"),s.push("}"),s}}class Lo extends Do{constructor(e,t){super(e,t,{instancing:!0,edges:!0})}}class ko extends Lo{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// EdgesEmphasisRenderer vertex shader"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeFlag = int(flags) >> 8 & 0xF;"),i.push("if (edgeFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// EdgesEmphasisRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class Oo extends Lo{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!1})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// EdgesColorRenderer vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeFlag = int(flags) >> 8 & 0xF;"),i.push("if (edgeFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// EdgesColorRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class No extends Do{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry picking vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 pickColor;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry picking fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vPickColor; "),s.push("}"),s}}class Vo extends Do{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry depth vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("  vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}}class Qo extends Do{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec2 normal;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("in vec4 modelNormalMatrixCol0;"),i.push("in vec4 modelNormalMatrixCol1;"),i.push("in vec4 modelNormalMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i,3),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),i.push("  vWorldNormal = worldNormal;"),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec3 vWorldNormal;"),s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var r=0;r<t.getNumAllocatedSectionPlanes();r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push(`    outNormal = ivec4(vWorldNormal * float(${d.MAX_INT}), 1.0);`),s.push("}"),s}}class Ho extends Do{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// TrianglesInstancingOcclusionRenderer vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// TrianglesInstancingOcclusionRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("if (sectionPlaneActive"+t+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),i.push("}"),i}}class jo extends Do{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry depth drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const r=t.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Instancing geometry depth drawing fragment shader"),o.push("precision highp float;"),o.push("precision highp int;"),e.logarithmicDepthBufferEnabled&&(o.push("in float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("in vec2 vHighPrecisionZW;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return e.logarithmicDepthBufferEnabled&&o.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),o.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),o.push("}"),o}}class Go extends Do{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry normals drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec3 normal;"),i.push("in vec4 color;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i,!0),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec3 vViewNormal;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("  vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}}class zo extends Do{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry shadow drawing vertex shader"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(i),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("bool visible = (colorFlag > 0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}}const Wo={3e3:"linearToLinear",3001:"sRGBToLinear"};class Xo extends Do{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0,r=t.clippingCaps,o=[];return o.push("#version 300 es"),o.push("// Instancing geometry quality drawing vertex shader"),o.push("uniform int renderPass;"),o.push("in vec3 position;"),o.push("in vec3 normal;"),o.push("in vec4 color;"),o.push("in vec2 uv;"),o.push("in vec2 metallicRoughness;"),o.push("in float flags;"),e.entityOffsetsEnabled&&o.push("in vec3 offset;"),o.push("in vec4 modelMatrixCol0;"),o.push("in vec4 modelMatrixCol1;"),o.push("in vec4 modelMatrixCol2;"),o.push("in vec4 modelNormalMatrixCol0;"),o.push("in vec4 modelNormalMatrixCol1;"),o.push("in vec4 modelNormalMatrixCol2;"),this._addMatricesUniformBlockLines(o,!0),o.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("out float isPerspective;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("out vec4 vViewPosition;"),o.push("out vec3 vViewNormal;"),o.push("out vec4 vColor;"),o.push("out vec2 vUV;"),o.push("out vec2 vMetallicRoughness;"),i.lightMaps.length>0&&o.push("out vec3 vWorldNormal;"),s&&(o.push("out vec4 vWorldPosition;"),o.push("out float vFlags;"),r&&o.push("out vec4 vClipPosition;")),o.push("void main(void) {"),o.push("int colorFlag = int(flags) & 0xF;"),o.push("if (colorFlag != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),o.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 1.0);"),o.push("vec3 viewNormal = vec4(viewNormalMatrix * worldNormal).xyz;"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags = flags;"),r&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),o.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._sectionPlanesState,s=e._lightsState,r=i.getNumAllocatedSectionPlanes()>0,o=i.clippingCaps,n=[];n.push("#version 300 es"),n.push("// Instancing geometry quality drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uColorMap;"),n.push("uniform sampler2D uMetallicRoughMap;"),n.push("uniform sampler2D uEmissiveMap;"),n.push("uniform sampler2D uNormalMap;"),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),s.reflectionMaps.length>0&&n.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&n.push("uniform samplerCube lightMap;"),n.push("uniform vec4 lightAmbient;");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];"ambient"!==t.type&&(n.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&n.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&n.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(n.push("uniform vec3 lightPos"+e+";"),n.push("uniform vec3 lightDir"+e+";")))}if(n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),r){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;"),o&&n.push("in vec4 vClipPosition;");for(let e=0,t=i.getNumAllocatedSectionPlanes();e<t;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";")}if(n.push("in vec4 vViewPosition;"),n.push("in vec3 vViewNormal;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("in vec2 vMetallicRoughness;"),s.lightMaps.length>0&&n.push("in vec3 vWorldNormal;"),this._addMatricesUniformBlockLines(n,!0),n.push("#define PI 3.14159265359"),n.push("#define RECIPROCAL_PI 0.31830988618"),n.push("#define RECIPROCAL_PI2 0.15915494"),n.push("#define EPSILON 1e-6"),n.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),n.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),n.push("       vec3 texel = texture( uNormalMap, uv ).xyz;"),n.push("       if (texel.r == 0.0 && texel.g == 0.0 && texel.b == 0.0) {"),n.push("              return normalize(surf_norm );"),n.push("       }"),n.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),n.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),n.push("      vec2 st0 = dFdx( uv.st );"),n.push("      vec2 st1 = dFdy( uv.st );"),n.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),n.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),n.push("      vec3 N = normalize( surf_norm );"),n.push("      vec3 mapN = texel.xyz * 2.0 - 1.0;"),n.push("      mat3 tsn = mat3( S, T, N );"),n.push("      return normalize( tsn * mapN );"),n.push("}"),n.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),n.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),n.push("}"),n.push("struct IncidentLight {"),n.push("   vec3 color;"),n.push("   vec3 direction;"),n.push("};"),n.push("struct ReflectedLight {"),n.push("   vec3 diffuse;"),n.push("   vec3 specular;"),n.push("};"),n.push("struct Geometry {"),n.push("   vec3 position;"),n.push("   vec3 viewNormal;"),n.push("   vec3 worldNormal;"),n.push("   vec3 viewEyeDir;"),n.push("};"),n.push("struct Material {"),n.push("   vec3    diffuseColor;"),n.push("   float   specularRoughness;"),n.push("   vec3    specularColor;"),n.push("   float   shine;"),n.push("};"),n.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),n.push("   float r = ggxRoughness + 0.0001;"),n.push("   return (2.0 / (r * r) - 2.0);"),n.push("}"),n.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),n.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),n.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),n.push("}"),s.reflectionMaps.length>0&&(n.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),n.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),n.push("   vec3 envMapColor = "+Wo[s.reflectionMaps[0].encoding]+"(texture(reflectionMap, reflectVec, mipLevel)).rgb;"),n.push("  return envMapColor;"),n.push("}")),n.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),n.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),n.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),n.push("}"),n.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   return 1.0 / ( gl * gv );"),n.push("}"),n.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),n.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),n.push("   return 0.5 / max( gv + gl, EPSILON );"),n.push("}"),n.push("float D_GGX(const in float alpha, const in float dotNH) {"),n.push("   float a2 = ( alpha * alpha );"),n.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),n.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float alpha = ( roughness * roughness );"),n.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),n.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),n.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),n.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),n.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),n.push("   vec3  F = F_Schlick( specularColor, dotLH );"),n.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),n.push("   float D = D_GGX( alpha, dotNH );"),n.push("   return F * (G * D);"),n.push("}"),n.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),n.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),n.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),n.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),n.push("   vec4 r = roughness * c0 + c1;"),n.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),n.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),n.push("   return specularColor * AB.x + AB.y;"),n.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(n.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(n.push("   vec3 irradiance = "+Wo[s.lightMaps[0].encoding]+"(texture(lightMap, geometry.worldNormal)).rgb;"),n.push("   irradiance *= PI;"),n.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(n.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),n.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),n.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),n.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),n.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),n.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),n.push("}")),n.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),n.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),n.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),n.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),n.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),n.push("}"),n.push("out vec4 outColor;"),n.push("void main(void) {"),r){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,t=i.getNumAllocatedSectionPlanes();e<t;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");o?(n.push("  if (dist > (0.002 * vClipPosition.w)) {"),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      outColor=vec4(1.0, 0.0, 0.0, 1.0);"),e.logarithmicDepthBufferEnabled&&n.push("  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("  return;"),n.push("}")):(n.push("  if (dist > 0.0) { "),n.push("      discard;"),n.push("  }")),n.push("}")}n.push("IncidentLight  light;"),n.push("Material       material;"),n.push("Geometry       geometry;"),n.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),n.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),n.push("float opacity = float(vColor.a) / 255.0;"),n.push("vec3  baseColor = rgb;"),n.push("float specularF0 = 1.0;"),n.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),n.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),n.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),n.push("vec4 colorTexel = sRGBToLinear(texture(uColorMap, vUV));"),n.push("baseColor *= colorTexel.rgb;"),n.push("vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;"),n.push("metallic *= metalRoughTexel.b;"),n.push("roughness *= metalRoughTexel.g;"),n.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition.xyz, normalize(vViewNormal), vUV );"),n.push("material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),n.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),n.push("material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);"),n.push("geometry.position      = vViewPosition.xyz;"),n.push("geometry.viewNormal    = -normalize(viewNormal);"),n.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&n.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&n.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let e=0,t=s.lights.length;e<t;e++){const t=s.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?n.push("light.direction = normalize(lightDir"+e+");"):n.push("light.direction = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?n.push("light.direction = normalize(lightPos"+e+" - vViewPosition.xyz);"):n.push("light.direction = normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==t.type)continue;"view"===t.space?n.push("light.direction = normalize(lightDir"+e+");"):n.push("light.direction = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}n.push("light.color =  lightColor"+e+".rgb * lightColor"+e+".a;"),n.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return n.push("vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;"),n.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;"),n.push("vec4 fragColor;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   fragColor            = vec4(outgoingLight.rgb * ambient, opacity);")):n.push("   fragColor            = vec4(outgoingLight.rgb, opacity);"),t&&n.push("fragColor = linearToGamma(fragColor, gammaFactor);"),n.push("outColor = fragColor;"),e.logarithmicDepthBufferEnabled&&n.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}class Ko extends Do{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry normals vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),this._addRemapClipPosLines(i,3),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&i.push("out float vFlags;"),i.push("out vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&i.push("vFlags = flags;"),i.push("gl_Position = remapClipPos(clipPos);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Batched geometry normals fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("in vec4 vWorldPosition;"),i){s.push("in float vFlags;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("out highp ivec4 outNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var r=0;r<t.getNumAllocatedSectionPlanes();r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push(`  outNormal = ivec4(worldNormal * float(${d.MAX_INT}), 1.0);`),s.push("}"),s}}class Zo extends Do{_getHash(){const e=this._scene;return[e.gammaOutput,e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry drawing vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in vec2 uv;"),i.push("in float flags;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),i.push("uniform mat3 uvDecodeMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vViewPosition;"),i.push("out vec4 vColor;"),i.push("out vec2 vUV;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e.gammaOutput,i=e._lightsState,s=e._sectionPlanesState,r=s.getNumAllocatedSectionPlanes()>0,o=this._useAlphaCutoff,n=[];if(n.push("#version 300 es"),n.push("// Instancing geometry drawing fragment shader"),n.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),n.push("precision highp float;"),n.push("precision highp int;"),n.push("#else"),n.push("precision mediump float;"),n.push("precision mediump int;"),n.push("#endif"),e.logarithmicDepthBufferEnabled&&(n.push("in float isPerspective;"),n.push("uniform float logDepthBufFC;"),n.push("in float vFragDepth;")),n.push("uniform sampler2D uColorMap;"),this._withSAO&&(n.push("uniform sampler2D uOcclusionTexture;"),n.push("uniform vec4      uSAOParams;"),n.push("const float       packUpscale = 256. / 255.;"),n.push("const float       unpackDownScale = 255. / 256.;"),n.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),n.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),n.push("float unpackRGBToFloat( const in vec4 v ) {"),n.push("    return dot( v, unPackFactors );"),n.push("}")),n.push("uniform float gammaFactor;"),n.push("vec4 linearToLinear( in vec4 value ) {"),n.push("  return value;"),n.push("}"),n.push("vec4 sRGBToLinear( in vec4 value ) {"),n.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),n.push("}"),n.push("vec4 gammaToLinear( in vec4 value) {"),n.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),n.push("}"),t&&(n.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),n.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),n.push("}")),r){n.push("in vec4 vWorldPosition;"),n.push("in float vFlags;");for(let e=0,t=s.getNumAllocatedSectionPlanes();e<t;e++)n.push("uniform bool sectionPlaneActive"+e+";"),n.push("uniform vec3 sectionPlanePos"+e+";"),n.push("uniform vec3 sectionPlaneDir"+e+";");n.push("uniform float sliceThickness;"),n.push("uniform vec4 sliceColor;")}this._addMatricesUniformBlockLines(n),n.push("uniform vec4 lightAmbient;");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];"ambient"!==t.type&&(n.push("uniform vec4 lightColor"+e+";"),"dir"===t.type&&n.push("uniform vec3 lightDir"+e+";"),"point"===t.type&&n.push("uniform vec3 lightPos"+e+";"),"spot"===t.type&&(n.push("uniform vec3 lightPos"+e+";"),n.push("uniform vec3 lightDir"+e+";")))}if(o&&n.push("uniform float materialAlphaCutoff;"),n.push("in vec4 vViewPosition;"),n.push("in vec4 vColor;"),n.push("in vec2 vUV;"),n.push("out vec4 outColor;"),n.push("void main(void) {"),n.push("  vec4 newColor;"),n.push("  newColor = vColor;"),r){n.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),n.push("  if (clippable) {"),n.push("  float dist = 0.0;");for(let e=0,t=s.getNumAllocatedSectionPlanes();e<t;e++)n.push("if (sectionPlaneActive"+e+") {"),n.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),n.push("}");n.push("  if (dist > sliceThickness) { "),n.push("      discard;"),n.push("  }"),n.push("  if (dist > 0.0) { "),n.push("      newColor = sliceColor;"),n.push("  }"),n.push("}")}n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),n.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),n.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),n.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let e=0,t=i.lights.length;e<t;e++){const t=i.lights[e];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?n.push("viewLightDir = normalize(lightDir"+e+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?n.push("viewLightDir = -normalize(lightPos"+e+" - vViewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==t.type)continue;"view"===t.space?n.push("viewLightDir = normalize(lightDir"+e+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}}return n.push("vec4 color =  vec4((lightAmbient.rgb * lightAmbient.a * newColor.rgb) + (reflectedColor * newColor.rgb), newColor.a);"),n.push("vec4 sampleColor = texture(uColorMap, vUV);"),o&&(n.push("if (sampleColor.a < materialAlphaCutoff) {"),n.push("   discard;"),n.push("}")),t&&n.push("sampleColor = sRGBToLinear(sampleColor);"),n.push("vec4 colorTexel = color * sampleColor;"),n.push("float opacity = color.a;"),this._withSAO?(n.push("   float viewportWidth     = uSAOParams[0];"),n.push("   float viewportHeight    = uSAOParams[1];"),n.push("   float blendCutoff       = uSAOParams[2];"),n.push("   float blendFactor       = uSAOParams[3];"),n.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),n.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),n.push("   outColor                = vec4(colorTexel.rgb * ambient, opacity);")):n.push("   outColor                = vec4(colorTexel.rgb, opacity);"),t&&n.push("outColor = linearToGamma(outColor, gammaFactor);"),e.logarithmicDepthBufferEnabled&&n.push("gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),n.push("}"),n}}const Jo=d.vec3(),Yo=d.vec3(),qo=d.vec3(),$o=d.vec3(),en=d.mat4();class tn extends Tr{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.canvas.gl,n=r.camera,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=t.aabb,u=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?o.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));const p=Jo;let f,m;if(p[0]=d.safeInv(h[3]-h[0])*d.MAX_INT,p[1]=d.safeInv(h[4]-h[1])*d.MAX_INT,p[2]=d.safeInv(h[5]-h[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(p[0]),e.snapPickCoordinateScale[1]=d.safeInv(p[1]),e.snapPickCoordinateScale[2]=d.safeInv(p[2]),l||0!==A[0]||0!==A[1]||0!==A[2]){const t=Yo;if(l){const e=d.transformPoint3(c,l,qo);t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=A[0],t[1]+=A[1],t[2]+=A[2],f=Ye(u,t,en),m=$o,m[0]=n.eye[0]-t[0],m[1]=n.eye[1]-t[1],m[2]=n.eye[2]-t[2],e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else f=u,m=n.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;o.uniform3fv(this._uCameraEyeRtc,m),o.uniform2fv(this.uVectorA,e.snapVectorA),o.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),o.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),o.uniform3fv(this._uCoordinateScaler,p),o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);let g=0;this._matricesUniformBlockBufferData.set(c,0),this._matricesUniformBlockBufferData.set(f,g+=16),this._matricesUniformBlockBufferData.set(n.projMatrix,g+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,g+=16),o.bindBuffer(o.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),o.bufferData(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,o.DYNAMIC_DRAW),o.bindBufferBase(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,t)}this.setSectionPlanesStateUniforms(t),a.indicesBuf.bind(),o.drawElementsInstanced(o.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0,a.numInstances),a.indicesBuf.unbind(),o.bindVertexArray(null)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// SnapInstancingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vWorldPosition = worldPosition;"),t&&i.push("  vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Points instancing pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("if (sectionPlaneActive"+t+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),i.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push(`outNormal = ivec4(worldNormal * float(${d.MAX_INT}), 1.0);`),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const sn=d.vec3(),rn=d.vec3(),on=d.vec3(),nn=d.vec3(),an=d.mat4();class ln extends Tr{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=t.aabb,u=e.pickViewMatrix||o.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));const p=sn;let f,m;if(p[0]=d.safeInv(h[3]-h[0])*d.MAX_INT,p[1]=d.safeInv(h[4]-h[1])*d.MAX_INT,p[2]=d.safeInv(h[5]-h[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(p[0]),e.snapPickCoordinateScale[1]=d.safeInv(p[1]),e.snapPickCoordinateScale[2]=d.safeInv(p[2]),l||0!==A[0]||0!==A[1]||0!==A[2]){const t=rn;if(l){const e=d.transformPoint3(c,l,on);t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=A[0],t[1]+=A[1],t[2]+=A[2],f=Ye(u,t,an),m=nn,m[0]=o.eye[0]-t[0],m[1]=o.eye[1]-t[1],m[2]=o.eye[2]-t[2],e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else f=u,m=o.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,m),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,p),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let g=0;this._matricesUniformBlockBufferData.set(c,0),this._matricesUniformBlockBufferData.set(f,g+=16),this._matricesUniformBlockBufferData.set(o.projMatrix,g+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,g+=16),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}this.setSectionPlanesStateUniforms(t),"edge"===e.snapMode?a.edgeIndicesBuf&&(a.edgeIndicesBuf.bind(),n.drawElementsInstanced(n.LINES,a.edgeIndicesBuf.numItems,a.edgeIndicesBuf.itemType,0,a.numInstances),a.edgeIndicesBuf.unbind()):n.drawArraysInstanced(n.POINTS,0,a.positionsBuf.numItems,a.numInstances),n.bindVertexArray(null)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// SnapInstancingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(2.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// SnapInstancingDepthRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("if (sectionPlaneActive"+t+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class An{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorTextureRenderer&&!this._colorTextureRenderer.getValid()&&(this._colorTextureRenderer.destroy(),this._colorTextureRenderer=null),this._colorTextureRendererWithSAO&&!this._colorTextureRendererWithSAO.getValid()&&(this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererWithSAO=null),this._colorTextureRendererAlphaCutoff&&!this._colorTextureRendererAlphaCutoff.getValid()&&(this._colorTextureRendererAlphaCutoff.destroy(),this._colorTextureRendererAlphaCutoff=null),this._colorTextureRendererWithSAOAlphaCutoff&&!this._colorTextureRendererWithSAOAlphaCutoff.getValid()&&(this._colorTextureRendererWithSAOAlphaCutoff.destroy(),this._colorTextureRendererWithSAOAlphaCutoff=null),this._pbrRenderer&&!this._pbrRenderer.getValid()&&(this._pbrRenderer.destroy(),this._pbrRenderer=null),this._pbrRendererWithSAO&&!this._pbrRendererWithSAO.getValid()&&(this._pbrRendererWithSAO.destroy(),this._pbrRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!1===this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}eagerCreateRenders(){this._silhouetteRenderer||(this._silhouetteRenderer=new Uo(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new No(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new Vo(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new tn(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new ln(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new So(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new So(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new Ro(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new Ro(this._scene,!0)),this._flatColorRendererWithSAO}get colorTextureRenderer(){return this._colorTextureRenderer||(this._colorTextureRenderer=new Zo(this._scene,!1)),this._colorTextureRenderer}get colorTextureRendererWithSAO(){return this._colorTextureRendererWithSAO||(this._colorTextureRendererWithSAO=new Zo(this._scene,!0)),this._colorTextureRendererWithSAO}get colorTextureRendererAlphaCutoff(){return this._colorTextureRendererAlphaCutoff||(this._colorTextureRendererAlphaCutoff=new Zo(this._scene,!1,{useAlphaCutoff:!0})),this._colorTextureRendererAlphaCutoff}get colorTextureRendererWithSAOAlphaCutoff(){return this._colorTextureRendererWithSAOAlphaCutoff||(this._colorTextureRendererWithSAOAlphaCutoff=new Zo(this._scene,!0,{useAlphaCutoff:!0})),this._colorTextureRendererWithSAOAlphaCutoff}get pbrRenderer(){return this._pbrRenderer||(this._pbrRenderer=new Xo(this._scene,!1)),this._pbrRenderer}get pbrRendererWithSAO(){return this._pbrRendererWithSAO||(this._pbrRendererWithSAO=new Xo(this._scene,!0)),this._pbrRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Uo(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new jo(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new Go(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new ko(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Oo(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new No(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Qo(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Ko(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Vo(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Ho(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new zo(this._scene)),this._shadowRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new ln(this._scene)),this._snapRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new tn(this._scene)),this._snapInitRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorTextureRenderer&&this._colorTextureRenderer.destroy(),this._colorTextureRendererWithSAO&&this._colorTextureRendererWithSAO.destroy(),this._colorTextureRendererAlphaCutoff&&this._colorTextureRendererAlphaCutoff.destroy(),this._colorTextureRendererWithSAOAlphaCutoff&&this._colorTextureRendererWithSAOAlphaCutoff.destroy(),this._pbrRenderer&&this._pbrRenderer.destroy(),this._pbrRendererWithSAO&&this._pbrRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const cn={};const hn=new Uint8Array(4),un=new Float32Array(1),dn=d.vec4([0,0,0,1]),pn=new Float32Array(3),fn=d.vec3(),mn=d.vec3(),gn=d.vec3(),_n=d.vec3(),vn=d.vec3(),bn=d.vec3(),yn=d.vec3(),wn=new Float32Array(4);class Bn{constructor(e){this.model=e.model,this.sortId="TrianglesInstancingLayer"+(e.solid?"-solid":"-surface")+(e.normals?"-normals":"-autoNormals"),this.layerIndex=e.layerIndex,this._renderers=function(e){const t=e.id;let i=cn[t];return i||(i=new An(e),cn[t]=i,i._compile(),i.eagerCreateRenders(),e.on("compile",(()=>{i._compile(),i.eagerCreateRenders()})),e.on("destroyed",(()=>{delete cn[t],i._destroy()}))),i}(e.model.scene),this._aabb=d.collapseAABB3(),this._state=new ae({numInstances:0,obb:d.OBB3(),origin:d.vec3(),geometry:e.geometry,textureSet:e.textureSet,pbrSupported:!1,positionsDecodeMatrix:e.geometry.positionsDecodeMatrix,colorsBuf:null,metallicRoughnessBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null,modelNormalMatrixCol0Buf:null,modelNormalMatrixCol1Buf:null,modelNormalMatrixCol2Buf:null,pickColorsBuf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._colors=[],this._metallicRoughness=[],this._pickColors=[],this._offsets=[],this._modelMatrix=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=d.collapseAABB3(),this.aabbDirty=!0,e.origin&&this._state.origin.set(e.origin),this._finalized=!1,this.solid=!!e.solid,this.numIndices=e.geometry.numIndices,this.primitive=e.geometry.primitive}get aabb(){if(this.aabbDirty){d.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)d.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}createPortion(e,t){const i=t.color,s=t.metallic,r=t.roughness,o=null!==t.opacity&&void 0!==t.opacity?t.opacity:255,n=t.meshMatrix,a=t.pickColor;if(this._finalized)throw"Already finalized";const l=i[0],A=i[1],c=i[2];if(this._colors.push(l),this._colors.push(A),this._colors.push(c),this._colors.push(o),this._metallicRoughness.push(null!=s?s:0),this._metallicRoughness.push(null!=r?r:255),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(n[0]),this._modelMatrixCol0.push(n[4]),this._modelMatrixCol0.push(n[8]),this._modelMatrixCol0.push(n[12]),this._modelMatrixCol1.push(n[1]),this._modelMatrixCol1.push(n[5]),this._modelMatrixCol1.push(n[9]),this._modelMatrixCol1.push(n[13]),this._modelMatrixCol2.push(n[2]),this._modelMatrixCol2.push(n[6]),this._modelMatrixCol2.push(n[10]),this._modelMatrixCol2.push(n[14]),this._state.geometry.normals){let e=d.transposeMat4(n,d.mat4()),t=d.inverseMat4(e);this._modelNormalMatrixCol0.push(t[0]),this._modelNormalMatrixCol0.push(t[4]),this._modelNormalMatrixCol0.push(t[8]),this._modelNormalMatrixCol0.push(t[12]),this._modelNormalMatrixCol1.push(t[1]),this._modelNormalMatrixCol1.push(t[5]),this._modelNormalMatrixCol1.push(t[9]),this._modelNormalMatrixCol1.push(t[13]),this._modelNormalMatrixCol2.push(t[2]),this._modelNormalMatrixCol2.push(t[6]),this._modelNormalMatrixCol2.push(t[10]),this._modelNormalMatrixCol2.push(t[14])}this._pickColors.push(a[0]),this._pickColors.push(a[1]),this._pickColors.push(a[2]),this._pickColors.push(a[3]),this._state.numInstances++;const h=this._portions.length,u={};return this.model.scene.readableGeometryEnabled&&(u.matrix=n.slice(),u.inverseMatrix=null,u.normalMatrix=null),this._portions.push(u),this._numPortions++,this.model.numPortions++,this._meshes.push(e),h}finalize(){if(this._finalized)return;const e=this._state,t=e.geometry,i=e.textureSet,s=this.model.scene.canvas.gl,r=this._colors.length,o=r/4;if(r>0){let t=!1;e.colorsBuf=new le(s,s.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,s.DYNAMIC_DRAW,t),this._colors=[]}if(this._metallicRoughness.length>0){const t=new Uint8Array(this._metallicRoughness);let i=!1;e.metallicRoughnessBuf=new le(s,s.ARRAY_BUFFER,t,this._metallicRoughness.length,2,s.STATIC_DRAW,i)}if(o>0){let t=!1;e.flagsBuf=new le(s,s.ARRAY_BUFFER,new Float32Array(o),o,1,s.DYNAMIC_DRAW,t)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const t=!1;e.offsetsBuf=new le(s,s.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,s.DYNAMIC_DRAW,t),this._offsets=[]}if(t.positionsCompressed&&t.positionsCompressed.length>0){const i=!1;e.positionsBuf=new le(s,s.ARRAY_BUFFER,t.positionsCompressed,t.positionsCompressed.length,3,s.STATIC_DRAW,i),e.positionsDecodeMatrix=d.mat4(t.positionsDecodeMatrix)}if(t.colorsCompressed&&t.colorsCompressed.length>0){const i=new Uint8Array(t.colorsCompressed),r=!1;e.colorsBuf=new le(s,s.ARRAY_BUFFER,i,i.length,4,s.STATIC_DRAW,r)}if(t.uvCompressed&&t.uvCompressed.length>0){const i=t.uvCompressed;e.uvDecodeMatrix=t.uvDecodeMatrix,e.uvBuf=new le(s,s.ARRAY_BUFFER,i,i.length,2,s.STATIC_DRAW,!1)}if(t.indices&&t.indices.length>0&&(e.indicesBuf=new le(s,s.ELEMENT_ARRAY_BUFFER,new Uint32Array(t.indices),t.indices.length,1,s.STATIC_DRAW),e.numIndices=t.indices.length),t.edgeIndices&&t.edgeIndices.length>0&&(e.edgeIndicesBuf=new le(s,s.ELEMENT_ARRAY_BUFFER,new Uint32Array(t.edgeIndices),t.edgeIndices.length,1,s.STATIC_DRAW)),this._modelMatrixCol0.length>0){const t=!1;e.modelMatrixCol0Buf=new le(s,s.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,s.STATIC_DRAW,t),e.modelMatrixCol1Buf=new le(s,s.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,s.STATIC_DRAW,t),e.modelMatrixCol2Buf=new le(s,s.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,s.STATIC_DRAW,t),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],e.normalsBuf&&(e.modelNormalMatrixCol0Buf=new le(s,s.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,s.STATIC_DRAW,t),e.modelNormalMatrixCol1Buf=new le(s,s.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,s.STATIC_DRAW,t),e.modelNormalMatrixCol2Buf=new le(s,s.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,s.STATIC_DRAW,t),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[])}if(this._pickColors.length>0){const t=!1;e.pickColorsBuf=new le(s,s.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,s.STATIC_DRAW,t),this._pickColors=[]}e.pbrSupported=!!(e.metallicRoughnessBuf&&e.uvBuf&&e.normalsBuf&&i&&i.colorTexture&&i.metallicRoughnessTexture),e.colorTextureSupported=!!e.uvBuf&&!!i&&!!i.colorTexture,this.model.scene.readableGeometryEnabled||(this._state.geometry=null),this._finalized=!0}initFlags(e,t,i){t&fr&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&yr&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&br&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&wr&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&_r&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Br&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&gr&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&mr&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&fr?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&yr?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&br?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&wr?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&Br?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&_r?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&gr?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&mr?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";hn[0]=t[0],hn[1]=t[1],hn[2]=t[2],hn[3]=t[3],this._state.colorsBuf&&this._state.colorsBuf.setData(hn,4*e)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=!!(t&fr),r=!!(t&br),o=!!(t&yr),n=!!(t&wr),a=!!(t&Br),l=!!(t&gr),A=!!(t&mr);let c,h;c=!s||A||r||o&&!this.model.scene.highlightMaterial.glowThrough||n&&!this.model.scene.selectedMaterial.glowThrough?Pr.NOT_RENDERED:i?Pr.COLOR_TRANSPARENT:Pr.COLOR_OPAQUE,h=!s||A?Pr.NOT_RENDERED:n?Pr.SILHOUETTE_SELECTED:o?Pr.SILHOUETTE_HIGHLIGHTED:r?Pr.SILHOUETTE_XRAYED:Pr.NOT_RENDERED;let u=0;u=!s||A?Pr.NOT_RENDERED:n?Pr.EDGES_SELECTED:o?Pr.EDGES_HIGHLIGHTED:r?Pr.EDGES_XRAYED:a?i?Pr.EDGES_COLOR_TRANSPARENT:Pr.EDGES_COLOR_OPAQUE:Pr.NOT_RENDERED;let d=0;d|=c,d|=h<<4,d|=u<<8,d|=(s&&!A&&l?Pr.PICK:Pr.NOT_RENDERED)<<12,d|=(t&_r?1:0)<<16,un[0]=d,this._state.flagsBuf&&this._state.flagsBuf.setData(un,e)}setOffset(e,t){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(pn[0]=t[0],pn[1]=t[1],pn[2]=t[2],this._state.offsetsBuf&&this._state.offsetsBuf.setData(pn,3*e)):this.model.error("Entity#offset not enabled for this Viewer")}getEachVertex(e,t){if(!this.model.scene.readableGeometryEnabled)return!1;const i=this._state,s=i.geometry,r=this._portions[e];if(!r)return void this.model.error("portion not found: "+e);const o=s.positionsCompressed,n=this.model.matrix,a=d.vec4();a.set(i.origin,0),a[3]=1,d.mulMat4v4(n,a,a);const l=a[0],A=a[1],c=a[2],h=dn,u=r.matrix,p=i.positionsDecodeMatrix;for(let e=0,i=o.length;e<i;e+=3)h[0]=o[e],h[1]=o[e+1],h[2]=o[e+2],d.decompressPosition(h,p),d.transformPoint3(u,h,h),h[3]=1,d.mulMat4v4(n,h,h),h[0]+=l,h[1]+=A,h[2]+=c,t(h)}getEachIndex(e,t){if(!this.model.scene.readableGeometryEnabled)return!1;const i=this._state.geometry;if(!this._portions[e])return void this.model.error("portion not found: "+e);const s=i.indices;for(let e=0,i=s.length;e<i;e++)t(s[e])}setMatrix(e,t){if(!this._finalized)throw"Not finalized";var i=4*e;wn[0]=t[0],wn[1]=t[4],wn[2]=t[8],wn[3]=t[12],this._state.modelMatrixCol0Buf.setData(wn,i),wn[0]=t[1],wn[1]=t[5],wn[2]=t[9],wn[3]=t[13],this._state.modelMatrixCol1Buf.setData(wn,i),wn[0]=t[2],wn[1]=t[6],wn[2]=t[10],wn[3]=t[14],this._state.modelMatrixCol2Buf.setData(wn,i)}readGeometryData(e){if(!this._finalized)throw"Not finalized";const t=this._state,i=this.model.matrix,s=t.modelMatrixCol0Buf.getData(e,1),r=t.modelMatrixCol1Buf.getData(e,1),o=t.modelMatrixCol2Buf.getData(e,1),n=[s[0],r[0],o[0],0,s[1],r[1],o[1],0,s[2],r[2],o[2],0,s[3],r[3],o[3],1],a=t.positionsDecodeMatrix,l=d.vec4();l.set(t.origin,0),l[3]=1,d.mulMat4v4(i,l,l);const A=t.indicesBuf.getData(),c=d.mulMat4(n,a,new Array(16));d.mulMat4(i,c,c),c[12]+=l[0],c[13]+=l[1],c[14]+=l[2];const h=t.positionsBuf.getData();return{indices:A,positions:d.transformPositions3(c,h,new Array(h.length))}}drawColorOpaque(e,t){if(this._numCulledLayerPortions===this._numPortions||0===this._numVisibleLayerPortions||this._numTransparentLayerPortions===this._numPortions||this._numXRayedLayerPortions===this._numPortions)return;this._updateBackfaceCull(e,t);const i=this._state.textureSet&&"number"==typeof this._state.textureSet.alphaCutoff;t.withSAO&&this.model.saoEnabled?t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRendererWithSAO&&this._renderers.pbrRendererWithSAO.drawLayer(t,this,Pr.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?i?this._renderers.colorTextureRendererWithSAOAlphaCutoff&&this._renderers.colorTextureRendererWithSAOAlphaCutoff.drawLayer(t,this,Pr.COLOR_OPAQUE):this._renderers.colorTextureRendererWithSAO&&this._renderers.colorTextureRendererWithSAO.drawLayer(t,this,Pr.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(t,this,Pr.COLOR_OPAQUE):this._renderers.flatColorRendererWithSAO&&this._renderers.flatColorRendererWithSAO.drawLayer(t,this,Pr.COLOR_OPAQUE):t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?i?this._renderers.colorTextureRendererAlphaCutoff&&this._renderers.colorTextureRendererAlphaCutoff.drawLayer(t,this,Pr.COLOR_OPAQUE):this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE)}_updateBackfaceCull(e,t){if(true!==t.backfaces){const e=t.gl;e.disable(e.CULL_FACE),t.backfaces=true}}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.pbrEnabled&&this.model.pbrEnabled&&this._state.pbrSupported?this._renderers.pbrRenderer&&this._renderers.pbrRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT):t.colorTextureEnabled&&this.model.colorTextureEnabled&&this._state.colorTextureSupported?this._renderers.colorTextureRenderer&&this._renderers.colorTextureRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT):this._state.normalsBuf?this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT):this._renderers.flatColorRenderer&&this._renderers.flatColorRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT))}drawDepth(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}drawNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_XRAYED))}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_HIGHLIGHTED))}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_SELECTED))}drawEdgesColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,Pr.EDGES_COLOR_OPAQUE)}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,Pr.EDGES_COLOR_TRANSPARENT)}drawEdgesXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Pr.EDGES_XRAYED)}drawEdgesHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Pr.EDGES_HIGHLIGHTED)}drawEdgesSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Pr.EDGES_SELECTED)}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}drawShadow(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,Pr.PICK))}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,Pr.PICK))}drawPickNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickNormalsFlatRenderer&&this._renderers.pickNormalsFlatRenderer.drawLayer(t,this,Pr.PICK))}drawSnapInit(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Pr.PICK))}drawSnap(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Pr.PICK))}precisionRayPickSurface(e,t,i,s,r){if(!this.model.scene.readableGeometryEnabled)return!1;const o=this._state.geometry,n=this._state,a=this._portions[e];if(!a)return this.model.error("portion not found: "+e),!1;a.inverseMatrix||(a.inverseMatrix=d.inverseMat4(a.matrix,d.mat4())),r&&!a.normalMatrix&&(a.normalMatrix=d.transposeMat4(a.inverseMatrix,d.mat4()));const l=o.quantizedPositions,A=o.indices,c=n.origin,h=a.offset,u=fn,p=mn;u.set(c?d.subVec3(t,c,gn):t),p.set(i),h&&d.subVec3(u,h),d.transformRay(this.model.worldNormalMatrix,u,p,u,p),d.transformRay(a.inverseMatrix,u,p,u,p);const f=_n,m=vn,g=bn;let _=!1,v=0;const b=yn;for(let e=0,i=A.length;e<i;e+=3){const i=3*A[e+0],o=3*A[e+1],y=3*A[e+2];f[0]=l[i],f[1]=l[i+1],f[2]=l[i+2],m[0]=l[o],m[1]=l[o+1],m[2]=l[o+2],g[0]=l[y],g[1]=l[y+1],g[2]=l[y+2];const{positionsDecodeMatrix:w}=n.geometry;if(d.decompressPosition(f,w),d.decompressPosition(m,w),d.decompressPosition(g,w),d.rayTriangleIntersect(u,p,f,m,g,b)){d.transformPoint3(a.matrix,b,b),d.transformPoint3(this.model.worldMatrix,b,b),h&&d.addVec3(b,h),c&&d.addVec3(b,c);const e=Math.abs(d.lenVec3(d.subVec3(b,t,[])));(!_||e>v)&&(v=e,s.set(b),r&&d.triangleNormal(f,m,g,r),_=!0)}}return _&&r&&(d.transformVec3(a.normalMatrix,r,r),d.transformVec3(this.model.worldNormalMatrix,r,r),d.normalizeVec3(r)),_}destroy(){const e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.modelNormalMatrixCol0Buf&&(e.modelNormalMatrixCol0Buf.destroy(),e.modelNormalMatrixCol0Buf=null),e.modelNormalMatrixCol1Buf&&(e.modelNormalMatrixCol1Buf.destroy(),e.modelNormalMatrixCol1Buf=null),e.modelNormalMatrixCol2Buf&&(e.modelNormalMatrixCol2Buf.destroy(),e.modelNormalMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy(),this._state=null}}class Pn extends Tr{_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:r}=e;t.drawElements(t.LINES,i.indicesBuf.numItems,i.indicesBuf.itemType,0),r&&s.drawElements++}}class xn extends Pn{drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Lines batching color vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in float flags;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Lines batching color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor            = vColor;"),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}class Cn extends Pn{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Lines batching silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),i.push("if (silhouetteFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Lines batching silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("uniform vec4 color;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = color;"),s.push("}"),s}}const Mn=d.vec3(),En=d.vec3(),Fn=d.vec3(),In=d.vec3(),Tn=d.mat4();class Dn extends Tr{drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=t.aabb,u=e.pickViewMatrix||o.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));const p=Mn;let f,m;if(p[0]=d.safeInv(h[3]-h[0])*d.MAX_INT,p[1]=d.safeInv(h[4]-h[1])*d.MAX_INT,p[2]=d.safeInv(h[5]-h[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(p[0]),e.snapPickCoordinateScale[1]=d.safeInv(p[1]),e.snapPickCoordinateScale[2]=d.safeInv(p[2]),l||0!==A[0]||0!==A[1]||0!==A[2]){const t=En;if(l){const e=Fn;d.transformPoint3(c,l,e),t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=A[0],t[1]+=A[1],t[2]+=A[2],f=Ye(u,t,Tn),m=In,m[0]=o.eye[0]-t[0],m[1]=o.eye[1]-t[1],m[2]=o.eye[2]-t[2],e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else f=u,m=o.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,m),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,p),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let g=0;this._matricesUniformBlockBufferData.set(c,0),this._matricesUniformBlockBufferData.set(f,g+=16),this._matricesUniformBlockBufferData.set(o.projMatrix,g+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,g+=16),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}this.setSectionPlanesStateUniforms(t),a.indicesBuf.bind(),n.drawElements(n.LINES,a.indicesBuf.numItems,a.indicesBuf.itemType,0),a.indicesBuf.unbind(),n.bindVertexArray(null)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// VBO SnapBatchingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// VBO SnapBatchingDepthBufInitRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),i.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push(`outNormal = ivec4(worldNormal * float(${d.MAX_INT}), 1.0);`),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Sn=d.vec3(),Rn=d.vec3(),Un=d.vec3(),Ln=d.vec3(),kn=d.mat4();class On extends Tr{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=t.aabb,u=e.pickViewMatrix||o.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));const p=Sn;let f,m;if(p[0]=d.safeInv(h[3]-h[0])*d.MAX_INT,p[1]=d.safeInv(h[4]-h[1])*d.MAX_INT,p[2]=d.safeInv(h[5]-h[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(p[0]),e.snapPickCoordinateScale[1]=d.safeInv(p[1]),e.snapPickCoordinateScale[2]=d.safeInv(p[2]),l||0!==A[0]||0!==A[1]||0!==A[2]){const t=Rn;if(l){const e=Un;d.transformPoint3(c,l,e),t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=A[0],t[1]+=A[1],t[2]+=A[2],f=Ye(u,t,kn),m=Ln,m[0]=o.eye[0]-t[0],m[1]=o.eye[1]-t[1],m[2]=o.eye[2]-t[2],e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else f=u,m=o.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,m),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,p),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let g=0;this._matricesUniformBlockBufferData.set(c,0),this._matricesUniformBlockBufferData.set(f,g+=16),this._matricesUniformBlockBufferData.set(o.projMatrix,g+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,g+=16),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}this.setSectionPlanesStateUniforms(t),"edge"===e.snapMode?(a.indicesBuf.bind(),n.drawElements(n.LINES,a.indicesBuf.numItems,a.indicesBuf.itemType,0),a.indicesBuf.unbind()):n.drawArrays(n.POINTS,0,a.positionsBuf.numItems),n.bindVertexArray(null)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;const i=[];return i.push("#version 300 es"),i.push("// SnapBatchingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(2.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// SnapBatchingDepthRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Nn{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new xn(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Cn(this._scene)),this._silhouetteRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Dn(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new On(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const Vn={};class Qn{constructor(e=5e6){e>5e6&&(e=5e6),this.maxVerts=e,this.maxIndices=3*e,this.positions=[],this.colors=[],this.offsets=[],this.indices=[]}}class Hn{constructor(e){this.layerIndex=e.layerIndex,this._renderers=function(e){const t=e.id;let i=Vn[t];return i||(i=new Nn(e),Vn[t]=i,i._compile(),e.on("compile",(()=>{i._compile()})),e.on("destroyed",(()=>{delete Vn[t],i._destroy()}))),i}(e.model.scene),this.model=e.model,this._buffer=new Qn(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new ae({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,indicesBuf:null,positionsDecodeMatrix:d.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=d.collapseAABB3(),this._portions=[],this._meshes=[],this._numVerts=0,this._aabb=d.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.origin&&(this._state.origin=d.vec3(e.origin)),this.primitive=e.primitive}get aabb(){if(this.aabbDirty){d.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)d.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e,t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+e<3*this._buffer.maxVerts&&this._buffer.indices.length+t<this._buffer.maxIndices}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=t.positions,s=t.positionsCompressed,r=t.indices,o=t.color,n=t.opacity,a=this._buffer,l=a.positions.length/3;let A;if(d.expandAABB3(this._modelAABB,t.aabb),this._preCompressedPositionsExpected){if(!s)throw"positionsCompressed expected";A=s.length/3;for(let e=0,t=s.length;e<t;e++)a.positions.push(s[e])}else{if(!i)throw"positions expected";A=i.length/3;for(let e=0,t=i.length;e<t;e++)a.positions.push(i[e])}if(o){const e=o[0],t=o[1],i=o[2],s=n;for(let r=0;r<A;r++)a.colors.push(e),a.colors.push(t),a.colors.push(i),a.colors.push(s)}if(r)for(let e=0,t=r.length;e<t;e++)a.indices.push(r[e]+l);if(this.model.scene.entityOffsetsEnabled)for(let e=0;e<A;e++)a.offsets.push(0),a.offsets.push(0),a.offsets.push(0);const c=this._portions.length/2;return this._portions.push(l),this._portions.push(A),this._numPortions++,this.model.numPortions++,this._numVerts+=A,this._meshes.push(e),c}finalize(){if(this._finalized)return;const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressedPositionsExpected){const s=new Uint16Array(i.positions);e.positionsBuf=new le(t,t.ARRAY_BUFFER,s,i.positions.length,3,t.STATIC_DRAW)}else{const s=go(new Float32Array(i.positions),this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=new le(t,t.ARRAY_BUFFER,s,i.positions.length,3,t.STATIC_DRAW)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let r=!1;e.colorsBuf=new le(t,t.ARRAY_BUFFER,s,i.colors.length,4,t.DYNAMIC_DRAW,r)}if(i.colors.length>0){const s=i.colors.length/4,r=new Float32Array(s);let o=!1;e.flagsBuf=new le(t,t.ARRAY_BUFFER,r,r.length,1,t.DYNAMIC_DRAW,o)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);e.offsetsBuf=new le(t,t.ARRAY_BUFFER,s,i.offsets.length,3,t.DYNAMIC_DRAW)}if(i.indices.length>0){const s=new Uint32Array(i.indices);e.indicesBuf=new le(t,t.ELEMENT_ARRAY_BUFFER,s,i.indices.length,1,t.STATIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(e,t,i){t&fr&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&yr&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&br&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&wr&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&_r&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Br&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&gr&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&mr&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,i,!0)}flushInitFlags(){this._setDeferredFlags()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&fr?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&yr?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&br?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&wr?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&Br?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&_r?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&mr?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&gr?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";const i=2*e,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),n=t[0],a=t[1],l=t[2],A=t[3];for(let e=0;e<r;e+=4)o[e+0]=n,o[e+1]=a,o[e+2]=l,o[e+3]=A;this._state.colorsBuf.setData(o,s,r)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const r=2*e,o=this._portions[r],n=this._portions[r+1],a=!!(t&fr),l=!!(t&br),A=!!(t&yr),c=!!(t&wr),h=!!(t&gr),u=!!(t&mr);let d,p;d=!a||u||l||A&&!this.model.scene.highlightMaterial.glowThrough||c&&!this.model.scene.selectedMaterial.glowThrough?Pr.NOT_RENDERED:i?Pr.COLOR_TRANSPARENT:Pr.COLOR_OPAQUE,p=!a||u?Pr.NOT_RENDERED:c?Pr.SILHOUETTE_SELECTED:A?Pr.SILHOUETTE_HIGHLIGHTED:l?Pr.SILHOUETTE_XRAYED:Pr.NOT_RENDERED;let f=a&&!u&&h?Pr.PICK:Pr.NOT_RENDERED;const m=t&_r?1:0;if(s){this._deferredFlagValues||(this._deferredFlagValues=new Float32Array(this._numVerts));for(let e=o,t=o+n;e<t;e++){let t=0;t|=d,t|=p<<4,t|=f<<12,t|=m<<16,this._deferredFlagValues[e]=t}}else if(this._state.flagsBuf){const e=this._scratchMemory.getFloat32Array(n);for(let t=0;t<n;t++){let i=0;i|=d,i|=p<<4,i|=f<<12,i|=m<<16,e[t]=i}this._state.flagsBuf.setData(e,o,n)}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const i=2*e,s=3*this._portions[i],r=3*this._portions[i+1],o=this._scratchMemory.getFloat32Array(r),n=t[0],a=t[1],l=t[2];for(let e=0;e<r;e+=3)o[e+0]=n,o[e+1]=a,o[e+2]=l;this._state.offsetsBuf.setData(o,s,r)}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawPickMesh(e){}drawPickDepths(e){}drawPickNormals(e){}drawSnapInit(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Pr.PICK)}drawSnap(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Pr.PICK)}drawOcclusion(e){}drawShadow(e){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.indicesBuf&&(e.indicesBuf.destroy(),e.indicesBuf=null),e.destroy()}}class jn extends Tr{constructor(e,t){super(e,t,{instancing:!0})}_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:r}=e;t.drawElementsInstanced(t.LINES,i.indicesBuf.numItems,i.indicesBuf.itemType,0,i.numInstances),r&&s.drawElements++}}class Gn extends jn{drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Lines instancing color vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),i.push("in vec4 color;"),i.push("in float flags;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),i.push("uniform vec4 lightAmbient;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int colorFlag = int(flags) & 0xF;"),i.push("if (colorFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0,  float(color.a) / 255.0);"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const r=t.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Lines instancing color fragment shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("in vec4 vColor;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture(uOcclusionTexture, uv))) * blendFactor;"),o.push("   outColor            = vec4(vColor.rgb * ambient, vColor.a);")):o.push("    outColor           = vColor;"),e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}}class zn extends jn{drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Lines instancing silhouette vertex shader"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(i),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),i.push("uniform vec4 color;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),i.push("if (silhouetteFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Lines instancing silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("uniform vec4 color;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = color;"),s.push("}"),s}}const Wn=d.vec3(),Xn=d.vec3(),Kn=d.vec3();d.vec3();const Zn=d.mat4();class Jn extends Tr{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.canvas.gl,n=r.camera,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=t.aabb,u=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?o.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));const p=Wn;let f;if(p[0]=d.safeInv(h[3]-h[0])*d.MAX_INT,p[1]=d.safeInv(h[4]-h[1])*d.MAX_INT,p[2]=d.safeInv(h[5]-h[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(p[0]),e.snapPickCoordinateScale[1]=d.safeInv(p[1]),e.snapPickCoordinateScale[2]=d.safeInv(p[2]),l||0!==A[0]||0!==A[1]||0!==A[2]){const t=Xn;if(l){const e=d.transformPoint3(c,l,Kn);t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=A[0],t[1]+=A[1],t[2]+=A[2],f=Ye(u,t,Zn),e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else f=u,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;o.uniform2fv(this.uVectorA,e.snapVectorA),o.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),o.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),o.uniform3fv(this._uCoordinateScaler,p),o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);let m=0;this._matricesUniformBlockBufferData.set(c,0),this._matricesUniformBlockBufferData.set(f,m+=16),this._matricesUniformBlockBufferData.set(n.projMatrix,m+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,m+=16),o.bindBuffer(o.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),o.bufferData(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,o.DYNAMIC_DRAW),o.bindBufferBase(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,t)}this.setSectionPlanesStateUniforms(t),a.indicesBuf.bind(),o.drawElementsInstanced(o.LINES,a.indicesBuf.numItems,a.indicesBuf.itemType,0,a.numInstances),a.indicesBuf.unbind(),o.bindVertexArray(null)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// SnapInstancingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vWorldPosition = worldPosition;"),t&&i.push("  vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Points instancing pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("if (sectionPlaneActive"+t+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Yn=d.vec3(),qn=d.vec3(),$n=d.vec3();d.vec3();const ea=d.mat4();class ta extends Tr{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=t.aabb,u=e.pickViewMatrix||o.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));const p=Yn;let f;if(p[0]=d.safeInv(h[3]-h[0])*d.MAX_INT,p[1]=d.safeInv(h[4]-h[1])*d.MAX_INT,p[2]=d.safeInv(h[5]-h[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(p[0]),e.snapPickCoordinateScale[1]=d.safeInv(p[1]),e.snapPickCoordinateScale[2]=d.safeInv(p[2]),l||0!==A[0]||0!==A[1]||0!==A[2]){const t=qn;if(l){const e=d.transformPoint3(c,l,$n);t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=A[0],t[1]+=A[1],t[2]+=A[2],f=Ye(u,t,ea),e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else f=u,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,p),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let m=0;this._matricesUniformBlockBufferData.set(c,0),this._matricesUniformBlockBufferData.set(f,m+=16),this._matricesUniformBlockBufferData.set(o.projMatrix,m+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,m+=16),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}this.setSectionPlanesStateUniforms(t),"edge"===e.snapMode?(a.indicesBuf.bind(),n.drawElementsInstanced(n.LINES,a.indicesBuf.numItems,a.indicesBuf.itemType,0,a.numInstances),a.indicesBuf.unbind()):n.drawArraysInstanced(n.POINTS,0,a.positionsBuf.numItems,a.numInstances),n.bindVertexArray(null)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// SnapInstancingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(2.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// SnapInstancingDepthRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("if (sectionPlaneActive"+t+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class ia{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}eagerCreateRenders(){this._snapInitRenderer||(this._snapInitRenderer=new Jn(this._scene,!1)),this._snapRenderer||(this._snapRenderer=new ta(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Gn(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new zn(this._scene)),this._silhouetteRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Jn(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new ta(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const sa={};const ra=new Uint8Array(4),oa=new Float32Array(1),na=new Float32Array(3),aa=new Float32Array(4);class la{constructor(e){this.model=e.model,this.material=e.material,this.sortId="LinesInstancingLayer",this.layerIndex=e.layerIndex,this._renderers=function(e){const t=e.id;let i=sa[t];return i||(i=new ia(e),sa[t]=i,i._compile(),e.on("compile",(()=>{i._compile()})),e.on("destroyed",(()=>{delete sa[t],i._destroy()}))),i}(e.model.scene),this._aabb=d.collapseAABB3(),this._state=new ae({obb:d.OBB3(),numInstances:0,origin:null,geometry:e.geometry,positionsDecodeMatrix:e.geometry.positionsDecodeMatrix,positionsBuf:null,colorsBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._colors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=d.collapseAABB3(),this.aabbDirty=!0,e.origin&&(this._state.origin=d.vec3(e.origin)),this._finalized=!1,this.primitive=e.primitive}get aabb(){if(this.aabbDirty){d.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)d.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}createPortion(e,t){const i=t.color,s=t.opacity,r=t.meshMatrix;if(this._finalized)throw"Already finalized";const o=i[0],n=i[1],a=i[2];i[3],this._colors.push(o),this._colors.push(n),this._colors.push(a),this._colors.push(s),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(r[0]),this._modelMatrixCol0.push(r[4]),this._modelMatrixCol0.push(r[8]),this._modelMatrixCol0.push(r[12]),this._modelMatrixCol1.push(r[1]),this._modelMatrixCol1.push(r[5]),this._modelMatrixCol1.push(r[9]),this._modelMatrixCol1.push(r[13]),this._modelMatrixCol2.push(r[2]),this._modelMatrixCol2.push(r[6]),this._modelMatrixCol2.push(r[10]),this._modelMatrixCol2.push(r[14]),this._state.numInstances++;const l=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,this._meshes.push(e),l}finalize(){if(this._finalized)throw"Already finalized";const e=this.model.scene.canvas.gl,t=this._state,i=t.geometry,s=this._colors.length,r=s/4;if(s>0){let t=!1;this._state.colorsBuf=new le(e,e.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,e.DYNAMIC_DRAW,t),this._colors=[]}if(r>0){let t=!1;this._state.flagsBuf=new le(e,e.ARRAY_BUFFER,new Float32Array(r),r,1,e.DYNAMIC_DRAW,t)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const t=!1;this._state.offsetsBuf=new le(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,t),this._offsets=[]}if(i.colorsCompressed&&i.colorsCompressed.length>0){const s=new Uint8Array(i.colorsCompressed),r=!1;t.colorsBuf=new le(e,e.ARRAY_BUFFER,s,s.length,4,e.STATIC_DRAW,r)}if(i.positionsCompressed&&i.positionsCompressed.length>0){const s=!1;t.positionsBuf=new le(e,e.ARRAY_BUFFER,i.positionsCompressed,i.positionsCompressed.length,3,e.STATIC_DRAW,s),t.positionsDecodeMatrix=d.mat4(i.positionsDecodeMatrix)}if(i.indices&&i.indices.length>0&&(t.indicesBuf=new le(e,e.ELEMENT_ARRAY_BUFFER,new Uint32Array(i.indices),i.indices.length,1,e.STATIC_DRAW),t.numIndices=i.indices.length),this._modelMatrixCol0.length>0){const t=!1;this._state.modelMatrixCol0Buf=new le(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,t),this._state.modelMatrixCol1Buf=new le(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,t),this._state.modelMatrixCol2Buf=new le(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,t),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}this.model.scene.readableGeometryEnabled||(this._state.geometry=null),this._finalized=!0}initFlags(e,t,i){t&fr&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&yr&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&br&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&wr&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&_r&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Br&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&gr&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&mr&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&fr?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&yr?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&br?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&wr?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&Br?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&_r?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&gr?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&mr?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";ra[0]=t[0],ra[1]=t[1],ra[2]=t[2],ra[3]=t[3],this._state.colorsBuf.setData(ra,4*e,4)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=!!(t&fr),r=!!(t&br),o=!!(t&yr),n=!!(t&wr),a=!!(t&Br),l=!!(t&gr),A=!!(t&mr);let c,h;c=!s||A||r||o&&!this.model.scene.highlightMaterial.glowThrough||n&&!this.model.scene.selectedMaterial.glowThrough?Pr.NOT_RENDERED:i?Pr.COLOR_TRANSPARENT:Pr.COLOR_OPAQUE,h=!s||A?Pr.NOT_RENDERED:n?Pr.SILHOUETTE_SELECTED:o?Pr.SILHOUETTE_HIGHLIGHTED:r?Pr.SILHOUETTE_XRAYED:Pr.NOT_RENDERED;let u=0;u=!s||A?Pr.NOT_RENDERED:n?Pr.EDGES_SELECTED:o?Pr.EDGES_HIGHLIGHTED:r?Pr.EDGES_XRAYED:a?i?Pr.EDGES_COLOR_TRANSPARENT:Pr.EDGES_COLOR_OPAQUE:Pr.NOT_RENDERED;let d=0;d|=c,d|=h<<4,d|=u<<8,d|=(s&&!A&&l?Pr.PICK:Pr.NOT_RENDERED)<<12,d|=(t&_r?1:0)<<16,oa[0]=d,this._state.flagsBuf.setData(oa,e)}setOffset(e,t){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(na[0]=t[0],na[1]=t[1],na[2]=t[2],this._state.offsetsBuf.setData(na,3*e,3)):this.model.error("Entity#offset not enabled for this Viewer")}setMatrix(e,t){if(!this._finalized)throw"Not finalized";const i=4*e;aa[0]=t[0],aa[1]=t[4],aa[2]=t[8],aa[3]=t[12],this._state.modelMatrixCol0Buf.setData(aa,i),aa[0]=t[1],aa[1]=t[5],aa[2]=t[9],aa[3]=t[13],this._state.modelMatrixCol1Buf.setData(aa,i),aa[0]=t[2],aa[1]=t[6],aa[2]=t[10],aa[3]=t[14],this._state.modelMatrixCol2Buf.setData(aa,i)}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesXRayed(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawSnapInit(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Pr.PICK)}drawSnap(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Pr.PICK)}drawOcclusion(e,t){}drawShadow(e,t){}drawPickMesh(e,t){}drawPickDepths(e,t){}drawPickNormals(e,t){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.destroy()}}class Aa extends Tr{_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:r}=e;t.drawArrays(t.POINTS,0,i.positionsBuf.numItems),r&&s.drawArrays++}}class ca extends Aa{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial,s=[];return s.push("#version 300 es"),s.push("// Points batching color vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),this._addMatricesUniformBlockLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),i.filterIntensity&&s.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),i.filterIntensity&&(s.push("float intensity = float(color.a) / 255.0;"),s.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {")),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),i.filterIntensity&&s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batching color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}class ha extends Aa{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batching silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s),s.push("uniform vec4 color;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),s.push("if (silhouetteFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const r=t.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Points batching silhouette vertex shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("uniform vec4 color;"),o.push("out vec4 outColor;"),o.push("void main(void) {"),e.pointsMaterial.roundPoints&&(o.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("  float r = dot(cxy, cxy);"),o.push("  if (r > 1.0) {"),o.push("       discard;"),o.push("  }")),r){for(o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("outColor = color;"),o.push("}"),o}}class ua extends Aa{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batching pick mesh vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 pickColor;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vPickColor;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = remapClipPos(clipPos);"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("gl_PointSize += 10.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batching pick mesh vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(var r=0;r<t.getNumAllocatedSectionPlanes();r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("      if (sectionPlaneActive"+e+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vPickColor; "),s.push("}"),s}}class da extends Aa{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batched pick depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = remapClipPos(clipPos);"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("gl_PointSize += 10.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batched pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<t.getNumAllocatedSectionPlanes();r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}}class pa extends Aa{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points batching occlusion vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),this._addMatricesUniformBlockLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("  gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points batching occlusion fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("      if (sectionPlaneActive"+e+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}}const fa=d.vec3(),ma=d.vec3(),ga=d.vec3(),_a=d.vec3(),va=d.mat4();class ba extends Tr{drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=t.aabb,u=e.pickViewMatrix||o.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));const p=fa;let f,m;if(p[0]=d.safeInv(h[3]-h[0])*d.MAX_INT,p[1]=d.safeInv(h[4]-h[1])*d.MAX_INT,p[2]=d.safeInv(h[5]-h[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(p[0]),e.snapPickCoordinateScale[1]=d.safeInv(p[1]),e.snapPickCoordinateScale[2]=d.safeInv(p[2]),l||0!==A[0]||0!==A[1]||0!==A[2]){const t=ma;if(l){const e=ga;d.transformPoint3(c,l,e),t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=A[0],t[1]+=A[1],t[2]+=A[2],f=Ye(u,t,va),m=_a,m[0]=o.eye[0]-t[0],m[1]=o.eye[1]-t[1],m[2]=o.eye[2]-t[2],e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else f=u,m=o.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,m),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,p),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniform1f(this._uPointSize,1);let g=0;this._matricesUniformBlockBufferData.set(c,0),this._matricesUniformBlockBufferData.set(f,g+=16),this._matricesUniformBlockBufferData.set(o.projMatrix,g+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,g+=16),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}this.setSectionPlanesStateUniforms(t),n.drawArrays(n.POINTS,0,a.positionsBuf.numItems),n.bindVertexArray(null)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler"),this._uPointSize=e.getLocation("pointSize")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// VBOBatchingPointsSnapInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float pointSize;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),t&&i.push("      vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = pointSize;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// VBOBatchingPointsSnapInitRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),i.push("outNormal = ivec4(1.0, 1.0, 1.0, 1.0);"),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ya=d.vec3(),wa=d.vec3(),Ba=d.vec3(),Pa=d.vec3(),xa=d.mat4();class Ca extends Tr{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=t.aabb,u=e.pickViewMatrix||o.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));const p=ya;let f,m;if(p[0]=d.safeInv(h[3]-h[0])*d.MAX_INT,p[1]=d.safeInv(h[4]-h[1])*d.MAX_INT,p[2]=d.safeInv(h[5]-h[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(p[0]),e.snapPickCoordinateScale[1]=d.safeInv(p[1]),e.snapPickCoordinateScale[2]=d.safeInv(p[2]),l||0!==A[0]||0!==A[1]||0!==A[2]){const t=wa;if(l){const e=Ba;d.transformPoint3(c,l,e),t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=A[0],t[1]+=A[1],t[2]+=A[2],f=Ye(u,t,xa),m=Pa,m[0]=o.eye[0]-t[0],m[1]=o.eye[1]-t[1],m[2]=o.eye[2]-t[2],e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else f=u,m=o.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,m),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,p),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let g=0;this._matricesUniformBlockBufferData.set(c,0),this._matricesUniformBlockBufferData.set(f,g+=16),this._matricesUniformBlockBufferData.set(o.projMatrix,g+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,g+=16),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}this.setSectionPlanesStateUniforms(t),n.drawArrays(n.POINTS,0,a.positionsBuf.numItems),n.bindVertexArray(null)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this._uCameraEyeRtc=e.getLocation("uCameraEyeRtc"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0;e.pointsMaterial._state;const i=[];return i.push("#version 300 es"),i.push("// VBOBatchingPointsSnapRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// VBOBatchingPointsSnapRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Ma{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new ca(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new ha(this._scene)),this._silhouetteRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new ua(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new da(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new pa(this._scene)),this._occlusionRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new ba(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new Ca(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const Ea={};class Fa{constructor(e){this.model=e.model,this.sortId="PointsBatchingLayer",this.layerIndex=e.layerIndex,this._renderers=function(e){const t=e.id;let i=Ea[t];return i||(i=new Ma(e),Ea[t]=i,i._compile(),e.on("compile",(()=>{i._compile()})),e.on("destroyed",(()=>{delete Ea[t],i._destroy()}))),i}(e.model.scene);const t=e.maxGeometryBatchSize||5e6,i=function(){const e=[];return{append:function(t,i=1,s=1){e.push({data:t,times:i,denormalizeScale:s})},compileBuffer:function(t){let i=0;e.forEach((e=>{i+=e.times*e.data.length}));const s=new t(i);let r=0;return e.forEach((e=>{const t=e.data,i=e.denormalizeScale,o=s.subarray(r);if(1===i)o.set(t,0);else for(let e=0;e<t.length;++e)o[e]=t[e]*i;let n=t.length;const a=e.times*t.length;for(;n<a;){const e=Math.min(n,a-n);o.set(o.subarray(0,e),n),n+=e}r+=n})),s}}};this._buffer={maxVerts:t,positions:i(),colors:i(),pickColors:i(),vertsIndex:0},this._scratchMemory=e.scratchMemory,this._state=new ae({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,positionsDecodeMatrix:d.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=d.collapseAABB3(),this._portions=[],this._meshes=[],this._aabb=d.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressedPositionsExpected=!0):this._preCompressedPositionsExpected=!1,e.origin&&(this._state.origin=d.vec3(e.origin))}get aabb(){if(this.aabbDirty){d.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)d.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e){if(this._finalized)throw"Already finalized";return this._buffer.vertsIndex+e/3<=this._buffer.maxVerts}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=this._buffer,s=this._preCompressedPositionsExpected?t.positionsCompressed:t.positions;if(!s)throw(this._preCompressedPositionsExpected?"positionsCompressed":"positions")+" expected";i.positions.append(s);const r=s.length/3,o=t.color,n=t.colorsCompressed,a=t.colors,l=t.pickColor;n?i.colors.append(n):a?i.colors.append(a,1,255):o&&i.colors.append([o[0],o[1],o[2],1],r),i.pickColors.append(l.slice(0,4),r),d.expandAABB3(this._modelAABB,t.aabb);const A=this._portions.length/2;return this._portions.push(this._buffer.vertsIndex),this._portions.push(r),this._buffer.vertsIndex+=r,this._numPortions++,this.model.numPortions++,this._meshes.push(e),A}finalize(){if(this._finalized)return;const e=this._state,t=this.model.scene.canvas.gl,i=this._buffer,s=(e,i,s)=>e.length>0?new le(t,t.ARRAY_BUFFER,e,e.length,i,s):null,r=this._preCompressedPositionsExpected?i.positions.compileBuffer(Uint16Array):go(i.positions.compileBuffer(Float32Array),this._modelAABB,e.positionsDecodeMatrix);e.positionsBuf=s(r,3,t.STATIC_DRAW),e.flagsBuf=s(new Float32Array(this._buffer.vertsIndex),1,t.DYNAMIC_DRAW),e.colorsBuf=s(i.colors.compileBuffer(Uint8Array),4,t.STATIC_DRAW),e.pickColorsBuf=s(i.pickColors.compileBuffer(Uint8Array),4,t.STATIC_DRAW),e.offsetsBuf=this.model.scene.entityOffsetsEnabled?s(new Float32Array(3*this._buffer.vertsIndex),3,t.DYNAMIC_DRAW):null,this._buffer=null,this._finalized=!0}initFlags(e,t,i){t&fr&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&yr&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&br&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&wr&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&_r&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&gr&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&mr&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&fr?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&yr?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&br?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&wr?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized"}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&_r?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&mr?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&gr?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";const i=2*e,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),n=t[0],a=t[1],l=t[2];for(let e=0;e<r;e+=4)o[e+0]=n,o[e+1]=a,o[e+2]=l;this._state.colorsBuf.setData(o,s,r)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=2*e,r=this._portions[s],o=this._portions[s+1],n=this._scratchMemory.getFloat32Array(o),a=!!(t&fr),l=!!(t&br),A=!!(t&yr),c=!!(t&wr),h=!!(t&gr),u=!!(t&mr);let d,p;d=!a||u||l||A&&!this.model.scene.highlightMaterial.glowThrough||c&&!this.model.scene.selectedMaterial.glowThrough?Pr.NOT_RENDERED:i?Pr.COLOR_TRANSPARENT:Pr.COLOR_OPAQUE,p=!a||u?Pr.NOT_RENDERED:c?Pr.SILHOUETTE_SELECTED:A?Pr.SILHOUETTE_HIGHLIGHTED:l?Pr.SILHOUETTE_XRAYED:Pr.NOT_RENDERED;let f=a&&!u&&h?Pr.PICK:Pr.NOT_RENDERED;const m=t&_r?1:0;for(let e=0;e<o;e++){let t=0;t|=d,t|=p<<4,t|=f<<12,t|=m<<16,n[e]=t}this._state.flagsBuf.setData(n,r)}setOffset(e,t){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const i=2*e,s=3*this._portions[i],r=3*this._portions[i+1],o=this._scratchMemory.getFloat32Array(r),n=t[0],a=t[1],l=t[2];for(let e=0;e<r;e+=3)o[e+0]=n,o[e+1]=a,o[e+2]=l;this._state.offsetsBuf.setData(o,s,r)}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,Pr.PICK)}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,Pr.PICK)}drawPickNormals(e,t){}drawSnapInit(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Pr.PICK)}drawSnap(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Pr.PICK)}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE)}drawShadow(e,t){}destroy(){const e=this._state;e.positionsBuf&&(e.positionsBuf.destroy(),e.positionsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}class Ia extends Tr{constructor(e,t){super(e,t,{instancing:!0})}_draw(e){const{gl:t}=this._scene.canvas,{state:i,frameCtx:s,incrementDrawState:r}=e;t.drawArraysInstanced(t.POINTS,0,i.positionsBuf.numItems,i.numInstances),r&&s.drawArrays++}}class Ta extends Ia{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){super.drawLayer(e,t,i,{incrementDrawState:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points instancing color vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),s.push("in vec4 color;"),s.push("in float flags;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),i.filterIntensity&&s.push("uniform vec2 intensityRange;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),i.filterIntensity&&(s.push("float intensity = float(color.a) / 255.0;"),s.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {")),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),i.filterIntensity&&s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing color fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vColor;"),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}class Da extends Ia{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(e,t,i){super.drawLayer(e,t,i,{colorUniform:!0})}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points instancing silhouette vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 color;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),s.push("uniform vec4 silhouetteColor;"),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vColor;"),s.push("void main(void) {"),s.push("int silhouetteFlag = int(flags) >> 4 & 0xF;"),s.push("if (silhouetteFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("vColor = vec4(float(silhouetteColor.r) / 255.0, float(silhouetteColor.g) / 255.0, float(silhouetteColor.b) / 255.0, float(color.a) / 255.0);"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing silhouette fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vColor;"),s.push("}"),s}}class Sa extends Ia{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points instancing pick mesh vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 pickColor;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vPickColor;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),t&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("gl_Position = remapClipPos(clipPos);"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick mesh fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vPickColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("outColor = vPickColor; "),s.push("}"),s}}class Ra extends Ia{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points instancing pick depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(s),this._addRemapClipPosLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("out vec4 vViewPosition;"),s.push("void main(void) {"),s.push("int pickFlag = int(flags) >> 12 & 0xF;"),s.push("if (pickFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags = flags;")),s.push("  vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),s.push("gl_Position = remapClipPos(clipPos);"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = remapClipPos(clipPos);"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing pick depth fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    outColor = packDepth(zNormalizedDepth); "),s.push("}"),s}}class Ua extends Ia{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points instancing occlusion vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in vec4 color;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("  vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Points instancing occlusion vertex shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),e.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0;e<t.getNumAllocatedSectionPlanes();e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}}class La extends Ia{_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=e.pointsMaterial._state,s=[];return s.push("#version 300 es"),s.push("// Points instancing depth vertex shader"),s.push("uniform int renderPass;"),s.push("in vec3 position;"),e.entityOffsetsEnabled&&s.push("in vec3 offset;"),s.push("in float flags;"),s.push("in vec4 modelMatrixCol0;"),s.push("in vec4 modelMatrixCol1;"),s.push("in vec4 modelMatrixCol2;"),this._addMatricesUniformBlockLines(s),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("out float vFragDepth;")),t&&(s.push("out vec4 vWorldPosition;"),s.push("out float vFlags;")),s.push("void main(void) {"),s.push("int colorFlag = int(flags) & 0xF;"),s.push("if (colorFlag != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags = flags;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&s.push("vFragDepth = 1.0 + clipPos.w;"),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState;let i,s;const r=t.getNumAllocatedSectionPlanes()>0,o=[];if(o.push("#version 300 es"),o.push("// Points instancing depth vertex shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("in float vFragDepth;")),r)for(o.push("in vec4 vWorldPosition;"),o.push("in float vFlags;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("const float   packUpScale = 256. / 255.;"),o.push("const float   unpackDownscale = 255. / 256.;"),o.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),o.push("const float   shiftRight8 = 1.0 / 256.;"),o.push("vec4 packDepthToRGBA( const in float v ) {"),o.push("    vec4 r = vec4( fract( v * packFactors ), v );"),o.push("    r.yzw -= r.xyz * shiftRight8;"),o.push("    return r * packUpScale;"),o.push("}"),o.push("out vec4 outColor;"),o.push("void main(void) {"),e.pointsMaterial.roundPoints&&(o.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("  float r = dot(cxy, cxy);"),o.push("  if (r > 1.0) {"),o.push("       discard;"),o.push("  }")),r){for(o.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=t.getNumAllocatedSectionPlanes();i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return o.push("    outColor = packDepthToRGBA( gl_FragCoord.z); "),e.logarithmicDepthBufferEnabled&&o.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}}class ka extends Ia{_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Instancing geometry shadow drawing vertex shader"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in vec4 color;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),this._addMatricesUniformBlockLines(i),i.push("uniform float pointSize;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("void main(void) {"),i.push("int colorFlag     = int(flags) & 0xF;"),i.push("bool visible      = (colorFlag > 0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags = flags;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("gl_PointSize = pointSize;"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// Instancing geometry depth drawing fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("in float vFlags;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }"),i){s.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    outColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}}const Oa=d.vec3(),Na=d.vec3(),Va=d.vec3();d.vec3();const Qa=d.mat4();class Ha extends Tr{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.canvas.gl,n=r.camera,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=t.aabb,u=e.pickViewMatrix||n.viewMatrix;this._vaoCache.has(t)?o.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));const p=Oa;let f;if(p[0]=d.safeInv(h[3]-h[0])*d.MAX_INT,p[1]=d.safeInv(h[4]-h[1])*d.MAX_INT,p[2]=d.safeInv(h[5]-h[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(p[0]),e.snapPickCoordinateScale[1]=d.safeInv(p[1]),e.snapPickCoordinateScale[2]=d.safeInv(p[2]),l||0!==A[0]||0!==A[1]||0!==A[2]){const t=Na;if(l){const e=d.transformPoint3(c,l,Va);t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=A[0],t[1]+=A[1],t[2]+=A[2],f=Ye(u,t,Qa),e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else f=u,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;o.uniform2fv(this.uVectorA,e.snapVectorA),o.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),o.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),o.uniform3fv(this._uCoordinateScaler,p),o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,e.pickInvisible);let m=0;this._matricesUniformBlockBufferData.set(c,0),this._matricesUniformBlockBufferData.set(f,m+=16),this._matricesUniformBlockBufferData.set(n.projMatrix,m+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,m+=16),o.bindBuffer(o.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),o.bufferData(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,o.DYNAMIC_DRAW),o.bindBufferBase(o.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,t)}this.setSectionPlanesStateUniforms(t),o.drawArraysInstanced(o.POINTS,0,a.positionsBuf.numItems,a.numInstances),o.bindVertexArray(null)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// SnapInstancingDepthBufInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec4 pickColor;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("out float vFlags;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vWorldPosition = worldPosition;"),t&&i.push("  vFlags = flags;"),i.push("vPickColor = pickColor;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Points instancing pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("if (sectionPlaneActive"+t+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, -layerNumber);"),i.push("outNormal = ivec4(1.0, 1.0, 1.0, 1.0);"),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ja=d.vec3(),Ga=d.vec3(),za=d.vec3();d.vec3();const Wa=d.mat4();class Xa extends Tr{constructor(e){super(e,!1,{instancing:!0})}drawLayer(e,t,i){if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=t.aabb,u=e.pickViewMatrix||o.viewMatrix;this._vaoCache.has(t)?n.bindVertexArray(this._vaoCache.get(t)):this._vaoCache.set(t,this._makeVAO(a));const p=ja;let f;if(p[0]=d.safeInv(h[3]-h[0])*d.MAX_INT,p[1]=d.safeInv(h[4]-h[1])*d.MAX_INT,p[2]=d.safeInv(h[5]-h[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(p[0]),e.snapPickCoordinateScale[1]=d.safeInv(p[1]),e.snapPickCoordinateScale[2]=d.safeInv(p[2]),l||0!==A[0]||0!==A[1]||0!==A[2]){const t=Ga;if(l){const e=d.transformPoint3(c,l,za);t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=A[0],t[1]+=A[1],t[2]+=A[2],f=Ye(u,t,Wa),e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else f=u,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,p),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible);let m=0;this._matricesUniformBlockBufferData.set(c,0),this._matricesUniformBlockBufferData.set(f,m+=16),this._matricesUniformBlockBufferData.set(o.projMatrix,m+=16),this._matricesUniformBlockBufferData.set(a.positionsDecodeMatrix,m+=16),n.bindBuffer(n.UNIFORM_BUFFER,this._matricesUniformBlockBuffer),n.bufferData(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferData,n.DYNAMIC_DRAW),n.bindBufferBase(n.UNIFORM_BUFFER,this._matricesUniformBlockBufferBindingPoint,this._matricesUniformBlockBuffer);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}this.setSectionPlanesStateUniforms(t),n.drawArraysInstanced(n.POINTS,0,a.positionsBuf.numItems,a.numInstances),n.bindVertexArray(null)}_allocate(){super._allocate();const e=this._program;this._uLogDepthBufFC=e.getLocation("logDepthBufFC"),this.uVectorA=e.getLocation("snapVectorA"),this.uInverseVectorAB=e.getLocation("snapInvVectorAB"),this._uLayerNumber=e.getLocation("layerNumber"),this._uCoordinateScaler=e.getLocation("coordinateScaler")}_bindProgram(){this._program.bind()}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// SnapInstancingDepthRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("in vec3 position;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("in float flags;"),i.push("in vec4 modelMatrixCol0;"),i.push("in vec4 modelMatrixCol1;"),i.push("in vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),this._addMatricesUniformBlockLines(i),i.push("uniform vec2 snapVectorA;"),i.push("uniform vec2 snapInvVectorAB;"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - snapVectorA.x) * snapInvVectorAB.x;"),i.push("    float y = (clipPos.y - snapVectorA.y) * snapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out float vFlags;")),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int pickFlag = int(flags) >> 12 & 0xF;"),i.push("if (pickFlag != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags = flags;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// SnapInstancingDepthRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int layerNumber;"),i.push("uniform vec3 coordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("in float vFlags;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = (int(vFlags) >> 16 & 0xF) == 1;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("if (sectionPlaneActive"+t+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("if (dist > 0.0) { discard; }"),i.push("}")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz*coordinateScaler.xyz, layerNumber);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Ka{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Ta(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Da(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new La(this._scene)),this._depthRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Sa(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Ra(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Ua(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new ka(this._scene)),this._shadowRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new Ha(this._scene,!1)),this._snapInitRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new Xa(this._scene)),this._snapRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy()}}const Za={};const Ja=new Uint8Array(4),Ya=new Float32Array(1),qa=new Float32Array(3),$a=new Float32Array(4);class el{constructor(e){this.model=e.model,this.material=e.material,this.sortId="PointsInstancingLayer",this.layerIndex=e.layerIndex,this._renderers=function(e){const t=e.id;let i=Za[t];return i||(i=new Ka(e),Za[t]=i,i._compile(),e.on("compile",(()=>{i._compile()})),e.on("destroyed",(()=>{delete Za[t],i._destroy()}))),i}(e.model.scene),this._aabb=d.collapseAABB3(),this._state=new ae({obb:d.OBB3(),numInstances:0,origin:e.origin?d.vec3(e.origin):null,geometry:e.geometry,positionsDecodeMatrix:e.geometry.positionsDecodeMatrix,colorsBuf:null,flagsBuf:null,offsetsBuf:null,modelMatrixCol0Buf:null,modelMatrixCol1Buf:null,modelMatrixCol2Buf:null,pickColorsBuf:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.geometry.numIndices,this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],this._meshes=[],this._aabb=d.collapseAABB3(),this.aabbDirty=!0,this._finalized=!1,this.primitive=e.geometry.primitive}get aabb(){if(this.aabbDirty){d.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)d.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}createPortion(e,t){const i=t.meshMatrix,s=t.pickColor;if(this._finalized)throw"Already finalized";this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(i[0]),this._modelMatrixCol0.push(i[4]),this._modelMatrixCol0.push(i[8]),this._modelMatrixCol0.push(i[12]),this._modelMatrixCol1.push(i[1]),this._modelMatrixCol1.push(i[5]),this._modelMatrixCol1.push(i[9]),this._modelMatrixCol1.push(i[13]),this._modelMatrixCol2.push(i[2]),this._modelMatrixCol2.push(i[6]),this._modelMatrixCol2.push(i[10]),this._modelMatrixCol2.push(i[14]),this._pickColors.push(s[0]),this._pickColors.push(s[1]),this._pickColors.push(s[2]),this._pickColors.push(s[3]),this._state.numInstances++;const r=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,this._meshes.push(e),r}finalize(){if(this._finalized)throw"Already finalized";const e=this.model.scene.canvas.gl,t=this._pickColors.length/4,i=this._state,s=i.geometry;if(t>0){let s=!1;i.flagsBuf=new le(e,e.ARRAY_BUFFER,new Float32Array(t),t,1,e.DYNAMIC_DRAW,s)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const t=!1;i.offsetsBuf=new le(e,e.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,e.DYNAMIC_DRAW,t),this._offsets=[]}if(s.positionsCompressed&&s.positionsCompressed.length>0){const t=!1;i.positionsBuf=new le(e,e.ARRAY_BUFFER,s.positionsCompressed,s.positionsCompressed.length,3,e.STATIC_DRAW,t),i.positionsDecodeMatrix=d.mat4(s.positionsDecodeMatrix)}if(s.colorsCompressed&&s.colorsCompressed.length>0){const t=new Uint8Array(s.colorsCompressed),r=!1;i.colorsBuf=new le(e,e.ARRAY_BUFFER,t,t.length,4,e.STATIC_DRAW,r)}if(this._modelMatrixCol0.length>0){const t=!1;i.modelMatrixCol0Buf=new le(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,e.STATIC_DRAW,t),i.modelMatrixCol1Buf=new le(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,e.STATIC_DRAW,t),i.modelMatrixCol2Buf=new le(e,e.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,e.STATIC_DRAW,t),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}if(this._pickColors.length>0){const t=!1;i.pickColorsBuf=new le(e,e.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,e.STATIC_DRAW,t),this._pickColors=[]}i.geometry=null,this._finalized=!0}initFlags(e,t,i){t&fr&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&yr&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&br&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&wr&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&_r&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Br&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&gr&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&mr&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(e,t,i)}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&fr?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&yr?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&br?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&wr?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&Br?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&_r?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags(e,t)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&gr?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&mr?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){if(!this._finalized)throw"Not finalized";Ja[0]=t[0],Ja[1]=t[1],Ja[2]=t[2],this._state.colorsBuf.setData(Ja,3*e)}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i){if(!this._finalized)throw"Not finalized";const s=!!(t&fr),r=!!(t&br),o=!!(t&yr),n=!!(t&wr),a=!!(t&Br),l=!!(t&gr),A=!!(t&mr);let c,h;c=!s||A||r||o&&!this.model.scene.highlightMaterial.glowThrough||n&&!this.model.scene.selectedMaterial.glowThrough?Pr.NOT_RENDERED:i?Pr.COLOR_TRANSPARENT:Pr.COLOR_OPAQUE,h=!s||A?Pr.NOT_RENDERED:n?Pr.SILHOUETTE_SELECTED:o?Pr.SILHOUETTE_HIGHLIGHTED:r?Pr.SILHOUETTE_XRAYED:Pr.NOT_RENDERED;let u=0;u=!s||A?Pr.NOT_RENDERED:n?Pr.EDGES_SELECTED:o?Pr.EDGES_HIGHLIGHTED:r?Pr.EDGES_XRAYED:a?i?Pr.EDGES_COLOR_TRANSPARENT:Pr.EDGES_COLOR_OPAQUE:Pr.NOT_RENDERED;let d=0;d|=c,d|=h<<4,d|=u<<8,d|=(s&&!A&&l?Pr.PICK:Pr.NOT_RENDERED)<<12,d|=(t&_r?255:0)<<16,Ya[0]=d,this._state.flagsBuf.setData(Ya,e)}setOffset(e,t){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(qa[0]=t[0],qa[1]=t[1],qa[2]=t[2],this._state.offsetsBuf.setData(qa,3*e)):this.model.error("Entity#offset not enabled for this Viewer")}setMatrix(e,t){if(!this._finalized)throw"Not finalized";const i=4*e;$a[0]=t[0],$a[1]=t[4],$a[2]=t[8],$a[3]=t[12],this._state.modelMatrixCol0Buf.setData($a,i),$a[0]=t[1],$a[1]=t[5],$a[2]=t[9],$a[3]=t[13],this._state.modelMatrixCol1Buf.setData($a,i),$a[0]=t[2],$a[1]=t[6],$a[2]=t[10],$a[3]=t[14],this._state.modelMatrixCol2Buf.setData($a,i)}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_XRAYED)}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_HIGHLIGHTED)}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_SELECTED)}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE)}drawShadow(e,t){}drawPickMesh(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,Pr.PICK)}drawPickDepths(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,Pr.PICK)}drawPickNormals(e,t){}drawSnapInit(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Pr.PICK)}drawSnap(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Pr.PICK)}destroy(){const e=this._state;e.colorsBuf&&(e.colorsBuf.destroy(),e.colorsBuf=null),e.flagsBuf&&(e.flagsBuf.destroy(),e.flagsBuf=null),e.offsetsBuf&&(e.offsetsBuf.destroy(),e.offsetsBuf=null),e.modelMatrixCol0Buf&&(e.modelMatrixCol0Buf.destroy(),e.modelMatrixCol0Buf=null),e.modelMatrixCol1Buf&&(e.modelMatrixCol1Buf.destroy(),e.modelMatrixCol1Buf=null),e.modelMatrixCol2Buf&&(e.modelMatrixCol2Buf.destroy(),e.modelMatrixCol2Buf=null),e.pickColorsBuf&&(e.pickColorsBuf.destroy(),e.pickColorsBuf=null),e.destroy()}}const tl=d.vec3(),il=d.vec3(),sl=d.mat4();class rl{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=a.textureState,A=t._state.origin,{position:c,rotationMatrix:h}=o,u=r.viewMatrix;if(!this._program&&(this._allocate(),this.errors))return;let p;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a)),l.bindCommonTextures(this._program,this.uPerObjectDecodeMatrix,this._uPerVertexPosition,this.uPerObjectColorAndFlags,this._uPerObjectMatrix);const f=0!==A[0]||0!==A[1]||0!==A[2],m=0!==c[0]||0!==c[1]||0!==c[2];if(f||m){const e=tl;if(f){const t=d.transformPoint3(h,A,il);e[0]=t[0],e[1]=t[1],e[2]=t[2]}else e[0]=0,e[1]=0,e[2]=0;e[0]+=c[0],e[1]+=c[1],e[2]+=c[2],p=Ye(u,e,sl)}else p=u;if(n.uniformMatrix4fv(this._uSceneModelMatrix,!1,h),n.uniformMatrix4fv(this._uViewMatrix,!1,p),n.uniformMatrix4fv(this._uProjMatrix,!1,r.projMatrix),n.uniform1i(this._uRenderPass,i),s.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}const g=s._sectionPlanesState.getNumAllocatedSectionPlanes(),_=s._sectionPlanesState.sectionPlanes.length;if(g>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*_,r=o.renderFlags;for(let t=0;t<g;t++){const s=this._uSectionPlanes[t];if(s)if(t<_){const a=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,a?1:0),a){const i=e[t];if(A){const e=tt(i.dist,i.dir,A,tl,o.matrix);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}else n.uniform1i(s.active,0)}}a.numIndices8Bits>0&&(l.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,8),n.drawArrays(n.LINES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,16),n.drawArrays(n.LINES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindLineIndicesTextures(this._program,this._uPerLineObject,this._uPerLineIndices,32),n.drawArrays(n.LINES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return this.errors=this._program.errors,void console.error(this.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uPerObjectDecodeMatrix="uPerObjectDecodeMatrix",this.uPerObjectColorAndFlags="uPerObjectColorAndFlags",this._uPerVertexPosition="uPerVertexPosition",this._uPerLineIndices="uPerLineIndices",this._uPerLineObject="uPerLineObject",this._uPerObjectMatrix="uPerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t.camera.project;if(s.bind(),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// LinesDataTextureColorRenderer"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled,i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uPerObjectDecodeMatrix;"),i.push("uniform highp sampler2D uPerObjectMatrix;"),i.push("uniform lowp usampler2D uPerObjectColorAndFlags;"),i.push("uniform mediump usampler2D uPerVertexPosition;"),i.push("uniform highp usampler2D uPerLineIndices;"),i.push("uniform mediump usampler2D uPerLineObject;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("  int lineIndex = gl_VertexID / 2;"),i.push("  int h_packed_object_id_index = (lineIndex >> 3) & 4095;"),i.push("  int v_packed_object_id_index = (lineIndex >> 3) >> 12;"),i.push("  int objectIndex = int(texelFetch(uPerLineObject, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("  ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("  uvec4 flags = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("  uvec4 flags2 = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("  if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("      return;"),i.push("  } else {"),i.push("      ivec4 packedVertexBase = ivec4(texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("      ivec4 packedLineIndexBaseOffset = ivec4(texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("      int lineIndexBaseOffset = (packedLineIndexBaseOffset.r << 24) + (packedLineIndexBaseOffset.g << 16) + (packedLineIndexBaseOffset.b << 8) + packedLineIndexBaseOffset.a;"),i.push("      int h_index = (lineIndex - lineIndexBaseOffset) & 4095;"),i.push("      int v_index = (lineIndex - lineIndexBaseOffset) >> 12;"),i.push("      ivec3 vertexIndices = ivec3(texelFetch(uPerLineIndices, ivec2(h_index, v_index), 0));"),i.push("      ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("      int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("      int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("      mat4 objectInstanceMatrix = mat4 (texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uPerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("      mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uPerObjectDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("      uvec4 flags = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("      uvec4 flags2 = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("      vec3 position = vec3(texelFetch(uPerVertexPosition, ivec2(indexPositionH, indexPositionV), 0));"),i.push("      uvec4 color = texelFetch (uPerObjectColorAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("      if (color.a == 0u) {"),i.push("          gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("          return;"),i.push("      };"),i.push("      vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2.r;")),i.push("      vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("      vFragDepth = 1.0 + clipPos.w;"),i.push("      isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("      gl_Position = clipPos;"),i.push("      vec4 rgb = vec4(color.rgba);"),i.push("      vColor = vec4(float(rgb.r*0.5) / 255.0, float(rgb.g*0.5) / 255.0, float(rgb.b*0.5) / 255.0, float(rgb.a) / 255.0);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// LinesDataTextureColorRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled&&s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class ol{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null)}eagerCreateRenders(){}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new rl(this._scene,!1)),this._colorRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy()}}const nl={};class al{constructor(){this.positionsCompressed=[],this.lenPositionsCompressed=0,this.indices8Bits=[],this.lenIndices8Bits=0,this.indices16Bits=[],this.lenIndices16Bits=0,this.indices32Bits=[],this.lenIndices32Bits=0,this.perObjectColors=[],this.perObjectPickColors=[],this.perObjectSolid=[],this.perObjectOffsets=[],this.perObjectPositionsDecodeMatrices=[],this.perObjectInstancePositioningMatrices=[],this.perObjectVertexBases=[],this.perObjectIndexBaseOffsets=[],this.perLineNumberPortionId8Bits=[],this.perLineNumberPortionId16Bits=[],this.perLineNumberPortionId32Bits=[]}}class ll{constructor(){this.texturePerObjectColorsAndFlags=null,this.texturePerObjectOffsets=null,this.texturePerObjectInstanceMatrices=null,this.texturePerObjectPositionsDecodeMatrix=null,this.texturePerVertexIdCoordinates=null,this.texturePerLineIdPortionIds8Bits=null,this.texturePerLineIdPortionIds16Bits=null,this.texturePerLineIdPortionIds32Bits=null,this.texturePerLineIdIndices8Bits=null,this.texturePerLineIdIndices16Bits=null,this.texturePerLineIdIndices32Bits=null,this.textureModelMatrices=null}finalize(){this.indicesPerBitnessTextures={8:this.texturePerLineIdIndices8Bits,16:this.texturePerLineIdIndices16Bits,32:this.texturePerLineIdIndices32Bits},this.indicesPortionIdsPerBitnessTextures={8:this.texturePerLineIdPortionIds8Bits,16:this.texturePerLineIdPortionIds16Bits,32:this.texturePerLineIdPortionIds32Bits}}bindCommonTextures(e,t,i,s,r){this.texturePerObjectPositionsDecodeMatrix.bindTexture(e,t,1),this.texturePerVertexIdCoordinates.bindTexture(e,i,2),this.texturePerObjectColorsAndFlags.bindTexture(e,s,3),this.texturePerObjectInstanceMatrices.bindTexture(e,r,4)}bindLineIndicesTextures(e,t,i,s){this.indicesPortionIdsPerBitnessTextures[s].bindTexture(e,t,5),this.indicesPerBitnessTextures[s].bindTexture(e,i,6)}}class Al{constructor(e,t,i,s,r=null){this._gl=e,this._texture=t,this._textureWidth=i,this._textureHeight=s,this._textureData=r}bindTexture(e,t,i){return e.bindTexture(t,this,i)}bind(e){return this._gl.activeTexture(this._gl["TEXTURE"+e]),this._gl.bindTexture(this._gl.TEXTURE_2D,this._texture),!0}unbind(e){}}const cl={sizeDataColorsAndFlags:0,sizeDataPositionDecodeMatrices:0,sizeDataTextureOffsets:0,sizeDataTexturePositions:0,sizeDataTextureIndices:0,sizeDataTexturePortionIds:0,numberOfGeometries:0,numberOfPortions:0,numberOfLayers:0,numberOfTextures:0,totalLines:0,totalLines8Bits:0,totalLines16Bits:0,totalLines32Bits:0,cannotCreatePortion:{because10BitsObjectId:0,becauseTextureSize:0},overheadSizeAlignementIndices:0,overheadSizeAlignementEdgeIndices:0};window.printDataTextureRamStats=function(){console.log(JSON.stringify(cl,null,4));let e=0;Object.keys(cl).forEach((t=>{t.startsWith("size")&&(e+=cl[t])})),console.log(`Total size ${e} bytes (${(e/1e3/1e3).toFixed(2)} MB)`),console.log(`Avg bytes / triangle: ${(e/cl.totalLines).toFixed(2)}`);let t={};Object.keys(cl).forEach((i=>{i.startsWith("size")&&(t[i]=`${(cl[i]/e*100).toFixed(2)} % of total`)})),console.log(JSON.stringify({percentualRamUsage:t},null,4))};class hl{disableBindedTextureFiltering(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}generateTextureForColorsAndFlags(e,t,i,s,r){const o=t.length;this.numPortions=o;const n=4096,a=Math.ceil(o/512);if(0===a)throw"texture height===0";const l=new Uint8Array(16384*a);cl.sizeDataColorsAndFlags+=l.byteLength,cl.numberOfTextures++;for(let e=0;e<o;e++)l.set(t[e],32*e+0),l.set(i[e],32*e+4),l.set([0,0,0,0],32*e+8),l.set([0,0,0,0],32*e+12),l.set([s[e]>>24&255,s[e]>>16&255,s[e]>>8&255,255&s[e]],32*e+16),l.set([r[e]>>24&255,r[e]>>16&255,r[e]>>8&255,255&r[e]],32*e+20);const A=e.createTexture();return e.bindTexture(e.TEXTURE_2D,A),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8UI,n,a),e.texSubImage2D(e.TEXTURE_2D,0,0,0,n,a,e.RGBA_INTEGER,e.UNSIGNED_BYTE,l,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Al(e,A,n,a,l)}generateTextureForObjectOffsets(e,t){const i=512,s=Math.ceil(t/i);if(0===s)throw"texture height===0";const r=new Float32Array(1536*s).fill(0);cl.sizeDataTextureOffsets+=r.byteLength,cl.numberOfTextures++;const o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32F,i,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,s,e.RGB,e.FLOAT,r,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Al(e,o,i,s,r)}generateTextureForInstancingMatrices(e,t){const i=t.length;if(0===i)throw"num instance matrices===0";const s=2048,r=Math.ceil(i/512),o=new Float32Array(8192*r);cl.numberOfTextures++;for(let e=0;e<t.length;e++)o.set(t[e],16*e);const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RGBA,e.FLOAT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r,o)}generateTextureForPositionsDecodeMatrices(e,t){const i=t.length;if(0===i)throw"num decode+entity matrices===0";const s=2048,r=Math.ceil(i/512),o=new Float32Array(8192*r);cl.sizeDataPositionDecodeMatrices+=o.byteLength,cl.numberOfTextures++;for(let e=0;e<t.length;e++)o.set(t[e],16*e);const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RGBA,e.FLOAT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}generateTextureFor8BitIndices(e,t,i){if(0===i)return{texture:null,textureHeight:0};const s=4096,r=Math.ceil(i/3/s);if(0===r)throw"texture height===0";const o=new Uint8Array(s*r*3);cl.sizeDataTextureIndices+=o.byteLength,cl.numberOfTextures++;for(let e=0,i=0,s=t.length;e<s;e++){const s=t[e];o.set(s,i),i+=s.length}const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB8UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RGB_INTEGER,e.UNSIGNED_BYTE,o,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}generateTextureFor16BitIndices(e,t,i){if(0===i)return{texture:null,textureHeight:0};const s=4096,r=Math.ceil(i/3/s);if(0===r)throw"texture height===0";const o=new Uint16Array(s*r*3);cl.sizeDataTextureIndices+=o.byteLength,cl.numberOfTextures++;for(let e=0,i=0,s=t.length;e<s;e++){const s=t[e];o.set(s,i),i+=s.length}const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RGB_INTEGER,e.UNSIGNED_SHORT,o,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}generateTextureFor32BitIndices(e,t,i){if(0===i)return{texture:null,textureHeight:0};const s=4096,r=Math.ceil(i/3/s);if(0===r)throw"texture height===0";const o=new Uint32Array(s*r*3);cl.sizeDataTextureIndices+=o.byteLength,cl.numberOfTextures++;for(let e=0,i=0,s=t.length;e<s;e++){const s=t[e];o.set(s,i),i+=s.length}const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RGB_INTEGER,e.UNSIGNED_INT,o,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}generateTextureForPositions(e,t,i){const s=i/3,r=4096,o=Math.ceil(s/r);if(0===o)throw"texture height===0";const n=new Uint16Array(r*o*3);cl.sizeDataTexturePositions+=n.byteLength,cl.numberOfTextures++;for(let e=0,i=0,s=t.length;e<s;e++){const s=t[e];n.set(s,i),i+=s.length}const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,r,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,o,e.RGB_INTEGER,e.UNSIGNED_SHORT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Al(e,a,r,o)}generateTextureForPackedPortionIds(e,t){if(0===t.length)return{texture:null,textureHeight:0};const i=t.length,s=4096,r=Math.ceil(i/s);if(0===r)throw"texture height===0";const o=new Uint16Array(s*r);o.set(t,0),cl.sizeDataTexturePortionIds+=o.byteLength,cl.numberOfTextures++;const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.R16UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RED_INTEGER,e.UNSIGNED_SHORT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}}const ul=new ho,dl=ul.maxDataTextureHeight,pl=new Float32Array(16),fl=new Uint8Array(4),ml=new Float32Array(3);let gl=0;const _l=d.identityMat4();class vl{constructor(e,t){cl.numberOfLayers++,this._layerNumber=gl++,this.sortId=`TriDTX-${this._layerNumber}`,this.layerIndex=t.layerIndex,this._renderers=function(e){const t=e.id;let i=nl[t];return i||(i=new ol(e),nl[t]=i,i._compile(),i.eagerCreateRenders(),e.on("compile",(()=>{i._compile(),i.eagerCreateRenders()})),e.on("destroyed",(()=>{delete nl[t],i._destroy()}))),i}(e.scene),this.model=e,this._buffer=new al,this._dataTextureState=new ll,this._dataTextureGenerator=new hl,this._state=new ae({origin:d.vec3(t.origin),textureState:this._dataTextureState,numIndices8Bits:0,numIndices16Bits:0,numIndices32Bits:0,numVertices:0}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._subPortions=[],this._portionToSubPortionsMap=[],this._bucketGeometries={},this._meshes=[],this._aabb=d.collapseAABB3(),this.aabbDirty=!0,this._numUpdatesInFrame=0,this.primitive=t.primitive,this._finalized=!1}get aabb(){if(this.aabbDirty){d.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)d.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e){if(this._finalized)throw"Already finalized";const t=e.buckets.length;this._numPortions+t>65536&&cl.cannotCreatePortion.because10BitsObjectId++;let i=this._numPortions+t<=65536;const s=void 0!==e.geometryId&&null!==e.geometryId?`${e.geometryId}#0`:`${e.id}#0`;if(!this._bucketGeometries[s]){const t=Math.max(this._state.numIndices8Bits,this._state.numIndices16Bits,this._state.numIndices32Bits);let s=0,r=0;e.buckets.forEach((e=>{s+=e.positionsCompressed.length/3,r+=e.indices.length/2})),(this._state.numVertices+s>4096*dl||t+r>4096*dl)&&cl.cannotCreatePortion.becauseTextureSize++,i&&=this._state.numVertices+s<=4096*dl&&t+r<=4096*dl}return i}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=[];t.buckets.forEach(((e,s)=>{const r=void 0!==t.geometryId&&null!==t.geometryId?`${t.geometryId}#${s}`:`${t.id}#${s}`;let o=this._bucketGeometries[r];o||(o=this._createBucketGeometry(t,e),this._bucketGeometries[r]=o);const n=this._createSubPortion(t,o,e);i.push(n)}));const s=this._portionToSubPortionsMap.length;return this._portionToSubPortionsMap.push(i),this.model.numPortions++,this._meshes.push(e),s}_createBucketGeometry(e,t){if(t.indices){const e=8*Math.ceil(t.indices.length/2/8)*2;cl.overheadSizeAlignementIndices+=2*(e-t.indices.length);const i=new Uint32Array(e);i.fill(0),i.set(t.indices),t.indices=i}const i=t.positionsCompressed,s=t.indices,r=this._buffer;r.positionsCompressed.push(i);const o=r.lenPositionsCompressed/3,n=i.length/3;let a;r.lenPositionsCompressed+=i.length;let l=0;if(s){let e;l=s.length/2,n<=256?(e=r.indices8Bits,a=r.lenIndices8Bits/2,r.lenIndices8Bits+=s.length):n<=65536?(e=r.indices16Bits,a=r.lenIndices16Bits/2,r.lenIndices16Bits+=s.length):(e=r.indices32Bits,a=r.lenIndices32Bits/2,r.lenIndices32Bits+=s.length),e.push(s)}this._state.numVertices+=n,cl.numberOfGeometries++;return{vertexBase:o,numVertices:n,numLines:l,indicesBase:a}}_createSubPortion(e,t){const i=e.color,s=e.colors,r=e.opacity,o=e.meshMatrix,n=e.pickColor,a=this._buffer,l=this._state;a.perObjectPositionsDecodeMatrices.push(e.positionsDecodeMatrix),a.perObjectInstancePositioningMatrices.push(o||_l),a.perObjectSolid.push(!!e.solid),s?a.perObjectColors.push([255*s[0],255*s[1],255*s[2],255]):i&&a.perObjectColors.push([i[0],i[1],i[2],r]),a.perObjectPickColors.push(n),a.perObjectVertexBases.push(t.vertexBase);{let e;e=t.numVertices<=256?l.numIndices8Bits:t.numVertices<=65536?l.numIndices16Bits:l.numIndices32Bits,a.perObjectIndexBaseOffsets.push(e/2-t.indicesBase)}const A=this._subPortions.length;if(t.numLines>0){let e,i=2*t.numLines;t.numVertices<=256?(e=a.perLineNumberPortionId8Bits,l.numIndices8Bits+=i,cl.totalLines8Bits+=t.numLines):t.numVertices<=65536?(e=a.perLineNumberPortionId16Bits,l.numIndices16Bits+=i,cl.totalLines16Bits+=t.numLines):(e=a.perLineNumberPortionId32Bits,l.numIndices32Bits+=i,cl.totalLines32Bits+=t.numLines),cl.totalLines+=t.numLines;for(let i=0;i<t.numLines;i+=8)e.push(A)}return this._subPortions.push({numVertices:t.numLines}),this._numPortions++,cl.numberOfPortions++,A}finalize(){if(this._finalized)return;const e=this._state,t=this._dataTextureState,i=this.model.scene.canvas.gl,s=this._buffer;e.gl=i,t.texturePerObjectColorsAndFlags=this._dataTextureGenerator.generateTextureForColorsAndFlags(i,s.perObjectColors,s.perObjectPickColors,s.perObjectVertexBases,s.perObjectIndexBaseOffsets,s.perObjectSolid),t.texturePerObjectInstanceMatrices=this._dataTextureGenerator.generateTextureForInstancingMatrices(i,s.perObjectInstancePositioningMatrices),t.texturePerObjectPositionsDecodeMatrix=this._dataTextureGenerator.generateTextureForPositionsDecodeMatrices(i,s.perObjectPositionsDecodeMatrices),t.texturePerVertexIdCoordinates=this._dataTextureGenerator.generateTextureForPositions(i,s.positionsCompressed,s.lenPositionsCompressed),t.texturePerLineIdPortionIds8Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perLineNumberPortionId8Bits),t.texturePerLineIdPortionIds16Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perLineNumberPortionId16Bits),t.texturePerLineIdPortionIds32Bits=this._dataTextureGenerator.generateTextureForPackedPortionIds(i,s.perLineNumberPortionId32Bits),s.lenIndices8Bits>0&&(t.texturePerLineIdIndices8Bits=this._dataTextureGenerator.generateTextureFor8BitIndices(i,s.indices8Bits,s.lenIndices8Bits)),s.lenIndices16Bits>0&&(t.texturePerLineIdIndices16Bits=this._dataTextureGenerator.generateTextureFor16BitIndices(i,s.indices16Bits,s.lenIndices16Bits)),s.lenIndices32Bits>0&&(t.texturePerLineIdIndices32Bits=this._dataTextureGenerator.generateTextureFor32BitIndices(i,s.indices32Bits,s.lenIndices32Bits)),t.finalize(),this._buffer=null,this._bucketGeometries={},this._finalized=!0,this._deferredSetFlagsDirty=!1,this._onSceneRendering=this.model.scene.on("rendering",(()=>{this._deferredSetFlagsDirty&&this._uploadDeferredFlags(),this._numUpdatesInFrame=0}))}initFlags(e,t,i){t&fr&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&yr&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&br&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&wr&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&_r&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&gr&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&mr&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,i,true),this._setFlags2(e,t,true)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&fr?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&yr?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&br?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&wr?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&_r?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}_beginDeferredFlags(){this._deferredSetFlagsActive=!0}_uploadDeferredFlags(){if(this._deferredSetFlagsActive=!1,!this._deferredSetFlagsDirty)return;this._deferredSetFlagsDirty=!1;const e=this.model.scene.canvas.gl,t=this._dataTextureState;e.bindTexture(e.TEXTURE_2D,t.texturePerObjectColorsAndFlags._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.texturePerObjectColorsAndFlags._textureWidth,t.texturePerObjectColorsAndFlags._textureHeight,e.RGBA_INTEGER,e.UNSIGNED_BYTE,t.texturePerObjectColorsAndFlags._textureData)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&mr?(this._numCulledLayerPortions+=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions-=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&gr?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){const i=this._portionToSubPortionsMap[e];for(let e=0,s=i.length;e<s;e++)this._subPortionSetColor(i[e],t)}_subPortionSetColor(e,t){if(!this._finalized)throw"Not finalized";const i=this._dataTextureState,s=this.model.scene.canvas.gl;fl[0]=t[0],fl[1]=t[1],fl[2]=t[2],fl[3]=t[3],i.texturePerObjectColorsAndFlags._textureData.set(fl,32*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectColorsAndFlags._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*8,Math.floor(e/512),1,1,s.RGBA_INTEGER,s.UNSIGNED_BYTE,fl))}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){const r=this._portionToSubPortionsMap[e];for(let e=0,o=r.length;e<o;e++)this._subPortionSetFlags(r[e],t,i,s)}_subPortionSetFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const r=!!(t&fr),o=!!(t&br),n=!!(t&mr);let a,l;a=!r||n||o?Pr.NOT_RENDERED:i?Pr.COLOR_TRANSPARENT:Pr.COLOR_OPAQUE,l=!r||n?Pr.NOT_RENDERED:!!(t&wr)?Pr.SILHOUETTE_SELECTED:!!(t&yr)?Pr.SILHOUETTE_HIGHLIGHTED:o?Pr.SILHOUETTE_XRAYED:Pr.NOT_RENDERED;let A=r&&!n&&!!(t&gr)?Pr.PICK:Pr.NOT_RENDERED;const c=this._dataTextureState,h=this.model.scene.canvas.gl;fl[0]=a,fl[1]=l,fl[3]=A,c.texturePerObjectColorsAndFlags._textureData.set(fl,32*e+8),this._deferredSetFlagsActive||s?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),h.bindTexture(h.TEXTURE_2D,c.texturePerObjectColorsAndFlags._texture),h.texSubImage2D(h.TEXTURE_2D,0,e%512*8+2,Math.floor(e/512),1,1,h.RGBA_INTEGER,h.UNSIGNED_BYTE,fl))}_setDeferredFlags(){}_setFlags2(e,t,i=!1){const s=this._portionToSubPortionsMap[e];for(let e=0,r=s.length;e<r;e++)this._subPortionSetFlags2(s[e],t,i)}_subPortionSetFlags2(e,t,i=!1){if(!this._finalized)throw"Not finalized";const s=t&_r?255:0,r=this._dataTextureState,o=this.model.scene.canvas.gl;fl[0]=s,fl[1]=0,fl[2]=1,fl[3]=2,r.texturePerObjectColorsAndFlags._textureData.set(fl,32*e+12),this._deferredSetFlagsActive||i?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),o.bindTexture(o.TEXTURE_2D,r.texturePerObjectColorsAndFlags._texture),o.texSubImage2D(o.TEXTURE_2D,0,e%512*8+3,Math.floor(e/512),1,1,o.RGBA_INTEGER,o.UNSIGNED_BYTE,fl))}_setDeferredFlags2(){}setOffset(e,t){const i=this._portionToSubPortionsMap[e];for(let e=0,s=i.length;e<s;e++)this._subPortionSetOffset(i[e],t)}_subPortionSetOffset(e,t){if(!this._finalized)throw"Not finalized";const i=this._dataTextureState,s=this.model.scene.canvas.gl;ml[0]=t[0],ml[1]=t[1],ml[2]=t[2],i.texturePerObjectOffsets._textureData.set(ml,3*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectOffsets._texture),s.texSubImage2D(s.TEXTURE_2D,0,0,e,1,1,s.RGB,s.FLOAT,ml))}setMatrix(e,t){const i=this._portionToSubPortionsMap[e];for(let e=0,s=i.length;e<s;e++)this._subPortionSetMatrix(i[e],t)}_subPortionSetMatrix(e,t){if(!this._finalized)throw"Not finalized";const i=this._dataTextureState,s=this.model.scene.canvas.gl;pl.set(t),i.texturePerObjectInstanceMatrices._textureData.set(pl,16*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectInstanceMatrices._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*4,Math.floor(e/512),4,1,s.RGBA,s.FLOAT,pl))}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE)}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT)}drawDepth(e,t){}drawNormals(e,t){}drawSilhouetteXRayed(e,t){}drawSilhouetteHighlighted(e,t){}drawSilhouetteSelected(e,t){}drawEdgesColorOpaque(e,t){}drawEdgesColorTransparent(e,t){}drawEdgesHighlighted(e,t){}drawEdgesSelected(e,t){}drawEdgesXRayed(e,t){}drawOcclusion(e,t){}drawShadow(e,t){}setPickMatrices(e,t){}drawPickMesh(e,t){}drawPickDepths(e,t){}drawSnapInit(e,t){}drawSnap(e,t){}drawPickNormals(e,t){}destroy(){if(this._destroyed)return;const e=this._state;this.model.scene.off(this._onSceneRendering),e.destroy(),this._destroyed=!0}}const bl=d.vec3(),yl=d.vec3(),wl=d.vec3();d.vec3();const Bl=d.vec4(),Pl=d.mat4();class xl{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=a.textureState,A=t._state.origin,{position:c,rotationMatrix:h}=o;if(!this._program&&(this._allocate(),this.errors))return;let u,p;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);const f=0!==A[0]||0!==A[1]||0!==A[2],m=0!==c[0]||0!==c[1]||0!==c[2];if(f||m){const e=bl;if(f){const t=d.transformPoint3(h,A,yl);e[0]=t[0],e[1]=t[1],e[2]=t[2]}else e[0]=0,e[1]=0,e[2]=0;e[0]+=c[0],e[1]+=c[1],e[2]+=c[2],u=Ye(r.viewMatrix,e,Pl),p=wl,p[0]=r.eye[0]-e[0],p[1]=r.eye[1]-e[1],p[2]=r.eye[2]-e[2]}else u=r.viewMatrix,p=r.eye;if(n.uniformMatrix4fv(this._uSceneModelMatrix,!1,h),n.uniformMatrix4fv(this._uViewMatrix,!1,u),n.uniformMatrix4fv(this._uProjMatrix,!1,r.projMatrix),n.uniform3fv(this._uCameraEyeRtc,p),n.uniform1i(this._uRenderPass,i),s.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}const g=s._sectionPlanesState.getNumAllocatedSectionPlanes(),_=s._sectionPlanesState.sectionPlanes.length;if(g>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*_,r=o.renderFlags;s.crossSections&&(n.uniform4fv(this._uSliceColor,s.crossSections.sliceColor),n.uniform1f(this._uSliceThickness,s.crossSections.sliceThickness));for(let t=0;t<g;t++){const s=this._uSectionPlanes[t];if(s)if(t<_){const a=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,a?1:0),a){const i=e[t];if(A){const e=tt(i.dist,i.dir,A,bl,o.matrix);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}else n.uniform1i(s.active,0)}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl,i=e._lightsState;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return this.errors=this._program.errors,void console.error(this.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let e=0,t=r.length;e<t;e++)switch(o=r[e],o.type){case"dir":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=null,this._uLightDir[e]=s.getLocation("lightDir"+e);break;case"point":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=null,this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e);break;case"spot":this._uLightColor[e]=s.getLocation("lightColor"+e),this._uLightPos[e]=s.getLocation("lightPos"+e),this._uLightDir[e]=s.getLocation("lightDir"+e),this._uLightAttenuation[e]=s.getLocation("lightAttenuation"+e)}this._uSceneModelMatrix=s.getLocation("sceneModelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=s.getLocation("uCameraEyeRtc"),e.crossSections&&(this._uSliceColor=s.getLocation("sliceColor"),this._uSliceThickness=s.getLocation("sliceThickness"))}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t._lightsState.lights,o=t.camera.project;s.bind(),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,t._lightsState.getAmbientColorAndIntensity());for(let e=0,t=r.length;e<t;e++){const t=r[e];this._uLightColor[e]&&i.uniform4f(this._uLightColor[e],t.color[0],t.color[1],t.color[2],t.intensity),this._uLightPos[e]&&(i.uniform3fv(this._uLightPos[e],t.pos),this._uLightAttenuation[e]&&i.uniform1f(this._uLightAttenuation[e],t.attenuation)),this._uLightDir[e]&&i.uniform3fv(this._uLightDir[e],t.dir)}if(this._withSAO){const s=t.sao;if(s.possible){const t=i.drawingBufferWidth,r=i.drawingBufferHeight;Bl[0]=t,Bl[1]=r,Bl[2]=s.blendCutoff,Bl[3]=s.blendFactor,i.uniform4fv(this._uSAOParams,Bl),this._program.bindTexture(this._uOcclusionTexture,e.occlusionTexture,10)}}if(t.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState,i=e._lightsState,s=t.getNumAllocatedSectionPlanes()>0;let r;const o=[];o.push("#version 300 es"),o.push("// TrianglesDataTextureColorRenderer vertex shader"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("precision highp usampler2D;"),o.push("precision highp isampler2D;"),o.push("precision highp sampler2D;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("precision mediump usampler2D;"),o.push("precision mediump isampler2D;"),o.push("precision mediump sampler2D;"),o.push("#endif"),o.push("uniform int renderPass;"),o.push("uniform mat4 sceneModelMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),o.push("uniform highp sampler2D uTexturePerObjectMatrix;"),o.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),o.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),o.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),o.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),o.push("uniform vec3 uCameraEyeRtc;"),o.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),o.push("out float vFragDepth;"),o.push("out float isPerspective;")),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("uniform vec4 lightAmbient;");for(let e=0,t=i.lights.length;e<t;e++)r=i.lights[e],"ambient"!==r.type&&(o.push("uniform vec4 lightColor"+e+";"),"dir"===r.type&&o.push("uniform vec3 lightDir"+e+";"),"point"===r.type&&o.push("uniform vec3 lightPos"+e+";"),"spot"===r.type&&(o.push("uniform vec3 lightPos"+e+";"),o.push("uniform vec3 lightDir"+e+";")));s&&(o.push("out vec4 vWorldPosition;"),o.push("flat out uint vFlags2;")),o.push("out vec4 vColor;"),o.push("void main(void) {"),o.push("int polygonIndex = gl_VertexID / 3;"),o.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),o.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),o.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),o.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),o.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),o.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),o.push("   return;"),o.push("} else {"),o.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),o.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),o.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),o.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),o.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),o.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),o.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),o.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),o.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),o.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),o.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),o.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),o.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),o.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),o.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),o.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),o.push("if (color.a == 0u) {"),o.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),o.push("   return;"),o.push("};"),o.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),o.push("vec3 position;"),o.push("position = positions[gl_VertexID % 3];"),o.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),o.push("if (solid != 1u) {"),o.push("if (isPerspectiveMatrix(projMatrix)) {"),o.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),o.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),o.push("position = positions[2 - (gl_VertexID % 3)];"),o.push("viewNormal = -viewNormal;"),o.push("}"),o.push("} else {"),o.push("if (viewNormal.z < 0.0) {"),o.push("position = positions[2 - (gl_VertexID % 3)];"),o.push("viewNormal = -viewNormal;"),o.push("}"),o.push("}"),o.push("}"),o.push("vec4 worldPosition = sceneModelMatrix * ((objectDecodeAndInstanceMatrix * vec4(position, 1.0))); "),o.push("vec4 viewPosition = viewMatrix * worldPosition; "),o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;");for(let e=0,t=i.lights.length;e<t;e++)if(r=i.lights[e],"ambient"!==r.type){if("dir"===r.type)"view"===r.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);");else if("point"===r.type)"view"===r.space?o.push("viewLightDir = -normalize(lightPos"+e+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+e+", 0.0)).xyz);");else{if("spot"!==r.type)continue;"view"===r.space?o.push("viewLightDir = normalize(lightDir"+e+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+e+", 0.0)).xyz);")}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+e+".rgb * lightColor"+e+".a);")}return o.push("vec3 rgb = vec3(color.rgb) / 255.0;"),o.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(o.push("vFragDepth = 1.0 + clipPos.w;"),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2.r;")),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState,i=t.getNumAllocatedSectionPlanes()>0,s=[];if(s.push("#version 300 es"),s.push("// TrianglesDataTextureColorRenderer fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("in float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("in vec4 vWorldPosition;"),s.push("flat in uint vFlags2;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";");s.push("uniform float sliceThickness;"),s.push("uniform vec4 sliceColor;")}if(s.push("in vec4 vColor;"),s.push("out vec4 outColor;"),s.push("void main(void) {"),s.push("  vec4 newColor;"),s.push("  newColor = vColor;"),i){s.push("  bool clippable = vFlags2 > 0u;"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let e=0,i=t.getNumAllocatedSectionPlanes();e<i;e++)s.push("if (sectionPlaneActive"+e+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+e+".xyz, vWorldPosition.xyz - sectionPlanePos"+e+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > sliceThickness) { "),s.push("      discard;"),s.push("  }"),s.push("  if (dist > 0.0) { "),s.push("      newColor = sliceColor;"),s.push("  }"),s.push("}")}return e.logarithmicDepthBufferEnabled?s.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"):(s.push("    float dx = dFdx(gl_FragCoord.z);"),s.push("    float dy = dFdy(gl_FragCoord.z);"),s.push("    float diff = sqrt(dx*dx+dy*dy);"),s.push("    gl_FragDepth = gl_FragCoord.z + diff;")),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;"),s.push("   outColor            = vec4(newColor.rgb * ambient, 1.0);")):s.push("   outColor            = newColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Cl=new Float32Array([1,1,1]),Ml=d.vec3(),El=d.vec3(),Fl=d.vec3();d.vec3();const Il=d.mat4();class Tl{constructor(e,t){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=a.textureState,A=t._state.origin,{position:c,rotationMatrix:h}=o,u=r.viewMatrix;if(!this._program&&(this._allocate(),this.errors))return;let p,f;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix),A||0!==c[0]||0!==c[1]||0!==c[2]){const e=Ml;if(A){const t=El;d.transformPoint3(h,A,t),e[0]=t[0],e[1]=t[1],e[2]=t[2]}else e[0]=0,e[1]=0,e[2]=0;e[0]+=c[0],e[1]+=c[1],e[2]+=c[2],p=Ye(u,e,Il),f=Fl,f[0]=r.eye[0]-e[0],f[1]=r.eye[1]-e[1],f[2]=r.eye[2]-e[2]}else p=u,f=r.eye;if(n.uniform3fv(this._uCameraEyeRtc,f),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uWorldMatrix,!1,h),n.uniformMatrix4fv(this._uViewMatrix,!1,p),n.uniformMatrix4fv(this._uProjMatrix,!1,r.projMatrix),i===Pr.SILHOUETTE_XRAYED){const e=s.xrayMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Pr.SILHOUETTE_HIGHLIGHTED){const e=s.highlightMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Pr.SILHOUETTE_SELECTED){const e=s.selectedMaterial._state,t=e.fillColor,i=e.fillAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else n.uniform4fv(this._uColor,Cl);if(s.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}const m=s._sectionPlanesState.getNumAllocatedSectionPlanes(),g=s._sectionPlanesState.sectionPlanes.length;if(m>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*g,r=o.renderFlags;for(let t=0;t<m;t++){const s=this._uSectionPlanes[t];if(s)if(t<g){const a=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,a?1:0),a){const i=e[t];if(A){const e=tt(i.dist,i.dir,A,Ml,o.matrix);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}else n.uniform1i(s.active,0)}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uWorldMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=t.camera.project;if(this._program.bind(),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture silhouette vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix *  (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture draw fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";");i.push("uniform float sliceThickness;"),i.push("uniform vec4 sliceColor;")}if(i.push("uniform vec4 color;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("  vec4 newColor;"),i.push("  newColor = color;"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)i.push("if (sectionPlaneActive"+t+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > sliceThickness) { "),i.push("      discard;"),i.push("  }"),i.push("  if (dist > 0.0) { "),i.push("      newColor = sliceColor;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    outColor = newColor;"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Dl=new Float32Array([0,0,0,1]),Sl=d.vec3(),Rl=d.vec3();d.vec3();const Ul=d.mat4();class Ll{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.textureState,A=t._state.origin,{position:c,rotationMatrix:h}=s,u=o.viewMatrix;if(!this._program&&(this._allocate(t),this.errors))return;let p;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);const f=0!==A[0]||0!==A[1]||0!==A[2],m=0!==c[0]||0!==c[1]||0!==c[2];if(f||m){const e=Sl;if(f){const t=d.transformPoint3(h,A,Rl);e[0]=t[0],e[1]=t[1],e[2]=t[2]}else e[0]=0,e[1]=0,e[2]=0;e[0]+=c[0],e[1]+=c[1],e[2]+=c[2],p=Ye(u,e,Ul)}else p=u;if(n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uSceneModelMatrix,!1,h),n.uniformMatrix4fv(this._uViewMatrix,!1,p),n.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),i===Pr.EDGES_XRAYED){const e=r.xrayMaterial._state,t=e.edgeColor,i=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Pr.EDGES_HIGHLIGHTED){const e=r.highlightMaterial._state,t=e.edgeColor,i=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else if(i===Pr.EDGES_SELECTED){const e=r.selectedMaterial._state,t=e.edgeColor,i=e.edgeAlpha;n.uniform4f(this._uColor,t[0],t[1],t[2],i)}else n.uniform4fv(this._uColor,Dl);const g=r._sectionPlanesState.getNumAllocatedSectionPlanes(),_=r._sectionPlanesState.sectionPlanes.length;if(g>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*_,o=s.renderFlags;for(let t=0;t<g;t++){const r=this._uSectionPlanes[t];if(r)if(t<_){const a=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(r.active,a?1:0),a){const i=e[t];if(A){const e=tt(i.dist,i.dir,A,Sl,s.matrix);n.uniform3fv(r.pos,e)}else n.uniform3fv(r.pos,i.pos);n.uniform3fv(r.dir,i.dir)}}else n.uniform1i(r.active,0)}}a.numEdgeIndices8Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),n.drawArrays(n.LINES,0,a.numEdgeIndices8Bits)),a.numEdgeIndices16Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),n.drawArrays(n.LINES,0,a.numEdgeIndices16Bits)),a.numEdgeIndices32Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),n.drawArrays(n.LINES,0,a.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix"}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e.camera.project;if(i.bind(),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// DTXTrianglesEdgesRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),i.push("uniform vec4 color;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("mat4 matrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// DTXTrianglesEdgesRenderer fragment shader"),e.logarithmicDepthBufferEnabled&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";");i.push("uniform float sliceThickness;"),i.push("uniform vec4 sliceColor;")}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("  vec4 newColor;"),i.push("  newColor = vColor;"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)i.push("if (sectionPlaneActive"+t+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > sliceThickness) { "),i.push("      discard;"),i.push("  }"),i.push("  if (dist > 0.0) { "),i.push("      newColor = sliceColor;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor            = newColor;"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const kl=d.vec3(),Ol=d.vec3(),Nl=d.mat4();class Vl{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.textureState,A=t._state.origin,{position:c,rotationMatrix:h}=s,u=o.viewMatrix;if(!this._program&&(this._allocate(),this.errors))return;let p;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);const f=0!==A[0]||0!==A[1]||0!==A[2],m=0!==c[0]||0!==c[1]||0!==c[2];if(f||m){const e=kl;if(f){const t=d.transformPoint3(h,A,Ol);e[0]=t[0],e[1]=t[1],e[2]=t[2]}else e[0]=0,e[1]=0,e[2]=0;e[0]+=c[0],e[1]+=c[1],e[2]+=c[2],p=Ye(u,e,Nl)}else p=u;n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uSceneModelMatrix,!1,h),n.uniformMatrix4fv(this._uViewMatrix,!1,p),n.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix);const g=r._sectionPlanesState.getNumAllocatedSectionPlanes(),_=r._sectionPlanesState.sectionPlanes.length;if(g>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*_,o=s.renderFlags;for(let t=0;t<g;t++){const r=this._uSectionPlanes[t];if(r)if(t<_){const a=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(r.active,a?1:0),a){const i=e[t];if(A){const e=tt(i.dist,i.dir,A,kl,s.matrix);n.uniform3fv(r.pos,e)}else n.uniform3fv(r.pos,i.pos);n.uniform3fv(r.dir,i.dir)}}else n.uniform1i(r.active,0)}}a.numEdgeIndices8Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),n.drawArrays(n.LINES,0,a.numEdgeIndices8Bits)),a.numEdgeIndices16Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),n.drawArrays(n.LINES,0,a.numEdgeIndices16Bits)),a.numEdgeIndices32Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),n.drawArrays(n.LINES,0,a.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix"}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e.camera.project;if(i.bind(),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(s.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// TrianglesDataTextureEdgesColorRenderer"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled,i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform highp sampler2D uObjectPerObjectOffsets;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;")),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vColor;"),i.push("void main(void) {"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vec4 rgb = vec4(color.rgba);"),i.push("vColor = vec4(float(rgb.r*0.5) / 255.0, float(rgb.g*0.5) / 255.0, float(rgb.b*0.5) / 255.0, float(rgb.a) / 255.0);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// TrianglesDataTextureEdgesColorRenderer"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";");i.push("uniform float sliceThickness;"),i.push("uniform vec4 sliceColor;")}if(i.push("in vec4 vColor;"),i.push("out vec4 outColor;"),i.push("void main(void) {"),i.push("  vec4 newColor;"),i.push("  newColor = vColor;"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)i.push("if (sectionPlaneActive"+t+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > sliceThickness) { "),i.push("      discard;"),i.push("  }"),i.push("  if (dist > 0.0) { "),i.push("      newColor = sliceColor;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outColor            = newColor;"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ql=d.vec3(),Hl=d.vec3(),jl=d.vec3(),Gl=d.mat4();class zl{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){if(!this._program&&(this._allocate(t),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e));const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.textureState,A=t._state.origin,{position:c,rotationMatrix:h}=s,u=e.pickViewMatrix||o.viewMatrix,p=e.pickProjMatrix||o.projMatrix,f=e.pickOrigin||o.eye,m=e.pickProjMatrix?e.pickZFar:o.project.far;let g,_;l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);const v=0!==A[0]||0!==A[1]||0!==A[2],b=0!==c[0]||0!==c[1]||0!==c[2];if(v||b){const e=Ql;if(v){const t=d.transformPoint3(h,A,Hl);e[0]=t[0],e[1]=t[1],e[2]=t[2]}else e[0]=0,e[1]=0,e[2]=0;e[0]+=c[0],e[1]+=c[1],e[2]+=c[2],g=Ye(u,e,Gl),_=jl,_[0]=f[0]-e[0],_[1]=f[1]-e[1],_[2]=f[2]-e[2]}else g=u,_=f;if(n.uniform2fv(this._uPickClipPos,e.pickClipPos),n.uniform2f(this._uDrawingBufferSize,n.drawingBufferWidth,n.drawingBufferHeight),n.uniformMatrix4fv(this._uSceneModelMatrix,!1,h),n.uniformMatrix4fv(this._uViewMatrix,!1,g),n.uniformMatrix4fv(this._uProjMatrix,!1,p),n.uniform3fv(this._uCameraEyeRtc,_),n.uniform1i(this._uRenderPass,i),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(m+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}const y=r._sectionPlanesState.getNumAllocatedSectionPlanes(),w=r._sectionPlanesState.sectionPlanes.length;if(y>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*w,o=s.renderFlags;for(let t=0;t<y;t++){const r=this._uSectionPlanes[t];if(r)if(t<w){const a=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(r.active,a?1:0),a){const i=e[t];if(A){const e=tt(i.dist,i.dir,A,Ql,s.matrix);n.uniform3fv(r.pos,e)}else n.uniform3fv(r.pos,i.pos);n.uniform3fv(r.dir,i.dir)}}else n.uniform1i(r.active,0)}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uDrawingBufferSize=i.getLocation("drawingBufferSize"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene.canvas.gl;this._program.bind(),t.uniform1i(this._uPickInvisible,e.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry picking vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform bool pickInvisible;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("uniform vec2 pickClipPos;"),i.push("uniform vec2 drawingBufferSize;"),i.push("vec4 remapClipPos(vec4 clipPos) {"),i.push("    clipPos.xy /= clipPos.w;"),i.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),i.push("    clipPos.xy *= clipPos.w;"),i.push("    return clipPos;"),i.push("}"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("smooth out vec4 vWorldPosition;"),i.push("flat out uvec4 vFlags2;")),i.push("out vec4 vPickColor;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("vPickColor = vec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0)) / 255.0;"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry picking fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uvec4 vFlags2;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("in vec4 vPickColor;"),i.push("out vec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("   outPickColor = vPickColor; "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Wl=d.vec3(),Xl=d.vec3(),Kl=d.vec3();d.vec3();const Zl=d.mat4();class Jl{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.textureState,A=t._state.origin,{position:c,rotationMatrix:h}=s,u=e.pickViewMatrix||o.viewMatrix,p=e.pickProjMatrix||o.projMatrix,f=e.pickOrigin||o.eye,m=e.pickProjMatrix?e.pickZFar:o.project.far;let g,_;if(this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix),A||0!==c[0]||0!==c[1]||0!==c[2]){const t=Wl;if(A){const e=Xl;d.transformPoint3(h,A,e),t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=c[0],t[1]+=c[1],t[2]+=c[2],g=Ye(u,t,Zl),_=Kl,_[0]=f[0]-t[0],_[1]=f[1]-t[1],_[2]=f[2]-t[2],e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else g=u,_=f,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;if(n.uniform3fv(this._uCameraEyeRtc,_),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniform2fv(this._uPickClipPos,e.pickClipPos),n.uniform2f(this._uDrawingBufferSize,n.drawingBufferWidth,n.drawingBufferHeight),n.uniform1f(this._uPickZNear,e.pickZNear),n.uniform1f(this._uPickZFar,e.pickZFar),n.uniformMatrix4fv(this._uSceneModelMatrix,!1,h),n.uniformMatrix4fv(this._uViewMatrix,!1,g),n.uniformMatrix4fv(this._uProjMatrix,!1,p),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(m+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}const v=r._sectionPlanesState.getNumAllocatedSectionPlanes(),b=r._sectionPlanesState.sectionPlanes.length;if(v>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*b,o=s.renderFlags;for(let t=0;t<v;t++){const r=this._uSectionPlanes[t];if(r)if(t<b){const a=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(r.active,a?1:0),a){const i=e[t];if(A){const e=tt(i.dist,i.dir,A,Wl,s.matrix);n.uniform3fv(r.pos,e)}else n.uniform3fv(r.pos,i.pos);n.uniform3fv(r.dir,i.dir)}}else n.uniform1i(r.active,0)}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uDrawingBufferSize=i.getLocation("drawingBufferSize"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform bool pickInvisible;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("uniform vec2 pickClipPos;"),i.push("uniform vec2 drawingBufferSize;"),i.push("vec4 remapClipPos(vec4 clipPos) {"),i.push("    clipPos.xy /= clipPos.w;"),i.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),i.push("    clipPos.xy *= clipPos.w;"),i.push("    return clipPos;"),i.push("}"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),t&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2.r;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = remapClipPos(clipPos);"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("uniform float pickZNear;"),i.push("uniform float pickZFar;"),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("uniform bool sectionPlaneActive"+s+";"),i.push("uniform vec3 sectionPlanePos"+s+";"),i.push("uniform vec3 sectionPlaneDir"+s+";")}if(i.push("in vec4 vViewPosition;"),i.push("vec4 packDepth(const in float depth) {"),i.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),i.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),i.push("  vec4 res = fract(depth * bitShift);"),i.push("  res -= res.xxyz * bitMask;"),i.push("  return res;"),i.push("}"),i.push("out vec4 outPackedDepth;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),i.push("    outPackedDepth = packDepth(zNormalizedDepth); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Yl=d.vec3(),ql=d.vec3(),$l=d.vec3(),eA=d.vec3();d.vec3();const tA=d.mat4();class iA{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.textureState,A=t._state.origin,{position:c,rotationMatrix:h}=s,u=t.aabb,p=e.pickViewMatrix||o.viewMatrix,f=Yl;let m,g;f[0]=d.safeInv(u[3]-u[0])*d.MAX_INT,f[1]=d.safeInv(u[4]-u[1])*d.MAX_INT,f[2]=d.safeInv(u[5]-u[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(f[0]),e.snapPickCoordinateScale[1]=d.safeInv(f[1]),e.snapPickCoordinateScale[2]=d.safeInv(f[2]),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);const _=0!==A[0]||0!==A[1]||0!==A[2],v=0!==c[0]||0!==c[1]||0!==c[2];if(_||v){const t=ql;if(_){const e=d.transformPoint3(h,A,$l);t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=c[0],t[1]+=c[1],t[2]+=c[2],m=Ye(p,t,tA),g=eA,g[0]=o.eye[0]-t[0],g[1]=o.eye[1]-t[1],g[2]=o.eye[2]-t[2],e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else m=p,g=o.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,g),n.uniform2fv(this.uVectorA,e.snapVectorA),n.uniform2fv(this.uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,f),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniformMatrix4fv(this._uSceneModelMatrix,!1,h),n.uniformMatrix4fv(this._uViewMatrix,!1,m),n.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}const b=r._sectionPlanesState.getNumAllocatedSectionPlanes(),y=r._sectionPlanesState.sectionPlanes.length;if(b>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*y,o=s.renderFlags;for(let t=0;t<b;t++){const r=this._uSectionPlanes[t];if(r)if(t<y){const a=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(r.active,a?1:0),a){const i=e[t];if(A){const e=tt(i.dist,i.dir,A,Yl,s.matrix);n.uniform3fv(r.pos,e)}else n.uniform3fv(r.pos,i.pos);n.uniform3fv(r.dir,i.dir)}}else n.uniform1i(r.active,0)}}const w="edge"===e.snapMode?n.LINES:n.POINTS;a.numEdgeIndices8Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,8),n.drawArrays(w,0,a.numEdgeIndices8Bits)),a.numEdgeIndices16Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,16),n.drawArrays(w,0,a.numEdgeIndices16Bits)),a.numEdgeIndices32Bits>0&&(l.bindEdgeIndicesTextures(this._program,this._uTexturePerEdgeIdPortionIds,this._uTexturePerPolygonIdEdgeIndices,32),n.drawArrays(w,0,a.numEdgeIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._uLogDepthBufFC=i.getLocation("logDepthBufFC"),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdEdgeIndices="uTexturePerPolygonIdEdgeIndices",this._uTexturePerEdgeIdPortionIds="uTexturePerEdgeIdPortionIds",this._uTextureModelMatrices="uTextureModelMatrices",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc"),this.uVectorA=i.getLocation("uSnapVectorA"),this.uInverseVectorAB=i.getLocation("uSnapInvVectorAB"),this._uLayerNumber=i.getLocation("uLayerNumber"),this._uCoordinateScaler=i.getLocation("uCoordinateScaler")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Batched geometry edges drawing vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdEdgeIndices;"),i.push("uniform mediump usampler2D uTexturePerEdgeIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 uSnapVectorA;"),i.push("uniform vec2 uSnapInvVectorAB;"),i.push("vec3 positions[3];"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out float isPerspective;"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - uSnapVectorA.x) * uSnapInvVectorAB.x;"),i.push("    float y = (clipPos.y - uSnapVectorA.y) * uSnapInvVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("out vec4 vViewPosition;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int edgeIndex = gl_VertexID / 2;"),i.push("int h_packed_object_id_index = (edgeIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (edgeIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerEdgeIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("}"),i.push("{"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedEdgeIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+6, objectIndexCoords.y), 0));"),i.push("int edgeIndexBaseOffset = (packedEdgeIndexBaseOffset.r << 24) + (packedEdgeIndexBaseOffset.g << 16) + (packedEdgeIndexBaseOffset.b << 8) + packedEdgeIndexBaseOffset.a;"),i.push("int h_index = (edgeIndex - edgeIndexBaseOffset) & 4095;"),i.push("int v_index = (edgeIndex - edgeIndexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdEdgeIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("int indexPositionH = uniqueVertexIndexes[gl_VertexID % 2] & 4095;"),i.push("int indexPositionV = uniqueVertexIndexes[gl_VertexID % 2] >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("vec3 position = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH, indexPositionV), 0));"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),t&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2.r;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vViewPosition = clipPos;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("gl_PointSize = 1.0;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture pick depth fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int uLayerNumber;"),i.push("uniform vec3 uCoordinateScaler;"),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("out highp ivec4 outCoords;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz * uCoordinateScaler.xyz, uLayerNumber);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const sA=d.vec3(),rA=d.vec3(),oA=d.vec3(),nA=d.vec3();d.vec3();const aA=d.mat4();class lA{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){this._program||this._allocate(),e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram());const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.textureState,A=t._state.origin,{position:c,rotationMatrix:h}=s,u=t.aabb,p=e.pickViewMatrix||o.viewMatrix,f=sA;let m,g;f[0]=d.safeInv(u[3]-u[0])*d.MAX_INT,f[1]=d.safeInv(u[4]-u[1])*d.MAX_INT,f[2]=d.safeInv(u[5]-u[2])*d.MAX_INT,e.snapPickCoordinateScale[0]=d.safeInv(f[0]),e.snapPickCoordinateScale[1]=d.safeInv(f[1]),e.snapPickCoordinateScale[2]=d.safeInv(f[2]),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);const _=0!==A[0]||0!==A[1]||0!==A[2],v=0!==c[0]||0!==c[1]||0!==c[2];if(_||v){const t=rA;if(_){const e=oA;d.transformPoint3(h,A,e),t[0]=e[0],t[1]=e[1],t[2]=e[2]}else t[0]=0,t[1]=0,t[2]=0;t[0]+=c[0],t[1]+=c[1],t[2]+=c[2],m=Ye(p,t,aA),g=nA,g[0]=o.eye[0]-t[0],g[1]=o.eye[1]-t[1],g[2]=o.eye[2]-t[2],e.snapPickOrigin[0]=t[0],e.snapPickOrigin[1]=t[1],e.snapPickOrigin[2]=t[2]}else m=p,g=o.eye,e.snapPickOrigin[0]=0,e.snapPickOrigin[1]=0,e.snapPickOrigin[2]=0;n.uniform3fv(this._uCameraEyeRtc,g),n.uniform2fv(this._uVectorA,e.snapVectorA),n.uniform2fv(this._uInverseVectorAB,e.snapInvVectorAB),n.uniform1i(this._uLayerNumber,e.snapPickLayerNumber),n.uniform3fv(this._uCoordinateScaler,f),n.uniform1i(this._uRenderPass,i),n.uniform1i(this._uPickInvisible,e.pickInvisible),n.uniformMatrix4fv(this._uSceneWorldModelMatrix,!1,h),n.uniformMatrix4fv(this._uViewMatrix,!1,m),n.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix);{const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}const b=r._sectionPlanesState.getNumAllocatedSectionPlanes(),y=r._sectionPlanesState.sectionPlanes.length;if(b>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*y,o=s.renderFlags;for(let t=0;t<b;t++){const r=this._uSectionPlanes[t];if(r)if(t<y){const a=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(r.active,a?1:0),a){const i=e[t];if(A){const e=tt(i.dist,i.dir,A,sA,s.matrix);n.uniform3fv(r.pos,e)}else n.uniform3fv(r.pos,i.pos);n.uniform3fv(r.dir,i.dir)}}else n.uniform1i(r.active,0)}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uSceneWorldModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._uLogDepthBufFC=i.getLocation("logDepthBufFC"),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc"),this._uVectorA=i.getLocation("uVectorAB"),this._uInverseVectorAB=i.getLocation("uInverseVectorAB"),this._uLayerNumber=i.getLocation("uLayerNumber"),this._uCoordinateScaler=i.getLocation("uCoordinateScaler")}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// DTXTrianglesSnapInitRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("uniform vec2 uVectorAB;"),i.push("uniform vec2 uInverseVectorAB;"),i.push("vec3 positions[3];"),i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("vec2 remapClipPos(vec2 clipPos) {"),i.push("    float x = (clipPos.x - uVectorAB.x) * uInverseVectorAB.x;"),i.push("    float y = (clipPos.y - uVectorAB.y) * uInverseVectorAB.y;"),i.push("    return vec2(x, y);"),i.push("}"),i.push("flat out vec4 vPickColor;"),i.push("out vec4 vWorldPosition;"),t&&i.push("flat out uint vFlags2;"),i.push("out highp vec3 relativeToOriginPosition;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("}"),i.push("{"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("  if (isPerspectiveMatrix(projMatrix)) {"),i.push("      vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("      if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("          viewNormal = -viewNormal;"),i.push("      }"),i.push("  } else {"),i.push("      if (viewNormal.z < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("          viewNormal = -viewNormal;"),i.push("      }"),i.push("  }"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("relativeToOriginPosition = worldPosition.xyz;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vWorldPosition = worldPosition;"),t&&i.push("vFlags2 = flags2.r;"),i.push("vPickColor = vec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+1, objectIndexCoords.y), 0));"),i.push("vec4 clipPos = projMatrix * viewPosition;"),i.push("float tmp = clipPos.w;"),i.push("clipPos.xyzw /= tmp;"),i.push("clipPos.xy = remapClipPos(clipPos.xy);"),i.push("clipPos.xyzw *= tmp;"),i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// DTXTrianglesSnapInitRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;"),i.push("uniform int uLayerNumber;"),i.push("uniform vec3 uCoordinateScaler;"),i.push("in vec4 vWorldPosition;"),i.push("flat in vec4 vPickColor;"),t){i.push("flat in uint vFlags2;");for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in highp vec3 relativeToOriginPosition;"),i.push("layout(location = 0) out highp ivec4 outCoords;"),i.push("layout(location = 1) out highp ivec4 outNormal;"),i.push("layout(location = 2) out lowp uvec4 outPickColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    float dx = dFdx(vFragDepth);"),i.push("    float dy = dFdy(vFragDepth);"),i.push("    float diff = sqrt(dx*dx+dy*dy);"),i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth + diff ) * logDepthBufFC * 0.5;"),i.push("outCoords = ivec4(relativeToOriginPosition.xyz * uCoordinateScaler.xyz, - uLayerNumber);"),i.push("vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push(`outNormal = ivec4(worldNormal * float(${d.MAX_INT}), 1.0);`),i.push("outPickColor = uvec4(vPickColor);"),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const AA=d.vec3(),cA=d.vec3(),hA=d.vec3();d.vec3();const uA=d.mat4();class dA{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=a.textureState,A=t._state.origin,{position:c,rotationMatrix:h}=s,u=e.pickViewMatrix||o.viewMatrix;if(!this._program&&(this._allocate(t),this.errors))return;let p,f;if(e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram()),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix),A||0!==c[0]||0!==c[1]||0!==c[2]){const e=AA;if(A){const t=cA;d.transformPoint3(h,A,t),e[0]=t[0],e[1]=t[1],e[2]=t[2]}else e[0]=0,e[1]=0,e[2]=0;e[0]+=c[0],e[1]+=c[1],e[2]+=c[2],p=Ye(u,e,uA),f=hA,f[0]=o.eye[0]-e[0],f[1]=o.eye[1]-e[1],f[2]=o.eye[2]-e[2]}else p=u,f=o.eye;n.uniform3fv(this._uCameraEyeRtc,f),n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uWorldMatrix,!1,h),n.uniformMatrix4fv(this._uViewMatrix,!1,p),n.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix);const m=r._sectionPlanesState.getNumAllocatedSectionPlanes(),g=r._sectionPlanesState.sectionPlanes.length;if(m>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*g,o=s.renderFlags;for(let t=0;t<m;t++){const r=this._uSectionPlanes[t];if(r)if(t<g){const a=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(r.active,a?1:0),a){const i=e[t];if(A){const e=tt(i.dist,i.dir,A,AA,s.matrix);n.uniform3fv(r.pos,e)}else n.uniform3fv(r.pos,i.pos);n.uniform3fv(r.dir,i.dir)}}else n.uniform1i(r.active,0)}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uWorldMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(){const e=this._scene;e.canvas.gl,e.camera.project,this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// TrianglesDataTextureOcclusionRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("if (solid != 1u) {"),i.push("  if (isPerspectiveMatrix(projMatrix)) {"),i.push("      vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("      if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("      }"),i.push("  } else {"),i.push("      vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("      if (viewNormal.z < 0.0) {"),i.push("          position = positions[2 - (gl_VertexID % 3)];"),i.push("      }"),i.push("  }"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix *  (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene._sectionPlanesState,t=e.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// TrianglesDataTextureColorRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("out vec4 outColor;"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(let t=0;t<e.getNumAllocatedSectionPlanes();t++)i.push("      if (sectionPlaneActive"+t+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("   outColor = vec4(0.0, 0.0, 1.0, 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const pA=d.vec3(),fA=d.vec3(),mA=d.vec3();d.vec3();const gA=d.mat4();class _A{constructor(e){this._scene=e,this._allocate(),this._hash=this._getHash()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=a.textureState,A=t._state.origin,{position:c,rotationMatrix:h}=o;if(!this._program&&(this._allocate(),this.errors))return;let u,p;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a)),l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);const f=0!==A[0]||0!==A[1]||0!==A[2],m=0!==c[0]||0!==c[1]||0!==c[2];if(f||m){const e=pA;if(f){const t=d.transformPoint3(h,A,fA);e[0]=t[0],e[1]=t[1],e[2]=t[2]}else e[0]=0,e[1]=0,e[2]=0;e[0]+=c[0],e[1]+=c[1],e[2]+=c[2],u=Ye(r.viewMatrix,e,gA),p=mA,p[0]=r.eye[0]-e[0],p[1]=r.eye[1]-e[1],p[2]=r.eye[2]-e[2]}else u=r.viewMatrix,p=r.eye;if(n.uniformMatrix4fv(this._uSceneModelMatrix,!1,h),n.uniformMatrix4fv(this._uViewMatrix,!1,u),n.uniformMatrix4fv(this._uProjMatrix,!1,r.projMatrix),n.uniform3fv(this._uCameraEyeRtc,p),n.uniform1i(this._uRenderPass,i),s.logarithmicDepthBufferEnabled){const t=2/(Math.log(e.pickZFar+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,t)}const g=s._sectionPlanesState.getNumAllocatedSectionPlanes(),_=s._sectionPlanesState.sectionPlanes.length;if(g>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*_,r=o.renderFlags;for(let t=0;t<g;t++){const s=this._uSectionPlanes[t];if(s)if(t<_){const a=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,a?1:0),a){const i=e[t];if(A){const e=tt(i.dist,i.dir,A,pA,o.matrix);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}else n.uniform1i(s.active,0)}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("objectDecodeAndInstanceMatrix"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t.camera.project;if(s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// Triangles dataTexture draw vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out highp vec2 vHighPrecisionZW;"),t&&(i.push("out vec4 vWorldPosition;"),i.push("flat out uint vFlags2;")),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),t&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2.r;")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Triangles dataTexture draw fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),i.push("in highp vec2 vHighPrecisionZW;"),i.push("out vec4 outColor;"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("flat in uint vFlags2;");for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)i.push("if (sectionPlaneActive"+t+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { "),i.push("      discard;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),i.push("    outColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const vA=d.vec3(),bA=d.vec3(),yA=d.vec3();d.vec3();const wA=d.mat4();class BA{constructor(e){this._scene=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(e,t,i){const s=t.model,r=s.scene,o=r.camera,n=r.canvas.gl,a=t._state,l=t._state.origin,{position:A,rotationMatrix:c}=s,h=o.viewMatrix;if(!this._program&&(this._allocate(t),this.errors))return;let u,p;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(t));const f=0!==l[0]||0!==l[1]||0!==l[2],m=0!==A[0]||0!==A[1]||0!==A[2];if(f||m){const e=vA;if(f){const t=bA;d.transformPoint3(c,l,t),e[0]=t[0],e[1]=t[1],e[2]=t[2]}else e[0]=0,e[1]=0,e[2]=0;e[0]+=A[0],e[1]+=A[1],e[2]+=A[2],u=Ye(h,e,wA),p=yA,p[0]=o.eye[0]-e[0],p[1]=o.eye[1]-e[1],p[2]=o.eye[2]-e[2]}else u=h,p=o.eye;n.uniform1i(this._uRenderPass,i),n.uniformMatrix4fv(this._uWorldMatrix,!1,c),n.uniformMatrix4fv(this._uViewMatrix,!1,u),n.uniformMatrix4fv(this._uProjMatrix,!1,o.projMatrix),n.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),n.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const g=r._sectionPlanesState.getNumAllocatedSectionPlanes(),_=r._sectionPlanesState.sectionPlanes.length;if(g>0){const e=r._sectionPlanesState.sectionPlanes,i=t.layerIndex*_,o=s.renderFlags;for(let t=0;t<g;t++){const r=this._uSectionPlanes[t];if(r)if(t<_){const a=o.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(r.active,a?1:0),a){const i=e[t];if(l){const e=tt(i.dist,i.dir,l,vA,s.matrix);n.uniform3fv(r.pos,e)}else n.uniform3fv(r.pos,i.pos);n.uniform3fv(r.dir,i.dir)}}else n.uniform1i(r.active,0)}}n.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,t._state.objectDecodeAndInstanceMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aNormal.bindArrayBuffer(a.normalsBuf),this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),n.drawElements(n.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("objectDecodeAndInstanceMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2&&(this._aFlags2=i.getAttribute("flags2")),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const e=this._scene,t=e.canvas.gl,i=e.camera.project;if(this._program.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(i.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("// Batched geometry normals vertex shader"),e.logarithmicDepthBufferEnabled&&Mi.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),e.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 objectDecodeAndInstanceMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),Mi.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("out float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),t&&(i.push("out vec4 vWorldPosition;"),i.push("out vec4 vFlags2;")),i.push("out vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),e.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),t&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags2         = flags2;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(Mi.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// Batched geometry normals fragment shader"),e.logarithmicDepthBufferEnabled&&Mi.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&Mi.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),t){i.push("in vec4 vWorldPosition;"),i.push("in vec4 vFlags2;");for(let t=0;t<e._sectionPlanesState.getNumAllocatedSectionPlanes();t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("in vec3 vViewNormal;"),i.push("vec3 packNormalToRGB( const in vec3 normal ) {"),i.push("    return normalize( normal ) * 0.5 + 0.5;"),i.push("}"),i.push("void main(void) {"),t){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<e._sectionPlanesState.getNumAllocatedSectionPlanes();s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return e.logarithmicDepthBufferEnabled&&Mi.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const PA=d.vec3(),xA=d.vec3(),CA=d.vec3();d.vec3(),d.vec4();const MA=d.mat4();class EA{constructor(e,t){this._scene=e,this._withSAO=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const e=this._scene;return[e._lightsState.getHash(),e._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(e,t,i){const s=this._scene,r=s.camera,o=t.model,n=s.canvas.gl,a=t._state,l=a.textureState,A=t._state.origin,{position:c,rotationMatrix:h}=o;if(!this._program&&(this._allocate(),this.errors))return;e.lastProgramId!==this._program.id&&(e.lastProgramId=this._program.id,this._bindProgram(e,a));const u=e.pickViewMatrix||r.viewMatrix,p=e.pickProjMatrix||r.projMatrix,f=e.pickOrigin||r.eye,m=e.pickProjMatrix?e.pickZFar:r.project.far;let g,_;l.bindCommonTextures(this._program,this.uTexturePerObjectPositionsDecodeMatrix,this._uTexturePerVertexIdCoordinates,this.uTexturePerObjectColorsAndFlags,this._uTexturePerObjectMatrix);const v=0!==A[0]||0!==A[1]||0!==A[2],b=0!==c[0]||0!==c[1]||0!==c[2];if(v||b){const e=PA;if(v){const t=d.transformPoint3(h,A,xA);e[0]=t[0],e[1]=t[1],e[2]=t[2]}else e[0]=0,e[1]=0,e[2]=0;e[0]+=c[0],e[1]+=c[1],e[2]+=c[2],g=Ye(u,e,MA),_=CA,_[0]=f[0]-e[0],_[1]=f[1]-e[1],_[2]=f[2]-e[2]}else g=u,_=f;if(n.uniform2fv(this._uPickClipPos,e.pickClipPos),n.uniform2f(this._uDrawingBufferSize,n.drawingBufferWidth,n.drawingBufferHeight),n.uniformMatrix4fv(this._uSceneModelMatrix,!1,h),n.uniformMatrix4fv(this._uViewMatrix,!1,g),n.uniformMatrix4fv(this._uProjMatrix,!1,p),n.uniform3fv(this._uCameraEyeRtc,_),n.uniform1i(this._uRenderPass,i),s.logarithmicDepthBufferEnabled){const e=2/(Math.log(m+1)/Math.LN2);n.uniform1f(this._uLogDepthBufFC,e)}const y=s._sectionPlanesState.getNumAllocatedSectionPlanes(),w=s._sectionPlanesState.sectionPlanes.length;if(y>0){const e=s._sectionPlanesState.sectionPlanes,i=t.layerIndex*w,r=o.renderFlags;for(let t=0;t<y;t++){const s=this._uSectionPlanes[t];if(s)if(t<w){const a=r.sectionPlanesActivePerLayer[i+t];if(n.uniform1i(s.active,a?1:0),a){const i=e[t];if(A){const e=tt(i.dist,i.dir,A,PA,o.matrix);n.uniform3fv(s.pos,e)}else n.uniform3fv(s.pos,i.pos);n.uniform3fv(s.dir,i.dir)}}else n.uniform1i(s.active,0)}}a.numIndices8Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,8),n.drawArrays(n.TRIANGLES,0,a.numIndices8Bits)),a.numIndices16Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,16),n.drawArrays(n.TRIANGLES,0,a.numIndices16Bits)),a.numIndices32Bits>0&&(l.bindTriangleIndicesTextures(this._program,this._uTexturePerPolygonIdPortionIds,this._uTexturePerPolygonIdIndices,32),n.drawArrays(n.TRIANGLES,0,a.numIndices32Bits)),e.drawElements++}_allocate(){const e=this._scene,t=e.canvas.gl;if(this._program=new Ci(t,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPickClipPos=i.getLocation("pickClipPos"),this._uDrawingBufferSize=i.getLocation("drawingBufferSize"),this._uSceneModelMatrix=i.getLocation("sceneModelMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+t),pos:i.getLocation("sectionPlanePos"+t),dir:i.getLocation("sectionPlaneDir"+t)});e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC")),this.uTexturePerObjectPositionsDecodeMatrix="uObjectPerObjectPositionsDecodeMatrix",this.uTexturePerObjectColorsAndFlags="uObjectPerObjectColorsAndFlags",this._uTexturePerVertexIdCoordinates="uTexturePerVertexIdCoordinates",this._uTexturePerPolygonIdNormals="uTexturePerPolygonIdNormals",this._uTexturePerPolygonIdIndices="uTexturePerPolygonIdIndices",this._uTexturePerPolygonIdPortionIds="uTexturePerPolygonIdPortionIds",this._uTexturePerObjectMatrix="uTexturePerObjectMatrix",this._uCameraEyeRtc=i.getLocation("uCameraEyeRtc")}_bindProgram(e){const t=this._scene,i=t.canvas.gl,s=this._program,r=t.camera.project;if(s.bind(),t.logarithmicDepthBufferEnabled){const e=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,e)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];return i.push("#version 300 es"),i.push("// trianglesDatatextureNormalsRenderer vertex shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("precision highp usampler2D;"),i.push("precision highp isampler2D;"),i.push("precision highp sampler2D;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("precision mediump usampler2D;"),i.push("precision mediump isampler2D;"),i.push("precision mediump sampler2D;"),i.push("#endif"),i.push("uniform int renderPass;"),e.entityOffsetsEnabled&&i.push("in vec3 offset;"),i.push("uniform mat4 sceneModelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform highp sampler2D uObjectPerObjectPositionsDecodeMatrix;"),i.push("uniform lowp usampler2D uObjectPerObjectColorsAndFlags;"),i.push("uniform highp sampler2D uTexturePerObjectMatrix;"),i.push("uniform mediump usampler2D uTexturePerVertexIdCoordinates;"),i.push("uniform highp usampler2D uTexturePerPolygonIdIndices;"),i.push("uniform mediump usampler2D uTexturePerPolygonIdPortionIds;"),i.push("uniform vec3 uCameraEyeRtc;"),i.push("vec3 positions[3];"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;"),i.push("out float isPerspective;")),i.push("uniform vec2 pickClipPos;"),i.push("uniform vec2 drawingBufferSize;"),i.push("vec4 remapClipPos(vec4 clipPos) {"),i.push("    clipPos.xy /= clipPos.w;"),i.push("    clipPos.xy = (clipPos.xy - pickClipPos) * drawingBufferSize;"),i.push("    clipPos.xy *= clipPos.w;"),i.push("    return clipPos;"),i.push("}"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("out vec4 vWorldPosition;"),t&&i.push("flat out uint vFlags2;"),i.push("void main(void) {"),i.push("int polygonIndex = gl_VertexID / 3;"),i.push("int h_packed_object_id_index = (polygonIndex >> 3) & 4095;"),i.push("int v_packed_object_id_index = (polygonIndex >> 3) >> 12;"),i.push("int objectIndex = int(texelFetch(uTexturePerPolygonIdPortionIds, ivec2(h_packed_object_id_index, v_packed_object_id_index), 0).r);"),i.push("ivec2 objectIndexCoords = ivec2(objectIndex % 512, objectIndex / 512);"),i.push("uvec4 flags = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+2, objectIndexCoords.y), 0);"),i.push("uvec4 flags2 = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+3, objectIndexCoords.y), 0);"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("} else {"),i.push("ivec4 packedVertexBase = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+4, objectIndexCoords.y), 0));"),i.push("ivec4 packedIndexBaseOffset = ivec4(texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+5, objectIndexCoords.y), 0));"),i.push("int indexBaseOffset = (packedIndexBaseOffset.r << 24) + (packedIndexBaseOffset.g << 16) + (packedIndexBaseOffset.b << 8) + packedIndexBaseOffset.a;"),i.push("int h_index = (polygonIndex - indexBaseOffset) & 4095;"),i.push("int v_index = (polygonIndex - indexBaseOffset) >> 12;"),i.push("ivec3 vertexIndices = ivec3(texelFetch(uTexturePerPolygonIdIndices, ivec2(h_index, v_index), 0));"),i.push("ivec3 uniqueVertexIndexes = vertexIndices + (packedVertexBase.r << 24) + (packedVertexBase.g << 16) + (packedVertexBase.b << 8) + packedVertexBase.a;"),i.push("ivec3 indexPositionH = uniqueVertexIndexes & 4095;"),i.push("ivec3 indexPositionV = uniqueVertexIndexes >> 12;"),i.push("mat4 objectInstanceMatrix = mat4 (texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uTexturePerObjectMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("mat4 objectDecodeAndInstanceMatrix = objectInstanceMatrix * mat4 (texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+0, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+1, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+2, objectIndexCoords.y), 0), texelFetch (uObjectPerObjectPositionsDecodeMatrix, ivec2(objectIndexCoords.x*4+3, objectIndexCoords.y), 0));"),i.push("uint solid = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+7, objectIndexCoords.y), 0).r;"),i.push("positions[0] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.r, indexPositionV.r), 0));"),i.push("positions[1] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.g, indexPositionV.g), 0));"),i.push("positions[2] = vec3(texelFetch(uTexturePerVertexIdCoordinates, ivec2(indexPositionH.b, indexPositionV.b), 0));"),i.push("uvec4 color = texelFetch (uObjectPerObjectColorsAndFlags, ivec2(objectIndexCoords.x*8+0, objectIndexCoords.y), 0);"),i.push("if (color.a == 0u) {"),i.push("   gl_Position = vec4(3.0, 3.0, 3.0, 1.0);"),i.push("   return;"),i.push("};"),i.push("vec3 normal = normalize(cross(positions[2] - positions[0], positions[1] - positions[0]));"),i.push("vec3 position;"),i.push("position = positions[gl_VertexID % 3];"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (solid != 1u) {"),i.push("if (isPerspectiveMatrix(projMatrix)) {"),i.push("vec3 uCameraEyeRtcInQuantizedSpace = (inverse(sceneModelMatrix * objectDecodeAndInstanceMatrix) * vec4(uCameraEyeRtc, 1)).xyz;"),i.push("if (dot(position.xyz - uCameraEyeRtcInQuantizedSpace, normal) < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("viewNormal = -viewNormal;"),i.push("}"),i.push("} else {"),i.push("vec3 viewNormal = -normalize((transpose(inverse(viewMatrix*objectDecodeAndInstanceMatrix)) * vec4(normal,1)).xyz);"),i.push("if (viewNormal.z < 0.0) {"),i.push("position = positions[2 - (gl_VertexID % 3)];"),i.push("}"),i.push("}"),i.push("}"),i.push("vec4 worldPosition = sceneModelMatrix * (objectDecodeAndInstanceMatrix * vec4(position, 1.0)); "),i.push("vec4 viewPosition = viewMatrix * worldPosition; "),i.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(i.push("vFragDepth = 1.0 + clipPos.w;"),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("vWorldPosition = worldPosition;"),t&&i.push("vFlags2 = flags2.r;"),i.push("gl_Position = remapClipPos(clipPos);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const e=this._scene,t=e._sectionPlanesState.getNumAllocatedSectionPlanes()>0,i=[];if(i.push("#version 300 es"),i.push("// TrianglesDataTexturePickNormalsRenderer fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e.logarithmicDepthBufferEnabled&&(i.push("in float isPerspective;"),i.push("uniform float logDepthBufFC;"),i.push("in float vFragDepth;")),i.push("in vec4 vWorldPosition;"),t){i.push("flat in uint vFlags2;");for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)i.push("uniform bool sectionPlaneActive"+t+";"),i.push("uniform vec3 sectionPlanePos"+t+";"),i.push("uniform vec3 sectionPlaneDir"+t+";")}if(i.push("out highp ivec4 outNormal;"),i.push("void main(void) {"),t){i.push("  bool clippable = vFlags2 > 0u;"),i.push("  if (clippable) {"),i.push("  float dist = 0.0;");for(let t=0,s=e._sectionPlanesState.getNumAllocatedSectionPlanes();t<s;t++)i.push("if (sectionPlaneActive"+t+") {"),i.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),i.push("}");i.push("  if (dist > 0.0) { "),i.push("      discard;"),i.push("  }"),i.push("}")}return e.logarithmicDepthBufferEnabled&&i.push("    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),i.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),i.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),i.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),i.push(`  outNormal = ivec4(worldNormal * float(${d.MAX_INT}), 1.0);`),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class FA{constructor(e){this._scene=e}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._snapRenderer&&!this._snapRenderer.getValid()&&(this._snapRenderer.destroy(),this._snapRenderer=null),this._snapInitRenderer&&!this._snapInitRenderer.getValid()&&(this._snapInitRenderer.destroy(),this._snapInitRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!1===this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null)}eagerCreateRenders(){this._silhouetteRenderer||(this._silhouetteRenderer=new Tl(this._scene)),this._pickMeshRenderer||(this._pickMeshRenderer=new zl(this._scene)),this._pickDepthRenderer||(this._pickDepthRenderer=new Jl(this._scene)),this._pickNormalsRenderer||(this._pickNormalsRenderer=new EA(this._scene)),this._snapRenderer||(this._snapRenderer=new iA(this._scene)),this._snapInitRenderer||(this._snapInitRenderer=new lA(this._scene)),this._snapRenderer||(this._snapRenderer=new iA(this._scene))}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new xl(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new xl(this._scene,!0)),this._colorRendererWithSAO}get colorQualityRendererWithSAO(){return this._colorQualityRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Tl(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new _A(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new BA(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new Ll(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Vl(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new zl(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new EA(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new EA(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Jl(this._scene)),this._pickDepthRenderer}get snapRenderer(){return this._snapRenderer||(this._snapRenderer=new iA(this._scene)),this._snapRenderer}get snapInitRenderer(){return this._snapInitRenderer||(this._snapInitRenderer=new lA(this._scene)),this._snapInitRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new dA(this._scene)),this._occlusionRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._snapRenderer&&this._snapRenderer.destroy(),this._snapInitRenderer&&this._snapInitRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy()}}const IA={};class TA{constructor(){this.positionsCompressed=[],this.lenPositionsCompressed=0,this.metallicRoughness=[],this.indices8Bits=[],this.lenIndices8Bits=0,this.indices16Bits=[],this.lenIndices16Bits=0,this.indices32Bits=[],this.lenIndices32Bits=0,this.edgeIndices8Bits=[],this.lenEdgeIndices8Bits=0,this.edgeIndices16Bits=[],this.lenEdgeIndices16Bits=0,this.edgeIndices32Bits=[],this.lenEdgeIndices32Bits=0,this.perObjectColors=[],this.perObjectPickColors=[],this.perObjectSolid=[],this.perObjectOffsets=[],this.perObjectPositionsDecodeMatrices=[],this.perObjectInstancePositioningMatrices=[],this.perObjectVertexBases=[],this.perObjectIndexBaseOffsets=[],this.perObjectEdgeIndexBaseOffsets=[],this.perTriangleNumberPortionId8Bits=[],this.perTriangleNumberPortionId16Bits=[],this.perTriangleNumberPortionId32Bits=[],this.perEdgeNumberPortionId8Bits=[],this.perEdgeNumberPortionId16Bits=[],this.perEdgeNumberPortionId32Bits=[]}}class DA{constructor(){this.texturePerObjectColorsAndFlags=null,this.texturePerObjectOffsets=null,this.texturePerObjectInstanceMatrices=null,this.texturePerObjectPositionsDecodeMatrix=null,this.texturePerVertexIdCoordinates=null,this.texturePerPolygonIdPortionIds8Bits=null,this.texturePerPolygonIdPortionIds16Bits=null,this.texturePerPolygonIdPortionIds32Bits=null,this.texturePerEdgeIdPortionIds8Bits=null,this.texturePerEdgeIdPortionIds16Bits=null,this.texturePerEdgeIdPortionIds32Bits=null,this.texturePerPolygonIdIndices8Bits=null,this.texturePerPolygonIdIndices16Bits=null,this.texturePerPolygonIdIndices32Bits=null,this.texturePerPolygonIdEdgeIndices8Bits=null,this.texturePerPolygonIdEdgeIndices16Bits=null,this.texturePerPolygonIdEdgeIndices32Bits=null,this.textureModelMatrices=null}finalize(){this.indicesPerBitnessTextures={8:this.texturePerPolygonIdIndices8Bits,16:this.texturePerPolygonIdIndices16Bits,32:this.texturePerPolygonIdIndices32Bits},this.indicesPortionIdsPerBitnessTextures={8:this.texturePerPolygonIdPortionIds8Bits,16:this.texturePerPolygonIdPortionIds16Bits,32:this.texturePerPolygonIdPortionIds32Bits},this.edgeIndicesPerBitnessTextures={8:this.texturePerPolygonIdEdgeIndices8Bits,16:this.texturePerPolygonIdEdgeIndices16Bits,32:this.texturePerPolygonIdEdgeIndices32Bits},this.edgeIndicesPortionIdsPerBitnessTextures={8:this.texturePerEdgeIdPortionIds8Bits,16:this.texturePerEdgeIdPortionIds16Bits,32:this.texturePerEdgeIdPortionIds32Bits}}bindCommonTextures(e,t,i,s,r){this.texturePerObjectPositionsDecodeMatrix.bindTexture(e,t,1),this.texturePerVertexIdCoordinates.bindTexture(e,i,2),this.texturePerObjectColorsAndFlags.bindTexture(e,s,3),this.texturePerObjectInstanceMatrices.bindTexture(e,r,4)}bindTriangleIndicesTextures(e,t,i,s){this.indicesPortionIdsPerBitnessTextures[s].bindTexture(e,t,5),this.indicesPerBitnessTextures[s].bindTexture(e,i,6)}bindEdgeIndicesTextures(e,t,i,s){this.edgeIndicesPortionIdsPerBitnessTextures[s].bindTexture(e,t,5),this.edgeIndicesPerBitnessTextures[s].bindTexture(e,i,6)}}const SA={sizeDataColorsAndFlags:0,sizeDataPositionDecodeMatrices:0,sizeDataTextureOffsets:0,sizeDataTexturePositions:0,sizeDataTextureIndices:0,sizeDataTextureEdgeIndices:0,sizeDataTexturePortionIds:0,numberOfGeometries:0,numberOfPortions:0,numberOfLayers:0,numberOfTextures:0,totalPolygons:0,totalPolygons8Bits:0,totalPolygons16Bits:0,totalPolygons32Bits:0,totalEdges:0,totalEdges8Bits:0,totalEdges16Bits:0,totalEdges32Bits:0,cannotCreatePortion:{because10BitsObjectId:0,becauseTextureSize:0},overheadSizeAlignementIndices:0,overheadSizeAlignementEdgeIndices:0};window.printDataTextureRamStats=function(){console.log(JSON.stringify(SA,null,4));let e=0;Object.keys(SA).forEach((t=>{t.startsWith("size")&&(e+=SA[t])})),console.log(`Total size ${e} bytes (${(e/1e3/1e3).toFixed(2)} MB)`),console.log(`Avg bytes / triangle: ${(e/SA.totalPolygons).toFixed(2)}`);let t={};Object.keys(SA).forEach((i=>{i.startsWith("size")&&(t[i]=`${(SA[i]/e*100).toFixed(2)} % of total`)})),console.log(JSON.stringify({percentualRamUsage:t},null,4))};class RA{constructor(){}disableBindedTextureFiltering(e){e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}createTextureForColorsAndFlags(e,t,i,s,r,o,n){const a=t.length;this.numPortions=a;const l=4096,A=Math.ceil(a/512);if(0===A)throw"texture height===0";const c=new Uint8Array(16384*A);SA.sizeDataColorsAndFlags+=c.byteLength,SA.numberOfTextures++;for(let e=0;e<a;e++)c.set(t[e],32*e+0),c.set(i[e],32*e+4),c.set([0,0,0,0],32*e+8),c.set([0,0,0,0],32*e+12),c.set([s[e]>>24&255,s[e]>>16&255,s[e]>>8&255,255&s[e]],32*e+16),c.set([r[e]>>24&255,r[e]>>16&255,r[e]>>8&255,255&r[e]],32*e+20),c.set([o[e]>>24&255,o[e]>>16&255,o[e]>>8&255,255&o[e]],32*e+24),c.set([n[e]?1:0,0,0,0],32*e+28);const h=e.createTexture();return e.bindTexture(e.TEXTURE_2D,h),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA8UI,l,A),e.texSubImage2D(e.TEXTURE_2D,0,0,0,l,A,e.RGBA_INTEGER,e.UNSIGNED_BYTE,c,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Al(e,h,l,A,c)}createTextureForObjectOffsets(e,t){const i=512,s=Math.ceil(t/i);if(0===s)throw"texture height===0";const r=new Float32Array(1536*s).fill(0);SA.sizeDataTextureOffsets+=r.byteLength,SA.numberOfTextures++;const o=e.createTexture();return e.bindTexture(e.TEXTURE_2D,o),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32F,i,s),e.texSubImage2D(e.TEXTURE_2D,0,0,0,i,s,e.RGB,e.FLOAT,r,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Al(e,o,i,s,r)}createTextureForInstancingMatrices(e,t){const i=t.length;if(0===i)throw"num instance matrices===0";const s=2048,r=Math.ceil(i/512),o=new Float32Array(8192*r);SA.numberOfTextures++;for(let e=0;e<t.length;e++)o.set(t[e],16*e);const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RGBA,e.FLOAT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r,o)}createTextureForPositionsDecodeMatrices(e,t){const i=t.length;if(0===i)throw"num decode+entity matrices===0";const s=2048,r=Math.ceil(i/512),o=new Float32Array(8192*r);SA.sizeDataPositionDecodeMatrices+=o.byteLength,SA.numberOfTextures++;for(let e=0;e<t.length;e++)o.set(t[e],16*e);const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RGBA,e.FLOAT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}createTextureFor8BitIndices(e,t,i){if(0===i)return{texture:null,textureHeight:0};const s=4096,r=Math.ceil(i/3/s);if(0===r)throw"texture height===0";const o=new Uint8Array(s*r*3);SA.sizeDataTextureIndices+=o.byteLength,SA.numberOfTextures++;for(let e=0,i=0,s=t.length;e<s;e++){const s=t[e];o.set(s,i),i+=s.length}const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB8UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RGB_INTEGER,e.UNSIGNED_BYTE,o,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}createTextureFor16BitIndices(e,t,i){if(0===i)return{texture:null,textureHeight:0};const s=4096,r=Math.ceil(i/3/s);if(0===r)throw"texture height===0";const o=new Uint16Array(s*r*3);SA.sizeDataTextureIndices+=o.byteLength,SA.numberOfTextures++;for(let e=0,i=0,s=t.length;e<s;e++){const s=t[e];o.set(s,i),i+=s.length}const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RGB_INTEGER,e.UNSIGNED_SHORT,o,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}createTextureFor32BitIndices(e,t,i){if(0===i)return{texture:null,textureHeight:0};const s=4096,r=Math.ceil(i/3/s);if(0===r)throw"texture height===0";const o=new Uint32Array(s*r*3);SA.sizeDataTextureIndices+=o.byteLength,SA.numberOfTextures++;for(let e=0,i=0,s=t.length;e<s;e++){const s=t[e];o.set(s,i),i+=s.length}const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RGB32UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RGB_INTEGER,e.UNSIGNED_INT,o,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}createTextureFor8BitsEdgeIndices(e,t,i){if(0===i)return{texture:null,textureHeight:0};const s=4096,r=Math.ceil(i/2/s);if(0===r)throw"texture height===0";const o=new Uint8Array(s*r*2);SA.sizeDataTextureEdgeIndices+=o.byteLength,SA.numberOfTextures++;for(let e=0,i=0,s=t.length;e<s;e++){const s=t[e];o.set(s,i),i+=s.length}const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RG8UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RG_INTEGER,e.UNSIGNED_BYTE,o,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}createTextureFor16BitsEdgeIndices(e,t,i){if(0===i)return{texture:null,textureHeight:0};const s=4096,r=Math.ceil(i/2/s);if(0===r)throw"texture height===0";const o=new Uint16Array(s*r*2);SA.sizeDataTextureEdgeIndices+=o.byteLength,SA.numberOfTextures++;for(let e=0,i=0,s=t.length;e<s;e++){const s=t[e];o.set(s,i),i+=s.length}const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RG16UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RG_INTEGER,e.UNSIGNED_SHORT,o,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}createTextureFor32BitsEdgeIndices(e,t,i){if(0===i)return{texture:null,textureHeight:0};const s=4096,r=Math.ceil(i/2/s);if(0===r)throw"texture height===0";const o=new Uint32Array(s*r*2);SA.sizeDataTextureEdgeIndices+=o.byteLength,SA.numberOfTextures++;for(let e=0,i=0,s=t.length;e<s;e++){const s=t[e];o.set(s,i),i+=s.length}const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.RG32UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RG_INTEGER,e.UNSIGNED_INT,o,0),this.disableBindedTextureFiltering(e),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}createTextureForPositions(e,t,i){const s=i/3,r=4096,o=Math.ceil(s/r);if(0===o)throw"texture height===0";const n=new Uint16Array(r*o*3);SA.sizeDataTexturePositions+=n.byteLength,SA.numberOfTextures++;for(let e=0,i=0,s=t.length;e<s;e++){const s=t[e];n.set(s,i),i+=s.length}const a=e.createTexture();return e.bindTexture(e.TEXTURE_2D,a),e.texStorage2D(e.TEXTURE_2D,1,e.RGB16UI,r,o),e.texSubImage2D(e.TEXTURE_2D,0,0,0,r,o,e.RGB_INTEGER,e.UNSIGNED_SHORT,n,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Al(e,a,r,o)}createTextureForPackedPortionIds(e,t){if(0===t.length)return{texture:null,textureHeight:0};const i=t.length,s=4096,r=Math.ceil(i/s);if(0===r)throw"texture height===0";const o=new Uint16Array(s*r);o.set(t,0),SA.sizeDataTexturePortionIds+=o.byteLength,SA.numberOfTextures++;const n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texStorage2D(e.TEXTURE_2D,1,e.R16UI,s,r),e.texSubImage2D(e.TEXTURE_2D,0,0,0,s,r,e.RED_INTEGER,e.UNSIGNED_SHORT,o,0),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),new Al(e,n,s,r)}}const UA=new ho,LA=UA.maxDataTextureHeight,kA=d.vec4(),OA=new Float32Array(16),NA=new Uint8Array(4),VA=new Float32Array(3);let QA=0;const HA=d.identityMat4();class jA{constructor(e,t){SA.numberOfLayers++,this._layerNumber=QA++,this.sortId=`TriDTX-${this._layerNumber}`,this.layerIndex=t.layerIndex,this._renderers=function(e){const t=e.id;let i=IA[t];return i||(i=new FA(e),IA[t]=i,i._compile(),i.eagerCreateRenders(),e.on("compile",(()=>{i._compile(),i.eagerCreateRenders()})),e.on("destroyed",(()=>{delete IA[t],i._destroy()}))),i}(e.scene),this.model=e,this._buffer=new TA,this._dtxState=new DA,this._dtxTextureFactory=new RA,this._state=new ae({origin:d.vec3(t.origin),metallicRoughnessBuf:null,textureState:this._dtxState,numIndices8Bits:0,numIndices16Bits:0,numIndices32Bits:0,numEdgeIndices8Bits:0,numEdgeIndices16Bits:0,numEdgeIndices32Bits:0,numVertices:0}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._subPortions=[],this.model.scene.readableGeometryEnabled&&(this._subPortionReadableGeometries={}),this._portionToSubPortionsMap=[],this._bucketGeometries={},this._meshes=[],this._aabb=d.collapseAABB3(),this.aabbDirty=!0,this._numUpdatesInFrame=0,this.primitive=t.primitive,this._finalized=!1}get aabb(){if(this.aabbDirty){d.collapseAABB3(this._aabb);for(let e=0,t=this._meshes.length;e<t;e++)d.expandAABB3(this._aabb,this._meshes[e].aabb);this.aabbDirty=!1}return this._aabb}canCreatePortion(e){if(this._finalized)throw"Already finalized";const t=e.buckets.length;this._numPortions+t>65536&&SA.cannotCreatePortion.because10BitsObjectId++;let i=this._numPortions+t<=65536;const s=void 0!==e.geometryId&&null!==e.geometryId?`${e.geometryId}#0`:`${e.id}#0`;if(!this._bucketGeometries[s]){const t=Math.max(this._state.numIndices8Bits,this._state.numIndices16Bits,this._state.numIndices32Bits);let s=0,r=0;e.buckets.forEach((e=>{s+=e.positionsCompressed.length/3,r+=e.indices.length/3})),(this._state.numVertices+s>4096*LA||t+r>4096*LA)&&SA.cannotCreatePortion.becauseTextureSize++,i&&=this._state.numVertices+s<=4096*LA&&t+r<=4096*LA}return i}createPortion(e,t){if(this._finalized)throw"Already finalized";const i=[];t.buckets.forEach(((e,s)=>{const r=void 0!==t.geometryId&&null!==t.geometryId?`${t.geometryId}#${s}`:`${t.id}#${s}`;let o=this._bucketGeometries[r];o||(o=this._createBucketGeometry(t,e),this._bucketGeometries[r]=o);const n=this._createSubPortion(t,o,e);i.push(n)}));const s=this._portionToSubPortionsMap.length;return this._portionToSubPortionsMap.push(i),this.model.numPortions++,this._meshes.push(e),s}_createBucketGeometry(e,t){if(t.indices){const e=8*Math.ceil(t.indices.length/3/8)*3;SA.overheadSizeAlignementIndices+=2*(e-t.indices.length);const i=new Uint32Array(e);i.fill(0),i.set(t.indices),t.indices=i}if(t.edgeIndices){const e=8*Math.ceil(t.edgeIndices.length/2/8)*2;SA.overheadSizeAlignementEdgeIndices+=2*(e-t.edgeIndices.length);const i=new Uint32Array(e);i.fill(0),i.set(t.edgeIndices),t.edgeIndices=i}const i=t.positionsCompressed,s=t.indices,r=t.edgeIndices,o=this._buffer;o.positionsCompressed.push(i);const n=o.lenPositionsCompressed/3,a=i.length/3;let l;o.lenPositionsCompressed+=i.length;let A,c=0;if(s){let e;c=s.length/3,a<=256?(e=o.indices8Bits,l=o.lenIndices8Bits/3,o.lenIndices8Bits+=s.length):a<=65536?(e=o.indices16Bits,l=o.lenIndices16Bits/3,o.lenIndices16Bits+=s.length):(e=o.indices32Bits,l=o.lenIndices32Bits/3,o.lenIndices32Bits+=s.length),e.push(s)}let h=0;if(r){let e;h=r.length/2,a<=256?(e=o.edgeIndices8Bits,A=o.lenEdgeIndices8Bits/2,o.lenEdgeIndices8Bits+=r.length):a<=65536?(e=o.edgeIndices16Bits,A=o.lenEdgeIndices16Bits/2,o.lenEdgeIndices16Bits+=r.length):(e=o.edgeIndices32Bits,A=o.lenEdgeIndices32Bits/2,o.lenEdgeIndices32Bits+=r.length),e.push(r)}this._state.numVertices+=a,SA.numberOfGeometries++;return{vertexBase:n,numVertices:a,numTriangles:c,numEdges:h,indicesBase:l,edgeIndicesBase:A}}_createSubPortion(e,t,i,s){const r=e.color;e.metallic,e.roughness;const o=e.colors,n=e.opacity,a=e.meshMatrix,l=e.pickColor,A=this._buffer,c=this._state;A.perObjectPositionsDecodeMatrices.push(e.positionsDecodeMatrix),A.perObjectInstancePositioningMatrices.push(a||HA),A.perObjectSolid.push(!!e.solid),o?A.perObjectColors.push([255*o[0],255*o[1],255*o[2],255]):r&&A.perObjectColors.push([r[0],r[1],r[2],n]),A.perObjectPickColors.push(l),A.perObjectVertexBases.push(t.vertexBase);{let e;e=t.numVertices<=256?c.numIndices8Bits:t.numVertices<=65536?c.numIndices16Bits:c.numIndices32Bits,A.perObjectIndexBaseOffsets.push(e/3-t.indicesBase)}{let e;e=t.numVertices<=256?c.numEdgeIndices8Bits:t.numVertices<=65536?c.numEdgeIndices16Bits:c.numEdgeIndices32Bits,A.perObjectEdgeIndexBaseOffsets.push(e/2-t.edgeIndicesBase)}const h=this._subPortions.length;if(t.numTriangles>0){let e,i=3*t.numTriangles;t.numVertices<=256?(e=A.perTriangleNumberPortionId8Bits,c.numIndices8Bits+=i,SA.totalPolygons8Bits+=t.numTriangles):t.numVertices<=65536?(e=A.perTriangleNumberPortionId16Bits,c.numIndices16Bits+=i,SA.totalPolygons16Bits+=t.numTriangles):(e=A.perTriangleNumberPortionId32Bits,c.numIndices32Bits+=i,SA.totalPolygons32Bits+=t.numTriangles),SA.totalPolygons+=t.numTriangles;for(let i=0;i<t.numTriangles;i+=8)e.push(h)}if(t.numEdges>0){let e,i=2*t.numEdges;t.numVertices<=256?(e=A.perEdgeNumberPortionId8Bits,c.numEdgeIndices8Bits+=i,SA.totalEdges8Bits+=t.numEdges):t.numVertices<=65536?(e=A.perEdgeNumberPortionId16Bits,c.numEdgeIndices16Bits+=i,SA.totalEdges16Bits+=t.numEdges):(e=A.perEdgeNumberPortionId32Bits,c.numEdgeIndices32Bits+=i,SA.totalEdges32Bits+=t.numEdges),SA.totalEdges+=t.numEdges;for(let i=0;i<t.numEdges;i+=8)e.push(h)}return this._subPortions.push({numVertices:t.numTriangles}),this.model.scene.readableGeometryEnabled&&(this._subPortionReadableGeometries[h]={indices:i.indices,positionsCompressed:i.positionsCompressed,positionsDecodeMatrix:e.positionsDecodeMatrix,meshMatrix:e.meshMatrix}),this._numPortions++,SA.numberOfPortions++,h}finalize(){if(this._finalized)return;const e=this._state,t=this._dtxState,i=this.model.scene.canvas.gl,s=this._buffer;e.gl=i,t.texturePerObjectColorsAndFlags=this._dtxTextureFactory.createTextureForColorsAndFlags(i,s.perObjectColors,s.perObjectPickColors,s.perObjectVertexBases,s.perObjectIndexBaseOffsets,s.perObjectEdgeIndexBaseOffsets,s.perObjectSolid),t.texturePerObjectInstanceMatrices=this._dtxTextureFactory.createTextureForInstancingMatrices(i,s.perObjectInstancePositioningMatrices),t.texturePerObjectPositionsDecodeMatrix=this._dtxTextureFactory.createTextureForPositionsDecodeMatrices(i,s.perObjectPositionsDecodeMatrices),t.texturePerVertexIdCoordinates=this._dtxTextureFactory.createTextureForPositions(i,s.positionsCompressed,s.lenPositionsCompressed),t.texturePerPolygonIdPortionIds8Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perTriangleNumberPortionId8Bits),t.texturePerPolygonIdPortionIds16Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perTriangleNumberPortionId16Bits),t.texturePerPolygonIdPortionIds32Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perTriangleNumberPortionId32Bits),s.perEdgeNumberPortionId8Bits.length>0&&(t.texturePerEdgeIdPortionIds8Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perEdgeNumberPortionId8Bits)),s.perEdgeNumberPortionId16Bits.length>0&&(t.texturePerEdgeIdPortionIds16Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perEdgeNumberPortionId16Bits)),s.perEdgeNumberPortionId32Bits.length>0&&(t.texturePerEdgeIdPortionIds32Bits=this._dtxTextureFactory.createTextureForPackedPortionIds(i,s.perEdgeNumberPortionId32Bits)),s.lenIndices8Bits>0&&(t.texturePerPolygonIdIndices8Bits=this._dtxTextureFactory.createTextureFor8BitIndices(i,s.indices8Bits,s.lenIndices8Bits)),s.lenIndices16Bits>0&&(t.texturePerPolygonIdIndices16Bits=this._dtxTextureFactory.createTextureFor16BitIndices(i,s.indices16Bits,s.lenIndices16Bits)),s.lenIndices32Bits>0&&(t.texturePerPolygonIdIndices32Bits=this._dtxTextureFactory.createTextureFor32BitIndices(i,s.indices32Bits,s.lenIndices32Bits)),s.lenEdgeIndices8Bits>0&&(t.texturePerPolygonIdEdgeIndices8Bits=this._dtxTextureFactory.createTextureFor8BitsEdgeIndices(i,s.edgeIndices8Bits,s.lenEdgeIndices8Bits)),s.lenEdgeIndices16Bits>0&&(t.texturePerPolygonIdEdgeIndices16Bits=this._dtxTextureFactory.createTextureFor16BitsEdgeIndices(i,s.edgeIndices16Bits,s.lenEdgeIndices16Bits)),s.lenEdgeIndices32Bits>0&&(t.texturePerPolygonIdEdgeIndices32Bits=this._dtxTextureFactory.createTextureFor32BitsEdgeIndices(i,s.edgeIndices32Bits,s.lenEdgeIndices32Bits)),t.finalize(),this._buffer=null,this._bucketGeometries={},this._finalized=!0,this._deferredSetFlagsDirty=!1,this._onSceneRendering=this.model.scene.on("rendering",(()=>{this._deferredSetFlagsDirty&&this._uploadDeferredFlags(),this._numUpdatesInFrame=0}))}isEmpty(){return 0===this._numPortions}initFlags(e,t,i){t&fr&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),t&yr&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),t&br&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),t&wr&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),t&_r&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),t&Br&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),t&gr&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),t&mr&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(e,t,i,true),this._setFlags2(e,t,true)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(e,t,i){if(!this._finalized)throw"Not finalized";t&fr?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(e,t,i)}setHighlighted(e,t,i){if(!this._finalized)throw"Not finalized";t&yr?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(e,t,i)}setXRayed(e,t,i){if(!this._finalized)throw"Not finalized";t&br?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(e,t,i)}setSelected(e,t,i){if(!this._finalized)throw"Not finalized";t&wr?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(e,t,i)}setEdges(e,t,i){if(!this._finalized)throw"Not finalized";t&Br?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(e,t,i)}setClippable(e,t){if(!this._finalized)throw"Not finalized";t&_r?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(e,t)}_beginDeferredFlags(){this._deferredSetFlagsActive=!0}_uploadDeferredFlags(){if(this._deferredSetFlagsActive=!1,!this._deferredSetFlagsDirty)return;this._deferredSetFlagsDirty=!1;const e=this.model.scene.canvas.gl,t=this._dtxState;e.bindTexture(e.TEXTURE_2D,t.texturePerObjectColorsAndFlags._texture),e.texSubImage2D(e.TEXTURE_2D,0,0,0,t.texturePerObjectColorsAndFlags._textureWidth,t.texturePerObjectColorsAndFlags._textureHeight,e.RGBA_INTEGER,e.UNSIGNED_BYTE,t.texturePerObjectColorsAndFlags._textureData)}setCulled(e,t,i){if(!this._finalized)throw"Not finalized";t&mr?(this._numCulledLayerPortions+=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions-=this._portionToSubPortionsMap[e].length,this.model.numCulledLayerPortions--),this._setFlags(e,t,i)}setCollidable(e,t){if(!this._finalized)throw"Not finalized"}setPickable(e,t,i){if(!this._finalized)throw"Not finalized";t&gr?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(e,t,i)}setColor(e,t){const i=this._portionToSubPortionsMap[e];for(let e=0,s=i.length;e<s;e++)this._subPortionSetColor(i[e],t)}_subPortionSetColor(e,t){if(!this._finalized)throw"Not finalized";const i=this._dtxState,s=this.model.scene.canvas.gl;NA[0]=t[0],NA[1]=t[1],NA[2]=t[2],NA[3]=t[3],i.texturePerObjectColorsAndFlags._textureData.set(NA,32*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectColorsAndFlags._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*8,Math.floor(e/512),1,1,s.RGBA_INTEGER,s.UNSIGNED_BYTE,NA))}setTransparent(e,t,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(e,t,i)}_setFlags(e,t,i,s=!1){const r=this._portionToSubPortionsMap[e];for(let e=0,o=r.length;e<o;e++)this._subPortionSetFlags(r[e],t,i,s)}_subPortionSetFlags(e,t,i,s=!1){if(!this._finalized)throw"Not finalized";const r=!!(t&fr),o=!!(t&br),n=!!(t&yr),a=!!(t&wr),l=!!(t&Br),A=!!(t&gr),c=!!(t&mr);let h,u;h=!r||c||o||n&&!this.model.scene.highlightMaterial.glowThrough||a&&!this.model.scene.selectedMaterial.glowThrough?Pr.NOT_RENDERED:i?Pr.COLOR_TRANSPARENT:Pr.COLOR_OPAQUE,u=!r||c?Pr.NOT_RENDERED:a?Pr.SILHOUETTE_SELECTED:n?Pr.SILHOUETTE_HIGHLIGHTED:o?Pr.SILHOUETTE_XRAYED:Pr.NOT_RENDERED;let d=0;d=!r||c?Pr.NOT_RENDERED:a?Pr.EDGES_SELECTED:n?Pr.EDGES_HIGHLIGHTED:o?Pr.EDGES_XRAYED:l?i?Pr.EDGES_COLOR_TRANSPARENT:Pr.EDGES_COLOR_OPAQUE:Pr.NOT_RENDERED;let p=r&&!c&&A?Pr.PICK:Pr.NOT_RENDERED;const f=this._dtxState,m=this.model.scene.canvas.gl;NA[0]=h,NA[1]=u,NA[2]=d,NA[3]=p,f.texturePerObjectColorsAndFlags._textureData.set(NA,32*e+8),this._deferredSetFlagsActive||s?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),m.bindTexture(m.TEXTURE_2D,f.texturePerObjectColorsAndFlags._texture),m.texSubImage2D(m.TEXTURE_2D,0,e%512*8+2,Math.floor(e/512),1,1,m.RGBA_INTEGER,m.UNSIGNED_BYTE,NA))}_setDeferredFlags(){}_setFlags2(e,t,i=!1){const s=this._portionToSubPortionsMap[e];for(let e=0,r=s.length;e<r;e++)this._subPortionSetFlags2(s[e],t,i)}_subPortionSetFlags2(e,t,i=!1){if(!this._finalized)throw"Not finalized";const s=t&_r?255:0,r=this._dtxState,o=this.model.scene.canvas.gl;NA[0]=s,NA[1]=0,NA[2]=1,NA[3]=2,r.texturePerObjectColorsAndFlags._textureData.set(NA,32*e+12),this._deferredSetFlagsActive||i?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),o.bindTexture(o.TEXTURE_2D,r.texturePerObjectColorsAndFlags._texture),o.texSubImage2D(o.TEXTURE_2D,0,e%512*8+3,Math.floor(e/512),1,1,o.RGBA_INTEGER,o.UNSIGNED_BYTE,NA))}_setDeferredFlags2(){}setOffset(e,t){const i=this._portionToSubPortionsMap[e];for(let e=0,s=i.length;e<s;e++)this._subPortionSetOffset(i[e],t)}_subPortionSetOffset(e,t){if(!this._finalized)throw"Not finalized";const i=this._dtxState,s=this.model.scene.canvas.gl;VA[0]=t[0],VA[1]=t[1],VA[2]=t[2],i.texturePerObjectOffsets._textureData.set(VA,3*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectOffsets._texture),s.texSubImage2D(s.TEXTURE_2D,0,0,e,1,1,s.RGB,s.FLOAT,VA))}setMatrix(e,t){const i=this._portionToSubPortionsMap[e];for(let e=0,s=i.length;e<s;e++)this._subPortionSetMatrix(i[e],t)}_subPortionSetMatrix(e,t){if(!this._finalized)throw"Not finalized";const i=this._dtxState,s=this.model.scene.canvas.gl;OA.set(t),i.texturePerObjectInstanceMatrices._textureData.set(OA,16*e),this._deferredSetFlagsActive?this._deferredSetFlagsDirty=!0:(++this._numUpdatesInFrame>=10&&this._beginDeferredFlags(),s.bindTexture(s.TEXTURE_2D,i.texturePerObjectInstanceMatrices._texture),s.texSubImage2D(s.TEXTURE_2D,0,e%512*4,Math.floor(e/512),4,1,s.RGBA,s.FLOAT,OA))}getEachVertex(e,t){if(!this.model.scene.readableGeometryEnabled)return;const i=this._state,s=this._portionToSubPortionsMap[e];if(s)for(let e=0,r=s.length;e<r;e++){const r=s[e],o=this._subPortionReadableGeometries[r],n=o.positionsCompressed,a=o.positionsDecodeMatrix;o.meshMatrix;const l=i.origin,A=l[0],c=l[1],h=l[2],u=kA;for(let e=0,i=n.length;e<i;e+=3)u[0]=n[e],u[1]=n[e+1],u[2]=n[e+2],u[3]=1,d.decompressPosition(u,a),d.mulMat4v4(this.model.worldMatrix,u,u),u[0]+=A,u[1]+=c,u[2]+=h,t(u)}else this.model.error("portion not found: "+e)}getEachIndex(e,t){if(!this.model.scene.readableGeometryEnabled)return;const i=this._portionToSubPortionsMap[e];if(i)for(let e=0,s=i.length;e<s;e++){const s=i[e],r=this._subPortionReadableGeometries[s].indices;for(let e=0,i=r.length;e<i;e++)t(r[e])}else this.model.error("portion not found: "+e)}drawColorOpaque(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),t.withSAO&&this.model.saoEnabled?this._renderers.colorRendererWithSAO&&this._renderers.colorRendererWithSAO.drawLayer(t,this,Pr.COLOR_OPAQUE):this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}_updateBackfaceCull(e,t){if(true!==t.backfaces){const e=t.gl;e.disable(e.CULL_FACE),t.backfaces=true}}drawColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.colorRenderer&&this._renderers.colorRenderer.drawLayer(t,this,Pr.COLOR_TRANSPARENT))}drawDepth(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.depthRenderer&&this._renderers.depthRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}drawNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(e,t),this._renderers.normalsRenderer&&this._renderers.normalsRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}drawSilhouetteXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_XRAYED))}drawSilhouetteHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_HIGHLIGHTED))}drawSilhouetteSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.silhouetteRenderer&&this._renderers.silhouetteRenderer.drawLayer(t,this,Pr.SILHOUETTE_SELECTED))}drawEdgesColorOpaque(e,t){this.model.scene.logarithmicDepthBufferEnabled?this.model.scene._loggedWarning||(console.log("Edge enhancement for SceneModel data texture layers currently disabled with logarithmic depth buffer"),this.model.scene._loggedWarning=!0):this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,Pr.EDGES_COLOR_OPAQUE)}drawEdgesColorTransparent(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._renderers.edgesColorRenderer&&this._renderers.edgesColorRenderer.drawLayer(t,this,Pr.EDGES_COLOR_TRANSPARENT)}drawEdgesHighlighted(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Pr.EDGES_HIGHLIGHTED)}drawEdgesSelected(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Pr.EDGES_SELECTED)}drawEdgesXRayed(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._renderers.edgesRenderer&&this._renderers.edgesRenderer.drawLayer(t,this,Pr.EDGES_XRAYED)}drawOcclusion(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.occlusionRenderer&&this._renderers.occlusionRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}drawShadow(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.shadowRenderer&&this._renderers.shadowRenderer.drawLayer(t,this,Pr.COLOR_OPAQUE))}setPickMatrices(e,t){}drawPickMesh(e,t){0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickMeshRenderer&&this._renderers.pickMeshRenderer.drawLayer(t,this,Pr.PICK))}drawPickDepths(e,t){0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickDepthRenderer&&this._renderers.pickDepthRenderer.drawLayer(t,this,Pr.PICK))}drawSnapInit(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.snapInitRenderer&&this._renderers.snapInitRenderer.drawLayer(t,this,Pr.PICK))}drawSnap(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.snapRenderer&&this._renderers.snapRenderer.drawLayer(t,this,Pr.PICK))}drawPickNormals(e,t){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(e,t),this._renderers.pickNormalsRenderer&&this._renderers.pickNormalsRenderer.drawLayer(t,this,Pr.PICK))}destroy(){if(this._destroyed)return;const e=this._state;e.metallicRoughnessBuf&&(e.metallicRoughnessBuf.destroy(),e.metallicRoughnessBuf=null),this.model.scene.off(this._onSceneRendering),e.destroy(),this._destroyed=!0}}class GA{constructor(e){this.id=e.id,this.colorTexture=e.colorTexture,this.alphaCutoff=e.alphaCutoff,this.metallicRoughnessTexture=e.metallicRoughnessTexture,this.normalsTexture=e.normalsTexture,this.emissiveTexture=e.emissiveTexture,this.occlusionTexture=e.occlusionTexture}destroy(){}}class zA{constructor(e){this.id=e.id,this.texture=e.texture}destroy(){this.texture&&(this.texture.destroy(),this.texture=null)}}const WA={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};class XA{constructor(e,t,i){this.isLoading=!1,this.itemsLoaded=0,this.itemsTotal=0,this.urlModifier=void 0,this.handlers=[],this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i}itemStart(e){this.itemsTotal++,!1===this.isLoading&&void 0!==this.onStart&&this.onStart(e,this.itemsLoaded,this.itemsTotal),this.isLoading=!0}itemEnd(e){this.itemsLoaded++,void 0!==this.onProgress&&this.onProgress(e,this.itemsLoaded,this.itemsTotal),this.itemsLoaded===this.itemsTotal&&(this.isLoading=!1,void 0!==this.onLoad&&this.onLoad())}itemError(e){void 0!==this.onError&&this.onError(e)}resolveURL(e){return this.urlModifier?this.urlModifier(e):e}setURLModifier(e){return this.urlModifier=e,this}addHandler(e,t){return this.handlers.push(e,t),this}removeHandler(e){const t=this.handlers.indexOf(e);return-1!==t&&this.handlers.splice(t,2),this}getHandler(e){for(let t=0,i=this.handlers.length;t<i;t+=2){const i=this.handlers[t],s=this.handlers[t+1];if(i.global&&(i.lastIndex=0),i.test(e))return s}return null}}const KA=new XA;class ZA{constructor(e){this.manager=void 0!==e?e:KA,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const i=this;return new Promise((function(s,r){i.load(e,s,t,r)}))}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}const JA={};class YA extends ZA{constructor(e){super(e)}load(e,t,i,s){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=WA.get(e);if(void 0!==r)return this.manager.itemStart(e),I.scheduleTask((()=>{t&&t(r),this.manager.itemEnd(e)}),0),r;if(void 0!==JA[e])return void JA[e].push({onLoad:t,onProgress:i,onError:s});JA[e]=[],JA[e].push({onLoad:t,onProgress:i,onError:s});const o=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),n=this.mimeType,a=this.responseType;fetch(o).then((t=>{if(200===t.status||0===t.status){if(0===t.status&&console.warn("FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body.getReader)return t;const i=JA[e],s=t.body.getReader(),r=t.headers.get("Content-Length"),o=r?parseInt(r):0,n=0!==o;let a=0;const l=new ReadableStream({start(e){!function t(){s.read().then((({done:s,value:r})=>{if(s)e.close();else{a+=r.byteLength;const s=new ProgressEvent("progress",{lengthComputable:n,loaded:a,total:o});for(let e=0,t=i.length;e<t;e++){const t=i[e];t.onProgress&&t.onProgress(s)}e.enqueue(r),t()}}))}()}});return new Response(l)}throw Error(`fetch for "${t.url}" responded with ${t.status}: ${t.statusText}`)})).then((e=>{switch(a){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then((e=>(new DOMParser).parseFromString(e,n)));case"json":return e.json();default:if(void 0===n)return e.text();{const t=/charset="?([^;"\s]*)"?/i.exec(n),i=t&&t[1]?t[1].toLowerCase():void 0,s=new TextDecoder(i);return e.arrayBuffer().then((e=>s.decode(e)))}}})).then((t=>{WA.add(e,t);const i=JA[e];delete JA[e];for(let e=0,s=i.length;e<s;e++){const s=i[e];s.onLoad&&s.onLoad(t)}})).catch((t=>{const i=JA[e];if(void 0===i)throw this.manager.itemError(e),t;delete JA[e];for(let e=0,s=i.length;e<s;e++){const s=i[e];s.onError&&s.onError(t)}this.manager.itemError(e)})).finally((()=>{this.manager.itemEnd(e)})),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class qA{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const i=this.workersResolve[e];if(i&&i(t),this.queue.length){const{resolve:t,msg:i,transfer:s}=this.queue.shift();this.workersResolve[e]=t,this.workers[e].postMessage(i,s)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise((i=>{const s=this._getIdleWorker();-1!==s?(this._initWorker(s),this.workerStatus|=1<<s,this.workersResolve[s]=i,this.workers[s].postMessage(e,t)):this.queue.push({resolve:i,msg:e,transfer:t})}))}destroy(){this.workers.forEach((e=>e.terminate())),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}let $A=0;class ec{constructor({viewer:e,transcoderPath:t,workerLimit:i}){this._transcoderPath=t||"https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk/dist/basis/",this._transcoderBinary=null,this._transcoderPending=null,this._workerPool=new qA,this._workerSourceURL="",i&&this._workerPool.setWorkerLimit(i);const s=e.capabilities;this._workerConfig={astcSupported:s.astcSupported,etc1Supported:s.etc1Supported,etc2Supported:s.etc2Supported,dxtSupported:s.dxtSupported,bptcSupported:s.bptcSupported,pvrtcSupported:s.pvrtcSupported},this._supportedFileTypes=["xkt2"]}_init(){if(!this._transcoderPending){const e=new YA;e.setPath(this._transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),i=new YA;i.setPath(this._transcoderPath),i.setResponseType("arraybuffer"),i.setWithCredentials(this.withCredentials);const s=i.loadAsync("basis_transcoder.wasm");this._transcoderPending=Promise.all([t,s]).then((([e,t])=>{const i=ec.BasisWorker.toString(),s=["/* constants */","let _EngineFormat = "+JSON.stringify(ec.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(ec.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(ec.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this._workerSourceURL=URL.createObjectURL(new Blob([s])),this._transcoderBinary=t,this._workerPool.setWorkerCreator((()=>{const e=new Worker(this._workerSourceURL),t=this._transcoderBinary.slice(0);return e.postMessage({type:"init",config:this._workerConfig,transcoderBinary:t},[t]),e}))})),$A>0&&console.warn("KTX2TextureTranscoder: Multiple active KTX2TextureTranscoder may cause performance issues. Use a single KTX2TextureTranscoder instance, or call .dispose() on old instances."),$A++}return this._transcoderPending}transcode(e,t,i={}){return new Promise(((s,r)=>{const o=i;this._init().then((()=>this._workerPool.postMessage({type:"transcode",buffers:e,taskConfig:o},e))).then((e=>{const i=e.data,{mipmaps:o,width:n,height:a,format:l,type:A,error:c,dfdTransferFn:h,dfdFlags:u}=i;if("error"===A)return r(c);t.setCompressedData({mipmaps:o,props:{format:l,minFilter:1===o.length?1006:1008,magFilter:1===o.length?1006:1008,encoding:2===h?3001:3e3,premultiplyAlpha:!!(1&u)}}),s()}))}))}destroy(){URL.revokeObjectURL(this._workerSourceURL),this._workerPool.destroy(),$A--}}ec.BasisFormat={ETC1S:0,UASTC_4x4:1},ec.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16},ec.EngineFormat={RGBAFormat:1023,RGBA_ASTC_4x4_Format:37808,RGBA_BPTC_Format:36492,RGBA_ETC2_EAC_Format:37496,RGBA_PVRTC_4BPPV1_Format:35842,RGBA_S3TC_DXT5_Format:33779,RGB_ETC1_Format:36196,RGB_ETC2_Format:37492,RGB_PVRTC_4BPPV1_Format:35840,RGB_S3TC_DXT1_Format:33776},ec.BasisWorker=function(){let e,t,i;const s=_EngineFormat,r=_TranscoderFormat,o=_BasisFormat;self.addEventListener("message",(function(n){const c=n.data;switch(c.type){case"init":e=c.config,h=c.transcoderBinary,t=new Promise((e=>{i={wasmBinary:h,onRuntimeInitialized:e},BASIS(i)})).then((()=>{i.initializeBasis(),void 0===i.KTX2File&&console.warn("KTX2TextureTranscoder: Please update Basis Universal transcoder.")}));break;case"transcode":t.then((()=>{try{const{width:t,height:n,hasAlpha:h,mipmaps:u,format:d,dfdTransferFn:p,dfdFlags:f}=function(t){const n=new i.KTX2File(new Uint8Array(t));function c(){n.close(),n.delete()}if(!n.isValid())throw c(),new Error("KTX2TextureTranscoder: Invalid or unsupported .ktx2 file");const h=n.isUASTC()?o.UASTC_4x4:o.ETC1S,u=n.getWidth(),d=n.getHeight(),p=n.getLevels(),f=n.getHasAlpha(),m=n.getDFDTransferFunc(),g=n.getDFDFlags(),{transcoderFormat:_,engineFormat:v}=function(t,i,n,c){let h,u;const d=t===o.ETC1S?a:l;for(let s=0;s<d.length;s++){const r=d[s];if(e[r.if]&&(r.basisFormat.includes(t)&&!(c&&r.transcoderFormat.length<2)&&(!r.needsPowerOfTwo||A(i)&&A(n))))return h=r.transcoderFormat[c?1:0],u=r.engineFormat[c?1:0],{transcoderFormat:h,engineFormat:u}}return console.warn("KTX2TextureTranscoder: No suitable compressed texture format found. Decoding to RGBA32."),h=r.RGBA32,u=s.RGBAFormat,{transcoderFormat:h,engineFormat:u}}(h,u,d,f);if(!u||!d||!p)throw c(),new Error("KTX2TextureTranscoder: Invalid texture");if(!n.startTranscoding())throw c(),new Error("KTX2TextureTranscoder: .startTranscoding failed");const b=[];for(let e=0;e<p;e++){const t=n.getImageLevelInfo(e,0,0),i=t.origWidth,s=t.origHeight,r=new Uint8Array(n.getImageTranscodedSizeInBytes(e,0,0,_));if(!n.transcodeImage(r,e,0,0,_,0,-1,-1))throw c(),new Error("KTX2TextureTranscoder: .transcodeImage failed.");b.push({data:r,width:i,height:s})}return c(),{width:u,height:d,hasAlpha:f,mipmaps:b,format:v,dfdTransferFn:m,dfdFlags:g}}(c.buffers[0]),m=[];for(let e=0;e<u.length;++e)m.push(u[e].data.buffer);self.postMessage({type:"transcode",id:c.id,width:t,height:n,hasAlpha:h,mipmaps:u,format:d,dfdTransferFn:p,dfdFlags:f},m)}catch(e){console.error(`[KTX2TextureTranscoder.BasisWorker]: ${e}`),self.postMessage({type:"error",id:c.id,error:e.message})}}))}var h}));const n=[{if:"astcSupported",basisFormat:[o.UASTC_4x4],transcoderFormat:[r.ASTC_4x4,r.ASTC_4x4],engineFormat:[s.RGBA_ASTC_4x4_Format,s.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.BC7_M5,r.BC7_M5],engineFormat:[s.RGBA_BPTC_Format,s.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.BC1,r.BC3],engineFormat:[s.RGB_S3TC_DXT1_Format,s.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.ETC1,r.ETC2],engineFormat:[s.RGB_ETC2_Format,s.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.ETC1],engineFormat:[s.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[o.ETC1S,o.UASTC_4x4],transcoderFormat:[r.PVRTC1_4_RGB,r.PVRTC1_4_RGBA],engineFormat:[s.RGB_PVRTC_4BPPV1_Format,s.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],a=n.sort((function(e,t){return e.priorityETC1S-t.priorityETC1S})),l=n.sort((function(e,t){return e.priorityUASTC-t.priorityUASTC}));function A(e){return e<=2||0==(e&e-1)&&0!==e}};const tc={};function ic(e){const t=e.scene.id;let i=tc[t];return i||(i=new ec({viewer:e}),tc[t]=i,e.scene.on("destroyed",(()=>{delete tc[t],i.destroy()}))),i}
/**
 * @author https://github.com/tmarti, with support from https://tribia.com/
 * @license MIT
 *
 * This file takes a geometry given by { positionsCompressed, indices }, and returns
 * equivalent { positionsCompressed, indices } arrays but which only contain unique
 * positionsCompressed.
 *
 * The time is O(N logN) with the number of positionsCompressed due to a pre-sorting
 * step, but is much more GC-friendly and actually faster than the classic O(N)
 * approach based in keeping a hash-based LUT to identify unique positionsCompressed.
 */let sc=null;function rc(e,t){let i;for(let s=0;s<3;s++)if(0!=(i=sc[3*e+s]-sc[3*t+s]))return i;return 0}let oc=null;function nc(e){const t=e.positionsCompressed,i=e.indices,s=e.edgeIndices;!function(e){if(!(null!==oc&&oc.length>=e)){oc=new Uint32Array(e);for(let t=0;t<e;t++)oc[t]=t}}(t.length/3);const r=oc.slice(0,t.length/3),o=oc.slice(0,t.length/3);sc=t,r.sort(rc);let n=0;o[r[0]]=0;for(let e=1,t=r.length;e<t;e++)0!==rc(r[e],r[e-1])&&n++,o[r[e]]=n;const a=new Uint16Array(3*(n+1));n=0,a[3*n+0]=t[3*r[0]+0],a[3*n+1]=t[3*r[0]+1],a[3*n+2]=t[3*r[0]+2];for(let e=1,i=r.length;e<i;e++)0!==rc(r[e],r[e-1])&&(n++,a[3*n+0]=t[3*r[e]+0],a[3*n+1]=t[3*r[e]+1],a[3*n+2]=t[3*r[e]+2]),o[r[e]]=n;sc=null;const l=new Uint32Array(i.length);for(let e=0,t=i.length;e<t;e++)l[e]=o[i[e]];const A=new Uint32Array(s.length);for(let e=0,t=s.length;e<t;e++)A[e]=o[s[e]];return[a,l,A]}
/**
 * @author https://github.com/tmarti, with support from https://tribia.com/
 * @license MIT
 **/let ac=null;function lc(e,t){const i=3*e,s=3*t;let r,o,n,a,l,A;const c=Math.min(r=ac[i],o=ac[i+1],n=ac[i+2]),h=Math.min(a=ac[s],l=ac[s+1],A=ac[s+2]);if(c!==h)return c-h;const u=Math.max(r,o,n),d=Math.max(a,l,A);return u!==d?u-d:0}let Ac=null;function cc(e,t){let i=Ac[2*e]-Ac[2*t];return 0!==i?i:Ac[2*e+1]-Ac[2*t+1]}function hc(e,t,i=!1){const s=e.positionsCompressed||[],r=function(e,t){const i=new Int32Array(e.length/3);for(let e=0,t=i.length;e<t;e++)i[e]=e;ac=new Int32Array(e.length);for(let i=0,s=e.length;i<s;i++)ac[i]=e[i]>>t;i.sort(lc);const s=new Int32Array(e.length);for(let t=0,r=i.length;t<r;t++)s[3*t+0]=e[3*i[t]+0],s[3*t+1]=e[3*i[t]+1],s[3*t+2]=e[3*i[t]+2];return s}(e.indices||[],t),o=function(e){if(0===(e||[]).length)return[];let t=new Int32Array(e.length/2);for(let e=0,i=t.length;e<i;e++)t[e]=e;for(let t=0,i=e.length;t<i;t+=2)if(e[t]>e[t+1]){let i=e[t];e[t]=e[t+1],e[t+1]=i}Ac=new Int32Array(e),t.sort(cc);const i=new Int32Array(e.length);for(let s=0,r=t.length;s<r;s++)i[2*s+0]=e[2*t[s]+0],i[2*s+1]=e[2*t[s]+1];return i}(e.edgeIndices||[]);function n(e,t){if(e>t){let i=e;e=t,t=i}function i(i,s){return i!==e?e-i:s!==t?t-s:0}let s=0,r=(o.length>>1)-1;for(;s<=r;){const e=r+s>>1,t=i(o[2*e],o[2*e+1]);if(t>0)s=e+1;else{if(!(t<0))return e;r=e-1}}return-s-1}const a=new Int32Array(o.length/2);a.fill(0);const l=s.length/3;if(l>8*(1<<t))return[e];const A=new Int32Array(l);A.fill(-1);const c=[];function h(){A.fill(-1);const e={positionsCompressed:[],indices:[],edgeIndices:[],maxNumPositions:(1<<t)-t,numPositions:0,bucketNumber:c.length};return c.push(e),e}let u=h();for(let t=0,i=r.length;t<i;t+=3){let i=0;const l=r[t],c=r[t+1],d=r[t+2];if(-1===A[l]&&i++,-1===A[c]&&i++,-1===A[d]&&i++,i+u.numPositions>u.maxNumPositions&&(u=h()),u.bucketNumber>8)return[e];let p;-1===A[l]&&(A[l]=u.numPositions++,u.positionsCompressed.push(s[3*l]),u.positionsCompressed.push(s[3*l+1]),u.positionsCompressed.push(s[3*l+2])),-1===A[c]&&(A[c]=u.numPositions++,u.positionsCompressed.push(s[3*c]),u.positionsCompressed.push(s[3*c+1]),u.positionsCompressed.push(s[3*c+2])),-1===A[d]&&(A[d]=u.numPositions++,u.positionsCompressed.push(s[3*d]),u.positionsCompressed.push(s[3*d+1]),u.positionsCompressed.push(s[3*d+2])),u.indices.push(A[l]),u.indices.push(A[c]),u.indices.push(A[d]),(p=n(l,c))>=0&&0===a[p]&&(a[p]=1,u.edgeIndices.push(A[o[2*p]]),u.edgeIndices.push(A[o[2*p+1]])),(p=n(l,d))>=0&&0===a[p]&&(a[p]=1,u.edgeIndices.push(A[o[2*p]]),u.edgeIndices.push(A[o[2*p+1]])),(p=n(c,d))>=0&&0===a[p]&&(a[p]=1,u.edgeIndices.push(A[o[2*p]]),u.edgeIndices.push(A[o[2*p+1]]))}const d=t/8*2,p=t/8,f=2*s.length+(r.length+o.length)*d;let m=0,g=-s.length/3;return c.forEach((e=>{m+=2*e.positionsCompressed.length+(e.indices.length+e.edgeIndices.length)*p,g+=e.positionsCompressed.length/3})),m>f?[e]:(i&&function(e,t){const i={},s={};let r=0;e.forEach((e=>{const t=e.indices,o=e.edgeIndices,n=e.positionsCompressed;for(let e=0,s=t.length;e<s;e+=3){const s=n[3*t[e]]+"_"+n[3*t[e]+1]+"_"+n[3*t[e]+2]+"/"+n[3*t[e+1]]+"_"+n[3*t[e+1]+1]+"_"+n[3*t[e+1]+2]+"/"+n[3*t[e+2]]+"_"+n[3*t[e+2]+1]+"_"+n[3*t[e+2]+2];i[s]=!0}r+=e.edgeIndices.length/2;for(let e=0,t=o.length;e<t;e+=2){const t=n[3*o[e]]+"_"+n[3*o[e]+1]+"_"+n[3*o[e]+2]+"/"+n[3*o[e+1]]+"_"+n[3*o[e+1]+1]+"_"+n[3*o[e+1]+2]+"/";s[t]=!0}}));{const e=t.indices;t.edgeIndices;const s=t.positionsCompressed;for(let t=0,r=e.length;t<r;t+=3){const r=s[3*e[t]]+"_"+s[3*e[t]+1]+"_"+s[3*e[t]+2]+"/"+s[3*e[t+1]]+"_"+s[3*e[t+1]+1]+"_"+s[3*e[t+1]+2]+"/"+s[3*e[t+2]]+"_"+s[3*e[t+2]+1]+"_"+s[3*e[t+2]+2];if(!(r in i))throw console.log("Not found "+r),"Ohhhh!"}}}(c,e),c)}const uc=new Float32Array([0,0,0]),dc=new Uint16Array([0,0,0]);d.OBB3();class pc{constructor(e,t,i,s,r,o){this._isObject=t,this.scene=e.scene,this.model=e,this.isSceneModelEntity=!0,this.meshes=s,this._numPrimitives=0,this._capMaterial=null;for(let e=0,t=this.meshes.length;e<t;e++){const t=this.meshes[e];t.parent=this,t.entity=this,this._numPrimitives+=t.numPrimitives}this.id=i,this.originalSystemId=d.unglobalizeObjectId(e.id,i),this._flags=r,this._aabb=d.AABB3(),this._aabbDirty=!0,this._offset=d.vec3(),this._colorizeUpdated=!1,this._opacityUpdated=!1,this._lodCullable=!!o,this._culled=!1,this._culledVFC=!1,this._culledLOD=!1,this._isObject&&e.scene._registerObject(this)}_transformDirty(){this._aabbDirty=!0,this.model._transformDirty()}_sceneModelDirty(){this._aabbDirty=!0;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._sceneModelDirty()}get aabb(){if(this._aabbDirty){d.collapseAABB3(this._aabb);for(let e=0,t=this.meshes.length;e<t;e++)d.expandAABB3(this._aabb,this.meshes[e].aabb);this._aabbDirty=!1}return this._aabb}get isEntity(){return!0}get isModel(){return!1}get isObject(){return this._isObject}get numPrimitives(){return this._numPrimitives}get numTriangles(){return this._numPrimitives}get visible(){return this._getFlag(fr)}set visible(e){if(!!(this._flags&fr)!==e){this._flags=e?this._flags|fr:this._flags&~fr;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}}get highlighted(){return this._getFlag(yr)}set highlighted(e){if(!!(this._flags&yr)!==e){this._flags=e?this._flags|yr:this._flags&~yr;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}}get xrayed(){return this._getFlag(br)}set xrayed(e){if(!!(this._flags&br)!==e){this._flags=e?this._flags|br:this._flags&~br;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}}get selected(){return this._getFlag(wr)}set selected(e){if(!!(this._flags&wr)!==e){this._flags=e?this._flags|wr:this._flags&~wr;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}}get edges(){return this._getFlag(Br)}set edges(e){if(!!(this._flags&Br)!==e){this._flags=e?this._flags|Br:this._flags&~Br;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setEdges(this._flags);this.model.glRedraw()}}get culledVFC(){return!!this._culledVFC}set culledVFC(e){this._culledVFC=e,this._setCulled()}get culledLOD(){return!!this._culledLOD}set culledLOD(e){this._culledLOD=e,this._setCulled()}get culled(){return!!this._culled}set culled(e){this._culled=e,this._setCulled()}_setCulled(){let e=!!this._culled||!(!this._culledLOD||!this._lodCullable)||!!this._culledVFC;if(!!(this._flags&mr)!==e){this._flags=e?this._flags|mr:this._flags&~mr;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCulled(this._flags);this.model.glRedraw()}}get clippable(){return this._getFlag(_r)}set clippable(e){if(!!(this._flags&_r)!==e){this._flags=e?this._flags|_r:this._flags&~_r;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setClippable(this._flags);this.model.glRedraw()}}get collidable(){return this._getFlag(vr)}set collidable(e){if(!!(this._flags&vr)!==e){this._flags=e?this._flags|vr:this._flags&~vr;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setCollidable(this._flags)}}get pickable(){return this._getFlag(gr)}set pickable(e){if(!!(this._flags&gr)!==e){this._flags=e?this._flags|gr:this._flags&~gr;for(var t=0,i=this.meshes.length;t<i;t++)this.meshes[t]._setPickable(this._flags)}}get colorize(){if(0===this.meshes.length)return null;const e=this.meshes[0]._colorize;return uc[0]=e[0]/255,uc[1]=e[1]/255,uc[2]=e[2]/255,uc}set colorize(e){if(e){dc[0]=Math.floor(255*e[0]),dc[1]=Math.floor(255*e[1]),dc[2]=Math.floor(255*e[2]);for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setColorize(dc)}else for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setColorize(null);if(this._isObject){const t=!!e;this.scene._objectColorizeUpdated(this,t),this._colorizeUpdated=t}this.model.glRedraw()}get opacity(){return this.meshes.length>0?this.meshes[0]._colorize[3]/255:1}set opacity(e){if(0===this.meshes.length)return;const t=null!=e,i=this.meshes[0]._colorize[3];let s=255;if(t){if(e<0?e=0:e>1&&(e=1),s=Math.floor(255*e),i===s)return}else if(s=255,i===s)return;for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setOpacity(s,this._flags);this._isObject&&(this.scene._objectOpacityUpdated(this,t),this._opacityUpdated=t),this.model.glRedraw()}get offset(){return this._offset}set offset(e){e?(this._offset[0]=e[0],this._offset[1]=e[1],this._offset[2]=e[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._setOffset(this._offset);this._aabbDirty=!0,this.model._aabbDirty=!0,this.scene._aabbDirty=!0,this.scene._objectOffsetUpdated(this,e),this.model.glRedraw()}get saoEnabled(){return this.model.saoEnabled}set capMaterial(e){this.scene.readableGeometryEnabled&&(this._capMaterial=e instanceof gs?e:null,this.scene._capMaterialUpdated(this.id,this.model.id))}get capMaterial(){return this._capMaterial}getEachVertex(e){for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t].getEachVertex(e)}getEachIndex(e){for(let t=0,i=this.meshes.length;t<i;t++)this.meshes[t].getEachIndex(e)}getGeometryData(){let e=0;const t=[],i=[];for(let s=0,r=this.meshes.length;s<r;s++){const r=this.meshes[s];if(r.layer.readGeometryData){const s=r.layer.readGeometryData(r.portionId);for(let t=0,r=s.indices.length;t<r;t++)i.push(s.indices[t]+e);for(let e=0,i=s.positions.length;e<i;e++)t.push(s.positions[e]);e+=s.positions.length/3}}return{indices:i,positions:t}}get volume(){let e=0;for(let t=0,i=this.meshes.length;t<i;t++){const i=this.meshes[t].volume;if(i<0)return-1;e+=i}return e}get surfaceArea(){let e=0;for(let t=0,i=this.meshes.length;t<i;t++){const i=this.meshes[t].surfaceArea;i>=0&&(e+=i)}return e>0?e:-1}_getFlag(e){return!!(this._flags&e)}_finalize(){const e=this.model.scene;this._isObject&&(this.visible&&e._objectVisibilityUpdated(this),this.highlighted&&e._objectHighlightedUpdated(this),this.xrayed&&e._objectXRayedUpdated(this),this.selected&&e._objectSelectedUpdated(this));for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._finalize(this._flags)}_finalize2(){for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._finalize2()}_destroy(){const e=this.model.scene;this._isObject&&(e._deregisterObject(this),this.visible&&e._deRegisterVisibleObject(this),this.xrayed&&e._deRegisterXRayedObject(this),this.selected&&e._deRegisterSelectedObject(this),this.highlighted&&e._deRegisterHighlightedObject(this),this._colorizeUpdated&&this.scene._deRegisterColorizedObject(this),this._opacityUpdated&&this.scene._deRegisterOpacityObject(this),!this._offset||0===this._offset[0]&&0===this._offset[1]&&0===this._offset[2]||this.scene._deRegisterOffsetObject(this));for(let e=0,t=this.meshes.length;e<t;e++)this.meshes[e]._destroy();e._aabbDirty=!0}}const fc=d.vec4(4),mc=d.vec4(),gc=d.vec4(),_c=d.vec3([1,0,0]),vc=d.vec3([0,1,0]),bc=d.vec3([0,0,1]);d.vec3(3),d.vec3(3);const yc=d.identityMat4();class wc{constructor(e){this._model=e.model,this.id=e.id,this._parentTransform=e.parent,this._childTransforms=[],this._meshes=[],this._scale=new Float32Array([1,1,1]),this._quaternion=d.identityQuaternion(new Float32Array(4)),this._rotation=new Float32Array(3),this._position=new Float32Array(3),this._localMatrix=d.identityMat4(new Float32Array(16)),this._worldMatrix=d.identityMat4(new Float32Array(16)),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,e.matrix?this.matrix=e.matrix:(this.scale=e.scale,this.position=e.position,e.quaternion||(this.rotation=e.rotation)),e.parent&&e.parent._addChildTransform(this)}_addChildTransform(e){this._childTransforms.push(e),e._parentTransform=this,e._transformDirty(),e._setSubtreeAABBsDirty(this)}_addMesh(e){this._meshes.push(e),e.transform=this}get parentTransform(){return this._parentTransform}get meshes(){return this._meshes}set position(e){this._position.set(e||[0,0,0]),this._setLocalMatrixDirty(),this._model.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),d.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._model.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),d.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._model.glRedraw()}get quaternion(){return this._quaternion}set scale(e){this._scale.set(e||[1,1,1]),this._setLocalMatrixDirty(),this._model.glRedraw()}get scale(){return this._scale}set matrix(e){this._localMatrix||(this._localMatrix=d.identityMat4()),this._localMatrix.set(e||yc),d.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._transformDirty(),this._model.glRedraw()}get matrix(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=d.identityMat4()),d.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}rotate(e,t){return fc[0]=e[0],fc[1]=e[1],fc[2]=e[2],fc[3]=t*d.DEGTORAD,d.angleAxisToQuaternion(fc,mc),d.mulQuaternions(this.quaternion,mc,gc),this.quaternion=gc,this._setLocalMatrixDirty(),this._model.glRedraw(),this}rotateOnWorldAxis(e,t){return fc[0]=e[0],fc[1]=e[1],fc[2]=e[2],fc[3]=t*d.DEGTORAD,d.angleAxisToQuaternion(fc,mc),d.mulQuaternions(mc,this.quaternion,mc),this}rotateX(e){return this.rotate(_c,e)}rotateY(e){return this.rotate(vc,e)}rotateZ(e){return this.rotate(bc,e)}translate(e){return this._position[0]+=e[0],this._position[1]+=e[1],this._position[2]+=e[2],this._setLocalMatrixDirty(),this._model.glRedraw(),this}translateX(e){return this._position[0]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}translateY(e){return this._position[1]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}translateZ(e){return this._position[2]+=e,this._setLocalMatrixDirty(),this._model.glRedraw(),this}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._transformDirty()}_transformDirty(){this._worldMatrixDirty=!0;for(let e=0,t=this._childTransforms.length;e<t;e++){const t=this._childTransforms[e];if(t._transformDirty(),t._meshes&&t._meshes.length>0){const e=t._meshes;for(let t=0,i=e.length;t<i;t++)e[t]._transformDirty()}}if(this._meshes&&this._meshes.length>0){const e=this._meshes;for(let t=0,i=e.length;t<i;t++)e[t]._transformDirty()}}_buildWorldMatrix(){const e=this.matrix;if(this._parentTransform)d.mulMat4(this._parentTransform.worldMatrix,e,this._worldMatrix);else for(let t=0,i=e.length;t<i;t++)this._worldMatrix[t]=e[t];this._worldMatrixDirty=!1}_setSubtreeAABBsDirty(e){if(e._aabbDirty=!0,e._childTransforms)for(let t=0,i=e._childTransforms.length;t<i;t++)this._setSubtreeAABBsDirty(e._childTransforms[t])}}const Bc=d.vec3(),Pc=d.OBB3(),xc=d.vec4(),Cc=d.vec3([1,1,1]),Mc=d.vec3([0,0,0]);d.vec3([0,0,0]);const Ec=d.identityQuaternion(),Fc=d.identityMat4(),Ic=new Uint8Array([255,255,255]);class Tc extends R{constructor(e,t={}){super(e,t),this.renderOrder=t.renderOrder||0,this._dtxEnabled=this.scene.dtxEnabled&&!1!==t.dtxEnabled,this._enableVertexWelding=!1,this._enableIndexBucketing=!1,this._vboBatchingLayerScratchMemory=(pr++,dr),this._textureTranscoder=t.textureTranscoder||ic(this.scene.viewer),this._maxGeometryBatchSize=t.maxGeometryBatchSize,this._aabb=d.collapseAABB3(),this._aabbDirty=!0,this._quantizationRanges={},this._vboInstancingLayers={},this._vboBatchingLayers={},this._dtxLayers={},this._meshList=[],this.layerList=[],this._layersToFinalize=[],this._entityList=[],this._entitiesToFinalize=[],this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={},this._transforms={},this._meshes={},this._unusedMeshes={},this._entities={},this.renderFlags=new rs,this.numGeometries=0,this.numPortions=0,this.numVisibleLayerPortions=0,this.numTransparentLayerPortions=0,this.numXRayedLayerPortions=0,this.numHighlightedLayerPortions=0,this.numSelectedLayerPortions=0,this.numEdgesLayerPortions=0,this.numPickableLayerPortions=0,this.numClippableLayerPortions=0,this.numCulledLayerPortions=0,this.numEntities=0,this._numTriangles=0,this._numLines=0,this._numPoints=0,this._layersFinalized=!1,this._edgeThreshold=t.edgeThreshold||10,this._origin=d.vec3(t.origin||[0,0,0]),this._position=d.vec3(t.position||[0,0,0]),this._rotation=d.vec3(t.rotation||[0,0,0]),this._quaternion=d.vec4(t.quaternion||[0,0,0,1]),this._conjugateQuaternion=d.vec4(t.quaternion||[0,0,0,1]),t.rotation&&d.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._scale=d.vec3(t.scale||[1,1,1]),this._worldRotationMatrix=d.mat4(),this._worldRotationMatrixConjugate=d.mat4(),this._matrix=d.mat4(),this._matrixDirty=!0,this._rebuildMatrices(),this._worldNormalMatrix=d.mat4(),d.inverseMat4(this._matrix,this._worldNormalMatrix),d.transposeMat4(this._worldNormalMatrix),(t.matrix||t.position||t.rotation||t.scale||t.quaternion)&&(this._viewMatrix=d.mat4(),this._viewNormalMatrix=d.mat4(),this._viewMatrixDirty=!0,this._matrixNonIdentity=!0),this._opacity=1,this._colorize=[1,1,1],this._saoEnabled=!1!==t.saoEnabled,this._pbrEnabled=!1!==t.pbrEnabled,this._colorTextureEnabled=!1!==t.colorTextureEnabled,this._isModel=t.isModel,this._isModel&&this.scene._registerModel(this),this._onCameraViewMatrix=this.scene.camera.on("matrix",(()=>{this._viewMatrixDirty=!0})),this._meshesWithDirtyMatrices=[],this._numMeshesWithDirtyMatrices=0,this._onTick=this.scene.on("tick",(()=>{for(;this._numMeshesWithDirtyMatrices>0;)this._meshesWithDirtyMatrices[--this._numMeshesWithDirtyMatrices]._updateMatrix()})),this._createDefaultTextureSet(),this.visible=t.visible,this.culled=t.culled,this.pickable=t.pickable,this.clippable=t.clippable,this.collidable=t.collidable,this.castsShadow=t.castsShadow,this.receivesShadow=t.receivesShadow,this.xrayed=t.xrayed,this.highlighted=t.highlighted,this.selected=t.selected,this.edges=t.edges,this.colorize=t.colorize,this.opacity=t.opacity,this.backfaces=t.backfaces}_meshMatrixDirty(e){this._meshesWithDirtyMatrices[this._numMeshesWithDirtyMatrices++]=e}_createDefaultTextureSet(){const e=new zA({id:"defaultColorTexture",texture:new Ps({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})}),t=new zA({id:"defaultMetalRoughTexture",texture:new Ps({gl:this.scene.canvas.gl,preloadColor:[0,1,1,1]})}),i=new zA({id:"defaultNormalsTexture",texture:new Ps({gl:this.scene.canvas.gl,preloadColor:[0,0,0,0]})}),s=new zA({id:"defaultEmissiveTexture",texture:new Ps({gl:this.scene.canvas.gl,preloadColor:[0,0,0,1]})}),r=new zA({id:"defaultOcclusionTexture",texture:new Ps({gl:this.scene.canvas.gl,preloadColor:[1,1,1,1]})});this._textures.defaultColorTexture=e,this._textures.defaultMetalRoughTexture=t,this._textures.defaultNormalsTexture=i,this._textures.defaultEmissiveTexture=s,this._textures.defaultOcclusionTexture=r,this._textureSets.defaultTextureSet=new GA({id:"defaultTextureSet",model:this,colorTexture:e,metallicRoughnessTexture:t,normalsTexture:i,emissiveTexture:s,occlusionTexture:r})}get isPerformanceModel(){return!0}get transforms(){return this._transforms}get textures(){return this._textures}get textureSets(){return this._textureSets}get meshes(){return this._meshes}get objects(){return this._entities}get origin(){return this._origin}set position(e){this._position.set(e||[0,0,0]),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get position(){return this._position}set rotation(e){this._rotation.set(e||[0,0,0]),d.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(e){this._quaternion.set(e||[0,0,0,1]),d.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(e){}get scale(){return this._scale}set matrix(e){this._matrix.set(e||Fc),d.decomposeMat4(this._matrix,this._position,this._quaternion,this._scale),d.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._matrixDirty=!1,this._setWorldMatrixDirty(),this._sceneModelDirty(),this.glRedraw()}get matrix(){return this._rebuildMatrices(),this._matrix}get rotationMatrix(){return this._rebuildMatrices(),this._worldRotationMatrix}_rebuildMatrices(){this._matrixDirty&&(d.quaternionToRotationMat4(this._quaternion,this._worldRotationMatrix),d.conjugateQuaternion(this._quaternion,this._conjugateQuaternion),d.quaternionToRotationMat4(this._conjugateQuaternion,this._worldRotationMatrixConjugate),d.scaleMat4v(this._scale,this._worldRotationMatrix),d.scaleMat4v(this._scale,this._worldRotationMatrixConjugate),this._matrix.set(this._worldRotationMatrix),d.translateMat4v(this._position,this._matrix),this._matrixDirty=!1,this._viewMatrixDirty=!0)}get rotationMatrixConjugate(){return this._rebuildMatrices(),this._worldRotationMatrixConjugate}_setWorldMatrixDirty(){this._matrixDirty=!0,this._aabbDirty=!0}_transformDirty(){this._matrixDirty=!0,this._aabbDirty=!0,this.scene._aabbDirty=!0}_sceneModelDirty(){this.scene._aabbDirty=!0,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._matrixDirty=!0;for(let e=0,t=this._entityList.length;e<t;e++)this._entityList[e]._sceneModelDirty()}get worldMatrix(){return this.matrix}get worldNormalMatrix(){return this._worldNormalMatrix}_rebuildViewMatrices(){this._rebuildMatrices(),this._viewMatrixDirty&&(d.mulMat4(this.scene.camera.viewMatrix,this._matrix,this._viewMatrix),d.inverseMat4(this._viewMatrix,this._viewNormalMatrix),d.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1)}get viewMatrix(){return this._viewMatrix?(this._rebuildViewMatrices(),this._viewMatrix):this.scene.camera.viewMatrix}get viewNormalMatrix(){return this._viewNormalMatrix?(this._rebuildViewMatrices(),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}get backfaces(){return this._backfaces}set backfaces(e){e=!!e,this._backfaces=e,this.glRedraw()}get entityList(){return this._entityList}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return!1}get aabb(){if(this._aabbDirty){d.collapseAABB3(this._aabb);for(let e=0,t=this._entityList.length;e<t;e++)d.expandAABB3(this._aabb,this._entityList[e].aabb);this._aabbDirty=!1}return this._aabb}get numTriangles(){return this._numTriangles}get numLines(){return this._numLines}get numPoints(){return this._numPoints}get visible(){return this.numVisibleLayerPortions>0}set visible(e){e=!1!==e,this._visible=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].visible=e;this.glRedraw()}get xrayed(){return this.numXRayedLayerPortions>0}set xrayed(e){e=!!e,this._xrayed=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].xrayed=e;this.glRedraw()}get highlighted(){return this.numHighlightedLayerPortions>0}set highlighted(e){e=!!e,this._highlighted=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].highlighted=e;this.glRedraw()}get selected(){return this.numSelectedLayerPortions>0}set selected(e){e=!!e,this._selected=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].selected=e;this.glRedraw()}get edges(){return this.numEdgesLayerPortions>0}set edges(e){e=!!e,this._edges=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].edges=e;this.glRedraw()}get culled(){return this._culled}set culled(e){e=!!e,this._culled=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].culled=e;this.glRedraw()}get clippable(){return this._clippable}set clippable(e){e=!1!==e,this._clippable=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].clippable=e;this.glRedraw()}get collidable(){return this._collidable}set collidable(e){e=!1!==e,this._collidable=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].collidable=e}get pickable(){return this.numPickableLayerPortions>0}set pickable(e){e=!1!==e,this._pickable=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].pickable=e}get colorize(){return this._colorize}set colorize(e){this._colorize=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].colorize=e}get opacity(){return this._opacity}set opacity(e){this._opacity=e;for(let t=0,i=this._entityList.length;t<i;t++)this._entityList[t].opacity=e}get castsShadow(){return this._castsShadow}set castsShadow(e){(e=!1!==e)!==this._castsShadow&&(this._castsShadow=e,this.glRedraw())}get receivesShadow(){return this._receivesShadow}set receivesShadow(e){(e=!1!==e)!==this._receivesShadow&&(this._receivesShadow=e,this.glRedraw())}get saoEnabled(){return this._saoEnabled}get pbrEnabled(){return this._pbrEnabled}get colorTextureEnabled(){return this._colorTextureEnabled}get isDrawable(){return!0}get isStateSortable(){return!1}get xrayMaterial(){return this.scene.xrayMaterial}get highlightMaterial(){return this.scene.highlightMaterial}get selectedMaterial(){return this.scene.selectedMaterial}get edgeMaterial(){return this.scene.edgeMaterial}getPickViewMatrix(e){return this._viewMatrix?this._viewMatrix:e}createQuantizationRange(e){void 0!==e.id&&null!==e.id?e.aabb?this.error("[createQuantizationRange] Config missing: aabb"):this._quantizationRanges[e.id]?this.error("[createQuantizationRange] QuantizationRange already created: "+e.id):this._quantizationRanges[e.id]={id:e.id,aabb:e.aabb,matrix:_o(e.aabb,d.mat4())}:this.error("[createQuantizationRange] Config missing: id")}createGeometry(e){if(void 0!==e.id&&null!==e.id)if(this._geometries[e.id])this.error("[createGeometry] Geometry already created: "+e.id);else if(void 0!==e.primitive&&null!==e.primitive||(e.primitive="triangles"),"points"===e.primitive||"lines"===e.primitive||"triangles"===e.primitive||"solid"===e.primitive||"surface"===e.primitive){if(!e.positions&&!e.positionsCompressed&&!e.buckets)return this.error("[createGeometry] Param expected: `positions`,  `positionsCompressed' or 'buckets"),null;if(e.positionsCompressed&&!e.positionsDecodeMatrix&&!e.positionsDecodeBoundary)return this.error("[createGeometry] Param expected: `positionsDecodeMatrix` or 'positionsDecodeBoundary' (required for `positionsCompressed')"),null;if(e.positionsDecodeMatrix&&e.positionsDecodeBoundary)return this.error("[createGeometry] Only one of these params expected: `positionsDecodeMatrix` or 'positionsDecodeBoundary' (required for `positionsCompressed')"),null;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("[createGeometry] Param expected: `uvDecodeMatrix` (required for `uvCompressed')"),null;if(!(e.buckets||e.indices||"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive)){const t=(e.positions||e.positionsCompressed).length/3;e.indices=this._createDefaultIndices(t)}if(!e.buckets&&!e.indices&&"points"!==e.primitive)return this.error(`[createGeometry] Param expected: indices (required for '${e.primitive}' primitive type)`),null;if(e.positionsDecodeBoundary&&(e.positionsDecodeMatrix=_o(e.positionsDecodeBoundary,d.mat4())),e.positions){const t=d.collapseAABB3();e.positionsDecodeMatrix=d.mat4(),d.expandAABB3Points3(t,e.positions),e.positionsCompressed=go(e.positions,t,e.positionsDecodeMatrix),e.aabb=t}else if(e.positionsCompressed){const t=d.collapseAABB3();e.positionsDecodeMatrix=new Float64Array(e.positionsDecodeMatrix),e.positionsCompressed=new Uint16Array(e.positionsCompressed),d.expandAABB3Points3(t,e.positionsCompressed),me.decompressAABB(t,e.positionsDecodeMatrix),e.aabb=t}else if(e.buckets){const t=d.collapseAABB3();this._dtxBuckets[e.id]=e.buckets;for(let i=0,s=e.buckets.length;i<s;i++){const s=e.buckets[i];s.positions?d.expandAABB3Points3(t,s.positions):s.positionsCompressed&&d.expandAABB3Points3(t,s.positionsCompressed)}e.positionsDecodeMatrix&&me.decompressAABB(t,e.positionsDecodeMatrix),e.aabb=t}if(e.colorsCompressed&&e.colorsCompressed.length>0)e.colorsCompressed=new Uint8Array(e.colorsCompressed);else if(e.colors&&e.colors.length>0){const t=e.colors,i=new Uint8Array(t.length);for(let e=0,s=t.length;e<s;e++)i[e]=255*t[e];e.colorsCompressed=i}if(e.buckets||e.edgeIndices||"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive||(e.positions?e.edgeIndices=Ae(e.positions,e.indices,null,5):e.edgeIndices=Ae(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.uv){const t=me.getUVBounds(e.uv),i=me.compressUVs(e.uv,t.min,t.max);e.uvCompressed=i.quantized,e.uvDecodeMatrix=i.decodeMatrix}else e.uvCompressed&&(e.uvCompressed=new Uint16Array(e.uvCompressed),e.uvDecodeMatrix=new Float64Array(e.uvDecodeMatrix));e.normals&&(e.normals=null),this._geometries[e.id]=e,this._numTriangles+=e.indices?Math.round(e.indices.length/3):0,this.numGeometries++}else this.error(`[createGeometry] Unsupported value for 'primitive': '${e.primitive}' - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'. Defaulting to 'triangles'.`);else this.error("[createGeometry] Config missing: id")}createTexture(e){const t=e.id;if(null==t)return void this.error("[createTexture] Config missing: id");if(this._textures[t])return void this.error("[createTexture] Texture already created: "+t);if(!e.src&&!e.image&&!e.buffers)return this.error("[createTexture] Param expected: `src`, `image' or 'buffers'"),null;let i=e.minFilter||1008;1006!==i&&1007!==i&&1008!==i&&1005!==i&&1004!==i&&(this.error("[createTexture] Unsupported value for 'minFilter' - \n            supported values are LinearFilter, LinearMipMapNearestFilter, NearestMipMapNearestFilter, \n            NearestMipMapLinearFilter and LinearMipmapLinearFilter. Defaulting to LinearMipmapLinearFilter."),i=1008);let s=e.magFilter||1006;1006!==s&&1003!==s&&(this.error("[createTexture] Unsupported value for 'magFilter' - supported values are LinearFilter and NearestFilter. Defaulting to LinearFilter."),s=1006);let r=e.wrapS||1e3;1001!==r&&1002!==r&&1e3!==r&&(this.error("[createTexture] Unsupported value for 'wrapS' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),r=1e3);let o=e.wrapT||1e3;1001!==o&&1002!==o&&1e3!==o&&(this.error("[createTexture] Unsupported value for 'wrapT' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),o=1e3);let n=e.wrapR||1e3;1001!==n&&1002!==n&&1e3!==n&&(this.error("[createTexture] Unsupported value for 'wrapR' - supported values are ClampToEdgeWrapping, MirroredRepeatWrapping and RepeatWrapping. Defaulting to RepeatWrapping."),n=1e3);let a=e.encoding||3e3;3e3!==a&&3001!==a&&(this.error("[createTexture] Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),a=3e3);const l=new Ps({gl:this.scene.canvas.gl,minFilter:i,magFilter:s,wrapS:r,wrapT:o,wrapR:n,encoding:a});if(e.preloadColor&&l.setPreloadColor(e.preloadColor),e.image){const t=e.image;if(t.crossOrigin="Anonymous",t.compressed){const e=t.data;l.setCompressedData({mipmaps:e,props:{format:e[0].format,minFilter:i,magFilter:s}})}else l.setImage(t,{minFilter:i,magFilter:s,wrapS:r,wrapT:o,wrapR:n,flipY:e.flipY,encoding:a})}else if(e.src){const t=e.src.split(".").pop();switch(t){case"jpeg":case"jpg":case"png":case"gif":const A=new Image;A.onload=()=>{l.setImage(A,{minFilter:i,magFilter:s,wrapS:r,wrapT:o,wrapR:n,flipY:e.flipY,encoding:a}),this.glRedraw()},A.src=e.src;break;default:this._textureTranscoder?y.loadArraybuffer(e.src,(e=>{e.byteLength?this._textureTranscoder.transcode([e],l).then((()=>{this.glRedraw()})):this.error("[createTexture] Can't create texture from 'src': file data is zero length")}),(function(e){this.error(`[createTexture] Can't create texture from 'src': ${e}`)})):this.error(`[createTexture] Can't create texture from 'src' - SceneModel needs to be configured with a TextureTranscoder for this file type ('${t}')`)}}else e.buffers&&(this._textureTranscoder?this._textureTranscoder.transcode(e.buffers,l).then((()=>{this.glRedraw()})):this.error("[createTexture] Can't create texture from 'buffers' - SceneModel needs to be configured with a TextureTranscoder for this option"));this._textures[t]=new zA({id:t,texture:l})}createTextureSet(e){const t=e.id;if(null==t)return void this.error("[createTextureSet] Config missing: id");if(this._textureSets[t])return void this.error(`[createTextureSet] Texture set already created: ${t}`);let i,s,r,o,n;if(void 0!==e.colorTextureId&&null!==e.colorTextureId){if(i=this._textures[e.colorTextureId],!i)return void this.error(`[createTextureSet] Texture not found: ${e.colorTextureId} - ensure that you create it first with createTexture()`)}else i=this._textures.defaultColorTexture;if(void 0!==e.metallicRoughnessTextureId&&null!==e.metallicRoughnessTextureId){if(s=this._textures[e.metallicRoughnessTextureId],!s)return void this.error(`[createTextureSet] Texture not found: ${e.metallicRoughnessTextureId} - ensure that you create it first with createTexture()`)}else s=this._textures.defaultMetalRoughTexture;if(void 0!==e.normalsTextureId&&null!==e.normalsTextureId){if(r=this._textures[e.normalsTextureId],!r)return void this.error(`[createTextureSet] Texture not found: ${e.normalsTextureId} - ensure that you create it first with createTexture()`)}else r=this._textures.defaultNormalsTexture;if(void 0!==e.emissiveTextureId&&null!==e.emissiveTextureId){if(o=this._textures[e.emissiveTextureId],!o)return void this.error(`[createTextureSet] Texture not found: ${e.emissiveTextureId} - ensure that you create it first with createTexture()`)}else o=this._textures.defaultEmissiveTexture;if(void 0!==e.occlusionTextureId&&null!==e.occlusionTextureId){if(n=this._textures[e.occlusionTextureId],!n)return void this.error(`[createTextureSet] Texture not found: ${e.occlusionTextureId} - ensure that you create it first with createTexture()`)}else n=this._textures.defaultOcclusionTexture;const a=new GA({id:t,model:this,colorTexture:i,alphaCutoff:e.alphaCutoff,metallicRoughnessTexture:s,normalsTexture:r,emissiveTexture:o,occlusionTexture:n});return this._textureSets[t]=a,a}createTransform(e){if(void 0===e.id||null===e.id)return void this.error("[createTransform] SceneModel.createTransform() config missing: id");if(this._transforms[e.id])return void this.error(`[createTransform] SceneModel already has a transform with this ID: ${e.id}`);let t;if(e.parentTransformId&&(t=this._transforms[e.parentTransformId],!t))return void this.error("[createTransform] SceneModel.createTransform() config missing: id");const i=new wc({id:e.id,model:this,parent:t,matrix:e.matrix,position:e.position,scale:e.scale,rotation:e.rotation,quaternion:e.quaternion});return this._transforms[i.id]=i,i}createMesh(e){if(void 0===e.id||null===e.id)return this.error("[createMesh] SceneModel.createMesh() config missing: id"),!1;if(this._meshes[e.id])return this.error(`[createMesh] SceneModel already has a mesh with this ID: ${e.id}`),!1;if(!(void 0!==e.geometryId)){if(void 0!==e.primitive&&null!==e.primitive||(e.primitive="triangles"),"points"!==e.primitive&&"lines"!==e.primitive&&"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive)return this.error(`Unsupported value for 'primitive': '${primitive}'  ('geometryId' is absent) - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'.`),!1;if(!e.positions&&!e.positionsCompressed&&!e.buckets)return this.error("Param expected: 'positions',  'positionsCompressed' or `buckets`  ('geometryId' is absent)"),!1;if(e.positions&&(e.positionsDecodeMatrix||e.positionsDecodeBoundary))return this.error("Illegal params: 'positions' not expected with 'positionsDecodeMatrix'/'positionsDecodeBoundary' ('geometryId' is absent)"),!1;if(e.positionsCompressed&&!e.positionsDecodeMatrix&&!e.positionsDecodeBoundary)return this.error("Param expected: 'positionsCompressed' should be accompanied by 'positionsDecodeMatrix'/'positionsDecodeBoundary' ('geometryId' is absent)"),!1;if(e.uvCompressed&&!e.uvDecodeMatrix)return this.error("Param expected: 'uvCompressed' should be accompanied by `uvDecodeMatrix` ('geometryId' is absent)"),!1;if(!(e.buckets||e.indices||"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive)){const t=(e.positions||e.positionsCompressed).length/3;e.indices=this._createDefaultIndices(t)}if(!e.buckets&&!e.indices&&"points"!==e.primitive)return e.indices=this._createDefaultIndices(numIndices),this.error(`Param expected: indices (required for '${e.primitive}' primitive type)`),!1;if((e.matrix||e.position||e.rotation||e.scale)&&(e.positionsCompressed||e.positionsDecodeBoundary))return this.error("Unexpected params: 'matrix', 'rotation', 'scale', 'position' not allowed with 'positionsCompressed'"),!1;const t=!(!this._dtxEnabled||"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive||e.textureSetId);if(e.origin=e.origin?d.addVec3(this._origin,e.origin,d.vec3()):this._origin,e.matrix)e.meshMatrix=e.matrix;else if(e.scale||e.rotation||e.position||e.quaternion){const t=e.scale||Cc,i=e.position||Mc;e.rotation?(d.eulerToQuaternion(e.rotation,"XYZ",xc),e.meshMatrix=d.composeMat4(i,xc,t,d.mat4())):e.meshMatrix=d.composeMat4(i,e.quaternion||Ec,t,d.mat4())}if(e.positionsDecodeBoundary&&(e.positionsDecodeMatrix=_o(e.positionsDecodeBoundary,d.mat4())),t){if(e.type=2,e.color=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):Ic,e.opacity=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255,e.positions){const t=d.vec3(),i=[];$e(e.positions,i,t)&&(e.positions=i,e.origin=d.addVec3(e.origin,t,t))}if(e.positions){const t=d.collapseAABB3();e.positionsDecodeMatrix=d.mat4(),d.expandAABB3Points3(t,e.positions),e.positionsCompressed=go(e.positions,t,e.positionsDecodeMatrix),e.aabb=t}else if(e.positionsCompressed){const t=d.collapseAABB3();d.expandAABB3Points3(t,e.positionsCompressed),me.decompressAABB(t,e.positionsDecodeMatrix),e.aabb=t}if(e.buckets){const t=d.collapseAABB3();for(let i=0,s=e.buckets.length;i<s;i++){const s=e.buckets[i];s.positions?d.expandAABB3Points3(t,s.positions):s.positionsCompressed&&d.expandAABB3Points3(t,s.positionsCompressed)}e.positionsDecodeMatrix&&me.decompressAABB(t,e.positionsDecodeMatrix),e.aabb=t}e.meshMatrix&&(d.AABB3ToOBB3(e.aabb,Pc),d.transformOBB3(e.meshMatrix,Pc),d.OBB3ToAABB3(Pc,e.aabb)),e.buckets||e.edgeIndices||"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive||(e.positions?e.edgeIndices=Ae(e.positions,e.indices,null,2):e.edgeIndices=Ae(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.buckets||(e.buckets=Dc(e,this._enableVertexWelding&&this._enableIndexBucketing))}else{if(e.type=1,e.color=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):[255,255,255],e.opacity=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255,e.metallic=void 0!==e.metallic&&null!==e.metallic?Math.floor(255*e.metallic):0,e.roughness=void 0!==e.roughness&&null!==e.roughness?Math.floor(255*e.roughness):255,e.positions){const t=[];$e(e.positions,t,Bc)&&(e.positions=t,e.origin=d.addVec3(e.origin,Bc,d.vec3()))}if(e.positions){const t=d.collapseAABB3();e.meshMatrix&&(d.transformPositions3(e.meshMatrix,e.positions,e.positions),e.meshMatrix=null),d.expandAABB3Points3(t,e.positions),e.aabb=t}else{const t=d.collapseAABB3();d.expandAABB3Points3(t,e.positionsCompressed),me.decompressAABB(t,e.positionsDecodeMatrix),e.aabb=t}if(e.meshMatrix&&(d.AABB3ToOBB3(e.aabb,Pc),d.transformOBB3(e.meshMatrix,Pc),d.OBB3ToAABB3(Pc,e.aabb)),e.buckets||e.edgeIndices||"triangles"!==e.primitive&&"solid"!==e.primitive&&"surface"!==e.primitive||(e.positions?e.edgeIndices=Ae(e.positions,e.indices,null,2):e.edgeIndices=Ae(e.positionsCompressed,e.indices,e.positionsDecodeMatrix,2)),e.textureSetId&&(e.textureSet=this._textureSets[e.textureSetId],!e.textureSet))return this.error(`[createMesh] Texture set not found: ${e.textureSetId} - ensure that you create it first with createTextureSet()`),!1}}else{if(e.positions||e.positionsCompressed||e.indices||e.edgeIndices||e.normals||e.normalsCompressed||e.uv||e.uvCompressed||e.positionsDecodeMatrix)return this.error("Mesh geometry parameters not expected when instancing a geometry (not expected: positions, positionsCompressed, indices, edgeIndices, normals, normalsCompressed, uv, uvCompressed, positionsDecodeMatrix)"),!1;if(e.geometry=this._geometries[e.geometryId],!e.geometry)return this.error(`[createMesh] Geometry not found: ${e.geometryId} - ensure that you create it first with createGeometry()`),!1;if(e.origin=e.origin?d.addVec3(this._origin,e.origin,d.vec3()):this._origin,e.positionsDecodeMatrix=e.geometry.positionsDecodeMatrix,e.transformId){if(e.transform=this._transforms[e.transformId],!e.transform)return this.error(`[createMesh] Transform not found: ${e.transformId} - ensure that you create it first with createTransform()`),!1;e.aabb=e.geometry.aabb}else{if(e.matrix)e.meshMatrix=e.matrix;else if(e.scale||e.rotation||e.position||e.quaternion){const t=e.scale||Cc,i=e.position||Mc;e.rotation?(d.eulerToQuaternion(e.rotation,"XYZ",xc),e.meshMatrix=d.composeMat4(i,xc,t,d.mat4())):e.meshMatrix=d.composeMat4(i,e.quaternion||Ec,t,d.mat4())}d.AABB3ToOBB3(e.geometry.aabb,Pc),d.transformOBB3(e.meshMatrix,Pc),e.aabb=d.OBB3ToAABB3(Pc,d.AABB3())}if(!(!this._dtxEnabled||"triangles"!==e.geometry.primitive&&"solid"!==e.geometry.primitive&&"surface"!==e.geometry.primitive||e.textureSetId)){e.type=2,e.color=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):Ic,e.opacity=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255;let t=this._dtxBuckets[e.geometryId];t||(t=Dc(e.geometry,this._enableVertexWelding,this._enableIndexBucketing),this._dtxBuckets[e.geometryId]=t),e.buckets=t}else e.type=0,e.color=e.color?new Uint8Array([Math.floor(255*e.color[0]),Math.floor(255*e.color[1]),Math.floor(255*e.color[2])]):Ic,e.opacity=void 0!==e.opacity&&null!==e.opacity?Math.floor(255*e.opacity):255,e.metallic=void 0!==e.metallic&&null!==e.metallic?Math.floor(255*e.metallic):0,e.roughness=void 0!==e.roughness&&null!==e.roughness?Math.floor(255*e.roughness):255,e.textureSetId&&(e.textureSet=this._textureSets[e.textureSetId])}return e.numPrimitives=this._getNumPrimitives(e),this._createMesh(e)}_createDefaultIndices(e){const t=[];for(let i=0;i<e;i++)t.push(i);return t}_createMesh(e){const t=new ur(this,e.id,e.color,e.opacity,e.transform,e.textureSet);t.pickId=this.scene._renderer.getPickID(t);const i=t.pickId,s=i>>24&255,r=i>>16&255,o=i>>8&255,n=255&i;switch(e.pickColor=new Uint8Array([n,o,r,s]),e.solid="solid"===e.primitive,t.origin=d.vec3(e.origin),e.type){case 2:t.layer=this._getDTXLayer(e),t.aabb=e.aabb;break;case 1:t.layer=this._getVBOBatchingLayer(e),t.aabb=e.aabb;break;case 0:t.layer=this._getVBOInstancingLayer(e),t.aabb=e.aabb}return e.transform&&(e.meshMatrix=e.transform.worldMatrix),t.portionId=t.layer.createPortion(t,e),t.numPrimitives=e.numPrimitives,this._meshes[e.id]=t,this._unusedMeshes[e.id]=t,this._meshList.push(t),t}_getNumPrimitives(e){let t=0;switch(e.geometry?e.geometry.primitive:e.primitive){case"triangles":case"solid":case"surface":switch(e.type){case 2:for(let i=0,s=e.buckets.length;i<s;i++)t+=e.buckets[i].indices.length;break;case 1:t+=e.indices.length;break;case 0:t+=e.geometry.indices.length}return Math.round(t/3);case"points":switch(e.type){case 2:for(let i=0,s=e.buckets.length;i<s;i++)t+=e.buckets[i].positionsCompressed.length;break;case 1:t+=e.positions?e.positions.length:e.positionsCompressed.length;break;case 0:const i=e.geometry;t+=i.positions?i.positions.length:i.positionsCompressed.length}return Math.round(t);case"lines":case"line-strip":switch(e.type){case 2:for(let i=0,s=e.buckets.length;i<s;i++)t+=e.buckets[i].indices.length;break;case 1:t+=e.indices.length;break;case 0:t+=e.geometry.indices.length}return Math.round(t/2)}return 0}_getDTXLayer(e){const t=e.origin,i=e.geometry?e.geometry.primitive:e.primitive,s=`.${i}.${Math.round(t[0])}.${Math.round(t[1])}.${Math.round(t[2])}`;let r=this._dtxLayers[s];if(r){if(r.canCreatePortion(e))return r;delete this._dtxLayers[s],r=null}switch(i){case"triangles":case"solid":case"surface":r=new jA(this,{layerIndex:0,origin:t,primitive:i});break;case"lines":r=new vl(this,{layerIndex:0,origin:t,primitive:i});break;default:return}return this._dtxLayers[s]=r,this.layerList.push(r),this._layersToFinalize.push(r),r}_getVBOBatchingLayer(e){const t=this,i=e.origin;e.renderLayer;const s=e.positionsDecodeMatrix||e.positionsDecodeBoundary?this._createHashStringFromMatrix(e.positionsDecodeMatrix||e.positionsDecodeBoundary):"-",r=e.textureSetId||"-",o=`${Math.round(i[0])}.${Math.round(i[1])}.${Math.round(i[2])}.${e.primitive}.${s}.${r}`;let n=this._vboBatchingLayers[o];if(n)return n;let a=e.textureSet;for(;!n;){switch(e.primitive){case"triangles":case"solid":case"surface":n=new To({model:t,textureSet:a,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:"solid"===e.primitive,autoNormals:!0,primitive:e.primitive});break;case"lines":n=new Hn({model:t,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,primitive:e.primitive});break;case"points":n=new Fa({model:t,layerIndex:0,scratchMemory:this._vboBatchingLayerScratchMemory,positionsDecodeMatrix:e.positionsDecodeMatrix,uvDecodeMatrix:e.uvDecodeMatrix,origin:i,maxGeometryBatchSize:this._maxGeometryBatchSize,primitive:e.primitive})}const s=e.positionsCompressed?e.positionsCompressed.length:e.positions.length;("points"===e.primitive?n.canCreatePortion(s):n.canCreatePortion(s,e.indices.length))||(n.finalize(),delete this._vboBatchingLayers[o],n=null)}return this._vboBatchingLayers[o]=n,this.layerList.push(n),this._layersToFinalize.push(n),n}_createHashStringFromMatrix(e){const t=e.join("");let i=0;for(let e=0;e<t.length;e++){i=(i<<5)-i+t.charCodeAt(e),i|=0}return(i>>>0).toString(16)}_getVBOInstancingLayer(e){const t=this,i=e.origin,s=e.textureSetId||"-",r=e.geometryId,o=`${Math.round(i[0])}.${Math.round(i[1])}.${Math.round(i[2])}.${s}.${r}`;let n=this._vboInstancingLayers[o];if(n)return n;let a=e.textureSet;const l=e.geometry;for(;!n;)switch(l.primitive){case"triangles":case"surface":n=new Bn({model:t,textureSet:a,geometry:l,origin:i,layerIndex:0,solid:!1});break;case"solid":n=new Bn({model:t,textureSet:a,geometry:l,origin:i,layerIndex:0,solid:!0});break;case"lines":n=new la({model:t,textureSet:a,geometry:l,origin:i,layerIndex:0});break;case"points":n=new el({model:t,textureSet:a,geometry:l,origin:i,layerIndex:0})}return this._vboInstancingLayers[o]=n,this.layerList.push(n),this._layersToFinalize.push(n),n}createEntity(e){if(void 0===e.id?e.id=d.createUUID():this.scene.components[e.id]&&(this.error(`Scene already has a Component with this ID: ${e.id} - will assign random ID`),e.id=d.createUUID()),void 0===e.meshIds)return void this.error("Config missing: meshIds");let t=0;return this._visible&&!1!==e.visible&&(t|=fr),this._pickable&&!1!==e.pickable&&(t|=gr),this._culled&&!1!==e.culled&&(t|=mr),this._clippable&&!1!==e.clippable&&(t|=_r),this._collidable&&!1!==e.collidable&&(t|=vr),this._edges&&!1!==e.edges&&(t|=Br),this._xrayed&&!1!==e.xrayed&&(t|=br),this._highlighted&&!1!==e.highlighted&&(t|=yr),this._selected&&!1!==e.selected&&(t|=wr),e.flags=t,this._createEntity(e)}_createEntity(e){let t=[];for(let i=0,s=e.meshIds.length;i<s;i++){const s=e.meshIds[i];let r=this._meshes[s];r?r.parent?this.error(`Mesh with ID "${s}" already belongs to object with ID "${r.parent.id}" - ignoring this mesh`):(t.push(r),delete this._unusedMeshes[s]):this.error(`Mesh with this ID not found: "${s}" - ignoring this mesh`)}const i=new pc(this,e.isObject,e.id,t,e.flags,!0);return this._entityList.push(i),this._entities[e.id]=i,this._entitiesToFinalize.push(i),this.numEntities++,i}preFinalize(){if(this.destroyed)return!1;if(0===this._layersToFinalize.length)return!1;this._createDummyEntityForUnusedMeshes();for(let e=0,t=this._layersToFinalize.length;e<t;e++){this._layersToFinalize[e].finalize()}this._vboBatchingLayers={},this._vboInstancingLayers={},this._dtxLayers={},this._layersToFinalize=[];for(let e=0,t=this._entitiesToFinalize.length;e<t;e++){this._entitiesToFinalize[e]._finalize()}for(let e=0,t=this._entitiesToFinalize.length;e<t;e++){this._entitiesToFinalize[e]._finalize2()}this._entitiesToFinalize=[],this.scene._aabbDirty=!0,this._viewMatrixDirty=!0,this._matrixDirty=!0,this._aabbDirty=!0,this._setWorldMatrixDirty(),this._sceneModelDirty(),this.position=this._position,this.layerList.sort(((e,t)=>e.sortId<t.sortId?-1:e.sortId>t.sortId?1:0));for(let e=0,t=this.layerList.length;e<t;e++){this.layerList[e].layerIndex=e}this.glRedraw(),this._layersFinalized=!0}finalize(){this.destroyed||(this.preFinalize(),this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={})}stateSortCompare(e,t){}rebuildRenderFlags(){this.renderFlags.reset(),this._updateRenderFlagsVisibleLayers(),this.renderFlags.numLayers>0&&0===this.renderFlags.numVisibleLayers?this.renderFlags.culled=!0:this._updateRenderFlags()}_updateRenderFlagsVisibleLayers(){const e=this.renderFlags;e.numLayers=this.layerList.length,e.numVisibleLayers=0;for(let t=0,i=this.layerList.length;t<i;t++){const i=this.layerList[t];this._getActiveSectionPlanesForLayer(i)&&(e.visibleLayers[e.numVisibleLayers++]=t)}}_createDummyEntityForUnusedMeshes(){const e=Object.keys(this._unusedMeshes);if(e.length>0){const t=`${this.id}-${d.createUUID()}`;this.warn(`Creating dummy SceneModelEntity "${t}" for unused SceneMeshes: [${e.join(",")}]`),this.createEntity({id:t,meshIds:e,isObject:!0})}this._unusedMeshes={}}_getActiveSectionPlanesForLayer(e){const t=this.renderFlags,i=this.scene._sectionPlanesState.sectionPlanes,s=i.length,r=e.layerIndex*s;if(s>0)for(let e=0;e<s;e++){i[e].active?(t.sectionPlanesActivePerLayer[r+e]=!0,t.sectioned=!0):t.sectionPlanesActivePerLayer[r+e]=!1}return!0}_updateRenderFlags(){if(0===this.numVisibleLayerPortions)return;if(this.numCulledLayerPortions===this.numPortions)return;const e=this.renderFlags;if(e.colorOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.colorTransparent=!0),this.numXRayedLayerPortions>0){const t=this.scene.xrayMaterial._state;t.fill&&(t.fillAlpha<1?e.xrayedSilhouetteTransparent=!0:e.xrayedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.xrayedEdgesTransparent=!0:e.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0){this.scene.edgeMaterial._state.edges&&(e.edgesOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(e.edgesTransparent=!0))}if(this.numSelectedLayerPortions>0){const t=this.scene.selectedMaterial._state;t.fill&&(t.fillAlpha<1?e.selectedSilhouetteTransparent=!0:e.selectedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.selectedEdgesTransparent=!0:e.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){const t=this.scene.highlightMaterial._state;t.fill&&(t.fillAlpha<1?e.highlightedSilhouetteTransparent=!0:e.highlightedSilhouetteOpaque=!0),t.edges&&(t.edgeAlpha<1?e.highlightedEdgesTransparent=!0:e.highlightedEdgesOpaque=!0)}}drawColorOpaque(e,t){const i=this.renderFlags;for(let t=0,s=i.visibleLayers.length;t<s;t++){const s=i.visibleLayers[t];this.layerList[s].drawColorOpaque(i,e)}}drawColorTransparent(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawColorTransparent(t,e)}}drawDepth(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawDepth(t,e)}}drawNormals(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawNormals(t,e)}}drawSilhouetteXRayed(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawSilhouetteXRayed(t,e)}}drawSilhouetteHighlighted(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawSilhouetteHighlighted(t,e)}}drawSilhouetteSelected(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawSilhouetteSelected(t,e)}}drawEdgesColorOpaque(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawEdgesColorOpaque(t,e)}}drawEdgesColorTransparent(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawEdgesColorTransparent(t,e)}}drawEdgesXRayed(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawEdgesXRayed(t,e)}}drawEdgesHighlighted(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawEdgesHighlighted(t,e)}}drawEdgesSelected(e){const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawEdgesSelected(t,e)}}drawOcclusion(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawOcclusion(t,e)}}drawShadow(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawShadow(t,e)}}setPickMatrices(e,t){if(0===this._numVisibleLayerPortions)return;const i=this.renderFlags;for(let s=0,r=i.visibleLayers.length;s<r;s++){const r=i.visibleLayers[s],o=this.layerList[r];o.setPickMatrices&&o.setPickMatrices(e,t)}}drawPickMesh(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawPickMesh(t,e)}}drawPickDepths(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawPickDepths(t,e)}}drawPickNormals(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i];this.layerList[s].drawPickNormals(t,e)}}drawSnapInit(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i],r=this.layerList[s];r.drawSnapInit&&(e.snapPickOrigin=[0,0,0],e.snapPickCoordinateScale=[1,1,1],e.snapPickLayerNumber++,r.drawSnapInit(t,e),e.snapPickLayerParams[e.snapPickLayerNumber]={origin:e.snapPickOrigin.slice(),coordinateScale:e.snapPickCoordinateScale.slice()})}}drawSnap(e){if(0===this.numVisibleLayerPortions)return;const t=this.renderFlags;for(let i=0,s=t.visibleLayers.length;i<s;i++){const s=t.visibleLayers[i],r=this.layerList[s];r.drawSnap&&(e.snapPickOrigin=[0,0,0],e.snapPickCoordinateScale=[1,1,1],e.snapPickLayerNumber++,r.drawSnap(t,e),e.snapPickLayerParams[e.snapPickLayerNumber]={origin:e.snapPickOrigin.slice(),coordinateScale:e.snapPickCoordinateScale.slice()})}}destroy(){for(let e in this._vboBatchingLayers)this._vboBatchingLayers.hasOwnProperty(e)&&this._vboBatchingLayers[e].destroy();this._vboBatchingLayers={};for(let e in this._vboInstancingLayers)this._vboInstancingLayers.hasOwnProperty(e)&&this._vboInstancingLayers[e].destroy();this._vboInstancingLayers={},this.scene.camera.off(this._onCameraViewMatrix),this.scene.off(this._onTick);for(let e=0,t=this.layerList.length;e<t;e++)this.layerList[e].destroy();this.layerList=[];for(let e=0,t=this._entityList.length;e<t;e++)this._entityList[e]._destroy();this._layersToFinalize={},this._geometries={},this._dtxBuckets={},this._textures={},this._textureSets={},this._meshes={},this._entities={},this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this),0!==pr&&(pr--,0===pr&&dr._clear()),super.destroy()}}function Dc(e,t,i){let s,r,o,n;if(t||i?[s,r,o]=nc({positionsCompressed:e.positionsCompressed,indices:e.indices,edgeIndices:e.edgeIndices}):(s=e.positionsCompressed,r=e.indices,o=e.edgeIndices),i){n=hc({positionsCompressed:s,indices:r,edgeIndices:o},s.length/3>65536?16:8)}else n=[{positionsCompressed:s,indices:r,edgeIndices:o}];return n}class Sc extends R{constructor(e,t={}){if(super(e,t),this._positions=t.positions||[],t.indices)this._indices=t.indices;else{this._indices=[];for(let e=0,t=this._positions.length/3-1;e<t;e+=2)this._indices.push(e),this._indices.push(e+1)}this._color=t.color||[1,1,1],this._opacity=t.opacity||1,this._sceneModel=new Tc(this,{isModel:!1}),this._sceneModel.createMesh({id:"linesMesh",primitive:"lines",positions:this._positions,indices:this._indices,color:this._color,opacity:this._opacity}),this._sceneModel.createEntity({meshIds:["linesMesh"],visible:t.visible,clippable:t.clippable,collidable:t.collidable}),this._sceneModel.finalize(),this.scene._lineSetCreated(this)}set visible(e){this._sceneModel.visible=e}get visible(){return this._sceneModel.visible}get positions(){return this._positions}get indices(){return this._indices}destroy(){super.destroy(),this.scene._lineSetDestroyed(this)}}class Rc extends R{get type(){return"Light"}get isLight(){return!0}constructor(e,t={}){super(e,t)}}class Uc extends Rc{get type(){return"AmbientLight"}constructor(e,t={}){super(e,t),this._state={type:"ambient",color:d.vec3([.7,.7,.7]),intensity:1},this.color=t.color,this.intensity=t.intensity,this.scene._lightCreated(this)}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){this._state.intensity=void 0!==e?e:1,this.glRedraw()}get intensity(){return this._state.intensity}destroy(){super.destroy(),this.scene._lightDestroyed(this)}}class Lc{constructor(e,t,i){i=i||{},this.gl=t,this.allocated=!1,this.canvas=e,this.buffer=null,this.bound=!1,this.size=i.size,this._hasDepthTexture=!!i.depthTexture}setSize(e){this.size=e}webglContextRestored(e){this.gl=e,this.buffer=null,this.allocated=!1,this.bound=!1}bind(...e){if(this._touch(...e),this.bound)return;const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}createTexture(e,t,i=null){const s=this.gl,r=s.createTexture();return s.bindTexture(s.TEXTURE_2D,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),i?s.texStorage2D(s.TEXTURE_2D,1,i,e,t):s.texImage2D(s.TEXTURE_2D,0,s.RGBA,e,t,0,s.RGBA,s.UNSIGNED_BYTE,null),r}_touch(...e){let t,i;const s=this.gl;if(this.size?(t=this.size[0],i=this.size[1]):(t=s.drawingBufferWidth,i=s.drawingBufferHeight),this.buffer){if(this.buffer.width===t&&this.buffer.height===i)return;this.buffer.textures.forEach((e=>s.deleteTexture(e))),s.deleteFramebuffer(this.buffer.framebuf),s.deleteRenderbuffer(this.buffer.renderbuf)}const r=[];let o;e.length>0?r.push(...e.map((e=>this.createTexture(t,i,e)))):r.push(this.createTexture(t,i)),this._hasDepthTexture&&(o=s.createTexture(),s.bindTexture(s.TEXTURE_2D,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_COMPONENT32F,t,i,0,s.DEPTH_COMPONENT,s.FLOAT,null));const n=s.createRenderbuffer();s.bindRenderbuffer(s.RENDERBUFFER,n),s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_COMPONENT32F,t,i);const a=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,a);for(let e=0;e<r.length;e++)s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0+e,s.TEXTURE_2D,r[e],0);if(e.length>0&&s.drawBuffers(r.map(((e,t)=>s.COLOR_ATTACHMENT0+t))),this._hasDepthTexture?s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.TEXTURE_2D,o,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_ATTACHMENT,s.RENDERBUFFER,n),s.bindTexture(s.TEXTURE_2D,null),s.bindRenderbuffer(s.RENDERBUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,null),s.bindFramebuffer(s.FRAMEBUFFER,a),!s.isFramebuffer(a))throw"Invalid framebuffer";s.bindFramebuffer(s.FRAMEBUFFER,null);const l=s.checkFramebufferStatus(s.FRAMEBUFFER);switch(l){case s.FRAMEBUFFER_COMPLETE:break;case s.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case s.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case s.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case s.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+l}this.buffer={framebuf:a,renderbuf:n,texture:r[0],textures:r,depthTexture:o,width:t,height:i},this.bound=!1}clear(){if(!this.bound)throw"Render buffer not bound";const e=this.gl;e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT)}read(e,t,i=null,s=null,r=Uint8Array,o=4,n=0){const a=e,l=this.buffer.height?this.buffer.height-t-1:this.gl.drawingBufferHeight-t,A=new r(o),c=this.gl;return c.readBuffer(c.COLOR_ATTACHMENT0+n),c.readPixels(a,l,1,1,i||c.RGBA,s||c.UNSIGNED_BYTE,A,0),A}readArray(e=null,t=null,i=Uint8Array,s=4,r=0){const o=new i(this.buffer.width*this.buffer.height*s),n=this.gl;return n.readBuffer(n.COLOR_ATTACHMENT0+r),n.readPixels(0,0,this.buffer.width,this.buffer.height,e||n.RGBA,t||n.UNSIGNED_BYTE,o,0),o}readImageAsCanvas(){const e=this.gl,t=this._getImageDataCache(),i=t.pixelData,s=t.canvas,r=t.imageData,o=t.context;e.readPixels(0,0,this.buffer.width,this.buffer.height,e.RGBA,e.UNSIGNED_BYTE,i);const n=this.buffer.width,a=this.buffer.height,l=a/2|0,A=4*n,c=new Uint8Array(4*n);for(let e=0;e<l;++e){const t=e*A,s=(a-e-1)*A;c.set(i.subarray(t,t+A)),i.copyWithin(t,s,s+A),i.set(c,s)}return r.data.set(i),o.putImageData(r,0,0),s}readImage(e){const t=this.gl,i=this._getImageDataCache(),s=i.pixelData,r=i.canvas,o=i.imageData,n=i.context,{width:a,height:l}=this.buffer;t.readPixels(0,0,a,l,t.RGBA,t.UNSIGNED_BYTE,s),o.data.set(s),n.putImageData(o,0,0),n.save(),n.globalCompositeOperation="copy",n.scale(1,-1),n.drawImage(r,0,-l,a,l),n.restore();let A=e.format||"png";return"jpeg"!==A&&"png"!==A&&"bmp"!==A&&(console.error("Unsupported image format: '"+A+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'png'"),A="png"),r.toDataURL(`image/${A}`)}_getImageDataCache(e=Uint8Array,t=4){const i=this.buffer.width,s=this.buffer.height;let r=this._imageDataCache;if(r&&(r.width===i&&r.height===s||(this._imageDataCache=null,r=null)),!r){const o=document.createElement("canvas"),n=o.getContext("2d");o.width=i,o.height=s,r={pixelData:new e(i*s*t),canvas:o,context:n,imageData:n.createImageData(i,s),width:i,height:s},this._imageDataCache=r}return r.context.resetTransform(),r}unbind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null),this.bound=!1}getTexture(e=0){const t=this;return this._texture||(this._texture={renderBuffer:this,bind:function(i){return!(!t.buffer||!t.buffer.textures[e])&&(t.gl.activeTexture(t.gl["TEXTURE"+i]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.textures[e]),!0)},unbind:function(i){t.buffer&&t.buffer.textures[e]&&(t.gl.activeTexture(t.gl["TEXTURE"+i]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}})}hasDepthTexture(){return this._hasDepthTexture}getDepthTexture(){if(!this._hasDepthTexture)return null;const e=this;return this._depthTexture||(this._dethTexture={renderBuffer:this,bind:function(t){return!(!e.buffer||!e.buffer.depthTexture)&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,e.buffer.depthTexture),!0)},unbind:function(t){e.buffer&&e.buffer.depthTexture&&(e.gl.activeTexture(e.gl["TEXTURE"+t]),e.gl.bindTexture(e.gl.TEXTURE_2D,null))}})}destroy(){if(this.allocated){const e=this.gl;this.buffer.textures.forEach((t=>e.deleteTexture(t))),e.deleteTexture(this.buffer.depthTexture),e.deleteFramebuffer(this.buffer.framebuf),e.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}this._imageDataCache=null,this._texture=null,this._depthTexture=null}}class kc extends Rc{get type(){return"DirLight"}constructor(e,t={}){super(e,t),this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;const i=this.scene.camera,s=this.scene.canvas;this._onCameraViewMatrix=i.on("viewMatrix",(()=>{this._shadowViewMatrixDirty=!0})),this._onCameraProjMatrix=i.on("projMatrix",(()=>{this._shadowProjMatrixDirty=!0})),this._onCanvasBoundary=s.on("boundary",(()=>{this._shadowProjMatrixDirty=!0})),this._state=new ae({type:"dir",dir:d.vec3([1,1,1]),color:d.vec3([.7,.7,.8]),intensity:1,space:t.space||"view",castsShadow:!1,getShadowViewMatrix:()=>{if(this._shadowViewMatrixDirty){this._shadowViewMatrix||(this._shadowViewMatrix=d.identityMat4());const e=this.scene.camera,t=this._state.dir,i=e.look,s=[i[0]-t[0],i[1]-t[1],i[2]-t[2]],r=[0,1,0];d.lookAtMat4v(s,i,r,this._shadowViewMatrix),this._shadowViewMatrixDirty=!1}return this._shadowViewMatrix},getShadowProjMatrix:()=>(this._shadowProjMatrixDirty&&(this._shadowProjMatrix||(this._shadowProjMatrix=d.identityMat4()),d.orthoMat4c(-40,40,-40,40,-40,80,this._shadowProjMatrix),this._shadowProjMatrixDirty=!1),this._shadowProjMatrix),getShadowRenderBuf:()=>(this._shadowRenderBuf||(this._shadowRenderBuf=new Lc(this.scene.canvas.canvas,this.scene.canvas.gl,{size:[1024,1024]})),this._shadowRenderBuf)}),this.dir=t.dir,this.color=t.color,this.intensity=t.intensity,this.castsShadow=t.castsShadow,this.scene._lightCreated(this)}set dir(e){this._state.dir.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get dir(){return this._state.dir}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){e=void 0!==e?e:1,this._state.intensity=e,this.glRedraw()}get intensity(){return this._state.intensity}set castsShadow(e){e=!!e,this._state.castsShadow!==e&&(this._state.castsShadow=e,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){const e=this.scene.camera,t=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),t.off(this._onCanvasBoundary),super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}class Oc extends Rc{get type(){return"PointLight"}constructor(e,t={}){super(e,t);const i=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;const s=this.scene.camera,r=this.scene.canvas;this._onCameraViewMatrix=s.on("viewMatrix",(()=>{this._shadowViewMatrixDirty=!0})),this._onCameraProjMatrix=s.on("projMatrix",(()=>{this._shadowProjMatrixDirty=!0})),this._onCanvasBoundary=r.on("boundary",(()=>{this._shadowProjMatrixDirty=!0})),this._state=new ae({type:"point",pos:d.vec3([1,1,1]),color:d.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:t.space||"view",castsShadow:!1,getShadowViewMatrix:()=>{if(i._shadowViewMatrixDirty){i._shadowViewMatrix||(i._shadowViewMatrix=d.identityMat4());const e=i._state.pos,t=s.look,r=s.up;d.lookAtMat4v(e,t,r,i._shadowViewMatrix),i._shadowViewMatrixDirty=!1}return i._shadowViewMatrix},getShadowProjMatrix:()=>{if(i._shadowProjMatrixDirty){i._shadowProjMatrix||(i._shadowProjMatrix=d.identityMat4());const e=i.scene.canvas.canvas;d.perspectiveMat4(Math.PI/180*70,e.clientWidth/e.clientHeight,.1,500,i._shadowProjMatrix),i._shadowProjMatrixDirty=!1}return i._shadowProjMatrix},getShadowRenderBuf:()=>(i._shadowRenderBuf||(i._shadowRenderBuf=new Lc(i.scene.canvas.canvas,i.scene.canvas.gl,{size:[1024,1024]})),i._shadowRenderBuf)}),this.pos=t.pos,this.color=t.color,this.intensity=t.intensity,this.constantAttenuation=t.constantAttenuation,this.linearAttenuation=t.linearAttenuation,this.quadraticAttenuation=t.quadraticAttenuation,this.castsShadow=t.castsShadow,this.scene._lightCreated(this)}set pos(e){this._state.pos.set(e||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get pos(){return this._state.pos}set color(e){this._state.color.set(e||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(e){e=void 0!==e?e:1,this._state.intensity=e,this.glRedraw()}get intensity(){return this._state.intensity}set constantAttenuation(e){this._state.attenuation[0]=e||0,this.glRedraw()}get constantAttenuation(){return this._state.attenuation[0]}set linearAttenuation(e){this._state.attenuation[1]=e||0,this.glRedraw()}get linearAttenuation(){return this._state.attenuation[1]}set quadraticAttenuation(e){this._state.attenuation[2]=e||0,this.glRedraw()}get quadraticAttenuation(){return this._state.attenuation[2]}set castsShadow(e){e=!!e,this._state.castsShadow!==e&&(this._state.castsShadow=e,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){const e=this.scene.camera,t=this.scene.canvas;e.off(this._onCameraViewMatrix),e.off(this._onCameraProjMatrix),t.off(this._onCanvasBoundary),super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}function Nc(e){if(!Vc(e.width)||!Vc(e.height)){const t=document.createElement("canvas");t.width=Qc(e.width),t.height=Qc(e.height);t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),e=t}return e}function Vc(e){return 0==(e&e-1)}function Qc(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1}class Hc extends R{get type(){return"CubeTexture"}constructor(e,t={}){super(e,t);const i=this.scene.canvas.gl;this._state=new ae({texture:new Ps({gl:i,target:i.TEXTURE_CUBE_MAP}),flipY:this._checkFlipY(t.minFilter),encoding:this._checkEncoding(t.encoding),minFilter:1008,magFilter:1006,wrapS:1001,wrapT:1001,mipmaps:!0}),this._src=t.src,this._images=[],this._loadSrc(t.src),g.memory.textures++}_checkFlipY(e){return!!e}_checkEncoding(e){return 3e3!==(e=e||3e3)&&3001!==e&&(this.error("Unsupported value for 'encoding' - supported values are LinearEncoding and sRGBEncoding. Defaulting to LinearEncoding."),e=3e3),e}_webglContextRestored(){this.scene.canvas.gl,this._state.texture=null,this._src&&this._loadSrc(this._src)}_loadSrc(e){const t=this,i=this.scene.canvas.gl;this._images=[];let s=!1,r=0;for(let o=0;o<e.length;o++){const n=new Image;n.onload=function(){let e=n;const a=o;return function(){if(!s&&(e=Nc(e),t._images[a]=e,r++,6===r)){let e=t._state.texture;e||(e=new Ps({gl:i,target:i.TEXTURE_CUBE_MAP}),t._state.texture=e),e.setImage(t._images,t._state),t.fire("loaded",t._src,!1),t.glRedraw()}}}(),n.onerror=function(){s=!0},n.src=e[o]}}destroy(){super.destroy(),this._state.texture&&this._state.texture.destroy(),g.memory.textures--,this._state.destroy()}}class jc extends Hc{get type(){return"ReflectionMap"}constructor(e,t={}){super(e,t),this.scene._lightsState.addReflectionMap(this._state),this.scene._reflectionMapCreated(this)}destroy(){super.destroy(),this.scene._reflectionMapDestroyed(this)}}class Gc extends Hc{get type(){return"LightMap"}constructor(e,t={}){super(e,t),this.scene._lightMapCreated(this)}destroy(){super.destroy(),this.scene._lightMapDestroyed(this)}}const zc=d.vec4(),Wc=d.vec4();class Xc extends R{constructor(e,t){super(e,t),this._entity=null,this._visible=null,this._worldPos=d.vec3(),this._origin=d.vec3(),this._rtcPos=d.vec3(),this._viewPos=d.vec3(),this._canvasPos=d.vec2(),this._occludable=!1,this._onCameraViewMatrix=this.scene.camera.on("matrix",(()=>{this._viewPosDirty=!0,this._needUpdate()})),this._onCameraProjMatrix=this.scene.camera.on("projMatrix",(()=>{this._canvasPosDirty=!0,this._needUpdate()})),this._onEntityDestroyed=null,this._onEntityModelDestroyed=null,this._renderer.addMarker(this),this.entity=t.entity,this.worldPos=t.worldPos,this.occludable=t.occludable}_update(){if(this._viewPosDirty&&(d.transformPoint3(this.scene.camera.viewMatrix,this._worldPos,this._viewPos),this._viewPosDirty=!1,this._canvasPosDirty=!0,this.fire("viewPos",this._viewPos)),this._canvasPosDirty){zc.set(this._viewPos),zc[3]=1,d.transformPoint4(this.scene.camera.projMatrix,zc,Wc);const e=this.scene.canvas.boundary;this._canvasPos[0]=Math.floor((1+Wc[0]/Wc[3])*e[2]/2),this._canvasPos[1]=Math.floor((1-Wc[1]/Wc[3])*e[3]/2),this._canvasPosDirty=!1,this.fire("canvasPos",this._canvasPos)}}_setVisible(e){this._visible,this._visible=e,this.fire("visible",this._visible)}set entity(e){this._entity!==e&&(this._cleanupDestroyedHandlers(),this._entity=e,this._entity&&(this._entity.isSceneModelEntity?this._onEntityModelDestroyed=this._entity.model.on("destroyed",(()=>{this._entity=null,this._onEntityModelDestroyed=null})):this._onEntityDestroyed=this._entity.on("destroyed",(()=>{this._entity=null,this._onEntityDestroyed=null}))),this.fire("entity",this._entity,!0))}get entity(){return this._entity}set occludable(e){(e=!!e)!==this._occludable&&(this._occludable=e,this._occludable&&this._renderer.markerWorldPosUpdated(this))}get occludable(){return this._occludable}set worldPos(e){this._worldPos.set(e||[0,0,0]),qe(this._worldPos,this._origin,this._rtcPos),this._occludable&&this._renderer.markerWorldPosUpdated(this),this._viewPosDirty=!0,this.fire("worldPos",this._worldPos),this._needUpdate()}get worldPos(){return this._worldPos}get origin(){return this._origin}get rtcPos(){return this._rtcPos}get viewPos(){return this._update(),this._viewPos}get canvasPos(){return this._update(),this._canvasPos}get visible(){return!!this._visible}destroy(){this.fire("destroyed",!0),this.scene.camera.off(this._onCameraViewMatrix),this.scene.camera.off(this._onCameraProjMatrix),this._cleanupDestroyedHandlers(),this._renderer.removeMarker(this),super.destroy()}_cleanupDestroyedHandlers(){this._entity&&(null!==this._onEntityDestroyed&&(this._entity.model?this._entity.model.off(this._onEntityDestroyed):this._entity.off(this._onEntityDestroyed),this._onEntityDestroyed=null),null!==this._onEntityModelDestroyed&&(this._entity.model&&this._entity.model.off(this._onEntityModelDestroyed),this._onEntityModelDestroyed=null))}}class Kc extends Xc{constructor(e,t={}){super(e,{entity:t.entity,occludable:t.occludable,worldPos:t.worldPos}),this._occluded=!1,this._visible=!0,this._src=null,this._image=null,this._pos=d.vec3(),this._origin=d.vec3(),this._rtcPos=d.vec3(),this._dir=d.vec3(),this._size=1,this._imageSize=d.vec2(),this._texture=new Is(this,{src:t.src}),this._geometry=new ve(this,{primitive:"triangles",positions:[3,3,0,-3,3,0,-3,-3,0,3,-3,0],normals:[-1,0,0,-1,0,0,-1,0,0,-1,0,0],uv:[1,-1,0,-1,0,0,1,0],indices:[0,1,2,0,2,3]}),this._mesh=new fs(this,{geometry:this._geometry,material:new bs(this,{ambient:[.9,.3,.9],shininess:30,diffuseMap:this._texture,backfaces:!0}),scale:[1,1,1],position:t.worldPos,rotation:[90,0,0],billboard:"spherical",occluder:!1}),this.visible=!0,this.collidable=t.collidable,this.clippable=t.clippable,this.pickable=t.pickable,this.opacity=t.opacity,this.size=t.size,t.image?this.image=t.image:this.src=t.src}_setVisible(e){this._occluded=!e,this._mesh.visible=this._visible&&!this._occluded,super._setVisible(e)}set visible(e){this._visible=null==e||e,this._mesh.visible=this._visible&&!this._occluded}get visible(){return this._visible}set image(e){this._image=e,this._image&&(this._imageSize[0]=this._image.width,this._imageSize[1]=this._image.height,this._updatePlaneSizeFromImage(),this._src=null,this._texture.image=this._image)}get image(){return this._image}set src(e){if(this._src=e,this._src){this._image=null;const e=new Image;e.onload=()=>{this._texture.image=e,this._imageSize[0]=e.width,this._imageSize[1]=e.height,this._updatePlaneSizeFromImage()},e.src=this._src}}get src(){return this._src}set size(e){this._size=null==e?1:e,this._image&&this._updatePlaneSizeFromImage()}get size(){return this._size}set collidable(e){this._mesh.collidable=!1!==e}get collidable(){return this._mesh.collidable}set clippable(e){this._mesh.clippable=!1!==e}get clippable(){return this._mesh.clippable}set pickable(e){this._mesh.pickable=!1!==e}get pickable(){return this._mesh.pickable}set opacity(e){this._mesh.opacity=e}get opacity(){return this._mesh.opacity}_updatePlaneSizeFromImage(){const e=.5*this._size,t=this._imageSize[0],i=this._imageSize[1],s=i/t;this._geometry.positions=t>i?[e,e*s,0,-e,e*s,0,-e,-e*s,0,e,-e*s,0]:[e/s,e,0,-e/s,e,0,-e/s,-e,0,e/s,-e,0]}}class Zc{constructor(e){this._eye=d.vec3(),this._look=d.vec3(),this._up=d.vec3(),this._projection={},e&&this.saveCamera(e)}saveCamera(e){const t=e.camera,i=t.project;switch(this._eye.set(t.eye),this._look.set(t.look),this._up.set(t.up),t.projection){case"perspective":this._projection={projection:"perspective",fov:i.fov,fovAxis:i.fovAxis,near:i.near,far:i.far};break;case"ortho":this._projection={projection:"ortho",scale:i.scale,near:i.near,far:i.far};break;case"frustum":this._projection={projection:"frustum",left:i.left,right:i.right,top:i.top,bottom:i.bottom,near:i.near,far:i.far};break;case"custom":this._projection={projection:"custom",matrix:i.matrix.slice()}}}restoreCamera(e,t){const i=e.camera,s=this._projection;function r(){switch(s.type){case"perspective":i.perspective.fov=s.fov,i.perspective.fovAxis=s.fovAxis,i.perspective.near=s.near,i.perspective.far=s.far;break;case"ortho":i.ortho.scale=s.scale,i.ortho.near=s.near,i.ortho.far=s.far;break;case"frustum":i.frustum.left=s.left,i.frustum.right=s.right,i.frustum.top=s.top,i.frustum.bottom=s.bottom,i.frustum.near=s.near,i.frustum.far=s.far;break;case"custom":i.customProjection.matrix=s.matrix}}t?e.viewer.cameraFlight.flyTo({eye:this._eye,look:this._look,up:this._up,orthoScale:s.scale,projection:s.projection},(()=>{r(),t()})):(i.eye=this._eye,i.look=this._look,i.up=this._up,r(),i.projection=s.projection)}}const Jc=d.vec3();class Yc{constructor(e){if(this.objectsVisible=[],this.objectsEdges=[],this.objectsXrayed=[],this.objectsHighlighted=[],this.objectsSelected=[],this.objectsClippable=[],this.objectsPickable=[],this.objectsColorize=[],this.objectsOpacity=[],this.numObjects=0,e){const t=e.metaScene.scene;this.saveObjects(t,e)}}saveObjects(e,t,i){this.numObjects=0,this._mask=i?y.apply(i,{}):null;const s=!i||i.visible,r=!i||i.edges,o=!i||i.xrayed,n=!i||i.highlighted,a=!i||i.selected,l=!i||i.clippable,A=!i||i.pickable,c=!i||i.colorize,h=!i||i.opacity,u=t.metaObjects,d=e.objects;for(let e=0,t=u.length;e<t;e++){const t=d[u[e].id];if(t){if(s&&(this.objectsVisible[e]=t.visible),r&&(this.objectsEdges[e]=t.edges),o&&(this.objectsXrayed[e]=t.xrayed),n&&(this.objectsHighlighted[e]=t.highlighted),a&&(this.objectsSelected[e]=t.selected),l&&(this.objectsClippable[e]=t.clippable),A&&(this.objectsPickable[e]=t.pickable),c){const i=t.colorize;this.objectsColorize[3*e+0]=i[0],this.objectsColorize[3*e+1]=i[1],this.objectsColorize[3*e+2]=i[2]}h&&(this.objectsOpacity[e]=t.opacity),this.numObjects++}}}restoreObjects(e,t){const i=this._mask,s=!i||i.visible,r=!i||i.edges,o=!i||i.xrayed,n=!i||i.highlighted,a=!i||i.selected,l=!i||i.clippable,A=!i||i.pickable,c=!i||i.colorize,h=!i||i.opacity,u=t.metaObjects,d=e.objects;for(let e=0,t=u.length;e<t;e++){const t=d[u[e].id];t&&(s&&(t.visible=this.objectsVisible[e]),r&&(t.edges=this.objectsEdges[e]),o&&(t.xrayed=this.objectsXrayed[e]),n&&(t.highlighted=this.objectsHighlighted[e]),a&&(t.selected=this.objectsSelected[e]),l&&(t.clippable=this.objectsClippable[e]),A&&(t.pickable=this.objectsPickable[e]),c&&(Jc[0]=this.objectsColorize[3*e+0],Jc[1]=this.objectsColorize[3*e+1],Jc[2]=this.objectsColorize[3*e+2],t.colorize=Jc),h&&(t.opacity=this.objectsOpacity[e]))}}}const qc=d.vec3();class $c{constructor(){this.objectsVisible=[],this.objectsEdges=[],this.objectsXrayed=[],this.objectsHighlighted=[],this.objectsSelected=[],this.objectsClippable=[],this.objectsPickable=[],this.objectsColorize=[],this.objectsHasColorize=[],this.objectsOpacity=[],this.numObjects=0}saveObjects(e,t){this.numObjects=0,this._mask=t?y.apply(t,{}):null;const i=e.objects,s=!t||t.visible,r=!t||t.edges,o=!t||t.xrayed,n=!t||t.highlighted,a=!t||t.selected,l=!t||t.clippable,A=!t||t.pickable,c=!t||t.colorize,h=!t||t.opacity;for(let e in i)if(i.hasOwnProperty(e)){const t=i[e],u=this.numObjects;if(s&&(this.objectsVisible[u]=t.visible),r&&(this.objectsEdges[u]=t.edges),o&&(this.objectsXrayed[u]=t.xrayed),n&&(this.objectsHighlighted[u]=t.highlighted),a&&(this.objectsSelected[u]=t.selected),l&&(this.objectsClippable[u]=t.clippable),A&&(this.objectsPickable[u]=t.pickable),c){const e=t.colorize;e?(this.objectsColorize[3*u+0]=e[0],this.objectsColorize[3*u+1]=e[1],this.objectsColorize[3*u+2]=e[2],this.objectsHasColorize[u]=!0):this.objectsHasColorize[u]=!1}h&&(this.objectsOpacity[u]=t.opacity),this.numObjects++}}restoreObjects(e){const t=this._mask,i=!t||t.visible,s=!t||t.edges,r=!t||t.xrayed,o=!t||t.highlighted,n=!t||t.selected,a=!t||t.clippable,l=!t||t.pickable,A=!t||t.colorize,c=!t||t.opacity;var h=0;const u=e.objects;for(let e in u)if(u.hasOwnProperty(e)){const t=u[e];i&&(t.visible=this.objectsVisible[h]),s&&(t.edges=this.objectsEdges[h]),r&&(t.xrayed=this.objectsXrayed[h]),o&&(t.highlighted=this.objectsHighlighted[h]),n&&(t.selected=this.objectsSelected[h]),a&&(t.clippable=this.objectsClippable[h]),l&&(t.pickable=this.objectsPickable[h]),A&&(this.objectsHasColorize[h]?(qc[0]=this.objectsColorize[3*h+0],qc[1]=this.objectsColorize[3*h+1],qc[2]=this.objectsColorize[3*h+2],t.colorize=qc):t.colorize=null),c&&(t.opacity=this.objectsOpacity[h]),h++}}}class eh extends K{constructor(e,t={}){super(e,t),this.v0=t.v0,this.v1=t.v1,this.v2=t.v2,this.v3=t.v3,this.t=t.t}set v0(e){this._v0=e||d.vec3([0,0,0])}get v0(){return this._v0}set v1(e){this._v1=e||d.vec3([0,0,0])}get v1(){return this._v1}set v2(e){this._v2=e||d.vec3([0,0,0])}get v2(){return this._v2}set v3(e){this.fire("v3",this._v3=e||d.vec3([0,0,0]))}get v3(){return this._v3}set t(e){e=e||0,this._t=e<0?0:e>1?1:e}get t(){return this._t}get point(){return this.getPoint(this._t)}getPoint(e){var t=d.vec3();return t[0]=d.b3(e,this._v0[0],this._v1[0],this._v2[0],this._v3[0]),t[1]=d.b3(e,this._v0[1],this._v1[1],this._v2[1],this._v3[1]),t[2]=d.b3(e,this._v0[2],this._v1[2],this._v2[2],this._v3[2]),t}getJSON(){return{v0:this._v0,v1:this._v1,v2:this._v2,v3:this._v3,t:this._t}}}class th extends K{constructor(e,t={}){super(e,t),this._cachedLengths=[],this._dirty=!0,this._curves=[],this._t=0,this._dirtySubs=[],this._destroyedSubs=[],this.curves=t.curves||[],this.t=t.t}addCurve(e){this._curves.push(e),this._dirty=!0}set curves(e){var t,i,s;for(e=e||[],i=0,s=this._curves.length;i<s;i++)(t=this._curves[i]).off(this._dirtySubs[i]),t.off(this._destroyedSubs[i]);this._curves=[],this._dirtySubs=[],this._destroyedSubs=[];var r=this;function o(){r._dirty=!0}function n(){var e=this.id;for(i=0,s=r._curves.length;i<s;i++)if(r._curves[i].id===e)return r._curves=r._curves.slice(i,i+1),r._dirtySubs=r._dirtySubs.slice(i,i+1),r._destroyedSubs=r._destroyedSubs.slice(i,i+1),void(r._dirty=!0)}for(i=0,s=e.length;i<s;i++){if(t=e[i],y.isNumeric(t)||y.isString(t)){var a=t;if(!(t=this.scene.components[a])){this.error("Component not found: "+_inQuotes(a));continue}}var l=t.type;"xeokit.SplineCurve"===l||"xeokit.Path"===l||"xeokit.CubicBezierCurve"===l||"xeokit.QuadraticBezierCurve"===l?(this._curves.push(t),this._dirtySubs.push(t.on("dirty",o)),this._destroyedSubs.push(t.once("destroyed",n))):this.error("Component "+_inQuotes(t.id)+" is not a xeokit.SplineCurve, xeokit.Path or xeokit.QuadraticBezierCurve")}this._dirty=!0}get curves(){return this._curves}set t(e){e=e||0,this._t=e<0?0:e>1?1:e}get t(){return this._t}get point(){return this.getPoint(this._t)}get length(){var e=this._getCurveLengths();return e[e.length-1]}getPoint(e){for(var t,i=e*this.length,s=this._getCurveLengths(),r=0;r<s.length;){if(s[r]>=i){var o=1-(s[r]-i)/(t=this._curves[r]).length;return t.getPointAt(o)}r++}return null}_getCurveLengths(){if(!this._dirty)return this._cachedLengths;var e,t=[],i=0,s=this._curves.length;for(e=0;e<s;e++)i+=this._curves[e].length,t.push(i);return this._cachedLengths=t,this._dirty=!1,t}_getJSON(){for(var e=[],t=0,i=this._curves.length;t<i;t++)e.push(this._curves[t].id);return{curves:e,t:this._t}}destroy(){var e,t,i;for(super.destroy(),e=0,t=this._curves.length;e<t;e++)(i=this._curves[e]).off(this._dirtySubs[e]),i.off(this._destroyedSubs[e])}}class ih extends K{constructor(e,t={}){super(e,t),this.v0=t.v0,this.v1=t.v1,this.v2=t.v2,this.t=t.t}set v0(e){this._v0=e||d.vec3([0,0,0])}get v0(){return this._v0}set v1(e){this._v1=e||d.vec3([0,0,0])}get v1(){return this._v1}set v2(e){this._v2=e||d.vec3([0,0,0])}get v2(){return this._v2}set t(e){e=e||0,this._t=e<0?0:e>1?1:e}get t(){return this._t}get point(){return this.getPoint(this._t)}getPoint(e){var t=d.vec3();return t[0]=d.b2(e,this._v0[0],this._v1[0],this._v2[0]),t[1]=d.b2(e,this._v0[1],this._v1[1],this._v2[1]),t[2]=d.b2(e,this._v0[2],this._v1[2],this._v2[2]),t}getJSON(){return{v0:this._v0,v1:this._v1,v2:this._v2,t:this._t}}}class sh extends Tc{constructor(e,t={}){super(e,t)}}const rh=d.vec3(),oh=d.vec3(),nh=d.vec4(),ah=d.vec3([0,0,-1]),lh=d.vec3([0,0,1]),Ah=d.vec3([0,1,0]);class ch extends R{get type(){return"SectionPlane"}constructor(e,t={}){super(e,t),this._state=new ae({active:!0,pos:d.vec3(),quaternion:d.vec4(),roll:0,dir:d.vec3(),dist:0}),this.active=t.active,this.pos=t.pos,this.dir=t.dir,this.scene._sectionPlaneCreated(this)}set active(e){this._state.active=!1!==e,this.glRedraw(),this.fire("active",this._state.active),this.scene.fire("sectionPlaneUpdated",this)}get active(){return this._state.active}set pos(e){this._state.pos.set(e||[0,0,0]),this._state.dist=-d.dotVec3(this._state.pos,this._state.dir),this.fire("pos",this._state.pos),this.scene.fire("sectionPlaneUpdated",this)}get pos(){return this._state.pos}set quaternion(e){this._state.quaternion.set(e||[0,0,0,-1]),d.vec3ApplyQuaternion(this._state.quaternion,lh,this._state.dir);const t=d.vec3ApplyQuaternion(this._state.quaternion,Ah,rh),i=d.vec3PairToQuaternion(lh,this._state.dir,nh),s=d.vec3ApplyQuaternion(i,Ah,oh),r=Math.acos(Math.min(1,d.dotVec3(t,s))),o=Math.sign(d.dotVec3(this._state.dir,d.cross3Vec3(t,s,oh)));this._state.roll=o*r,this._onDirUpdated()}get quaternion(){return this._state.quaternion}set roll(e){this._state.roll=e||0,this._onDirRollUpdated()}get roll(){return this._state.roll}set dir(e){this._state.dir.set(e||ah),this._onDirRollUpdated()}_onDirRollUpdated(){d.vec3PairToQuaternion(lh,this._state.dir,this._state.quaternion),nh[0]=0,nh[1]=0,nh[2]=-1,nh[3]=this._state.roll,d.angleAxisToQuaternion(nh,nh),d.mulQuaternions(this._state.quaternion,nh,this._state.quaternion),this._onDirUpdated()}_onDirUpdated(){this._state.dist=-d.dotVec3(this._state.pos,this._state.dir),this.glRedraw(),this.fire("dir",this._state.dir),this.scene.fire("sectionPlaneUpdated",this)}get dir(){return this._state.dir}get dist(){return this._state.dist}flipDir(){d.mulVec3Scalar(this._state.dir,-1,this._state.dir),this.dir=this._state.dir}destroy(){this._state.destroy(),this.scene._sectionPlaneDestroyed(this),super.destroy()}}class hh{transcode(e,t,i={}){}destroy(){}}class uh{constructor(){this.entity=null,this.primitive=null,this.primIndex=-1,this.pickSurfacePrecision=!1,this.touchInput=!1,this.snappedToEdge=!1,this.snappedToVertex=!1,this._origin=new Float64Array([0,0,0]),this._direction=new Float64Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float64Array([0,0,0]),this._worldPos=new Float64Array([0,0,0]),this._viewPos=new Float64Array([0,0,0]),this._canvasPos=new Int16Array([0,0]),this._snappedCanvasPos=new Int16Array([0,0]),this._bary=new Float64Array([0,0,0]),this._worldNormal=new Float64Array([0,0,0]),this._uv=new Float64Array([0,0]),this.reset()}get canvasPos(){return this._gotCanvasPos?this._canvasPos:null}set canvasPos(e){e?(this._canvasPos[0]=e[0],this._canvasPos[1]=e[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1}get origin(){return this._gotOrigin?this._origin:null}set origin(e){e?(this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this._gotOrigin=!0):this._gotOrigin=!1}get direction(){return this._gotDirection?this._direction:null}set direction(e){e?(this._direction[0]=e[0],this._direction[1]=e[1],this._direction[2]=e[2],this._gotDirection=!0):this._gotDirection=!1}get indices(){return this.entity&&this._gotIndices?this._indices:null}set indices(e){e?(this._indices[0]=e[0],this._indices[1]=e[1],this._indices[2]=e[2],this._gotIndices=!0):this._gotIndices=!1}get localPos(){return this.entity&&this._gotLocalPos?this._localPos:null}set localPos(e){e?(this._localPos[0]=e[0],this._localPos[1]=e[1],this._localPos[2]=e[2],this._gotLocalPos=!0):this._gotLocalPos=!1}get snappedCanvasPos(){return this._gotSnappedCanvasPos?this._snappedCanvasPos:null}set snappedCanvasPos(e){e?(this._snappedCanvasPos[0]=e[0],this._snappedCanvasPos[1]=e[1],this._gotSnappedCanvasPos=!0):this._gotSnappedCanvasPos=!1}get worldPos(){return this._gotWorldPos?this._worldPos:null}set worldPos(e){e?(this._worldPos[0]=e[0],this._worldPos[1]=e[1],this._worldPos[2]=e[2],this._gotWorldPos=!0):this._gotWorldPos=!1}get viewPos(){return this.entity&&this._gotViewPos?this._viewPos:null}set viewPos(e){e?(this._viewPos[0]=e[0],this._viewPos[1]=e[1],this._viewPos[2]=e[2],this._gotViewPos=!0):this._gotViewPos=!1}get bary(){return this.entity&&this._gotBary?this._bary:null}set bary(e){e?(this._bary[0]=e[0],this._bary[1]=e[1],this._bary[2]=e[2],this._gotBary=!0):this._gotBary=!1}get worldNormal(){return this.entity&&this._gotWorldNormal?this._worldNormal:null}set worldNormal(e){e?(this._worldNormal[0]=e[0],this._worldNormal[1]=e[1],this._worldNormal[2]=e[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1}get uv(){return this.entity&&this._gotUV?this._uv:null}set uv(e){e?(this._uv[0]=e[0],this._uv[1]=e[1],this._gotUV=!0):this._gotUV=!1}get snapped(){return this.snappedToEdge||this.snappedToVertex}reset(){this.entity=null,this.primIndex=-1,this.primitive=null,this.pickSurfacePrecision=!1,this._gotCanvasPos=!1,this._gotSnappedCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1,this.touchInput=!1,this.snappedToEdge=!1,this.snappedToVertex=!1}}const dh={isIphoneSafari(){const e=window.navigator.userAgent,t=/iPhone/i.test(e),i=/Safari/i.test(e)&&!/Chrome/i.test(e);return t&&i},isIphoneOrIpadSafari(){const e=window.navigator.userAgent,t=/iPhone|iPad/i.test(e)||/Macintosh/i.test(e)&&navigator.maxTouchPoints&&navigator.maxTouchPoints>2,i=/Safari/i.test(e)&&!/Chrome/i.test(e);return t&&i},isTouchDevice:()=>"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.mxMaxTouchPoints>0};class ph{constructor(e,t,i){this.id=i&&i.id?i.id:e,this.viewer=t,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,t.addPlugin(this)}scheduleTask(e){I.scheduleTask(e,null)}fire(e,t,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),!0!==i&&(this._events[e]=t||!0);const s=this._eventSubs[e];let r;if(s)for(const i in s)s.hasOwnProperty(i)&&(r=s[i],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,t):this.error("fire: potential stack overflow from recursive event '"+e+"' - dropping this event"),this._eventCallDepth--)}on(t,i,s){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new e),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let r=this._eventSubs[t];r?this._eventSubsNum[t]++:(r={},this._eventSubs[t]=r,this._eventSubsNum[t]=1);const o=this._subIdMap.addItem();r[o]={callback:i,scope:s||this},this._subIdEvents[o]=t;const n=this._events[t];return void 0!==n&&i.call(s||this,n),o}off(e){if(null==e)return;if(!this._subIdEvents)return;const t=this._subIdEvents[e];if(t){delete this._subIdEvents[e];const i=this._eventSubs[t];i&&(delete i[e],this._eventSubsNum[t]--),this._subIdMap.removeItem(e)}}once(e,t,i){const s=this,r=this.on(e,(function(e){s.off(r),t.call(i||this,e)}),i)}hasSubs(e){return this._eventSubsNum&&this._eventSubsNum[e]>0}log(e){console.log(`[xeokit plugin ${this.id}]: ${e}`)}warn(e){console.warn(`[xeokit plugin ${this.id}]: ${e}`)}error(e){console.error(`[xeokit plugin ${this.id}]: ${e}`)}send(e,t){}destroy(){this.viewer.removePlugin(this)}}class fh extends R{get type(){return"Spinner"}constructor(e,t={}){super(e,t),this._canvas=t.canvas,this._element=null,this._isCustom=!1,t.elementId&&(this._element=document.getElementById(t.elementId),this._element?this._adjustPosition():this.error("Can't find given Spinner HTML element: '"+t.elementId+"' - will automatically create default element")),this._element||this._createDefaultSpinner(),this.processes=0}_createDefaultSpinner(){this._injectDefaultCSS();const e=document.createElement("div"),t=e.style;t["z-index"]="9000",t.position="absolute",e.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(e),this._element=e,this._isCustom=!1,this._adjustPosition()}_injectDefaultCSS(){const e="xeokit-spinner-css";if(document.getElementById(e))return;const t=document.createElement("style");t.innerHTML=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }",t.id=e,document.body.appendChild(t)}_adjustPosition(){if(this._isCustom)return;const e=this._canvas,t=this._element,i=t.style;i.left=e.offsetLeft+.5*e.clientWidth-.5*t.clientWidth+"px",i.top=e.offsetTop+.5*e.clientHeight-.5*t.clientHeight+"px"}set processes(e){if(e=e||0,this._processes===e)return;if(e<0)return;const t=this._processes;this._processes=e;const i=this._element;i&&(i.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),0===this._processes&&this._processes!==t&&this.fire("zeroProcesses",this._processes)}get processes(){return this._processes}_destroy(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null);const e=document.getElementById("xeokit-spinner-css");e&&e.parentNode.removeChild(e)}}const mh=["webgl2","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];class gh extends R{constructor(e,t={}){super(e,t),this._backgroundColor=d.vec3([t.backgroundColor?t.backgroundColor[0]:1,t.backgroundColor?t.backgroundColor[1]:1,t.backgroundColor?t.backgroundColor[2]:1]),this._backgroundColorFromAmbientLight=!!t.backgroundColorFromAmbientLight,this.canvas=t.canvas,this.gl=null,this.webgl2=!1,this.transparent=!!t.transparent,this.contextAttr=t.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!!this.contextAttr.preserveDrawingBuffer,this.contextAttr.stencil=!1,this.contextAttr.premultipliedAlpha=!!this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=!1!==this.contextAttr.antialias,this.resolutionScale=t.resolutionScale,this.canvas.width=Math.round(this.canvas.clientWidth*this._resolutionScale),this.canvas.height=Math.round(this.canvas.clientHeight*this._resolutionScale),this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._initWebGL(t);const i=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(e){console.time("webglcontextrestored"),i.scene._webglContextLost(),i.fire("webglcontextlost"),e.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(e){i._initWebGL(),i.gl&&(i.scene._webglContextRestored(i.gl),i.fire("webglcontextrestored",i.gl),e.preventDefault()),console.timeEnd("webglcontextrestored")},!1);let s=!0;new ResizeObserver((e=>{for(const t of e)t.contentBoxSize&&(s=!0)})).observe(this.canvas),this._tick=this.scene.on("tick",(()=>{s&&(s=!1,i.canvas.width=Math.round(i.canvas.clientWidth*i._resolutionScale),i.canvas.height=Math.round(i.canvas.clientHeight*i._resolutionScale),i.boundary[0]=i.canvas.offsetLeft,i.boundary[1]=i.canvas.offsetTop,i.boundary[2]=i.canvas.clientWidth,i.boundary[3]=i.canvas.clientHeight,i.fire("boundary",i.boundary))})),this._spinner=new fh(this.scene,{canvas:this.canvas,elementId:t.spinnerElementId})}get type(){return"Canvas"}get backgroundColorFromAmbientLight(){return this._backgroundColorFromAmbientLight}set backgroundColorFromAmbientLight(e){this._backgroundColorFromAmbientLight=!1!==e,this.glRedraw()}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){e?(this._backgroundColor[0]=e[0],this._backgroundColor[1]=e[1],this._backgroundColor[2]=e[2]):(this._backgroundColor[0]=1,this._backgroundColor[1]=1,this._backgroundColor[2]=1),this.glRedraw()}get resolutionScale(){return this._resolutionScale}set resolutionScale(e){if((e=e||1)===this._resolutionScale)return;this._resolutionScale=e;const t=this.canvas;t.width=Math.round(t.clientWidth*this._resolutionScale),t.height=Math.round(t.clientHeight*this._resolutionScale),this.glRedraw()}get spinner(){return this._spinner}_createCanvas(){const e="xeokit-canvas-"+d.createUUID(),t=document.getElementsByTagName("body")[0],i=document.createElement("div"),s=i.style;s.height="100%",s.width="100%",s.padding="0",s.margin="0",s.background="rgba(0,0,0,0);",s.float="left",s.left="0",s.top="0",s.position="absolute",s.opacity="1.0",s["z-index"]="-10000",i.innerHTML+='<canvas id="'+e+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',t.appendChild(i),this.canvas=document.getElementById(e)}_getElementXY(e){let t=0,i=0;for(;e;)t+=e.offsetLeft-e.scrollLeft,i+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{x:t,y:i}}_initWebGL(){if(!this.gl)for(let e=0;!this.gl&&e<mh.length;e++)try{this.gl=this.canvas.getContext(mh[e],this.contextAttr)}catch(e){}this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0));{const e=this.gl;let t="__",i=e.activeTexture;e.activeTexture=function(e){t!==e&&(t=e,i.call(this,e))};let s={},r=e.bindTexture;e.bindTexture=function(e,i){s[t]!==i&&(s[t]=i,r.call(this,e,i))}}this.gl&&this.webgl2&&(this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST),this.gl,WebGL2RenderingContext)}getSnapshot(e){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}readPixels(e,t,i,s){return this.scene._renderer.readPixels(e,t,i,s)}loseWebGLContext(){this.canvas.loseContext&&this.canvas.loseContext()}destroy(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.gl=null,super.destroy()}}class _h{constructor(e){this._scene=e,this._matPool=[],this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.reset()}reset(){this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.gl=this._scene.canvas.gl,this.lastProgramId=null,this.pbrEnabled=!1,this.colorTextureEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.pickElementsCount=null,this.pickElementsOffset=null,this.lineWidth=1,this.snapPickLayerParams={},this.snapPickLayerNumber=0,this.snapPickCoordinateScale=d.vec3(),this.snapPickOrigin=d.vec3()}getRTCViewMatrix(e,t){let i=this._rtcViewMats[e];return i||(i=this._getNewMat(),Ye(this._scene.camera.viewMatrix,t,i),this._rtcViewMats[e]=i),i}getRTCPickViewMatrix(e,t){let i=this._rtcPickViewMats[e];if(!i){i=this._getNewMat();const s=this.pickViewMatrix||this._scene.camera.viewMatrix;Ye(s,t,i),this._rtcPickViewMats[e]=i}return i}_getNewMat(){let e=this._matPool[this._matPoolNextFreeIndex];return e||(e=d.mat4(),this._matPool[this._matPoolNextFreeIndex]=e),this._matPoolNextFreeIndex++,e}}class vh{constructor(e,t){this.scene=e,this.aabb=d.AABB3(),this.origin=d.vec3(t),this.originHash=this.origin.join(),this.numMarkers=0,this.markers={},this.markerList=[],this.markerIndices={},this.positions=[],this.indices=[],this.positionsBuf=null,this.lenPositionsBuf=0,this.indicesBuf=null,this.sectionPlanesActive=[],this.culledBySectionPlanes=!1,this.occlusionTestList=[],this.lenOcclusionTestList=0,this.pixels=[],this.aabbDirty=!1,this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!1}addMarker(e){this.markers[e.id]=e,this.markerListDirty=!0,this.numMarkers++}markerWorldPosUpdated(e){if(!this.markers[e.id])return;const t=this.markerIndices[e.id];this.positions[3*t+0]=e.worldPos[0],this.positions[3*t+1]=e.worldPos[1],this.positions[3*t+2]=e.worldPos[2],this.positionsDirty=!0}removeMarker(e){delete this.markers[e.id],this.markerListDirty=!0,this.numMarkers--}update(){this.markerListDirty&&(this._buildMarkerList(),this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!0),this.positionsDirty&&(this._buildPositions(),this.positionsDirty=!1,this.aabbDirty=!0,this.vbosDirty=!0),this.aabbDirty&&(this._buildAABB(),this.aabbDirty=!1),this.vbosDirty&&(this._buildVBOs(),this.vbosDirty=!1),this.occlusionTestListDirty&&this._buildOcclusionTestList(),this._updateActiveSectionPlanes()}_buildMarkerList(){for(var e in this.numMarkers=0,this.markers)this.markers.hasOwnProperty(e)&&(this.markerList[this.numMarkers]=this.markers[e],this.markerIndices[e]=this.numMarkers,this.numMarkers++);this.markerList.length=this.numMarkers}_buildPositions(){let e=0;for(let t=0;t<this.numMarkers;t++)if(this.markerList[t]){const i=this.markerList[t].rtcPos;this.positions[e++]=i[0],this.positions[e++]=i[1],this.positions[e++]=i[2],this.indices[t]=t}this.positions.length=3*this.numMarkers,this.indices.length=this.numMarkers}_buildAABB(){const e=this.aabb;d.collapseAABB3(e),d.expandAABB3Points3(e,this.positions);const t=this.origin;e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[0],e[4]+=t[1],e[5]+=t[2]}_buildVBOs(){if(this.positionsBuf){if(this.lenPositionsBuf===this.positions.length)return void this.positionsBuf.setData(new Float32Array(this.positions));this.positionsBuf.destroy(),this.positionsBuf=null,this.indicesBuf.destroy(),this.indicesBuf=null}const e=this.scene.canvas.gl,t=3*this.numMarkers,i=this.numMarkers;this.positionsBuf=new le(e,e.ARRAY_BUFFER,new Float32Array(this.positions),t,3,e.STATIC_DRAW),this.indicesBuf=new le(e,e.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),i,1,e.STATIC_DRAW),this.lenPositionsBuf=this.positions.length}_buildOcclusionTestList(){const e=this.scene.canvas,t=this.scene.camera.perspective.near,i=e.boundary,s=i[2],r=i[3];let o=0;this.lenOcclusionTestList=0;for(let e=0;e<this.numMarkers;e++){const i=this.markerList[e];if(i.viewPos[2]>-t){i._setVisible(!1);continue}const n=i.canvasPos,a=n[0],l=n[1];a+10<0||l+10<0||a-10>s||l-10>r?i._setVisible(!1):!i.entity||i.entity.visible?i.occludable?(this.occlusionTestList[this.lenOcclusionTestList++]=i,this.pixels[o++]=a,this.pixels[o++]=l):i._setVisible(!0):i._setVisible(!1)}}_updateActiveSectionPlanes(){const e=this.scene._sectionPlanesState.sectionPlanes,t=e.length;if(t>0)for(let i=0;i<t;i++){const t=e[i];if(t.active){const e=d.planeAABB3Intersect(t.dir,t.dist,this.aabb);if(-1===e)return void(this.culledBySectionPlanes=!0);const s=0===e;this.sectionPlanesActive[i]=s}else this.sectionPlanesActive[i]=!1}this.culledBySectionPlanes=!1}destroy(){this.markers={},this.markerList.length=0,this.positionsBuf&&this.positionsBuf.destroy(),this.indicesBuf&&this.indicesBuf.destroy()}}const bh=d.vec3([1,0,0]),yh=d.vec3();class wh{constructor(e,t){this._scene=e,this._renderBufferManager=t,this._occlusionLayers={},this._occlusionLayersList=[],this._occlusionLayersListDirty=!1,this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markersToOcclusionLayersMap={},this._onCameraViewMatrix=e.camera.on("viewMatrix",(()=>{this._occlusionTestListDirty=!0})),this._onCameraProjMatrix=e.camera.on("projMatrix",(()=>{this._occlusionTestListDirty=!0})),this._onCanvasBoundary=e.canvas.on("boundary",(()=>{this._occlusionTestListDirty=!0}))}addMarker(e){const t=e.origin.join();let i=this._occlusionLayers[t];i||(i=new vh(this._scene,e.origin),this._occlusionLayers[i.originHash]=i,this._occlusionLayersListDirty=!0),i.addMarker(e),this._markersToOcclusionLayersMap[e.id]=i,this._occlusionTestListDirty=!0}markerWorldPosUpdated(e){const t=this._markersToOcclusionLayersMap[e.id];if(!t)return;const i=e.origin.join();if(i!==t.originHash){1===t.numMarkers?(t.destroy(),delete this._occlusionLayers[t.originHash],this._occlusionLayersListDirty=!0):t.removeMarker(e);let s=this._occlusionLayers[i];s||(s=new vh(this._scene,e.origin),this._occlusionLayers[i]=s,this._occlusionLayersListDirty=!0),s.addMarker(e),this._markersToOcclusionLayersMap[e.id]=s}else t.markerWorldPosUpdated(e)}removeMarker(e){const t=e.origin.join();let i=this._occlusionLayers[t];i&&(1===i.numMarkers?(i.destroy(),delete this._occlusionLayers[i.originHash],this._occlusionLayersListDirty=!0):i.removeMarker(e),delete this._markersToOcclusionLayersMap[e.id])}get needOcclusionTest(){return this._occlusionTestListDirty}bindRenderBuf(){const e=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");if(e!==this._shaderSourceHash&&(this._shaderSourceHash=e,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._occlusionLayersListDirty&&(this._buildOcclusionLayersList(),this._occlusionLayersListDirty=!1),this._occlusionTestListDirty){for(let e=0,t=this._occlusionLayersList.length;e<t;e++){this._occlusionLayersList[e].occlusionTestListDirty=!0}this._occlusionTestListDirty=!1}this._readPixelBuf=this._renderBufferManager.getRenderBuffer("occlusionReadPix"),this._readPixelBuf.bind(),this._readPixelBuf.clear()}_buildOcclusionLayersList(){let e=0;for(let t in this._occlusionLayers)this._occlusionLayers.hasOwnProperty(t)&&(this._occlusionLayersList[e++]=this._occlusionLayers[t]);this._occlusionLayersList.length=e}_buildShaderSource(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}}_buildVertexShaderSource(){const e=this._scene,t=e._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("#version 300 es"),i.push("// OcclusionTester vertex shader"),i.push("in vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),e.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),i.push("out float vFragDepth;")),t&&i.push("out vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("vec4 worldPosition = vec4(position, 1.0); "),i.push("   vec4 viewPosition = viewMatrix * worldPosition;"),t&&i.push("   vWorldPosition = worldPosition;"),i.push("   vec4 clipPos = projMatrix * viewPosition;"),i.push("   gl_PointSize = 20.0;"),e.logarithmicDepthBufferEnabled?i.push("vFragDepth = 1.0 + clipPos.w;"):e.markerZOffset<0&&i.push("clipPos.z += "+e.markerZOffset+";"),i.push("   gl_Position = clipPos;"),i.push("}"),i}_buildFragmentShaderSource(){const e=this._scene,t=e._sectionPlanesState,i=t.sectionPlanes.length>0,s=[];if(s.push("#version 300 es"),s.push("// OcclusionTester fragment shader"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),e.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),s.push("in float vFragDepth;")),i){s.push("in vec4 vWorldPosition;");for(let e=0;e<t.sectionPlanes.length;e++)s.push("uniform bool sectionPlaneActive"+e+";"),s.push("uniform vec3 sectionPlanePos"+e+";"),s.push("uniform vec3 sectionPlaneDir"+e+";")}if(s.push("out vec4 outColor;"),s.push("void main(void) {"),i){s.push("  float dist = 0.0;");for(var r=0;r<t.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }")}return e.logarithmicDepthBufferEnabled&&s.push("gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   outColor = vec4(1.0, 0.0, 0.0, 1.0); "),s.push("}"),s}_buildProgram(){this._program&&this._program.destroy();const e=this._scene,t=e.canvas.gl,i=e._sectionPlanesState;if(this._program=new Ci(t,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,t=i.sectionPlanes.length;e<t;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}drawMarkers(){const e=this._scene,t=e.canvas.gl,i=this._program,s=e._sectionPlanesState,r=e.camera,o=e.camera.project;if(i.bind(),t.uniformMatrix4fv(this._uProjMatrix,!1,r._project._state.matrix),e.logarithmicDepthBufferEnabled){const e=2/(Math.log(o.far+1)/Math.LN2);t.uniform1f(this._uLogDepthBufFC,e)}for(let e=0,i=this._occlusionLayersList.length;e<i;e++){const i=this._occlusionLayersList[e];if(i.update(),i.culledBySectionPlanes)continue;const o=i.origin;t.uniformMatrix4fv(this._uViewMatrix,!1,Ye(r.viewMatrix,o));const n=s.sectionPlanes.length;if(n>0){const e=s.sectionPlanes;for(let s=0;s<n;s++){const r=this._uSectionPlanes[s];if(r){const n=i.sectionPlanesActive[s];if(t.uniform1i(r.active,n?1:0),n){const i=e[s];t.uniform3fv(r.pos,tt(i.dist,i.dir,o,yh)),t.uniform3fv(r.dir,i.dir)}}}}this._aPosition.bindArrayBuffer(i.positionsBuf);const a=i.indicesBuf;a.bind(),t.drawElements(t.POINTS,a.numItems,a.itemType,0)}}doOcclusionTest(){{const e=this._scene.canvas.resolutionScale,t=255*bh[0],i=255*bh[1],s=255*bh[2];for(let r=0,o=this._occlusionLayersList.length;r<o;r++){const o=this._occlusionLayersList[r];for(let r=0;r<o.lenOcclusionTestList;r++){const n=o.occlusionTestList[r],a=2*r,l=this._readPixelBuf.read(Math.round(o.pixels[a]*e),Math.round(o.pixels[a+1]*e)),A=l[0]===t&&l[1]===i&&l[2]===s;n._setVisible(A)}}}}unbindRenderBuf(){this._readPixelBuf.unbind()}destroy(){if(!this.destroyed){for(let e=0,t=this._occlusionLayersList.length;e<t;e++){this._occlusionLayersList[e].destroy()}this._program&&this._program.destroy(),this._scene.camera.off(this._onCameraViewMatrix),this._scene.camera.off(this._onCameraProjMatrix),this._scene.canvas.off(this._onCanvasBoundary),this.destroyed=!0}}}const Bh=d.vec2();class Ph{constructor(e){this._scene=e,this._numSamples=null,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uRandomSeed=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()}init(){this._rebuild=!0}render(e){if(this._build(),this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let e=!0;this._scene.camera.on("projMatrix",(function(){e=!0}));const t=d.mat4();return()=>(e&&d.inverseMat4(s.camera.projMatrix,t),t)})());const t=this._scene.canvas.gl,i=this._program,s=this._scene,r=s.sao,o=t.drawingBufferWidth,n=t.drawingBufferHeight,a=s.camera.project._state,l=a.near,A=a.far,c=a.matrix,h=this._getInverseProjectMat(),u=Math.random(),p="perspective"===s.camera.projection;Bh[0]=o,Bh[1]=n,t.viewport(0,0,o,n),t.clearColor(0,0,0,1),t.disable(t.DEPTH_TEST),t.disable(t.BLEND),t.frontFace(t.CCW),t.clear(t.COLOR_BUFFER_BIT),i.bind(),t.uniform1f(this._uCameraNear,l),t.uniform1f(this._uCameraFar,A),t.uniformMatrix4fv(this._uCameraProjectionMatrix,!1,c),t.uniformMatrix4fv(this._uCameraInverseProjectionMatrix,!1,h),t.uniform1i(this._uPerspective,p),t.uniform1f(this._uScale,r.scale*(A/5)),t.uniform1f(this._uIntensity,r.intensity),t.uniform1f(this._uBias,r.bias),t.uniform1f(this._uKernelRadius,r.kernelRadius),t.uniform1f(this._uMinResolution,r.minResolution),t.uniform2fv(this._uViewport,Bh),t.uniform1f(this._uRandomSeed,u);const f=e.getDepthTexture();i.bindTexture(this._uDepthTexture,f,0),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),t.drawElements(t.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}_build(){let e=!1;const t=this._scene.sao;if(t.numSamples!==this._numSamples&&(this._numSamples=Math.floor(t.numSamples),e=!0),!e&&!this._rebuild)return;this._rebuild=!1;const i=this._scene.canvas.gl;if(this._program&&(this._program.destroy(),this._program=null),this._program=new Ci(i,{vertex:["#version 300 es\n                    precision highp float;\n                    precision highp int;\n                    \n                    in vec3 aPosition;\n                    in vec2 aUV;            \n                    \n                    out vec2 vUV;\n                    \n                    void main () {\n                        gl_Position = vec4(aPosition, 1.0);\n                        vUV = aUV;\n                    }"],fragment:[`#version 300 es      \n                precision highp float;\n                precision highp int;           \n                \n                #define NORMAL_TEXTURE 0\n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n                #define NUM_SAMPLES ${this._numSamples}\n                #define NUM_RINGS 4              \n            \n                in vec2        vUV;\n            \n                uniform sampler2D   uDepthTexture;\n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;\n                uniform mat4        uProjectMatrix;\n                uniform mat4        uInverseProjectMatrix;\n                \n                uniform bool        uPerspective;\n\n                uniform float       uScale;\n                uniform float       uIntensity;\n                uniform float       uBias;\n                uniform float       uKernelRadius;\n                uniform float       uMinResolution;\n                uniform vec2        uViewport;\n                uniform float       uRandomSeed;\n\n                float pow2( const in float x ) { return x*x; }\n                \n                highp float rand( const in vec2 uv ) {\n                    const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n                    highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n                    return fract(sin(sn) * c);\n                }\n\n                vec3 packNormalToRGB( const in vec3 normal ) {\n                    return normalize( normal ) * 0.5 + 0.5;\n                }\n\n                vec3 unpackRGBToNormal( const in vec3 rgb ) {\n                    return 2.0 * rgb.xyz - 1.0;\n                }\n\n                const float packUpscale = 256. / 255.;\n                const float unpackDownScale = 255. / 256.; \n\n                const vec3 packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4 unPackFactors = unpackDownScale / vec4( packFactors, 1. );   \n\n                const float shiftRights = 1. / 256.;\n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float unpackRGBAToFloat( const in vec4 v ) {                   \n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unPackFactors );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n                    return ( near * far ) / ( ( far - near ) * invClipZ - far );\n                }\n\n                float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n                    return linearClipZ * ( near - far ) - near;\n                }\n                \n                float getDepth( const in vec2 screenPosition ) {\n                    return vec4(texture(uDepthTexture, screenPosition)).r;\n                }\n\n                float getViewZ( const in float depth ) {\n                     if (uPerspective) {\n                         return perspectiveDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     } else {\n                        return orthographicDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     }\n                }\n\n                vec3 getViewPos( const in vec2 screenPos, const in float depth, const in float viewZ ) {\n                \tfloat clipW = uProjectMatrix[2][3] * viewZ + uProjectMatrix[3][3];\n                \tvec4 clipPosition = vec4( ( vec3( screenPos, depth ) - 0.5 ) * 2.0, 1.0 );\n                \tclipPosition *= clipW; \n                \treturn ( uInverseProjectMatrix * clipPosition ).xyz;\n                }\n\n                vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPos ) {               \n                    return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );\n                }\n\n                float scaleDividedByCameraFar;\n                float minResolutionMultipliedByCameraFar;\n\n                float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {\n                \tvec3 viewDelta = sampleViewPosition - centerViewPosition;\n                \tfloat viewDistance = length( viewDelta );\n                \tfloat scaledScreenDistance = scaleDividedByCameraFar * viewDistance;\n                \treturn max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - uBias) / (1.0 + pow2( scaledScreenDistance ) );\n                }\n\n                const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );\n                const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );\n\n                float getAmbientOcclusion( const in vec3 centerViewPosition ) {\n            \n                \tscaleDividedByCameraFar = uScale / uCameraFar;\n                \tminResolutionMultipliedByCameraFar = uMinResolution * uCameraFar;\n                \tvec3 centerViewNormal = getViewNormal( centerViewPosition, vUV );\n\n                \tfloat angle = rand( vUV + uRandomSeed ) * PI2;\n                \tvec2 radius = vec2( uKernelRadius * INV_NUM_SAMPLES ) / uViewport;\n                \tvec2 radiusStep = radius;\n\n                \tfloat occlusionSum = 0.0;\n                \tfloat weightSum = 0.0;\n\n                \tfor( int i = 0; i < NUM_SAMPLES; i ++ ) {\n                \t\tvec2 sampleUv = vUV + vec2( cos( angle ), sin( angle ) ) * radius;\n                \t\tradius += radiusStep;\n                \t\tangle += ANGLE_STEP;\n\n                \t\tfloat sampleDepth = getDepth( sampleUv );\n                \t\tif( sampleDepth >= ( 1.0 - EPSILON ) ) {\n                \t\t\tcontinue;\n                \t\t}\n\n                \t\tfloat sampleViewZ = getViewZ( sampleDepth );\n                \t\tvec3 sampleViewPosition = getViewPos( sampleUv, sampleDepth, sampleViewZ );\n                \t\tocclusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );\n                \t\tweightSum += 1.0;\n                \t}\n\n                \tif( weightSum == 0.0 ) discard;\n\n                \treturn occlusionSum * ( uIntensity / weightSum );\n                }\n\n                out vec4 outColor;\n   \n                void main() {\n                \n                \tfloat centerDepth = getDepth( vUV );\n                \t\n                \tif( centerDepth >= ( 1.0 - EPSILON ) ) {\n                \t\tdiscard;\n                \t}\n\n                \tfloat centerViewZ = getViewZ( centerDepth );\n                \tvec3 viewPosition = getViewPos( vUV, centerDepth, centerViewZ );\n\n                \tfloat ambientOcclusion = getAmbientOcclusion( viewPosition );\n                \n                \toutColor = packFloatToRGBA(  1.0- ambientOcclusion );\n                }`]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);const s=new Float32Array([1,1,0,1,0,0,1,0]),r=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),o=new Uint32Array([0,1,2,0,2,3]);this._positionsBuf=new le(i,i.ARRAY_BUFFER,r,r.length,3,i.STATIC_DRAW),this._uvBuf=new le(i,i.ARRAY_BUFFER,s,s.length,2,i.STATIC_DRAW),this._indicesBuf=new le(i,i.ELEMENT_ARRAY_BUFFER,o,o.length,1,i.STATIC_DRAW),this._program.bind(),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uCameraProjectionMatrix=this._program.getLocation("uProjectMatrix"),this._uCameraInverseProjectionMatrix=this._program.getLocation("uInverseProjectMatrix"),this._uPerspective=this._program.getLocation("uPerspective"),this._uScale=this._program.getLocation("uScale"),this._uIntensity=this._program.getLocation("uIntensity"),this._uBias=this._program.getLocation("uBias"),this._uKernelRadius=this._program.getLocation("uKernelRadius"),this._uMinResolution=this._program.getLocation("uMinResolution"),this._uViewport=this._program.getLocation("uViewport"),this._uRandomSeed=this._program.getLocation("uRandomSeed"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV"),this._dirty=!1}destroy(){this._program&&(this._program.destroy(),this._program=null)}}const xh=new Float32Array(Th(17,[0,1])),Ch=new Float32Array(Th(17,[1,0])),Mh=new Float32Array(function(e,t){const i=[];for(let s=0;s<=e;s++)i.push(Ih(s,t));return i}(17,4)),Eh=new Float32Array(2);class Fh{constructor(e){this._scene=e,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uOcclusionTexture="uOcclusionTexture",this._uViewport=null,this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()}init(){const e=this._scene.canvas.gl;if(this._program=new Ci(e,{vertex:["#version 300 es\n                precision highp float;\n                precision highp int;\n                    \n                in vec3 aPosition;\n                in vec2 aUV;\n                uniform vec2 uViewport;\n                out vec2 vUV;\n                out vec2 vInvSize;\n                void main () {\n                    vUV = aUV;\n                    vInvSize = 1.0 / uViewport;\n                    gl_Position = vec4(aPosition, 1.0);\n                }"],fragment:["#version 300 es\n                precision highp float;\n                precision highp int;\n                    \n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n\n                #define KERNEL_RADIUS 16\n\n                in vec2        vUV;\n                in vec2        vInvSize;\n            \n                uniform sampler2D   uDepthTexture;\n                uniform sampler2D   uOcclusionTexture;              \n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;               \n                uniform float       uDepthCutoff;\n\n                uniform vec2        uSampleOffsets[ KERNEL_RADIUS + 1 ];\n                uniform float       uSampleWeights[ KERNEL_RADIUS + 1 ];\n\n                const float         unpackDownscale = 255. / 256.; \n\n                const vec3          packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4          unpackFactors = unpackDownscale / vec4( packFactors, 1. );   \n\n                const float packUpscale = 256. / 255.;\n       \n                const float shiftRights = 1. / 256.;\n                \n                float unpackRGBAToFloat( const in vec4 v ) {\n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unpackFactors );\n                }               \n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float viewZToOrthographicDepth( const in float viewZ) {\n                    return ( viewZ + uCameraNear ) / ( uCameraNear - uCameraFar );\n                }\n              \n                float orthographicDepthToViewZ( const in float linearClipZ) {\n                    return linearClipZ * ( uCameraNear - uCameraFar ) - uCameraNear;\n                }\n\n                float viewZToPerspectiveDepth( const in float viewZ) {\n                    return (( uCameraNear + viewZ ) * uCameraFar ) / (( uCameraFar - uCameraNear ) * viewZ );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ) {\n                    return ( uCameraNear * uCameraFar ) / ( ( uCameraFar - uCameraNear ) * invClipZ - uCameraFar );\n                }\n\n                float getDepth( const in vec2 screenPosition ) {\n                    return vec4(texture(uDepthTexture, screenPosition)).r;\n                }\n\n                float getViewZ( const in float depth ) {\n                     return perspectiveDepthToViewZ( depth );\n                }\n\n                out vec4 outColor;\n        \n                void main() {\n                \n                    float depth = getDepth( vUV );\n                    if( depth >= ( 1.0 - EPSILON ) ) {\n                        discard;\n                    }\n\n                    float centerViewZ = -getViewZ( depth );\n                    bool rBreak = false;\n                    bool lBreak = false;\n\n                    float weightSum = uSampleWeights[0];\n                    float occlusionSum = unpackRGBAToFloat(texture( uOcclusionTexture, vUV )) * weightSum;\n\n                    for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {\n\n                        float sampleWeight = uSampleWeights[i];\n                        vec2 sampleUVOffset = uSampleOffsets[i] * vInvSize;\n\n                        vec2 sampleUV = vUV + sampleUVOffset;\n                        float viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            rBreak = true;\n                        }\n\n                        if( ! rBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n\n                        sampleUV = vUV - sampleUVOffset;\n                        viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            lBreak = true;\n                        }\n\n                        if( ! lBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n                    }\n\n                    outColor = packFloatToRGBA(occlusionSum / weightSum);\n                }"]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);const t=new Float32Array([1,1,0,1,0,0,1,0]),i=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),s=new Uint32Array([0,1,2,0,2,3]);this._positionsBuf=new le(e,e.ARRAY_BUFFER,i,i.length,3,e.STATIC_DRAW),this._uvBuf=new le(e,e.ARRAY_BUFFER,t,t.length,2,e.STATIC_DRAW),this._indicesBuf=new le(e,e.ELEMENT_ARRAY_BUFFER,s,s.length,1,e.STATIC_DRAW),this._program.bind(),this._uViewport=this._program.getLocation("uViewport"),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uDepthCutoff=this._program.getLocation("uDepthCutoff"),this._uSampleOffsets=e.getUniformLocation(this._program.handle,"uSampleOffsets"),this._uSampleWeights=e.getUniformLocation(this._program.handle,"uSampleWeights"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV")}render(e,t,i){if(this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let e=!0;this._scene.camera.on("projMatrix",(function(){e=!0}));const t=d.mat4();return()=>(e&&d.inverseMat4(o.camera.projMatrix,t),t)})());const s=this._scene.canvas.gl,r=this._program,o=this._scene,n=s.drawingBufferWidth,a=s.drawingBufferHeight,l=o.camera.project._state,A=l.near,c=l.far;s.viewport(0,0,n,a),s.clearColor(0,0,0,1),s.enable(s.DEPTH_TEST),s.disable(s.BLEND),s.frontFace(s.CCW),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),r.bind(),Eh[0]=n,Eh[1]=a,s.uniform2fv(this._uViewport,Eh),s.uniform1f(this._uCameraNear,A),s.uniform1f(this._uCameraFar,c),s.uniform1f(this._uDepthCutoff,.01),0===i?s.uniform2fv(this._uSampleOffsets,Ch):s.uniform2fv(this._uSampleOffsets,xh),s.uniform1fv(this._uSampleWeights,Mh);const h=e.getDepthTexture(),u=t.getTexture();r.bindTexture(this._uDepthTexture,h,0),r.bindTexture(this._uOcclusionTexture,u,1),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),s.drawElements(s.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}destroy(){this._program.destroy()}}function Ih(e,t){return Math.exp(-e*e/(t*t*2))/(Math.sqrt(2*Math.PI)*t)}function Th(e,t){const i=[];for(let s=0;s<=e;s++)i.push(t[0]*s),i.push(t[1]*s);return i}class Dh{constructor(e){this.scene=e,this._renderBuffersBasic={},this._renderBuffersScaled={}}getRenderBuffer(e,t){const i=1===this.scene.canvas.resolutionScale?this._renderBuffersBasic:this._renderBuffersScaled;let s=i[e];return s||(s=new Lc(this.scene.canvas.canvas,this.scene.canvas.gl,t),i[e]=s),s}destroy(){for(let e in this._renderBuffersBasic)this._renderBuffersBasic[e].destroy();for(let e in this._renderBuffersScaled)this._renderBuffersScaled[e].destroy()}}const Sh=d.vec3([0,0,0]),Rh=function(t,i){i=i||{};const s=new _h(t),r=t.canvas.canvas,o=t.canvas.gl,n=!!i.transparent,a=i.alphaDepthMask,l=new e({});let A={},c={},h=[],u=[],p=[],f=!0,m=!0,_=!0,v=!0,b=!0,y=!0,w=!0,B=!0;const P=new Dh(t);let x=!1;const C=new Ph(t),M=new Fh(t);function E(){f&&(!function(){for(let e in A)if(A.hasOwnProperty(e)){const t=A[e],i=t.drawableMap,s=t.drawableListPreCull;let r=0;for(let e in i)i.hasOwnProperty(e)&&(s[r++]=i[e]);s.length=r}}(),f=!1,m=!0),m&&(!function(){let e=0;for(let t in A)if(A.hasOwnProperty(t)){const i=A[t].drawableListPreCull;for(let t=0,s=i.length;t<s;t++){const s=i[t];h[e++]=s}}h.length=e,h.sort(((e,t)=>e.renderOrder-t.renderOrder))}(),m=!1,_=!0),_&&function(){let e=0,t=0;for(let i=0,s=h.length;i<s;i++){const s=h[i];s.rebuildRenderFlags(),s.renderFlags.culled||(s.isUI?p[t++]=s:u[e++]=s)}u.length=e,p.length=t}()}function F(e){if(!e.castsShadow)return;const t=e.getShadowRenderBuf();if(t){t.bind(),s.reset(),s.backfaces=!0,s.frontface=!0,s.shadowViewMatrix=e.getShadowViewMatrix(),s.shadowProjMatrix=e.getShadowProjMatrix(),o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,1),o.enable(o.DEPTH_TEST),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(let e in A)if(A.hasOwnProperty(e)){const t=A[e].drawableList;for(let e=0,i=t.length;e<i;e++){const i=t[e];!1!==i.visible&&i.castsShadow&&i.drawShadow&&(i.renderFlags.colorOpaque&&i.drawShadow(s))}}t.unbind()}}this.scene=t,this._occlusionTester=null,this.capabilities={astcSupported:!!ys(o,"WEBGL_compressed_texture_astc"),etc1Supported:!0,etc2Supported:!!ys(o,"WEBGL_compressed_texture_etc"),dxtSupported:!!ys(o,"WEBGL_compressed_texture_s3tc"),bptcSupported:!!ys(o,"EXT_texture_compression_bptc"),pvrtcSupported:!(!ys(o,"WEBGL_compressed_texture_pvrtc")&&!ys(o,"WEBKIT_WEBGL_compressed_texture_pvrtc"))},this.setTransparentEnabled=function(e){v=e,_=!0},this.setEdgesEnabled=function(e){b=e,_=!0},this.setSAOEnabled=function(e){y=e,_=!0},this.setPBREnabled=function(e){w=e,_=!0},this.setColorTextureEnabled=function(e){B=e,_=!0},this.needStateSort=function(){m=!0},this.shadowsDirty=function(){},this.imageDirty=function(){_=!0},this.webglContextLost=function(){},this.webglContextRestored=function(e){C.init(),M.init(),_=!0},this.addDrawable=function(e,t){const i=t.type;if(!i)return void console.error("Renderer#addDrawable() : drawable with ID "+e+" has no 'type' - ignoring");let s=A[i];s||(s={type:t.type,count:0,isStateSortable:t.isStateSortable,stateSortCompare:t.stateSortCompare,drawableMap:{},drawableListPreCull:[],drawableList:[]},A[i]=s),s.count++,s.drawableMap[e]=t,c[e]=t,f=!0},this.removeDrawable=function(e){const t=c[e];if(!t)return void console.error("Renderer#removeDrawable() : drawable not found with ID "+e+" - ignoring");const i=t.type,s=A[i];--s.count<=0?delete A[i]:delete s.drawableMap[e],delete c[e],f=!0},this.getPickID=function(e){return l.addItem(e)},this.putPickID=function(e){l.removeItem(e)},this.clear=function(e){if(o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),n)o.clearColor(1,1,1,1);else{const e=t.canvas.backgroundColorFromAmbientLight?this.lights.getAmbientColorAndIntensity():t.canvas.backgroundColor;o.clearColor(e[0],e[1],e[2],1)}o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)},this.needsRender=function(){return _||f||m},this.render=function(e){(e=e||{}).force&&(_=!0),E(),_&&(!function(e){const i=t.sao;y&&i.possible&&function(e){const i=t.sao,r=P.getRenderBuffer("saoDepth",{depthTexture:!0});r.bind(),r.clear(),function(e){s.reset(),s.pass=e.pass,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.frontFace(o.CCW),o.enable(o.CULL_FACE),o.depthMask(!0),!1!==e.clear&&o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(let e=0,t=u.length;e<t;e++){const t=u[e];!0!==t.culled&&!1!==t.visible&&t.drawDepth&&t.saoEnabled&&(t.renderFlags.colorOpaque&&t.drawDepth(s))}}(e),r.unbind();const n=P.getRenderBuffer("saoOcclusion");if(n.bind(),n.clear(),C.render(r),n.unbind(),i.blur){const e=P.getRenderBuffer("saoOcclusion2");e.bind(),e.clear(),M.render(r,n,0),e.unbind(),n.bind(),n.clear(),M.render(r,e,1),n.unbind()}}(e);(function(){let e=t._lightsState.lights;for(let t=0,i=e.length;t<i;t++){const i=e[t];i.castsShadow&&F(i)}})(),function(e){const i=[],r=[],l=[],A=[],c=[],h=[],f=[],m=[],_=[],x=[],C=[],M=[],E=[],F=[],I=[],T=[],D=t._lightsState.getAmbientColorAndIntensity();if(s.reset(),s.pass=e.pass,s.withSAO=!1,s.pbrEnabled=w&&!!t.pbrEnabled,s.colorTextureEnabled=B&&!!t.colorTextureEnabled,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),n)o.clearColor(0,0,0,0);else{const e=t.canvas.backgroundColorFromAmbientLight?D:t.canvas.backgroundColor;o.clearColor(e[0],e[1],e[2],1)}o.enable(o.DEPTH_TEST),o.frontFace(o.CCW),o.enable(o.CULL_FACE),o.depthMask(!0),o.lineWidth(1),s.lineWidth=1;const S=t.sao.possible;if(y&&S){const e=P.getRenderBuffer("saoOcclusion");s.occlusionTexture=e?e.getTexture():null}else s.occlusionTexture=null;let R,U;const L=Date.now();!1!==e.clear&&o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);const k=function(e){let u=0,p=0,g=0,w=0,B=0,P=0,D=0,L=0,k=0,O=0,N=0,V=0,Q=0,H=0,j=0,G=0;for(let t=0,o=e.length;t<o;t++){if(U=e[t],!0===U.culled||!1===U.visible)continue;const o=U.renderFlags;o.colorOpaque&&(y&&S&&U.saoEnabled?i[u++]=U:U.drawColorOpaque(s)),v&&o.colorTransparent&&(l[g++]=U),o.xrayedSilhouetteTransparent&&(f[D++]=U),o.xrayedSilhouetteOpaque&&(c[B++]=U),o.highlightedSilhouetteTransparent&&(C[N++]=U),o.highlightedSilhouetteOpaque&&(_[k++]=U),o.selectedSilhouetteTransparent&&(I[j++]=U),o.selectedSilhouetteOpaque&&(E[Q++]=U),U.edges&&b&&(o.edgesOpaque&&(r[p++]=U),o.edgesTransparent&&(A[w++]=U),o.selectedEdgesTransparent&&(T[G++]=U),o.selectedEdgesOpaque&&(F[H++]=U),o.xrayedEdgesTransparent&&(m[L++]=U),o.xrayedEdgesOpaque&&(h[P++]=U),o.highlightedEdgesTransparent&&(M[V++]=U),o.highlightedEdgesOpaque&&(x[O++]=U))}if(u>0)for(s.withSAO=!0,R=0;R<u;R++)i[R].drawColorOpaque(s);if(p>0)for(R=0;R<p;R++)r[R].drawEdgesColorOpaque(s);if(B>0)for(R=0;R<B;R++)c[R].drawSilhouetteXRayed(s);if(P>0)for(R=0;R<P;R++)h[R].drawEdgesXRayed(s);if(D>0||L>0||g>0||w>0){if(o.enable(o.CULL_FACE),o.enable(o.BLEND),n?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):(o.blendEquation(o.FUNC_ADD),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA)),s.backfaces=!1,a||o.depthMask(!1),(g>0||w>0)&&o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),w>0)for(R=0;R<w;R++)U=A[R],U.drawEdgesColorTransparent(s);if(g>0){const e=s.pickOrigin||t.camera.eye,i=l.map((t=>({drawable:t,distSq:d.distVec3(t.origin||Sh,e)})));for(i.sort(((e,t)=>t.distSq-e.distSq)),R=0;R<g;R++)i[R].drawable.drawColorTransparent(s)}if(L>0)for(R=0;R<L;R++)m[R].drawEdgesXRayed(s);if(D>0)for(R=0;R<D;R++)f[R].drawSilhouetteXRayed(s);o.disable(o.BLEND),a||o.depthMask(!0)}if(k>0||O>0){if(s.lastProgramId=null,t.highlightMaterial.glowThrough&&o.clear(o.DEPTH_BUFFER_BIT),O>0)for(R=0;R<O;R++)x[R].drawEdgesHighlighted(s);if(k>0)for(R=0;R<k;R++)_[R].drawSilhouetteHighlighted(s)}if(N>0||V>0||k>0){if(s.lastProgramId=null,t.selectedMaterial.glowThrough&&o.clear(o.DEPTH_BUFFER_BIT),o.enable(o.BLEND),n?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),o.enable(o.CULL_FACE),V>0)for(R=0;R<V;R++)M[R].drawEdgesHighlighted(s);if(N>0)for(R=0;R<N;R++)C[R].drawSilhouetteHighlighted(s);o.disable(o.BLEND)}if(Q>0||H>0){if(s.lastProgramId=null,t.selectedMaterial.glowThrough&&o.clear(o.DEPTH_BUFFER_BIT),H>0)for(R=0;R<H;R++)F[R].drawEdgesSelected(s);if(Q>0)for(R=0;R<Q;R++)E[R].drawSilhouetteSelected(s)}if(j>0||G>0){if(s.lastProgramId=null,t.selectedMaterial.glowThrough&&o.clear(o.DEPTH_BUFFER_BIT),o.enable(o.CULL_FACE),o.enable(o.BLEND),n?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),G>0)for(R=0;R<G;R++)T[R].drawEdgesSelected(s);if(j>0)for(R=0;R<j;R++)I[R].drawSilhouetteSelected(s);o.disable(o.BLEND)}};k(u),p.length>0&&(o.clear(o.DEPTH_BUFFER_BIT),k(p));const O=Date.now(),N=g.frame;N.renderTime=(O-L)/1e3,N.drawElements=s.drawElements,N.drawArrays=s.drawArrays,N.useProgram=s.useProgram,N.bindTexture=s.bindTexture,N.bindArray=s.bindArray;const V=Mi.MAX_TEXTURE_IMAGE_UNITS;for(let e=0;e<V;e++)o.activeTexture(o.TEXTURE0+e);o.bindTexture(o.TEXTURE_CUBE_MAP,null),o.bindTexture(o.TEXTURE_2D,null);const Q=Mi.MAX_VERTEX_ATTRIBS;for(let e=0;e<Q;e++)o.disableVertexAttribArray(e)}(e)}(e),g.frame.frameCount++,_=!1)},this.pick=function(){const e=d.vec3();d.mat4();const i=d.mat4(),n=d.vec3(),a=d.vec3([0,1,0]),c=new uh,h=d.vec2(),f=d.vec3(),m=d.vec3(),g=d.vec3();return d.vec3(),d.vec3(),function(_,v=c){let b;v.reset(),E();let y=null,w=null,B=null;v.pickSurface=_.pickSurface,_.canvasPos?(f[0]=_.canvasPos[0],f[1]=_.canvasPos[1],y=t.camera.viewMatrix,w=t.camera.projMatrix,B=t.camera.projection,h[0]=t.camera.project.near,h[1]=t.camera.project.far,v.canvasPos=_.canvasPos):(_.matrix?(y=_.matrix,w=t.camera.projMatrix,B=t.camera.projection,h[0]=t.camera.project.near,h[1]=t.camera.project.far):(m.set(_.origin||[0,0,0]),g.set(_.direction||[0,0,1]),b=d.addVec3(m,g,e),n[0]=Math.random(),n[1]=Math.random(),n[2]=Math.random(),d.normalizeVec3(n),d.cross3Vec3(g,n,a),y=d.lookAtMat4v(m,b,a,i),w=t.camera.ortho.matrix,B="ortho",h[0]=t.camera.ortho.near,h[1]=t.camera.ortho.far,v.origin=m,v.direction=g),f[0]=.5*r.clientWidth,f[1]=.5*r.clientHeight);for(let e in A)if(A.hasOwnProperty(e)){const t=A[e].drawableList;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.setPickMatrices&&i.setPickMatrices(y,w)}}const x=P.getRenderBuffer("pick",{size:[1,1]});x.bind();const C=function(e,i,r,n,a,A){const c=t.canvas.resolutionScale;s.reset(),s.backfaces=!0,s.frontface=!0,s.pickOrigin=A.origin,s.pickViewMatrix=r,s.pickProjMatrix=n,s.pickInvisible=!!a.pickInvisible,s.pickClipPos=[D(i[0]*c,o.drawingBufferWidth),S(i[1]*c,o.drawingBufferHeight)],o.viewport(0,0,1,1),o.depthMask(!0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);const h=a.includeEntityIds,d=a.excludeEntityIds,f=function(e){for(let t=0,i=e.length;t<i;t++){const i=e[t];!0!==i.culled&&!1!==i.visible&&(!i.drawPickMesh||!0!==a.pickInvisible&&!1===i.visible||!1===i.pickable||h&&!h[i.id]||d&&d[i.id]||i.drawPickMesh(s))}};f(u),p.length>0&&(o.clear(o.DEPTH_BUFFER_BIT),f(p));const m=e.read(0,0),g=m[0]+(m[1]<<8)+(m[2]<<16)+(m[3]<<24);if(g<0)return;return l.items[g]}(x,f,y,w,_,v);if(!C)return x.unbind(),null;const M=C.delegatePickedEntity?C.delegatePickedEntity():C;return M?(_.pickSurface&&(C.canPickTriangle&&C.canPickTriangle()?(!function(e,i,r,n,a,l){if(!i.drawPickTriangles)return;const A=t.canvas.resolutionScale;s.reset(),s.backfaces=!0,s.frontface=!0,s.pickOrigin=l.origin,s.pickViewMatrix=n,s.pickProjMatrix=a,s.pickClipPos=[D(r[0]*A,o.drawingBufferWidth),S(r[1]*A,o.drawingBufferHeight)],o.viewport(0,0,1,1),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),i.drawPickTriangles(s);const c=e.read(0,0);let h=c[0]+256*c[1]+256*c[2]*256+256*c[3]*256*256;h*=3,l.primIndex=h}(x,C,f,y,w,v),C.pickTriangleSurface(y,w,B,v),v.pickSurfacePrecision=!1):C.canPickWorldPos&&C.canPickWorldPos()&&(I(x,C,f,y,w,h,v),!1!==_.pickSurfaceNormal&&function(e,i,r,n,a,l){const A=t.canvas.resolutionScale;s.reset(),s.backfaces=!0,s.frontface=!0,s.pickOrigin=l.origin,s.pickViewMatrix=n,s.pickProjMatrix=a,s.pickClipPos=[D(r[0]*A,o.drawingBufferWidth),S(r[1]*A,o.drawingBufferHeight)];const c=P.getRenderBuffer("pick-normal",{size:[3,3]});c.bind(o.RGBA32I),o.viewport(0,0,c.size[0],c.size[1]),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.DEPTH_BUFFER_BIT),o.clearBufferiv(o.COLOR,0,new Int32Array([0,0,0,0])),i.drawPickNormals(s);const h=c.read(1,1,o.RGBA_INTEGER,o.INT,Int32Array,4);c.unbind();const u=[h[0]/d.MAX_INT,h[1]/d.MAX_INT,h[2]/d.MAX_INT];d.normalizeVec3(u),l.worldNormal=u}(0,C,f,y,w,v),v.pickSurfacePrecision=!1)),x.unbind(),v.entity=M,v):(x.unbind(),null)}}();const I=function(){const e=d.vec4(),i=d.vec4(),n=d.vec4(),a=d.vec4(),l=d.vec4(),A=d.mat4(),c=d.mat4(),h=d.mat4();return function(u,p,f,m,g,_,v){const b=t.canvas.resolutionScale;s.reset(),s.backfaces=!0,s.frontface=!0,s.pickOrigin=v.origin,s.pickViewMatrix=m,s.pickProjMatrix=g,s.pickZNear=_[0],s.pickZFar=_[1],s.pickElementsCount=p.pickElementsCount,s.pickElementsOffset=p.pickElementsOffset,s.pickClipPos=[D(f[0]*b,o.drawingBufferWidth),S(f[1]*b,o.drawingBufferHeight)],o.viewport(0,0,1,1),o.clearColor(0,0,0,0),o.depthMask(!0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),p.drawPickDepths(s);const y=function(e){const t=[e[0]/256,e[1]/256,e[2]/256,e[3]/256],i=[1/16777216,1/65536,1/256,1];return d.dotVec4(t,i)}(u.read(0,0)),w=(f[0]-r.clientWidth/2)/(r.clientWidth/2),B=-(f[1]-r.clientHeight/2)/(r.clientHeight/2),P=p.origin;let x;if(P){const e=Ye(m,P,A);x=d.mulMat4(g,e,c)}else x=d.mulMat4(g,m,c);const C=d.inverseMat4(x,h);e[0]=w,e[1]=B,e[2]=-1,e[3]=1;let M=d.transformVec4(C,e);M=d.mulVec4Scalar(M,1/M[3]),i[0]=w,i[1]=B,i[2]=1,i[3]=1;let E=d.transformVec4(C,i);E=d.mulVec4Scalar(E,1/E[3]);const F=d.subVec3(E,M,n),I=d.addVec3(M,d.mulVec4Scalar(F,y,a),l);P&&d.addVec3(I,P),v.worldPos=I}}();function T(e){e.snapPickLayerParams=e.snapPickLayerParams||[],e.snapPickLayerNumber=e.snapPickLayerParams.length;for(let t=0,i=u.length;t<i;t++){const i=u[t];i.drawSnapInit&&i.drawSnap&&!i.culled&&i.visible&&i.pickable&&i.drawSnap(e)}return e.snapPickLayerParams}function D(e,t){return e/t*2-1}function S(e,t){return 1-e/t*2}this.snapPick=function(){const e=new uh;return function(i,r=e){const{canvasPos:n,origin:a,direction:c,snapRadius:h,snapToVertex:p,snapToEdge:f}=i;if(!p&&!f)return this.pick({canvasPos:n,pickSurface:!0});const m=t.canvas.resolutionScale;s.reset(),s.backfaces=!0,s.frontface=!0,s.pickZNear=t.camera.project.near,s.pickZFar=t.camera.project.far;const g=h||30,_=P.getRenderBuffer(`uniquePickColors-aabs-${g}`,{depthTexture:!0,size:[2*g+1,2*g+1]});s.snapVectorA=[n?D(n[0]*m,o.drawingBufferWidth):0,n?S(n[1]*m,o.drawingBufferHeight):0],s.snapInvVectorAB=[o.drawingBufferWidth/(2*g),o.drawingBufferHeight/(2*g)],_.bind(o.RGBA32I,o.RGBA32I,o.RGBA8UI),o.viewport(0,0,_.size[0],_.size[1]),o.enable(o.DEPTH_TEST),o.frontFace(o.CCW),o.disable(o.CULL_FACE),o.depthMask(!0),o.disable(o.BLEND),o.depthFunc(o.LEQUAL),o.clear(o.DEPTH_BUFFER_BIT),o.clearBufferiv(o.COLOR,0,new Int32Array([0,0,0,0])),o.clearBufferiv(o.COLOR,1,new Int32Array([0,0,0,0])),o.clearBufferuiv(o.COLOR,2,new Uint32Array([0,0,0,0])),s.pickViewMatrix=n?t.camera.viewMatrix:d.lookAtMat4v(a,d.addVec3(a,c,d.vec3()),d.vec3([0,1,0]),d.mat4());const v=t.camera.projMatrix;for(let e in A)if(A.hasOwnProperty(e)){const t=A[e].drawableList;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.setPickMatrices&&i.setPickMatrices(s.pickViewMatrix,v)}}o.drawBuffers([o.COLOR_ATTACHMENT0,o.COLOR_ATTACHMENT1,o.COLOR_ATTACHMENT2]);const b=function(e){e.snapPickLayerParams=[],e.snapPickLayerNumber=0;for(let t=0,i=u.length;t<i;t++){const i=u[t];i.drawSnapInit&&!i.culled&&i.visible&&i.pickable&&i.drawSnapInit(e)}return e.snapPickLayerParams}(s),y=[];s.snapPickLayerParams=y,o.depthMask(!1),o.drawBuffers([o.COLOR_ATTACHMENT0]),p&&f?(s.snapMode="edge",T(s),s.snapMode="vertex",s.snapPickLayerNumber++,T(s)):(s.snapMode=p?"vertex":"edge",T(s)),o.depthMask(!0);const w=_.readArray(o.RGBA_INTEGER,o.INT,Int32Array,4),B=_.readArray(o.RGBA_INTEGER,o.INT,Int32Array,4,1),x=_.readArray(o.RGBA_INTEGER,o.UNSIGNED_INT,Uint32Array,4,2);_.unbind();let C=null,M=null,E=null;const F=4*g+g*_.size[0]*4,I=w.slice(F,F+4),R=B.slice(F,F+4),U=x.slice(F,F+4);if(0!==I[3]){const e=b[Math.abs(I[3])%b.length],t=e.origin,i=e.coordinateScale;C=[I[0]*i[0]+t[0],I[1]*i[1]+t[1],I[2]*i[2]+t[2]],M=d.normalizeVec3([R[0]/d.MAX_INT,R[1]/d.MAX_INT,R[2]/d.MAX_INT]);const s=U[0]+(U[1]<<8)+(U[2]<<16)+(U[3]<<24);E=l.items[s]}let L=[];for(let e=0;e<w.length;e+=4)if(w[e+3]>0){const t=Math.floor(e/4),i=_.size[0],s=t%i-Math.floor(i/2),r=Math.floor(t/i)-Math.floor(i/2),o=Math.sqrt(Math.pow(s,2)+Math.pow(r,2));L.push({x:s,y:r,dist:o,isVertex:p&&f?w[e+3]>y.length/2:p,result:[w[e+0],w[e+1],w[e+2],w[e+3]],normal:[B[e+0],B[e+1],B[e+2],B[e+3]],id:[x[e+0],x[e+1],x[e+2],x[e+3]]})}let k=null,O=null,N=null,V=null;if(L.length>0){L.sort(((e,t)=>e.isVertex!==t.isVertex?e.isVertex?-1:1:e.dist-t.dist)),V=L[0].isVertex?"vertex":"edge";const e=L[0].result,t=L[0].normal,i=L[0].id,s=y[e[3]],r=s.origin,o=s.coordinateScale;O=d.normalizeVec3([t[0]/d.MAX_INT,t[1]/d.MAX_INT,t[2]/d.MAX_INT]),k=[e[0]*o[0]+r[0],e[1]*o[1]+r[1],e[2]*o[2]+r[2]],N=l.items[i[0]+(i[1]<<8)+(i[2]<<16)+(i[3]<<24)]}if(null===C&&null==k)return null;let Q=null;null!==k&&(Q=t.camera.projectWorldPos(k));const H=N&&N.delegatePickedEntity?N.delegatePickedEntity():N;return!H&&E&&(E=E.delegatePickedEntity?E.delegatePickedEntity():E),r.reset(),r.snappedToEdge="edge"===V,r.snappedToVertex="vertex"===V,r.worldPos=k||C,r.worldNormal=O||M,r.entity=H||E,r.canvasPos=n||t.camera.projectWorldPos(C||k),r.snappedCanvasPos=Q||n,r}}(),this.addMarker=function(e){this._occlusionTester=this._occlusionTester||new wh(t,P),this._occlusionTester.addMarker(e),t.occlusionTestCountdown=0},this.markerWorldPosUpdated=function(e){this._occlusionTester.markerWorldPosUpdated(e)},this.removeMarker=function(e){this._occlusionTester.removeMarker(e)},this.doOcclusionTest=function(){if(this._occlusionTester&&this._occlusionTester.needOcclusionTest){E(),this._occlusionTester.bindRenderBuf(),s.reset(),s.backfaces=!0,s.frontface=!0,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(let e=0,t=u.length;e<t;e++){const t=u[e];t.drawOcclusion&&!0!==t.culled&&!1!==t.visible&&!1!==t.pickable&&t.drawOcclusion(s)}this._occlusionTester.drawMarkers(s),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(e,t,i,s){const r=P.getRenderBuffer("snapshot");let o,n,a,l;for(r.bind(),r.clear(),this.render({force:!0,opaqueOnly:s}),n=0;n<i;n++)a=2*n,l=4*n,o=r.read(e[a],e[a+1]),t[l]=o[0],t[l+1]=o[1],t[l+2]=o[2],t[l+3]=o[3];r.unbind(),_=!0},this.beginSnapshot=function(e={}){const t=P.getRenderBuffer("snapshot");e.width&&e.height&&t.setSize([e.width,e.height]),t.bind(),t.clear(),x=!0},this.renderSnapshot=function(){if(!x)return;P.getRenderBuffer("snapshot").clear(),this.render({force:!0,opaqueOnly:!1}),_=!0},this.readSnapshot=function(e){return P.getRenderBuffer("snapshot").readImage(e)},this.readSnapshotAsCanvas=function(){return P.getRenderBuffer("snapshot").readImageAsCanvas()},this.endSnapshot=function(){if(!x)return;P.getRenderBuffer("snapshot").unbind(),x=!1},this.destroy=function(){A={},c={},P.destroy(),C.destroy(),M.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}};class Uh extends R{constructor(e,t={}){super(e,t),this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.MOUSE_LEFT_BUTTON=260,this.MOUSE_MIDDLE_BUTTON=261,this.MOUSE_RIGHT_BUTTON=262,this.element=t.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.keyboardEnabled=!0,this.mouseover=!1,this.mouseCanvasPos=d.vec2(),this._keyboardEventsElement=t.keyboardEventsElement||document,this._bindEvents()}_bindEvents(){if(this._eventsBound)return;this._keyboardEventsElement.addEventListener("keydown",this._keyDownListener=e=>{this.enabled&&this.keyboardEnabled&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.keyCode===this.KEY_CTRL?this.ctrlDown=!0:e.keyCode===this.KEY_ALT?this.altDown=!0:e.keyCode===this.KEY_SHIFT&&(this.shiftDown=!0),this.keyDown[e.keyCode]=!0,this.fire("keydown",e.keyCode,!0))},!1),this._keyboardEventsElement.addEventListener("keyup",this._keyUpListener=e=>{this.enabled&&this.keyboardEnabled&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&(e.keyCode===this.KEY_CTRL?this.ctrlDown=!1:e.keyCode===this.KEY_ALT?this.altDown=!1:e.keyCode===this.KEY_SHIFT&&(this.shiftDown=!1),this.keyDown[e.keyCode]=!1,this.fire("keyup",e.keyCode,!0))}),this.element.addEventListener("mouseenter",this._mouseEnterListener=e=>{this.enabled&&(this.mouseover=!0,this._getMouseCanvasPos(e),this.fire("mouseenter",this.mouseCanvasPos,!0))}),this.element.addEventListener("mouseleave",this._mouseLeaveListener=e=>{this.enabled&&(this.mouseover=!1,this._getMouseCanvasPos(e),this.fire("mouseleave",this.mouseCanvasPos,!0))}),this.element.addEventListener("mousedown",this._mouseDownListener=e=>{if(this.enabled){switch(e.which){case 1:this.mouseDownLeft=!0;break;case 2:this.mouseDownMiddle=!0;break;case 3:this.mouseDownRight=!0}this._getMouseCanvasPos(e),this.element.focus(),this.fire("mousedown",this.mouseCanvasPos,!0),this.mouseover&&e.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=e=>{if(this.enabled){switch(e.which){case 1:this.mouseDownLeft=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownRight=!1}this.fire("mouseup",this.mouseCanvasPos,!0)}},!0),document.addEventListener("click",this._clickListener=e=>{if(this.enabled){switch(e.which){case 1:case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1}this._getMouseCanvasPos(e),this.fire("click",this.mouseCanvasPos,!0),this.mouseover&&e.preventDefault()}}),document.addEventListener("dblclick",this._dblClickListener=e=>{if(this.enabled){switch(e.which){case 1:case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1}this._getMouseCanvasPos(e),this.fire("dblclick",this.mouseCanvasPos,!0),this.mouseover&&e.preventDefault()}});const e=this.scene.tickify((()=>this.fire("mousemove",this.mouseCanvasPos,!0)));this.element.addEventListener("mousemove",this._mouseMoveListener=t=>{this.enabled&&(this._getMouseCanvasPos(t),e(),this.mouseover&&t.preventDefault())}),this.element.addEventListener("contextmenu",this._contextmenuListener=e=>{this.enabled&&(this._getMouseCanvasPos(e),this.fire("contextmenu",this.mouseCanvasPos,!0))});const t=this.scene.tickify((e=>{this.fire("mousewheel",e,!0)}));this.element.addEventListener("wheel",this._mouseWheelListener=(e,i)=>{if(!this.enabled)return;const s=Math.max(-1,Math.min(1,40*-e.deltaY));t(s)},{passive:!0});{let e,t;const i=2;this.on("mousedown",(i=>{e=i[0],t=i[1]})),this.on("mouseup",(s=>{e>=s[0]-i&&e<=s[0]+i&&t>=s[1]-i&&t<=s[1]+i&&this.fire("mouseclicked",s,!0)}))}this.element.addEventListener("touchstart",this._touchstartListener=e=>{this.enabled&&[...e.changedTouches].forEach((e=>{this.fire("touchstart",[e.identifier,this._getTouchCanvasPos(e)],!0)}))}),this.element.addEventListener("touchend",this._touchendListener=e=>{this.enabled&&[...e.changedTouches].forEach((e=>{this.fire("touchend",[e.identifier,this._getTouchCanvasPos(e)],!0)}))}),this._eventsBound=!0}_unbindEvents(){this._eventsBound&&(this._keyboardEventsElement.removeEventListener("keydown",this._keyDownListener),this._keyboardEventsElement.removeEventListener("keyup",this._keyUpListener),this.element.removeEventListener("mouseenter",this._mouseEnterListener),this.element.removeEventListener("mouseleave",this._mouseLeaveListener),this.element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("click",this._clickListener),document.removeEventListener("dblclick",this._dblClickListener),this.element.removeEventListener("mousemove",this._mouseMoveListener),this.element.removeEventListener("contextmenu",this._contextmenuListener),this.element.removeEventListener("wheel",this._mouseWheelListener),this.element.removeEventListener("touchstart",this._touchstartListener),this.element.removeEventListener("touchend",this._touchendListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener),this._eventsBound=!1)}_getTouchCanvasPos(e){let t=e.target,i=0,s=0;for(;t.offsetParent;)i+=t.offsetLeft,s+=t.offsetTop,t=t.offsetParent;return[e.pageX-i,e.pageY-s]}_getMouseCanvasPos(e){if(e){const t=e.target.getBoundingClientRect();this.mouseCanvasPos[0]=e.clientX-t.left,this.mouseCanvasPos[1]=e.clientY-t.top}else e=window.event,this.mouseCanvasPos[0]=e.x,this.mouseCanvasPos[1]=e.y}setEnabled(e){this.enabled!==e&&this.fire("enabled",this.enabled=e)}getEnabled(){return this.enabled}setKeyboardEnabled(e){this.keyboardEnabled=e}getKeyboardEnabled(){return this.keyboardEnabled}destroy(){super.destroy(),this._unbindEvents()}}class Lh extends R{get type(){return"Viewport"}constructor(e,t={}){super(e,t),this._state=new ae({boundary:[0,0,100,100]}),this.boundary=t.boundary,this.autoBoundary=t.autoBoundary}set boundary(e){if(!this._autoBoundary){if(!e){const t=this.scene.canvas.boundary;e=[0,0,t[2],t[3]]}this._state.boundary=e,this.glRedraw(),this.fire("boundary",this._state.boundary)}}get boundary(){return this._state.boundary}set autoBoundary(e){(e=!!e)!==this._autoBoundary&&(this._autoBoundary=e,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",(function(e){const t=e[2],i=e[3];this._state.boundary=[0,0,t,i],this.glRedraw(),this.fire("boundary",this._state.boundary)}),this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}get autoBoundary(){return this._autoBoundary}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}class kh extends R{get type(){return"Perspective"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new ae({matrix:d.mat4(),inverseMatrix:d.mat4(),transposedMatrix:d.mat4(),near:.1,far:1e4}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this._fov=60,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=t.fov,this.fovAxis=t.fovAxis,this.near=t.near,this.far=t.far}_update(){const e=this.scene.canvas.boundary,t=e[2]/e[3],i=this._fovAxis;let s=this._fov;("x"===i||"min"===i&&t<1||"max"===i&&t>1)&&(s/=t),s=Math.min(s,120),d.perspectiveMat4(s*(Math.PI/180),t,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.camera._updateScheduled=!0,this.fire("matrix",this._state.matrix)}set fov(e){(e=null!=e?e:60)!==this._fov&&(this._fov=e,this._needUpdate(0),this.fire("fov",this._fov))}get fov(){return this._fov}set fovAxis(e){e=e||"min",this._fovAxis!==e&&("x"!==e&&"y"!==e&&"min"!==e&&(this.error("Unsupported value for 'fovAxis': "+e+" - defaulting to 'min'"),e="min"),this._fovAxis=e,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}get fovAxis(){return this._fovAxis}set near(e){const t=null!=e?e:.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(e){const t=null!=e?e:1e4;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(d.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(d.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,r){const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return i[0]=(e[0]-n)/n,i[1]=(e[1]-a)/a,i[2]=t,i[3]=1,d.mulMat4v4(this.inverseMatrix,i,s),d.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,d.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._canvasResized)}}class Oh extends R{get type(){return"Ortho"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new ae({matrix:d.mat4(),inverseMatrix:d.mat4(),transposedMatrix:d.mat4(),near:.1,far:1e4}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.scale=t.scale,this.near=t.near,this.far=t.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)}_update(){const e=this.scene,t=.5*this._scale,i=e.canvas.boundary,s=i[2],r=i[3],o=s/r;let n,a,l,A;s>r?(n=-t,a=t,l=t/o,A=-t/o):(n=-t*o,a=t*o,l=t,A=-t),d.orthoMat4c(n,a,A,l,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set scale(e){null==e&&(e=1),e<=0&&(e=.01),this._scale=e,this._needUpdate(0),this.fire("scale",this._scale)}get scale(){return this._scale}set near(e){const t=null!=e?e:.1;this._state.near!==t&&(this._state.near=t,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(e){const t=null!=e?e:1e4;this._state.far!==t&&(this._state.far=t,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(d.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(d.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,r){const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return i[0]=(e[0]-n)/n,i[1]=(e[1]-a)/a,i[2]=t,i[3]=1,d.mulMat4v4(this.inverseMatrix,i,s),d.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,d.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}class Nh extends R{get type(){return"Frustum"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new ae({matrix:d.mat4(),inverseMatrix:d.mat4(),transposedMatrix:d.mat4(),near:.1,far:1e4}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.left=t.left,this.right=t.right,this.bottom=t.bottom,this.top=t.top,this.near=t.near,this.far=t.far}_update(){d.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set left(e){this._left=null!=e?e:-1,this._needUpdate(0),this.fire("left",this._left)}get left(){return this._left}set right(e){this._right=null!=e?e:1,this._needUpdate(0),this.fire("right",this._right)}get right(){return this._right}set top(e){this._top=null!=e?e:1,this._needUpdate(0),this.fire("top",this._top)}get top(){return this._top}set bottom(e){this._bottom=null!=e?e:-1,this._needUpdate(0),this.fire("bottom",this._bottom)}get bottom(){return this._bottom}set near(e){this._state.near=null!=e?e:.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(e){this._state.far=null!=e?e:1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(d.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(d.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,r){const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return i[0]=(e[0]-n)/n,i[1]=(e[1]-a)/a,i[2]=t,i[3]=1,d.mulMat4v4(this.inverseMatrix,i,s),d.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,d.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),super.destroy()}}class Vh extends R{get type(){return"CustomProjection"}constructor(e,t={}){super(e,t),this.camera=e,this._state=new ae({matrix:d.mat4(),inverseMatrix:d.mat4(),transposedMatrix:d.mat4()}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!1,this.matrix=t.matrix}set matrix(e){this._state.matrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}get matrix(){return this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(d.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(d.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(e,t,i,s,r){const o=this.scene.canvas.canvas,n=o.offsetWidth/2,a=o.offsetHeight/2;return i[0]=(e[0]-n)/n,i[1]=(e[1]-a)/a,i[2]=t,i[3]=1,d.mulMat4v4(this.inverseMatrix,i,s),d.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,d.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy()}}const Qh=d.vec3(),Hh=d.vec3(),jh=d.vec3(),Gh=d.vec3(),zh=d.vec3(),Wh=d.vec3(),Xh=d.vec4(),Kh=d.vec4(),Zh=d.vec4(),Jh=d.mat4(),Yh=d.mat4(),qh=d.vec3(),$h=d.vec3(),eu=d.vec3(),tu=d.vec3();class iu extends R{get type(){return"Camera"}constructor(e,t={}){super(e,t),this._state=new ae({offsetEyeFromLook:!0,deviceMatrix:d.mat4(),hasDeviceMatrix:!1,matrix:d.mat4(),normalMatrix:d.mat4(),inverseMatrix:d.mat4()}),this._perspective=new kh(this),this._ortho=new Oh(this),this._frustum=new Nh(this),this._customProjection=new Vh(this),this._project=this._perspective,this._eye=d.vec3([0,0,10]),this._look=d.vec3([0,0,0]),this._up=d.vec3([0,1,0]),this._worldUp=d.vec3([0,1,0]),this._worldRight=d.vec3([1,0,0]),this._worldForward=d.vec3([0,0,-1]),this.deviceMatrix=t.deviceMatrix,this.eye=t.eye,this.look=t.look,this.up=t.up,this.worldAxis=t.worldAxis,this.gimbalLock=t.gimbalLock,this.constrainPitch=t.constrainPitch,this.projection=t.projection,this._perspective.on("matrix",(()=>{"perspective"===this._projectionType&&this.fire("projMatrix",this._perspective.matrix)})),this._ortho.on("matrix",(()=>{"ortho"===this._projectionType&&this.fire("projMatrix",this._ortho.matrix)})),this._frustum.on("matrix",(()=>{"frustum"===this._projectionType&&this.fire("projMatrix",this._frustum.matrix)})),this._customProjection.on("matrix",(()=>{"customProjection"===this._projectionType&&this.fire("projMatrix",this._customProjection.matrix)}))}_update(){const e=this._state;let t;"ortho"===this.projection&&this._state.offsetEyeFromLook?(d.subVec3(this._eye,this._look,qh),d.normalizeVec3(qh,$h),d.mulVec3Scalar($h,1e3,eu),d.addVec3(this._look,eu,tu),t=tu):t=this._eye,e.hasDeviceMatrix?(d.lookAtMat4v(t,this._look,this._up,Yh),d.mulMat4(e.deviceMatrix,Yh,e.matrix)):d.lookAtMat4v(t,this._look,this._up,e.matrix),d.inverseMat4(this._state.matrix,this._state.inverseMatrix),d.transposeMat4(this._state.inverseMatrix,this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}orbitYaw(e){let t=d.subVec3(this._eye,this._look,Qh);d.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,Jh),t=d.transformPoint3(Jh,t,Hh),this.eye=d.addVec3(this._look,t,jh),this.up=d.transformPoint3(Jh,this._up,Gh)}orbitPitch(e){if(this._constrainPitch&&(e=d.dotVec3(this._up,this._worldUp)/d.DEGTORAD)<1)return;let t=d.subVec3(this._eye,this._look,Qh);const i=d.cross3Vec3(d.normalizeVec3(t,Hh),d.normalizeVec3(this._up,jh));d.rotationMat4v(.0174532925*e,i,Jh),t=d.transformPoint3(Jh,t,Gh),this.up=d.transformPoint3(Jh,this._up,zh),this.eye=d.addVec3(t,this._look,Wh)}yaw(e){let t=d.subVec3(this._look,this._eye,Qh);d.rotationMat4v(.0174532925*e,this._gimbalLock?this._worldUp:this._up,Jh),t=d.transformPoint3(Jh,t,Hh),this.look=d.addVec3(t,this._eye,jh),this._gimbalLock&&(this.up=d.transformPoint3(Jh,this._up,Gh))}pitch(e){if(this._constrainPitch&&(e=d.dotVec3(this._up,this._worldUp)/d.DEGTORAD)<1)return;let t=d.subVec3(this._look,this._eye,Qh);const i=d.cross3Vec3(d.normalizeVec3(t,Hh),d.normalizeVec3(this._up,jh));d.rotationMat4v(.0174532925*e,i,Jh),this.up=d.transformPoint3(Jh,this._up,Wh),t=d.transformPoint3(Jh,t,Gh),this.look=d.addVec3(t,this._eye,zh)}pan(e){const t=d.subVec3(this._eye,this._look,Qh),i=[0,0,0];let s;if(0!==e[0]){const r=d.cross3Vec3(d.normalizeVec3(t,[]),d.normalizeVec3(this._up,Hh));s=d.mulVec3Scalar(r,e[0]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]}0!==e[1]&&(s=d.mulVec3Scalar(d.normalizeVec3(this._up,jh),e[1]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),0!==e[2]&&(s=d.mulVec3Scalar(d.normalizeVec3(t,Gh),e[2]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),this.eye=d.addVec3(this._eye,i,zh),this.look=d.addVec3(this._look,i,Wh)}zoom(e){const t=d.subVec3(this._eye,this._look,Qh),i=Math.abs(d.lenVec3(t,Hh)),s=Math.abs(i+e);if(s<.5)return;const r=d.normalizeVec3(t,jh);this.eye=d.addVec3(this._look,d.mulVec3Scalar(r,s),Gh)}set eye(e){this._eye.set(e||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}get eye(){return this._eye}set look(e){this._look.set(e||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}get look(){return this._look}set up(e){this._up.set(e||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}get up(){return this._up}set deviceMatrix(e){this._state.deviceMatrix.set(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!e,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}get deviceMatrix(){return this._state.deviceMatrix}set worldAxis(e){e=e||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(e):this._worldAxis=d.vec3(e),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}get worldAxis(){return this._worldAxis}get worldUp(){return this._worldUp}get xUp(){return this._worldUp[0]>this._worldUp[1]&&this._worldUp[0]>this._worldUp[2]}get yUp(){return this._worldUp[1]>this._worldUp[0]&&this._worldUp[1]>this._worldUp[2]}get zUp(){return this._worldUp[2]>this._worldUp[0]&&this._worldUp[2]>this._worldUp[1]}get worldRight(){return this._worldRight}get worldForward(){return this._worldForward}set gimbalLock(e){this._gimbalLock=!1!==e,this.fire("gimbalLock",this._gimbalLock)}get gimbalLock(){return this._gimbalLock}set constrainPitch(e){this._constrainPitch=!!e,this.fire("constrainPitch",this._constrainPitch)}get eyeLookDist(){return d.lenVec3(d.subVec3(this._look,this._eye,Qh))}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get viewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get normalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get viewNormalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get inverseViewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.inverseMatrix}get projMatrix(){return this[this.projection].matrix}get perspective(){return this._perspective}get ortho(){return this._ortho}get frustum(){return this._frustum}get customProjection(){return this._customProjection}set projection(e){e=e||"perspective",this._projectionType!==e&&("perspective"===e?this._project=this._perspective:"ortho"===e?this._project=this._ortho:"frustum"===e?this._project=this._frustum:"customProjection"===e?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+e+" defaulting to 'perspective'"),this._project=this._perspective,e="perspective"),this._project._update(),this._projectionType=e,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType),this.fire("projMatrix",this._project.matrix))}get projection(){return this._projectionType}get project(){return this._project}get offsetEyeFromLook(){return this._state.offsetEyeFromLook}set offsetEyeFromLook(e){this._state.offsetEyeFromLook=e,this._needUpdate(0)}projectWorldPos(e){const t=Xh,i=Kh,s=Zh;t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=1,d.mulMat4v4(this.viewMatrix,t,i),d.mulMat4v4(this.projMatrix,i,s),d.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1;const r=this.scene.canvas.canvas,o=r.offsetWidth/2,n=r.offsetHeight/2;return[s[0]*o+o,s[1]*n+n]}destroy(){super.destroy(),this._state.destroy()}}const su={meters:{abbrev:"m"},metres:{abbrev:"m"},centimeters:{abbrev:"cm"},centimetres:{abbrev:"cm"},millimeters:{abbrev:"mm"},millimetres:{abbrev:"mm"},yards:{abbrev:"yd"},feet:{abbrev:"ft"},inches:{abbrev:"in"}};class ru extends R{constructor(e,t={}){super(e,t),this._units="meters",this._scale=1,this._origin=d.vec3([0,0,0]),this.units=t.units,this.scale=t.scale,this.origin=t.origin}get unitsInfo(){return su}set units(e){e||(e="meters");su[e]||(this.error("Unsupported value for 'units': "+e+" defaulting to 'meters'"),e="meters"),this._units=e,this.fire("units",this._units)}get units(){return this._units}set scale(e){(e=e||1)<=0?this.error("scale value should be larger than zero"):(this._scale=e,this.fire("scale",this._scale))}get scale(){return this._scale}set origin(e){if(!e)return this._origin[0]=0,this._origin[1]=0,void(this._origin[2]=0);this._origin[0]=e[0],this._origin[1]=e[1],this._origin[2]=e[2],this.fire("origin",this._origin)}get origin(){return this._origin}worldToRealPos(e,t=d.vec3(3)){t[0]=this._origin[0]+this._scale*e[0],t[1]=this._origin[1]+this._scale*e[1],t[2]=this._origin[2]+this._scale*e[2]}realToWorldPos(e,t=d.vec3(3)){return t[0]=(e[0]-this._origin[0])/this._scale,t[1]=(e[1]-this._origin[1])/this._scale,t[2]=(e[2]-this._origin[2])/this._scale,t}}class ou extends R{constructor(e,t={}){super(e,t),this._supported=Mi.SUPPORTED_EXTENSIONS.OES_standard_derivatives,this.enabled=t.enabled,this.kernelRadius=t.kernelRadius,this.intensity=t.intensity,this.bias=t.bias,this.scale=t.scale,this.minResolution=t.minResolution,this.numSamples=t.numSamples,this.blur=t.blur,this.blendCutoff=t.blendCutoff,this.blendFactor=t.blendFactor}get supported(){return this._supported}set enabled(e){e=!!e,this._enabled!==e&&(this._enabled=e,this.glRedraw())}get enabled(){return this._enabled}get possible(){if(!this._supported)return!1;if(!this._enabled)return!1;const e=this.scene.camera.projection;return"customProjection"!==e&&"frustum"!==e}get active(){return this._active}set kernelRadius(e){null==e&&(e=100),this._kernelRadius!==e&&(this._kernelRadius=e,this.glRedraw())}get kernelRadius(){return this._kernelRadius}set intensity(e){null==e&&(e=.15),this._intensity!==e&&(this._intensity=e,this.glRedraw())}get intensity(){return this._intensity}set bias(e){null==e&&(e=.5),this._bias!==e&&(this._bias=e,this.glRedraw())}get bias(){return this._bias}set scale(e){null==e&&(e=1),this._scale!==e&&(this._scale=e,this.glRedraw())}get scale(){return this._scale}set minResolution(e){null==e&&(e=0),this._minResolution!==e&&(this._minResolution=e,this.glRedraw())}get minResolution(){return this._minResolution}set numSamples(e){null==e&&(e=10),this._numSamples!==e&&(this._numSamples=e,this.glRedraw())}get numSamples(){return this._numSamples}set blur(e){e=!1!==e,this._blur!==e&&(this._blur=e,this.glRedraw())}get blur(){return this._blur}set blendCutoff(e){null==e&&(e=.3),this._blendCutoff!==e&&(this._blendCutoff=e,this.glRedraw())}get blendCutoff(){return this._blendCutoff}set blendFactor(e){null==e&&(e=1),this._blendFactor!==e&&(this._blendFactor=e,this.glRedraw())}get blendFactor(){return this._blendFactor}destroy(){super.destroy()}}class nu extends R{constructor(e,t={}){super(e,t),this.sliceColor=t.sliceColor,this.sliceThickness=t.sliceThickness}set sliceThickness(e){null==e&&(e=0),this._sliceThickness!==e&&(this._sliceThickness=e,this.glRedraw())}get sliceThickness(){return this._sliceThickness}set sliceColor(e){null==e&&(e=[0,0,0,1]),this._sliceColor!==e&&(this._sliceColor=e,this.glRedraw())}get sliceColor(){return this._sliceColor}destroy(){super.destroy()}}const au={default:{pointSize:4,roundPoints:!0,perspectivePoints:!0},square:{pointSize:4,roundPoints:!1,perspectivePoints:!0},round:{pointSize:4,roundPoints:!0,perspectivePoints:!0}};class lu extends gs{get type(){return"PointsMaterial"}get presets(){return au}constructor(e,t={}){super(e,t),this._state=new ae({type:"PointsMaterial",pointSize:null,roundPoints:null,perspectivePoints:null,minPerspectivePointSize:null,maxPerspectivePointSize:null,filterIntensity:null,minIntensity:null,maxIntensity:null}),t.preset?(this.preset=t.preset,void 0!==t.pointSize&&(this.pointSize=t.pointSize),void 0!==t.roundPoints&&(this.roundPoints=t.roundPoints),void 0!==t.perspectivePoints&&(this.perspectivePoints=t.perspectivePoints),void 0!==t.minPerspectivePointSize&&(this.minPerspectivePointSize=t.minPerspectivePointSize),void 0!==t.maxPerspectivePointSize&&(this.maxPerspectivePointSize=t.minPerspectivePointSize)):(this._preset="default",this.pointSize=t.pointSize,this.roundPoints=t.roundPoints,this.perspectivePoints=t.perspectivePoints,this.minPerspectivePointSize=t.minPerspectivePointSize,this.maxPerspectivePointSize=t.maxPerspectivePointSize),this.filterIntensity=t.filterIntensity,this.minIntensity=t.minIntensity,this.maxIntensity=t.maxIntensity}set pointSize(e){this._state.pointSize=e||2,this.glRedraw()}get pointSize(){return this._state.pointSize}set roundPoints(e){e=!1!==e,this._state.roundPoints!==e&&(this._state.roundPoints=e,this.scene._needRecompile=!0,this.glRedraw())}get roundPoints(){return this._state.roundPoints}set perspectivePoints(e){e=!1!==e,this._state.perspectivePoints!==e&&(this._state.perspectivePoints=e,this.scene._needRecompile=!0,this.glRedraw())}get perspectivePoints(){return this._state.perspectivePoints}set minPerspectivePointSize(e){this._state.minPerspectivePointSize=e||1,this.scene._needRecompile=!0,this.glRedraw()}get minPerspectivePointSize(){return this._state.minPerspectivePointSize}set maxPerspectivePointSize(e){this._state.maxPerspectivePointSize=e||6,this.scene._needRecompile=!0,this.glRedraw()}get maxPerspectivePointSize(){return this._state.maxPerspectivePointSize}set filterIntensity(e){e=!1!==e,this._state.filterIntensity!==e&&(this._state.filterIntensity=e,this.scene._needRecompile=!0,this.glRedraw())}get filterIntensity(){return this._state.filterIntensity}set minIntensity(e){this._state.minIntensity=null!=e?e:0,this.glRedraw()}get minIntensity(){return this._state.minIntensity}set maxIntensity(e){this._state.maxIntensity=null!=e?e:1,this.glRedraw()}get maxIntensity(){return this._state.maxIntensity}set preset(e){if(e=e||"default",this._preset===e)return;const t=au[e];t?(this.pointSize=t.pointSize,this.roundPoints=t.roundPoints,this.perspectivePoints=t.perspectivePoints,this.minPerspectivePointSize=t.minPerspectivePointSize,this.maxPerspectivePointSize=t.maxPerspectivePointSize,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(au).join(", "))}get preset(){return this._preset}get hash(){return[this.pointSize,this.roundPoints,this.perspectivePoints,this.minPerspectivePointSize,this.maxPerspectivePointSize,this.filterIntensity].join(";")}destroy(){super.destroy(),this._state.destroy()}}const Au={default:{lineWidth:1},thick:{lineWidth:2},thicker:{lineWidth:4}};class cu extends gs{get type(){return"LinesMaterial"}get presets(){return Au}constructor(e,t={}){super(e,t),this._state=new ae({type:"LinesMaterial",lineWidth:null}),t.preset?(this.preset=t.preset,void 0!==t.lineWidth&&(this.lineWidth=t.lineWidth)):(this._preset="default",this.lineWidth=t.lineWidth)}set lineWidth(e){this._state.lineWidth=e||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set preset(e){if(e=e||"default",this._preset===e)return;const t=Au[e];t?(this.lineWidth=t.lineWidth,this._preset=e):this.error("unsupported preset: '"+e+"' - supported values are "+Object.keys(Au).join(", "))}get preset(){return this._preset}get hash(){return[""+this.lineWidth].join(";")}destroy(){super.destroy(),this._state.destroy()}}function hu(e,t,i=2){const s=t&&t.length,r=s?t[0]*i:e.length;let o=uu(e,0,r,i,!0);const n=[];if(!o||o.next===o.prev)return n;let a,l,A;if(s&&(o=function(e,t,i,s){const r=[];for(let i=0,o=t.length;i<o;i++){const n=uu(e,t[i]*s,i<o-1?t[i+1]*s:e.length,s,!1);n===n.next&&(n.steiner=!0),r.push(Bu(n))}r.sort(vu);for(let e=0;e<r.length;e++)i=bu(r[e],i);return i}(e,t,o,i)),e.length>80*i){a=1/0,l=1/0;let t=-1/0,s=-1/0;for(let o=i;o<r;o+=i){const i=e[o],r=e[o+1];i<a&&(a=i),r<l&&(l=r),i>t&&(t=i),r>s&&(s=r)}A=Math.max(t-a,s-l),A=0!==A?32767/A:0}return pu(o,n,i,a,l,A,0),n}function uu(e,t,i,s,r){let o;if(r===function(e,t,i,s){let r=0;for(let o=t,n=i-s;o<i;o+=s)r+=(e[n]-e[o])*(e[o+1]+e[n+1]),n=o;return r}(e,t,i,s)>0)for(let r=t;r<i;r+=s)o=Ru(r/s|0,e[r],e[r+1],o);else for(let r=i-s;r>=t;r-=s)o=Ru(r/s|0,e[r],e[r+1],o);return o&&Eu(o,o.next)&&(Uu(o),o=o.next),o}function du(e,t){if(!e)return e;t||(t=e);let i,s=e;do{if(i=!1,s.steiner||!Eu(s,s.next)&&0!==Mu(s.prev,s,s.next))s=s.next;else{if(Uu(s),s=t=s.prev,s===s.next)break;i=!0}}while(i||s!==t);return t}function pu(e,t,i,s,r,o,n){if(!e)return;!n&&o&&function(e,t,i,s){let r=e;do{0===r.z&&(r.z=wu(r.x,r.y,t,i,s)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){let t,i=1;do{let s,r=e;e=null;let o=null;for(t=0;r;){t++;let n=r,a=0;for(let e=0;e<i&&(a++,n=n.nextZ,n);e++);let l=i;for(;a>0||l>0&&n;)0!==a&&(0===l||!n||r.z<=n.z)?(s=r,r=r.nextZ,a--):(s=n,n=n.nextZ,l--),o?o.nextZ=s:e=s,s.prevZ=o,o=s;r=n}o.nextZ=null,i*=2}while(t>1)}(r)}(e,s,r,o);let a=e;for(;e.prev!==e.next;){const l=e.prev,A=e.next;if(o?mu(e,s,r,o):fu(e))t.push(l.i,e.i,A.i),Uu(e),e=A.next,a=A.next;else if((e=A)===a){n?1===n?pu(e=gu(du(e),t),t,i,s,r,o,2):2===n&&_u(e,t,i,s,r,o):pu(du(e),t,i,s,r,o,1);break}}}function fu(e){const t=e.prev,i=e,s=e.next;if(Mu(t,i,s)>=0)return!1;const r=t.x,o=i.x,n=s.x,a=t.y,l=i.y,A=s.y,c=Math.min(r,o,n),h=Math.min(a,l,A),u=Math.max(r,o,n),d=Math.max(a,l,A);let p=s.next;for(;p!==t;){if(p.x>=c&&p.x<=u&&p.y>=h&&p.y<=d&&xu(r,a,o,l,n,A,p.x,p.y)&&Mu(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function mu(e,t,i,s){const r=e.prev,o=e,n=e.next;if(Mu(r,o,n)>=0)return!1;const a=r.x,l=o.x,A=n.x,c=r.y,h=o.y,u=n.y,d=Math.min(a,l,A),p=Math.min(c,h,u),f=Math.max(a,l,A),m=Math.max(c,h,u),g=wu(d,p,t,i,s),_=wu(f,m,t,i,s);let v=e.prevZ,b=e.nextZ;for(;v&&v.z>=g&&b&&b.z<=_;){if(v.x>=d&&v.x<=f&&v.y>=p&&v.y<=m&&v!==r&&v!==n&&xu(a,c,l,h,A,u,v.x,v.y)&&Mu(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,b.x>=d&&b.x<=f&&b.y>=p&&b.y<=m&&b!==r&&b!==n&&xu(a,c,l,h,A,u,b.x,b.y)&&Mu(b.prev,b,b.next)>=0)return!1;b=b.nextZ}for(;v&&v.z>=g;){if(v.x>=d&&v.x<=f&&v.y>=p&&v.y<=m&&v!==r&&v!==n&&xu(a,c,l,h,A,u,v.x,v.y)&&Mu(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;b&&b.z<=_;){if(b.x>=d&&b.x<=f&&b.y>=p&&b.y<=m&&b!==r&&b!==n&&xu(a,c,l,h,A,u,b.x,b.y)&&Mu(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function gu(e,t){let i=e;do{const s=i.prev,r=i.next.next;!Eu(s,r)&&Fu(s,i,i.next,r)&&Du(s,r)&&Du(r,s)&&(t.push(s.i,i.i,r.i),Uu(i),Uu(i.next),i=e=r),i=i.next}while(i!==e);return du(i)}function _u(e,t,i,s,r,o){let n=e;do{let e=n.next.next;for(;e!==n.prev;){if(n.i!==e.i&&Cu(n,e)){let a=Su(n,e);return n=du(n,n.next),a=du(a,a.next),pu(n,t,i,s,r,o,0),void pu(a,t,i,s,r,o,0)}e=e.next}n=n.next}while(n!==e)}function vu(e,t){let i=e.x-t.x;if(0===i&&(i=e.y-t.y,0===i)){i=(e.next.y-e.y)/(e.next.x-e.x)-(t.next.y-t.y)/(t.next.x-t.x)}return i}function bu(e,t){const i=function(e,t){let i=t;const s=e.x,r=e.y;let o,n=-1/0;if(Eu(e,i))return i;do{if(Eu(e,i.next))return i.next;if(r<=i.y&&r>=i.next.y&&i.next.y!==i.y){const e=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(e<=s&&e>n&&(n=e,o=i.x<i.next.x?i:i.next,e===s))return o}i=i.next}while(i!==t);if(!o)return null;const a=o,l=o.x,A=o.y;let c=1/0;i=o;do{if(s>=i.x&&i.x>=l&&s!==i.x&&Pu(r<A?s:n,r,l,A,r<A?n:s,r,i.x,i.y)){const t=Math.abs(r-i.y)/(s-i.x);Du(i,e)&&(t<c||t===c&&(i.x>o.x||i.x===o.x&&yu(o,i)))&&(o=i,c=t)}i=i.next}while(i!==a);return o}(e,t);if(!i)return t;const s=Su(i,e);return du(s,s.next),du(i,i.next)}function yu(e,t){return Mu(e.prev,e,t.prev)<0&&Mu(t.next,e,e.next)<0}function wu(e,t,i,s,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-i)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-s)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Bu(e){let t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next}while(t!==e);return i}function Pu(e,t,i,s,r,o,n,a){return(r-n)*(t-a)>=(e-n)*(o-a)&&(e-n)*(s-a)>=(i-n)*(t-a)&&(i-n)*(o-a)>=(r-n)*(s-a)}function xu(e,t,i,s,r,o,n,a){return!(e===n&&t===a)&&Pu(e,t,i,s,r,o,n,a)}function Cu(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&Fu(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&(Du(e,t)&&Du(t,e)&&function(e,t){let i=e,s=!1;const r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&r<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next}while(i!==e);return s}(e,t)&&(Mu(e.prev,e,t.prev)||Mu(e,t.prev,t))||Eu(e,t)&&Mu(e.prev,e,e.next)>0&&Mu(t.prev,t,t.next)>0)}function Mu(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function Eu(e,t){return e.x===t.x&&e.y===t.y}function Fu(e,t,i,s){const r=Tu(Mu(e,t,i)),o=Tu(Mu(e,t,s)),n=Tu(Mu(i,s,e)),a=Tu(Mu(i,s,t));return r!==o&&n!==a||(!(0!==r||!Iu(e,i,t))||(!(0!==o||!Iu(e,s,t))||(!(0!==n||!Iu(i,e,s))||!(0!==a||!Iu(i,t,s)))))}function Iu(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y)}function Tu(e){return e>0?1:e<0?-1:0}function Du(e,t){return Mu(e.prev,e,e.next)<0?Mu(e,t,e.next)>=0&&Mu(e,e.prev,t)>=0:Mu(e,t,e.prev)<0||Mu(e,e.next,t)<0}function Su(e,t){const i=Lu(e.i,e.x,e.y),s=Lu(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,i.next=r,r.prev=i,s.next=i,i.prev=s,o.next=s,s.prev=o,s}function Ru(e,t,i,s){const r=Lu(e,t,i);return s?(r.next=s.next,r.prev=s,s.next.prev=r,s.next=r):(r.prev=r,r.next=r),r}function Uu(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function Lu(e,t,i){return{i:e,x:t,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}const ku=[0,1,0],Ou=[1,0,0],Nu=d.vec3(),Vu=d.vec3(),Qu=d.vec3(),Hu=d.vec3(),ju=d.vec3();function Gu(e,t){return Math.abs(e[0]-t[0])<1e-6&&Math.abs(e[1]-t[1])<1e-6&&Math.abs(e[2]-t[2])<1e-6}class zu{constructor(e){this.scene=e,this._resourcesAllocated=!1}_onCapMaterialUpdated(e,t){if(!this._resourcesAllocated){this._resourcesAllocated=!0,this._sectionPlanes=[],this._sceneModelsData={},this._dirtyMap={},this._prevIntersectionModelsMap={},this._sectionPlaneTimeout=null,this._updateTimeout=null;const e=e=>{const t=()=>{this._setAllDirty(!0),this._update()};this._sectionPlanes.push(e),e.on("pos",t),e.on("dir",t),e.on("active",t),e.once("destroyed",(()=>{const t=e.id;t&&(this._sectionPlanes=this._sectionPlanes.filter((e=>e.id!==t)),this._update())}).bind(this))};for(const t in this.scene.sectionPlanes)e(this.scene.sectionPlanes[t]);this._onSectionPlaneCreated=this.scene.on("sectionPlaneCreated",e),this._onTick=this.scene.on("tick",(()=>{let e=!1;for(const t in this._sceneModelsData)this.scene.models[t]?this._sceneModelsData[t].visible!==!!this.scene.models[t].visible&&(this._sceneModelsData[t].visible=!!this.scene.models[t].visible,e=!0):(delete this._sceneModelsData[t],e=!0);e&&this._update()}))}this._dirtyMap[t]||(this._dirtyMap[t]=new Map),this._dirtyMap[t].set(e,!0),this._update()}_update(){clearTimeout(this._updateTimeout),this._deletePreviousModels(),this._updateTimeout=setTimeout((()=>{clearTimeout(this._updateTimeout);const e=Object.values(this.scene.models).filter((e=>e.visible));this._addHatches(e,this._sectionPlanes.filter((e=>e.active))),this._setAllDirty(!1)}),100)}_setAllDirty(e){for(const t in this._dirty)this._dirtyMap[t].forEach(((i,s)=>this._dirtyMap[t].set(s,e)))}_addHatches(e,t){t.forEach((t=>{e.forEach((e=>{if(!this._doesPlaneIntersectBoundingBox(e.aabb,t))return;if(!this._dirtyMap[e.id])return;const i=new Map,s=e.objects,r=[d.vec3(),d.vec3(),d.vec3()];this._dirtyMap[e.id].forEach(((o,n)=>{if(!o)return;const a=s[n];if(!this._doesPlaneIntersectBoundingBox(a.aabb,t))return;if(!this._sceneModelsData[e.id]){const t=e.aabb;this._sceneModelsData[e.id]={verticesMap:new Map,indicesMap:new Map,modelOrigin:d.vec3([(t[0]+t[3])/2,(t[1]+t[4])/2,(t[2]+t[5])/2])}}const l=this._sceneModelsData[e.id],A=l.modelOrigin;if(!l.verticesMap.has(n)){const e=a.meshes[0].isSolid(),t=[],i=[];e&&a.capMaterial&&(a.getEachVertex((e=>t.push(e[0]-A[0],e[1]-A[1],e[2]-A[2]))),a.getEachIndex((e=>i.push(e)))),l.verticesMap.set(n,t),l.indicesMap.set(n,i)}const c=l.verticesMap.get(n),h=l.indicesMap.get(n),u=-d.dotVec3(d.subVec3(t.pos,A,Nu),t.dir),p=[],f=h.length;for(let e=0;e<f;e+=3){for(let t=0;t<3;t++){const i=3*h[e+t];r[t][0]=c[i],r[t][1]=c[i+1],r[t][2]=c[i+2]}if(!r[0][0]&&!r[0][1]&&!r[0][2])continue;const i=[];for(let e=0;e<3;e++){const s=r[e],o=r[(e+1)%3],n=u+d.dotVec3(t.dir,s),a=u+d.dotVec3(t.dir,o);if(n*a>0)continue;const l=-n/(a-n);i.push(d.lerpVec3(l,0,1,s,o,d.vec3()))}2===i.length&&p.push(i)}p.length>0&&i.set(n,p)}));const o=new Map;i.forEach(((e,t)=>{o.set(t,[[e[0]]]),e.splice(0,1);let s=0;for(;e.length>0;){const r=o.get(t)[s][o.get(t)[s].length-1][1];let n=!1;for(let i=0;i<e.length;i++){const[a,l]=e[i];if(Gu(r,a)){o.get(t)[s].push(e[i]),e.splice(i,1),n=!0;break}if(Gu(r,l)){o.get(t)[s].push([l,a]),e.splice(i,1),n=!0;break}}if(!n&&Gu(r,o.get(t)[s][0][0])&&e.length>1)o.get(t).push([i.get(t)[0]]),e.splice(0,1),s++;else if(!n)break}}));const n=new Map;o.forEach(((e,i)=>{const s=[];for(let i=0;i<e.length;i++)s.push([]),e[i].forEach((e=>{s[i].push([this._projectTo2D(e[0],t.dir),this._projectTo2D(e[1],t.dir)])}));n.set(i,s)}));const a=new Map;let l;n.forEach(((i,s)=>{const r=this._sceneModelsData[e.id].modelOrigin;l=[];const o=i,n=[],A=new Set;for(let e=0;e<o.length;e++){if(A.has(e))continue;const t=[o[e]];A.add(e);for(let i=e+1;i<o.length;i++)A.has(i)||(this._isLoopInside(o[e],o[i])||this._isLoopInside(o[i],o[e]))&&(t.push(o[i]),A.add(i));n.push(t)}n.forEach((e=>{const i=[],s=[];let o=0;const n=e.map((e=>{let t=0;for(let i=0;i<e.length;i++){const s=(i+1)%e.length;t+=e[i][0][0]*e[s][0][1],t-=e[s][0][0]*e[i][0][1]}return Math.abs(t)/2})),a=n.indexOf(Math.max(...n));e[a].forEach((e=>{i.push(e[0][0],e[0][1]),o+=2}));for(let t=0;t<e.length;t++)t!==a&&(s.push(o/2),e[t].forEach((e=>{i.push(e[0][0],e[0][1]),o+=2})));const A=hu(i,s),c=[];for(let e=0;e<A.length;e+=3){const s=[];for(let o=0;o<3;o++){const n=2*A[e+o],a=[i[n],i[n+1]],l=this._convertTo3D(a,t,r);s.push(l)}c.push(s)}l.push(c)})),a.set(s,l)}));const A=new Map;a.forEach(((e,t)=>{l=[],e.forEach((e=>{const t=new Map,i=[],s=[];let r=0;e.forEach((e=>{const o=[];e.forEach((e=>{const s=`${e[0].toFixed(6)},${e[1].toFixed(6)},${e[2].toFixed(6)}`;t.has(s)?o.push(t.get(s)):(i.push(e[0],e[1],e[2]),t.set(s,r),o.push(r),r++)})),s.push(...o)})),l.push({positions:i,indices:s})})),A.set(t,l)})),this._prevIntersectionModelsMap[e.id]||(this._prevIntersectionModelsMap[e.id]=new Map),d.mulVec3Scalar(t.dir,.001,ju),A.forEach(((i,s)=>{const r=this._sceneModelsData[e.id].modelOrigin,o=new Array(i.size);let n=0;i.forEach(((i,a)=>{const l=i.positions,A=i.indices;l.length;const c=d.buildNormals(l,A),h=this._createUVs(l,t,r);o[n++]=new fs(this.scene,{id:`${t.id}-${s}-${a}`,geometry:new ve(this.scene,{primitive:"triangles",positions:l,indices:A,normals:c,uv:h}),origin:d.addVec3(r,ju,Nu),position:[0,0,0],rotation:[0,0,0],material:e.objects[s].capMaterial})})),this._prevIntersectionModelsMap[e.id].has(s)?this._prevIntersectionModelsMap[e.id].get(s).push(...o):this._prevIntersectionModelsMap[e.id].set(s,o)}))}))}))}_doesPlaneIntersectBoundingBox(e,t){const i=[e[0],e[1],e[2]],s=[e[3],e[4],e[5]],r=[[i[0],i[1],i[2]],[s[0],i[1],i[2]],[i[0],s[1],i[2]],[s[0],s[1],i[2]],[i[0],i[1],s[2]],[s[0],i[1],s[2]],[i[0],s[1],s[2]],[s[0],s[1],s[2]]];let o=!1,n=!1;for(const e of r){const i=t.dist+d.dotVec3(t.dir,e);if(i>0&&(o=!0),i<0&&(n=!0),o&&n)return!0}return!1}_buildLines(e){for(const t in e)for(let i=0;i<e[t].length;i++){const s=e[t][i];s.length<=0||s.forEach(((e,t)=>{new fs(this.scene,{clippable:!1,geometry:new ve(this.scene,Oe({startPoint:e[0],endPoint:e[1]})),material:new bs(this.scene,{emissive:[1,0,0]})})}))}}_projectTo2D(e,t){let i;i=Math.abs(t[0])>Math.abs(t[1])?[-t[2],0,t[0]]:[0,t[2],-t[1]],i=d.normalizeVec3(i);const s=d.vec3(t),r=d.cross3Vec3(s,i),o=d.normalizeVec3(r);return[d.dotVec3(e,i),d.dotVec3(e,o)]}_isLoopInside(e,t){const i=e[0][0];let s=!1;for(let e=0,r=t.length-1;e<t.length;r=e++){const o=t[e][0][0],n=t[e][0][1],a=t[r][0][0],l=t[r][0][1];n>i[1]!=l>i[1]&&i[0]<(a-o)*(i[1]-n)/(l-n)+o&&(s=!s)}return s}_convertTo3D(e,t,i){let s,r=t.dir,o=t.pos;s=Math.abs(r[0])>Math.abs(r[1])?[-r[2],0,r[0]]:[0,r[2],-r[1]],s=d.normalizeVec3(s);const n=d.vec3(r),a=d.cross3Vec3(n,s),l=d.normalizeVec3(a),A=e[0],c=e[1],h=[s[0]*A+l[0]*c,s[1]*A+l[1]*c,s[2]*A+l[2]*c],u=d.dotVec3(r,[o[0]-h[0]-i[0],o[1]-h[1]-i[1],o[2]-h[2]-i[2]]);return[h[0]+r[0]*u,h[1]+r[1]*u,h[2]+r[2]*u]}_deletePreviousModels(){for(const e in this._prevIntersectionModelsMap){this._prevIntersectionModelsMap[e].forEach(((t,i)=>{this._dirtyMap[e].get(i)&&(t.forEach((e=>{e.destroy()})),this._prevIntersectionModelsMap[e].delete(i))})),this._prevIntersectionModelsMap[e].size<=0&&delete this._prevIntersectionModelsMap[e]}}_createUVs(e,t,i){const s=t.pos,r=Nu;r.set(t.dir),d.normalizeVec3(r);const o=Vu,n=[];for(let t=0;t<e.length;t+=3){o[0]=e[t]+i[0],o[1]=e[t+1]+i[1],o[2]=e[t+2]+i[2];const a=d.subVec3(o,s,Qu),l=d.dotVec3(a,r);d.subVec3(o,d.mulVec3Scalar(r,l,Qu),o);const A=Math.abs(d.dotVec3(r,ku))<.999?d.cross3Vec3(r,ku,Qu):Ou,c=d.cross3Vec3(r,A,Qu);d.normalizeVec3(c,c);const h=d.subVec3(o,s,o);n.push(d.dotVec3(h,d.normalizeVec3(d.cross3Vec3(c,r,Hu))),d.dotVec3(h,c))}return n}destroy(){this._deletePreviousModels(),this._resourcesAllocated&&(this.scene.off(this._onModelLoaded),this.scene.off(this._onModelUnloaded),this.scene.off(this._onSectionPlaneCreated),this.scene.off(this._onTick))}}function Wu(e,t){const i={};let s,r;for(let o=0,n=t.length;o<n;o++)s=t[o],r=e.components[s],r?r.isEntity?i[s]=!0:e.warn("pick(): Component is not an Entity: "+s):e.warn("pick(): Component not found: "+s);return i}class Xu extends R{get type(){return"Scene"}constructor(e,t={}){super(null,t);const i=t.canvasElement||document.querySelector(`#${t.canvasId}`);if(!(i instanceof HTMLCanvasElement))throw"Mandatory config expected: valid canvasId or canvasElement";this._tickifiedFunctions={};const s=!!t.transparent,r=!!t.alphaDepthMask;this._aabbDirty=!0,this._readableGeometry=!!t.readableGeometryEnabled,this.viewer=e,this.occlusionTestCountdown=0,this.loading=0,this.startTime=(new Date).getTime(),this.models={},this.objects={},this._numObjects=0,this.visibleObjects={},this._numVisibleObjects=0,this.xrayedObjects={},this._numXRayedObjects=0,this.highlightedObjects={},this._numHighlightedObjects=0,this.selectedObjects={},this._numSelectedObjects=0,this.colorizedObjects={},this._numColorizedObjects=0,this.opacityObjects={},this._numOpacityObjects=0,this.offsetObjects={},this._numOffsetObjects=0,this._modelIds=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this._opacityObjectIds=null,this._offsetObjectIds=null,this._collidables={},this._compilables={},this._needRecompile=!1,this.types={},this.components={},this.sectionPlanes={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.bitmaps={},this.lineSets={},this.realWorldOffset=t.realWorldOffset||new Float64Array([0,0,0]),this.canvas=new gh(this,{dontClear:!0,canvas:i,spinnerElementId:t.spinnerElementId,transparent:s,webgl2:!1!==t.webgl2,contextAttr:t.contextAttr||{},backgroundColor:t.backgroundColor,backgroundColorFromAmbientLight:t.backgroundColorFromAmbientLight,premultipliedAlpha:t.premultipliedAlpha}),this.canvas.on("boundary",(()=>{this.glRedraw()})),this.canvas.on("webglContextFailed",(()=>{alert("xeokit failed to find WebGL!")})),this._renderer=new Rh(this,{transparent:s,alphaDepthMask:r}),this._sectionPlanesState=new function(){this.sectionPlanes=[],this.clippingCaps=!1,this._numCachedSectionPlanes=0;let e=null;this.getHash=function(){if(e)return e;const t=this.getNumAllocatedSectionPlanes();if(this.sectionPlanes,0===t)return this.hash=";";const i=[];for(let e=0,s=t;e<s;e++)i.push("cp");return i.push(";"),e=i.join(""),e},this.addSectionPlane=function(t){this.sectionPlanes.push(t),e=null},this.removeSectionPlane=function(t){for(let i=0,s=this.sectionPlanes.length;i<s;i++)if(this.sectionPlanes[i].id===t.id)return this.sectionPlanes.splice(i,1),void(e=null)},this.setNumCachedSectionPlanes=function(t){this._numCachedSectionPlanes=t,e=null},this.getNumCachedSectionPlanes=function(){return this._numCachedSectionPlanes},this.getNumAllocatedSectionPlanes=function(){const e=this.sectionPlanes.length;return e>this._numCachedSectionPlanes?e:this._numCachedSectionPlanes}},this._sectionPlanesState.setNumCachedSectionPlanes(t.numCachedSectionPlanes||0),this._lightsState=new function(){const e=d.vec4([0,0,0,0]),t=d.vec4();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];let i=null,s=null;this.getHash=function(){if(i)return i;const e=[],t=this.lights;let s;for(let i=0,r=t.length;i<r;i++)s=t[i],e.push("/"),e.push(s.type),e.push("world"===s.space?"w":"v"),s.castsShadow&&e.push("sh");return this.lightMaps.length>0&&e.push("/lm"),this.reflectionMaps.length>0&&e.push("/rm"),e.push(";"),i=e.join(""),i},this.addLight=function(e){this.lights.push(e),s=null,i=null},this.removeLight=function(e){for(let t=0,r=this.lights.length;t<r;t++){if(this.lights[t].id===e.id)return this.lights.splice(t,1),s&&s.id===e.id&&(s=null),void(i=null)}},this.addReflectionMap=function(e){this.reflectionMaps.push(e),i=null},this.removeReflectionMap=function(e){for(let t=0,s=this.reflectionMaps.length;t<s;t++)if(this.reflectionMaps[t].id===e.id)return this.reflectionMaps.splice(t,1),void(i=null)},this.addLightMap=function(e){this.lightMaps.push(e),i=null},this.removeLightMap=function(e){for(let t=0,s=this.lightMaps.length;t<s;t++)if(this.lightMaps[t].id===e.id)return this.lightMaps.splice(t,1),void(i=null)},this.getAmbientColorAndIntensity=function(){if(!s)for(let e=0,t=this.lights.length;e<t;e++){const t=this.lights[e];if("ambient"===t.type){s=t;break}}if(s){const e=s.color,i=s.intensity;return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=i,t}return e}},this.input=new Uh(this,{dontClear:!0,element:this.canvas.canvas,keyboardEventsElement:t.keyboardEventsElement}),this.metrics=new ru(this,{units:t.units,scale:t.scale,origin:t.origin}),this.sao=new ou(this,{enabled:t.saoEnabled}),this.crossSections=new nu(this,{}),this.ticksPerRender=t.ticksPerRender,this.ticksPerOcclusionTest=t.ticksPerOcclusionTest,this.passes=t.passes,this.clearEachPass=t.clearEachPass,this.gammaInput=t.gammaInput,this.gammaOutput=t.gammaOutput,this.gammaFactor=t.gammaFactor,this._entityOffsetsEnabled=!!t.entityOffsetsEnabled,this._logarithmicDepthBufferEnabled=!!t.logarithmicDepthBufferEnabled,this._dtxEnabled=!1!==t.dtxEnabled,this._pbrEnabled=!!t.pbrEnabled,this._colorTextureEnabled=!1!==t.colorTextureEnabled,this._dtxEnabled=!!t.dtxEnabled,this._markerZOffset=t.markerZOffset,I._addScene(this),this._initDefaults(),this._viewport=new Lh(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new iu(this,{id:"default.camera",dontClear:!0}),this._sectionCaps=new zu(this),new Uc(this,{color:[1,1,1],intensity:.7}),new kc(this,{dir:[.8,-.5,-.5],color:[.67,.67,1],intensity:.7,space:"world"}),new kc(this,{dir:[-.8,-1,.5],color:[1,1,.9],intensity:.9,space:"world"}),this._camera.on("dirty",(()=>{this._renderer.imageDirty()}))}_initDefaults(){}_addComponent(e){if(e.id&&this.components[e.id]&&(this.error("Component "+y.inQuotes(e.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),e.id=null),!e.id)for(void 0===window.nextID&&(window.nextID=0),e.id="__"+window.nextID++;this.components[e.id];)e.id=d.createUUID();this.components[e.id]=e;const t=e.type;let i=this.types[e.type];i||(i=this.types[t]={}),i[e.id]=e,e.compile&&(this._compilables[e.id]=e),e.isDrawable&&(this._renderer.addDrawable(e.id,e),this._collidables[e.id]=e)}_removeComponent(e){var t=e.id,i=e.type;delete this.components[t];const s=this.types[i];s&&(delete s[t],y.isEmptyObject(s)&&delete this.types[i]),e.compile&&delete this._compilables[e.id],e.isDrawable&&(this._renderer.removeDrawable(e.id),delete this._collidables[e.id])}_capMaterialUpdated(e,t){this._sectionCaps._onCapMaterialUpdated(e,t)}_sectionPlaneCreated(e){this.sectionPlanes[e.id]=e,this.scene._sectionPlanesState.addSectionPlane(e._state),this.scene.fire("sectionPlaneCreated",e,!0),this._needRecompile=!0}_bitmapCreated(e){this.bitmaps[e.id]=e,this.scene.fire("bitmapCreated",e,!0)}_lineSetCreated(e){this.lineSets[e.id]=e,this.scene.fire("lineSetCreated",e,!0)}_lightCreated(e){this.lights[e.id]=e,this.scene._lightsState.addLight(e._state),this._needRecompile=!0}_lightMapCreated(e){this.lightMaps[e.id]=e,this.scene._lightsState.addLightMap(e._state),this._needRecompile=!0}_reflectionMapCreated(e){this.reflectionMaps[e.id]=e,this.scene._lightsState.addReflectionMap(e._state),this._needRecompile=!0}_sectionPlaneDestroyed(e){delete this.sectionPlanes[e.id],this.scene._sectionPlanesState.removeSectionPlane(e._state),this.scene.fire("sectionPlaneDestroyed",e,!0),this._needRecompile=!0}_bitmapDestroyed(e){delete this.bitmaps[e.id],this.scene.fire("bitmapDestroyed",e,!0)}_lineSetDestroyed(e){delete this.lineSets[e.id],this.scene.fire("lineSetDestroyed",e,!0)}_lightDestroyed(e){delete this.lights[e.id],this.scene._lightsState.removeLight(e._state),this._needRecompile=!0}_lightMapDestroyed(e){delete this.lightMaps[e.id],this.scene._lightsState.removeLightMap(e._state),this._needRecompile=!0}_reflectionMapDestroyed(e){delete this.reflectionMaps[e.id],this.scene._lightsState.removeReflectionMap(e._state),this._needRecompile=!0}_registerModel(e){this.models[e.id]=e,this._modelIds=null}_deregisterModel(e){const t=e.id;delete this.models[t],this._modelIds=null,this.fire("modelUnloaded",t)}_registerObject(e){this.objects[e.id]=e,this._numObjects++,this._objectIds=null}_deregisterObject(e){delete this.objects[e.id],this._numObjects--,this._objectIds=null}_objectVisibilityUpdated(e,t=!0){e.visible?(this.visibleObjects[e.id]=e,this._numVisibleObjects++):(delete this.visibleObjects[e.id],this._numVisibleObjects--),this._visibleObjectIds=null,t&&this.fire("objectVisibility",e,!0)}_deRegisterVisibleObject(e){delete this.visibleObjects[e.id],this._numVisibleObjects--,this._visibleObjectIds=null}_objectXRayedUpdated(e,t=!0){e.xrayed?(this.xrayedObjects[e.id]=e,this._numXRayedObjects++):(delete this.xrayedObjects[e.id],this._numXRayedObjects--),this._xrayedObjectIds=null,t&&this.fire("objectXRayed",e,!0)}_deRegisterXRayedObject(e){delete this.xrayedObjects[e.id],this._numXRayedObjects--,this._xrayedObjectIds=null}_objectHighlightedUpdated(e){e.highlighted?(this.highlightedObjects[e.id]=e,this._numHighlightedObjects++):(delete this.highlightedObjects[e.id],this._numHighlightedObjects--),this._highlightedObjectIds=null}_deRegisterHighlightedObject(e){delete this.highlightedObjects[e.id],this._numHighlightedObjects--,this._highlightedObjectIds=null}_objectSelectedUpdated(e,t=!0){e.selected?(this.selectedObjects[e.id]=e,this._numSelectedObjects++):(delete this.selectedObjects[e.id],this._numSelectedObjects--),this._selectedObjectIds=null,t&&this.fire("objectSelected",e,!0)}_deRegisterSelectedObject(e){delete this.selectedObjects[e.id],this._numSelectedObjects--,this._selectedObjectIds=null}_objectColorizeUpdated(e,t){t?(this.colorizedObjects[e.id]=e,this._numColorizedObjects++):(delete this.colorizedObjects[e.id],this._numColorizedObjects--),this._colorizedObjectIds=null}_deRegisterColorizedObject(e){delete this.colorizedObjects[e.id],this._numColorizedObjects--,this._colorizedObjectIds=null}_objectOpacityUpdated(e,t){t?(this.opacityObjects[e.id]=e,this._numOpacityObjects++):(delete this.opacityObjects[e.id],this._numOpacityObjects--),this._opacityObjectIds=null}_deRegisterOpacityObject(e){delete this.opacityObjects[e.id],this._numOpacityObjects--,this._opacityObjectIds=null}_objectOffsetUpdated(e,t){!t||0===t[0]&&0===t[1]&&0===t[2]?(this.offsetObjects[e.id]=e,this._numOffsetObjects++):(delete this.offsetObjects[e.id],this._numOffsetObjects--),this._offsetObjectIds=null}_deRegisterOffsetObject(e){delete this.offsetObjects[e.id],this._numOffsetObjects--,this._offsetObjectIds=null}_webglContextLost(){this.canvas.spinner.processes++;for(const e in this.components)if(this.components.hasOwnProperty(e)){const t=this.components[e];t._webglContextLost&&t._webglContextLost()}this._renderer.webglContextLost()}_webglContextRestored(){const e=this.canvas.gl;for(const t in this.components)if(this.components.hasOwnProperty(t)){const i=this.components[t];i._webglContextRestored&&i._webglContextRestored(e)}this._renderer.webglContextRestored(e),this.canvas.spinner.processes--}get capabilities(){return this._renderer.capabilities}get entityOffsetsEnabled(){return this._entityOffsetsEnabled}get readableGeometryEnabled(){return this._readableGeometry}get pickSurfacePrecisionEnabled(){return this._readableGeometry}get logarithmicDepthBufferEnabled(){return this._logarithmicDepthBufferEnabled}set numCachedSectionPlanes(e){e=e||0,this._sectionPlanesState.getNumCachedSectionPlanes()!==e&&(this._sectionPlanesState.setNumCachedSectionPlanes(e),this._needRecompile=!0,this.glRedraw())}get numCachedSectionPlanes(){return this._sectionPlanesState.getNumCachedSectionPlanes()}set pbrEnabled(e){this._pbrEnabled=!!e,this.glRedraw()}get pbrEnabled(){return this._pbrEnabled}set dtxEnabled(e){e=!!e,this._dtxEnabled!==e&&(this._dtxEnabled=e)}get dtxEnabled(){return this._dtxEnabled}set colorTextureEnabled(e){this._colorTextureEnabled=!!e,this.glRedraw()}get colorTextureEnabled(){return this._colorTextureEnabled}get markerZOffset(){return null==this._markerZOffset?-.001:this._markerZOffset}doOcclusionTest(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()}render(e){e&&I.runTasks();const t={sceneId:null,pass:0};if(this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),!e&&!this._renderer.needsRender())return;t.sceneId=this.id;const i=this._passes,s=this._clearEachPass;let r,o;for(r=0;r<i;r++)t.pass=r,this.fire("rendering",t,!0),o=s||0===r,this._renderer.render({pass:r,clear:o,force:e}),this.fire("rendered",t,!0);this._saveAmbientColor()}compile(){this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1)}_recompile(){for(const e in this._compilables)this._compilables.hasOwnProperty(e)&&this._compilables[e].compile();this._renderer.shadowsDirty(),this.fire("compile",this,!0)}_saveAmbientColor(){const e=this.canvas;if(e.transparent||e.backgroundImage||e.backgroundColor)this._lastAmbientColor=null;else{const t=this._lightsState.getAmbientColorAndIntensity();this._lastAmbientColor&&this._lastAmbientColor[0]===t[0]&&this._lastAmbientColor[1]===t[1]&&this._lastAmbientColor[2]===t[2]&&this._lastAmbientColor[3]===t[3]||(e.backgroundColor=t,this._lastAmbientColor||(this._lastAmbientColor=d.vec4([0,0,0,1])),this._lastAmbientColor.set(t))}}get modelIds(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}get numObjects(){return this._numObjects}get objectIds(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}get numVisibleObjects(){return this._numVisibleObjects}get visibleObjectIds(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}get numXRayedObjects(){return this._numXRayedObjects}get xrayedObjectIds(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}get numHighlightedObjects(){return this._numHighlightedObjects}get highlightedObjectIds(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}get numSelectedObjects(){return this._numSelectedObjects}get selectedObjectIds(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}get numColorizedObjects(){return this._numColorizedObjects}get colorizedObjectIds(){return this._colorizedObjectIds||(this._colorizedObjectIds=Object.keys(this.colorizedObjects)),this._colorizedObjectIds}get opacityObjectIds(){return this._opacityObjectIds||(this._opacityObjectIds=Object.keys(this.opacityObjects)),this._opacityObjectIds}get offsetObjectIds(){return this._offsetObjectIds||(this._offsetObjectIds=Object.keys(this.offsetObjects)),this._offsetObjectIds}set ticksPerRender(e){null==e?e=1:(!y.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._ticksPerRender&&(this._ticksPerRender=e)}get ticksPerRender(){return this._ticksPerRender}set ticksPerOcclusionTest(e){null==e?e=20:(!y.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+e+"' - should be an integer greater than zero."),e=20),e!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=e)}get ticksPerOcclusionTest(){return this._ticksPerOcclusionTest}set passes(e){null==e?e=1:(!y.isNumeric(e)||e<=0)&&(this.error("Unsupported value for 'passes': '"+e+"' - should be an integer greater than zero."),e=1),e!==this._passes&&(this._passes=e,this.glRedraw())}get passes(){return this._passes}set clearEachPass(e){(e=!!e)!==this._clearEachPass&&(this._clearEachPass=e,this.glRedraw())}get clearEachPass(){return this._clearEachPass}set gammaInput(e){(e=!1!==e)!==this._renderer.gammaInput&&(this._renderer.gammaInput=e,this._needRecompile=!0,this.glRedraw())}get gammaInput(){return this._renderer.gammaInput}set gammaOutput(e){(e=!!e)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=e,this._needRecompile=!0,this.glRedraw())}get gammaOutput(){return this._renderer.gammaOutput}set gammaFactor(e){(e=null==e?2.2:e)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=e,this.glRedraw())}get gammaFactor(){return this._renderer.gammaFactor}get geometry(){return this.components["default.geometry"]||Ce(ve)}get material(){return this.components["default.material"]||new bs(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}get xrayMaterial(){return this.components["default.xrayMaterial"]||new Gs(this,{id:"default.xrayMaterial",fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get highlightMaterial(){return this.components["default.highlightMaterial"]||new Gs(this,{id:"default.highlightMaterial",fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get selectedMaterial(){return this.components["default.selectedMaterial"]||new Gs(this,{id:"default.selectedMaterial",fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[1,1,1],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get edgeMaterial(){return this.components["default.edgeMaterial"]||new Ws(this,{id:"default.edgeMaterial",fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get pointsMaterial(){return this.components["default.pointsMaterial"]||new lu(this,{id:"default.pointsMaterial",fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1,dontClear:!0})}get linesMaterial(){return this.components["default.linesMaterial"]||new cu(this,{id:"default.linesMaterial",fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1,dontClear:!0})}get viewport(){return this._viewport}get camera(){return this._camera}get center(){if(this._aabbDirty||!this._center){const e=this.aabb;this._center||(this._center=d.vec3()),this._center[0]=(e[0]+e[3])/2,this._center[1]=(e[1]+e[4])/2,this._center[2]=(e[2]+e[5])/2}return this._center}get aabb(){if(this._aabbDirty){this._aabb||(this._aabb=d.AABB3());let e,t=d.MAX_DOUBLE,i=d.MAX_DOUBLE,s=d.MAX_DOUBLE,r=d.MIN_DOUBLE,o=d.MIN_DOUBLE,n=d.MIN_DOUBLE;const a=this._collidables;let l,A=!1;for(const c in a)if(a.hasOwnProperty(c)){if(l=a[c],!1===l.collidable)continue;e=l.aabb,e[0]<t&&(t=e[0]),e[1]<i&&(i=e[1]),e[2]<s&&(s=e[2]),e[3]>r&&(r=e[3]),e[4]>o&&(o=e[4]),e[5]>n&&(n=e[5]),A=!0}A||(t=-100,i=-100,s=-100,r=100,o=100,n=100),this._aabb[0]=t,this._aabb[1]=i,this._aabb[2]=s,this._aabb[3]=r,this._aabb[4]=o,this._aabb[5]=n,this._aabbDirty=!1,this._center=null}return this._aabb}_setAABBDirty(){this._aabbDirty=!0,this.fire("boundary")}pick(e,t){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(e=e||{}).pickSurface=e.pickSurface||e.rayPick,e.canvasPos||e.matrix||e.origin&&e.direction||this.warn("picking without canvasPos, matrix, or ray origin and direction");const i=e.includeEntities||e.include;i&&(e.includeEntityIds=Wu(this,i));const s=e.excludeEntities||e.exclude;return s&&(e.excludeEntityIds=Wu(this,s)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),(t=e.snapToEdge||e.snapToVertex?this._renderer.snapPick(e,t):this._renderer.pick(e,t))&&t.entity&&t.entity.fire&&t.entity.fire("picked",t),t}snapPick(e){if(void 0===this._warnSnapPickDeprecated&&(this._warnSnapPickDeprecated=!0,this.warn("Scene.snapPick() is deprecated since v2.4.2 - use Scene.pick() instead")),e.canvasPos)return this._renderer.snapPick(e);this.error("Scene.snapPick() canvasPos parameter expected")}clear(){var e;for(const t in this.components)this.components.hasOwnProperty(t)&&((e=this.components[t])._dontClear||e.destroy())}clearLights(){const e=Object.keys(this.lights);for(let t=0,i=e.length;t<i;t++)this.lights[e[t]].destroy()}clearSectionPlanes(){const e=Object.keys(this.sectionPlanes);for(let t=0,i=e.length;t<i;t++)this.sectionPlanes[e[t]].destroy()}clearBitmaps(){const e=Object.keys(this.bitmaps);for(let t=0,i=e.length;t<i;t++)this.bitmaps[e[t]].destroy()}clearLines(){const e=Object.keys(this.lineSets);for(let t=0,i=e.length;t<i;t++)this.lineSets[e[t]].destroy()}getAABB(e){if(void 0===e)return this.aabb;if(y.isString(e)){const t=this.objects[e];if(t&&t.aabb)return t.aabb;e=[e]}if(0===e.length)return this.aabb;let t,i=d.MAX_DOUBLE,s=d.MAX_DOUBLE,r=d.MAX_DOUBLE,o=d.MIN_DOUBLE,n=d.MIN_DOUBLE,a=d.MIN_DOUBLE;if(this.withObjects(e,(e=>{if(e.collidable){const l=e.aabb;l[0]<i&&(i=l[0]),l[1]<s&&(s=l[1]),l[2]<r&&(r=l[2]),l[3]>o&&(o=l[3]),l[4]>n&&(n=l[4]),l[5]>a&&(a=l[5]),t=!0}})),t){const e=d.AABB3();return e[0]=i,e[1]=s,e[2]=r,e[3]=o,e[4]=n,e[5]=a,e}return this.aabb}setObjectsVisible(e,t){return this.withObjects(e,(e=>{const i=e.visible!==t;return e.visible=t,i}))}setObjectsCollidable(e,t){return this.withObjects(e,(e=>{const i=e.collidable!==t;return e.collidable=t,i}))}setObjectsCulled(e,t){return this.withObjects(e,(e=>{const i=e.culled!==t;return e.culled=t,i}))}setObjectsSelected(e,t){return this.withObjects(e,(e=>{const i=e.selected!==t;return e.selected=t,i}))}setObjectsHighlighted(e,t){return this.withObjects(e,(e=>{const i=e.highlighted!==t;return e.highlighted=t,i}))}setObjectsXRayed(e,t){return this.withObjects(e,(e=>{const i=e.xrayed!==t;return e.xrayed=t,i}))}setObjectsEdges(e,t){return this.withObjects(e,(e=>{const i=e.edges!==t;return e.edges=t,i}))}setObjectsColorized(e,t){return this.withObjects(e,(e=>{e.colorize=t}))}setObjectsOpacity(e,t){return this.withObjects(e,(e=>{const i=e.opacity!==t;return e.opacity=t,i}))}setObjectsPickable(e,t){return this.withObjects(e,(e=>{const i=e.pickable!==t;return e.pickable=t,i}))}setObjectsOffset(e,t){this.withObjects(e,(e=>{e.offset=t}))}withObjects(e,t){y.isString(e)&&(e=[e]);let i=!1;for(let s=0,r=e.length;s<r;s++){const r=e[s];let o=this.objects[r];if(o)i=t(o)||i;else{const e=this.modelIds;for(let s=0,n=e.length;s<n;s++){const n=e[s],a=d.globalizeObjectId(n,r);o=this.objects[a],o&&(i=t(o)||i)}}}return i}tickify(e){const t=e.toString();if(t in this._tickifiedFunctions)return this._tickifiedFunctions[t].wrapperFunc;let i,s=0,r=0;const o=function(...e){i=e,r++},n=this.on("tick",(()=>{r>s&&(s=r,e(...i))}));return this._tickifiedFunctions[t]={tickSubId:n,wrapperFunc:o},o}destroy(){super.destroy();for(const e in this.components)this.components.hasOwnProperty(e)&&this.components[e].destroy();this._sectionCaps.destroy(),this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.colorizedObjects=null,this.opacityObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this._sectionCaps=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}const Ku=d.vec4(),Zu=d.vec4(),Ju=d.vec3(),Yu=d.vec3(),qu=d.vec3(),$u=d.vec4(),ed=d.vec4(),td=d.vec4();class id{constructor(e){this._scene=e}dollyToCanvasPos(e,t,i){let s=!1;const r=this._scene.camera;if(e){const t=d.subVec3(e,r.eye,Ju);s=d.lenVec3(t)<i}if("perspective"===r.projection){r.ortho.scale=r.ortho.scale-i;const s=this._unproject(t,$u),o=d.subVec3(s,r.eye,td),n=d.mulVec3Scalar(d.normalizeVec3(o),-i,[]);if(r.eye=[r.eye[0]-n[0],r.eye[1]-n[1],r.eye[2]-n[2]],r.look=[r.look[0]-n[0],r.look[1]-n[1],r.look[2]-n[2]],e){const t=d.subVec3(e,r.eye,Ju),i=d.lenVec3(t),s=d.mulVec3Scalar(d.normalizeVec3(d.subVec3(r.look,r.eye,Yu)),i);r.look=[r.eye[0]+s[0],r.eye[1]+s[1],r.eye[2]+s[2]]}}else if("ortho"===r.projection){const e=this._unproject(t,$u);r.ortho.scale=r.ortho.scale-i,r.ortho._update();const s=this._unproject(t,ed),o=d.subVec3(s,e,td),n=d.mulVec3Scalar(d.normalizeVec3(d.subVec3(r.look,r.eye,Ju)),-i,Yu),a=d.addVec3(o,n,qu);r.eye=[r.eye[0]-a[0],r.eye[1]-a[1],r.eye[2]-a[2]],r.look=[r.look[0]-a[0],r.look[1]-a[1],r.look[2]-a[2]]}return s}_unproject(e,t){const i=this._scene.camera,s=i.project.transposedMatrix,r=s.subarray(8,12),o=s.subarray(12),n=[0,0,-1,1],a=d.dotVec4(n,r)/d.dotVec4(n,o);return i.project.unproject(e,a,Ku,Zu,t),t}destroy(){}}const sd=d.vec3(),rd=d.vec3(),od=d.vec3(),nd=d.vec4(),ad=d.vec4(),ld=d.vec4(),Ad=Math.PI-.001;class cd{constructor(e,t){this._scene=e,this._configs=t,this._pivotWorldPos=d.vec3(),this._cameraOffset=d.vec3(),this._azimuth=0,this._polar=0,this._radius=0,this._pivotPosSet=!1,this._pivoting=!1,this._shown=!1,this._pivotSphereEnabled=!1,this._pivotSphere=null,this._pivotSphereSize=1,this._pivotSphereGeometry=null,this._pivotSphereMaterial=null,this._rtcCenter=d.vec3(),this._rtcPos=d.vec3(),this._pivotViewPos=d.vec4(),this._pivotProjPos=d.vec4(),this._pivotCanvasPos=d.vec2(),this._cameraDirty=!0,this._onViewMatrix=this._scene.camera.on("viewMatrix",(()=>{this._cameraDirty=!0})),this._onProjMatrix=this._scene.camera.on("projMatrix",(()=>{this._cameraDirty=!0})),this._onTick=this._scene.on("tick",(()=>{this.updatePivotElement(),this.updatePivotSphere()}))}createPivotSphere(){const e=this.getPivotPos(),t=d.vec3();d.decomposeMat4(d.inverseMat4(this._scene.viewer.camera.viewMatrix,d.mat4()),t,d.vec4(),d.vec3());const i=d.distVec3(t,e);let s=Math.tan(Math.PI/500)*i*this._pivotSphereSize;"ortho"==this._scene.camera.projection&&(s/=this._scene.camera.ortho.scale/2),qe(e,this._rtcCenter,this._rtcPos),this._pivotSphereGeometry=new we(this._scene,De({radius:s})),this._pivotSphere=new fs(this._scene,{geometry:this._pivotSphereGeometry,material:this._pivotSphereMaterial,pickable:!1,position:this._rtcPos,rtcCenter:this._rtcCenter})}destroyPivotSphere(){this._pivotSphere&&(this._pivotSphere.destroy(),this._pivotSphere=null),this._pivotSphereGeometry&&(this._pivotSphereGeometry.destroy(),this._pivotSphereGeometry=null)}updatePivotElement(){const e=this._scene.camera,t=this._scene.canvas;if(this._pivoting&&this._cameraDirty){d.transformPoint3(e.viewMatrix,this.getPivotPos(),this._pivotViewPos),this._pivotViewPos[3]=1,d.transformPoint4(e.projMatrix,this._pivotViewPos,this._pivotProjPos);const i=t.boundary,s=i[2],r=i[3];this._pivotCanvasPos[0]=Math.floor((1+this._pivotProjPos[0]/this._pivotProjPos[3])*s/2),this._pivotCanvasPos[1]=Math.floor((1-this._pivotProjPos[1]/this._pivotProjPos[3])*r/2);let o=t._lastBoundingClientRect;if(!o||t._canvasSizeChanged){const e=t.canvas;o=t._lastBoundingClientRect=e.getBoundingClientRect()}this._pivotElement&&(this._pivotElement.style.left=Math.floor(o.left+this._pivotCanvasPos[0])-this._pivotElement.clientWidth/2+window.scrollX+"px",this._pivotElement.style.top=Math.floor(o.top+this._pivotCanvasPos[1])-this._pivotElement.clientHeight/2+window.scrollY+"px"),this._cameraDirty=!1}}updatePivotSphere(){this._pivoting&&this._pivotSphere&&(qe(this.getPivotPos(),this._rtcCenter,this._rtcPos),d.compareVec3(this._rtcPos,this._pivotSphere.position)||(this.destroyPivotSphere(),this.createPivotSphere()))}setPivotElement(e){this._pivotElement=e}enablePivotSphere(e={}){this.destroyPivotSphere(),this._pivotSphereEnabled=!0,e.size&&(this._pivotSphereSize=e.size);const t=e.color||[1,0,0];this._pivotSphereMaterial=new bs(this._scene,{emissive:t,ambient:t,specular:[0,0,0],diffuse:[0,0,0]})}disablePivotSphere(){this.destroyPivotSphere(),this._pivotSphereEnabled=!1}startPivot(){const e=this._scene.camera;let t=d.lookAtMat4v(e.eye,e.look,e.up);d.transformPoint3(t,this.getPivotPos(),this._cameraOffset);const i=this.getPivotPos();this._cameraOffset[2]+=d.distVec3(e.eye,i),t=d.inverseMat4(t);const s=d.transformVec3(t,this._cameraOffset),r=d.vec3();if(d.subVec3(e.eye,i,r),d.addVec3(r,s),e.zUp){const e=r[1];r[1]=r[2],r[2]=e}this._radius=d.lenVec3(r),this._polar=Math.acos(r[1]/this._radius),this._azimuth=Math.atan2(r[0],r[2]),this._pivoting=!0}_cameraLookingDownwards(){const e=this._scene.camera,t=d.normalizeVec3(d.subVec3(e.look,e.eye,sd)),i=d.cross3Vec3(t,e.worldUp,rd);return d.sqLenVec3(i)<=1e-4}getPivoting(){return this._pivoting}setPivotPos(e){this._pivotWorldPos.set(e),this._pivotPosSet=!0}setCanvasPivotPos(e){const t=this._scene.camera,i=Math.abs(d.distVec3(this._scene.center,t.eye)),s=t.project.transposedMatrix,r=s.subarray(8,12),o=s.subarray(12),n=[0,0,-1,1],a=d.dotVec4(n,r)/d.dotVec4(n,o),l=nd;t.project.unproject(e,a,ad,ld,l);const A=d.normalizeVec3(d.subVec3(l,t.eye,sd)),c=d.addVec3(t.eye,d.mulVec3Scalar(A,i,rd),od);this.setPivotPos(c)}getPivotPos(){return this._pivotPosSet?this._pivotWorldPos:this._scene.camera.look}continuePivot(e,t){if(!this._pivoting)return;if(0===e&&0===t)return;const i=this._scene.camera;var s=-e;const r=-t;1===i.worldUp[2]&&(s=-s),this._azimuth+=.01*-s;const o=r<0,n=r>0,a=Math.abs(this._polar-.001)<.005,l=Math.abs(this._polar-Ad)<.005;let A=this._polar+.01*r;A=a&&o?.001:l&&n?Ad:d.clamp(A,.001,Ad),this._polar=A;const c=[this._radius*Math.sin(this._polar)*Math.sin(this._azimuth),this._radius*Math.cos(this._polar),this._radius*Math.sin(this._polar)*Math.cos(this._azimuth)];if(1===i.worldUp[2]){const e=c[1];c[1]=c[2],c[2]=e}const h=d.lenVec3(d.subVec3(i.look,i.eye,d.vec3())),u=this.getPivotPos();d.addVec3(c,u);let p=d.lookAtMat4v(c,u,i.worldUp);p=d.inverseMat4(p);const f=d.transformVec3(p,this._cameraOffset);p[12]-=f[0],p[13]-=f[1],p[14]-=f[2];const m=[p[8],p[9],p[10]];i.eye=[p[12],p[13],p[14]],d.subVec3(i.eye,d.mulVec3Scalar(m,h),i.look),i.up=[p[4],p[5],p[6]],this.showPivot()}showPivot(){this._shown||(this._pivotElement&&(this.updatePivotElement(),this._pivotElement.style.visibility="visible"),this._pivotSphereEnabled&&(this.destroyPivotSphere(),this.createPivotSphere()),this._shown=!0)}hidePivot(){this._shown&&(this._pivotElement&&(this._pivotElement.style.visibility="hidden"),this._pivotSphereEnabled&&this.destroyPivotSphere(),this._shown=!1)}endPivot(){this._pivoting=!1}destroy(){this.destroyPivotSphere(),this._scene.camera.off(this._onViewMatrix),this._scene.camera.off(this._onProjMatrix),this._scene.off(this._onTick)}}class hd{constructor(e,t){this._scene=e.scene,this._cameraControl=e,this._scene.canvas.canvas.oncontextmenu=function(e){e.preventDefault()},this._configs=t,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.scheduleSnapOrPick=!1,this.pickCursorPos=d.vec2(),this.picked=!1,this.pickedSurface=!1,this.pickResult=null,this._lastPickedEntityId=null,this._lastHash=null,this._needFireEvents=0}update(){if(!this._configs.pointerEnabled)return;if(!this.schedulePickEntity&&!this.schedulePickSurface)return;const e=`${~~this.pickCursorPos[0]}-${~~this.pickCursorPos[1]}-${this.scheduleSnapOrPick}-${this.schedulePickSurface}-${this.schedulePickEntity}`;if(this._lastHash===e)return;this.picked=!1,this.pickedSurface=!1,this.snappedOrPicked=!1,this.hoveredSnappedOrSurfaceOff=!1;const t=this._cameraControl.hasSubs("hoverSurface");if(this.scheduleSnapOrPick){const e=this._scene.pick({canvasPos:this.pickCursorPos,snapRadius:this._configs.snapRadius,snapToVertex:this._configs.snapToVertex,snapToEdge:this._configs.snapToEdge});e&&(e.snappedToEdge||e.snappedToVertex)?(this.snapPickResult=e,this.snappedOrPicked=!0,this._needFireEvents++):(this.schedulePickSurface=!0,this.snapPickResult=null)}if(this.schedulePickSurface&&this.pickResult&&this.pickResult.worldPos){const e=this.pickResult.canvasPos;if(e[0]===this.pickCursorPos[0]&&e[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!0,this._needFireEvents+=t?1:0,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.scheduleSnapOrPick?this.snappedOrPicked=!0:this.hoveredSnappedOrSurfaceOff=!0,void(this.scheduleSnapOrPick=!1)}if(this.schedulePickEntity&&this.pickResult&&(this.pickResult.canvasPos||this.pickResult.snappedCanvasPos)){const e=this.pickResult.canvasPos||this.pickResult.snappedCanvasPos;if(e[0]===this.pickCursorPos[0]&&e[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!1,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}this.schedulePickSurface||this.scheduleSnapOrPick&&!this.snapPickResult?(this.pickResult=this._scene.pick({pickSurface:!0,pickSurfaceNormal:!1,canvasPos:this.pickCursorPos}),this.pickResult?(this.picked=!0,this.scheduleSnapOrPick?this.snappedOrPicked=!0:this.pickedSurface=!0,this._needFireEvents++):this.scheduleSnapOrPick&&(this.hoveredSnappedOrSurfaceOff=!0,this._needFireEvents++)):(this.pickResult=this._scene.pick({canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!1,this._needFireEvents++)),this.scheduleSnapOrPick=!1,this.schedulePickEntity=!1,this.schedulePickSurface=!1}fireEvents(){if(0!==this._needFireEvents){if(this.hoveredSnappedOrSurfaceOff&&this._cameraControl.fire("hoverSnapOrSurfaceOff",{canvasPos:this.pickCursorPos,pointerPos:this.pickCursorPos},!0),this.snappedOrPicked)if(this.snapPickResult){const e=new uh;e.entity=this.snapPickResult.entity,e.snappedToVertex=this.snapPickResult.snappedToVertex,e.snappedToEdge=this.snapPickResult.snappedToEdge,e.worldPos=this.snapPickResult.worldPos,e.canvasPos=this.pickCursorPos,e.snappedCanvasPos=this.snapPickResult.snappedCanvasPos,this._cameraControl.fire("hoverSnapOrSurface",e,!0),this.snapPickResult=null}else this._cameraControl.fire("hoverSnapOrSurface",this.pickResult,!0);if(this.picked&&this.pickResult&&(this.pickResult.entity||this.pickResult.worldPos)){if(this.pickResult.entity){const e=this.pickResult.entity.id;this._lastPickedEntityId!==e&&(void 0!==this._lastPickedEntityId&&this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._cameraControl.fire("hoverEnter",this.pickResult,!0),this._lastPickedEntityId=e)}this._cameraControl.fire("hover",this.pickResult,!0),this.pickResult.worldPos&&(this.pickedSurface=!0,this._cameraControl.fire("hoverSurface",this.pickResult,!0))}else void 0!==this._lastPickedEntityId&&(this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),this._cameraControl.fire("hoverOff",{canvasPos:this.pickCursorPos},!0);this.pickResult=null,this._needFireEvents=0}}}const ud=d.vec2();class dd{constructor(e,t,i,s,r){this._scene=e;const o=t.pickController,n=t.cameraControl;let a,l,A,c=0,h=0,u=0,p=0,f=!1;const m=d.vec3();let g=!0;const _=this._scene.canvas.canvas,v=[];function b(e=!0){c=s.pointerCanvasPos[0],h=s.pointerCanvasPos[1],u=s.pointerCanvasPos[0],p=s.pointerCanvasPos[1],e&&(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickSurface=!0,o.update(),o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(f=!0,m.set(o.pickResult.worldPos)):f=!1)}document.addEventListener("keydown",this._documentKeyDownHandler=t=>{if(!i.active||!i.pointerEnabled||!e.input.keyboardEnabled)return;const s=t.keyCode;v[s]=!0}),document.addEventListener("keyup",this._documentKeyUpHandler=t=>{if(!i.active||!i.pointerEnabled||!e.input.keyboardEnabled)return;const s=t.keyCode;v[s]=!1}),document.addEventListener("visibilitychange",this._onVisibilityChange=()=>{v.splice(0)}),window.addEventListener("blur",this._onBlur=()=>{v.splice(0)}),_.addEventListener("mousedown",this._mouseDownHandler=t=>{if(i.active&&i.pointerEnabled)switch(t.which){case 1:v[e.input.KEY_SHIFT]||i.planView?(a=!0,v[e.input.MOUSE_LEFT_BUTTON]=!0,b()):(a=!0,v[e.input.MOUSE_LEFT_BUTTON]=!0,b(!1));break;case 2:l=!0,v[e.input.MOUSE_MIDDLE_BUTTON]=!0,b();break;case 3:A=!0,v[e.input.MOUSE_RIGHT_BUTTON]=!0,i.panRightClick&&b()}}),document.addEventListener("mousemove",this._documentMouseMoveHandler=t=>{if(!i.active||!i.pointerEnabled)return;if(!a&&!l&&!A)return;const o=e.canvas.boundary,u=o[2],p=o[3],g=s.pointerCanvasPos[0],_=s.pointerCanvasPos[1],b=i.planView||n._isKeyDownForAction(n.MOUSE_PAN,v),y=n._isKeyDownForAction(n.MOUSE_ROTATE,v),w=document.pointerLockElement?t.movementX:g-c,B=document.pointerLockElement?t.movementY:_-h;if(b){const t=e.camera;if("perspective"===t.projection){const i=Math.abs(f?d.lenVec3(d.subVec3(m,e.camera.eye,[])):e.camera.eyeLookDist)*Math.tan(t.perspective.fov/2*Math.PI/180);r.panDeltaX+=1.5*w*i/p,r.panDeltaY+=1.5*B*i/p}else r.panDeltaX+=.5*t.ortho.scale*(w/p),r.panDeltaY+=.5*t.ortho.scale*(B/p)}else y&&(i.planView||(i.firstPerson?(r.rotateDeltaY-=w/u*i.dragRotationRate/2,r.rotateDeltaX+=B/p*(i.dragRotationRate/4)):(r.rotateDeltaY-=w/u*(1.5*i.dragRotationRate),r.rotateDeltaX+=B/p*(1.5*i.dragRotationRate))));c=g,h=_}),_.addEventListener("mousemove",this._canvasMouseMoveHandler=e=>{i.active&&i.pointerEnabled&&s.mouseover&&(g=!0)}),document.addEventListener("mouseup",this._documentMouseUpHandler=t=>{if(i.active&&i.pointerEnabled)switch(t.which){case 1:case 2:case 3:a=!1,l=!1,A=!1,v[e.input.MOUSE_LEFT_BUTTON]=!1,v[e.input.MOUSE_MIDDLE_BUTTON]=!1,v[e.input.MOUSE_RIGHT_BUTTON]=!1}}),_.addEventListener("mouseup",this._mouseUpHandler=e=>{if(i.active&&i.pointerEnabled){if(3===e.which){!function(e,t){if(e){let i=e.target,s=0,r=0,o=0,n=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,o+=i.scrollLeft,n+=i.scrollTop,i=i.offsetParent;t[0]=e.pageX+o-s,t[1]=e.pageY+n-r}else e=window.event,t[0]=e.x,t[1]=e.y}(e,ud);const i=ud[0],s=ud[1];Math.abs(i-u)<3&&Math.abs(s-p)<3&&t.cameraControl.fire("rightClick",{pagePos:[Math.round(e.pageX),Math.round(e.pageY)],canvasPos:ud,event:e},!0)}_.style.removeProperty("cursor")}}),_.addEventListener("mouseenter",this._mouseEnterHandler=()=>{i.active&&i.pointerEnabled});const y=1/60;let w=null;_.addEventListener("wheel",this._mouseWheelHandler=e=>{if(!(i.active&&i.pointerEnabled&&i.zoomOnMouseWheel&&n._isKeyDownForAction(n.MOUSE_DOLLY,v)))return;const t=performance.now()/1e3;var o=null!==w?t-w:0;w=t,o>.05&&(o=.05),o<y&&(o=y);const a=Math.max(-1,Math.min(1,40*-e.deltaY));if(0===a)return;const l=a/Math.abs(a);r.dollyDelta+=-l*o*i.mouseWheelDollyRate,g&&(s.followPointerDirty=!0,g=!1)},{passive:!0})}reset(){}destroy(){const e=this._scene.canvas.canvas;document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler),document.removeEventListener("visibilitychange",this._onVisibilityChange),window.removeEventListener("blur",this._onBlur),e.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mousemove",this._documentMouseMoveHandler),e.removeEventListener("mousemove",this._canvasMouseMoveHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._mouseUpHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("wheel",this._mouseWheelHandler)}}const pd=d.vec3(),fd=d.vec3(),md=d.vec3(),gd=d.vec3(),_d=d.vec3(),vd={eye:d.vec3(),look:d.vec3(),up:d.vec3()};class bd{constructor(e,t,i,s){this._scene=e;const r=t.cameraControl,o=e.camera;this._onSceneKeyDown=e.input.on("keydown",(()=>{if(!i.active||!i.pointerEnabled||!e.input.keyboardEnabled)return;if(i.keyboardEnabledOnlyIfMouseover&&!s.mouseover)return;const n=r._isKeyDownForAction(r.AXIS_VIEW_RIGHT),a=r._isKeyDownForAction(r.AXIS_VIEW_BACK),l=r._isKeyDownForAction(r.AXIS_VIEW_LEFT),A=r._isKeyDownForAction(r.AXIS_VIEW_FRONT),c=r._isKeyDownForAction(r.AXIS_VIEW_TOP),h=r._isKeyDownForAction(r.AXIS_VIEW_BOTTOM);if(!(n||a||l||A||c||h))return;const u=e.aabb,p=d.getAABB3Diag(u);d.getAABB3Center(u,pd);const f=Math.abs(p/Math.tan(t.cameraFlight.fitFOV*d.DEGTORAD)),m=1.1*p;vd.orthoScale=m,n?(vd.eye.set(d.addVec3(pd,d.mulVec3Scalar(o.worldRight,f,fd),_d)),vd.look.set(pd),vd.up.set(o.worldUp)):a?(vd.eye.set(d.addVec3(pd,d.mulVec3Scalar(o.worldForward,f,fd),_d)),vd.look.set(pd),vd.up.set(o.worldUp)):l?(vd.eye.set(d.addVec3(pd,d.mulVec3Scalar(o.worldRight,-f,fd),_d)),vd.look.set(pd),vd.up.set(o.worldUp)):A?(vd.eye.set(d.addVec3(pd,d.mulVec3Scalar(o.worldForward,-f,fd),_d)),vd.look.set(pd),vd.up.set(o.worldUp)):c?(vd.eye.set(d.addVec3(pd,d.mulVec3Scalar(o.worldUp,f,fd),_d)),vd.look.set(pd),vd.up.set(d.normalizeVec3(d.mulVec3Scalar(o.worldForward,1,md),gd))):h&&(vd.eye.set(d.addVec3(pd,d.mulVec3Scalar(o.worldUp,-f,fd),_d)),vd.look.set(pd),vd.up.set(d.normalizeVec3(d.mulVec3Scalar(o.worldForward,-1,md)))),!i.firstPerson&&i.followPointer&&t.pivotController.setPivotPos(pd),t.cameraFlight.duration>0?t.cameraFlight.flyTo(vd,(()=>{t.pivotController.getPivoting()&&i.followPointer&&t.pivotController.showPivot()})):(t.cameraFlight.jumpTo(vd),t.pivotController.getPivoting()&&i.followPointer&&t.pivotController.showPivot())}))}reset(){}destroy(){this._scene.input.off(this._onSceneKeyDown)}}class yd{constructor(e,t,i,s,r){this._scene=e;const o=t.pickController,n=t.pivotController,a=t.cameraControl;this._clicks=0,this._timeout=null,this._lastPickedEntityId=null,this._lastClickedWorldPos=null;let l=!1,A=!1;const c=this._scene.canvas.canvas,h=i=>{let s;i&&i.worldPos&&(s=i.worldPos);const r=i&&i.entity?i.entity.aabb:e.aabb;if(s){const i=e.camera;d.subVec3(i.eye,i.look,[]),t.cameraFlight.flyTo({aabb:r})}else t.cameraFlight.flyTo({aabb:r})},u=e.tickify(this._canvasMouseMoveHandler=t=>{if(!i.active||!i.pointerEnabled)return;if(l||A)return;if(a.hasSubs("rayMove")){const t=d.vec3(),i=d.vec3();d.canvasPosToWorldRay(e.canvas.canvas,e.camera.viewMatrix,e.camera.projMatrix,e.camera.projection,s.pointerCanvasPos,t,i),a.fire("rayMove",{canvasPos:s.pointerCanvasPos,ray:{origin:t,direction:i,canvasPos:s.pointerCanvasPos}},!0)}const r=a.hasSubs("hover"),n=a.hasSubs("hoverEnter"),c=a.hasSubs("hoverOut"),h=a.hasSubs("hoverOff"),u=a.hasSubs("hoverSurface"),p=a.hasSubs("hoverSnapOrSurface");if(r||n||c||h||u||p)if(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=!0,o.schedulePickSurface=u,o.scheduleSnapOrPick=p,o.update(),o.pickResult){if(o.pickResult.entity){const t=o.pickResult.entity.id;this._lastPickedEntityId!==t&&(void 0!==this._lastPickedEntityId&&a.fire("hoverOut",{entity:e.objects[this._lastPickedEntityId]},!0),a.fire("hoverEnter",o.pickResult,!0),this._lastPickedEntityId=t)}a.fire("hover",o.pickResult,!0),(o.pickResult.worldPos||o.pickResult.snappedWorldPos)&&a.fire("hoverSurface",o.pickResult,!0)}else void 0!==this._lastPickedEntityId&&(a.fire("hoverOut",{entity:e.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),a.fire("hoverOff",{canvasPos:o.pickCursorPos},!0)});c.addEventListener("mousemove",u),c.addEventListener("mousedown",this._canvasMouseDownHandler=t=>{1===t.which&&(l=!0),3===t.which&&(A=!0);if(1===t.which&&i.active&&i.pointerEnabled&&(s.mouseDownClientX=t.clientX,s.mouseDownClientY=t.clientY,s.mouseDownCursorX=s.pointerCanvasPos[0],s.mouseDownCursorY=s.pointerCanvasPos[1],!i.firstPerson&&i.followPointer&&(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickSurface=!0,o.update(),1===t.which))){const t=o.pickResult;t&&t.worldPos?(n.setPivotPos(t.worldPos),n.startPivot(),this._lastClickedWorldPos=t.worldPos.slice()):(i.smartPivot?n.setCanvasPivotPos(s.pointerCanvasPos):this._lastClickedWorldPos?n.setPivotPos(this._lastClickedWorldPos):n.setPivotPos(e.camera.look),n.startPivot())}}),document.addEventListener("mouseup",this._documentMouseUpHandler=e=>{1===e.which&&(l=!1),3===e.which&&(A=!1),n.getPivoting()&&n.endPivot()}),c.addEventListener("mouseup",this._canvasMouseUpHandler=r=>{if(!i.active||!i.pointerEnabled)return;if(!(1===r.which))return;if(n.hidePivot(),Math.abs(r.clientX-s.mouseDownClientX)>3||Math.abs(r.clientY-s.mouseDownClientY)>3)return;const l=a.hasSubs("picked"),A=a.hasSubs("pickedNothing"),c=a.hasSubs("pickedSurface"),u=a.hasSubs("doublePicked"),p=a.hasSubs("doublePickedSurface"),f=a.hasSubs("doublePickedNothing");if(!(i.doublePickFlyTo||u||p||f))return(l||A||c)&&(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=!0,o.schedulePickSurface=c,o.update(),o.pickResult?(a.fire("picked",o.pickResult,!0),o.pickedSurface&&a.fire("pickedSurface",o.pickResult,!0)):a.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0)),void(this._clicks=0);if(this._clicks++,1===this._clicks){o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=i.doublePickFlyTo,o.schedulePickSurface=c,o.update();const e=o.pickResult,r=o.pickedSurface;this._timeout=setTimeout((()=>{e?(a.fire("picked",e,!0),r&&(a.fire("pickedSurface",e,!0),!i.firstPerson&&i.followPointer&&(t.pivotController.setPivotPos(e.worldPos),t.pivotController.startPivot()&&t.pivotController.showPivot()))):a.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0),this._clicks=0}),i.doubleClickTimeFrame)}else{if(null!==this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null),o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=i.doublePickFlyTo||u||p,o.schedulePickSurface=o.schedulePickEntity&&p,o.update(),o.pickResult){if(a.fire("doublePicked",o.pickResult,!0),o.pickedSurface&&a.fire("doublePickedSurface",o.pickResult,!0),i.doublePickFlyTo&&(h(o.pickResult),!i.firstPerson&&i.followPointer)){const e=o.pickResult.entity.aabb,i=d.getAABB3Center(e);t.pivotController.setPivotPos(i),t.pivotController.startPivot()&&t.pivotController.showPivot()}}else if(a.fire("doublePickedNothing",{canvasPos:s.pointerCanvasPos},!0),i.doublePickFlyTo&&(h(),!i.firstPerson&&i.followPointer)){const i=e.aabb,s=d.getAABB3Center(i);t.pivotController.setPivotPos(s),t.pivotController.startPivot()&&t.pivotController.showPivot()}this._clicks=0}},!1)}reset(){this._clicks=0,this._lastPickedEntityId=null,this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("mousemove",this._canvasMouseMoveHandler),e.removeEventListener("mousedown",this._canvasMouseDownHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),e.removeEventListener("mouseup",this._canvasMouseUpHandler),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}}class wd{constructor(e,t,i,s,r){this._scene=e;const o=e.input,n=[];e.canvas.canvas;let a=!0;this._onSceneMouseMove=o.on("mousemove",(()=>{a=!0})),this._onSceneKeyDown=o.on("keydown",(t=>{i.active&&i.pointerEnabled&&e.input.keyboardEnabled&&(i.keyboardEnabledOnlyIfMouseover&&!s.mouseover||(n[t]=!0))})),this._onSceneKeyUp=o.on("keyup",(s=>{i.active&&i.pointerEnabled&&e.input.keyboardEnabled&&(n[s]=!1,t.pivotController.getPivoting()&&t.pivotController.endPivot())})),document.addEventListener("visibilitychange",this._onVisibilityChange=()=>{n.splice(0)}),window.addEventListener("blur",this._onBlur=()=>{n.splice(0)}),this._onTick=e.on("tick",(l=>{if(!i.active||!i.pointerEnabled||!e.input.keyboardEnabled)return;if(i.keyboardEnabledOnlyIfMouseover&&!s.mouseover)return;const A=t.cameraControl,c=l.deltaTime/1e3;if(!i.planView){const e=A._isKeyDownForAction(A.ROTATE_Y_POS,n),s=A._isKeyDownForAction(A.ROTATE_Y_NEG,n),o=A._isKeyDownForAction(A.ROTATE_X_POS,n),a=A._isKeyDownForAction(A.ROTATE_X_NEG,n),l=c*i.keyboardRotationRate;(e||s||o||a)&&(!i.firstPerson&&i.followPointer&&t.pivotController.startPivot(),e?r.rotateDeltaY+=l:s&&(r.rotateDeltaY-=l),o?r.rotateDeltaX+=l:a&&(r.rotateDeltaX-=l),!i.firstPerson&&i.followPointer&&t.pivotController.startPivot())}if(!n[o.KEY_CTRL]&&!n[o.KEY_ALT]){const e=A._isKeyDownForAction(A.DOLLY_BACKWARDS,n),o=A._isKeyDownForAction(A.DOLLY_FORWARDS,n);if(e||o){const n=c*i.keyboardDollyRate;!i.firstPerson&&i.followPointer&&t.pivotController.startPivot(),o?r.dollyDelta-=n:e&&(r.dollyDelta+=n),a&&(s.followPointerDirty=!0,a=!1)}}const h=A._isKeyDownForAction(A.PAN_FORWARDS,n),u=A._isKeyDownForAction(A.PAN_BACKWARDS,n),d=A._isKeyDownForAction(A.PAN_LEFT,n),p=A._isKeyDownForAction(A.PAN_RIGHT,n),f=A._isKeyDownForAction(A.PAN_UP,n),m=A._isKeyDownForAction(A.PAN_DOWN,n),g=(n[o.KEY_ALT]?.3:1)*c*i.keyboardPanRate;(h||u||d||p||f||m)&&(!i.firstPerson&&i.followPointer&&t.pivotController.startPivot(),m?r.panDeltaY+=g:f&&(r.panDeltaY+=-g),p?r.panDeltaX+=-g:d&&(r.panDeltaX+=g),u?r.panDeltaZ+=g:h&&(r.panDeltaZ+=-g))}))}reset(){}destroy(){this._scene.off(this._onTick),this._scene.input.off(this._onSceneMouseMove),this._scene.input.off(this._onSceneKeyDown),document.removeEventListener("visibilitychange",this._onVisibilityChange),window.removeEventListener("blur",this._onBlur),this._scene.input.off(this._onSceneKeyUp)}}const Bd=d.vec3();class Pd{constructor(e,t,i,s,r){this._scene=e;const o=e.camera,n=t.pickController,a=t.pivotController,l=t.panController,A=t.cameraControl;let c=1,h=1,u=null;this._onTick=e.on("tick",(()=>{if(!i.active||!i.pointerEnabled)return;let t="default";if(Math.abs(r.dollyDelta)<.001&&(r.dollyDelta=0),Math.abs(r.rotateDeltaX)<.001&&(r.rotateDeltaX=0),Math.abs(r.rotateDeltaY)<.001&&(r.rotateDeltaY=0),0===r.rotateDeltaX&&0===r.rotateDeltaY||(r.dollyDelta=0),i.followPointer){if(--c<=0&&(c=1,0!==r.dollyDelta)){if(0===r.rotateDeltaY&&0===r.rotateDeltaX&&i.followPointer&&s.followPointerDirty&&(n.pickCursorPos=s.pointerCanvasPos,n.schedulePickSurface=!0,n.update(),n.pickResult&&n.pickResult.worldPos?u=n.pickResult.worldPos:(h=1,u=null),s.followPointerDirty=!1),u){const t=Math.abs(d.lenVec3(d.subVec3(u,e.camera.eye,Bd)));h=t/i.dollyProximityThreshold}h<i.dollyMinSpeed&&(h=i.dollyMinSpeed)}}else h=1,u=null;const p=r.dollyDelta*h;if(0===r.rotateDeltaY&&0===r.rotateDeltaX||(!i.firstPerson&&i.followPointer&&a.getPivoting()?(a.continuePivot(r.rotateDeltaY,r.rotateDeltaX),a.showPivot()):(0!==r.rotateDeltaX&&(i.firstPerson?o.pitch(-r.rotateDeltaX):o.orbitPitch(r.rotateDeltaX)),0!==r.rotateDeltaY&&(i.firstPerson?o.yaw(r.rotateDeltaY):o.orbitYaw(r.rotateDeltaY))),r.rotateDeltaX*=i.rotationInertia,r.rotateDeltaY*=i.rotationInertia,t=A._cursors.rotate),Math.abs(r.panDeltaX)<.001&&(r.panDeltaX=0),Math.abs(r.panDeltaY)<.001&&(r.panDeltaY=0),Math.abs(r.panDeltaZ)<.001&&(r.panDeltaZ=0),0!==r.panDeltaX||0!==r.panDeltaY||0!==r.panDeltaZ){const e=d.vec3();let s,n;if(e[0]=r.panDeltaX,e[1]=r.panDeltaY,e[2]=r.panDeltaZ,i.constrainVertical){o.xUp?(s=o.eye[0],n=o.look[0]):o.yUp?(s=o.eye[1],n=o.look[1]):o.zUp&&(s=o.eye[2],n=o.look[2]),o.pan(e);const t=o.eye,i=o.look;o.xUp?(t[0]=s,i[0]=n):o.yUp?(t[1]=s,i[1]=n):o.zUp&&(t[2]=s,i[2]=n),o.eye=t,o.look=i}else o.pan(e);t=A._cursors.pan}if(r.panDeltaX*=i.panInertia,r.panDeltaY*=i.panInertia,r.panDeltaZ*=i.panInertia,0!==p){if(t=p<0?A._cursors.dollyForward:A._cursors.dollyBackward,i.firstPerson){let e,t;if(i.constrainVertical&&(o.xUp?(e=o.eye[0],t=o.look[0]):o.yUp?(e=o.eye[1],t=o.look[1]):o.zUp&&(e=o.eye[2],t=o.look[2])),i.followPointer){l.dollyToCanvasPos(u,s.pointerCanvasPos,-p)&&(s.followPointerDirty=!0)}else o.pan([0,0,p]),o.ortho.scale=o.ortho.scale-p;if(i.constrainVertical){const i=o.eye,s=o.look;o.xUp?(i[0]=e,s[0]=t):o.yUp?(i[1]=e,s[1]=t):o.zUp&&(i[2]=e,s[2]=t),o.eye=i,o.look=s}}else if(i.planView)if(i.followPointer){l.dollyToCanvasPos(u,s.pointerCanvasPos,-p)&&(s.followPointerDirty=!0)}else o.ortho.scale=o.ortho.scale+p,o.zoom(p);else if(i.followPointer){l.dollyToCanvasPos(u,s.pointerCanvasPos,-p)&&(s.followPointerDirty=!0)}else o.ortho.scale=o.ortho.scale+p,o.zoom(p);r.dollyDelta*=i.dollyInertia}n.fireEvents(),document.body.style.cursor=t}))}destroy(){this._scene.off(this._onTick)}}class xd{constructor(e,t,i,s,r){this._scene=e;const o=this._scene.canvas.canvas;o.addEventListener("mouseenter",this._mouseEnterHandler=()=>{s.mouseover=!0}),o.addEventListener("mouseleave",this._mouseLeaveHandler=()=>{s.mouseover=!1,o.style.cursor=null}),document.addEventListener("mousemove",this._mouseMoveHandler=e=>{Cd(e,o,s.pointerCanvasPos)}),o.addEventListener("mousedown",this._mouseDownHandler=e=>{i.active&&i.pointerEnabled&&(Cd(e,o,s.pointerCanvasPos),s.mouseover=!0)}),o.addEventListener("mouseup",this._mouseUpHandler=e=>{i.active&&i.pointerEnabled})}reset(){}destroy(){const e=this._scene.canvas.canvas;document.removeEventListener("mousemove",this._mouseMoveHandler),e.removeEventListener("mouseenter",this._mouseEnterHandler),e.removeEventListener("mouseleave",this._mouseLeaveHandler),e.removeEventListener("mousedown",this._mouseDownHandler),e.removeEventListener("mouseup",this._mouseUpHandler)}}function Cd(e,t,i){if(e){const{left:s,top:r}=t.getBoundingClientRect();i[0]=e.clientX-s,i[1]=e.clientY-r}else e=window.event,i[0]=e.x,i[1]=e.y;return i}const Md=function(e,t){if(e){let i=e.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t[0]=e.x,t[1]=e.y;return t};class Ed{constructor(e,t,i,s,r){this._scene=e;const o=t.pickController,n=t.pivotController,a=d.vec2(),l=d.vec2(),A=d.vec2(),c=d.vec2(),h=[],u=this._scene.canvas.canvas;let p=0,f=!1;this._onTick=e.on("tick",(()=>{f=!1})),u.addEventListener("touchstart",this._canvasTouchStartHandler=t=>{if(!i.active||!i.pointerEnabled)return;t.preventDefault();const r=t.touches,l=t.changedTouches;for(s.touchStartTime=Date.now(),1===r.length&&1===l.length&&(Md(r[0],a),i.followPointer&&(o.pickCursorPos=a,o.schedulePickSurface=!0,o.update(),i.planView||(o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(n.setPivotPos(o.pickResult.worldPos),!i.firstPerson&&n.startPivot()&&n.showPivot()):(i.smartPivot?n.setCanvasPivotPos(s.pointerCanvasPos):n.setPivotPos(e.camera.look),!i.firstPerson&&n.startPivot()&&n.showPivot()))));h.length<r.length;)h.push(d.vec2());for(let e=0,t=r.length;e<t;++e)Md(r[e],h[e]);p=r.length}),u.addEventListener("touchend",this._canvasTouchEndHandler=()=>{n.getPivoting()&&(n.endPivot(),n.hidePivot())}),u.addEventListener("touchmove",this._canvasTouchMoveHandler=t=>{if(!i.active||!i.pointerEnabled)return;if(t.stopPropagation(),t.preventDefault(),f)return;f=!0;const n=e.canvas.boundary,a=n[2],u=n[3],m=t.touches;if(t.touches.length===p){if(1===p){Md(m[0],l),d.subVec2(l,h[0],c);const t=c[0],o=c[1];if(null!==s.longTouchTimeout&&(Math.abs(t)>i.longTapRadius||Math.abs(o)>i.longTapRadius)&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null),i.planView){const s=e.camera;if("perspective"===s.projection){const n=Math.abs(e.camera.eyeLookDist)*Math.tan(s.perspective.fov/2*Math.PI/180);r.panDeltaX+=t*n/u*i.touchPanRate,r.panDeltaY+=o*n/u*i.touchPanRate}else r.panDeltaX+=.5*s.ortho.scale*(t/u)*i.touchPanRate,r.panDeltaY+=.5*s.ortho.scale*(o/u)*i.touchPanRate}else r.rotateDeltaY-=t/a*(1*i.dragRotationRate),r.rotateDeltaX+=o/u*(1.5*i.dragRotationRate)}else if(2===p){const t=m[0],n=m[1];Md(t,l),Md(n,A);const a=d.geometricMeanVec2(h[0],h[1]),c=d.geometricMeanVec2(l,A),p=d.vec2();d.subVec2(a,c,p);const f=p[0],g=p[1],_=e.camera,v=d.distVec2([t.pageX,t.pageY],[n.pageX,n.pageY]),b=(d.distVec2(h[0],h[1])-v)*i.touchDollyRate;if(r.dollyDelta=b,Math.abs(b)<1)if("perspective"===_.projection){const t=o.pickResult?o.pickResult.worldPos:e.center,s=Math.abs(d.lenVec3(d.subVec3(t,e.camera.eye,[])))*Math.tan(_.perspective.fov/2*Math.PI/180);r.panDeltaX-=f*s/u*i.touchPanRate,r.panDeltaY-=g*s/u*i.touchPanRate}else r.panDeltaX-=.5*_.ortho.scale*(f/u)*i.touchPanRate,r.panDeltaY-=.5*_.ortho.scale*(g/u)*i.touchPanRate;s.pointerCanvasPos=c}for(let e=0;e<p;++e)Md(m[e],h[e])}})}reset(){}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler),e.removeEventListener("touchmove",this._canvasTouchMoveHandler),this._scene.off(this._onTick)}}const Fd=function(e,t){if(e){let i=e.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t[0]=e.x,t[1]=e.y;return t};class Id{constructor(e,t,i,s,r){this._scene=e;const o=t.pickController,n=t.cameraControl;let a;const l=[],A=new Float32Array(2);let c=-1,h=-1;const u=this._scene.canvas.canvas,p=i=>{let s;i&&i.worldPos&&(s=i.worldPos);const r=i?i.entity.aabb:e.aabb;if(s){const i=e.camera;d.subVec3(i.eye,i.look,[]),t.cameraFlight.flyTo({aabb:r})}else t.cameraFlight.flyTo({aabb:r})};u.addEventListener("touchstart",this._canvasTouchStartHandler=e=>{if(!i.active||!i.pointerEnabled)return;null!==s.longTouchTimeout&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null);const r=e.touches,o=e.changedTouches;if(a=Date.now(),1===r.length&&1===o.length){c=a,Fd(r[0],A);const o=A[0],n=A[1],l=r[0].pageX,h=r[0].pageY;s.longTouchTimeout=setTimeout((()=>{i.active&&i.pointerEnabled&&t.cameraControl.fire("rightClick",{pagePos:[Math.round(l),Math.round(h)],canvasPos:[Math.round(o),Math.round(n)],event:e},!0),s.longTouchTimeout=null}),i.longTapTimeout)}else c=-1;for(;l.length<r.length;)l.push(new Float32Array(2));for(let e=0,t=r.length;e<t;++e)Fd(r[e],l[e]);l.length=r.length},{passive:!0}),u.addEventListener("touchend",this._canvasTouchEndHandler=e=>{if(!i.active||!i.pointerEnabled)return;const t=Date.now(),r=e.touches,a=e.changedTouches,u=n.hasSubs("pickedSurface");null!==s.longTouchTimeout&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null),0===r.length&&1===a.length&&c>-1&&t-c<150&&(h>-1&&c-h<325?(Fd(a[0],o.pickCursorPos),o.schedulePickEntity=!0,o.schedulePickSurface=u,o.update(),o.pickResult?(o.pickResult.touchInput=!0,n.fire("doublePicked",o.pickResult),o.pickedSurface&&n.fire("doublePickedSurface",o.pickResult),i.doublePickFlyTo&&p(o.pickResult)):(n.fire("doublePickedNothing"),i.doublePickFlyTo&&p()),h=-1):d.distVec2(l[0],A)<4&&(Fd(a[0],o.pickCursorPos),o.schedulePickEntity=!0,o.schedulePickSurface=u,o.update(),o.pickResult?(o.pickResult.touchInput=!0,n.fire("picked",o.pickResult),o.pickedSurface&&n.fire("pickedSurface",o.pickResult)):n.fire("pickedNothing"),h=t),c=-1),l.length=r.length;for(let e=0,t=r.length;e<t;++e)l[e][0]=r[e].pageX,l[e][1]=r[e].pageY},{passive:!0})}reset(){}destroy(){const e=this._scene.canvas.canvas;e.removeEventListener("touchstart",this._canvasTouchStartHandler),e.removeEventListener("touchend",this._canvasTouchEndHandler)}}class Td extends R{constructor(e,t={}){super(e,t),this.PAN_LEFT=0,this.PAN_RIGHT=1,this.PAN_UP=2,this.PAN_DOWN=3,this.PAN_FORWARDS=4,this.PAN_BACKWARDS=5,this.ROTATE_X_POS=6,this.ROTATE_X_NEG=7,this.ROTATE_Y_POS=8,this.ROTATE_Y_NEG=9,this.DOLLY_FORWARDS=10,this.DOLLY_BACKWARDS=11,this.AXIS_VIEW_RIGHT=12,this.AXIS_VIEW_BACK=13,this.AXIS_VIEW_LEFT=14,this.AXIS_VIEW_FRONT=15,this.AXIS_VIEW_TOP=16,this.AXIS_VIEW_BOTTOM=17,this.MOUSE_PAN=18,this.MOUSE_ROTATE=19,this.MOUSE_DOLLY=20,this._keyMap={},this.scene.canvas.canvas.oncontextmenu=e=>{e.preventDefault()},this._configs={longTapTimeout:600,longTapRadius:5,active:!0,keyboardLayout:"qwerty",navMode:"orbit",planView:!1,firstPerson:!1,followPointer:!0,doublePickFlyTo:!0,panRightClick:!0,showPivot:!1,pointerEnabled:!0,constrainVertical:!1,smartPivot:!1,doubleClickTimeFrame:250,zoomOnMouseWheel:!0,snapToVertex:true,snapToEdge:true,snapRadius:30,keyboardEnabledOnlyIfMouseover:!0,dragRotationRate:360,keyboardRotationRate:90,rotationInertia:0,keyboardPanRate:1,touchPanRate:1,panInertia:.5,keyboardDollyRate:10,mouseWheelDollyRate:100,touchDollyRate:.2,dollyInertia:0,dollyProximityThreshold:30,dollyMinSpeed:.04},this._states={pointerCanvasPos:d.vec2(),mouseover:!1,followPointerDirty:!0,mouseDownClientX:0,mouseDownClientY:0,mouseDownCursorX:0,mouseDownCursorY:0,touchStartTime:null,activeTouches:[],tapStartPos:d.vec2(),tapStartTime:-1,lastTapTime:-1,longTouchTimeout:null},this._updates={rotateDeltaX:0,rotateDeltaY:0,panDeltaX:0,panDeltaY:0,panDeltaZ:0,dollyDelta:0};const i=this.scene;this._controllers={cameraControl:this,pickController:new hd(this,this._configs),pivotController:new cd(i,this._configs),panController:new id(i),cameraFlight:new se(this,{duration:.5})},this._handlers=[new xd(this.scene,this._controllers,this._configs,this._states,this._updates),new Ed(this.scene,this._controllers,this._configs,this._states,this._updates),new dd(this.scene,this._controllers,this._configs,this._states,this._updates),new bd(this.scene,this._controllers,this._configs,this._states,this._updates),new yd(this.scene,this._controllers,this._configs,this._states,this._updates),new Id(this.scene,this._controllers,this._configs,this._states,this._updates),new wd(this.scene,this._controllers,this._configs,this._states,this._updates)],this._cursors={dollyForward:"zoom-in",dollyBackward:"zoom-out",rotate:"grabbing",pan:"move"},this._cameraUpdater=new Pd(this.scene,this._controllers,this._configs,this._states,this._updates),this.navMode=t.navMode,t.planView&&(this.planView=t.planView),this.constrainVertical=t.constrainVertical,t.keyboardLayout?this.keyboardLayout=t.keyboardLayout:this.keyMap=t.keyMap,this.doublePickFlyTo=t.doublePickFlyTo,this.panRightClick=t.panRightClick,this.active=t.active,this.followPointer=t.followPointer,this.rotationInertia=t.rotationInertia,this.keyboardPanRate=t.keyboardPanRate,this.touchPanRate=t.touchPanRate,this.keyboardRotationRate=t.keyboardRotationRate,this.dragRotationRate=t.dragRotationRate,this.touchDollyRate=t.touchDollyRate,this.dollyInertia=t.dollyInertia,this.dollyProximityThreshold=t.dollyProximityThreshold,this.dollyMinSpeed=t.dollyMinSpeed,this.panInertia=t.panInertia,this.pointerEnabled=!0,this.keyboardDollyRate=t.keyboardDollyRate,this.mouseWheelDollyRate=t.mouseWheelDollyRate}set keyMap(e){if(e=e||"qwerty",y.isString(e)){const t=this.scene.input,i={};switch(e){default:this.error("Unsupported value for 'keyMap': "+e+" defaulting to 'qwerty'");case"qwerty":i[this.PAN_LEFT]=[t.KEY_A],i[this.PAN_RIGHT]=[t.KEY_D],i[this.PAN_UP]=[t.KEY_Z],i[this.PAN_DOWN]=[t.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[t.KEY_W,t.KEY_ADD],i[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[t.KEY_Q,t.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6],i[this.MOUSE_PAN]=[[t.MOUSE_LEFT_BUTTON,t.KEY_SHIFT],this._configs.panRightClick?t.MOUSE_RIGHT_BUTTON:t.MOUSE_MIDDLE_BUTTON],i[this.MOUSE_ROTATE]=[t.MOUSE_LEFT_BUTTON],i[this.MOUSE_DOLLY]=[];break;case"azerty":i[this.PAN_LEFT]=[t.KEY_Q],i[this.PAN_RIGHT]=[t.KEY_D],i[this.PAN_UP]=[t.KEY_W],i[this.PAN_DOWN]=[t.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[t.KEY_Z,t.KEY_ADD],i[this.DOLLY_BACKWARDS]=[t.KEY_S,t.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[t.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[t.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[t.KEY_A,t.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[t.KEY_E,t.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[t.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[t.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[t.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[t.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[t.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[t.KEY_NUM_6],i[this.MOUSE_PAN]=[[t.MOUSE_LEFT_BUTTON,t.KEY_SHIFT],this._configs.panRightClick?t.MOUSE_RIGHT_BUTTON:t.MOUSE_MIDDLE_BUTTON],i[this.MOUSE_ROTATE]=[t.MOUSE_LEFT_BUTTON],i[this.MOUSE_DOLLY]=[]}this._keyMap=i}else{const t=e;this._keyMap=t}}get keyMap(){return this._keyMap}_areAllKeysDown(e,t){if(!t||t.length<=0)return!0;if(!e)return!1;for(let i=0,s=t.length;i<s;i++){if(!e[t[i]])return!1}return!0}_isAnyOtherKeyDown(e,t){for(let i=0,s=e.length;i<s;i++)if(e[i])if(Array.isArray(t)){if(t.indexOf(i)<0)return!0}else if(i!==t)return!0;return!1}_isMouseAction(e){switch(e){case this.MOUSE_ROTATE:case this.MOUSE_DOLLY:case this.MOUSE_PAN:return!0;default:return!1}}_isKeyDownForAction(e,t){const i=this._keyMap[e];if(!i)return!1;if(0===i.length&&this._isMouseAction(e))return!0;t||(t=this.scene.input.keyDown);for(let e=0,s=i.length;e<s;e++){const s=i[e];if(Array.isArray(s)){if(this._areAllKeysDown(t,s)&&!this._isAnyOtherKeyDown(t,s))return!0}else if(t[s]&&!this._isAnyOtherKeyDown(t,s))return!0}return!1}set pivotElement(e){this._controllers.pivotController.setPivotElement(e)}set active(e){e=!1!==e,this._configs.active=e,this._handlers[1]._active=e,this._handlers[5]._active=e}get active(){return this._configs.active}set snapToVertex(e){this._configs.snapToVertex=!!e}get snapToVertex(){return this._configs.snapToVertex}set snapToEdge(e){this._configs.snapToEdge=!!e}get snapToEdge(){return this._configs.snapToEdge}set snapRadius(e){e=e||30,this._configs.snapRadius=e}get snapRadius(){return this._configs.snapRadius}set keyboardEnabledOnlyIfMouseover(e){this._configs.keyboardEnabledOnlyIfMouseover=!!e}get keyboardEnabledOnlyIfMouseover(){return this._configs.keyboardEnabledOnlyIfMouseover}set navMode(e){"firstPerson"!==(e=e||"orbit")&&"orbit"!==e&&"planView"!==e&&(this.error("Unsupported value for navMode: "+e+" - supported values are 'orbit', 'firstPerson' and 'planView' - defaulting to 'orbit'"),e="orbit"),this._configs.firstPerson="firstPerson"===e,this._configs.planView="planView"===e,(this._configs.firstPerson||this._configs.planView)&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this._configs.navMode=e}get navMode(){return this._configs.navMode}set pointerEnabled(e){this._reset(),this._configs.pointerEnabled=!!e}setCursorStyle(e,t){Object.prototype.hasOwnProperty.call(this._cursors,e)?this._cursors={...this._cursors,[e]:t}:console.warn(`Action '${e}' is not valid for cursor styles.`)}getCursorStyle(e){return this._cursors[e]||null}_reset(){for(let e=0,t=this._handlers.length;e<t;e++){const t=this._handlers[e];t.reset&&t.reset()}this._updates.panDeltaX=0,this._updates.panDeltaY=0,this._updates.rotateDeltaX=0,this._updates.rotateDeltaY=0,this._updates.dolyDelta=0}get pointerEnabled(){return this._configs.pointerEnabled}set followPointer(e){this._configs.followPointer=!1!==e}get followPointer(){return this._configs.followPointer}set pivotPos(e){this._controllers.pivotController.setPivotPos(e)}get pivotPos(){return this._controllers.pivotController.getPivotPos()}set dollyToPointer(e){this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer=e}get dollyToPointer(){return this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer}set panToPointer(e){this.warn("panToPointer property is deprecated - replaced with followPointer")}get panToPointer(){return this.warn("panToPointer property is deprecated - replaced with followPointer"),!1}set planView(e){this._configs.planView=!!e,this._configs.firstPerson=!1,this._configs.planView&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this.warn("planView property is deprecated - replaced with navMode")}get planView(){return this.warn("planView property is deprecated - replaced with navMode"),this._configs.planView}set firstPerson(e){this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson=!!e,this._configs.planView=!1,this._configs.firstPerson&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot())}get firstPerson(){return this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson}set constrainVertical(e){this._configs.constrainVertical=!!e}get constrainVertical(){return this._configs.constrainVertical}set doublePickFlyTo(e){this._configs.doublePickFlyTo=!1!==e}get doublePickFlyTo(){return this._configs.doublePickFlyTo}set panRightClick(e){this._configs.panRightClick=!1!==e;const t=this._keyMap[this.MOUSE_PAN];if(t&&t.length>0){const e=this.scene.input;for(let i=0,s=t.length;i<s;i++)this._configs.panRightClick&&t[i]===e.MOUSE_MIDDLE_BUTTON?this._keyMap[this.MOUSE_PAN][i]=e.MOUSE_RIGHT_BUTTON:this._configs.panRightClick||t[i]!==e.MOUSE_RIGHT_BUTTON||(this._keyMap[this.MOUSE_PAN][i]=e.MOUSE_MIDDLE_BUTTON)}}get panRightClick(){return this._configs.panRightClick}set rotationInertia(e){this._configs.rotationInertia=null!=e?e:0}get rotationInertia(){return this._configs.rotationInertia}set keyboardPanRate(e){this._configs.keyboardPanRate=null!=e?e:5}set touchPanRate(e){this._configs.touchPanRate=null!=e?e:1}get touchPanRate(){return this._configs.touchPanRate}get keyboardPanRate(){return this._configs.keyboardPanRate}set keyboardRotationRate(e){this._configs.keyboardRotationRate=null!=e?e:90}get keyboardRotationRate(){return this._configs.keyboardRotationRate}set dragRotationRate(e){this._configs.dragRotationRate=null!=e?e:360}get dragRotationRate(){return this._configs.dragRotationRate}set keyboardDollyRate(e){this._configs.keyboardDollyRate=null!=e?e:15}get keyboardDollyRate(){return this._configs.keyboardDollyRate}set touchDollyRate(e){this._configs.touchDollyRate=null!=e?e:.2}get touchDollyRate(){return this._configs.touchDollyRate}set mouseWheelDollyRate(e){this._configs.mouseWheelDollyRate=null!=e?e:100}get mouseWheelDollyRate(){return this._configs.mouseWheelDollyRate}set dollyInertia(e){this._configs.dollyInertia=null!=e?e:0}get dollyInertia(){return this._configs.dollyInertia}set dollyProximityThreshold(e){this._configs.dollyProximityThreshold=null!=e?e:35}get dollyProximityThreshold(){return this._configs.dollyProximityThreshold}set dollyMinSpeed(e){this._configs.dollyMinSpeed=null!=e?e:.04}get dollyMinSpeed(){return this._configs.dollyMinSpeed}set panInertia(e){this._configs.panInertia=null!=e?e:.5}get panInertia(){return this._configs.panInertia}set keyboardLayout(e){"qwerty"!==(e=e||"qwerty")&&"azerty"!==e&&(this.error("Unsupported value for keyboardLayout - defaulting to 'qwerty'"),e="qwerty"),this._configs.keyboardLayout=e,this.keyMap=this._configs.keyboardLayout}get keyboardLayout(){return this._configs.keyboardLayout}enablePivotSphere(e={}){this._controllers.pivotController.enablePivotSphere(e)}disablePivotSphere(){this._controllers.pivotController.disablePivotSphere()}set smartPivot(e){this._configs.smartPivot=!1!==e}get smartPivot(){return this._configs.smartPivot}set doubleClickTimeFrame(e){this._configs.doubleClickTimeFrame=null!=e?e:250}get doubleClickTimeFrame(){return this._configs.doubleClickTimeFrame}set zoomOnMouseWheel(e){this._configs.zoomOnMouseWheel=!!e}get zoomOnMouseWheel(){return this._configs.zoomOnMouseWheel}destroy(){this._destroyHandlers(),this._destroyControllers(),this._cameraUpdater.destroy(),super.destroy()}_destroyHandlers(){for(let e=0,t=this._handlers.length;e<t;e++){const t=this._handlers[e];t.destroy&&t.destroy()}}_destroyControllers(){for(let e=0,t=this._controllers.length;e<t;e++){const t=this._controllers[e];t.destroy&&t.destroy()}}}class Dd{constructor(e,t,i,s,r){this.name=e,this.type=i,this.value=t,this.valueType=s,this.description=r}}class Sd{constructor(e){if(this.id=e.id,this.originalSystemId=e.originalSystemId,this.metaModels=[],this.name=e.name,this.type=e.type,this.properties=[],e.properties){const t=e.properties;for(let e=0,i=t.length;e<i;e++){const i=t[e];Number.isInteger(i)?this.properties.push(i):this.properties.push(new Dd(i.name,i.value,i.type,i.valueType,i.description))}}}}class Rd{constructor(e){this.metaModels=[],this.id=e.id,this.parentId=e.parentId,this.parent=null,this.originalSystemId=e.originalSystemId,this.name=e.name,this.type=e.type,this.propertySetIds=e.propertySetIds,this.propertySets=[],this.attributes=e.attributes||{},void 0!==e.external&&null!==e.external&&(this.external=e.external)}get metaModel(){return 1==this.metaModels.length?this.metaModels[0]:null}getObjectIDsInSubtree(){const e=[];return function t(i){if(!i)return;e.push(i.id);const s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)t(s[r])}(this),e}withMetaObjectsInSubtree(e){!function t(i){if(!i)return;e(i);const s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)t(s[r])}(this)}getObjectIDsInSubtreeByType(e){const t={};for(var i=0,s=e.length;i<s;i++)t[e[i]]=e[i];const r=[];return function e(i){if(!i)return;t[i.type]&&r.push(i.id);const s=i.children;if(s)for(var o=0,n=s.length;o<n;o++)e(s[o])}(this),r}getJSON(){var e={id:this.id,type:this.type,name:this.name};return this.parent&&(e.parent=this.parent.id),e}}class Ud{constructor(e){this.id=e.id,this.projectId=e.projectId,this.revisionId=e.revisionId,this.author=e.author,this.createdAt=e.createdAt,this.creatingApplication=e.creatingApplication,this.schema=e.schema,this.metaScene=e.metaScene,this.propertySets=[],this.rootMetaObjects=[],this.metaObjects={},this.graph=e.graph||{},this.metaScene.metaModels[this.id]=this,this._propertyLookup=[],this.finalized=!1}get rootMetaObject(){return 1===this.rootMetaObjects.length?this.rootMetaObjects[0]:null}loadData(e,t={}){if(this.finalized)throw"MetaScene already finalized - can't add more data";this._globalizeIDs(e,t);const i=this.metaScene,s=e.properties;if(s)for(let e=0,t=s.length;e<t;e++)this._propertyLookup.push(s[e]);if(e.propertySets)for(let t=0,s=e.propertySets.length;t<s;t++){const s=e.propertySets[t];s.properties||(s.properties=[]);let r=i.propertySets[s.id];r||(r=new Sd({id:s.id,originalSystemId:s.originalSystemId||s.id,type:s.type,name:s.name,properties:s.properties}),i.propertySets[r.id]=r),r.metaModels.push(this),this.propertySets.push(r)}if(e.metaObjects)for(let t=0,s=e.metaObjects.length;t<s;t++){const s=e.metaObjects[t],r=s.id;let o=i.metaObjects[r];if(!o){const e=s.type,t=s.originalSystemId,i=s.propertySets||s.propertySetIds;o=new Rd({id:r,originalSystemId:t,parentId:s.parent,type:e,name:s.name,attributes:s.attributes,propertySetIds:i,external:s.external}),this.metaScene.metaObjects[r]=o,o.metaModels=[]}this.metaObjects[r]=o,s.parent||(this.rootMetaObjects.push(o),i.rootMetaObjects[r]=o),o.metaModels.push(this)}}_decompressProperties(e,t){const i=[];for(let s=0,r=t.length;s<r;s++){const r=t[s];if(Number.isInteger(r)){const o=e[r];o?t[s]=o:i.push(r)}}i.length>0&&console.error(`[MetaModel._decompressProperties] Properties not found: ${i}`)}finalize(){if(this.finalized)throw"MetaScene already finalized - can't re-finalize";const e=this.metaScene;for(let t in e.metaObjects){const i=e.metaObjects[t];if(i.children&&(i.children=[]),i.propertySets&&(i.propertySets=[]),i.propertySetIds)for(let t=0,s=i.propertySetIds.length;t<s;t++){const s=i.propertySetIds[t],r=e.propertySets[s];i.propertySets.push(r)}}for(let t in e.metaObjects){const i=e.metaObjects[t];if(i.parentId){const t=e.metaObjects[i.parentId];t&&(i.parent=t,(t.children||(t.children=[])).push(i))}}for(let t in e.metaObjects){e.metaObjects[t].metaModels=[]}for(let t in e.metaModels){const i=e.metaModels[t];for(let e in i.metaObjects){i.metaObjects[e].metaModels.push(i)}}e.metaObjectsByType={};for(let t in e.metaObjects){const i=e.metaObjects[t],s=i.type;(e.metaObjectsByType[s]||(e.metaObjectsByType[s]={}))[t]=i}if(this.propertySets)for(let e=0,t=this.propertySets.length;e<t;e++){const t=this.propertySets[e];this._decompressProperties(this._propertyLookup,t.properties)}this._propertyLookup=[],this.finalized=!0,this.metaScene.fire("metaModelCreated",this.id)}getJSON(){const e={id:this.id,projectId:this.projectId,author:this.author,createdAt:this.createdAt,schema:this.schema,creatingApplication:this.creatingApplication,metaObjects:[],propertySets:[]},t=Object.values(this.metaObjects);for(let i=0,s=t.length;i<s;i++){const s=t[i],r={id:s.id,originalSystemId:s.originalSystemId,extId:s.extId,type:s.type,name:s.name};s.parent&&(r.parent=s.parent.id),s.attributes&&(r.attributes=s.attributes),s.propertySetIds&&(r.propertySetIds=s.propertySetIds),e.metaObjects.push(r)}for(let t=0,i=this.propertySets.length;t<i;t++){const i=this.propertySets[t],s={id:i.id,originalSystemId:i.originalSystemId,extId:i.extId,type:i.type,name:i.name,propertyies:[]};for(let e=0,t=i.properties.length;e<t;e++){const t=i.properties[e],r={id:t.id,description:t.description,type:t.type,name:t.name,value:t.value,valueType:t.valueType};s.properties.push(r)}e.propertySets.push(s)}return e}_globalizeIDs(e,t){const i=!!t.globalizeObjectIds;if(e.metaObjects)for(let t=0,s=e.metaObjects.length;t<s;t++){const s=e.metaObjects[t];if(s.originalSystemId=s.id,s.parent&&(s.originalParentSystemId=s.parent),i&&(s.id=d.globalizeObjectId(this.id,s.id),s.parent&&(s.parent=d.globalizeObjectId(this.id,s.parent))),i){const e=s.propertySetIds;if(e){const t=[];for(let i=0,s=e.length;i<s;i++)t.push(d.globalizeObjectId(this.id,e[i]));s.propertySetIds=t,s.originalSystemPropertySetIds=e}}else s.originalSystemPropertySetIds=s.propertySetIds}if(e.propertySets)for(let t=0,s=e.propertySets.length;t<s;t++){const s=e.propertySets[t];s.originalSystemId=s.id,i&&(s.id=d.globalizeObjectId(this.id,s.id))}}}class Ld{constructor(e,t){this.viewer=e,this.scene=t,this.metaModels={},this.propertySets={},this.metaObjects={},this.metaObjectsByType={},this.rootMetaObjects={},this._eventSubs={}}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let e=0,s=i.length;e<s;e++)i[e](t)}off(e){}createMetaModel(e,t,i={}){const s=new Ud({metaScene:this,id:e,projectId:t.projectId||"none",revisionId:t.revisionId||"none",author:t.author||"none",createdAt:t.createdAt||"none",creatingApplication:t.creatingApplication||"none",schema:t.schema||"none",propertySets:[]});return s.loadData(t),s.finalize(),s}destroyMetaModel(e){const t=this.metaModels[e];if(t){if(t.propertySets)for(let i=0,s=t.propertySets.length;i<s;i++){const s=t.propertySets[i];if(1===s.metaModels.length&&s.metaModels[0].id===e)delete this.propertySets[s.id];else{const t=[];for(let i=0,r=s.metaModels.length;i<r;i++)s.metaModels[i].id!==e&&t.push(s.metaModels[i]);s.metaModels=t}}if(t.metaObjects)for(let i in t.metaObjects){const s=t.metaObjects[i];1===s.metaModels.length&&s.metaModels[0].id===e?(delete this.metaObjects[i],s.parent||delete this.rootMetaObjects[i]):s.metaModels=s.metaModels.filter((t=>t.id!==e))}for(let e in this.metaObjects){const t=this.metaObjects[e];if(t.children&&(t.children=[]),t.propertySets&&(t.propertySets=[]),t.propertySetIds)for(let e=0,i=t.propertySetIds.length;e<i;e++){const i=t.propertySetIds[e],s=this.propertySets[i];t.propertySets.push(s)}}this.metaObjectsByType={};for(let e in this.metaObjects){const t=this.metaObjects[e],i=t.type;t.children&&(t.children=null),(this.metaObjectsByType[i]||(this.metaObjectsByType[i]={}))[e]=t}for(let e in this.metaObjects){const t=this.metaObjects[e];if(t.parentId){const e=this.metaObjects[t.parentId];e&&(t.parent=e,(e.children||(e.children=[])).push(t))}}delete this.metaModels[e];for(let e in this.metaObjects){this.metaObjects[e].metaModels=[]}for(let e in this.metaModels){const t=this.metaModels[e];for(let e in t.metaObjects){t.metaObjects[e].metaModels.push(t)}}this.fire("metaModelDestroyed",e)}}getObjectIDsByType(e){const t=this.metaObjectsByType[e];return t?Object.keys(t):[]}getObjectIDsInSubtree(e,t,i){const s=[],r=this.metaObjects[e],o=t&&t.length>0?kd(t):null,n=i&&i.length>0?kd(i):null,a=e=>{if(!e)return;var t=!0;(n&&n[e.type]||o&&!o[e.type])&&(t=!1),t&&s.push(e.id);const i=e.children;if(i)for(var r=0,l=i.length;r<l;r++)a(i[r])};return a(r),s}withMetaObjectsInSubtree(e,t){const i=this.metaObjects[e];i&&i.withMetaObjectsInSubtree(t)}}function kd(e){const t={};for(var i=0,s=e.length;i<s;i++)t[e[i]]=!0;return t}
/*!
 * html2canvas 1.4.1 <https://html2canvas.hertzen.com>
 * Copyright (c) 2022 Niklas von Hertzen <https://hertzen.com>
 * Released under MIT License
 */
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var Od=function(e,t){return Od=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},Od(e,t)};function Nd(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}Od(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var Vd=function(){return Vd=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},Vd.apply(this,arguments)};function Qd(e,t,i,s){return new(i||(i=Promise))((function(r,o){function n(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(n,a)}l((s=s.apply(e,t||[])).next())}))}function Hd(e,t){var i,s,r,o,n={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(i)throw new TypeError("Generator is already executing.");for(;n;)try{if(i=1,s&&(r=2&o[0]?s.return:o[0]?s.throw||((r=s.return)&&r.call(s),0):s.next)&&!(r=r.call(s,o[1])).done)return r;switch(s=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return n.label++,{value:o[1],done:!1};case 5:n.label++,s=o[1],o=[0];continue;case 7:o=n.ops.pop(),n.trys.pop();continue;default:if(!(r=n.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){n=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){n.label=o[1];break}if(6===o[0]&&n.label<r[1]){n.label=r[1],r=o;break}if(r&&n.label<r[2]){n.label=r[2],n.ops.push(o);break}r[2]&&n.ops.pop(),n.trys.pop();continue}o=t.call(e,n)}catch(e){o=[6,e],s=0}finally{i=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}function jd(e,t,i){if(i||2===arguments.length)for(var s,r=0,o=t.length;r<o;r++)!s&&r in t||(s||(s=Array.prototype.slice.call(t,0,r)),s[r]=t[r]);return e.concat(s||t)}for(var Gd=function(){function e(e,t,i,s){this.left=e,this.top=t,this.width=i,this.height=s}return e.prototype.add=function(t,i,s,r){return new e(this.left+t,this.top+i,this.width+s,this.height+r)},e.fromClientRect=function(t,i){return new e(i.left+t.windowBounds.left,i.top+t.windowBounds.top,i.width,i.height)},e.fromDOMRectList=function(t,i){var s=Array.from(i).find((function(e){return 0!==e.width}));return s?new e(s.left+t.windowBounds.left,s.top+t.windowBounds.top,s.width,s.height):e.EMPTY},e.EMPTY=new e(0,0,0,0),e}(),zd=function(e,t){return Gd.fromClientRect(e,t.getBoundingClientRect())},Wd=function(e){for(var t=[],i=0,s=e.length;i<s;){var r=e.charCodeAt(i++);if(r>=55296&&r<=56319&&i<s){var o=e.charCodeAt(i++);56320==(64512&o)?t.push(((1023&r)<<10)+(1023&o)+65536):(t.push(r),i--)}else t.push(r)}return t},Xd=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(String.fromCodePoint)return String.fromCodePoint.apply(String,e);var i=e.length;if(!i)return"";for(var s=[],r=-1,o="";++r<i;){var n=e[r];n<=65535?s.push(n):(n-=65536,s.push(55296+(n>>10),n%1024+56320)),(r+1===i||s.length>16384)&&(o+=String.fromCharCode.apply(String,s),s.length=0)}return o},Kd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Zd="undefined"==typeof Uint8Array?[]:new Uint8Array(256),Jd=0;Jd<Kd.length;Jd++)Zd[Kd.charCodeAt(Jd)]=Jd;for(var Yd="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",qd="undefined"==typeof Uint8Array?[]:new Uint8Array(256),$d=0;$d<Yd.length;$d++)qd[Yd.charCodeAt($d)]=$d;for(var ep=function(e,t,i){return e.slice?e.slice(t,i):new Uint16Array(Array.prototype.slice.call(e,t,i))},tp=function(){function e(e,t,i,s,r,o){this.initialValue=e,this.errorValue=t,this.highStart=i,this.highValueIndex=s,this.index=r,this.data=o}return e.prototype.get=function(e){var t;if(e>=0){if(e<55296||e>56319&&e<=65535)return t=((t=this.index[e>>5])<<2)+(31&e),this.data[t];if(e<=65535)return t=((t=this.index[2048+(e-55296>>5)])<<2)+(31&e),this.data[t];if(e<this.highStart)return t=2080+(e>>11),t=this.index[t],t+=e>>5&63,t=((t=this.index[t])<<2)+(31&e),this.data[t];if(e<=1114111)return this.data[this.highValueIndex]}return this.errorValue},e}(),ip="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",sp="undefined"==typeof Uint8Array?[]:new Uint8Array(256),rp=0;rp<ip.length;rp++)sp[ip.charCodeAt(rp)]=rp;var op=10,np=13,ap=15,lp=17,Ap=18,cp=19,hp=20,up=21,dp=22,pp=24,fp=25,mp=26,gp=27,_p=28,vp=30,bp=32,yp=33,wp=34,Bp=35,Pp=37,xp=38,Cp=39,Mp=40,Ep=42,Fp=[9001,65288],Ip=function(e,t){var i,s,r,o=function(e){var t,i,s,r,o,n=.75*e.length,a=e.length,l=0;"="===e[e.length-1]&&(n--,"="===e[e.length-2]&&n--);var A="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array&&void 0!==Uint8Array.prototype.slice?new ArrayBuffer(n):new Array(n),c=Array.isArray(A)?A:new Uint8Array(A);for(t=0;t<a;t+=4)i=qd[e.charCodeAt(t)],s=qd[e.charCodeAt(t+1)],r=qd[e.charCodeAt(t+2)],o=qd[e.charCodeAt(t+3)],c[l++]=i<<2|s>>4,c[l++]=(15&s)<<4|r>>2,c[l++]=(3&r)<<6|63&o;return A}(e),n=Array.isArray(o)?function(e){for(var t=e.length,i=[],s=0;s<t;s+=4)i.push(e[s+3]<<24|e[s+2]<<16|e[s+1]<<8|e[s]);return i}(o):new Uint32Array(o),a=Array.isArray(o)?function(e){for(var t=e.length,i=[],s=0;s<t;s+=2)i.push(e[s+1]<<8|e[s]);return i}(o):new Uint16Array(o),l=ep(a,12,n[4]/2),A=2===n[5]?ep(a,(24+n[4])/2):(i=n,s=Math.ceil((24+n[4])/4),i.slice?i.slice(s,r):new Uint32Array(Array.prototype.slice.call(i,s,r)));return new tp(n[0],n[1],n[2],n[3],l,A)}("KwAAAAAAAAAACA4AUD0AADAgAAACAAAAAAAIABAAGABAAEgAUABYAGAAaABgAGgAYgBqAF8AZwBgAGgAcQB5AHUAfQCFAI0AlQCdAKIAqgCyALoAYABoAGAAaABgAGgAwgDKAGAAaADGAM4A0wDbAOEA6QDxAPkAAQEJAQ8BFwF1AH0AHAEkASwBNAE6AUIBQQFJAVEBWQFhAWgBcAF4ATAAgAGGAY4BlQGXAZ8BpwGvAbUBvQHFAc0B0wHbAeMB6wHxAfkBAQIJAvEBEQIZAiECKQIxAjgCQAJGAk4CVgJeAmQCbAJ0AnwCgQKJApECmQKgAqgCsAK4ArwCxAIwAMwC0wLbAjAA4wLrAvMC+AIAAwcDDwMwABcDHQMlAy0DNQN1AD0DQQNJA0kDSQNRA1EDVwNZA1kDdQB1AGEDdQBpA20DdQN1AHsDdQCBA4kDkQN1AHUAmQOhA3UAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AKYDrgN1AHUAtgO+A8YDzgPWAxcD3gPjA+sD8wN1AHUA+wMDBAkEdQANBBUEHQQlBCoEFwMyBDgEYABABBcDSARQBFgEYARoBDAAcAQzAXgEgASIBJAEdQCXBHUAnwSnBK4EtgS6BMIEyAR1AHUAdQB1AHUAdQCVANAEYABgAGAAYABgAGAAYABgANgEYADcBOQEYADsBPQE/AQEBQwFFAUcBSQFLAU0BWQEPAVEBUsFUwVbBWAAYgVgAGoFcgV6BYIFigWRBWAAmQWfBaYFYABgAGAAYABgAKoFYACxBbAFuQW6BcEFwQXHBcEFwQXPBdMF2wXjBeoF8gX6BQIGCgYSBhoGIgYqBjIGOgZgAD4GRgZMBmAAUwZaBmAAYABgAGAAYABgAGAAYABgAGAAYABgAGIGYABpBnAGYABgAGAAYABgAGAAYABgAGAAYAB4Bn8GhQZgAGAAYAB1AHcDFQSLBmAAYABgAJMGdQA9A3UAmwajBqsGqwaVALMGuwbDBjAAywbSBtIG1QbSBtIG0gbSBtIG0gbdBuMG6wbzBvsGAwcLBxMHAwcbByMHJwcsBywHMQcsB9IGOAdAB0gHTgfSBkgHVgfSBtIG0gbSBtIG0gbSBtIG0gbSBiwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdgAGAALAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdbB2MHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB2kH0gZwB64EdQB1AHUAdQB1AHUAdQB1AHUHfQdgAIUHjQd1AHUAlQedB2AAYAClB6sHYACzB7YHvgfGB3UAzgfWBzMB3gfmB1EB7gf1B/0HlQENAQUIDQh1ABUIHQglCBcDLQg1CD0IRQhNCEEDUwh1AHUAdQBbCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIcAh3CHoIMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIgggwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAALAcsBywHLAcsBywHLAcsBywHLAcsB4oILAcsB44I0gaWCJ4Ipgh1AHUAqgiyCHUAdQB1AHUAdQB1AHUAdQB1AHUAtwh8AXUAvwh1AMUIyQjRCNkI4AjoCHUAdQB1AO4I9gj+CAYJDgkTCS0HGwkjCYIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiAAIAAAAFAAYABgAGIAXwBgAHEAdQBFAJUAogCyAKAAYABgAEIA4ABGANMA4QDxAMEBDwE1AFwBLAE6AQEBUQF4QkhCmEKoQrhCgAHIQsAB0MLAAcABwAHAAeDC6ABoAHDCwMMAAcABwAHAAdDDGMMAAcAB6MM4wwjDWMNow3jDaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAEjDqABWw6bDqABpg6gAaABoAHcDvwOPA+gAaABfA/8DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DpcPAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcAB9cPKwkyCToJMAB1AHUAdQBCCUoJTQl1AFUJXAljCWcJawkwADAAMAAwAHMJdQB2CX4JdQCECYoJjgmWCXUAngkwAGAAYABxAHUApgn3A64JtAl1ALkJdQDACTAAMAAwADAAdQB1AHUAdQB1AHUAdQB1AHUAowYNBMUIMAAwADAAMADICcsJ0wnZCRUE4QkwAOkJ8An4CTAAMAB1AAAKvwh1AAgKDwoXCh8KdQAwACcKLgp1ADYKqAmICT4KRgowADAAdQB1AE4KMAB1AFYKdQBeCnUAZQowADAAMAAwADAAMAAwADAAMAAVBHUAbQowADAAdQC5CXUKMAAwAHwBxAijBogEMgF9CoQKiASMCpQKmgqIBKIKqgquCogEDQG2Cr4KxgrLCjAAMADTCtsKCgHjCusK8Qr5CgELMAAwADAAMAB1AIsECQsRC3UANAEZCzAAMAAwADAAMAB1ACELKQswAHUANAExCzkLdQBBC0kLMABRC1kLMAAwADAAMAAwADAAdQBhCzAAMAAwAGAAYABpC3ELdwt/CzAAMACHC4sLkwubC58Lpwt1AK4Ltgt1APsDMAAwADAAMAAwADAAMAAwAL4LwwvLC9IL1wvdCzAAMADlC+kL8Qv5C/8LSQswADAAMAAwADAAMAAwADAAMAAHDDAAMAAwADAAMAAODBYMHgx1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1ACYMMAAwADAAdQB1AHUALgx1AHUAdQB1AHUAdQA2DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AD4MdQBGDHUAdQB1AHUAdQB1AEkMdQB1AHUAdQB1AFAMMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQBYDHUAdQB1AF8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUA+wMVBGcMMAAwAHwBbwx1AHcMfwyHDI8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAYABgAJcMMAAwADAAdQB1AJ8MlQClDDAAMACtDCwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB7UMLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AA0EMAC9DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAsBywHLAcsBywHLAcsBywHLQcwAMEMyAwsBywHLAcsBywHLAcsBywHLAcsBywHzAwwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1ANQM2QzhDDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMABgAGAAYABgAGAAYABgAOkMYADxDGAA+AwADQYNYABhCWAAYAAODTAAMAAwADAAFg1gAGAAHg37AzAAMAAwADAAYABgACYNYAAsDTQNPA1gAEMNPg1LDWAAYABgAGAAYABgAGAAYABgAGAAUg1aDYsGVglhDV0NcQBnDW0NdQ15DWAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAlQCBDZUAiA2PDZcNMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAnw2nDTAAMAAwADAAMAAwAHUArw23DTAAMAAwADAAMAAwADAAMAAwADAAMAB1AL8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQDHDTAAYABgAM8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA1w11ANwNMAAwAD0B5A0wADAAMAAwADAAMADsDfQN/A0EDgwOFA4wABsOMAAwADAAMAAwADAAMAAwANIG0gbSBtIG0gbSBtIG0gYjDigOwQUuDsEFMw7SBjoO0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGQg5KDlIOVg7SBtIGXg5lDm0OdQ7SBtIGfQ6EDooOjQ6UDtIGmg6hDtIG0gaoDqwO0ga0DrwO0gZgAGAAYADEDmAAYAAkBtIGzA5gANIOYADaDokO0gbSBt8O5w7SBu8O0gb1DvwO0gZgAGAAxA7SBtIG0gbSBtIGYABgAGAAYAAED2AAsAUMD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHJA8sBywHLAcsBywHLAccDywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywPLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAc0D9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHPA/SBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gYUD0QPlQCVAJUAMAAwADAAMACVAJUAlQCVAJUAlQCVAEwPMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA//8EAAQABAAEAAQABAAEAAQABAANAAMAAQABAAIABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQACgATABcAHgAbABoAHgAXABYAEgAeABsAGAAPABgAHABLAEsASwBLAEsASwBLAEsASwBLABgAGAAeAB4AHgATAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABYAGwASAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWAA0AEQAeAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAFAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJABYAGgAbABsAGwAeAB0AHQAeAE8AFwAeAA0AHgAeABoAGwBPAE8ADgBQAB0AHQAdAE8ATwAXAE8ATwBPABYAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAFAATwBAAE8ATwBPAEAATwBQAFAATwBQAB4AHgAeAB4AHgAeAB0AHQAdAB0AHgAdAB4ADgBQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgBQAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAkACQAJAAkACQAJAAkABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAFAAHgAeAB4AKwArAFAAUABQAFAAGABQACsAKwArACsAHgAeAFAAHgBQAFAAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUAAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAYAA0AKwArAB4AHgAbACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAB4ABAAEAB4ABAAEABMABAArACsAKwArACsAKwArACsAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAKwArACsAKwBWAFYAVgBWAB4AHgArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AGgAaABoAGAAYAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQAEwAEACsAEwATAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABLAEsASwBLAEsASwBLAEsASwBLABoAGQAZAB4AUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABMAUAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABABQAFAABAAEAB4ABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUAAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAFAABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQAUABQAB4AHgAYABMAUAArACsABAAbABsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAFAABAAEAAQABAAEAFAABAAEAAQAUAAEAAQABAAEAAQAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArACsAHgArAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAUAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEAA0ADQBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUAArACsAKwBQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABABQACsAKwArACsAKwArACsAKwAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUAAaABoAUABQAFAAUABQAEwAHgAbAFAAHgAEACsAKwAEAAQABAArAFAAUABQAFAAUABQACsAKwArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQACsAUABQACsAKwAEACsABAAEAAQABAAEACsAKwArACsABAAEACsAKwAEAAQABAArACsAKwAEACsAKwArACsAKwArACsAUABQAFAAUAArAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLAAQABABQAFAAUAAEAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAArACsAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AGwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAKwArACsAKwArAAQABAAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAAQAUAArAFAAUABQAFAAUABQACsAKwArAFAAUABQACsAUABQAFAAUAArACsAKwBQAFAAKwBQACsAUABQACsAKwArAFAAUAArACsAKwBQAFAAUAArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArAAQABAAEAAQABAArACsAKwAEAAQABAArAAQABAAEAAQAKwArAFAAKwArACsAKwArACsABAArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAHgAeAB4AHgAeAB4AGwAeACsAKwArACsAKwAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAUABQAFAAKwArACsAKwArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwAOAFAAUABQAFAAUABQAFAAHgBQAAQABAAEAA4AUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAKwArAAQAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAKwArACsAKwArACsAUAArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAFAABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQABABQAB4AKwArACsAKwBQAFAAUAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQABoAUABQAFAAUABQAFAAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQACsAUAArACsAUABQAFAAUABQAFAAUAArACsAKwAEACsAKwArACsABAAEAAQABAAEAAQAKwAEACsABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArAAQABAAeACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAXAAqACoAKgAqACoAKgAqACsAKwArACsAGwBcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAeAEsASwBLAEsASwBLAEsASwBLAEsADQANACsAKwArACsAKwBcAFwAKwBcACsAXABcAFwAXABcACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAXAArAFwAXABcAFwAXABcAFwAXABcAFwAKgBcAFwAKgAqACoAKgAqACoAKgAqACoAXAArACsAXABcAFwAXABcACsAXAArACoAKgAqACoAKgAqACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwBcAFwAXABcAFAADgAOAA4ADgAeAA4ADgAJAA4ADgANAAkAEwATABMAEwATAAkAHgATAB4AHgAeAAQABAAeAB4AHgAeAB4AHgBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQAFAADQAEAB4ABAAeAAQAFgARABYAEQAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAAQABAAEAAQADQAEAAQAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAA0ADQAeAB4AHgAeAB4AHgAEAB4AHgAeAB4AHgAeACsAHgAeAA4ADgANAA4AHgAeAB4AHgAeAAkACQArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgBcAEsASwBLAEsASwBLAEsASwBLAEsADQANAB4AHgAeAB4AXABcAFwAXABcAFwAKgAqACoAKgBcAFwAXABcACoAKgAqAFwAKgAqACoAXABcACoAKgAqACoAKgAqACoAXABcAFwAKgAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqAFwAKgBLAEsASwBLAEsASwBLAEsASwBLACoAKgAqACoAKgAqAFAAUABQAFAAUABQACsAUAArACsAKwArACsAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAKwBQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsABAAEAAQAHgANAB4AHgAeAB4AHgAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUAArACsADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWABEAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQANAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAANAA0AKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUAArAAQABAArACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqAA0ADQAVAFwADQAeAA0AGwBcACoAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwAeAB4AEwATAA0ADQAOAB4AEwATAB4ABAAEAAQACQArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAHgArACsAKwATABMASwBLAEsASwBLAEsASwBLAEsASwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAXABcAFwAXABcACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAXAArACsAKwAqACoAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsAHgAeAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKwArAAQASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACoAKgAqACoAKgAqACoAXAAqACoAKgAqACoAKgArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABABQAFAAUABQAFAAUABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwANAA0AHgANAA0ADQANAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwAeAB4AHgAeAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArAA0ADQANAA0ADQBLAEsASwBLAEsASwBLAEsASwBLACsAKwArAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUAAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAAQAUABQAFAAUABQAFAABABQAFAABAAEAAQAUAArACsAKwArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQACsAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAFAAUABQACsAHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQACsAKwAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQACsAHgAeAB4AHgAeAB4AHgAOAB4AKwANAA0ADQANAA0ADQANAAkADQANAA0ACAAEAAsABAAEAA0ACQANAA0ADAAdAB0AHgAXABcAFgAXABcAFwAWABcAHQAdAB4AHgAUABQAFAANAAEAAQAEAAQABAAEAAQACQAaABoAGgAaABoAGgAaABoAHgAXABcAHQAVABUAHgAeAB4AHgAeAB4AGAAWABEAFQAVABUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ADQAeAA0ADQANAA0AHgANAA0ADQAHAB4AHgAeAB4AKwAEAAQABAAEAAQABAAEAAQABAAEAFAAUAArACsATwBQAFAAUABQAFAAHgAeAB4AFgARAE8AUABPAE8ATwBPAFAAUABQAFAAUAAeAB4AHgAWABEAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArABsAGwAbABsAGwAbABsAGgAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGgAbABsAGwAbABoAGwAbABoAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAHgAeAFAAGgAeAB0AHgBQAB4AGgAeAB4AHgAeAB4AHgAeAB4AHgBPAB4AUAAbAB4AHgBQAFAAUABQAFAAHgAeAB4AHQAdAB4AUAAeAFAAHgBQAB4AUABPAFAAUAAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgBQAFAAUABQAE8ATwBQAFAAUABQAFAATwBQAFAATwBQAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAUABQAFAATwBPAE8ATwBPAE8ATwBPAE8ATwBQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABPAB4AHgArACsAKwArAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHQAdAB4AHgAeAB0AHQAeAB4AHQAeAB4AHgAdAB4AHQAbABsAHgAdAB4AHgAeAB4AHQAeAB4AHQAdAB0AHQAeAB4AHQAeAB0AHgAdAB0AHQAdAB0AHQAeAB0AHgAeAB4AHgAeAB0AHQAdAB0AHgAeAB4AHgAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHgAeAB0AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAeAB0AHQAdAB0AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAdAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAWABEAHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAWABEAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AHQAdAB0AHgAeAB0AHgAeAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlAB4AHQAdAB4AHgAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AJQAlAB0AHQAlAB4AJQAlACUAIAAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAdAB0AHQAeAB0AJQAdAB0AHgAdAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAdAB0AHQAdACUAHgAlACUAJQAdACUAJQAdAB0AHQAlACUAHQAdACUAHQAdACUAJQAlAB4AHQAeAB4AHgAeAB0AHQAlAB0AHQAdAB0AHQAdACUAJQAlACUAJQAdACUAJQAgACUAHQAdACUAJQAlACUAJQAlACUAJQAeAB4AHgAlACUAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AFwAXABcAFwAXABcAHgATABMAJQAeAB4AHgAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARABYAEQAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAEAAQABAAeAB4AKwArACsAKwArABMADQANAA0AUAATAA0AUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUAANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAA0ADQANAA0ADQANAA0ADQAeAA0AFgANAB4AHgAXABcAHgAeABcAFwAWABEAFgARABYAEQAWABEADQANAA0ADQATAFAADQANAB4ADQANAB4AHgAeAB4AHgAMAAwADQANAA0AHgANAA0AFgANAA0ADQANAA0ADQANAA0AHgANAB4ADQANAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArAA0AEQARACUAJQBHAFcAVwAWABEAFgARABYAEQAWABEAFgARACUAJQAWABEAFgARABYAEQAWABEAFQAWABEAEQAlAFcAVwBXAFcAVwBXAFcAVwBXAAQABAAEAAQABAAEACUAVwBXAFcAVwA2ACUAJQBXAFcAVwBHAEcAJQAlACUAKwBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBRAFcAUQBXAFEAVwBXAFcAVwBXAFcAUQBXAFcAVwBXAFcAVwBRAFEAKwArAAQABAAVABUARwBHAFcAFQBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBRAFcAVwBXAFcAVwBXAFEAUQBXAFcAVwBXABUAUQBHAEcAVwArACsAKwArACsAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwAlACUAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACsAKwArACsAKwArACsAKwArACsAKwArAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBPAE8ATwBPAE8ATwBPAE8AJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADQATAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABLAEsASwBLAEsASwBLAEsASwBLAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAABAAEAAQABAAeAAQABAAEAAQABAAEAAQABAAEAAQAHgBQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAeAA0ADQANAA0ADQArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAAQAUABQAFAABABQAFAAUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAeAB4AHgAeAAQAKwArACsAUABQAFAAUABQAFAAHgAeABoAHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADgAOABMAEwArACsAKwArACsAKwArACsABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwANAA0ASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUAAeAB4AHgBQAA4AUABQAAQAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArAB4AWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYACsAKwArAAQAHgAeAB4AHgAeAB4ADQANAA0AHgAeAB4AHgArAFAASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArAB4AHgBcAFwAXABcAFwAKgBcAFwAXABcAFwAXABcAFwAXABcAEsASwBLAEsASwBLAEsASwBLAEsAXABcAFwAXABcACsAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAFAAUABQAAQAUABQAFAAUABQAFAAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAHgANAA0ADQBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAXAAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAKgAqACoAXABcACoAKgBcAFwAXABcAFwAKgAqAFwAKgBcACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcACoAKgBQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAA0ADQBQAFAAUAAEAAQAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQADQAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAVABVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBUAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVACsAKwArACsAKwArACsAKwArACsAKwArAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAKwArACsAKwBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAKwArACsAKwAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAKwArACsAKwArAFYABABWAFYAVgBWAFYAVgBWAFYAVgBWAB4AVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgArAFYAVgBWAFYAVgArAFYAKwBWAFYAKwBWAFYAKwBWAFYAVgBWAFYAVgBWAFYAVgBWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAEQAWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAaAB4AKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAGAARABEAGAAYABMAEwAWABEAFAArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACUAJQAlACUAJQAWABEAFgARABYAEQAWABEAFgARABYAEQAlACUAFgARACUAJQAlACUAJQAlACUAEQAlABEAKwAVABUAEwATACUAFgARABYAEQAWABEAJQAlACUAJQAlACUAJQAlACsAJQAbABoAJQArACsAKwArAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAcAKwATACUAJQAbABoAJQAlABYAEQAlACUAEQAlABEAJQBXAFcAVwBXAFcAVwBXAFcAVwBXABUAFQAlACUAJQATACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXABYAJQARACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAWACUAEQAlABYAEQARABYAEQARABUAVwBRAFEAUQBRAFEAUQBRAFEAUQBRAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcARwArACsAVwBXAFcAVwBXAFcAKwArAFcAVwBXAFcAVwBXACsAKwBXAFcAVwBXAFcAVwArACsAVwBXAFcAKwArACsAGgAbACUAJQAlABsAGwArAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAAQAB0AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsADQANAA0AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAA0AUABQAFAAUAArACsAKwArAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwArAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwBQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAUABQAFAAUABQAAQABAAEACsABAAEACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAKwBQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAA0ADQANAA0ADQANAA0ADQAeACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAArACsAKwArAFAAUABQAFAAUAANAA0ADQANAA0ADQAUACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsADQANAA0ADQANAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArAAQABAANACsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAB4AHgAeAB4AHgArACsAKwArACsAKwAEAAQABAAEAAQABAAEAA0ADQAeAB4AHgAeAB4AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsASwBLAEsASwBLAEsASwBLAEsASwANAA0ADQANAFAABAAEAFAAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAeAA4AUAArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAADQANAB4ADQAEAAQABAAEAB4ABAAEAEsASwBLAEsASwBLAEsASwBLAEsAUAAOAFAADQANAA0AKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAANAA0AHgANAA0AHgAEACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAA0AKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsABAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsABAAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAUAArACsAKwArACsAKwAEACsAKwArACsAKwBQAFAAUABQAFAABAAEACsAKwAEAAQABAAEAAQABAAEACsAKwArAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAQABABQAFAAUABQAA0ADQANAA0AHgBLAEsASwBLAEsASwBLAEsASwBLAA0ADQArAB4ABABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUAAeAFAAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABAAEAAQADgANAA0AEwATAB4AHgAeAA0ADQANAA0ADQANAA0ADQANAA0ADQANAA0ADQANAFAAUABQAFAABAAEACsAKwAEAA0ADQAeAFAAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKwArACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBcAFwADQANAA0AKgBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAKwArAFAAKwArAFAAUABQAFAAUABQAFAAUAArAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQAKwAEAAQAKwArAAQABAAEAAQAUAAEAFAABAAEAA0ADQANACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABABQAA4AUAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAFAABAAEAAQABAAOAB4ADQANAA0ADQAOAB4ABAArACsAKwArACsAKwArACsAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAA0ADQANAFAADgAOAA4ADQANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAAQABAAEAFAADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAOABMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAArACsAKwAEACsABAAEACsABAAEAAQABAAEAAQABABQAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAaABoAGgAaAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABIAEgAQwBDAEMAUABQAFAAUABDAFAAUABQAEgAQwBIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABDAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAJAAkACQAJAAkACQAJABYAEQArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwANAA0AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAANACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAA0ADQANAB4AHgAeAB4AHgAeAFAAUABQAFAADQAeACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAA0AHgAeACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAARwBHABUARwAJACsAKwArACsAKwArACsAKwArACsAKwAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUQBRAFEAKwArACsAKwArACsAKwArACsAKwArACsAKwBRAFEAUQBRACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAHgAEAAQADQAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQABAAEAAQABAAeAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQAHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAKwArAFAAKwArAFAAUAArACsAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUAArAFAAUABQAFAAUABQAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAHgAeAFAAUABQAFAAUAArAFAAKwArACsAUABQAFAAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeACsAKwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4ABAAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAHgAeAA0ADQANAA0AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArAAQABAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwBQAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArABsAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAB4AHgAeAB4ABAAEAAQABAAEAAQABABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArABYAFgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAGgBQAFAAUAAaAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUAArACsAKwArACsAKwBQACsAKwArACsAUAArAFAAKwBQACsAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUAArAFAAKwBQACsAUAArAFAAUAArAFAAKwArAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAKwBQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8AJQAlACUAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB4AHgAeACUAJQAlAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAlACUAJQAlACUAHgAlACUAJQAlACUAIAAgACAAJQAlACAAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACEAIQAhACEAIQAlACUAIAAgACUAJQAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAIAAlACUAJQAlACAAIAAgACUAIAAgACAAJQAlACUAJQAlACUAJQAgACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAlAB4AJQAeACUAJQAlACUAJQAgACUAJQAlACUAHgAlAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACAAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABcAFwAXABUAFQAVAB4AHgAeAB4AJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAgACUAJQAgACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAIAAgACUAJQAgACAAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACAAIAAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACAAIAAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAA=="),Tp=[vp,36],Dp=[1,2,3,5],Sp=[op,8],Rp=[gp,mp],Up=Dp.concat(Sp),Lp=[xp,Cp,Mp,wp,Bp],kp=[ap,np],Op=function(e,t,i,s){var r=s[i];if(Array.isArray(e)?-1!==e.indexOf(r):e===r)for(var o=i;o<=s.length;){if((l=s[++o])===t)return!0;if(l!==op)break}if(r===op)for(o=i;o>0;){var n=s[--o];if(Array.isArray(e)?-1!==e.indexOf(n):e===n)for(var a=i;a<=s.length;){var l;if((l=s[++a])===t)return!0;if(l!==op)break}if(n!==op)break}return!1},Np=function(e,t){for(var i=e;i>=0;){var s=t[i];if(s!==op)return s;i--}return 0},Vp=function(e,t,i,s,r){if(0===i[s])return"×";var o=s-1;if(Array.isArray(r)&&!0===r[o])return"×";var n=o-1,a=o+1,l=t[o],A=n>=0?t[n]:0,c=t[a];if(2===l&&3===c)return"×";if(-1!==Dp.indexOf(l))return"!";if(-1!==Dp.indexOf(c))return"×";if(-1!==Sp.indexOf(c))return"×";if(8===Np(o,t))return"÷";if(11===Ip.get(e[o]))return"×";if((l===bp||l===yp)&&11===Ip.get(e[a]))return"×";if(7===l||7===c)return"×";if(9===l)return"×";if(-1===[op,np,ap].indexOf(l)&&9===c)return"×";if(-1!==[lp,Ap,cp,pp,_p].indexOf(c))return"×";if(Np(o,t)===dp)return"×";if(Op(23,dp,o,t))return"×";if(Op([lp,Ap],up,o,t))return"×";if(Op(12,12,o,t))return"×";if(l===op)return"÷";if(23===l||23===c)return"×";if(16===c||16===l)return"÷";if(-1!==[np,ap,up].indexOf(c)||14===l)return"×";if(36===A&&-1!==kp.indexOf(l))return"×";if(l===_p&&36===c)return"×";if(c===hp)return"×";if(-1!==Tp.indexOf(c)&&l===fp||-1!==Tp.indexOf(l)&&c===fp)return"×";if(l===gp&&-1!==[Pp,bp,yp].indexOf(c)||-1!==[Pp,bp,yp].indexOf(l)&&c===mp)return"×";if(-1!==Tp.indexOf(l)&&-1!==Rp.indexOf(c)||-1!==Rp.indexOf(l)&&-1!==Tp.indexOf(c))return"×";if(-1!==[gp,mp].indexOf(l)&&(c===fp||-1!==[dp,ap].indexOf(c)&&t[a+1]===fp)||-1!==[dp,ap].indexOf(l)&&c===fp||l===fp&&-1!==[fp,_p,pp].indexOf(c))return"×";if(-1!==[fp,_p,pp,lp,Ap].indexOf(c))for(var h=o;h>=0;){if((u=t[h])===fp)return"×";if(-1===[_p,pp].indexOf(u))break;h--}if(-1!==[gp,mp].indexOf(c))for(h=-1!==[lp,Ap].indexOf(l)?n:o;h>=0;){var u;if((u=t[h])===fp)return"×";if(-1===[_p,pp].indexOf(u))break;h--}if(xp===l&&-1!==[xp,Cp,wp,Bp].indexOf(c)||-1!==[Cp,wp].indexOf(l)&&-1!==[Cp,Mp].indexOf(c)||-1!==[Mp,Bp].indexOf(l)&&c===Mp)return"×";if(-1!==Lp.indexOf(l)&&-1!==[hp,mp].indexOf(c)||-1!==Lp.indexOf(c)&&l===gp)return"×";if(-1!==Tp.indexOf(l)&&-1!==Tp.indexOf(c))return"×";if(l===pp&&-1!==Tp.indexOf(c))return"×";if(-1!==Tp.concat(fp).indexOf(l)&&c===dp&&-1===Fp.indexOf(e[a])||-1!==Tp.concat(fp).indexOf(c)&&l===Ap)return"×";if(41===l&&41===c){for(var d=i[o],p=1;d>0&&41===t[--d];)p++;if(p%2!=0)return"×"}return l===bp&&c===yp?"×":"÷"},Qp=function(e,t){t||(t={lineBreak:"normal",wordBreak:"normal"});var i=function(e,t){void 0===t&&(t="strict");var i=[],s=[],r=[];return e.forEach((function(e,o){var n=Ip.get(e);if(n>50?(r.push(!0),n-=50):r.push(!1),-1!==["normal","auto","loose"].indexOf(t)&&-1!==[8208,8211,12316,12448].indexOf(e))return s.push(o),i.push(16);if(4===n||11===n){if(0===o)return s.push(o),i.push(vp);var a=i[o-1];return-1===Up.indexOf(a)?(s.push(s[o-1]),i.push(a)):(s.push(o),i.push(vp))}return s.push(o),31===n?i.push("strict"===t?up:Pp):n===Ep||29===n?i.push(vp):43===n?e>=131072&&e<=196605||e>=196608&&e<=262141?i.push(Pp):i.push(vp):void i.push(n)})),[s,i,r]}(e,t.lineBreak),s=i[0],r=i[1],o=i[2];"break-all"!==t.wordBreak&&"break-word"!==t.wordBreak||(r=r.map((function(e){return-1!==[fp,vp,Ep].indexOf(e)?Pp:e})));var n="keep-all"===t.wordBreak?o.map((function(t,i){return t&&e[i]>=19968&&e[i]<=40959})):void 0;return[s,r,n]},Hp=function(){function e(e,t,i,s){this.codePoints=e,this.required="!"===t,this.start=i,this.end=s}return e.prototype.slice=function(){return Xd.apply(void 0,this.codePoints.slice(this.start,this.end))},e}(),jp=function(e){return e>=48&&e<=57},Gp=function(e){return jp(e)||e>=65&&e<=70||e>=97&&e<=102},zp=function(e){return 10===e||9===e||32===e},Wp=function(e){return function(e){return function(e){return e>=97&&e<=122}(e)||function(e){return e>=65&&e<=90}(e)}(e)||function(e){return e>=128}(e)||95===e},Xp=function(e){return Wp(e)||jp(e)||45===e},Kp=function(e){return e>=0&&e<=8||11===e||e>=14&&e<=31||127===e},Zp=function(e,t){return 92===e&&10!==t},Jp=function(e,t,i){return 45===e?Wp(t)||Zp(t,i):!!Wp(e)||!(92!==e||!Zp(e,t))},Yp=function(e,t,i){return 43===e||45===e?!!jp(t)||46===t&&jp(i):jp(46===e?t:e)},qp=function(e){var t=0,i=1;43!==e[t]&&45!==e[t]||(45===e[t]&&(i=-1),t++);for(var s=[];jp(e[t]);)s.push(e[t++]);var r=s.length?parseInt(Xd.apply(void 0,s),10):0;46===e[t]&&t++;for(var o=[];jp(e[t]);)o.push(e[t++]);var n=o.length,a=n?parseInt(Xd.apply(void 0,o),10):0;69!==e[t]&&101!==e[t]||t++;var l=1;43!==e[t]&&45!==e[t]||(45===e[t]&&(l=-1),t++);for(var A=[];jp(e[t]);)A.push(e[t++]);var c=A.length?parseInt(Xd.apply(void 0,A),10):0;return i*(r+a*Math.pow(10,-n))*Math.pow(10,l*c)},$p={type:2},ef={type:3},tf={type:4},sf={type:13},rf={type:8},of={type:21},nf={type:9},af={type:10},lf={type:11},Af={type:12},cf={type:14},hf={type:23},uf={type:1},df={type:25},pf={type:24},ff={type:26},mf={type:27},gf={type:28},_f={type:29},vf={type:31},bf={type:32},yf=function(){function e(){this._value=[]}return e.prototype.write=function(e){this._value=this._value.concat(Wd(e))},e.prototype.read=function(){for(var e=[],t=this.consumeToken();t!==bf;)e.push(t),t=this.consumeToken();return e},e.prototype.consumeToken=function(){var e=this.consumeCodePoint();switch(e){case 34:return this.consumeStringToken(34);case 35:var t=this.peekCodePoint(0),i=this.peekCodePoint(1),s=this.peekCodePoint(2);if(Xp(t)||Zp(i,s)){var r=Jp(t,i,s)?2:1;return{type:5,value:this.consumeName(),flags:r}}break;case 36:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),sf;break;case 39:return this.consumeStringToken(39);case 40:return $p;case 41:return ef;case 42:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),cf;break;case 43:if(Yp(e,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(e),this.consumeNumericToken();break;case 44:return tf;case 45:var o=e,n=this.peekCodePoint(0),a=this.peekCodePoint(1);if(Yp(o,n,a))return this.reconsumeCodePoint(e),this.consumeNumericToken();if(Jp(o,n,a))return this.reconsumeCodePoint(e),this.consumeIdentLikeToken();if(45===n&&62===a)return this.consumeCodePoint(),this.consumeCodePoint(),pf;break;case 46:if(Yp(e,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(e),this.consumeNumericToken();break;case 47:if(42===this.peekCodePoint(0))for(this.consumeCodePoint();;){var l=this.consumeCodePoint();if(42===l&&47===(l=this.consumeCodePoint()))return this.consumeToken();if(-1===l)return this.consumeToken()}break;case 58:return ff;case 59:return mf;case 60:if(33===this.peekCodePoint(0)&&45===this.peekCodePoint(1)&&45===this.peekCodePoint(2))return this.consumeCodePoint(),this.consumeCodePoint(),df;break;case 64:var A=this.peekCodePoint(0),c=this.peekCodePoint(1),h=this.peekCodePoint(2);if(Jp(A,c,h))return{type:7,value:this.consumeName()};break;case 91:return gf;case 92:if(Zp(e,this.peekCodePoint(0)))return this.reconsumeCodePoint(e),this.consumeIdentLikeToken();break;case 93:return _f;case 61:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),rf;break;case 123:return lf;case 125:return Af;case 117:case 85:var u=this.peekCodePoint(0),d=this.peekCodePoint(1);return 43!==u||!Gp(d)&&63!==d||(this.consumeCodePoint(),this.consumeUnicodeRangeToken()),this.reconsumeCodePoint(e),this.consumeIdentLikeToken();case 124:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),nf;if(124===this.peekCodePoint(0))return this.consumeCodePoint(),of;break;case 126:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),af;break;case-1:return bf}return zp(e)?(this.consumeWhiteSpace(),vf):jp(e)?(this.reconsumeCodePoint(e),this.consumeNumericToken()):Wp(e)?(this.reconsumeCodePoint(e),this.consumeIdentLikeToken()):{type:6,value:Xd(e)}},e.prototype.consumeCodePoint=function(){var e=this._value.shift();return void 0===e?-1:e},e.prototype.reconsumeCodePoint=function(e){this._value.unshift(e)},e.prototype.peekCodePoint=function(e){return e>=this._value.length?-1:this._value[e]},e.prototype.consumeUnicodeRangeToken=function(){for(var e=[],t=this.consumeCodePoint();Gp(t)&&e.length<6;)e.push(t),t=this.consumeCodePoint();for(var i=!1;63===t&&e.length<6;)e.push(t),t=this.consumeCodePoint(),i=!0;if(i)return{type:30,start:parseInt(Xd.apply(void 0,e.map((function(e){return 63===e?48:e}))),16),end:parseInt(Xd.apply(void 0,e.map((function(e){return 63===e?70:e}))),16)};var s=parseInt(Xd.apply(void 0,e),16);if(45===this.peekCodePoint(0)&&Gp(this.peekCodePoint(1))){this.consumeCodePoint(),t=this.consumeCodePoint();for(var r=[];Gp(t)&&r.length<6;)r.push(t),t=this.consumeCodePoint();return{type:30,start:s,end:parseInt(Xd.apply(void 0,r),16)}}return{type:30,start:s,end:s}},e.prototype.consumeIdentLikeToken=function(){var e=this.consumeName();return"url"===e.toLowerCase()&&40===this.peekCodePoint(0)?(this.consumeCodePoint(),this.consumeUrlToken()):40===this.peekCodePoint(0)?(this.consumeCodePoint(),{type:19,value:e}):{type:20,value:e}},e.prototype.consumeUrlToken=function(){var e=[];if(this.consumeWhiteSpace(),-1===this.peekCodePoint(0))return{type:22,value:""};var t=this.peekCodePoint(0);if(39===t||34===t){var i=this.consumeStringToken(this.consumeCodePoint());return 0===i.type&&(this.consumeWhiteSpace(),-1===this.peekCodePoint(0)||41===this.peekCodePoint(0))?(this.consumeCodePoint(),{type:22,value:i.value}):(this.consumeBadUrlRemnants(),hf)}for(;;){var s=this.consumeCodePoint();if(-1===s||41===s)return{type:22,value:Xd.apply(void 0,e)};if(zp(s))return this.consumeWhiteSpace(),-1===this.peekCodePoint(0)||41===this.peekCodePoint(0)?(this.consumeCodePoint(),{type:22,value:Xd.apply(void 0,e)}):(this.consumeBadUrlRemnants(),hf);if(34===s||39===s||40===s||Kp(s))return this.consumeBadUrlRemnants(),hf;if(92===s){if(!Zp(s,this.peekCodePoint(0)))return this.consumeBadUrlRemnants(),hf;e.push(this.consumeEscapedCodePoint())}else e.push(s)}},e.prototype.consumeWhiteSpace=function(){for(;zp(this.peekCodePoint(0));)this.consumeCodePoint()},e.prototype.consumeBadUrlRemnants=function(){for(;;){var e=this.consumeCodePoint();if(41===e||-1===e)return;Zp(e,this.peekCodePoint(0))&&this.consumeEscapedCodePoint()}},e.prototype.consumeStringSlice=function(e){for(var t="";e>0;){var i=Math.min(5e4,e);t+=Xd.apply(void 0,this._value.splice(0,i)),e-=i}return this._value.shift(),t},e.prototype.consumeStringToken=function(e){for(var t="",i=0;;){var s=this._value[i];if(-1===s||void 0===s||s===e)return{type:0,value:t+=this.consumeStringSlice(i)};if(10===s)return this._value.splice(0,i),uf;if(92===s){var r=this._value[i+1];-1!==r&&void 0!==r&&(10===r?(t+=this.consumeStringSlice(i),i=-1,this._value.shift()):Zp(s,r)&&(t+=this.consumeStringSlice(i),t+=Xd(this.consumeEscapedCodePoint()),i=-1))}i++}},e.prototype.consumeNumber=function(){var e=[],t=4,i=this.peekCodePoint(0);for(43!==i&&45!==i||e.push(this.consumeCodePoint());jp(this.peekCodePoint(0));)e.push(this.consumeCodePoint());i=this.peekCodePoint(0);var s=this.peekCodePoint(1);if(46===i&&jp(s))for(e.push(this.consumeCodePoint(),this.consumeCodePoint()),t=8;jp(this.peekCodePoint(0));)e.push(this.consumeCodePoint());i=this.peekCodePoint(0),s=this.peekCodePoint(1);var r=this.peekCodePoint(2);if((69===i||101===i)&&((43===s||45===s)&&jp(r)||jp(s)))for(e.push(this.consumeCodePoint(),this.consumeCodePoint()),t=8;jp(this.peekCodePoint(0));)e.push(this.consumeCodePoint());return[qp(e),t]},e.prototype.consumeNumericToken=function(){var e=this.consumeNumber(),t=e[0],i=e[1],s=this.peekCodePoint(0),r=this.peekCodePoint(1),o=this.peekCodePoint(2);return Jp(s,r,o)?{type:15,number:t,flags:i,unit:this.consumeName()}:37===s?(this.consumeCodePoint(),{type:16,number:t,flags:i}):{type:17,number:t,flags:i}},e.prototype.consumeEscapedCodePoint=function(){var e=this.consumeCodePoint();if(Gp(e)){for(var t=Xd(e);Gp(this.peekCodePoint(0))&&t.length<6;)t+=Xd(this.consumeCodePoint());zp(this.peekCodePoint(0))&&this.consumeCodePoint();var i=parseInt(t,16);return 0===i||function(e){return e>=55296&&e<=57343}(i)||i>1114111?65533:i}return-1===e?65533:e},e.prototype.consumeName=function(){for(var e="";;){var t=this.consumeCodePoint();if(Xp(t))e+=Xd(t);else{if(!Zp(t,this.peekCodePoint(0)))return this.reconsumeCodePoint(t),e;e+=Xd(this.consumeEscapedCodePoint())}}},e}(),wf=function(){function e(e){this._tokens=e}return e.create=function(t){var i=new yf;return i.write(t),new e(i.read())},e.parseValue=function(t){return e.create(t).parseComponentValue()},e.parseValues=function(t){return e.create(t).parseComponentValues()},e.prototype.parseComponentValue=function(){for(var e=this.consumeToken();31===e.type;)e=this.consumeToken();if(32===e.type)throw new SyntaxError("Error parsing CSS component value, unexpected EOF");this.reconsumeToken(e);var t=this.consumeComponentValue();do{e=this.consumeToken()}while(31===e.type);if(32===e.type)return t;throw new SyntaxError("Error parsing CSS component value, multiple values found when expecting only one")},e.prototype.parseComponentValues=function(){for(var e=[];;){var t=this.consumeComponentValue();if(32===t.type)return e;e.push(t),e.push()}},e.prototype.consumeComponentValue=function(){var e=this.consumeToken();switch(e.type){case 11:case 28:case 2:return this.consumeSimpleBlock(e.type);case 19:return this.consumeFunction(e)}return e},e.prototype.consumeSimpleBlock=function(e){for(var t={type:e,values:[]},i=this.consumeToken();;){if(32===i.type||Tf(i,e))return t;this.reconsumeToken(i),t.values.push(this.consumeComponentValue()),i=this.consumeToken()}},e.prototype.consumeFunction=function(e){for(var t={name:e.value,values:[],type:18};;){var i=this.consumeToken();if(32===i.type||3===i.type)return t;this.reconsumeToken(i),t.values.push(this.consumeComponentValue())}},e.prototype.consumeToken=function(){var e=this._tokens.shift();return void 0===e?bf:e},e.prototype.reconsumeToken=function(e){this._tokens.unshift(e)},e}(),Bf=function(e){return 15===e.type},Pf=function(e){return 17===e.type},xf=function(e){return 20===e.type},Cf=function(e){return 0===e.type},Mf=function(e,t){return xf(e)&&e.value===t},Ef=function(e){return 31!==e.type},Ff=function(e){return 31!==e.type&&4!==e.type},If=function(e){var t=[],i=[];return e.forEach((function(e){if(4===e.type){if(0===i.length)throw new Error("Error parsing function args, zero tokens for arg");return t.push(i),void(i=[])}31!==e.type&&i.push(e)})),i.length&&t.push(i),t},Tf=function(e,t){return 11===t&&12===e.type||(28===t&&29===e.type||2===t&&3===e.type)},Df=function(e){return 17===e.type||15===e.type},Sf=function(e){return 16===e.type||Df(e)},Rf=function(e){return e.length>1?[e[0],e[1]]:[e[0]]},Uf={type:17,number:0,flags:4},Lf={type:16,number:50,flags:4},kf={type:16,number:100,flags:4},Of=function(e,t,i){var s=e[0],r=e[1];return[Nf(s,t),Nf(void 0!==r?r:s,i)]},Nf=function(e,t){if(16===e.type)return e.number/100*t;if(Bf(e))switch(e.unit){case"rem":case"em":return 16*e.number;default:return e.number}return e.number},Vf=function(e,t){if(15===t.type)switch(t.unit){case"deg":return Math.PI*t.number/180;case"grad":return Math.PI/200*t.number;case"rad":return t.number;case"turn":return 2*Math.PI*t.number}throw new Error("Unsupported angle type")},Qf=function(e){return 15===e.type&&("deg"===e.unit||"grad"===e.unit||"rad"===e.unit||"turn"===e.unit)},Hf=function(e){switch(e.filter(xf).map((function(e){return e.value})).join(" ")){case"to bottom right":case"to right bottom":case"left top":case"top left":return[Uf,Uf];case"to top":case"bottom":return jf(0);case"to bottom left":case"to left bottom":case"right top":case"top right":return[Uf,kf];case"to right":case"left":return jf(90);case"to top left":case"to left top":case"right bottom":case"bottom right":return[kf,kf];case"to bottom":case"top":return jf(180);case"to top right":case"to right top":case"left bottom":case"bottom left":return[kf,Uf];case"to left":case"right":return jf(270)}return 0},jf=function(e){return Math.PI*e/180},Gf=function(e,t){if(18===t.type){var i=qf[t.name];if(void 0===i)throw new Error('Attempting to parse an unsupported color function "'+t.name+'"');return i(e,t.values)}if(5===t.type){if(3===t.value.length){var s=t.value.substring(0,1),r=t.value.substring(1,2),o=t.value.substring(2,3);return Xf(parseInt(s+s,16),parseInt(r+r,16),parseInt(o+o,16),1)}if(4===t.value.length){s=t.value.substring(0,1),r=t.value.substring(1,2),o=t.value.substring(2,3);var n=t.value.substring(3,4);return Xf(parseInt(s+s,16),parseInt(r+r,16),parseInt(o+o,16),parseInt(n+n,16)/255)}if(6===t.value.length){s=t.value.substring(0,2),r=t.value.substring(2,4),o=t.value.substring(4,6);return Xf(parseInt(s,16),parseInt(r,16),parseInt(o,16),1)}if(8===t.value.length){s=t.value.substring(0,2),r=t.value.substring(2,4),o=t.value.substring(4,6),n=t.value.substring(6,8);return Xf(parseInt(s,16),parseInt(r,16),parseInt(o,16),parseInt(n,16)/255)}}if(20===t.type){var a=em[t.value.toUpperCase()];if(void 0!==a)return a}return em.TRANSPARENT},zf=function(e){return 0==(255&e)},Wf=function(e){var t=255&e,i=255&e>>8,s=255&e>>16,r=255&e>>24;return t<255?"rgba("+r+","+s+","+i+","+t/255+")":"rgb("+r+","+s+","+i+")"},Xf=function(e,t,i,s){return(e<<24|t<<16|i<<8|Math.round(255*s)<<0)>>>0},Kf=function(e,t){if(17===e.type)return e.number;if(16===e.type){var i=3===t?1:255;return 3===t?e.number/100*i:Math.round(e.number/100*i)}return 0},Zf=function(e,t){var i=t.filter(Ff);if(3===i.length){var s=i.map(Kf),r=s[0],o=s[1],n=s[2];return Xf(r,o,n,1)}if(4===i.length){var a=i.map(Kf),l=(r=a[0],o=a[1],n=a[2],a[3]);return Xf(r,o,n,l)}return 0};function Jf(e,t,i){return i<0&&(i+=1),i>=1&&(i-=1),i<1/6?(t-e)*i*6+e:i<.5?t:i<2/3?6*(t-e)*(2/3-i)+e:e}var Yf=function(e,t){var i=t.filter(Ff),s=i[0],r=i[1],o=i[2],n=i[3],a=(17===s.type?jf(s.number):Vf(e,s))/(2*Math.PI),l=Sf(r)?r.number/100:0,A=Sf(o)?o.number/100:0,c=void 0!==n&&Sf(n)?Nf(n,1):1;if(0===l)return Xf(255*A,255*A,255*A,1);var h=A<=.5?A*(l+1):A+l-A*l,u=2*A-h,d=Jf(u,h,a+1/3),p=Jf(u,h,a),f=Jf(u,h,a-1/3);return Xf(255*d,255*p,255*f,c)},qf={hsl:Yf,hsla:Yf,rgb:Zf,rgba:Zf},$f=function(e,t){return Gf(e,wf.create(t).parseComponentValue())},em={ALICEBLUE:4042850303,ANTIQUEWHITE:4209760255,AQUA:16777215,AQUAMARINE:2147472639,AZURE:4043309055,BEIGE:4126530815,BISQUE:4293182719,BLACK:255,BLANCHEDALMOND:4293643775,BLUE:65535,BLUEVIOLET:2318131967,BROWN:2771004159,BURLYWOOD:3736635391,CADETBLUE:1604231423,CHARTREUSE:2147418367,CHOCOLATE:3530104575,CORAL:4286533887,CORNFLOWERBLUE:1687547391,CORNSILK:4294499583,CRIMSON:3692313855,CYAN:16777215,DARKBLUE:35839,DARKCYAN:9145343,DARKGOLDENROD:3095837695,DARKGRAY:2846468607,DARKGREEN:6553855,DARKGREY:2846468607,DARKKHAKI:3182914559,DARKMAGENTA:2332068863,DARKOLIVEGREEN:1433087999,DARKORANGE:4287365375,DARKORCHID:2570243327,DARKRED:2332033279,DARKSALMON:3918953215,DARKSEAGREEN:2411499519,DARKSLATEBLUE:1211993087,DARKSLATEGRAY:793726975,DARKSLATEGREY:793726975,DARKTURQUOISE:13554175,DARKVIOLET:2483082239,DEEPPINK:4279538687,DEEPSKYBLUE:12582911,DIMGRAY:1768516095,DIMGREY:1768516095,DODGERBLUE:512819199,FIREBRICK:2988581631,FLORALWHITE:4294635775,FORESTGREEN:579543807,FUCHSIA:4278255615,GAINSBORO:3705462015,GHOSTWHITE:4177068031,GOLD:4292280575,GOLDENROD:3668254975,GRAY:2155905279,GREEN:8388863,GREENYELLOW:2919182335,GREY:2155905279,HONEYDEW:4043305215,HOTPINK:4285117695,INDIANRED:3445382399,INDIGO:1258324735,IVORY:4294963455,KHAKI:4041641215,LAVENDER:3873897215,LAVENDERBLUSH:4293981695,LAWNGREEN:2096890111,LEMONCHIFFON:4294626815,LIGHTBLUE:2916673279,LIGHTCORAL:4034953471,LIGHTCYAN:3774873599,LIGHTGOLDENRODYELLOW:4210742015,LIGHTGRAY:3553874943,LIGHTGREEN:2431553791,LIGHTGREY:3553874943,LIGHTPINK:4290167295,LIGHTSALMON:4288707327,LIGHTSEAGREEN:548580095,LIGHTSKYBLUE:2278488831,LIGHTSLATEGRAY:2005441023,LIGHTSLATEGREY:2005441023,LIGHTSTEELBLUE:2965692159,LIGHTYELLOW:4294959359,LIME:16711935,LIMEGREEN:852308735,LINEN:4210091775,MAGENTA:4278255615,MAROON:2147483903,MEDIUMAQUAMARINE:1724754687,MEDIUMBLUE:52735,MEDIUMORCHID:3126187007,MEDIUMPURPLE:2473647103,MEDIUMSEAGREEN:1018393087,MEDIUMSLATEBLUE:2070474495,MEDIUMSPRINGGREEN:16423679,MEDIUMTURQUOISE:1221709055,MEDIUMVIOLETRED:3340076543,MIDNIGHTBLUE:421097727,MINTCREAM:4127193855,MISTYROSE:4293190143,MOCCASIN:4293178879,NAVAJOWHITE:4292783615,NAVY:33023,OLDLACE:4260751103,OLIVE:2155872511,OLIVEDRAB:1804477439,ORANGE:4289003775,ORANGERED:4282712319,ORCHID:3664828159,PALEGOLDENROD:4008225535,PALEGREEN:2566625535,PALETURQUOISE:2951671551,PALEVIOLETRED:3681588223,PAPAYAWHIP:4293907967,PEACHPUFF:4292524543,PERU:3448061951,PINK:4290825215,PLUM:3718307327,POWDERBLUE:2967529215,PURPLE:2147516671,REBECCAPURPLE:1714657791,RED:4278190335,ROSYBROWN:3163525119,ROYALBLUE:1097458175,SADDLEBROWN:2336560127,SALMON:4202722047,SANDYBROWN:4104413439,SEAGREEN:780883967,SEASHELL:4294307583,SIENNA:2689740287,SILVER:3233857791,SKYBLUE:2278484991,SLATEBLUE:1784335871,SLATEGRAY:1887473919,SLATEGREY:1887473919,SNOW:4294638335,SPRINGGREEN:16744447,STEELBLUE:1182971135,TAN:3535047935,TEAL:8421631,THISTLE:3636451583,TOMATO:4284696575,TRANSPARENT:0,TURQUOISE:1088475391,VIOLET:4001558271,WHEAT:4125012991,WHITE:4294967295,WHITESMOKE:4126537215,YELLOW:4294902015,YELLOWGREEN:2597139199},tm={name:"background-clip",initialValue:"border-box",prefix:!1,type:1,parse:function(e,t){return t.map((function(e){if(xf(e))switch(e.value){case"padding-box":return 1;case"content-box":return 2}return 0}))}},im={name:"background-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},sm=function(e,t){var i=Gf(e,t[0]),s=t[1];return s&&Sf(s)?{color:i,stop:s}:{color:i,stop:null}},rm=function(e,t){var i=e[0],s=e[e.length-1];null===i.stop&&(i.stop=Uf),null===s.stop&&(s.stop=kf);for(var r=[],o=0,n=0;n<e.length;n++){var a=e[n].stop;if(null!==a){var l=Nf(a,t);l>o?r.push(l):r.push(o),o=l}else r.push(null)}var A=null;for(n=0;n<r.length;n++){var c=r[n];if(null===c)null===A&&(A=n);else if(null!==A){for(var h=n-A,u=(c-r[A-1])/(h+1),d=1;d<=h;d++)r[A+d-1]=u*d;A=null}}return e.map((function(e,i){return{color:e.color,stop:Math.max(Math.min(1,r[i]/t),0)}}))},om=function(e,t,i){var s="number"==typeof e?e:function(e,t,i){var s=t/2,r=i/2,o=Nf(e[0],t)-s,n=r-Nf(e[1],i);return(Math.atan2(n,o)+2*Math.PI)%(2*Math.PI)}(e,t,i),r=Math.abs(t*Math.sin(s))+Math.abs(i*Math.cos(s)),o=t/2,n=i/2,a=r/2,l=Math.sin(s-Math.PI/2)*a,A=Math.cos(s-Math.PI/2)*a;return[r,o-A,o+A,n-l,n+l]},nm=function(e,t){return Math.sqrt(e*e+t*t)},am=function(e,t,i,s,r){return[[0,0],[0,t],[e,0],[e,t]].reduce((function(e,t){var o=t[0],n=t[1],a=nm(i-o,s-n);return(r?a<e.optimumDistance:a>e.optimumDistance)?{optimumCorner:t,optimumDistance:a}:e}),{optimumDistance:r?1/0:-1/0,optimumCorner:null}).optimumCorner},lm=function(e,t){var i=jf(180),s=[];return If(t).forEach((function(t,r){if(0===r){var o=t[0];if(20===o.type&&-1!==["top","left","right","bottom"].indexOf(o.value))return void(i=Hf(t));if(Qf(o))return void(i=(Vf(e,o)+jf(270))%jf(360))}var n=sm(e,t);s.push(n)})),{angle:i,stops:s,type:1}},Am=function(e,t){var i=0,s=3,r=[],o=[];return If(t).forEach((function(t,n){var a=!0;if(0===n?a=t.reduce((function(e,t){if(xf(t))switch(t.value){case"center":return o.push(Lf),!1;case"top":case"left":return o.push(Uf),!1;case"right":case"bottom":return o.push(kf),!1}else if(Sf(t)||Df(t))return o.push(t),!1;return e}),a):1===n&&(a=t.reduce((function(e,t){if(xf(t))switch(t.value){case"circle":return i=0,!1;case"ellipse":return i=1,!1;case"contain":case"closest-side":return s=0,!1;case"farthest-side":return s=1,!1;case"closest-corner":return s=2,!1;case"cover":case"farthest-corner":return s=3,!1}else if(Df(t)||Sf(t))return Array.isArray(s)||(s=[]),s.push(t),!1;return e}),a)),a){var l=sm(e,t);r.push(l)}})),{size:s,shape:i,stops:r,position:o,type:2}},cm=function(e,t){if(22===t.type){var i={url:t.value,type:0};return e.cache.addImage(t.value),i}if(18===t.type){var s=um[t.name];if(void 0===s)throw new Error('Attempting to parse an unsupported image function "'+t.name+'"');return s(e,t.values)}throw new Error("Unsupported image type "+t.type)};var hm,um={"linear-gradient":function(e,t){var i=jf(180),s=[];return If(t).forEach((function(t,r){if(0===r){var o=t[0];if(20===o.type&&"to"===o.value)return void(i=Hf(t));if(Qf(o))return void(i=Vf(e,o))}var n=sm(e,t);s.push(n)})),{angle:i,stops:s,type:1}},"-moz-linear-gradient":lm,"-ms-linear-gradient":lm,"-o-linear-gradient":lm,"-webkit-linear-gradient":lm,"radial-gradient":function(e,t){var i=0,s=3,r=[],o=[];return If(t).forEach((function(t,n){var a=!0;if(0===n){var l=!1;a=t.reduce((function(e,t){if(l)if(xf(t))switch(t.value){case"center":return o.push(Lf),e;case"top":case"left":return o.push(Uf),e;case"right":case"bottom":return o.push(kf),e}else(Sf(t)||Df(t))&&o.push(t);else if(xf(t))switch(t.value){case"circle":return i=0,!1;case"ellipse":return i=1,!1;case"at":return l=!0,!1;case"closest-side":return s=0,!1;case"cover":case"farthest-side":return s=1,!1;case"contain":case"closest-corner":return s=2,!1;case"farthest-corner":return s=3,!1}else if(Df(t)||Sf(t))return Array.isArray(s)||(s=[]),s.push(t),!1;return e}),a)}if(a){var A=sm(e,t);r.push(A)}})),{size:s,shape:i,stops:r,position:o,type:2}},"-moz-radial-gradient":Am,"-ms-radial-gradient":Am,"-o-radial-gradient":Am,"-webkit-radial-gradient":Am,"-webkit-gradient":function(e,t){var i=jf(180),s=[],r=1;return If(t).forEach((function(t,i){var o=t[0];if(0===i){if(xf(o)&&"linear"===o.value)return void(r=1);if(xf(o)&&"radial"===o.value)return void(r=2)}if(18===o.type)if("from"===o.name){var n=Gf(e,o.values[0]);s.push({stop:Uf,color:n})}else if("to"===o.name){n=Gf(e,o.values[0]);s.push({stop:kf,color:n})}else if("color-stop"===o.name){var a=o.values.filter(Ff);if(2===a.length){n=Gf(e,a[1]);var l=a[0];Pf(l)&&s.push({stop:{type:16,number:100*l.number,flags:l.flags},color:n})}}})),1===r?{angle:(i+jf(180))%jf(360),stops:s,type:r}:{size:3,shape:0,stops:s,position:[],type:r}}},dm={name:"background-image",initialValue:"none",type:1,prefix:!1,parse:function(e,t){if(0===t.length)return[];var i=t[0];return 20===i.type&&"none"===i.value?[]:t.filter((function(e){return Ff(e)&&function(e){return!(20===e.type&&"none"===e.value||18===e.type&&!um[e.name])}(e)})).map((function(t){return cm(e,t)}))}},pm={name:"background-origin",initialValue:"border-box",prefix:!1,type:1,parse:function(e,t){return t.map((function(e){if(xf(e))switch(e.value){case"padding-box":return 1;case"content-box":return 2}return 0}))}},fm={name:"background-position",initialValue:"0% 0%",type:1,prefix:!1,parse:function(e,t){return If(t).map((function(e){return e.filter(Sf)})).map(Rf)}},mm={name:"background-repeat",initialValue:"repeat",prefix:!1,type:1,parse:function(e,t){return If(t).map((function(e){return e.filter(xf).map((function(e){return e.value})).join(" ")})).map(gm)}},gm=function(e){switch(e){case"no-repeat":return 1;case"repeat-x":case"repeat no-repeat":return 2;case"repeat-y":case"no-repeat repeat":return 3;default:return 0}};!function(e){e.AUTO="auto",e.CONTAIN="contain",e.COVER="cover"}(hm||(hm={}));var _m,vm={name:"background-size",initialValue:"0",prefix:!1,type:1,parse:function(e,t){return If(t).map((function(e){return e.filter(bm)}))}},bm=function(e){return xf(e)||Sf(e)},ym=function(e){return{name:"border-"+e+"-color",initialValue:"transparent",prefix:!1,type:3,format:"color"}},wm=ym("top"),Bm=ym("right"),Pm=ym("bottom"),xm=ym("left"),Cm=function(e){return{name:"border-radius-"+e,initialValue:"0 0",prefix:!1,type:1,parse:function(e,t){return Rf(t.filter(Sf))}}},Mm=Cm("top-left"),Em=Cm("top-right"),Fm=Cm("bottom-right"),Im=Cm("bottom-left"),Tm=function(e){return{name:"border-"+e+"-style",initialValue:"solid",prefix:!1,type:2,parse:function(e,t){switch(t){case"none":return 0;case"dashed":return 2;case"dotted":return 3;case"double":return 4}return 1}}},Dm=Tm("top"),Sm=Tm("right"),Rm=Tm("bottom"),Um=Tm("left"),Lm=function(e){return{name:"border-"+e+"-width",initialValue:"0",type:0,prefix:!1,parse:function(e,t){return Bf(t)?t.number:0}}},km=Lm("top"),Om=Lm("right"),Nm=Lm("bottom"),Vm=Lm("left"),Qm={name:"color",initialValue:"transparent",prefix:!1,type:3,format:"color"},Hm={name:"direction",initialValue:"ltr",prefix:!1,type:2,parse:function(e,t){return"rtl"===t?1:0}},jm={name:"display",initialValue:"inline-block",prefix:!1,type:1,parse:function(e,t){return t.filter(xf).reduce((function(e,t){return e|Gm(t.value)}),0)}},Gm=function(e){switch(e){case"block":case"-webkit-box":return 2;case"inline":return 4;case"run-in":return 8;case"flow":return 16;case"flow-root":return 32;case"table":return 64;case"flex":case"-webkit-flex":return 128;case"grid":case"-ms-grid":return 256;case"ruby":return 512;case"subgrid":return 1024;case"list-item":return 2048;case"table-row-group":return 4096;case"table-header-group":return 8192;case"table-footer-group":return 16384;case"table-row":return 32768;case"table-cell":return 65536;case"table-column-group":return 131072;case"table-column":return 262144;case"table-caption":return 524288;case"ruby-base":return 1048576;case"ruby-text":return 2097152;case"ruby-base-container":return 4194304;case"ruby-text-container":return 8388608;case"contents":return 16777216;case"inline-block":return 33554432;case"inline-list-item":return 67108864;case"inline-table":return 134217728;case"inline-flex":return 268435456;case"inline-grid":return 536870912}return 0},zm={name:"float",initialValue:"none",prefix:!1,type:2,parse:function(e,t){switch(t){case"left":return 1;case"right":return 2;case"inline-start":return 3;case"inline-end":return 4}return 0}},Wm={name:"letter-spacing",initialValue:"0",prefix:!1,type:0,parse:function(e,t){return 20===t.type&&"normal"===t.value?0:17===t.type||15===t.type?t.number:0}};!function(e){e.NORMAL="normal",e.STRICT="strict"}(_m||(_m={}));var Xm,Km={name:"line-break",initialValue:"normal",prefix:!1,type:2,parse:function(e,t){return"strict"===t?_m.STRICT:_m.NORMAL}},Zm={name:"line-height",initialValue:"normal",prefix:!1,type:4},Jm=function(e,t){return xf(e)&&"normal"===e.value?1.2*t:17===e.type?t*e.number:Sf(e)?Nf(e,t):t},Ym={name:"list-style-image",initialValue:"none",type:0,prefix:!1,parse:function(e,t){return 20===t.type&&"none"===t.value?null:cm(e,t)}},qm={name:"list-style-position",initialValue:"outside",prefix:!1,type:2,parse:function(e,t){return"inside"===t?0:1}},$m={name:"list-style-type",initialValue:"none",prefix:!1,type:2,parse:function(e,t){switch(t){case"disc":return 0;case"circle":return 1;case"square":return 2;case"decimal":return 3;case"cjk-decimal":return 4;case"decimal-leading-zero":return 5;case"lower-roman":return 6;case"upper-roman":return 7;case"lower-greek":return 8;case"lower-alpha":return 9;case"upper-alpha":return 10;case"arabic-indic":return 11;case"armenian":return 12;case"bengali":return 13;case"cambodian":return 14;case"cjk-earthly-branch":return 15;case"cjk-heavenly-stem":return 16;case"cjk-ideographic":return 17;case"devanagari":return 18;case"ethiopic-numeric":return 19;case"georgian":return 20;case"gujarati":return 21;case"gurmukhi":case"hebrew":return 22;case"hiragana":return 23;case"hiragana-iroha":return 24;case"japanese-formal":return 25;case"japanese-informal":return 26;case"kannada":return 27;case"katakana":return 28;case"katakana-iroha":return 29;case"khmer":return 30;case"korean-hangul-formal":return 31;case"korean-hanja-formal":return 32;case"korean-hanja-informal":return 33;case"lao":return 34;case"lower-armenian":return 35;case"malayalam":return 36;case"mongolian":return 37;case"myanmar":return 38;case"oriya":return 39;case"persian":return 40;case"simp-chinese-formal":return 41;case"simp-chinese-informal":return 42;case"tamil":return 43;case"telugu":return 44;case"thai":return 45;case"tibetan":return 46;case"trad-chinese-formal":return 47;case"trad-chinese-informal":return 48;case"upper-armenian":return 49;case"disclosure-open":return 50;case"disclosure-closed":return 51;default:return-1}}},eg=function(e){return{name:"margin-"+e,initialValue:"0",prefix:!1,type:4}},tg=eg("top"),ig=eg("right"),sg=eg("bottom"),rg=eg("left"),og={name:"overflow",initialValue:"visible",prefix:!1,type:1,parse:function(e,t){return t.filter(xf).map((function(e){switch(e.value){case"hidden":return 1;case"scroll":return 2;case"clip":return 3;case"auto":return 4;default:return 0}}))}},ng={name:"overflow-wrap",initialValue:"normal",prefix:!1,type:2,parse:function(e,t){return"break-word"===t?"break-word":"normal"}},ag=function(e){return{name:"padding-"+e,initialValue:"0",prefix:!1,type:3,format:"length-percentage"}},lg=ag("top"),Ag=ag("right"),cg=ag("bottom"),hg=ag("left"),ug={name:"text-align",initialValue:"left",prefix:!1,type:2,parse:function(e,t){switch(t){case"right":return 2;case"center":case"justify":return 1;default:return 0}}},dg={name:"position",initialValue:"static",prefix:!1,type:2,parse:function(e,t){switch(t){case"relative":return 1;case"absolute":return 2;case"fixed":return 3;case"sticky":return 4}return 0}},pg={name:"text-shadow",initialValue:"none",type:1,prefix:!1,parse:function(e,t){return 1===t.length&&Mf(t[0],"none")?[]:If(t).map((function(t){for(var i={color:em.TRANSPARENT,offsetX:Uf,offsetY:Uf,blur:Uf},s=0,r=0;r<t.length;r++){var o=t[r];Df(o)?(0===s?i.offsetX=o:1===s?i.offsetY=o:i.blur=o,s++):i.color=Gf(e,o)}return i}))}},fg={name:"text-transform",initialValue:"none",prefix:!1,type:2,parse:function(e,t){switch(t){case"uppercase":return 2;case"lowercase":return 1;case"capitalize":return 3}return 0}},mg={name:"transform",initialValue:"none",prefix:!0,type:0,parse:function(e,t){if(20===t.type&&"none"===t.value)return null;if(18===t.type){var i=gg[t.name];if(void 0===i)throw new Error('Attempting to parse an unsupported transform function "'+t.name+'"');return i(t.values)}return null}},gg={matrix:function(e){var t=e.filter((function(e){return 17===e.type})).map((function(e){return e.number}));return 6===t.length?t:null},matrix3d:function(e){var t=e.filter((function(e){return 17===e.type})).map((function(e){return e.number})),i=t[0],s=t[1];t[2],t[3];var r=t[4],o=t[5];t[6],t[7],t[8],t[9],t[10],t[11];var n=t[12],a=t[13];return t[14],t[15],16===t.length?[i,s,r,o,n,a]:null}},_g={type:16,number:50,flags:4},vg=[_g,_g],bg={name:"transform-origin",initialValue:"50% 50%",prefix:!0,type:1,parse:function(e,t){var i=t.filter(Sf);return 2!==i.length?vg:[i[0],i[1]]}},yg={name:"visible",initialValue:"none",prefix:!1,type:2,parse:function(e,t){switch(t){case"hidden":return 1;case"collapse":return 2;default:return 0}}};!function(e){e.NORMAL="normal",e.BREAK_ALL="break-all",e.KEEP_ALL="keep-all"}(Xm||(Xm={}));for(var wg={name:"word-break",initialValue:"normal",prefix:!1,type:2,parse:function(e,t){switch(t){case"break-all":return Xm.BREAK_ALL;case"keep-all":return Xm.KEEP_ALL;default:return Xm.NORMAL}}},Bg={name:"z-index",initialValue:"auto",prefix:!1,type:0,parse:function(e,t){if(20===t.type)return{auto:!0,order:0};if(Pf(t))return{auto:!1,order:t.number};throw new Error("Invalid z-index number parsed")}},Pg=function(e,t){if(15===t.type)switch(t.unit.toLowerCase()){case"s":return 1e3*t.number;case"ms":return t.number}throw new Error("Unsupported time type")},xg={name:"opacity",initialValue:"1",type:0,prefix:!1,parse:function(e,t){return Pf(t)?t.number:1}},Cg={name:"text-decoration-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},Mg={name:"text-decoration-line",initialValue:"none",prefix:!1,type:1,parse:function(e,t){return t.filter(xf).map((function(e){switch(e.value){case"underline":return 1;case"overline":return 2;case"line-through":return 3;case"none":return 4}return 0})).filter((function(e){return 0!==e}))}},Eg={name:"font-family",initialValue:"",prefix:!1,type:1,parse:function(e,t){var i=[],s=[];return t.forEach((function(e){switch(e.type){case 20:case 0:i.push(e.value);break;case 17:i.push(e.number.toString());break;case 4:s.push(i.join(" ")),i.length=0}})),i.length&&s.push(i.join(" ")),s.map((function(e){return-1===e.indexOf(" ")?e:"'"+e+"'"}))}},Fg={name:"font-size",initialValue:"0",prefix:!1,type:3,format:"length"},Ig={name:"font-weight",initialValue:"normal",type:0,prefix:!1,parse:function(e,t){return Pf(t)?t.number:xf(t)&&"bold"===t.value?700:400}},Tg={name:"font-variant",initialValue:"none",type:1,prefix:!1,parse:function(e,t){return t.filter(xf).map((function(e){return e.value}))}},Dg={name:"font-style",initialValue:"normal",prefix:!1,type:2,parse:function(e,t){switch(t){case"oblique":return"oblique";case"italic":return"italic";default:return"normal"}}},Sg=function(e,t){return 0!=(e&t)},Rg={name:"content",initialValue:"none",type:1,prefix:!1,parse:function(e,t){if(0===t.length)return[];var i=t[0];return 20===i.type&&"none"===i.value?[]:t}},Ug={name:"counter-increment",initialValue:"none",prefix:!0,type:1,parse:function(e,t){if(0===t.length)return null;var i=t[0];if(20===i.type&&"none"===i.value)return null;for(var s=[],r=t.filter(Ef),o=0;o<r.length;o++){var n=r[o],a=r[o+1];if(20===n.type){var l=a&&Pf(a)?a.number:1;s.push({counter:n.value,increment:l})}}return s}},Lg={name:"counter-reset",initialValue:"none",prefix:!0,type:1,parse:function(e,t){if(0===t.length)return[];for(var i=[],s=t.filter(Ef),r=0;r<s.length;r++){var o=s[r],n=s[r+1];if(xf(o)&&"none"!==o.value){var a=n&&Pf(n)?n.number:0;i.push({counter:o.value,reset:a})}}return i}},kg={name:"duration",initialValue:"0s",prefix:!1,type:1,parse:function(e,t){return t.filter(Bf).map((function(t){return Pg(e,t)}))}},Og={name:"quotes",initialValue:"none",prefix:!0,type:1,parse:function(e,t){if(0===t.length)return null;var i=t[0];if(20===i.type&&"none"===i.value)return null;var s=[],r=t.filter(Cf);if(r.length%2!=0)return null;for(var o=0;o<r.length;o+=2){var n=r[o].value,a=r[o+1].value;s.push({open:n,close:a})}return s}},Ng=function(e,t,i){if(!e)return"";var s=e[Math.min(t,e.length-1)];return s?i?s.open:s.close:""},Vg={name:"box-shadow",initialValue:"none",type:1,prefix:!1,parse:function(e,t){return 1===t.length&&Mf(t[0],"none")?[]:If(t).map((function(t){for(var i={color:255,offsetX:Uf,offsetY:Uf,blur:Uf,spread:Uf,inset:!1},s=0,r=0;r<t.length;r++){var o=t[r];Mf(o,"inset")?i.inset=!0:Df(o)?(0===s?i.offsetX=o:1===s?i.offsetY=o:2===s?i.blur=o:i.spread=o,s++):i.color=Gf(e,o)}return i}))}},Qg={name:"paint-order",initialValue:"normal",prefix:!1,type:1,parse:function(e,t){var i=[];return t.filter(xf).forEach((function(e){switch(e.value){case"stroke":i.push(1);break;case"fill":i.push(0);break;case"markers":i.push(2)}})),[0,1,2].forEach((function(e){-1===i.indexOf(e)&&i.push(e)})),i}},Hg={name:"-webkit-text-stroke-color",initialValue:"currentcolor",prefix:!1,type:3,format:"color"},jg={name:"-webkit-text-stroke-width",initialValue:"0",type:0,prefix:!1,parse:function(e,t){return Bf(t)?t.number:0}},Gg=function(){function e(e,t){var i,s;this.animationDuration=Xg(e,kg,t.animationDuration),this.backgroundClip=Xg(e,tm,t.backgroundClip),this.backgroundColor=Xg(e,im,t.backgroundColor),this.backgroundImage=Xg(e,dm,t.backgroundImage),this.backgroundOrigin=Xg(e,pm,t.backgroundOrigin),this.backgroundPosition=Xg(e,fm,t.backgroundPosition),this.backgroundRepeat=Xg(e,mm,t.backgroundRepeat),this.backgroundSize=Xg(e,vm,t.backgroundSize),this.borderTopColor=Xg(e,wm,t.borderTopColor),this.borderRightColor=Xg(e,Bm,t.borderRightColor),this.borderBottomColor=Xg(e,Pm,t.borderBottomColor),this.borderLeftColor=Xg(e,xm,t.borderLeftColor),this.borderTopLeftRadius=Xg(e,Mm,t.borderTopLeftRadius),this.borderTopRightRadius=Xg(e,Em,t.borderTopRightRadius),this.borderBottomRightRadius=Xg(e,Fm,t.borderBottomRightRadius),this.borderBottomLeftRadius=Xg(e,Im,t.borderBottomLeftRadius),this.borderTopStyle=Xg(e,Dm,t.borderTopStyle),this.borderRightStyle=Xg(e,Sm,t.borderRightStyle),this.borderBottomStyle=Xg(e,Rm,t.borderBottomStyle),this.borderLeftStyle=Xg(e,Um,t.borderLeftStyle),this.borderTopWidth=Xg(e,km,t.borderTopWidth),this.borderRightWidth=Xg(e,Om,t.borderRightWidth),this.borderBottomWidth=Xg(e,Nm,t.borderBottomWidth),this.borderLeftWidth=Xg(e,Vm,t.borderLeftWidth),this.boxShadow=Xg(e,Vg,t.boxShadow),this.color=Xg(e,Qm,t.color),this.direction=Xg(e,Hm,t.direction),this.display=Xg(e,jm,t.display),this.float=Xg(e,zm,t.cssFloat),this.fontFamily=Xg(e,Eg,t.fontFamily),this.fontSize=Xg(e,Fg,t.fontSize),this.fontStyle=Xg(e,Dg,t.fontStyle),this.fontVariant=Xg(e,Tg,t.fontVariant),this.fontWeight=Xg(e,Ig,t.fontWeight),this.letterSpacing=Xg(e,Wm,t.letterSpacing),this.lineBreak=Xg(e,Km,t.lineBreak),this.lineHeight=Xg(e,Zm,t.lineHeight),this.listStyleImage=Xg(e,Ym,t.listStyleImage),this.listStylePosition=Xg(e,qm,t.listStylePosition),this.listStyleType=Xg(e,$m,t.listStyleType),this.marginTop=Xg(e,tg,t.marginTop),this.marginRight=Xg(e,ig,t.marginRight),this.marginBottom=Xg(e,sg,t.marginBottom),this.marginLeft=Xg(e,rg,t.marginLeft),this.opacity=Xg(e,xg,t.opacity);var r=Xg(e,og,t.overflow);this.overflowX=r[0],this.overflowY=r[r.length>1?1:0],this.overflowWrap=Xg(e,ng,t.overflowWrap),this.paddingTop=Xg(e,lg,t.paddingTop),this.paddingRight=Xg(e,Ag,t.paddingRight),this.paddingBottom=Xg(e,cg,t.paddingBottom),this.paddingLeft=Xg(e,hg,t.paddingLeft),this.paintOrder=Xg(e,Qg,t.paintOrder),this.position=Xg(e,dg,t.position),this.textAlign=Xg(e,ug,t.textAlign),this.textDecorationColor=Xg(e,Cg,null!==(i=t.textDecorationColor)&&void 0!==i?i:t.color),this.textDecorationLine=Xg(e,Mg,null!==(s=t.textDecorationLine)&&void 0!==s?s:t.textDecoration),this.textShadow=Xg(e,pg,t.textShadow),this.textTransform=Xg(e,fg,t.textTransform),this.transform=Xg(e,mg,t.transform),this.transformOrigin=Xg(e,bg,t.transformOrigin),this.visibility=Xg(e,yg,t.visibility),this.webkitTextStrokeColor=Xg(e,Hg,t.webkitTextStrokeColor),this.webkitTextStrokeWidth=Xg(e,jg,t.webkitTextStrokeWidth),this.wordBreak=Xg(e,wg,t.wordBreak),this.zIndex=Xg(e,Bg,t.zIndex)}return e.prototype.isVisible=function(){return this.display>0&&this.opacity>0&&0===this.visibility},e.prototype.isTransparent=function(){return zf(this.backgroundColor)},e.prototype.isTransformed=function(){return null!==this.transform},e.prototype.isPositioned=function(){return 0!==this.position},e.prototype.isPositionedWithZIndex=function(){return this.isPositioned()&&!this.zIndex.auto},e.prototype.isFloating=function(){return 0!==this.float},e.prototype.isInlineLevel=function(){return Sg(this.display,4)||Sg(this.display,33554432)||Sg(this.display,268435456)||Sg(this.display,536870912)||Sg(this.display,67108864)||Sg(this.display,134217728)},e}(),zg=function(e,t){this.content=Xg(e,Rg,t.content),this.quotes=Xg(e,Og,t.quotes)},Wg=function(e,t){this.counterIncrement=Xg(e,Ug,t.counterIncrement),this.counterReset=Xg(e,Lg,t.counterReset)},Xg=function(e,t,i){var s=new yf,r=null!=i?i.toString():t.initialValue;s.write(r);var o=new wf(s.read());switch(t.type){case 2:var n=o.parseComponentValue();return t.parse(e,xf(n)?n.value:t.initialValue);case 0:return t.parse(e,o.parseComponentValue());case 1:return t.parse(e,o.parseComponentValues());case 4:return o.parseComponentValue();case 3:switch(t.format){case"angle":return Vf(e,o.parseComponentValue());case"color":return Gf(e,o.parseComponentValue());case"image":return cm(e,o.parseComponentValue());case"length":var a=o.parseComponentValue();return Df(a)?a:Uf;case"length-percentage":var l=o.parseComponentValue();return Sf(l)?l:Uf;case"time":return Pg(e,o.parseComponentValue())}}},Kg=function(e,t){var i=function(e){switch(e.getAttribute("data-html2canvas-debug")){case"all":return 1;case"clone":return 2;case"parse":return 3;case"render":return 4;default:return 0}}(e);return 1===i||t===i},Zg=function(e,t){this.context=e,this.textNodes=[],this.elements=[],this.flags=0,Kg(t,3),this.styles=new Gg(e,window.getComputedStyle(t,null)),Z_(t)&&(this.styles.animationDuration.some((function(e){return e>0}))&&(t.style.animationDuration="0s"),null!==this.styles.transform&&(t.style.transform="none")),this.bounds=zd(this.context,t),Kg(t,4)&&(this.flags|=16)},Jg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Yg="undefined"==typeof Uint8Array?[]:new Uint8Array(256),qg=0;qg<Jg.length;qg++)Yg[Jg.charCodeAt(qg)]=qg;for(var $g=function(e,t,i){return e.slice?e.slice(t,i):new Uint16Array(Array.prototype.slice.call(e,t,i))},e_=function(){function e(e,t,i,s,r,o){this.initialValue=e,this.errorValue=t,this.highStart=i,this.highValueIndex=s,this.index=r,this.data=o}return e.prototype.get=function(e){var t;if(e>=0){if(e<55296||e>56319&&e<=65535)return t=((t=this.index[e>>5])<<2)+(31&e),this.data[t];if(e<=65535)return t=((t=this.index[2048+(e-55296>>5)])<<2)+(31&e),this.data[t];if(e<this.highStart)return t=2080+(e>>11),t=this.index[t],t+=e>>5&63,t=((t=this.index[t])<<2)+(31&e),this.data[t];if(e<=1114111)return this.data[this.highValueIndex]}return this.errorValue},e}(),t_="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i_="undefined"==typeof Uint8Array?[]:new Uint8Array(256),s_=0;s_<t_.length;s_++)i_[t_.charCodeAt(s_)]=s_;var r_,o_=8,n_=9,a_=11,l_=12,A_=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];if(String.fromCodePoint)return String.fromCodePoint.apply(String,e);var i=e.length;if(!i)return"";for(var s=[],r=-1,o="";++r<i;){var n=e[r];n<=65535?s.push(n):(n-=65536,s.push(55296+(n>>10),n%1024+56320)),(r+1===i||s.length>16384)&&(o+=String.fromCharCode.apply(String,s),s.length=0)}return o},c_=function(e,t){var i,s,r,o=function(e){var t,i,s,r,o,n=.75*e.length,a=e.length,l=0;"="===e[e.length-1]&&(n--,"="===e[e.length-2]&&n--);var A="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array&&void 0!==Uint8Array.prototype.slice?new ArrayBuffer(n):new Array(n),c=Array.isArray(A)?A:new Uint8Array(A);for(t=0;t<a;t+=4)i=Yg[e.charCodeAt(t)],s=Yg[e.charCodeAt(t+1)],r=Yg[e.charCodeAt(t+2)],o=Yg[e.charCodeAt(t+3)],c[l++]=i<<2|s>>4,c[l++]=(15&s)<<4|r>>2,c[l++]=(3&r)<<6|63&o;return A}(e),n=Array.isArray(o)?function(e){for(var t=e.length,i=[],s=0;s<t;s+=4)i.push(e[s+3]<<24|e[s+2]<<16|e[s+1]<<8|e[s]);return i}(o):new Uint32Array(o),a=Array.isArray(o)?function(e){for(var t=e.length,i=[],s=0;s<t;s+=2)i.push(e[s+1]<<8|e[s]);return i}(o):new Uint16Array(o),l=$g(a,12,n[4]/2),A=2===n[5]?$g(a,(24+n[4])/2):(i=n,s=Math.ceil((24+n[4])/4),i.slice?i.slice(s,r):new Uint32Array(Array.prototype.slice.call(i,s,r)));return new e_(n[0],n[1],n[2],n[3],l,A)}("AAAAAAAAAAAAEA4AGBkAAFAaAAACAAAAAAAIABAAGAAwADgACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAAQABIAEQATAAIABAACAAQAAgAEAAIABAAVABcAAgAEAAIABAACAAQAGAAaABwAHgAgACIAI4AlgAIABAAmwCjAKgAsAC2AL4AvQDFAMoA0gBPAVYBWgEIAAgACACMANoAYgFkAWwBdAF8AX0BhQGNAZUBlgGeAaMBlQGWAasBswF8AbsBwwF0AcsBYwHTAQgA2wG/AOMBdAF8AekB8QF0AfkB+wHiAHQBfAEIAAMC5gQIAAsCEgIIAAgAFgIeAggAIgIpAggAMQI5AkACygEIAAgASAJQAlgCYAIIAAgACAAKBQoFCgUTBRMFGQUrBSsFCAAIAAgACAAIAAgACAAIAAgACABdAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABoAmgCrwGvAQgAbgJ2AggAHgEIAAgACADnAXsCCAAIAAgAgwIIAAgACAAIAAgACACKAggAkQKZAggAPADJAAgAoQKkAqwCsgK6AsICCADJAggA0AIIAAgACAAIANYC3gIIAAgACAAIAAgACABAAOYCCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAkASoB+QIEAAgACAA8AEMCCABCBQgACABJBVAFCAAIAAgACAAIAAgACAAIAAgACABTBVoFCAAIAFoFCABfBWUFCAAIAAgACAAIAAgAbQUIAAgACAAIAAgACABzBXsFfQWFBYoFigWKBZEFigWKBYoFmAWfBaYFrgWxBbkFCAAIAAgACAAIAAgACAAIAAgACAAIAMEFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAMgFCADQBQgACAAIAAgACAAIAAgACAAIAAgACAAIAO4CCAAIAAgAiQAIAAgACABAAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAD0AggACAD8AggACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIANYFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAMDvwAIAAgAJAIIAAgACAAIAAgACAAIAAgACwMTAwgACAB9BOsEGwMjAwgAKwMyAwsFYgE3A/MEPwMIAEUDTQNRAwgAWQOsAGEDCAAIAAgACAAIAAgACABpAzQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFIQUoBSwFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABtAwgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABMAEwACAAIAAgACAAIABgACAAIAAgACAC/AAgACAAyAQgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACAAIAAwAAgACAAIAAgACAAIAAgACAAIAAAARABIAAgACAAIABQASAAIAAgAIABwAEAAjgCIABsAqAC2AL0AigDQAtwC+IJIQqVAZUBWQqVAZUBlQGVAZUBlQGrC5UBlQGVAZUBlQGVAZUBlQGVAXsKlQGVAbAK6wsrDGUMpQzlDJUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAfAKAAuZA64AtwCJALoC6ADwAAgAuACgA/oEpgO6AqsD+AAIAAgAswMIAAgACAAIAIkAuwP5AfsBwwPLAwgACAAIAAgACADRA9kDCAAIAOED6QMIAAgACAAIAAgACADuA/YDCAAIAP4DyQAIAAgABgQIAAgAXQAOBAgACAAIAAgACAAIABMECAAIAAgACAAIAAgACAD8AAQBCAAIAAgAGgQiBCoECAExBAgAEAEIAAgACAAIAAgACAAIAAgACAAIAAgACAA4BAgACABABEYECAAIAAgATAQYAQgAVAQIAAgACAAIAAgACAAIAAgACAAIAFoECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAOQEIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAB+BAcACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAEABhgSMBAgACAAIAAgAlAQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAwAEAAQABAADAAMAAwADAAQABAAEAAQABAAEAAQABHATAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAdQMIAAgACAAIAAgACAAIAMkACAAIAAgAfQMIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACFA4kDCAAIAAgACAAIAOcBCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAIcDCAAIAAgACAAIAAgACAAIAAgACAAIAJEDCAAIAAgACADFAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABgBAgAZgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAbAQCBXIECAAIAHkECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABAAJwEQACjBKoEsgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAC6BMIECAAIAAgACAAIAAgACABmBAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAxwQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAGYECAAIAAgAzgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBd0FXwUIAOIF6gXxBYoF3gT5BQAGCAaKBYoFigWKBYoFigWKBYoFigWKBYoFigXWBIoFigWKBYoFigWKBYoFigWKBYsFEAaKBYoFigWKBYoFigWKBRQGCACKBYoFigWKBQgACAAIANEECAAIABgGigUgBggAJgYIAC4GMwaKBYoF0wQ3Bj4GigWKBYoFigWKBYoFigWKBYoFigWKBYoFigUIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWLBf///////wQABAAEAAQABAAEAAQABAAEAAQAAwAEAAQAAgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAQADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUAAAAFAAUAAAAFAAUAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAQAAAAUABQAFAAUABQAFAAAAAAAFAAUAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAFAAUAAQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAAABwAHAAcAAAAHAAcABwAFAAEAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAcABwAFAAUAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAAAAQABAAAAAAAAAAAAAAAFAAUABQAFAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAHAAcAAAAHAAcAAAAAAAUABQAHAAUAAQAHAAEABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwABAAUABQAFAAUAAAAAAAAAAAAAAAEAAQABAAEAAQABAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABQANAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAABQAHAAUABQAFAAAAAAAAAAcABQAFAAUABQAFAAQABAAEAAQABAAEAAQABAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUAAAAFAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAUAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAcABwAFAAcABwAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUABwAHAAUABQAFAAUAAAAAAAcABwAAAAAABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAAAAAAAAAAABQAFAAAAAAAFAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAFAAUABQAFAAUAAAAFAAUABwAAAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABwAFAAUABQAFAAAAAAAHAAcAAAAAAAcABwAFAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAAAAAAAAAHAAcABwAAAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAUABQAFAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAHAAcABQAHAAcAAAAFAAcABwAAAAcABwAFAAUAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAFAAcABwAFAAUABQAAAAUAAAAHAAcABwAHAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAHAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUAAAAFAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAUAAAAFAAUAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABwAFAAUABQAFAAUABQAAAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABQAFAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAFAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAHAAUABQAFAAUABQAFAAUABwAHAAcABwAHAAcABwAHAAUABwAHAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABwAHAAcABwAFAAUABwAHAAcAAAAAAAAAAAAHAAcABQAHAAcABwAHAAcABwAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAUABQAFAAUABQAFAAUAAAAFAAAABQAAAAAABQAFAAUABQAFAAUABQAFAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAUABQAFAAUABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABwAFAAcABwAHAAcABwAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAUABQAFAAUABwAHAAUABQAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABQAFAAcABwAHAAUABwAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAcABQAFAAUABQAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAAAAAABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAAAAAAAAAFAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAUABQAHAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAFAAUABQAFAAcABwAFAAUABwAHAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAcABwAFAAUABwAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABQAAAAAABQAFAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAcABwAAAAAAAAAAAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAcABwAFAAcABwAAAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAFAAUABQAAAAUABQAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABwAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAHAAcABQAHAAUABQAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAAABwAHAAAAAAAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAFAAUABwAFAAcABwAFAAcABQAFAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAAAAAABwAHAAcABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAFAAcABwAFAAUABQAFAAUABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAUABQAFAAcABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABQAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAAAAAAFAAUABwAHAAcABwAFAAAAAAAAAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAHAAUABQAFAAUABQAFAAUABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAABQAAAAUABQAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAHAAcAAAAFAAUAAAAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABQAFAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAABQAFAAUABQAFAAUABQAAAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAFAAUABQAFAAUADgAOAA4ADgAOAA4ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAMAAwADAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkAAAAAAAAAAAAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAAAAAAAAAAAAsADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwACwAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAADgAOAA4AAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAAAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4AAAAOAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAAAAAAAAAAAA4AAAAOAAAAAAAAAAAADgAOAA4AAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAA="),h_=function(e){return c_.get(e)},u_=function(e,t,i){var s=i-2,r=t[s],o=t[i-1],n=t[i];if(2===o&&3===n)return"×";if(2===o||3===o||4===o)return"÷";if(2===n||3===n||4===n)return"÷";if(o===o_&&-1!==[o_,n_,a_,l_].indexOf(n))return"×";if(!(o!==a_&&o!==n_||n!==n_&&10!==n))return"×";if((o===l_||10===o)&&10===n)return"×";if(13===n||5===n)return"×";if(7===n)return"×";if(1===o)return"×";if(13===o&&14===n){for(;5===r;)r=t[--s];if(14===r)return"×"}if(15===o&&15===n){for(var a=0;15===r;)a++,r=t[--s];if(a%2==0)return"×"}return"÷"},d_=function(e){var t=function(e){for(var t=[],i=0,s=e.length;i<s;){var r=e.charCodeAt(i++);if(r>=55296&&r<=56319&&i<s){var o=e.charCodeAt(i++);56320==(64512&o)?t.push(((1023&r)<<10)+(1023&o)+65536):(t.push(r),i--)}else t.push(r)}return t}(e),i=t.length,s=0,r=0,o=t.map(h_);return{next:function(){if(s>=i)return{done:!0,value:null};for(var e="×";s<i&&"×"===(e=u_(0,o,++s)););if("×"!==e||s===i){var n=A_.apply(null,t.slice(r,s));return r=s,{value:n,done:!1}}return{done:!0,value:null}}}},p_=function(e){return 0===e[0]&&255===e[1]&&0===e[2]&&255===e[3]},f_=function(e,t,i,s,r){var o="http://www.w3.org/2000/svg",n=document.createElementNS(o,"svg"),a=document.createElementNS(o,"foreignObject");return n.setAttributeNS(null,"width",e.toString()),n.setAttributeNS(null,"height",t.toString()),a.setAttributeNS(null,"width","100%"),a.setAttributeNS(null,"height","100%"),a.setAttributeNS(null,"x",i.toString()),a.setAttributeNS(null,"y",s.toString()),a.setAttributeNS(null,"externalResourcesRequired","true"),n.appendChild(a),a.appendChild(r),n},m_=function(e){return new Promise((function(t,i){var s=new Image;s.onload=function(){return t(s)},s.onerror=i,s.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent((new XMLSerializer).serializeToString(e))}))},g_={get SUPPORT_RANGE_BOUNDS(){var e=function(e){if(e.createRange){var t=e.createRange();if(t.getBoundingClientRect){var i=e.createElement("boundtest");i.style.height="123px",i.style.display="block",e.body.appendChild(i),t.selectNode(i);var s=t.getBoundingClientRect(),r=Math.round(s.height);if(e.body.removeChild(i),123===r)return!0}}return!1}(document);return Object.defineProperty(g_,"SUPPORT_RANGE_BOUNDS",{value:e}),e},get SUPPORT_WORD_BREAKING(){var e=g_.SUPPORT_RANGE_BOUNDS&&function(e){var t=e.createElement("boundtest");t.style.width="50px",t.style.display="block",t.style.fontSize="12px",t.style.letterSpacing="0px",t.style.wordSpacing="0px",e.body.appendChild(t);var i=e.createRange();t.innerHTML="function"==typeof"".repeat?"&#128104;".repeat(10):"";var s=t.firstChild,r=Wd(s.data).map((function(e){return Xd(e)})),o=0,n={},a=r.every((function(e,t){i.setStart(s,o),i.setEnd(s,o+e.length);var r=i.getBoundingClientRect();o+=e.length;var a=r.x>n.x||r.y>n.y;return n=r,0===t||a}));return e.body.removeChild(t),a}(document);return Object.defineProperty(g_,"SUPPORT_WORD_BREAKING",{value:e}),e},get SUPPORT_SVG_DRAWING(){var e=function(e){var t=new Image,i=e.createElement("canvas"),s=i.getContext("2d");if(!s)return!1;t.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{s.drawImage(t,0,0),i.toDataURL()}catch(e){return!1}return!0}(document);return Object.defineProperty(g_,"SUPPORT_SVG_DRAWING",{value:e}),e},get SUPPORT_FOREIGNOBJECT_DRAWING(){var e="function"==typeof Array.from&&"function"==typeof window.fetch?function(e){var t=e.createElement("canvas"),i=100;t.width=i,t.height=i;var s=t.getContext("2d");if(!s)return Promise.reject(!1);s.fillStyle="rgb(0, 255, 0)",s.fillRect(0,0,i,i);var r=new Image,o=t.toDataURL();r.src=o;var n=f_(i,i,0,0,r);return s.fillStyle="red",s.fillRect(0,0,i,i),m_(n).then((function(t){s.drawImage(t,0,0);var r=s.getImageData(0,0,i,i).data;s.fillStyle="red",s.fillRect(0,0,i,i);var n=e.createElement("div");return n.style.backgroundImage="url("+o+")",n.style.height="100px",p_(r)?m_(f_(i,i,0,0,n)):Promise.reject(!1)})).then((function(e){return s.drawImage(e,0,0),p_(s.getImageData(0,0,i,i).data)})).catch((function(){return!1}))}(document):Promise.resolve(!1);return Object.defineProperty(g_,"SUPPORT_FOREIGNOBJECT_DRAWING",{value:e}),e},get SUPPORT_CORS_IMAGES(){var e=void 0!==(new Image).crossOrigin;return Object.defineProperty(g_,"SUPPORT_CORS_IMAGES",{value:e}),e},get SUPPORT_RESPONSE_TYPE(){var e="string"==typeof(new XMLHttpRequest).responseType;return Object.defineProperty(g_,"SUPPORT_RESPONSE_TYPE",{value:e}),e},get SUPPORT_CORS_XHR(){var e="withCredentials"in new XMLHttpRequest;return Object.defineProperty(g_,"SUPPORT_CORS_XHR",{value:e}),e},get SUPPORT_NATIVE_TEXT_SEGMENTATION(){var e=!("undefined"==typeof Intl||!Intl.Segmenter);return Object.defineProperty(g_,"SUPPORT_NATIVE_TEXT_SEGMENTATION",{value:e}),e}},__=function(e,t){this.text=e,this.bounds=t},v_=function(e,t){var i=t.ownerDocument;if(i){var s=i.createElement("html2canvaswrapper");s.appendChild(t.cloneNode(!0));var r=t.parentNode;if(r){r.replaceChild(s,t);var o=zd(e,s);return s.firstChild&&r.replaceChild(s.firstChild,s),o}}return Gd.EMPTY},b_=function(e,t,i){var s=e.ownerDocument;if(!s)throw new Error("Node has no owner document");var r=s.createRange();return r.setStart(e,t),r.setEnd(e,t+i),r},y_=function(e){if(g_.SUPPORT_NATIVE_TEXT_SEGMENTATION){var t=new Intl.Segmenter(void 0,{granularity:"grapheme"});return Array.from(t.segment(e)).map((function(e){return e.segment}))}return function(e){for(var t,i=d_(e),s=[];!(t=i.next()).done;)t.value&&s.push(t.value.slice());return s}(e)},w_=function(e,t){return 0!==t.letterSpacing?y_(e):function(e,t){if(g_.SUPPORT_NATIVE_TEXT_SEGMENTATION){var i=new Intl.Segmenter(void 0,{granularity:"word"});return Array.from(i.segment(e)).map((function(e){return e.segment}))}return P_(e,t)}(e,t)},B_=[32,160,4961,65792,65793,4153,4241],P_=function(e,t){for(var i,s=function(e,t){var i=Wd(e),s=Qp(i,t),r=s[0],o=s[1],n=s[2],a=i.length,l=0,A=0;return{next:function(){if(A>=a)return{done:!0,value:null};for(var e="×";A<a&&"×"===(e=Vp(i,o,r,++A,n)););if("×"!==e||A===a){var t=new Hp(i,e,l,A);return l=A,{value:t,done:!1}}return{done:!0,value:null}}}}(e,{lineBreak:t.lineBreak,wordBreak:"break-word"===t.overflowWrap?"break-word":t.wordBreak}),r=[],o=function(){if(i.value){var e=i.value.slice(),t=Wd(e),s="";t.forEach((function(e){-1===B_.indexOf(e)?s+=Xd(e):(s.length&&r.push(s),r.push(Xd(e)),s="")})),s.length&&r.push(s)}};!(i=s.next()).done;)o();return r},x_=function(e,t,i){this.text=C_(t.data,i.textTransform),this.textBounds=function(e,t,i,s){var r=w_(t,i),o=[],n=0;return r.forEach((function(t){if(i.textDecorationLine.length||t.trim().length>0)if(g_.SUPPORT_RANGE_BOUNDS){var r=b_(s,n,t.length).getClientRects();if(r.length>1){var a=y_(t),l=0;a.forEach((function(t){o.push(new __(t,Gd.fromDOMRectList(e,b_(s,l+n,t.length).getClientRects()))),l+=t.length}))}else o.push(new __(t,Gd.fromDOMRectList(e,r)))}else{var A=s.splitText(t.length);o.push(new __(t,v_(e,s))),s=A}else g_.SUPPORT_RANGE_BOUNDS||(s=s.splitText(t.length));n+=t.length})),o}(e,this.text,i,t)},C_=function(e,t){switch(t){case 1:return e.toLowerCase();case 3:return e.replace(M_,E_);case 2:return e.toUpperCase();default:return e}},M_=/(^|\s|:|-|\(|\))([a-z])/g,E_=function(e,t,i){return e.length>0?t+i.toUpperCase():e},F_=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.src=i.currentSrc||i.src,s.intrinsicWidth=i.naturalWidth,s.intrinsicHeight=i.naturalHeight,s.context.cache.addImage(s.src),s}return Nd(t,e),t}(Zg),I_=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.canvas=i,s.intrinsicWidth=i.width,s.intrinsicHeight=i.height,s}return Nd(t,e),t}(Zg),T_=function(e){function t(t,i){var s=e.call(this,t,i)||this,r=new XMLSerializer,o=zd(t,i);return i.setAttribute("width",o.width+"px"),i.setAttribute("height",o.height+"px"),s.svg="data:image/svg+xml,"+encodeURIComponent(r.serializeToString(i)),s.intrinsicWidth=i.width.baseVal.value,s.intrinsicHeight=i.height.baseVal.value,s.context.cache.addImage(s.svg),s}return Nd(t,e),t}(Zg),D_=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.value=i.value,s}return Nd(t,e),t}(Zg),S_=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.start=i.start,s.reversed="boolean"==typeof i.reversed&&!0===i.reversed,s}return Nd(t,e),t}(Zg),R_=[{type:15,flags:0,unit:"px",number:3}],U_=[{type:16,flags:0,number:50}],L_="password",k_=function(e){function t(t,i){var s,r,o,n=e.call(this,t,i)||this;switch(n.type=i.type.toLowerCase(),n.checked=i.checked,n.value=0===(r=(s=i).type===L_?new Array(s.value.length+1).join("•"):s.value).length?s.placeholder||"":r,"checkbox"!==n.type&&"radio"!==n.type||(n.styles.backgroundColor=3739148031,n.styles.borderTopColor=n.styles.borderRightColor=n.styles.borderBottomColor=n.styles.borderLeftColor=2779096575,n.styles.borderTopWidth=n.styles.borderRightWidth=n.styles.borderBottomWidth=n.styles.borderLeftWidth=1,n.styles.borderTopStyle=n.styles.borderRightStyle=n.styles.borderBottomStyle=n.styles.borderLeftStyle=1,n.styles.backgroundClip=[0],n.styles.backgroundOrigin=[0],n.bounds=(o=n.bounds).width>o.height?new Gd(o.left+(o.width-o.height)/2,o.top,o.height,o.height):o.width<o.height?new Gd(o.left,o.top+(o.height-o.width)/2,o.width,o.width):o),n.type){case"checkbox":n.styles.borderTopRightRadius=n.styles.borderTopLeftRadius=n.styles.borderBottomRightRadius=n.styles.borderBottomLeftRadius=R_;break;case"radio":n.styles.borderTopRightRadius=n.styles.borderTopLeftRadius=n.styles.borderBottomRightRadius=n.styles.borderBottomLeftRadius=U_}return n}return Nd(t,e),t}(Zg),O_=function(e){function t(t,i){var s=e.call(this,t,i)||this,r=i.options[i.selectedIndex||0];return s.value=r&&r.text||"",s}return Nd(t,e),t}(Zg),N_=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.value=i.value,s}return Nd(t,e),t}(Zg),V_=function(e){function t(t,i){var s=e.call(this,t,i)||this;s.src=i.src,s.width=parseInt(i.width,10)||0,s.height=parseInt(i.height,10)||0,s.backgroundColor=s.styles.backgroundColor;try{if(i.contentWindow&&i.contentWindow.document&&i.contentWindow.document.documentElement){s.tree=G_(t,i.contentWindow.document.documentElement);var r=i.contentWindow.document.documentElement?$f(t,getComputedStyle(i.contentWindow.document.documentElement).backgroundColor):em.TRANSPARENT,o=i.contentWindow.document.body?$f(t,getComputedStyle(i.contentWindow.document.body).backgroundColor):em.TRANSPARENT;s.backgroundColor=zf(r)?zf(o)?s.styles.backgroundColor:o:r}}catch(e){}return s}return Nd(t,e),t}(Zg),Q_=["OL","UL","MENU"],H_=function(e,t,i,s){for(var r=t.firstChild,o=void 0;r;r=o)if(o=r.nextSibling,X_(r)&&r.data.trim().length>0)i.textNodes.push(new x_(e,r,i.styles));else if(K_(r))if(Av(r)&&r.assignedNodes)r.assignedNodes().forEach((function(t){return H_(e,t,i,s)}));else{var n=j_(e,r);n.styles.isVisible()&&(z_(r,n,s)?n.flags|=4:W_(n.styles)&&(n.flags|=2),-1!==Q_.indexOf(r.tagName)&&(n.flags|=8),i.elements.push(n),r.slot,r.shadowRoot?H_(e,r.shadowRoot,n,s):av(r)||ev(r)||lv(r)||H_(e,r,n,s))}},j_=function(e,t){return rv(t)?new F_(e,t):iv(t)?new I_(e,t):ev(t)?new T_(e,t):Y_(t)?new D_(e,t):q_(t)?new S_(e,t):$_(t)?new k_(e,t):lv(t)?new O_(e,t):av(t)?new N_(e,t):ov(t)?new V_(e,t):new Zg(e,t)},G_=function(e,t){var i=j_(e,t);return i.flags|=4,H_(e,t,i,i),i},z_=function(e,t,i){return t.styles.isPositionedWithZIndex()||t.styles.opacity<1||t.styles.isTransformed()||tv(e)&&i.styles.isTransparent()},W_=function(e){return e.isPositioned()||e.isFloating()},X_=function(e){return e.nodeType===Node.TEXT_NODE},K_=function(e){return e.nodeType===Node.ELEMENT_NODE},Z_=function(e){return K_(e)&&void 0!==e.style&&!J_(e)},J_=function(e){return"object"==typeof e.className},Y_=function(e){return"LI"===e.tagName},q_=function(e){return"OL"===e.tagName},$_=function(e){return"INPUT"===e.tagName},ev=function(e){return"svg"===e.tagName},tv=function(e){return"BODY"===e.tagName},iv=function(e){return"CANVAS"===e.tagName},sv=function(e){return"VIDEO"===e.tagName},rv=function(e){return"IMG"===e.tagName},ov=function(e){return"IFRAME"===e.tagName},nv=function(e){return"STYLE"===e.tagName},av=function(e){return"TEXTAREA"===e.tagName},lv=function(e){return"SELECT"===e.tagName},Av=function(e){return"SLOT"===e.tagName},cv=function(e){return e.tagName.indexOf("-")>0},hv=function(){function e(){this.counters={}}return e.prototype.getCounterValue=function(e){var t=this.counters[e];return t&&t.length?t[t.length-1]:1},e.prototype.getCounterValues=function(e){var t=this.counters[e];return t||[]},e.prototype.pop=function(e){var t=this;e.forEach((function(e){return t.counters[e].pop()}))},e.prototype.parse=function(e){var t=this,i=e.counterIncrement,s=e.counterReset,r=!0;null!==i&&i.forEach((function(e){var i=t.counters[e.counter];i&&0!==e.increment&&(r=!1,i.length||i.push(1),i[Math.max(0,i.length-1)]+=e.increment)}));var o=[];return r&&s.forEach((function(e){var i=t.counters[e.counter];o.push(e.counter),i||(i=t.counters[e.counter]=[]),i.push(e.reset)})),o},e}(),uv={integers:[1e3,900,500,400,100,90,50,40,10,9,5,4,1],values:["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"]},dv={integers:[9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["Ք","Փ","Ւ","Ց","Ր","Տ","Վ","Ս","Ռ","Ջ","Պ","Չ","Ո","Շ","Ն","Յ","Մ","Ճ","Ղ","Ձ","Հ","Կ","Ծ","Խ","Լ","Ի","Ժ","Թ","Ը","Է","Զ","Ե","Դ","Գ","Բ","Ա"]},pv={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,400,300,200,100,90,80,70,60,50,40,30,20,19,18,17,16,15,10,9,8,7,6,5,4,3,2,1],values:["י׳","ט׳","ח׳","ז׳","ו׳","ה׳","ד׳","ג׳","ב׳","א׳","ת","ש","ר","ק","צ","פ","ע","ס","נ","מ","ל","כ","יט","יח","יז","טז","טו","י","ט","ח","ז","ו","ה","ד","ג","ב","א"]},fv={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["ჵ","ჰ","ჯ","ჴ","ხ","ჭ","წ","ძ","ც","ჩ","შ","ყ","ღ","ქ","ფ","ჳ","ტ","ს","რ","ჟ","პ","ო","ჲ","ნ","მ","ლ","კ","ი","თ","ჱ","ზ","ვ","ე","დ","გ","ბ","ა"]},mv=function(e,t,i,s,r,o){return e<t||e>i?yv(e,r,o.length>0):s.integers.reduce((function(t,i,r){for(;e>=i;)e-=i,t+=s.values[r];return t}),"")+o},gv=function(e,t,i,s){var r="";do{i||e--,r=s(e)+r,e/=t}while(e*t>=t);return r},_v=function(e,t,i,s,r){var o=i-t+1;return(e<0?"-":"")+(gv(Math.abs(e),o,s,(function(e){return Xd(Math.floor(e%o)+t)}))+r)},vv=function(e,t,i){void 0===i&&(i=". ");var s=t.length;return gv(Math.abs(e),s,!1,(function(e){return t[Math.floor(e%s)]}))+i},bv=function(e,t,i,s,r,o){if(e<-9999||e>9999)return yv(e,4,r.length>0);var n=Math.abs(e),a=r;if(0===n)return t[0]+a;for(var l=0;n>0&&l<=4;l++){var A=n%10;0===A&&Sg(o,1)&&""!==a?a=t[A]+a:A>1||1===A&&0===l||1===A&&1===l&&Sg(o,2)||1===A&&1===l&&Sg(o,4)&&e>100||1===A&&l>1&&Sg(o,8)?a=t[A]+(l>0?i[l-1]:"")+a:1===A&&l>0&&(a=i[l-1]+a),n=Math.floor(n/10)}return(e<0?s:"")+a},yv=function(e,t,i){var s=i?". ":"",r=i?"、":"",o=i?", ":"",n=i?" ":"";switch(t){case 0:return"•"+n;case 1:return"◦"+n;case 2:return"◾"+n;case 5:var a=_v(e,48,57,!0,s);return a.length<4?"0"+a:a;case 4:return vv(e,"〇一二三四五六七八九",r);case 6:return mv(e,1,3999,uv,3,s).toLowerCase();case 7:return mv(e,1,3999,uv,3,s);case 8:return _v(e,945,969,!1,s);case 9:return _v(e,97,122,!1,s);case 10:return _v(e,65,90,!1,s);case 11:return _v(e,1632,1641,!0,s);case 12:case 49:return mv(e,1,9999,dv,3,s);case 35:return mv(e,1,9999,dv,3,s).toLowerCase();case 13:return _v(e,2534,2543,!0,s);case 14:case 30:return _v(e,6112,6121,!0,s);case 15:return vv(e,"子丑寅卯辰巳午未申酉戌亥",r);case 16:return vv(e,"甲乙丙丁戊己庚辛壬癸",r);case 17:case 48:return bv(e,"零一二三四五六七八九","十百千萬","負",r,14);case 47:return bv(e,"零壹貳參肆伍陸柒捌玖","拾佰仟萬","負",r,15);case 42:return bv(e,"零一二三四五六七八九","十百千萬","负",r,14);case 41:return bv(e,"零壹贰叁肆伍陆柒捌玖","拾佰仟萬","负",r,15);case 26:return bv(e,"〇一二三四五六七八九","十百千万","マイナス",r,0);case 25:return bv(e,"零壱弐参四伍六七八九","拾百千万","マイナス",r,7);case 31:return bv(e,"영일이삼사오육칠팔구","십백천만","마이너스",o,7);case 33:return bv(e,"零一二三四五六七八九","十百千萬","마이너스",o,0);case 32:return bv(e,"零壹貳參四五六七八九","拾百千","마이너스",o,7);case 18:return _v(e,2406,2415,!0,s);case 20:return mv(e,1,19999,fv,3,s);case 21:return _v(e,2790,2799,!0,s);case 22:return _v(e,2662,2671,!0,s);case 22:return mv(e,1,10999,pv,3,s);case 23:return vv(e,"あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわゐゑをん");case 24:return vv(e,"いろはにほへとちりぬるをわかよたれそつねならむうゐのおくやまけふこえてあさきゆめみしゑひもせす");case 27:return _v(e,3302,3311,!0,s);case 28:return vv(e,"アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヰヱヲン",r);case 29:return vv(e,"イロハニホヘトチリヌルヲワカヨタレソツネナラムウヰノオクヤマケフコエテアサキユメミシヱヒモセス",r);case 34:return _v(e,3792,3801,!0,s);case 37:return _v(e,6160,6169,!0,s);case 38:return _v(e,4160,4169,!0,s);case 39:return _v(e,2918,2927,!0,s);case 40:return _v(e,1776,1785,!0,s);case 43:return _v(e,3046,3055,!0,s);case 44:return _v(e,3174,3183,!0,s);case 45:return _v(e,3664,3673,!0,s);case 46:return _v(e,3872,3881,!0,s);default:return _v(e,48,57,!0,s)}},wv=function(){function e(e,t,i){if(this.context=e,this.options=i,this.scrolledElements=[],this.referenceElement=t,this.counters=new hv,this.quoteDepth=0,!t.ownerDocument)throw new Error("Cloned element does not have an owner document");this.documentElement=this.cloneNode(t.ownerDocument.documentElement,!1)}return e.prototype.toIFrame=function(e,t){var i=this,s=Pv(e,t);if(!s.contentWindow)return Promise.reject("Unable to find iframe window");var r=e.defaultView.pageXOffset,o=e.defaultView.pageYOffset,n=s.contentWindow,a=n.document,l=Mv(s).then((function(){return Qd(i,void 0,void 0,(function(){var e,i;return Hd(this,(function(r){switch(r.label){case 0:return this.scrolledElements.forEach(Dv),n&&(n.scrollTo(t.left,t.top),!/(iPad|iPhone|iPod)/g.test(navigator.userAgent)||n.scrollY===t.top&&n.scrollX===t.left||(this.context.logger.warn("Unable to restore scroll position for cloned document"),this.context.windowBounds=this.context.windowBounds.add(n.scrollX-t.left,n.scrollY-t.top,0,0))),e=this.options.onclone,void 0===(i=this.clonedReferenceElement)?[2,Promise.reject("Error finding the "+this.referenceElement.nodeName+" in the cloned document")]:a.fonts&&a.fonts.ready?[4,a.fonts.ready]:[3,2];case 1:r.sent(),r.label=2;case 2:return/(AppleWebKit)/g.test(navigator.userAgent)?[4,Cv(a)]:[3,4];case 3:r.sent(),r.label=4;case 4:return"function"==typeof e?[2,Promise.resolve().then((function(){return e(a,i)})).then((function(){return s}))]:[2,s]}}))}))}));return a.open(),a.write(Iv(document.doctype)+"<html></html>"),Tv(this.referenceElement.ownerDocument,r,o),a.replaceChild(a.adoptNode(this.documentElement),a.documentElement),a.close(),l},e.prototype.createElementClone=function(e){if(Kg(e,2),iv(e))return this.createCanvasClone(e);if(sv(e))return this.createVideoClone(e);if(nv(e))return this.createStyleClone(e);var t=e.cloneNode(!1);return rv(t)&&(rv(e)&&e.currentSrc&&e.currentSrc!==e.src&&(t.src=e.currentSrc,t.srcset=""),"lazy"===t.loading&&(t.loading="eager")),cv(t)?this.createCustomElementClone(t):t},e.prototype.createCustomElementClone=function(e){var t=document.createElement("html2canvascustomelement");return Fv(e.style,t),t},e.prototype.createStyleClone=function(e){try{var t=e.sheet;if(t&&t.cssRules){var i=[].slice.call(t.cssRules,0).reduce((function(e,t){return t&&"string"==typeof t.cssText?e+t.cssText:e}),""),s=e.cloneNode(!1);return s.textContent=i,s}}catch(e){if(this.context.logger.error("Unable to access cssRules property",e),"SecurityError"!==e.name)throw e}return e.cloneNode(!1)},e.prototype.createCanvasClone=function(e){var t;if(this.options.inlineImages&&e.ownerDocument){var i=e.ownerDocument.createElement("img");try{return i.src=e.toDataURL(),i}catch(t){this.context.logger.info("Unable to inline canvas contents, canvas is tainted",e)}}var s=e.cloneNode(!1);try{s.width=e.width,s.height=e.height;var r=e.getContext("2d"),o=s.getContext("2d");if(o)if(!this.options.allowTaint&&r)o.putImageData(r.getImageData(0,0,e.width,e.height),0,0);else{var n=null!==(t=e.getContext("webgl2"))&&void 0!==t?t:e.getContext("webgl");if(n){var a=n.getContextAttributes();!1===(null==a?void 0:a.preserveDrawingBuffer)&&this.context.logger.warn("Unable to clone WebGL context as it has preserveDrawingBuffer=false",e)}o.drawImage(e,0,0)}return s}catch(t){this.context.logger.info("Unable to clone canvas as it is tainted",e)}return s},e.prototype.createVideoClone=function(e){var t=e.ownerDocument.createElement("canvas");t.width=e.offsetWidth,t.height=e.offsetHeight;var i=t.getContext("2d");try{return i&&(i.drawImage(e,0,0,t.width,t.height),this.options.allowTaint||i.getImageData(0,0,t.width,t.height)),t}catch(t){this.context.logger.info("Unable to clone video as it is tainted",e)}var s=e.ownerDocument.createElement("canvas");return s.width=e.offsetWidth,s.height=e.offsetHeight,s},e.prototype.appendChildNode=function(e,t,i){K_(t)&&("SCRIPT"===t.tagName||t.hasAttribute("data-html2canvas-ignore")||"function"==typeof this.options.ignoreElements&&this.options.ignoreElements(t))||this.options.copyStyles&&K_(t)&&nv(t)||e.appendChild(this.cloneNode(t,i))},e.prototype.cloneChildNodes=function(e,t,i){for(var s=this,r=e.shadowRoot?e.shadowRoot.firstChild:e.firstChild;r;r=r.nextSibling)if(K_(r)&&Av(r)&&"function"==typeof r.assignedNodes){var o=r.assignedNodes();o.length&&o.forEach((function(e){return s.appendChildNode(t,e,i)}))}else this.appendChildNode(t,r,i)},e.prototype.cloneNode=function(e,t){if(X_(e))return document.createTextNode(e.data);if(!e.ownerDocument)return e.cloneNode(!1);var i=e.ownerDocument.defaultView;if(i&&K_(e)&&(Z_(e)||J_(e))){var s=this.createElementClone(e);s.style.transitionProperty="none";var r=i.getComputedStyle(e),o=i.getComputedStyle(e,":before"),n=i.getComputedStyle(e,":after");this.referenceElement===e&&Z_(s)&&(this.clonedReferenceElement=s),tv(s)&&Uv(s);var a=this.counters.parse(new Wg(this.context,r)),l=this.resolvePseudoContent(e,s,o,r_.BEFORE);cv(e)&&(t=!0),sv(e)||this.cloneChildNodes(e,s,t),l&&s.insertBefore(l,s.firstChild);var A=this.resolvePseudoContent(e,s,n,r_.AFTER);return A&&s.appendChild(A),this.counters.pop(a),(r&&(this.options.copyStyles||J_(e))&&!ov(e)||t)&&Fv(r,s),0===e.scrollTop&&0===e.scrollLeft||this.scrolledElements.push([s,e.scrollLeft,e.scrollTop]),(av(e)||lv(e))&&(av(s)||lv(s))&&(s.value=e.value),s}return e.cloneNode(!1)},e.prototype.resolvePseudoContent=function(e,t,i,s){var r=this;if(i){var o=i.content,n=t.ownerDocument;if(n&&o&&"none"!==o&&"-moz-alt-content"!==o&&"none"!==i.display){this.counters.parse(new Wg(this.context,i));var a=new zg(this.context,i),l=n.createElement("html2canvaspseudoelement");Fv(i,l),a.content.forEach((function(t){if(0===t.type)l.appendChild(n.createTextNode(t.value));else if(22===t.type){var i=n.createElement("img");i.src=t.value,i.style.opacity="1",l.appendChild(i)}else if(18===t.type){if("attr"===t.name){var s=t.values.filter(xf);s.length&&l.appendChild(n.createTextNode(e.getAttribute(s[0].value)||""))}else if("counter"===t.name){var o=t.values.filter(Ff),A=o[0],c=o[1];if(A&&xf(A)){var h=r.counters.getCounterValue(A.value),u=c&&xf(c)?$m.parse(r.context,c.value):3;l.appendChild(n.createTextNode(yv(h,u,!1)))}}else if("counters"===t.name){var d=t.values.filter(Ff),p=(A=d[0],d[1]);c=d[2];if(A&&xf(A)){var f=r.counters.getCounterValues(A.value),m=c&&xf(c)?$m.parse(r.context,c.value):3,g=p&&0===p.type?p.value:"",_=f.map((function(e){return yv(e,m,!1)})).join(g);l.appendChild(n.createTextNode(_))}}}else if(20===t.type)switch(t.value){case"open-quote":l.appendChild(n.createTextNode(Ng(a.quotes,r.quoteDepth++,!0)));break;case"close-quote":l.appendChild(n.createTextNode(Ng(a.quotes,--r.quoteDepth,!1)));break;default:l.appendChild(n.createTextNode(t.value))}})),l.className=Sv+" "+Rv;var A=s===r_.BEFORE?" "+Sv:" "+Rv;return J_(t)?t.className.baseValue+=A:t.className+=A,l}}},e.destroy=function(e){return!!e.parentNode&&(e.parentNode.removeChild(e),!0)},e}();!function(e){e[e.BEFORE=0]="BEFORE",e[e.AFTER=1]="AFTER"}(r_||(r_={}));var Bv,Pv=function(e,t){var i=e.createElement("iframe");return i.className="html2canvas-container",i.style.visibility="hidden",i.style.position="fixed",i.style.left="-10000px",i.style.top="0px",i.style.border="0",i.width=t.width.toString(),i.height=t.height.toString(),i.scrolling="no",i.setAttribute("data-html2canvas-ignore","true"),e.body.appendChild(i),i},xv=function(e){return new Promise((function(t){e.complete?t():e.src?(e.onload=t,e.onerror=t):t()}))},Cv=function(e){return Promise.all([].slice.call(e.images,0).map(xv))},Mv=function(e){return new Promise((function(t,i){var s=e.contentWindow;if(!s)return i("No window assigned for iframe");var r=s.document;s.onload=e.onload=function(){s.onload=e.onload=null;var i=setInterval((function(){r.body.childNodes.length>0&&"complete"===r.readyState&&(clearInterval(i),t(e))}),50)}}))},Ev=["all","d","content"],Fv=function(e,t){for(var i=e.length-1;i>=0;i--){var s=e.item(i);-1===Ev.indexOf(s)&&t.style.setProperty(s,e.getPropertyValue(s))}return t},Iv=function(e){var t="";return e&&(t+="<!DOCTYPE ",e.name&&(t+=e.name),e.internalSubset&&(t+=e.internalSubset),e.publicId&&(t+='"'+e.publicId+'"'),e.systemId&&(t+='"'+e.systemId+'"'),t+=">"),t},Tv=function(e,t,i){e&&e.defaultView&&(t!==e.defaultView.pageXOffset||i!==e.defaultView.pageYOffset)&&e.defaultView.scrollTo(t,i)},Dv=function(e){var t=e[0],i=e[1],s=e[2];t.scrollLeft=i,t.scrollTop=s},Sv="___html2canvas___pseudoelement_before",Rv="___html2canvas___pseudoelement_after",Uv=function(e){Lv(e,"."+Sv+':before{\n    content: "" !important;\n    display: none !important;\n}\n         .'+Rv+':after{\n    content: "" !important;\n    display: none !important;\n}')},Lv=function(e,t){var i=e.ownerDocument;if(i){var s=i.createElement("style");s.textContent=t,e.appendChild(s)}},kv=function(){function e(){}return e.getOrigin=function(t){var i=e._link;return i?(i.href=t,i.href=i.href,i.protocol+i.hostname+i.port):"about:blank"},e.isSameOrigin=function(t){return e.getOrigin(t)===e._origin},e.setContext=function(t){e._link=t.document.createElement("a"),e._origin=e.getOrigin(t.location.href)},e._origin="about:blank",e}(),Ov=function(){function e(e,t){this.context=e,this._options=t,this._cache={}}return e.prototype.addImage=function(e){var t=Promise.resolve();return this.has(e)?t:zv(e)||Hv(e)?((this._cache[e]=this.loadImage(e)).catch((function(){})),t):t},e.prototype.match=function(e){return this._cache[e]},e.prototype.loadImage=function(e){return Qd(this,void 0,void 0,(function(){var t,i,s,r,o=this;return Hd(this,(function(n){switch(n.label){case 0:return t=kv.isSameOrigin(e),i=!jv(e)&&!0===this._options.useCORS&&g_.SUPPORT_CORS_IMAGES&&!t,s=!jv(e)&&!t&&!zv(e)&&"string"==typeof this._options.proxy&&g_.SUPPORT_CORS_XHR&&!i,t||!1!==this._options.allowTaint||jv(e)||zv(e)||s||i?(r=e,s?[4,this.proxy(r)]:[3,2]):[2];case 1:r=n.sent(),n.label=2;case 2:return this.context.logger.debug("Added image "+e.substring(0,256)),[4,new Promise((function(e,t){var s=new Image;s.onload=function(){return e(s)},s.onerror=t,(Gv(r)||i)&&(s.crossOrigin="anonymous"),s.src=r,!0===s.complete&&setTimeout((function(){return e(s)}),500),o._options.imageTimeout>0&&setTimeout((function(){return t("Timed out ("+o._options.imageTimeout+"ms) loading image")}),o._options.imageTimeout)}))];case 3:return[2,n.sent()]}}))}))},e.prototype.has=function(e){return void 0!==this._cache[e]},e.prototype.keys=function(){return Promise.resolve(Object.keys(this._cache))},e.prototype.proxy=function(e){var t=this,i=this._options.proxy;if(!i)throw new Error("No proxy defined");var s=e.substring(0,256);return new Promise((function(r,o){var n=g_.SUPPORT_RESPONSE_TYPE?"blob":"text",a=new XMLHttpRequest;a.onload=function(){if(200===a.status)if("text"===n)r(a.response);else{var e=new FileReader;e.addEventListener("load",(function(){return r(e.result)}),!1),e.addEventListener("error",(function(e){return o(e)}),!1),e.readAsDataURL(a.response)}else o("Failed to proxy resource "+s+" with status code "+a.status)},a.onerror=o;var l=i.indexOf("?")>-1?"&":"?";if(a.open("GET",""+i+l+"url="+encodeURIComponent(e)+"&responseType="+n),"text"!==n&&a instanceof XMLHttpRequest&&(a.responseType=n),t._options.imageTimeout){var A=t._options.imageTimeout;a.timeout=A,a.ontimeout=function(){return o("Timed out ("+A+"ms) proxying "+s)}}a.send()}))},e}(),Nv=/^data:image\/svg\+xml/i,Vv=/^data:image\/.*;base64,/i,Qv=/^data:image\/.*/i,Hv=function(e){return g_.SUPPORT_SVG_DRAWING||!Wv(e)},jv=function(e){return Qv.test(e)},Gv=function(e){return Vv.test(e)},zv=function(e){return"blob"===e.substr(0,4)},Wv=function(e){return"svg"===e.substr(-3).toLowerCase()||Nv.test(e)},Xv=function(){function e(e,t){this.type=0,this.x=e,this.y=t}return e.prototype.add=function(t,i){return new e(this.x+t,this.y+i)},e}(),Kv=function(e,t,i){return new Xv(e.x+(t.x-e.x)*i,e.y+(t.y-e.y)*i)},Zv=function(){function e(e,t,i,s){this.type=1,this.start=e,this.startControl=t,this.endControl=i,this.end=s}return e.prototype.subdivide=function(t,i){var s=Kv(this.start,this.startControl,t),r=Kv(this.startControl,this.endControl,t),o=Kv(this.endControl,this.end,t),n=Kv(s,r,t),a=Kv(r,o,t),l=Kv(n,a,t);return i?new e(this.start,s,n,l):new e(l,a,o,this.end)},e.prototype.add=function(t,i){return new e(this.start.add(t,i),this.startControl.add(t,i),this.endControl.add(t,i),this.end.add(t,i))},e.prototype.reverse=function(){return new e(this.end,this.endControl,this.startControl,this.start)},e}(),Jv=function(e){return 1===e.type},Yv=function(e){var t=e.styles,i=e.bounds,s=Of(t.borderTopLeftRadius,i.width,i.height),r=s[0],o=s[1],n=Of(t.borderTopRightRadius,i.width,i.height),a=n[0],l=n[1],A=Of(t.borderBottomRightRadius,i.width,i.height),c=A[0],h=A[1],u=Of(t.borderBottomLeftRadius,i.width,i.height),d=u[0],p=u[1],f=[];f.push((r+a)/i.width),f.push((d+c)/i.width),f.push((o+p)/i.height),f.push((l+h)/i.height);var m=Math.max.apply(Math,f);m>1&&(r/=m,o/=m,a/=m,l/=m,c/=m,h/=m,d/=m,p/=m);var g=i.width-a,_=i.height-h,v=i.width-c,b=i.height-p,y=t.borderTopWidth,w=t.borderRightWidth,B=t.borderBottomWidth,P=t.borderLeftWidth,x=Nf(t.paddingTop,e.bounds.width),C=Nf(t.paddingRight,e.bounds.width),M=Nf(t.paddingBottom,e.bounds.width),E=Nf(t.paddingLeft,e.bounds.width);this.topLeftBorderDoubleOuterBox=r>0||o>0?qv(i.left+P/3,i.top+y/3,r-P/3,o-y/3,Bv.TOP_LEFT):new Xv(i.left+P/3,i.top+y/3),this.topRightBorderDoubleOuterBox=r>0||o>0?qv(i.left+g,i.top+y/3,a-w/3,l-y/3,Bv.TOP_RIGHT):new Xv(i.left+i.width-w/3,i.top+y/3),this.bottomRightBorderDoubleOuterBox=c>0||h>0?qv(i.left+v,i.top+_,c-w/3,h-B/3,Bv.BOTTOM_RIGHT):new Xv(i.left+i.width-w/3,i.top+i.height-B/3),this.bottomLeftBorderDoubleOuterBox=d>0||p>0?qv(i.left+P/3,i.top+b,d-P/3,p-B/3,Bv.BOTTOM_LEFT):new Xv(i.left+P/3,i.top+i.height-B/3),this.topLeftBorderDoubleInnerBox=r>0||o>0?qv(i.left+2*P/3,i.top+2*y/3,r-2*P/3,o-2*y/3,Bv.TOP_LEFT):new Xv(i.left+2*P/3,i.top+2*y/3),this.topRightBorderDoubleInnerBox=r>0||o>0?qv(i.left+g,i.top+2*y/3,a-2*w/3,l-2*y/3,Bv.TOP_RIGHT):new Xv(i.left+i.width-2*w/3,i.top+2*y/3),this.bottomRightBorderDoubleInnerBox=c>0||h>0?qv(i.left+v,i.top+_,c-2*w/3,h-2*B/3,Bv.BOTTOM_RIGHT):new Xv(i.left+i.width-2*w/3,i.top+i.height-2*B/3),this.bottomLeftBorderDoubleInnerBox=d>0||p>0?qv(i.left+2*P/3,i.top+b,d-2*P/3,p-2*B/3,Bv.BOTTOM_LEFT):new Xv(i.left+2*P/3,i.top+i.height-2*B/3),this.topLeftBorderStroke=r>0||o>0?qv(i.left+P/2,i.top+y/2,r-P/2,o-y/2,Bv.TOP_LEFT):new Xv(i.left+P/2,i.top+y/2),this.topRightBorderStroke=r>0||o>0?qv(i.left+g,i.top+y/2,a-w/2,l-y/2,Bv.TOP_RIGHT):new Xv(i.left+i.width-w/2,i.top+y/2),this.bottomRightBorderStroke=c>0||h>0?qv(i.left+v,i.top+_,c-w/2,h-B/2,Bv.BOTTOM_RIGHT):new Xv(i.left+i.width-w/2,i.top+i.height-B/2),this.bottomLeftBorderStroke=d>0||p>0?qv(i.left+P/2,i.top+b,d-P/2,p-B/2,Bv.BOTTOM_LEFT):new Xv(i.left+P/2,i.top+i.height-B/2),this.topLeftBorderBox=r>0||o>0?qv(i.left,i.top,r,o,Bv.TOP_LEFT):new Xv(i.left,i.top),this.topRightBorderBox=a>0||l>0?qv(i.left+g,i.top,a,l,Bv.TOP_RIGHT):new Xv(i.left+i.width,i.top),this.bottomRightBorderBox=c>0||h>0?qv(i.left+v,i.top+_,c,h,Bv.BOTTOM_RIGHT):new Xv(i.left+i.width,i.top+i.height),this.bottomLeftBorderBox=d>0||p>0?qv(i.left,i.top+b,d,p,Bv.BOTTOM_LEFT):new Xv(i.left,i.top+i.height),this.topLeftPaddingBox=r>0||o>0?qv(i.left+P,i.top+y,Math.max(0,r-P),Math.max(0,o-y),Bv.TOP_LEFT):new Xv(i.left+P,i.top+y),this.topRightPaddingBox=a>0||l>0?qv(i.left+Math.min(g,i.width-w),i.top+y,g>i.width+w?0:Math.max(0,a-w),Math.max(0,l-y),Bv.TOP_RIGHT):new Xv(i.left+i.width-w,i.top+y),this.bottomRightPaddingBox=c>0||h>0?qv(i.left+Math.min(v,i.width-P),i.top+Math.min(_,i.height-B),Math.max(0,c-w),Math.max(0,h-B),Bv.BOTTOM_RIGHT):new Xv(i.left+i.width-w,i.top+i.height-B),this.bottomLeftPaddingBox=d>0||p>0?qv(i.left+P,i.top+Math.min(b,i.height-B),Math.max(0,d-P),Math.max(0,p-B),Bv.BOTTOM_LEFT):new Xv(i.left+P,i.top+i.height-B),this.topLeftContentBox=r>0||o>0?qv(i.left+P+E,i.top+y+x,Math.max(0,r-(P+E)),Math.max(0,o-(y+x)),Bv.TOP_LEFT):new Xv(i.left+P+E,i.top+y+x),this.topRightContentBox=a>0||l>0?qv(i.left+Math.min(g,i.width+P+E),i.top+y+x,g>i.width+P+E?0:a-P+E,l-(y+x),Bv.TOP_RIGHT):new Xv(i.left+i.width-(w+C),i.top+y+x),this.bottomRightContentBox=c>0||h>0?qv(i.left+Math.min(v,i.width-(P+E)),i.top+Math.min(_,i.height+y+x),Math.max(0,c-(w+C)),h-(B+M),Bv.BOTTOM_RIGHT):new Xv(i.left+i.width-(w+C),i.top+i.height-(B+M)),this.bottomLeftContentBox=d>0||p>0?qv(i.left+P+E,i.top+b,Math.max(0,d-(P+E)),p-(B+M),Bv.BOTTOM_LEFT):new Xv(i.left+P+E,i.top+i.height-(B+M))};!function(e){e[e.TOP_LEFT=0]="TOP_LEFT",e[e.TOP_RIGHT=1]="TOP_RIGHT",e[e.BOTTOM_RIGHT=2]="BOTTOM_RIGHT",e[e.BOTTOM_LEFT=3]="BOTTOM_LEFT"}(Bv||(Bv={}));var qv=function(e,t,i,s,r){var o=(Math.sqrt(2)-1)/3*4,n=i*o,a=s*o,l=e+i,A=t+s;switch(r){case Bv.TOP_LEFT:return new Zv(new Xv(e,A),new Xv(e,A-a),new Xv(l-n,t),new Xv(l,t));case Bv.TOP_RIGHT:return new Zv(new Xv(e,t),new Xv(e+n,t),new Xv(l,A-a),new Xv(l,A));case Bv.BOTTOM_RIGHT:return new Zv(new Xv(l,t),new Xv(l,t+a),new Xv(e+n,A),new Xv(e,A));case Bv.BOTTOM_LEFT:default:return new Zv(new Xv(l,A),new Xv(l-n,A),new Xv(e,t+a),new Xv(e,t))}},$v=function(e){return[e.topLeftBorderBox,e.topRightBorderBox,e.bottomRightBorderBox,e.bottomLeftBorderBox]},eb=function(e){return[e.topLeftPaddingBox,e.topRightPaddingBox,e.bottomRightPaddingBox,e.bottomLeftPaddingBox]},tb=function(e,t,i){this.offsetX=e,this.offsetY=t,this.matrix=i,this.type=0,this.target=6},ib=function(e,t){this.path=e,this.target=t,this.type=1},sb=function(e){this.opacity=e,this.type=2,this.target=6},rb=function(e){return 1===e.type},ob=function(e,t){return e.length===t.length&&e.some((function(e,i){return e===t[i]}))},nb=function(e){this.element=e,this.inlineLevel=[],this.nonInlineLevel=[],this.negativeZIndex=[],this.zeroOrAutoZIndexOrTransformedOrOpacity=[],this.positiveZIndex=[],this.nonPositionedFloats=[],this.nonPositionedInlineLevel=[]},ab=function(){function e(e,t){if(this.container=e,this.parent=t,this.effects=[],this.curves=new Yv(this.container),this.container.styles.opacity<1&&this.effects.push(new sb(this.container.styles.opacity)),null!==this.container.styles.transform){var i=this.container.bounds.left+this.container.styles.transformOrigin[0].number,s=this.container.bounds.top+this.container.styles.transformOrigin[1].number,r=this.container.styles.transform;this.effects.push(new tb(i,s,r))}if(0!==this.container.styles.overflowX){var o=$v(this.curves),n=eb(this.curves);ob(o,n)?this.effects.push(new ib(o,6)):(this.effects.push(new ib(o,2)),this.effects.push(new ib(n,4)))}}return e.prototype.getEffects=function(e){for(var t=-1===[2,3].indexOf(this.container.styles.position),i=this.parent,s=this.effects.slice(0);i;){var r=i.effects.filter((function(e){return!rb(e)}));if(t||0!==i.container.styles.position||!i.parent){if(s.unshift.apply(s,r),t=-1===[2,3].indexOf(i.container.styles.position),0!==i.container.styles.overflowX){var o=$v(i.curves),n=eb(i.curves);ob(o,n)||s.unshift(new ib(n,6))}}else s.unshift.apply(s,r);i=i.parent}return s.filter((function(t){return Sg(t.target,e)}))},e}(),lb=function(e,t,i,s){e.container.elements.forEach((function(r){var o=Sg(r.flags,4),n=Sg(r.flags,2),a=new ab(r,e);Sg(r.styles.display,2048)&&s.push(a);var l=Sg(r.flags,8)?[]:s;if(o||n){var A=o||r.styles.isPositioned()?i:t,c=new nb(a);if(r.styles.isPositioned()||r.styles.opacity<1||r.styles.isTransformed()){var h=r.styles.zIndex.order;if(h<0){var u=0;A.negativeZIndex.some((function(e,t){return h>e.element.container.styles.zIndex.order?(u=t,!1):u>0})),A.negativeZIndex.splice(u,0,c)}else if(h>0){var d=0;A.positiveZIndex.some((function(e,t){return h>=e.element.container.styles.zIndex.order?(d=t+1,!1):d>0})),A.positiveZIndex.splice(d,0,c)}else A.zeroOrAutoZIndexOrTransformedOrOpacity.push(c)}else r.styles.isFloating()?A.nonPositionedFloats.push(c):A.nonPositionedInlineLevel.push(c);lb(a,c,o?c:i,l)}else r.styles.isInlineLevel()?t.inlineLevel.push(a):t.nonInlineLevel.push(a),lb(a,t,i,l);Sg(r.flags,8)&&Ab(r,l)}))},Ab=function(e,t){for(var i=e instanceof S_?e.start:1,s=e instanceof S_&&e.reversed,r=0;r<t.length;r++){var o=t[r];o.container instanceof D_&&"number"==typeof o.container.value&&0!==o.container.value&&(i=o.container.value),o.listValue=yv(i,o.container.styles.listStyleType,!0),i+=s?-1:1}},cb=function(e,t){switch(t){case 0:return ub(e.topLeftBorderBox,e.topLeftPaddingBox,e.topRightBorderBox,e.topRightPaddingBox);case 1:return ub(e.topRightBorderBox,e.topRightPaddingBox,e.bottomRightBorderBox,e.bottomRightPaddingBox);case 2:return ub(e.bottomRightBorderBox,e.bottomRightPaddingBox,e.bottomLeftBorderBox,e.bottomLeftPaddingBox);default:return ub(e.bottomLeftBorderBox,e.bottomLeftPaddingBox,e.topLeftBorderBox,e.topLeftPaddingBox)}},hb=function(e,t){var i=[];return Jv(e)?i.push(e.subdivide(.5,!1)):i.push(e),Jv(t)?i.push(t.subdivide(.5,!0)):i.push(t),i},ub=function(e,t,i,s){var r=[];return Jv(e)?r.push(e.subdivide(.5,!1)):r.push(e),Jv(i)?r.push(i.subdivide(.5,!0)):r.push(i),Jv(s)?r.push(s.subdivide(.5,!0).reverse()):r.push(s),Jv(t)?r.push(t.subdivide(.5,!1).reverse()):r.push(t),r},db=function(e){var t=e.bounds,i=e.styles;return t.add(i.borderLeftWidth,i.borderTopWidth,-(i.borderRightWidth+i.borderLeftWidth),-(i.borderTopWidth+i.borderBottomWidth))},pb=function(e){var t=e.styles,i=e.bounds,s=Nf(t.paddingLeft,i.width),r=Nf(t.paddingRight,i.width),o=Nf(t.paddingTop,i.width),n=Nf(t.paddingBottom,i.width);return i.add(s+t.borderLeftWidth,o+t.borderTopWidth,-(t.borderRightWidth+t.borderLeftWidth+s+r),-(t.borderTopWidth+t.borderBottomWidth+o+n))},fb=function(e,t,i){var s=function(e,t){return 0===e?t.bounds:2===e?pb(t):db(t)}(vb(e.styles.backgroundOrigin,t),e),r=function(e,t){return 0===e?t.bounds:2===e?pb(t):db(t)}(vb(e.styles.backgroundClip,t),e),o=_b(vb(e.styles.backgroundSize,t),i,s),n=o[0],a=o[1],l=Of(vb(e.styles.backgroundPosition,t),s.width-n,s.height-a);return[bb(vb(e.styles.backgroundRepeat,t),l,o,s,r),Math.round(s.left+l[0]),Math.round(s.top+l[1]),n,a]},mb=function(e){return xf(e)&&e.value===hm.AUTO},gb=function(e){return"number"==typeof e},_b=function(e,t,i){var s=t[0],r=t[1],o=t[2],n=e[0],a=e[1];if(!n)return[0,0];if(Sf(n)&&a&&Sf(a))return[Nf(n,i.width),Nf(a,i.height)];var l=gb(o);if(xf(n)&&(n.value===hm.CONTAIN||n.value===hm.COVER))return gb(o)?i.width/i.height<o!=(n.value===hm.COVER)?[i.width,i.width/o]:[i.height*o,i.height]:[i.width,i.height];var A=gb(s),c=gb(r),h=A||c;if(mb(n)&&(!a||mb(a)))return A&&c?[s,r]:l||h?h&&l?[A?s:r*o,c?r:s/o]:[A?s:i.width,c?r:i.height]:[i.width,i.height];if(l){var u=0,d=0;return Sf(n)?u=Nf(n,i.width):Sf(a)&&(d=Nf(a,i.height)),mb(n)?u=d*o:a&&!mb(a)||(d=u/o),[u,d]}var p=null,f=null;if(Sf(n)?p=Nf(n,i.width):a&&Sf(a)&&(f=Nf(a,i.height)),null===p||a&&!mb(a)||(f=A&&c?p/s*r:i.height),null!==f&&mb(n)&&(p=A&&c?f/r*s:i.width),null!==p&&null!==f)return[p,f];throw new Error("Unable to calculate background-size for element")},vb=function(e,t){var i=e[t];return void 0===i?e[0]:i},bb=function(e,t,i,s,r){var o=t[0],n=t[1],a=i[0],l=i[1];switch(e){case 2:return[new Xv(Math.round(s.left),Math.round(s.top+n)),new Xv(Math.round(s.left+s.width),Math.round(s.top+n)),new Xv(Math.round(s.left+s.width),Math.round(l+s.top+n)),new Xv(Math.round(s.left),Math.round(l+s.top+n))];case 3:return[new Xv(Math.round(s.left+o),Math.round(s.top)),new Xv(Math.round(s.left+o+a),Math.round(s.top)),new Xv(Math.round(s.left+o+a),Math.round(s.height+s.top)),new Xv(Math.round(s.left+o),Math.round(s.height+s.top))];case 1:return[new Xv(Math.round(s.left+o),Math.round(s.top+n)),new Xv(Math.round(s.left+o+a),Math.round(s.top+n)),new Xv(Math.round(s.left+o+a),Math.round(s.top+n+l)),new Xv(Math.round(s.left+o),Math.round(s.top+n+l))];default:return[new Xv(Math.round(r.left),Math.round(r.top)),new Xv(Math.round(r.left+r.width),Math.round(r.top)),new Xv(Math.round(r.left+r.width),Math.round(r.height+r.top)),new Xv(Math.round(r.left),Math.round(r.height+r.top))]}},yb=function(){function e(e){this._data={},this._document=e}return e.prototype.parseMetrics=function(e,t){var i=this._document.createElement("div"),s=this._document.createElement("img"),r=this._document.createElement("span"),o=this._document.body;i.style.visibility="hidden",i.style.fontFamily=e,i.style.fontSize=t,i.style.margin="0",i.style.padding="0",i.style.whiteSpace="nowrap",o.appendChild(i),s.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",s.width=1,s.height=1,s.style.margin="0",s.style.padding="0",s.style.verticalAlign="baseline",r.style.fontFamily=e,r.style.fontSize=t,r.style.margin="0",r.style.padding="0",r.appendChild(this._document.createTextNode("Hidden Text")),i.appendChild(r),i.appendChild(s);var n=s.offsetTop-r.offsetTop+2;i.removeChild(r),i.appendChild(this._document.createTextNode("Hidden Text")),i.style.lineHeight="normal",s.style.verticalAlign="super";var a=s.offsetTop-i.offsetTop+2;return o.removeChild(i),{baseline:n,middle:a}},e.prototype.getMetrics=function(e,t){var i=e+" "+t;return void 0===this._data[i]&&(this._data[i]=this.parseMetrics(e,t)),this._data[i]},e}(),wb=function(e,t){this.context=e,this.options=t},Bb=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s._activeEffects=[],s.canvas=i.canvas?i.canvas:document.createElement("canvas"),s.ctx=s.canvas.getContext("2d"),i.canvas||(s.canvas.width=Math.floor(i.width*i.scale),s.canvas.height=Math.floor(i.height*i.scale),s.canvas.style.width=i.width+"px",s.canvas.style.height=i.height+"px"),s.fontMetrics=new yb(document),s.ctx.scale(s.options.scale,s.options.scale),s.ctx.translate(-i.x,-i.y),s.ctx.textBaseline="bottom",s._activeEffects=[],s.context.logger.debug("Canvas renderer initialized ("+i.width+"x"+i.height+") with scale "+i.scale),s}return Nd(t,e),t.prototype.applyEffects=function(e){for(var t=this;this._activeEffects.length;)this.popEffect();e.forEach((function(e){return t.applyEffect(e)}))},t.prototype.applyEffect=function(e){this.ctx.save(),function(e){return 2===e.type}(e)&&(this.ctx.globalAlpha=e.opacity),function(e){return 0===e.type}(e)&&(this.ctx.translate(e.offsetX,e.offsetY),this.ctx.transform(e.matrix[0],e.matrix[1],e.matrix[2],e.matrix[3],e.matrix[4],e.matrix[5]),this.ctx.translate(-e.offsetX,-e.offsetY)),rb(e)&&(this.path(e.path),this.ctx.clip()),this._activeEffects.push(e)},t.prototype.popEffect=function(){this._activeEffects.pop(),this.ctx.restore()},t.prototype.renderStack=function(e){return Qd(this,void 0,void 0,(function(){return Hd(this,(function(t){switch(t.label){case 0:return e.element.container.styles.isVisible()?[4,this.renderStackContent(e)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},t.prototype.renderNode=function(e){return Qd(this,void 0,void 0,(function(){return Hd(this,(function(t){switch(t.label){case 0:return Sg(e.container.flags,16),e.container.styles.isVisible()?[4,this.renderNodeBackgroundAndBorders(e)]:[3,3];case 1:return t.sent(),[4,this.renderNodeContent(e)];case 2:t.sent(),t.label=3;case 3:return[2]}}))}))},t.prototype.renderTextWithLetterSpacing=function(e,t,i){var s=this;0===t?this.ctx.fillText(e.text,e.bounds.left,e.bounds.top+i):y_(e.text).reduce((function(t,r){return s.ctx.fillText(r,t,e.bounds.top+i),t+s.ctx.measureText(r).width}),e.bounds.left)},t.prototype.createFontStyle=function(e){var t=e.fontVariant.filter((function(e){return"normal"===e||"small-caps"===e})).join(""),i=Eb(e.fontFamily).join(", "),s=Bf(e.fontSize)?""+e.fontSize.number+e.fontSize.unit:e.fontSize.number+"px";return[[e.fontStyle,t,e.fontWeight,s,i].join(" "),i,s]},t.prototype.renderTextNode=function(e,t){return Qd(this,void 0,void 0,(function(){var i,s,r,o,n,a,l,A,c=this;return Hd(this,(function(h){return i=this.createFontStyle(t),s=i[0],r=i[1],o=i[2],this.ctx.font=s,this.ctx.direction=1===t.direction?"rtl":"ltr",this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic",n=this.fontMetrics.getMetrics(r,o),a=n.baseline,l=n.middle,A=t.paintOrder,e.textBounds.forEach((function(e){A.forEach((function(i){switch(i){case 0:c.ctx.fillStyle=Wf(t.color),c.renderTextWithLetterSpacing(e,t.letterSpacing,a);var s=t.textShadow;s.length&&e.text.trim().length&&(s.slice(0).reverse().forEach((function(i){c.ctx.shadowColor=Wf(i.color),c.ctx.shadowOffsetX=i.offsetX.number*c.options.scale,c.ctx.shadowOffsetY=i.offsetY.number*c.options.scale,c.ctx.shadowBlur=i.blur.number,c.renderTextWithLetterSpacing(e,t.letterSpacing,a)})),c.ctx.shadowColor="",c.ctx.shadowOffsetX=0,c.ctx.shadowOffsetY=0,c.ctx.shadowBlur=0),t.textDecorationLine.length&&(c.ctx.fillStyle=Wf(t.textDecorationColor||t.color),t.textDecorationLine.forEach((function(t){switch(t){case 1:c.ctx.fillRect(e.bounds.left,Math.round(e.bounds.top+a),e.bounds.width,1);break;case 2:c.ctx.fillRect(e.bounds.left,Math.round(e.bounds.top),e.bounds.width,1);break;case 3:c.ctx.fillRect(e.bounds.left,Math.ceil(e.bounds.top+l),e.bounds.width,1)}})));break;case 1:t.webkitTextStrokeWidth&&e.text.trim().length&&(c.ctx.strokeStyle=Wf(t.webkitTextStrokeColor),c.ctx.lineWidth=t.webkitTextStrokeWidth,c.ctx.lineJoin=window.chrome?"miter":"round",c.ctx.strokeText(e.text,e.bounds.left,e.bounds.top+a)),c.ctx.strokeStyle="",c.ctx.lineWidth=0,c.ctx.lineJoin="miter"}}))})),[2]}))}))},t.prototype.renderReplacedElement=function(e,t,i){if(i&&e.intrinsicWidth>0&&e.intrinsicHeight>0){var s=pb(e),r=eb(t);this.path(r),this.ctx.save(),this.ctx.clip(),this.ctx.drawImage(i,0,0,e.intrinsicWidth,e.intrinsicHeight,s.left,s.top,s.width,s.height),this.ctx.restore()}},t.prototype.renderNodeContent=function(e){return Qd(this,void 0,void 0,(function(){var i,s,r,o,n,a,l,A,c,h,u,d,p,f,m,g,_,v;return Hd(this,(function(b){switch(b.label){case 0:this.applyEffects(e.getEffects(4)),i=e.container,s=e.curves,r=i.styles,o=0,n=i.textNodes,b.label=1;case 1:return o<n.length?(a=n[o],[4,this.renderTextNode(a,r)]):[3,4];case 2:b.sent(),b.label=3;case 3:return o++,[3,1];case 4:if(!(i instanceof F_))return[3,8];b.label=5;case 5:return b.trys.push([5,7,,8]),[4,this.context.cache.match(i.src)];case 6:return m=b.sent(),this.renderReplacedElement(i,s,m),[3,8];case 7:return b.sent(),this.context.logger.error("Error loading image "+i.src),[3,8];case 8:if(i instanceof I_&&this.renderReplacedElement(i,s,i.canvas),!(i instanceof T_))return[3,12];b.label=9;case 9:return b.trys.push([9,11,,12]),[4,this.context.cache.match(i.svg)];case 10:return m=b.sent(),this.renderReplacedElement(i,s,m),[3,12];case 11:return b.sent(),this.context.logger.error("Error loading svg "+i.svg.substring(0,255)),[3,12];case 12:return i instanceof V_&&i.tree?[4,new t(this.context,{scale:this.options.scale,backgroundColor:i.backgroundColor,x:0,y:0,width:i.width,height:i.height}).render(i.tree)]:[3,14];case 13:l=b.sent(),i.width&&i.height&&this.ctx.drawImage(l,0,0,i.width,i.height,i.bounds.left,i.bounds.top,i.bounds.width,i.bounds.height),b.label=14;case 14:if(i instanceof k_&&(A=Math.min(i.bounds.width,i.bounds.height),"checkbox"===i.type?i.checked&&(this.ctx.save(),this.path([new Xv(i.bounds.left+.39363*A,i.bounds.top+.79*A),new Xv(i.bounds.left+.16*A,i.bounds.top+.5549*A),new Xv(i.bounds.left+.27347*A,i.bounds.top+.44071*A),new Xv(i.bounds.left+.39694*A,i.bounds.top+.5649*A),new Xv(i.bounds.left+.72983*A,i.bounds.top+.23*A),new Xv(i.bounds.left+.84*A,i.bounds.top+.34085*A),new Xv(i.bounds.left+.39363*A,i.bounds.top+.79*A)]),this.ctx.fillStyle=Wf(707406591),this.ctx.fill(),this.ctx.restore()):"radio"===i.type&&i.checked&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i.bounds.left+A/2,i.bounds.top+A/2,A/4,0,2*Math.PI,!0),this.ctx.fillStyle=Wf(707406591),this.ctx.fill(),this.ctx.restore())),Pb(i)&&i.value.length){switch(c=this.createFontStyle(r),_=c[0],h=c[1],u=this.fontMetrics.getMetrics(_,h).baseline,this.ctx.font=_,this.ctx.fillStyle=Wf(r.color),this.ctx.textBaseline="alphabetic",this.ctx.textAlign=Cb(i.styles.textAlign),v=pb(i),d=0,i.styles.textAlign){case 1:d+=v.width/2;break;case 2:d+=v.width}p=v.add(d,0,0,-v.height/2+1),this.ctx.save(),this.path([new Xv(v.left,v.top),new Xv(v.left+v.width,v.top),new Xv(v.left+v.width,v.top+v.height),new Xv(v.left,v.top+v.height)]),this.ctx.clip(),this.renderTextWithLetterSpacing(new __(i.value,p),r.letterSpacing,u),this.ctx.restore(),this.ctx.textBaseline="alphabetic",this.ctx.textAlign="left"}if(!Sg(i.styles.display,2048))return[3,20];if(null===i.styles.listStyleImage)return[3,19];if(0!==(f=i.styles.listStyleImage).type)return[3,18];m=void 0,g=f.url,b.label=15;case 15:return b.trys.push([15,17,,18]),[4,this.context.cache.match(g)];case 16:return m=b.sent(),this.ctx.drawImage(m,i.bounds.left-(m.width+10),i.bounds.top),[3,18];case 17:return b.sent(),this.context.logger.error("Error loading list-style-image "+g),[3,18];case 18:return[3,20];case 19:e.listValue&&-1!==i.styles.listStyleType&&(_=this.createFontStyle(r)[0],this.ctx.font=_,this.ctx.fillStyle=Wf(r.color),this.ctx.textBaseline="middle",this.ctx.textAlign="right",v=new Gd(i.bounds.left,i.bounds.top+Nf(i.styles.paddingTop,i.bounds.width),i.bounds.width,Jm(r.lineHeight,r.fontSize.number)/2+1),this.renderTextWithLetterSpacing(new __(e.listValue,v),r.letterSpacing,Jm(r.lineHeight,r.fontSize.number)/2+2),this.ctx.textBaseline="bottom",this.ctx.textAlign="left"),b.label=20;case 20:return[2]}}))}))},t.prototype.renderStackContent=function(e){return Qd(this,void 0,void 0,(function(){var t,i,s,r,o,n,a,l,A,c,h,u,d,p,f;return Hd(this,(function(m){switch(m.label){case 0:return Sg(e.element.container.flags,16),[4,this.renderNodeBackgroundAndBorders(e.element)];case 1:m.sent(),t=0,i=e.negativeZIndex,m.label=2;case 2:return t<i.length?(f=i[t],[4,this.renderStack(f)]):[3,5];case 3:m.sent(),m.label=4;case 4:return t++,[3,2];case 5:return[4,this.renderNodeContent(e.element)];case 6:m.sent(),s=0,r=e.nonInlineLevel,m.label=7;case 7:return s<r.length?(f=r[s],[4,this.renderNode(f)]):[3,10];case 8:m.sent(),m.label=9;case 9:return s++,[3,7];case 10:o=0,n=e.nonPositionedFloats,m.label=11;case 11:return o<n.length?(f=n[o],[4,this.renderStack(f)]):[3,14];case 12:m.sent(),m.label=13;case 13:return o++,[3,11];case 14:a=0,l=e.nonPositionedInlineLevel,m.label=15;case 15:return a<l.length?(f=l[a],[4,this.renderStack(f)]):[3,18];case 16:m.sent(),m.label=17;case 17:return a++,[3,15];case 18:A=0,c=e.inlineLevel,m.label=19;case 19:return A<c.length?(f=c[A],[4,this.renderNode(f)]):[3,22];case 20:m.sent(),m.label=21;case 21:return A++,[3,19];case 22:h=0,u=e.zeroOrAutoZIndexOrTransformedOrOpacity,m.label=23;case 23:return h<u.length?(f=u[h],[4,this.renderStack(f)]):[3,26];case 24:m.sent(),m.label=25;case 25:return h++,[3,23];case 26:d=0,p=e.positiveZIndex,m.label=27;case 27:return d<p.length?(f=p[d],[4,this.renderStack(f)]):[3,30];case 28:m.sent(),m.label=29;case 29:return d++,[3,27];case 30:return[2]}}))}))},t.prototype.mask=function(e){this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.canvas.width,0),this.ctx.lineTo(this.canvas.width,this.canvas.height),this.ctx.lineTo(0,this.canvas.height),this.ctx.lineTo(0,0),this.formatPath(e.slice(0).reverse()),this.ctx.closePath()},t.prototype.path=function(e){this.ctx.beginPath(),this.formatPath(e),this.ctx.closePath()},t.prototype.formatPath=function(e){var t=this;e.forEach((function(e,i){var s=Jv(e)?e.start:e;0===i?t.ctx.moveTo(s.x,s.y):t.ctx.lineTo(s.x,s.y),Jv(e)&&t.ctx.bezierCurveTo(e.startControl.x,e.startControl.y,e.endControl.x,e.endControl.y,e.end.x,e.end.y)}))},t.prototype.renderRepeat=function(e,t,i,s){this.path(e),this.ctx.fillStyle=t,this.ctx.translate(i,s),this.ctx.fill(),this.ctx.translate(-i,-s)},t.prototype.resizeImage=function(e,t,i){var s;if(e.width===t&&e.height===i)return e;var r=(null!==(s=this.canvas.ownerDocument)&&void 0!==s?s:document).createElement("canvas");return r.width=Math.max(1,t),r.height=Math.max(1,i),r.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t,i),r},t.prototype.renderBackgroundImage=function(e){return Qd(this,void 0,void 0,(function(){var t,i,s,r,o,n;return Hd(this,(function(a){switch(a.label){case 0:t=e.styles.backgroundImage.length-1,i=function(i){var r,o,n,a,l,A,c,h,u,d,p,f,m,g,_,v,b,y,w,B,P,x,C,M,E,F,I,T,D,S,R;return Hd(this,(function(U){switch(U.label){case 0:if(0!==i.type)return[3,5];r=void 0,o=i.url,U.label=1;case 1:return U.trys.push([1,3,,4]),[4,s.context.cache.match(o)];case 2:return r=U.sent(),[3,4];case 3:return U.sent(),s.context.logger.error("Error loading background-image "+o),[3,4];case 4:return r&&(n=fb(e,t,[r.width,r.height,r.width/r.height]),v=n[0],x=n[1],C=n[2],w=n[3],B=n[4],g=s.ctx.createPattern(s.resizeImage(r,w,B),"repeat"),s.renderRepeat(v,g,x,C)),[3,6];case 5:1===i.type?(a=fb(e,t,[null,null,null]),v=a[0],x=a[1],C=a[2],w=a[3],B=a[4],l=om(i.angle,w,B),A=l[0],c=l[1],h=l[2],u=l[3],d=l[4],(p=document.createElement("canvas")).width=w,p.height=B,f=p.getContext("2d"),m=f.createLinearGradient(c,u,h,d),rm(i.stops,A).forEach((function(e){return m.addColorStop(e.stop,Wf(e.color))})),f.fillStyle=m,f.fillRect(0,0,w,B),w>0&&B>0&&(g=s.ctx.createPattern(p,"repeat"),s.renderRepeat(v,g,x,C))):function(e){return 2===e.type}(i)&&(_=fb(e,t,[null,null,null]),v=_[0],b=_[1],y=_[2],w=_[3],B=_[4],P=0===i.position.length?[Lf]:i.position,x=Nf(P[0],w),C=Nf(P[P.length-1],B),M=function(e,t,i,s,r){var o=0,n=0;switch(e.size){case 0:0===e.shape?o=n=Math.min(Math.abs(t),Math.abs(t-s),Math.abs(i),Math.abs(i-r)):1===e.shape&&(o=Math.min(Math.abs(t),Math.abs(t-s)),n=Math.min(Math.abs(i),Math.abs(i-r)));break;case 2:if(0===e.shape)o=n=Math.min(nm(t,i),nm(t,i-r),nm(t-s,i),nm(t-s,i-r));else if(1===e.shape){var a=Math.min(Math.abs(i),Math.abs(i-r))/Math.min(Math.abs(t),Math.abs(t-s)),l=am(s,r,t,i,!0),A=l[0],c=l[1];n=a*(o=nm(A-t,(c-i)/a))}break;case 1:0===e.shape?o=n=Math.max(Math.abs(t),Math.abs(t-s),Math.abs(i),Math.abs(i-r)):1===e.shape&&(o=Math.max(Math.abs(t),Math.abs(t-s)),n=Math.max(Math.abs(i),Math.abs(i-r)));break;case 3:if(0===e.shape)o=n=Math.max(nm(t,i),nm(t,i-r),nm(t-s,i),nm(t-s,i-r));else if(1===e.shape){a=Math.max(Math.abs(i),Math.abs(i-r))/Math.max(Math.abs(t),Math.abs(t-s));var h=am(s,r,t,i,!1);A=h[0],c=h[1],n=a*(o=nm(A-t,(c-i)/a))}}return Array.isArray(e.size)&&(o=Nf(e.size[0],s),n=2===e.size.length?Nf(e.size[1],r):o),[o,n]}(i,x,C,w,B),E=M[0],F=M[1],E>0&&F>0&&(I=s.ctx.createRadialGradient(b+x,y+C,0,b+x,y+C,E),rm(i.stops,2*E).forEach((function(e){return I.addColorStop(e.stop,Wf(e.color))})),s.path(v),s.ctx.fillStyle=I,E!==F?(T=e.bounds.left+.5*e.bounds.width,D=e.bounds.top+.5*e.bounds.height,R=1/(S=F/E),s.ctx.save(),s.ctx.translate(T,D),s.ctx.transform(1,0,0,S,0,0),s.ctx.translate(-T,-D),s.ctx.fillRect(b,R*(y-D)+D,w,B*R),s.ctx.restore()):s.ctx.fill())),U.label=6;case 6:return t--,[2]}}))},s=this,r=0,o=e.styles.backgroundImage.slice(0).reverse(),a.label=1;case 1:return r<o.length?(n=o[r],[5,i(n)]):[3,4];case 2:a.sent(),a.label=3;case 3:return r++,[3,1];case 4:return[2]}}))}))},t.prototype.renderSolidBorder=function(e,t,i){return Qd(this,void 0,void 0,(function(){return Hd(this,(function(s){return this.path(cb(i,t)),this.ctx.fillStyle=Wf(e),this.ctx.fill(),[2]}))}))},t.prototype.renderDoubleBorder=function(e,t,i,s){return Qd(this,void 0,void 0,(function(){var r,o;return Hd(this,(function(n){switch(n.label){case 0:return t<3?[4,this.renderSolidBorder(e,i,s)]:[3,2];case 1:return n.sent(),[2];case 2:return r=function(e,t){switch(t){case 0:return ub(e.topLeftBorderBox,e.topLeftBorderDoubleOuterBox,e.topRightBorderBox,e.topRightBorderDoubleOuterBox);case 1:return ub(e.topRightBorderBox,e.topRightBorderDoubleOuterBox,e.bottomRightBorderBox,e.bottomRightBorderDoubleOuterBox);case 2:return ub(e.bottomRightBorderBox,e.bottomRightBorderDoubleOuterBox,e.bottomLeftBorderBox,e.bottomLeftBorderDoubleOuterBox);default:return ub(e.bottomLeftBorderBox,e.bottomLeftBorderDoubleOuterBox,e.topLeftBorderBox,e.topLeftBorderDoubleOuterBox)}}(s,i),this.path(r),this.ctx.fillStyle=Wf(e),this.ctx.fill(),o=function(e,t){switch(t){case 0:return ub(e.topLeftBorderDoubleInnerBox,e.topLeftPaddingBox,e.topRightBorderDoubleInnerBox,e.topRightPaddingBox);case 1:return ub(e.topRightBorderDoubleInnerBox,e.topRightPaddingBox,e.bottomRightBorderDoubleInnerBox,e.bottomRightPaddingBox);case 2:return ub(e.bottomRightBorderDoubleInnerBox,e.bottomRightPaddingBox,e.bottomLeftBorderDoubleInnerBox,e.bottomLeftPaddingBox);default:return ub(e.bottomLeftBorderDoubleInnerBox,e.bottomLeftPaddingBox,e.topLeftBorderDoubleInnerBox,e.topLeftPaddingBox)}}(s,i),this.path(o),this.ctx.fill(),[2]}}))}))},t.prototype.renderNodeBackgroundAndBorders=function(e){return Qd(this,void 0,void 0,(function(){var t,i,s,r,o,n,a,l,A=this;return Hd(this,(function(c){switch(c.label){case 0:return this.applyEffects(e.getEffects(2)),t=e.container.styles,i=!zf(t.backgroundColor)||t.backgroundImage.length,s=[{style:t.borderTopStyle,color:t.borderTopColor,width:t.borderTopWidth},{style:t.borderRightStyle,color:t.borderRightColor,width:t.borderRightWidth},{style:t.borderBottomStyle,color:t.borderBottomColor,width:t.borderBottomWidth},{style:t.borderLeftStyle,color:t.borderLeftColor,width:t.borderLeftWidth}],r=xb(vb(t.backgroundClip,0),e.curves),i||t.boxShadow.length?(this.ctx.save(),this.path(r),this.ctx.clip(),zf(t.backgroundColor)||(this.ctx.fillStyle=Wf(t.backgroundColor),this.ctx.fill()),[4,this.renderBackgroundImage(e.container)]):[3,2];case 1:c.sent(),this.ctx.restore(),t.boxShadow.slice(0).reverse().forEach((function(t){A.ctx.save();var i,s,r,o,n,a=$v(e.curves),l=t.inset?0:1e4,c=(i=a,s=-l+(t.inset?1:-1)*t.spread.number,r=(t.inset?1:-1)*t.spread.number,o=t.spread.number*(t.inset?-2:2),n=t.spread.number*(t.inset?-2:2),i.map((function(e,t){switch(t){case 0:return e.add(s,r);case 1:return e.add(s+o,r);case 2:return e.add(s+o,r+n);case 3:return e.add(s,r+n)}return e})));t.inset?(A.path(a),A.ctx.clip(),A.mask(c)):(A.mask(a),A.ctx.clip(),A.path(c)),A.ctx.shadowOffsetX=t.offsetX.number+l,A.ctx.shadowOffsetY=t.offsetY.number,A.ctx.shadowColor=Wf(t.color),A.ctx.shadowBlur=t.blur.number,A.ctx.fillStyle=t.inset?Wf(t.color):"rgba(0,0,0,1)",A.ctx.fill(),A.ctx.restore()})),c.label=2;case 2:o=0,n=0,a=s,c.label=3;case 3:return n<a.length?0!==(l=a[n]).style&&!zf(l.color)&&l.width>0?2!==l.style?[3,5]:[4,this.renderDashedDottedBorder(l.color,l.width,o,e.curves,2)]:[3,11]:[3,13];case 4:return c.sent(),[3,11];case 5:return 3!==l.style?[3,7]:[4,this.renderDashedDottedBorder(l.color,l.width,o,e.curves,3)];case 6:return c.sent(),[3,11];case 7:return 4!==l.style?[3,9]:[4,this.renderDoubleBorder(l.color,l.width,o,e.curves)];case 8:return c.sent(),[3,11];case 9:return[4,this.renderSolidBorder(l.color,o,e.curves)];case 10:c.sent(),c.label=11;case 11:o++,c.label=12;case 12:return n++,[3,3];case 13:return[2]}}))}))},t.prototype.renderDashedDottedBorder=function(e,t,i,s,r){return Qd(this,void 0,void 0,(function(){var o,n,a,l,A,c,h,u,d,p,f,m,g,_,v,b;return Hd(this,(function(y){return this.ctx.save(),o=function(e,t){switch(t){case 0:return hb(e.topLeftBorderStroke,e.topRightBorderStroke);case 1:return hb(e.topRightBorderStroke,e.bottomRightBorderStroke);case 2:return hb(e.bottomRightBorderStroke,e.bottomLeftBorderStroke);default:return hb(e.bottomLeftBorderStroke,e.topLeftBorderStroke)}}(s,i),n=cb(s,i),2===r&&(this.path(n),this.ctx.clip()),Jv(n[0])?(a=n[0].start.x,l=n[0].start.y):(a=n[0].x,l=n[0].y),Jv(n[1])?(A=n[1].end.x,c=n[1].end.y):(A=n[1].x,c=n[1].y),h=0===i||2===i?Math.abs(a-A):Math.abs(l-c),this.ctx.beginPath(),3===r?this.formatPath(o):this.formatPath(n.slice(0,2)),u=t<3?3*t:2*t,d=t<3?2*t:t,3===r&&(u=t,d=t),p=!0,h<=2*u?p=!1:h<=2*u+d?(u*=f=h/(2*u+d),d*=f):(m=Math.floor((h+d)/(u+d)),g=(h-m*u)/(m-1),d=(_=(h-(m+1)*u)/m)<=0||Math.abs(d-g)<Math.abs(d-_)?g:_),p&&(3===r?this.ctx.setLineDash([0,u+d]):this.ctx.setLineDash([u,d])),3===r?(this.ctx.lineCap="round",this.ctx.lineWidth=t):this.ctx.lineWidth=2*t+1.1,this.ctx.strokeStyle=Wf(e),this.ctx.stroke(),this.ctx.setLineDash([]),2===r&&(Jv(n[0])&&(v=n[3],b=n[0],this.ctx.beginPath(),this.formatPath([new Xv(v.end.x,v.end.y),new Xv(b.start.x,b.start.y)]),this.ctx.stroke()),Jv(n[1])&&(v=n[1],b=n[2],this.ctx.beginPath(),this.formatPath([new Xv(v.end.x,v.end.y),new Xv(b.start.x,b.start.y)]),this.ctx.stroke())),this.ctx.restore(),[2]}))}))},t.prototype.render=function(e){return Qd(this,void 0,void 0,(function(){var t;return Hd(this,(function(i){switch(i.label){case 0:return this.options.backgroundColor&&(this.ctx.fillStyle=Wf(this.options.backgroundColor),this.ctx.fillRect(this.options.x,this.options.y,this.options.width,this.options.height)),s=new ab(e,null),r=new nb(s),lb(s,r,r,o=[]),Ab(s.container,o),t=r,[4,this.renderStack(t)];case 1:return i.sent(),this.applyEffects([]),[2,this.canvas]}var s,r,o}))}))},t}(wb),Pb=function(e){return e instanceof N_||(e instanceof O_||e instanceof k_&&"radio"!==e.type&&"checkbox"!==e.type)},xb=function(e,t){switch(e){case 0:return $v(t);case 2:return function(e){return[e.topLeftContentBox,e.topRightContentBox,e.bottomRightContentBox,e.bottomLeftContentBox]}(t);default:return eb(t)}},Cb=function(e){switch(e){case 1:return"center";case 2:return"right";default:return"left"}},Mb=["-apple-system","system-ui"],Eb=function(e){return/iPhone OS 15_(0|1)/.test(window.navigator.userAgent)?e.filter((function(e){return-1===Mb.indexOf(e)})):e},Fb=function(e){function t(t,i){var s=e.call(this,t,i)||this;return s.canvas=i.canvas?i.canvas:document.createElement("canvas"),s.ctx=s.canvas.getContext("2d"),s.options=i,s.canvas.width=Math.floor(i.width*i.scale),s.canvas.height=Math.floor(i.height*i.scale),s.canvas.style.width=i.width+"px",s.canvas.style.height=i.height+"px",s.ctx.scale(s.options.scale,s.options.scale),s.ctx.translate(-i.x,-i.y),s.context.logger.debug("EXPERIMENTAL ForeignObject renderer initialized ("+i.width+"x"+i.height+" at "+i.x+","+i.y+") with scale "+i.scale),s}return Nd(t,e),t.prototype.render=function(e){return Qd(this,void 0,void 0,(function(){var t,i;return Hd(this,(function(s){switch(s.label){case 0:return t=f_(this.options.width*this.options.scale,this.options.height*this.options.scale,this.options.scale,this.options.scale,e),[4,Ib(t)];case 1:return i=s.sent(),this.options.backgroundColor&&(this.ctx.fillStyle=Wf(this.options.backgroundColor),this.ctx.fillRect(0,0,this.options.width*this.options.scale,this.options.height*this.options.scale)),this.ctx.drawImage(i,-this.options.x*this.options.scale,-this.options.y*this.options.scale),[2,this.canvas]}}))}))},t}(wb),Ib=function(e){return new Promise((function(t,i){var s=new Image;s.onload=function(){t(s)},s.onerror=i,s.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent((new XMLSerializer).serializeToString(e))}))},Tb=function(){function e(e){var t=e.id,i=e.enabled;this.id=t,this.enabled=i,this.start=Date.now()}return e.prototype.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&("undefined"!=typeof window&&window.console&&"function"==typeof console.debug?console.debug.apply(console,jd([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},e.prototype.getTime=function(){return Date.now()-this.start},e.prototype.info=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&"undefined"!=typeof window&&window.console&&"function"==typeof console.info&&console.info.apply(console,jd([this.id,this.getTime()+"ms"],e))},e.prototype.warn=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&("undefined"!=typeof window&&window.console&&"function"==typeof console.warn?console.warn.apply(console,jd([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},e.prototype.error=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.enabled&&("undefined"!=typeof window&&window.console&&"function"==typeof console.error?console.error.apply(console,jd([this.id,this.getTime()+"ms"],e)):this.info.apply(this,e))},e.instances={},e}(),Db=function(){function e(t,i){var s;this.windowBounds=i,this.instanceName="#"+e.instanceCount++,this.logger=new Tb({id:this.instanceName,enabled:t.logging}),this.cache=null!==(s=t.cache)&&void 0!==s?s:new Ov(this,t)}return e.instanceCount=1,e}();"undefined"!=typeof window&&kv.setContext(window);var Sb=function(e,t){return Qd(void 0,void 0,void 0,(function(){var i,s,r,o,n,a,l,A,c,h,u,d,p,f,m,g,_,v,b,y,w,B,P,x,C,M,E,F,I,T,D,S,R,U,L,k,O,N;return Hd(this,(function(V){switch(V.label){case 0:if(!e||"object"!=typeof e)return[2,Promise.reject("Invalid element provided as first argument")];if(!(i=e.ownerDocument))throw new Error("Element is not attached to a Document");if(!(s=i.defaultView))throw new Error("Document is not attached to a Window");return r={allowTaint:null!==(B=t.allowTaint)&&void 0!==B&&B,imageTimeout:null!==(P=t.imageTimeout)&&void 0!==P?P:15e3,proxy:t.proxy,useCORS:null!==(x=t.useCORS)&&void 0!==x&&x},o=Vd({logging:null===(C=t.logging)||void 0===C||C,cache:t.cache},r),n={windowWidth:null!==(M=t.windowWidth)&&void 0!==M?M:s.innerWidth,windowHeight:null!==(E=t.windowHeight)&&void 0!==E?E:s.innerHeight,scrollX:null!==(F=t.scrollX)&&void 0!==F?F:s.pageXOffset,scrollY:null!==(I=t.scrollY)&&void 0!==I?I:s.pageYOffset},a=new Gd(n.scrollX,n.scrollY,n.windowWidth,n.windowHeight),l=new Db(o,a),A=null!==(T=t.foreignObjectRendering)&&void 0!==T&&T,c={allowTaint:null!==(D=t.allowTaint)&&void 0!==D&&D,onclone:t.onclone,ignoreElements:t.ignoreElements,inlineImages:A,copyStyles:A},l.logger.debug("Starting document clone with size "+a.width+"x"+a.height+" scrolled to "+-a.left+","+-a.top),h=new wv(l,e,c),(u=h.clonedReferenceElement)?[4,h.toIFrame(i,a)]:[2,Promise.reject("Unable to find element in cloned iframe")];case 1:return d=V.sent(),p=tv(u)||"HTML"===u.tagName?function(e){var t=e.body,i=e.documentElement;if(!t||!i)throw new Error("Unable to get document size");var s=Math.max(Math.max(t.scrollWidth,i.scrollWidth),Math.max(t.offsetWidth,i.offsetWidth),Math.max(t.clientWidth,i.clientWidth)),r=Math.max(Math.max(t.scrollHeight,i.scrollHeight),Math.max(t.offsetHeight,i.offsetHeight),Math.max(t.clientHeight,i.clientHeight));return new Gd(0,0,s,r)}(u.ownerDocument):zd(l,u),f=p.width,m=p.height,g=p.left,_=p.top,v=Rb(l,u,t.backgroundColor),b={canvas:t.canvas,backgroundColor:v,scale:null!==(R=null!==(S=t.scale)&&void 0!==S?S:s.devicePixelRatio)&&void 0!==R?R:1,x:(null!==(U=t.x)&&void 0!==U?U:0)+g,y:(null!==(L=t.y)&&void 0!==L?L:0)+_,width:null!==(k=t.width)&&void 0!==k?k:Math.ceil(f),height:null!==(O=t.height)&&void 0!==O?O:Math.ceil(m)},A?(l.logger.debug("Document cloned, using foreign object rendering"),[4,new Fb(l,b).render(u)]):[3,3];case 2:return y=V.sent(),[3,5];case 3:return l.logger.debug("Document cloned, element located at "+g+","+_+" with size "+f+"x"+m+" using computed rendering"),l.logger.debug("Starting DOM parsing"),w=G_(l,u),v===w.styles.backgroundColor&&(w.styles.backgroundColor=em.TRANSPARENT),l.logger.debug("Starting renderer for element at "+b.x+","+b.y+" with size "+b.width+"x"+b.height),[4,new Bb(l,b).render(w)];case 4:y=V.sent(),V.label=5;case 5:return(null===(N=t.removeContainer)||void 0===N||N)&&(wv.destroy(d)||l.logger.error("Cannot detach cloned iframe as it is not in the DOM anymore")),l.logger.debug("Finished rendering"),[2,y]}}))}))},Rb=function(e,t,i){var s=t.ownerDocument,r=s.documentElement?$f(e,getComputedStyle(s.documentElement).backgroundColor):em.TRANSPARENT,o=s.body?$f(e,getComputedStyle(s.body).backgroundColor):em.TRANSPARENT,n="string"==typeof i?$f(e,i):null===i?em.TRANSPARENT:4294967295;return t===s.documentElement?zf(r)?zf(o)?n:o:r:n};function Ub(e,t,i=(()=>{})){if(!e||!t)return;let s=null;let r,o;const n=e=>{if(e.preventDefault(),s&&(clearTimeout(s),s=null),e.touches.length>1)return;const i=e.touches[0];r=i.clientX,o=i.clientY,s=setTimeout((()=>{e.clientX=i.clientX,e.clientY=i.clientY,t(e),clearTimeout(s),s=null}),500)},a=e=>{e.touches.length>1&&s&&(clearTimeout(s),s=null)},l=e=>{if(!s)return;const t=e.touches[0],i=Math.abs(t.clientX-r),n=Math.abs(t.clientY-o);(i>3||n>3)&&(clearTimeout(s),s=null)},A=e=>{e.preventDefault(),s&&(i(e),clearTimeout(s),s=null)},c=e=>{t(e),e.preventDefault(),e.stopPropagation()};return dh.isIphoneOrIpadSafari()?(e.addEventListener("touchstart",n),e.addEventListener("touchmove",l),e.addEventListener("touchend",A),window.addEventListener("touchstart",a)):e.addEventListener("contextmenu",c),function(){dh.isIphoneOrIpadSafari()?(e.removeEventListener("touchstart",n),e.removeEventListener("touchmove",l),e.removeEventListener("touchend",A),window.removeEventListener("touchstart",a)):e.removeEventListener("contextmenu",c)}}class Lb{constructor(e,t={}){this._highlightClass="viewer-ruler-dot-highlighted",this._x=0,this._y=0,this._dot=document.createElement("div"),this._dot.className+=this._dot.className?" viewer-ruler-dot":"viewer-ruler-dot",this._dotClickable=document.createElement("div"),this._dotClickable.className+=this._dotClickable.className?" viewer-ruler-dot-clickable":"viewer-ruler-dot-clickable",this._visible=!1!==t.visible,this._culled=!1;var i=this._dot,s=i.style;s["border-radius"]="25px",s.border="solid 2px white",s.background="lightgreen",s.position="absolute",s["z-index"]=void 0===t.zIndex?"40000005":t.zIndex,s.width="8px",s.height="8px",s.visibility=this._visible?"visible":"hidden",s.top="0px",s.left="0px",s["box-shadow"]="0 2px 5px 0 #182A3D;",s.opacity=1,s["pointer-events"]="none",t.onContextMenu,e.appendChild(i);var r=this._dotClickable,o=r.style;if(o["border-radius"]="35px",o.border="solid 10px white",o.position="absolute",o["z-index"]=void 0===t.zIndex?"40000007":t.zIndex+1,o.width="8px",o.height="8px",o.visibility="visible",o.top="0px",o.left="0px",o.opacity=0,o["pointer-events"]="none",t.onContextMenu,e.appendChild(r),r.addEventListener("click",(t=>{e.dispatchEvent(new MouseEvent("mouseover",t))})),t.onMouseOver&&r.addEventListener("mouseover",(i=>{t.onMouseOver(i,this),e.dispatchEvent(new MouseEvent("mouseover",i))})),t.onMouseLeave&&r.addEventListener("mouseleave",(e=>{t.onMouseLeave(e,this)})),t.onMouseWheel&&r.addEventListener("wheel",(e=>{t.onMouseWheel(e,this)})),t.onMouseDown&&r.addEventListener("mousedown",(e=>{t.onMouseDown(e,this)})),t.onMouseUp&&r.addEventListener("mouseup",(e=>{t.onMouseUp(e,this)})),t.onMouseMove&&r.addEventListener("mousemove",(e=>{t.onMouseMove(e,this)})),t.onTouchstart&&r.addEventListener("touchstart",(e=>{t.onTouchstart(e,this)})),t.onTouchmove&&r.addEventListener("touchmove",(e=>{t.onTouchmove(e,this)})),t.onTouchend&&r.addEventListener("touchend",(e=>{t.onTouchend(e,this)})),t.onContextMenu){Ub(r,(e=>{t.onContextMenu(e,this)}))}this.setPos(t.x||0,t.y||0),this.setFillColor(t.fillColor),this.setBorderColor(t.borderColor)}setPos(e,t){this._x=e,this._y=t;var i=this._dot.style;i.left=Math.round(e)-6+"px",i.top=Math.round(t)-6+"px";var s=this._dotClickable.style;s.left=Math.round(e)-14+"px",s.top=Math.round(t)-14+"px"}setFillColor(e){this._dot.style.background=e||"lightgreen"}setBorderColor(e){this._dot.style.border="solid 2px"+(e||"black")}setOpacity(e){this._dot.style.opacity=e}_updateVisibility(){this._dot.style.visibility=this._dotClickable.style.visibility=this._visible&&!this._culled?"visible":"hidden"}setVisible(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}setCulled(e){this._culled!==e&&(this._culled=!!e,this._updateVisibility())}setClickable(e){this._dotClickable.style["pointer-events"]=e?"all":"none"}setHighlighted(e){this._highlighted!==e&&(this._highlighted=!!e,this._highlighted?this._dot.classList.add(this._highlightClass):this._dot.classList.remove(this._highlightClass))}destroy(){this.setVisible(!1),this._dot.parentElement&&this._dot.parentElement.removeChild(this._dot),this._dotClickable.parentElement&&this._dotClickable.parentElement.removeChild(this._dotClickable)}}class kb{constructor(e,t={}){this._highlightClass="viewer-ruler-label-highlighted",this._prefix=t.prefix||"",this._x=0,this._y=0,this._visible=!0,this._culled=!1,this._label=document.createElement("div"),this._label.className+=this._label.className?" viewer-ruler-label":"viewer-ruler-label",this._timeout=null;var i=this._label,s=i.style;if(s["border-radius"]="5px",s.color="white",s.padding="4px",s.border="solid 1px",s.background="lightgreen",s.position="absolute",s["z-index"]=void 0===t.zIndex?"5000005":t.zIndex,s.width="auto",s.height="auto",s.visibility="visible",s.top="0px",s.left="0px",s["pointer-events"]="all",s.opacity=1,t.onContextMenu,i.innerText="",e.appendChild(i),this.setPos(t.x||0,t.y||0),this.setFillColor(t.fillColor),this.setBorderColor(t.fillColor),this.setText(t.text),t.onMouseOver&&i.addEventListener("mouseover",(e=>{t.onMouseOver(e,this),e.preventDefault()})),t.onMouseLeave&&i.addEventListener("mouseleave",(e=>{t.onMouseLeave(e,this),e.preventDefault()})),t.onMouseWheel&&i.addEventListener("wheel",(e=>{t.onMouseWheel(e,this)})),t.onMouseDown&&i.addEventListener("mousedown",(e=>{t.onMouseDown(e,this),e.stopPropagation()})),t.onMouseUp&&i.addEventListener("mouseup",(e=>{t.onMouseUp(e,this),e.stopPropagation()})),t.onMouseMove&&i.addEventListener("mousemove",(e=>{t.onMouseMove(e,this)})),t.onContextMenu){Ub(i,(e=>{t.onContextMenu(e,this)}))}}setPos(e,t){this._x=e,this._y=t;var i=this._label.style;i.left=Math.round(e)-20+"px",i.top=Math.round(t)-12+"px"}setPosOnWire(e,t,i,s){var r=e+.5*(i-e),o=t+.5*(s-t),n=this._label.style;n.left=Math.round(r)-20+"px",n.top=Math.round(o)-12+"px"}setPosBetweenWires(e,t,i,s,r,o){var n=(e+i+r)/3,a=(t+s+o)/3,l=this._label.style;l.left=Math.round(n)-20+"px",l.top=Math.round(a)-12+"px"}setText(e){this._label.innerHTML=this._prefix+(e||"")}setFillColor(e){this._fillColor=e||"lightgreen",this._label.style.background=this._fillColor}setBorderColor(e){this._borderColor=e||"black",this._label.style.border="solid 1px "+this._borderColor}setOpacity(e){this._label.style.opacity=e}_updateVisibility(){this._label.style.visibility=this._visible&&!this._culled?"visible":"hidden"}setVisible(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}setCulled(e){this._culled!==e&&(this._culled=!!e,this._updateVisibility())}setHighlighted(e){this._highlighted!==e&&(this._highlighted=!!e,this._highlighted?this._label.classList.add(this._highlightClass):this._label.classList.remove(this._highlightClass))}setClickable(e){this._label.style["pointer-events"]=e?"all":"none"}setPrefix(e){this._prefix!==e&&(this._prefix=e)}destroy(){this._label.parentElement&&this._label.parentElement.removeChild(this._label)}}class Ob{constructor(e,t={}){this._color=t.color||"black",this._highlightClass="viewer-ruler-wire-highlighted",this._wire=document.createElement("div"),this._wire.className+=this._wire.className?" viewer-ruler-wire":"viewer-ruler-wire",this._wireClickable=document.createElement("div"),this._wireClickable.className+=this._wireClickable.className?" viewer-ruler-wire-clickable":"viewer-ruler-wire-clickable",this._thickness=t.thickness||1,this._thicknessClickable=t.thicknessClickable||6,this._visible=!0,this._culled=!1;var i=this._wire,s=i.style;s.border="solid "+this._thickness+"px "+this._color,s.position="absolute",s["z-index"]=void 0===t.zIndex?"2000001":t.zIndex,s.width="0px",s.height="0px",s.visibility="visible",s.top="0px",s.left="0px",s["-webkit-transform-origin"]="0 0",s["-moz-transform-origin"]="0 0",s["-ms-transform-origin"]="0 0",s["-o-transform-origin"]="0 0",s["transform-origin"]="0 0",s["-webkit-transform"]="rotate(0deg)",s["-moz-transform"]="rotate(0deg)",s["-ms-transform"]="rotate(0deg)",s["-o-transform"]="rotate(0deg)",s.transform="rotate(0deg)",s.opacity=1,s["pointer-events"]="none",t.onContextMenu,e.appendChild(i);var r=this._wireClickable,o=r.style;if(o.border="solid "+this._thicknessClickable+"px "+this._color,o.position="absolute",o["z-index"]=void 0===t.zIndex?"2000002":t.zIndex+1,o.width="0px",o.height="0px",o.visibility="visible",o.top="0px",o.left="0px",o["-webkit-transform-origin"]="0 0",o["-moz-transform-origin"]="0 0",o["-ms-transform-origin"]="0 0",o["-o-transform-origin"]="0 0",o["transform-origin"]="0 0",o["-webkit-transform"]="rotate(0deg)",o["-moz-transform"]="rotate(0deg)",o["-ms-transform"]="rotate(0deg)",o["-o-transform"]="rotate(0deg)",o.transform="rotate(0deg)",o.opacity=0,o["pointer-events"]="none",t.onContextMenu,e.appendChild(r),t.onMouseOver&&r.addEventListener("mouseover",(e=>{t.onMouseOver(e,this)})),t.onMouseLeave&&r.addEventListener("mouseleave",(e=>{t.onMouseLeave(e,this)})),t.onMouseWheel&&r.addEventListener("wheel",(e=>{t.onMouseWheel(e,this)})),t.onMouseDown&&r.addEventListener("mousedown",(e=>{t.onMouseDown(e,this)})),t.onMouseUp&&r.addEventListener("mouseup",(e=>{t.onMouseUp(e,this)})),t.onMouseMove&&r.addEventListener("mousemove",(e=>{t.onMouseMove(e,this)})),t.onContextMenu){Ub(r,(e=>{t.onContextMenu(e,this)}))}this._x1=0,this._y1=0,this._x2=0,this._y2=0,this._update()}get visible(){return"visible"===this._wire.style.visibility}_update(){var e=Math.abs(Math.sqrt((this._x1-this._x2)*(this._x1-this._x2)+(this._y1-this._y2)*(this._y1-this._y2))),t=180*Math.atan2(this._y2-this._y1,this._x2-this._x1)/Math.PI,i=this._wire.style;i.width=Math.round(e)+"px",i.left=Math.round(this._x1)+"px",i.top=Math.round(this._y1)+"px",i["-webkit-transform"]=i["-moz-transform"]=i["-ms-transform"]=i["-o-transform"]=i.transform="rotate("+t+"deg) translate(-"+this._thickness+"px, -"+this._thickness+"px)";var s=this._wireClickable.style;s.width=Math.round(e)+"px",s.left=Math.round(this._x1)+"px",s.top=Math.round(this._y1)+"px",s["-webkit-transform"]=s["-moz-transform"]=s["-ms-transform"]=s["-o-transform"]=s.transform="rotate("+t+"deg) translate(-"+this._thicknessClickable+"px, -"+this._thicknessClickable+"px)"}setStartAndEnd(e,t,i,s){this._x1=e,this._y1=t,this._x2=i,this._y2=s,this._update()}setColor(e){this._color=e||"black",this._wire.style.border="solid "+this._thickness+"px "+this._color}setOpacity(e){this._wire.style.opacity=e}_updateVisibility(){this._wire.style.visibility=this._wireClickable.style.visibility=this._visible&&!this._culled?"visible":"hidden"}setVisible(e){this._visible!==e&&(this._visible=!!e,this._updateVisibility())}setCulled(e){this._culled!==e&&(this._culled=!!e,this._updateVisibility())}setClickable(e){this._wireClickable.style["pointer-events"]=e?"all":"none"}setHighlighted(e){this._highlighted!==e&&(this._highlighted=!!e,this._highlighted?this._wire.classList.add(this._highlightClass):this._wire.classList.remove(this._highlightClass))}destroy(e){this._wire.parentElement&&this._wire.parentElement.removeChild(this._wire),this._wireClickable.parentElement&&this._wireClickable.parentElement.removeChild(this._wireClickable)}}const Nb=d.vec2(),Vb=d.vec2(),Qb=d.vec2(),Hb=d.vec2(),jb=d.vec3(),Gb=d.vec3(),zb=d.vec4(),Wb=d.vec4(),Xb=d.vec4(),Kb=d.vec4(),Zb=d.mat4(),Jb={origin:d.vec3(),direction:d.vec3()},Yb=()=>{},qb=function(e,t,i,s){const r=(e-d.dotVec3(i,t))/d.dotVec3(s,t);if(r<0)return null;{const e=d.vec3();return d.mulVec3Scalar(s,r,e),d.addVec3(i,e,e),e}};function $b(e,t,i){const s=e.getBoundingClientRect(),r=t.getBoundingClientRect();i[0]+=s.left-r.left,i[1]+=s.top-r.top}const ey=(e,t,i)=>{Zb.set(e.viewMatrix),Zb.set(e.projMatrix),i.set(t),i[3]=1,d.mulMat4v4(e.viewMatrix,i,i),d.mulMat4v4(e.projMatrix,i,i)},ty=(e,t,i,s)=>{s[0]=.5*(1+i[0])*e.offsetWidth,s[1]=.5*(1-i[1])*e.offsetHeight,$b(e,t,s)},iy=(e,t,i,s,r,o)=>{const n=e.camera,a=e.canvas.canvas;if(d.distVec3(i,s)<.001)return!1;const l=d.subVec3(s,i,jb);let A=0,c=1;for(let t of e._sectionPlanesState.sectionPlanes){const e=d.dotVec3(t.dir,d.subVec3(t.pos,s,Gb)),r=d.dotVec3(t.dir,d.subVec3(t.pos,i,Gb));if(r>0&&e>0)return!1;if(r>0||e>0){const e=d.dotVec3(t.dir,l);if(Math.abs(e)>=1e-6){const i=d.dotVec3(t.dir,Gb)/e;r>0?A=Math.max(A,i):c=Math.min(c,i)}}}const h=zb,u=Wb;ey(n,A>0?d.addVec3(i,d.mulVec3Scalar(l,A,Gb),Gb):i,h),ey(n,c<1?d.addVec3(i,d.mulVec3Scalar(l,c,Gb),Gb):s,u);const p=h[2]/h[3]<-1||h[3]<0,f=u[2]/u[3]<-1||u[3]<0;if(p&&f)return!1;const m=(h[3]+h[2])/(h[3]+h[2]-(u[3]+u[2]));if(m>0&&m<1){const e=d.subVec4(u,h,Xb);d.mulVec4Scalar(e,m,e),d.addVec4(h,e,p?h:u)}d.mulVec4Scalar(h,1/h[3]),d.mulVec4Scalar(u,1/u[3]);let g=0,_=1;for(let e=0;e<2;++e){const t=u[e]-h[e],i=(-h[3]-h[e])/t,s=(h[3]-h[e])/t;t>0?(g=Math.max(g,i),_=Math.min(_,s)):(g=Math.max(g,s),_=Math.min(_,i))}if(g>=_)return!1;const v=d.subVec4(u,h,Xb);return d.addVec4(h,d.mulVec4Scalar(v,_,Kb),u),d.addVec4(h,d.mulVec4Scalar(v,g,Kb),h),d.mulVec4Scalar(h,1/h[3]),d.mulVec4Scalar(u,1/u[3]),ty(a,t,h,r),ty(a,t,u,o),!0};class sy extends Xc{constructor(e,t,i,s={}){const r=e.camera;super(e,t),this.__visible=!0;const o=(e,t)=>i=>{e&&e(i),this.fire(t,i,!0)};this._dot=new Lb(i,{borderColor:s.borderColor,fillColor:s.fillColor,zIndex:s.zIndex,onMouseOver:o(s.onMouseOver,"mouseover"),onMouseLeave:o(s.onMouseLeave,"mouseleave"),onMouseWheel:o(s.onMouseWheel,"wheel"),onMouseDown:o(s.onMouseDown,"mousedown"),onMouseUp:o(s.onMouseUp,"mouseup"),onMouseMove:o(s.onMouseMove,"mousemove"),onTouchstart:o(s.onTouchstart,"touchstart"),onTouchmove:o(s.onTouchmove,"touchmove"),onTouchend:o(s.onTouchend,"touchend"),onContextMenu:o(s.onContextMenu,"contextmenu")});const n=()=>{if(!this.__visible)return;const t=Xb;((e,t)=>{t.set(e),t[3]=1,d.mulMat4v4(r.viewMatrix,t,t),d.mulMat4v4(r.projMatrix,t,t)})(this.worldPos,t),d.mulVec3Scalar(t,1/t[3]);const s=t[3]<0||t[0]<-1||t[0]>1||t[1]<-1||t[1]>1||t[2]<-1||t[2]>1||e._sectionPlanesState.sectionPlanes.some((e=>d.dotVec3(e.dir,d.subVec3(e.pos,this.worldPos,jb))>0));this._dot.setCulled(s),s||((t=>{const s=e.canvas.canvas;t[0]=.5*(1+t[0])*s.offsetWidth,t[1]=.5*(1-t[1])*s.offsetHeight,$b(s,i,t)})(t),this._dot.setPos(t[0],t[1]))};this.on("worldPos",n);const a=r.on("viewMatrix",n),l=r.on("projMatrix",n),A=e.canvas.on("boundary",n),c=e.on("sectionPlaneUpdated",n),h=e.on("sectionPlaneCreated",n),u=e.on("sectionPlaneDestroyed",n);this._updatePosition=n,this._cleanup=()=>{r.off(a),r.off(l),e.canvas.off(A),e.off(c),e.off(h),e.off(u),this._dot.destroy()}}setClickable(e){this._dot.setClickable(e)}setFillColor(e){this._dot.setFillColor(e)}setBorderColor(e){this._dot.setBorderColor(e)}setHighlighted(e){this._dot.setHighlighted(e)}setOpacity(e){this._dot.setOpacity(e)}setVisible(e){this.__visible!=e&&(this.__visible=e,this._updatePosition(),this._dot.setVisible(e))}destroy(){this._cleanup(),super.destroy()}}class ry{constructor(e,t,i){const s=e.camera;this._label=new kb(t,i),this._start=d.vec3(),this._mid=d.vec3(),this._end=d.vec3(),this._yOff=0,this.__visible=!0,this._updatePos=()=>{ey(s,this._start,zb),d.mulVec4Scalar(zb,1/zb[3]),ty(e.canvas.canvas,t,zb,Nb),this._label.setPos(Nb[0],Nb[1])};const r=(e,t,i)=>{e[0]+=t[0],e[1]+=t[1],d.mulVec2Scalar(e,.5),this._label.setPos(e[0],e[1]+i)};this._updatePosBetween=()=>{const i=iy(e,t,this._start,this._mid,Nb,Vb),s=iy(e,t,this._end,this._mid,Qb,Hb);this._label.setCulled(!(i||s)),i&&s?(Vb[0]+=Hb[0],Vb[1]+=Hb[1],d.mulVec2Scalar(Vb,.5),Vb[0]+=Nb[0]+Qb[0],Vb[1]+=Nb[1]+Qb[1],d.mulVec2Scalar(Vb,1/3),this._label.setPos(Vb[0],Vb[1])):i?r(Nb,Vb,0):s&&r(Qb,Hb,0)},this._updatePosOnWire=()=>{const i=iy(e,t,this._start,this._end,Nb,Vb)&&d.distVec2(Nb,Vb)>=this._labelMinAxisLength;this._label.setCulled(!i),i&&r(Nb,Vb,this._yOff)};let o=()=>{};this._setUpdatePositions=e=>{o=e,this._updatePositions()},this._updatePositions=()=>{this.__visible&&o()};const n=s.on("viewMatrix",this._updatePositions),a=s.on("projMatrix",this._updatePositions),l=e.canvas.on("boundary",this._updatePositions),A=e.on("sectionPlaneUpdated",this._updatePositions),c=e.on("sectionPlaneCreated",this._updatePositions),h=e.on("sectionPlaneDestroyed",this._updatePositions);this._cleanup=()=>{s.off(n),s.off(a),e.canvas.off(l),e.off(A),e.off(c),e.off(h),this._label.destroy()}}setPos(e){this._start.set(e),this._setUpdatePositions(this._updatePos)}setPosOnWire(e,t,i,s){this._start.set(e),this._end.set(t),this._yOff=i,this._labelMinAxisLength=s,this._setUpdatePositions(this._updatePosOnWire)}setPosBetween(e,t,i){this._start.set(e),this._mid.set(t),this._end.set(i),this._setUpdatePositions(this._updatePosBetween)}setFillColor(e){this._label.setFillColor(e)}setHighlighted(e){this._label.setHighlighted(e)}setText(e){this._label.setText(e)}setClickable(e){this._label.setClickable(e)}setVisible(e){this.__visible!=e&&(this.__visible=e,this._updatePositions(),this._label.setVisible(e))}destroy(){this._cleanup()}}class oy{constructor(e,t,i){const s=e.camera;this._wire=new Ob(t,i),this._start=d.vec3(),this._end=d.vec3(),this.__visible=!0,this._updatePositions=()=>{if(!this.__visible)return;const i=iy(e,t,this._start,this._end,Nb,Vb);this._wire.setCulled(!i),i&&this._wire.setStartAndEnd(Nb[0],Nb[1],Vb[0],Vb[1])};const r=s.on("viewMatrix",this._updatePositions),o=s.on("projMatrix",this._updatePositions),n=e.canvas.on("boundary",this._updatePositions),a=e.on("sectionPlaneUpdated",this._updatePositions),l=e.on("sectionPlaneCreated",this._updatePositions),A=e.on("sectionPlaneDestroyed",this._updatePositions);this._cleanup=()=>{s.off(r),s.off(o),e.canvas.off(n),e.off(a),e.off(l),e.off(A),this._wire.destroy()}}setEnds(e,t){this._start.set(e),this._end.set(t),this._updatePositions()}setClickable(e){this._wire.setClickable(e)}setColor(e){this._wire.setColor(e)}setHighlighted(e){this._wire.setHighlighted(e)}setOpacity(e){this._wire.setOpacity(e)}setVisible(e){this.__visible!=e&&(this.__visible=e,this._updatePositions(),this._wire.setVisible(e))}destroy(){this._cleanup()}}const ny=function(e,t){const i=new sy(e,{},e.canvas.canvas.parentNode,{borderColor:"white",fillColor:t,zIndex:100});return{update:function(e){e&&(i.worldPos=e),i.setVisible(!!e)},setFillColor:e=>i.setFillColor(e),setHighlighted:e=>i.setHighlighted(e),getCanvasPos:()=>i.canvasPos,getWorldPos:()=>i.worldPos,destroy:()=>i.destroy()}},ay=function(e,t){const i=new oy(e,e.canvas.canvas.ownerDocument.body,{color:t,thickness:1,thicknessClickable:6});return i.setVisible(!1),{update:(e,t)=>{t&&i.setEnds(e,t),i.setVisible(!!t)},setColor:e=>i.setColor(e),destroy:()=>i.destroy()}};function ly(e,t){const i=function(e,i){if(e in t)return t[e];if(void 0!==i)return i;throw"config missing: "+e},s=i("viewer"),r=i("ray2WorldPos"),o=i("handleMouseEvents",!1),n=i("handleTouchEvents",!1),a=i("onStart",Yb),l=i("onMove",Yb),A=i("onEnd",Yb),c=s.scene,h=c.canvas.canvas,u=e=>{const t=d.vec2([e.clientX,e.clientY]);$b(h.ownerDocument.documentElement,h,t),l(t,(e=>{const t=d.vec3(),i=d.vec3();return d.canvasPosToWorldRay(h,c.camera.viewMatrix,c.camera.projMatrix,c.camera.projection,e,t,i),r(t,i,e)})(t))};let p=null;const f=function(e){const t=p.matchesEvent(e);t&&u(t)},m=function(t){const i=p.matchesEvent(t);i&&(e.setOpacity(b),p.cleanup(),u(i),A())},g=function(t,i){p&&p.cleanup(),e.setOpacity(1),e.setClickable(!1),s.cameraControl.active=!1,p={matchesEvent:t,cleanup:function(){p=null,e.setClickable(!0),s.cameraControl.active=!0,i()}},a()},_=[],v=function(t,i){const s=e.on(t,i);_.push((()=>e.off(s)))};if(o&&(v("mouseover",(()=>!p&&e.setOpacity(1))),v("mouseleave",(()=>!p&&e.setOpacity(b))),v("mousedown",(e=>{1===e.which&&(h.addEventListener("mousemove",f),h.addEventListener("mouseup",m),g((e=>1===e.which&&e),(()=>{h.removeEventListener("mousemove",f),h.removeEventListener("mouseup",m)})))}))),n){let e;v("touchstart",(t=>{t.preventDefault(),1===t.touches.length&&(e=t.touches[0].identifier,g((t=>[...t.changedTouches].find((t=>t.identifier===e))),(()=>{e=null})))})),v("touchmove",(e=>{e.preventDefault(),f(e)})),v("touchend",(e=>{e.preventDefault(),m(e)}))}const b=.8;return e.setOpacity(b),function(){p&&p.cleanup(),_.forEach((e=>e())),e.setOpacity(1)}}function Ay(e){const t=function(t,i){if(t in e)return e[t];if(void 0!==i)return i;throw"config missing: "+t},i=t("viewer"),s=t("handleMouseEvents",!1),r=t("handleTouchEvents",!1),o=t("pointerLens",null),n=t("dots"),a=t("ray2WorldPos"),l=t("onEnd",Yb),A=o?function(e){o.visible=!!e,e&&(o.canvasPos=e)}:()=>{},c=n.map((e=>{let t;return ly(e,{handleMouseEvents:s,handleTouchEvents:r,viewer:i,ray2WorldPos:(e,i,s)=>a(e,i,s)||t,onStart:()=>{t=e.worldPos.slice(),h(!1,e)},onMove:(t,i)=>{A(t),e.worldPos=i},onEnd:()=>{l(t,e)||(e.worldPos=t),A(null),h(!0,e)}})})),h=(e,t)=>n.forEach((i=>i!==t&&i.setClickable(e)));return h(!0),function(){c.forEach((e=>e())),A(null)}}const cy=function(e,t,i){return function(s,r,o){const n=e.scene,a=n.canvas.canvas,l=(e,t)=>(t[0]=e.clientX,t[1]=e.clientY,$b(a.ownerDocument.documentElement,a,t),t),A=e=>{const t=d.vec3(),s=d.vec3();return d.canvasPosToWorldRay(a,n.camera.viewMatrix,n.camera.projMatrix,n.camera.projection,e,t,s),i(t,s)};let c=null;const h=()=>{};let u,p=h;const f=function(){t.stop(),clearTimeout(c),e.cameraControl.active=!0,p=h,u=null},m=function(){f(),a.removeEventListener("touchstart",g),a.removeEventListener("touchmove",_),a.removeEventListener("touchend",v)},g=function(i){const o=i.touches;if(1!==o.length)f(),s();else{const i=o[0],s=l(i,d.vec2());A(s)&&(u=i.identifier,p=e=>{d.distVec2(s,e)>20&&f()},c=setTimeout((function(){t.start(s),c=setTimeout((function(){t.stop(),e.cameraControl.active=!1,p=e=>{r(e,A(e))},p(s)}),300)}),250))}};a.addEventListener("touchstart",g,{passive:!0});const _=function(e){const t=[...e.changedTouches].find((e=>e.identifier===u));t&&p(l(t,d.vec2()))};a.addEventListener("touchmove",_,{passive:!0});const v=function(e){const t=[...e.changedTouches].find((e=>e.identifier===u));if(t){m();const e=l(t,d.vec2());o(e,A(e))}};return a.addEventListener("touchend",v,{passive:!0}),m}},hy=function(e){const t=[];for(let i=0;i<e.length;++i)t.push(i);const i=function(){const i=d.vec2(),s=d.vec2();let r=0;for(let o=0;o<t.length;++o){const n=e[t[o]],a=e[t[(o+1)%t.length]],l=e[t[(o+2)%t.length]];d.subVec2(n,a,i),d.subVec2(l,a,s);const A=d.dotVec2(i,s)/Math.sqrt(d.sqLenVec2(i)*d.sqLenVec2(s)),c=Math.acos(Math.max(-1,Math.min(A,1)));r+=i[0]*s[1]-i[1]*s[0]>=0?c:2*Math.PI-c}return r<t.length*Math.PI}(),s=function(){const e=(e,t,i)=>(e[0]-i[0])*(t[1]-i[1])-(t[0]-i[0])*(e[1]-i[1]);return(t,i,s,r)=>{const o=e(t,i,s),n=e(t,s,r),a=e(t,r,i);return!((o<0||n<0||a<0)&&(o>0||n>0||a>0))}}(),r=[],o=(i?t:t.slice(0).reverse()).map((e=>({idx:e})));o.forEach(((e,t)=>{e.prev=o[(t-1+o.length)%o.length],e.next=o[(t+1)%o.length]}));const n=d.vec2(),a=d.vec2();for(;o.length>2;){let t=0;for(;;){if(t>=o.length)throw`isCCW = ${i}; earIdx = ${t}; len = ${o.length}`;const r=o[t],l=e[r.prev.idx],A=e[r.idx],c=e[r.next.idx];if(d.subVec2(l,A,n),d.subVec2(c,A,a),n[0]*a[1]-n[1]*a[0]>=0&&o.every((t=>t===r||t===r.prev||t===r.next||!s(e[t.idx],l,A,c))))break;++t}const l=o[t];o.splice(t,1),r.push([l.idx,l.next.idx,l.prev.idx]);l.prev.next=l.next;l.next.prev=l.prev}return[e,r,i]},uy=function(e,t){const i=(t,i)=>(i[0]=t.clientX,i[1]=t.clientY,$b(e.ownerDocument.documentElement,e,i),i);let s=!1;const r=[],o=()=>r.forEach((e=>e())),n=(t,i)=>{e.addEventListener(t,i),r.push((()=>e.removeEventListener(t,i)))},a=d.vec2();return n("mousedown",(function(e){1===e.which&&(s=!0,t(i(e,a)))})),n("mousemove",(function(e){i(e,Nb),s&&d.distVec2(a,Nb)>4&&(s=!1),(s||1&!e.buttons)&&t(Nb)})),n("mouseup",(function(e){if(1===e.which&&s){const s=t(i(e,Nb));s&&(o(),s())}})),o},dy=function(e,t,i,s){const r=d.vec2(),o=(t,i)=>(i[0]=t.clientX,i[1]=t.clientY,$b(e.ownerDocument.documentElement,e,i),i);let n,a=null,l=Yb;const A=function(){clearTimeout(a),i.stop(),t.active=!0,l=Yb,n=null},c=[],h=()=>c.forEach((e=>e())),u=(t,i)=>{e.addEventListener(t,i,{passive:!0}),c.push((()=>e.removeEventListener(t,i)))};return u("touchstart",(function(e){const c=e.touches;if(1!==c.length)A(),s(null);else{const e=c[0];o(e,r),n=e.identifier,l=e=>{d.distVec2(r,e)>20&&A()},a=setTimeout((function(){i.start(r),a=setTimeout((function(){i.stop(),t.active=!1,l=s,l(r)}),300)}),250)}})),u("touchmove",(function(e){const t=[...e.changedTouches].find((e=>e.identifier===n));t&&l(o(t,Nb))})),u("touchend",(function(e){const t=[...e.changedTouches].find((e=>e.identifier===n));if(t){const e=s(o(t,Nb));A(),e?(h(),e()):s(null)}})),()=>{A(),h()}},py=function(e,t,i,s,r,o){const n=e.canvas.canvas,a=t?function(e,i){t.visible=!!e,e&&(t.canvasPos=e,t.snapped=!!i)}:()=>{},l=function(){const e=(e,t,i)=>t[0]<=Math.max(e[0],i[0])&&t[0]>=Math.min(e[0],i[0])&&t[1]<=Math.max(e[1],i[1])&&t[1]>=Math.min(e[1],i[1]),t=(e,t,i)=>{const s=(t[1]-e[1])*(i[0]-t[0])-(t[0]-e[0])*(i[1]-t[1]);return 0===s?0:s>0?1:2};return function(i,s){const r=s?1:0,o=i[(i.length-2+r)%i.length],n=i[(i.length-1+r)%i.length];for(let s=r;s<i.length-2-1+r;++s){const r=i[s],a=i[s+1],l=t(o,n,r),A=t(o,n,a),c=t(r,a,o),h=t(r,a,n);if(l!==A&&c!==h||0===l&&e(o,r,n)||0===A&&e(o,a,n)||0===c&&e(r,o,a)||0===h&&e(r,n,a))return!0}return!1}}(),A=e=>e.length>=3&&function(){const t=d.normalizeVec3(d.subVec3(e[1],e[0],d.vec3())),i=d.normalizeVec3(d.subVec3(e[2],e[0],jb)),s=d.normalizeVec3(d.cross3Vec3(t,i,d.vec3())),r=d.normalizeVec3(d.cross3Vec3(s,t,d.vec3()));return{normal:s,origin:d.vec3(e[0]),u:t,v:r}}(),c=[];let h;return function t(){const u=A(c);let p=!1;const f=i((t=>{const i=t&&(e=>{const t=s(e),i=t&&t.entity&&(!u||t.snapped)&&t.worldPos;if(u){const t=d.dotVec3(u.normal,u.origin),s=i?t-d.dotVec3(i,u.normal):window.Infinity;if(Math.abs(s)<1e-4){const e=d.vec3();return{worldPos:d.addVec3(i,d.mulVec3Scalar(u.normal,s,e),e),snapped:!0}}return{worldPos:qb(t,u.normal,e.origin,e.direction),snapped:!1}}return{worldPos:i,snapped:t&&t.snapped}})(((t,i)=>(d.canvasPosToWorldRay(n,e.camera.viewMatrix,e.camera.projMatrix,e.camera.projection,t,i.origin,i.direction),i))(t,Jb)),r=i&&i.worldPos;return m(r,t,i&&i.snapped)})),m=(i,s,n)=>{const h=i?e.camera.projectWorldPos(i):s,f=c.length>0&&function(){const t=c[0];return{canvasPos:e.camera.projectWorldPos(t),worldPos:t}}(),m=c.length>=3&&(h&&d.distVec2(h,f.canvasPos)<10||i&&d.compareVec3(i,f.worldPos));a(m?f.canvasPos:h,m||n);const g=s&&(!i||(c.length<3?c.some((e=>d.compareVec3(e,i))):d.compareVec3(c[c.length-1],i))),_=c.concat(m||!i||g?[]:[i]),v=!g&&(u||A(_)),b=v&&_.map((e=>(d.subVec3(e,v.origin,jb),d.vec2([d.dotVec3(jb,v.u),d.dotVec3(jb,v.v)])))),y=!(g||b&&l(b,m)),w=y&&b&&(m||!l(b,!0))&&function(){try{const[e,t,i]=hy(b);return{faces:t,vertices:e.map((e=>d.addVec3(v.origin,d.addVec3(d.mulVec3Scalar(v.u,e[0],jb),d.mulVec3Scalar(v.v,e[1],Gb),jb),d.vec3())))}}catch(e){return console.warn("e",e),!1}}();return r(_,m,y,w),p=y&&(m?()=>{a(null),o()}:()=>{c.push(d.vec3(i)),a(null),t()})};h={closePolygon:()=>{const e=c.length>=3&&m(c[0]);return e&&(f(),e()),!!e},placeVertex:()=>(p&&(f(),p()),!!p),popVertex:()=>c.length>0&&(f(),c.pop(),t(),!0),removePressListener:f,updateOnChange:()=>m()}}(),{cancel:()=>{h.removePressListener(),a(null)},closePolygon:()=>h.closePolygon(),placeVertex:()=>h.placeVertex(),popVertex:()=>h.popVertex(),updateOnChange:()=>h.updateOnChange()}};class fy{constructor(e){this.language="en",this.localeService=e.localeService||new z,this.scene=new Xu(this,{canvasId:e.canvasId,canvasElement:e.canvasElement,keyboardEventsElement:e.keyboardEventsElement,contextAttr:{preserveDrawingBuffer:!1!==e.preserveDrawingBuffer,premultipliedAlpha:!!e.premultipliedAlpha,antialias:!1!==e.antialias},spinnerElementId:e.spinnerElementId,transparent:!1!==e.transparent,gammaInput:!0,gammaOutput:!1,backgroundColor:e.backgroundColor,backgroundColorFromAmbientLight:e.backgroundColorFromAmbientLight,ticksPerRender:1,ticksPerOcclusionTest:20,units:e.units,scale:e.scale,origin:e.origin,saoEnabled:e.saoEnabled,alphaDepthMask:!1!==e.alphaDepthMask,entityOffsetsEnabled:!!e.entityOffsetsEnabled,readableGeometryEnabled:!!e.readableGeometryEnabled,logarithmicDepthBufferEnabled:!!e.logarithmicDepthBufferEnabled,pbrEnabled:!!e.pbrEnabled,colorTextureEnabled:!1!==e.colorTextureEnabled,dtxEnabled:!!e.dtxEnabled,markerZOffset:e.markerZOffset,numCachedSectionPlanes:e.numCachedSectionPlanes}),this.metaScene=new Ld(this,this.scene),this.id=e.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new se(this.scene,{duration:.5}),this.cameraControl=new Td(this.scene,{doublePickFlyTo:!0}),this._plugins=[],this._eventSubs={}}get capabilities(){return this.scene.capabilities}on(e,t){let i=this._eventSubs[e];i||(i=[],this._eventSubs[e]=i),i.push(t)}fire(e,t){const i=this._eventSubs[e];if(i)for(let e=0,s=i.length;e<s;e++)i[e](t)}off(e){}log(e){console.log(`[xeokit viewer ${this.id}]: ${e}`)}error(e){console.error(`[xeokit viewer ${this.id}]: ${e}`)}addPlugin(e){this._plugins.push(e)}removePlugin(e){for(let t=0,i=this._plugins.length;t<i;t++){const i=this._plugins[t];if(i===e)return i.clear&&i.clear(),void this._plugins.splice(t,1)}}sendToPlugins(e,t){for(let i=0,s=this._plugins.length;i<s;i++){const s=this._plugins[i];s.send&&s.send(e,t)}}clear(){throw'Viewer#clear() no longer implemented - use \'#sendToPlugins("clear") instead'}resetView(){throw"Viewer#resetView() no longer implemented - use CameraMemento & ObjectsMemento classes instead"}beginSnapshot(){this._snapshotBegun||(this.scene._renderer.beginSnapshot(),this._snapshotBegun=!0)}getSnapshot(e={}){const t=!this._snapshotBegun,i=void 0!==e.width&&void 0!==e.height,s=this.scene.canvas.canvas,r=s.clientWidth,o=s.clientHeight,n=e.width?Math.floor(e.width):s.width,a=e.height?Math.floor(e.height):s.height;i&&(s.width=n,s.height=a),this._snapshotBegun||this.beginSnapshot({width:n,height:a}),e.includeGizmos||this.sendToPlugins("snapshotStarting"),this.scene.fire("rendering",{},!0),this.scene._renderer.renderSnapshot();const l=this.scene._renderer.readSnapshot(e);return i&&(s.width=r,s.height=o,this.scene.glRedraw()),e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot(),l}async getSnapshotWithPlugins(e={}){const t=!this._snapshotBegun,i=void 0!==e.width&&void 0!==e.height,s=this.scene.canvas.canvas,r=s.clientWidth,o=s.clientHeight,n=e.width?Math.floor(e.width):s.width,a=e.height?Math.floor(e.height):s.height;i&&(s.width=n,s.height=a),this._snapshotBegun||this.beginSnapshot(),e.includeGizmos||this.sendToPlugins("snapshotStarting"),this.scene._renderer.renderSnapshot();const l=this.scene._renderer.readSnapshotAsCanvas();i&&(s.width=r,s.height=o,this.scene.glRedraw());const A={},c=[];for(let e=0,t=this._plugins.length;e<t;e++){const t=this._plugins[e];if(t.getContainerElement){const e=t.getContainerElement();e!==document.body&&(A[e.id]||(A[e.id]=!0,c.push(e)))}}const h=document.createElement("style");document.head.appendChild(h),h.sheet?.insertRule("body > div:last-child img { display: inline-block; }");for(let e=0,t=c.length;e<t;e++){const t=c[e];await(u=t,d={canvas:l,backgroundColor:null,scale:l.width/t.clientWidth},void 0===d&&(d={}),Sb(u,d)),l.getContext("2d").resetTransform()}var u,d;h.remove(),e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot();let p=e.format||"png";return"jpeg"!==p&&"png"!==p&&"bmp"!==p&&(console.error("Unsupported image format: '"+p+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'png'"),p="png"),e.includeGizmos||this.sendToPlugins("snapshotFinished"),t&&this.endSnapshot(),l.toDataURL(`image/${p}`)}endSnapshot(){this._snapshotBegun&&(this.scene._renderer.endSnapshot(),this.scene._renderer.render({force:!0}),this._snapshotBegun=!1)}destroy(){const e=this._plugins.slice();for(let t=0,i=e.length;t<i;t++){e[t].destroy()}this.scene.destroy()}}async function my(e,t){if(!t.src||!Array.isArray(t.src)||6!==t.src.length)throw new Error("src requires path to 6 images");const[i,s,r,o,n,a]=t.src;if(!(i&&s&&r&&o&&n&&a))throw new Error("All six images must be provided");const l=document.createElement("canvas"),A=l.getContext("2d"),c=e=>new Promise(((t,i)=>{const s=new Image;s.crossOrigin="anonymous",s.onload=()=>t(s),s.onerror=()=>i(new Error(`Failed to load image: ${e}`)),s.src=e}));try{const[h,u,d,p,f,m]=await Promise.all([c(i),c(s),c(r),c(o),c(n),c(a)]),g=h.width;if(u.width!==g||d.width!==g||p.width!==g||f.width!==g||m.width!==g)throw new Error("All skybox textures must have the same dimensions");l.width=4*g,l.height=3*g,A.fillStyle="black",A.fillRect(0,0,l.width,l.height),A.drawImage(u,0*g,1*g,g,g),A.drawImage(h,2*g,1*g,g,g),A.drawImage(d,1*g,0*g,g,g),A.drawImage(p,1*g,2*g,g,g),A.drawImage(f,1*g,1*g,g,g),A.drawImage(m,3*g,1*g,g,g);return new Is(e,{image:l,flipY:!0,wrapS:1001,wrapT:1001,encoding:t.encoding||3e3})}catch(e){throw console.error("Error creating combined skybox texture:",e),e}}function gy(e,t){return new fs(e,{geometry:new ve(e,{primitive:"triangles",positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),background:!0,scale:[1e3,1e3,1e3],rotation:[0,-90,0],material:new bs(e,{ambient:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],emissive:[1,1,1],emissiveMap:t,backfaces:!0}),visible:!0,pickable:!1,clippable:!1,collidable:!1})}function _y(e,t){const i=new ve(e,De({center:[0,0,0],radius:1,heightSegments:60,widthSegments:60})),s=new bs(e,{ambient:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],emissive:[1,1,1],emissiveMap:t,backfaces:!0});return new fs(e,{geometry:i,background:!0,rotation:[0,0,180],material:s,visible:!0,pickable:!1,clippable:!1,collidable:!1})}const vy=d.vec3(),by=d.vec3();class yy extends R{constructor(e,t={}){const i=e.viewer.scene;super(i,t),this.plugin=e;const s=t.container;if(!s)throw"config missing: container";this._color=t.color||e.defaultColor;const r=function(e){const t=[];let i=!1!==e;return{reg:e=>t.push(e),get:()=>i,set:e=>{i=!1!==e,t.forEach((e=>e(i)))}}};this._visible=r(t.visible),this._originVisible=r(t.originVisible),this._cornerVisible=r(t.cornerVisible),this._targetVisible=r(t.targetVisible),this._originWireVisible=r(t.originWireVisible),this._targetWireVisible=r(t.targetWireVisible),this._angleVisible=r(t.angleVisible),this._labelsVisible=r(),this.labelsVisible=t.labelsVisible,this._clickable=r(!1),this.approximate=t.approximate;const o=i.canvas.canvas,n=t.onMouseOver?e=>{t.onMouseOver(e,this),o.dispatchEvent(new MouseEvent("mouseover",e))}:null,a=t.onMouseLeave?e=>{t.onMouseLeave(e,this),o.dispatchEvent(new MouseEvent("mouseleave",e))}:null,l=t.onContextMenu?e=>{t.onContextMenu(e,this)}:null,A=e=>o.dispatchEvent(new MouseEvent("mousedown",e)),c=e=>o.dispatchEvent(new MouseEvent("mouseup",e)),h=e=>o.dispatchEvent(new MouseEvent("mousemove",e)),u=e=>o.dispatchEvent(new WheelEvent("wheel",e));this._cleanups=[],this._drawables=[];const d=(e,t)=>{const i=()=>e.setVisible(t.every((e=>e.get())));t.forEach((e=>e.reg(i))),this._drawables.push(e),this._cleanups.push((()=>e.destroy()))},p=(t,r,o)=>{const p=new oy(i,s,{color:t,thickness:r,thicknessClickable:6,zIndex:void 0!==e.zIndex?e.zIndex+1:void 0,onMouseOver:n,onMouseLeave:a,onMouseWheel:u,onMouseDown:A,onMouseUp:c,onMouseMove:h,onContextMenu:l});return d(p,o),{setEnds:(e,t)=>p.setEnds(e,t),setColor:e=>p.setColor(e)}};this._originWire=p(this._color||"blue",1,[this._visible,this._originWireVisible]),this._targetWire=p(this._color||"red",1,[this._visible,this._targetWireVisible]);this._angleLabel=((t,r,o)=>{const p=new ry(i,s,{fillColor:t,zIndex:e.zIndex+r,onMouseOver:n,onMouseLeave:a,onMouseWheel:u,onMouseDown:A,onMouseUp:c,onMouseMove:h,onContextMenu:l});return d(p,o),{setFillColor:e=>p.setFillColor(e),setPosOnWire:(e,t,i)=>p.setPosOnWire(e,t,i),setPosBetween:(e,t,i)=>p.setPosBetween(e,t,i),setText:e=>p.setText(e)}})(this._color||"#00BBFF",2,[this._visible,this._angleVisible,this._labelsVisible]);const f=(t,r)=>{const o=new sy(i,t,s,{fillColor:this._color,zIndex:void 0!==e.zIndex?e.zIndex+2:void 0,onMouseOver:n,onMouseLeave:a,onMouseWheel:u,onMouseDown:A,onMouseUp:c,onMouseMove:h,onContextMenu:l});return o.on("worldPos",(()=>this._update())),d(o,r),o};this._originDot=f(t.origin,[this._visible,this._originVisible]),this._cornerDot=f(t.corner,[this._visible,this._cornerVisible]),this._targetDot=f(t.target,[this._visible,this._targetVisible]),this._update()}_update(){if(!this._targetDot)return;const e=this._originDot.worldPos,t=this._cornerDot.worldPos,i=this._targetDot.worldPos;this._originWire.setEnds(e,t),this._targetWire.setEnds(t,i),this._angleLabel.setPosBetween(e,t,i),d.subVec3(e,t,vy),d.subVec3(i,t,by),d.lenVec3(vy)>0&&d.lenVec3(by)>0?(d.normalizeVec3(vy),d.normalizeVec3(by),this._angle=Math.abs(d.angleVec3(vy,by))*d.RADTODEG,this._angleLabel.setText((this._approximate?" ~ ":" = ")+this._angle.toFixed(2)+"°")):(this._angle=void 0,this._angleLabel.setText(""))}set approximate(e){e=!1!==e,this._approximate!==e&&(this._approximate=e,this._update())}get approximate(){return this._approximate}get origin(){return this._originDot}get corner(){return this._cornerDot}get target(){return this._targetDot}get angle(){return this._angle}get color(){return this._color}set color(e){this._color=e,this._originDot.setFillColor(e),this._cornerDot.setFillColor(e),this._targetDot.setFillColor(e),this._originWire.setColor(e||"blue"),this._targetWire.setColor(e||"red"),this._angleLabel.setFillColor(e||"#00BBFF")}set visible(e){this._visible.set(e)}get visible(){return this._visible.get()}set originVisible(e){this._originVisible.set(e)}get originVisible(){return this._originVisible.get()}set cornerVisible(e){this._cornerVisible.set(e)}get cornerVisible(){return this._cornerVisible.get()}set targetVisible(e){this._targetVisible.set(e)}get targetVisible(){return this._targetVisible.get()}set originWireVisible(e){this._originWireVisible.set(e)}get originWireVisible(){return this._originWireVisible.get()}set targetWireVisible(e){this._targetWireVisible.set(e)}get targetWireVisible(){return this._targetWireVisible.get()}set angleVisible(e){this._angleVisible.set(e)}get angleVisible(){return this._angleVisible.get()}set labelsVisible(e){this._labelsVisible.set(void 0!==e?Boolean(e):this.plugin.defaultLabelsVisible)}get labelsVisible(){return this._labelsVisible.get()}setHighlighted(e){this._drawables.forEach((t=>t.setHighlighted(e)))}set clickable(e){this._clickable.set(!!e),this._drawables.forEach((e=>e.setClickable(this._clickable.get())))}get clickable(){return this._clickable.get()}destroy(){this._cleanups.forEach((e=>e())),super.destroy()}}class wy extends R{get active(){}set snapping(e){}get snapping(){return!0}activate(){}deactivate(){}reset(){}get currentMeasurement(){return null}destroy(){}}class By extends wy{constructor(e,t={}){super(e.viewer.scene),this._canvasToPagePos=t.canvasToPagePos,this.pointerLens=t.pointerLens,this._active=!1,this._currentAngleMeasurement=null,this._initMarkerDiv(),this._snapping=!1!==t.snapping,this._mouseState=0,this._attachPlugin(e,t)}_initMarkerDiv(){const e=document.createElement("div"),t=this.scene.canvas.canvas;t.parentNode.insertBefore(e,t),e.style.background="black",e.style.border="2px solid blue",e.style.borderRadius="10px",e.style.width="5px",e.style.height="5px",e.style.top="-200px",e.style.left="-200px",e.style.margin="0 0",e.style.zIndex="100",e.style.position="absolute",e.style.pointerEvents="none",this.markerDiv=e}_destroyMarkerDiv(){this.markerDiv&&(this.markerDiv.parentNode.removeChild(this.markerDiv),this.markerDiv=null)}_attachPlugin(e,t={}){this.angleMeasurementsPlugin=e,this.plugin=e}get active(){return this._active}set snapping(e){this._snapping=e}get snapping(){return this._snapping}activate(){if(this._active)return;this.markerDiv||this._initMarkerDiv(),this.angleMeasurementsPlugin;const e=this.scene;e.input;const t=e.canvas.canvas,i=this.angleMeasurementsPlugin.viewer.cameraControl,s=this.pointerLens;let r=!1,o=null,n=0,a=0;const l=d.vec3(),A=d.vec2();this._currentAngleMeasurement=null;const c=d.vec2(),h=e=>{e.snappedToVertex||e.snappedToEdge?(s&&(s.visible=!0,s.canvasPos=e.canvasPos,s.snappedCanvasPos=e.snappedCanvasPos||e.canvasPos,s.snapped=!0),this.markerDiv.style.background="greenyellow",this.markerDiv.style.border="2px solid green"):(s&&(s.visible=!0,s.canvasPos=e.canvasPos,s.snappedCanvasPos=e.canvasPos,s.snapped=!1),this.markerDiv.style.background="pink",this.markerDiv.style.border="2px solid red");const i=e.snappedCanvasPos||e.canvasPos;switch(r=!0,o=e.entity,l.set(e.worldPos),A.set(i),this._mouseState){case 0:if(this._canvasToPagePos)this._canvasToPagePos(t,i,c),this.markerDiv.style.left=c[0]-5+"px",this.markerDiv.style.top=c[1]-5+"px";else{const e=d.vec2(i);$b(t,this.markerDiv.parentNode,e),this.markerDiv.style.left=e[0]-5+"px",this.markerDiv.style.top=e[1]-5+"px"}break;case 1:this._currentAngleMeasurement&&(this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.angleVisible=!1,this._currentAngleMeasurement.corner.worldPos=e.worldPos,this._currentAngleMeasurement.corner.entity=e.entity),this.markerDiv.style.left="-10000px",this.markerDiv.style.top="-10000px",t.style.cursor="pointer";break;case 2:this._currentAngleMeasurement&&(this._currentAngleMeasurement.targetWireVisible=!0,this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.angleVisible=!0,this._currentAngleMeasurement.target.worldPos=e.worldPos,this._currentAngleMeasurement.target.entity=e.entity),this.markerDiv.style.left="-10000px",this.markerDiv.style.top="-10000px",t.style.cursor="pointer"}};this._onHoverSnapOrSurface=i.on("hoverSnapOrSurface",(e=>{this._snapping&&h(e)})),this._onHoverSurface=i.on("hoverSurface",(e=>{this._snapping||h(e)})),t.addEventListener("mousedown",this._onMouseDown=e=>{1===e.which&&(n=e.clientX,a=e.clientY)}),t.addEventListener("mouseup",this._onMouseUp=e=>{if(1===e.which&&!(e.clientX>n+20||e.clientX<n-20||e.clientY>a+20||e.clientY<a-20))switch(this._mouseState){case 0:r&&(this._currentAngleMeasurement=this.angleMeasurementsPlugin.createMeasurement({id:d.createUUID(),origin:{worldPos:l,entity:o},corner:{worldPos:l,entity:o},target:{worldPos:l,entity:o},approximate:!0}),this._currentAngleMeasurement.clickable=!1,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.angleVisible=!1,this._currentAngleMeasurement.origin.entity=o,this._mouseState=1,this.angleMeasurementsPlugin.fire("measurementStart",this._currentAngleMeasurement));break;case 1:r?(this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.angleVisible=!0,this._currentAngleMeasurement.corner.entity=o,this._mouseState=2):this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null,o=null,this._mouseState=0,this.angleMeasurementsPlugin.fire("measurementCancel",this._currentAngleMeasurement));break;case 2:r?(this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.angleVisible=!0,this._currentAngleMeasurement.target.entity=o,this._currentAngleMeasurement.clickable=!0,o=null,this.angleMeasurementsPlugin.fire("measurementEnd",this._currentAngleMeasurement),this._currentAngleMeasurement=null,this._mouseState=0):this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null,o=null,this._mouseState=0,this.angleMeasurementsPlugin.fire("measurementCancel",this._currentAngleMeasurement))}});const u=e=>{if(r=!1,s&&(s.visible=!0,s.canvasPos=e.canvasPos,s.snappedCanvasPos=e.snappedCanvasPos||e.canvasPos,s.snapped=!1),this.markerDiv.style.left="-100px",this.markerDiv.style.top="-100px",this._currentAngleMeasurement){switch(this._mouseState){case 0:this._currentAngleMeasurement.originVisible=!1;break;case 1:this._currentAngleMeasurement.cornerVisible=!1,this._currentAngleMeasurement.originWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1;break;case 2:this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1}t.style.cursor="default"}};this._onHoverSnapOrSurfaceOff=i.on("hoverSnapOrSurfaceOff",(e=>{this._snapping&&u(e)})),this._onHoverOff=i.on("hoverOff",(e=>{this._snapping||u(e)})),this._active=!0}deactivate(){if(!this._active)return;this.pointerLens&&(this.pointerLens.visible=!1),this.reset();const e=this.scene.canvas.canvas;e.removeEventListener("mousedown",this._onMouseDown),e.removeEventListener("mouseup",this._onMouseUp);const t=this.angleMeasurementsPlugin.viewer.cameraControl;t.off(this._onHoverSnapOrSurface),t.off(this._onHoverSurface),t.off(this._onHoverSnapOrSurfaceOff),t.off(this._onHoverOff),this._active=!1}reset(){this._active&&(this._destroyMarkerDiv(),this._initMarkerDiv(),this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null),this._mouseState=0)}get currentMeasurement(){return this._currentAngleMeasurement}destroy(){this.deactivate(),super.destroy()}}class Py extends ph{constructor(e,t={}){super("AngleMeasurements",e),this._container=t.container||document.body,this._defaultControl=null,this._measurements={},this.defaultColor=void 0!==t.defaultColor?t.defaultColor:"#00BBFF",this.defaultLabelsVisible=!1!==t.defaultLabelsVisible,this.zIndex=t.zIndex||1e4,this._onMouseOver=(e,t)=>{this.fire("mouseOver",{plugin:this,angleMeasurement:t,measurement:t,event:e})},this._onMouseLeave=(e,t)=>{this.fire("mouseLeave",{plugin:this,angleMeasurement:t,measurement:t,event:e})},this._onContextMenu=(e,t)=>{this.fire("contextMenu",{plugin:this,angleMeasurement:t,measurement:t,event:e})}}getContainerElement(){return this._container}send(e,t){}get control(){return this._defaultControl||(this._defaultControl=new By(this,{})),this._defaultControl}get measurements(){return this._measurements}createMeasurement(e={}){this.viewer.scene.components[e.id]&&(this.error("Viewer scene component with this ID already exists: "+e.id),delete e.id);const t=e.origin,i=e.corner,s=e.target,r=new yy(this,{id:e.id,plugin:this,container:this._container,origin:{entity:t.entity,worldPos:t.worldPos},corner:{entity:i.entity,worldPos:i.worldPos},target:{entity:s.entity,worldPos:s.worldPos},visible:e.visible,originVisible:!0,originWireVisible:!0,cornerVisible:!0,targetWireVisible:!0,targetVisible:!0,onMouseOver:this._onMouseOver,onMouseLeave:this._onMouseLeave,onContextMenu:this._onContextMenu});return this._measurements[r.id]=r,r.on("destroyed",(()=>{delete this._measurements[r.id]})),r.clickable=!0,this.fire("measurementCreated",r),r}destroyMeasurement(e){const t=this._measurements[e];t?(t.destroy(),this.fire("measurementDestroyed",t)):this.log("AngleMeasurement not found: "+e)}setLabelsShown(e){for(const[t,i]of Object.entries(this.measurements))i.labelShown=e}clear(){const e=Object.keys(this._measurements);for(var t=0,i=e.length;t<i;t++)this.destroyMeasurement(e[t])}destroy(){this.clear(),super.destroy()}}const xy=d.vec2();class Cy extends wy{constructor(e,t={}){super(e.viewer.scene),this.pointerLens=t.pointerLens,this.pointerCircle=new G(e.viewer),this._active=!1;const i=document.createElement("div"),s=this.scene.canvas.canvas;s.parentNode.insertBefore(i,s),i.style.background="black",i.style.border="2px solid blue",i.style.borderRadius="10px",i.style.width="5px",i.style.height="5px",i.style.margin="-200px -200px",i.style.zIndex="100",i.style.position="absolute",i.style.pointerEvents="none",this.markerDiv=i,this._currentAngleMeasurement=null,this._longTouchTimeoutMs=300,this._snapping=!1!==t.snapping,this._touchState=0,this._attachPlugin(e,t)}_attachPlugin(e){this.angleMeasurementsPlugin=e,this.plugin=e}get active(){return this._active}set snapping(e){this._snapping=e}get snapping(){return this._snapping}activate(){if(this._active)return;const e=this.plugin,t=this.scene,i=t.canvas.canvas;e.pointerLens;const s=d.vec3(),r=20;let o=null;this._touchState=0;const n=d.vec2(),a=d.vec2(),l=d.vec2();let A=null;const c=()=>{this.plugin.viewer.cameraControl.active=!1},h=()=>{this.plugin.viewer.cameraControl.active=!0},u=()=>{o&&(clearTimeout(o),o=null),this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null),h(),this._touchState=0},p=(e,t)=>(t[0]=e.clientX,t[1]=e.clientY,$b(i.ownerDocument.documentElement,i,t),t),f=(e,t)=>(t.set(e),$b(i,i.ownerDocument.documentElement,t),t);i.addEventListener("touchstart",this._onCanvasTouchStart=i=>{const l=i.touches.length;if(1!==l)return void(o&&(clearTimeout(o),o=null));const h=i.touches[0];switch(p(h,n),a.set(n),this._touchState){case 0:if(1!==l&&null!==o)return void u();const i=t.pick({canvasPos:a,snapToVertex:this._snapping,snapToEdge:this._snapping});if(i&&i.snapped)s.set(i.worldPos),this.pointerCircle.start(f(i.snappedCanvasPos,xy));else{const e=t.pick({canvasPos:a,pickSurface:!0});if(!e||!e.worldPos)return;s.set(e.worldPos),this.pointerCircle.start(f(e.canvasPos,xy))}o=setTimeout((()=>{1!==l||a[0]>n[0]+r||a[0]<n[0]-r||a[1]>n[1]+r||a[1]<n[1]-r||(this.pointerLens&&(this.pointerLens.visible=!0,this.pointerLens.canvasPos=n,this.pointerLens.cursorPos=n),this.pointerLens&&(this.pointerLens.canvasPos=a,this.pointerLens.snapped=!1),this.pointerLens&&(this.pointerLens.cursorPos=i.canvasPos,this.pointerLens.snapped=!0),this._currentAngleMeasurement?this._currentAngleMeasurement.origin.worldPos=s:(this._currentAngleMeasurement=e.createMeasurement({id:d.createUUID(),origin:{worldPos:i.worldPos,entity:i.entity},corner:{worldPos:i.worldPos,entity:i.entity},target:{worldPos:i.worldPos,entity:i.entity}}),this._currentAngleMeasurement.clickable=!1,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!1,this._currentAngleMeasurement.cornerVisible=!1,this._currentAngleMeasurement.cornerWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1),this.angleMeasurementsPlugin.fire("measurementStart",this._currentAngleMeasurement),this._touchState=2,c())}),this._longTouchTimeoutMs),this._touchState=1,A=h.identifier;break;case 3:if(1!==l&&null!==o)return clearTimeout(o),void(o=null);1===l&&(o=setTimeout((()=>{if(o=null,1!==l||a[0]>n[0]+r||a[0]<n[0]-r||a[1]>n[1]+r||a[1]<n[1]-r)return;this.pointerLens&&(this.pointerLens.visible=!0,this.pointerLens.canvasPos=n,this.pointerLens.snapped=!1);const e=t.pick({canvasPos:a,snapToVertex:this._snapping,snapToEdge:this._snapping});if(e&&e.snapped)this.pointerLens&&(this.pointerLens.cursorPos=e.snappedCanvasPos,this.pointerLens.snapped=!0),this.pointerCircle.start(f(e.snappedCanvasPos,xy)),s.set(e.worldPos),this._currentAngleMeasurement.corner.worldPos=e.worldPos,this._currentAngleMeasurement.corner.entity=e.entity,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.cornerWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1,this.angleMeasurementsPlugin.fire("measurementStart",this._currentAngleMeasurement);else{const e=t.pick({canvasPos:a,pickSurface:!0});e&&e.worldPos?(this.pointerLens&&(this.pointerLens.cursorPos=e.canvasPos,this.pointerLens.snapped=!1),this.pointerCircle.start(f(e.canvasPos,xy)),s.set(e.worldPos),this._currentAngleMeasurement.corner.worldPos=e.worldPos,this._currentAngleMeasurement.corner.entity=e.entity,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.cornerWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1,this.angleMeasurementsPlugin.fire("measurementStart",this._currentAngleMeasurement)):this.pointerLens&&(this.pointerLens.cursorPos=null,this.pointerLens.snapped=!1)}this._touchState=5,c()}),this._longTouchTimeoutMs),this._touchState=4),A=h.identifier;break;case 6:if(1!==l&&null!==o)return clearTimeout(o),void(o=null);1===l&&(o=setTimeout((()=>{if(o=null,1!==l||a[0]>n[0]+r||a[0]<n[0]-r||a[1]>n[1]+r||a[1]<n[1]-r)return;this.pointerLens&&(this.pointerLens.visible=!0,this.pointerLens.canvasPos=n,this.pointerLens.snapped=!1);const e=t.pick({canvasPos:a,snapToVertex:this._snapping,snapToEdge:this._snapping});if(e&&e.snapped)this.pointerLens&&(this.pointerLens.cursorPos=e.snappedCanvasPos,this.pointerLens.snapped=!0),this.pointerCircle.start(f(e.snappedCanvasPos,xy)),s.set(e.worldPos),this._currentAngleMeasurement.target.worldPos=e.worldPos,this._currentAngleMeasurement.target.entity=e.entity,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.cornerWireVisible=!0,this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.targetWireVisible=!0,this._currentAngleMeasurement.angleVisible=!0,this.angleMeasurementsPlugin.fire("measurementStart",this._currentAngleMeasurement);else{const e=t.pick({canvasPos:a,pickSurface:!0});e&&e.worldPos?(this.pointerLens&&(this.pointerLens.cursorPos=e.canvasPos,this.pointerLens.snapped=!1),this.pointerCircle.start(f(e.canvasPos,xy)),s.set(e.worldPos),this._currentAngleMeasurement.target.worldPos=e.worldPos,this._currentAngleMeasurement.target.entity=e.entity,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.cornerWireVisible=!0,this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.targetWireVisible=!0,this._currentAngleMeasurement.angleVisible=!0,this.angleMeasurementsPlugin.fire("measurementStart",this._currentAngleMeasurement)):this.pointerLens&&(this.pointerLens.cursorPos=null,this.pointerLens.snapped=!1)}this._touchState=8,c()}),this._longTouchTimeoutMs),this._touchState=7),A=h.identifier;break;default:return null!==o&&(clearTimeout(o),o=null),void(this._touchState=7)}},{passive:!0}),i.addEventListener("touchmove",(e=>{this.pointerCircle.stop();const i=e.touches.length;if(1!==i||1!==e.changedTouches.length)return void(o&&(clearTimeout(o),o=null));const r=e.touches[0];if(r.identifier!==A)return;let n,l;switch(p(r,a),this._touchState){case 2:this.pointerLens&&(this.pointerLens.canvasPos=a),n=t.pick({canvasPos:a,snapToVertex:this._snapping,snapToEdge:this._snapping}),n&&n.snapped?(this.pointerLens&&(this.pointerLens.snappedCanvasPos=n.snappedCanvasPos,this.pointerLens.snapped=!0),s.set(n.worldPos),this._currentAngleMeasurement.origin.worldPos=n.worldPos):(l=t.pick({canvasPos:a,pickSurface:!0}),l&&l.worldPos?(this.pointerLens&&(this.pointerLens.cursorPos=l.canvasPos,this.pointerLens.snapped=!1),s.set(l.worldPos),this._currentAngleMeasurement.origin.worldPos=l.worldPos):this.pointerLens&&(this.pointerLens.cursorPos=null,this.pointerLens.snapped=!1)),this._touchState=2;break;case 5:if(1!==i&&null!==o)return clearTimeout(o),o=null,this.pointerLens&&(this.pointerLens.visible=!1),void(this._touchState=7);this.pointerLens&&(this.pointerLens.canvasPos=a),n=t.pick({canvasPos:a,snapToVertex:this._snapping,snapToEdge:this._snapping}),n&&n.worldPos?(this.pointerLens&&(this.pointerLens.cursorPos=n.snappedCanvasPos,this.pointerLens.snapped=!0),this._currentAngleMeasurement.corner.worldPos=n.worldPos,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.cornerWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1):(l=t.pick({canvasPos:a,pickSurface:!0}),l&&l.worldPos&&(this.pointerLens&&(this.pointerLens.cursorPos=l.canvasPos,this.pointerLens.snapped=!1),this._currentAngleMeasurement.corner.worldPos=l.worldPos,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.cornerWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1)),this._touchState=5;break;case 8:if(1!==i&&null!==o)return clearTimeout(o),o=null,this.pointerLens&&(this.pointerLens.visible=!1),void(this._touchState=7);this.pointerLens&&(this.pointerLens.canvasPos=a),n=t.pick({canvasPos:a,snapToVertex:this._snapping,snapToEdge:this._snapping}),n&&n.worldPos?(this.pointerLens&&(this.pointerLens.cursorPos=n.snappedCanvasPos,this.pointerLens.snapped=!0),this._currentAngleMeasurement.target.worldPos=n.worldPos,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.cornerWireVisible=!0,this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.targetWireVisible=!0,this._currentAngleMeasurement.angleVisible=!0):(l=t.pick({canvasPos:a,pickSurface:!0}),l&&l.worldPos&&(this.pointerLens&&(this.pointerLens.cursorPos=l.canvasPos,this.pointerLens.snapped=!1),this._currentAngleMeasurement.target.worldPos=l.worldPos,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.cornerWireVisible=!0,this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.targetWireVisible=!0,this._currentAngleMeasurement.angleVisible=!0)),this._touchState=8}}),{passive:!0}),i.addEventListener("touchend",this._onCanvasTouchEnd=i=>{this.pointerCircle.stop();const s=i.changedTouches.length;if(1!==s)return;const c=i.changedTouches[0];if(c.identifier!==A)return;o&&(clearTimeout(o),o=null),p(c,l);const u=l[0],f=l[1];switch(this._touchState){case 1:{if(1!==s||u>n[0]+r||u<n[0]-r||f>n[1]+r||f<n[1]-r)return void(this._touchState=0);const i=t.pick({canvasPos:a,pickSurface:!0});i&&i.worldPos?(this._currentAngleMeasurement=e.createMeasurement({id:d.createUUID(),origin:{worldPos:i.worldPos},corner:{worldPos:i.worldPos},target:{worldPos:i.worldPos}}),this._currentAngleMeasurement.clickable=!1,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!1,this._currentAngleMeasurement.cornerVisible=!1,this._currentAngleMeasurement.cornerWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1,this._touchState=3):(this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null),this._touchState=0)}h();break;case 2:this.pointerLens&&(this.pointerLens.visible=!1),this._currentAngleMeasurement?this._touchState=3:(this.pointerLens&&(this.pointerLens.snapped=!1,this.pointerLens.visible=!1),this._touchState=0),h();break;case 4:{if(1!==s||u>n[0]+r||u<n[0]-r||f>n[1]+r||f<n[1]-r)return void(this._touchState=3);const e=t.pick({canvasPos:a,pickSurface:!0});e&&e.worldPos?(this._currentAngleMeasurement.corner.worldPos=e.worldPos,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.cornerWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1,this._touchState=6):(this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null),this._touchState=0)}h();break;case 5:this.pointerLens&&(this.pointerLens.visible=!1),this._touchState=6,h();break;case 7:{if(1!==s||u>n[0]+r||u<n[0]-r||f>n[1]+r||f<n[1]-r)return void(this._touchState=6);const e=t.pick({canvasPos:a,pickSurface:!0});e&&e.worldPos?(this._currentAngleMeasurement.target.worldPos=e.worldPos,this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.cornerWireVisible=!0,this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.targetWireVisible=!0,this._currentAngleMeasurement.angleVisible=!0,this.angleMeasurementsPlugin.fire("measurementEnd",this._currentAngleMeasurement),this._currentAngleMeasurement=null):this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null),this._touchState=0}h();break;case 8:this.pointerLens&&(this.pointerLens.visible=!1),this._currentAngleMeasurement&&this._currentAngleMeasurement.targetVisible?(this._currentAngleMeasurement.clickable=!0,this.angleMeasurementsPlugin.fire("measurementEnd",this._currentAngleMeasurement),this._currentAngleMeasurement=null,this._touchState=0):(this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null),this._touchState=0),h()}},{passive:!0}),this._active=!0}deactivate(){if(!this._active)return;this.plugin.pointerLens&&(this.plugin.pointerLens.visible=!1),this.reset();const e=this.plugin.viewer.scene.canvas.canvas;e.removeEventListener("touchstart",this._onCanvasTouchStart),e.removeEventListener("touchend",this._onCanvasTouchEnd),this._active=!1,this.plugin.viewer.cameraControl.active=!0}reset(){this._active&&this._currentAngleMeasurement&&(this.angleMeasurementsPlugin.fire("measurementCancel",this._currentAngleMeasurement),this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null)}get currentMeasurement(){return this._currentAngleMeasurement}destroy(){this.deactivate(),super.destroy()}}class My extends R{constructor(e,t,i,s){const r=e.plugin.viewer;super(r.scene);const o=Ay({viewer:r,handleMouseEvents:i,handleTouchEvents:s,pointerLens:t.pointerLens,dots:[e.origin,e.corner,e.target],ray2WorldPos:(e,i,s)=>{const o=e=>{const t=r.scene.pick({canvasPos:s,snapToEdge:e,snapToVertex:e,pickSurface:!0});return t&&t.worldPos?t.worldPos:e&&o(!1)};return o(!!t.snapping)},onEnd:(e,t)=>{const i=!d.compareVec3(e,t.worldPos);return i&&this.fire("edited"),i}}),n=e.on("destroyed",o);this._deactivate=function(){e.off("destroyed",n),o()}}deactivate(){this._deactivate(),super.destroy()}}class Ey extends My{constructor(e,t){super(e,t,!0,!1)}}class Fy extends My{constructor(e,t){super(e,t,!1,!0)}}const Iy=d.vec3(),Ty=d.vec3(),Dy=d.vec3(),Sy=e=>e+"px";class Ry extends Xc{constructor(e,t){if(super(e,t),this.plugin=t.plugin,this._container=t.container,!this._container)throw"config missing: container";if(!t.markerElement&&!t.markerHTML)throw"config missing: need either markerElement or markerHTML";if(!t.labelElement&&!t.labelHTML)throw"config missing: need either labelElement or labelHTML";this._htmlDirty=!1,this._curMarkerWidth=void 0,this._curLabelWidth=0,t.markerElement?(this._marker=t.markerElement,this._marker.addEventListener("click",this._onMouseClickedExternalMarker=()=>{this.plugin.fire("markerClicked",this)}),this._onContextMenuExternalMarker=()=>{this.plugin.fire("contextmenu",this)},this._onContextMenuExternalMarkerRemover=Ub(this._marker,this._onContextMenuExternalMarker),this._marker.addEventListener("mouseenter",this._onMouseEnterExternalMarker=()=>{this.plugin.fire("markerMouseEnter",this)}),this._marker.addEventListener("mouseleave",this._onMouseLeaveExternalMarker=()=>{this.plugin.fire("markerMouseLeave",this)}),this._markerExternal=!0):(this._markerHTML=t.markerHTML,this._htmlDirty=!0,this._markerExternal=!1),t.labelElement?(this._label=t.labelElement,this._labelExternal=!0):(this._labelHTML=t.labelHTML,this._htmlDirty=!0,this._labelExternal=!1),this._markerShown=!!t.markerShown,this._labelShown=!!t.labelShown,this._values=t.values||{},this._layoutDirty=!0,this._visibilityDirty=!0,this._labelPosition=24,this._buildHTML(),this._onTick=this.scene.on("tick",(()=>{this._htmlDirty&&(this._buildHTML(),this._htmlDirty=!1,this._layoutDirty=!0,this._visibilityDirty=!0),(this._layoutDirty||this._visibilityDirty)&&(this._markerShown||this._labelShown)&&(this._updatePosition(),this._layoutDirty=!1),this._visibilityDirty&&(this._marker.style.visibility=this.visible&&this._markerShown?"visible":"hidden",this._label.style.visibility=this.visible&&this._markerShown&&this._labelShown?"visible":"hidden",this._visibilityDirty=!1)})),this.on("canvasPos",(()=>{this._layoutDirty=!0})),this.on("visible",(()=>{this._visibilityDirty=!0})),this.setMarkerShown(!1!==t.markerShown),this.setLabelShown(t.labelShown),this.eye=t.eye?t.eye.slice():null,this.look=t.look?t.look.slice():null,this.up=t.up?t.up.slice():null,this.projection=t.projection}_buildHTML(){if(!this._markerExternal){this._marker&&(this._container.removeChild(this._marker),this._marker=null);let e=this._markerHTML||"<p></p>";y.isArray(e)&&(e=e.join("")),e=this._renderTemplate(e.trim());const t=document.createRange().createContextualFragment(e);this._marker=t.firstChild,this._container.appendChild(this._marker),this._marker.style.visibility=this._markerShown?"visible":"hidden",this._marker.addEventListener("click",(()=>{this.plugin.fire("markerClicked",this)})),Ub(this._marker,(e=>{e.preventDefault(),this.plugin.fire("contextmenu",this)}),(e=>{e.preventDefault(),this.plugin.fire("markerClicked",this)})),this._marker.addEventListener("mouseenter",(()=>{this.plugin.fire("markerMouseEnter",this)})),this._marker.addEventListener("mouseleave",(()=>{this.plugin.fire("markerMouseLeave",this)})),this._marker.addEventListener("wheel",(e=>{this.plugin.viewer.scene.canvas.canvas.dispatchEvent(new WheelEvent("wheel",e))}))}if(!this._labelExternal){this._label&&(this._container.removeChild(this._label),this._label=null);let e=this._labelHTML||"<p></p>";y.isArray(e)&&(e=e.join("")),e=this._renderTemplate(e.trim());const t=document.createRange().createContextualFragment(e);this._label=t.firstChild,this._container.appendChild(this._label),this._label.style.visibility=this._markerShown&&this._labelShown?"visible":"hidden",this._label.addEventListener("wheel",(e=>{this.plugin.viewer.scene.canvas.canvas.dispatchEvent(new WheelEvent("wheel",e))}))}}_updateWithCurWidths(){const e=this.scene.canvas.boundary,t=e[0]+this.canvasPos[0],i=e[1]+this.canvasPos[1];if(this._marker.style.top=Sy(i-12),this._label.style.top=Sy(i-17),"legacy"===this._markerAlign)this._marker.style.left=Sy(t-12),this._label.style.left=Sy(t+40);else{const e=this._curMarkerWidth,i=t+("right"===this._markerAlign?-1:"center"===this._markerAlign?0:1)*(e/2-12);this._marker.style.left=Sy(i-e/2);const s=this._curLabelWidth,r=Math.sign(this._labelPosition);this._label.style.left=Sy(i+r*(e/2+Math.abs(this._labelPosition)+s/2)-s/2)}const s=90005+Math.floor(this._viewPos[2])+1;this._marker.style["z-index"]=s,this._label.style["z-index"]=s}_updateIfWidthsChanged(){let e=!1;const t=this._marker.getBoundingClientRect().width;this._curMarkerWidth!==t&&(this._curMarkerWidth=t,e=!0);if(1!==Math.sign(this._labelPosition)){const t=this._label.getBoundingClientRect().width;this._curLabelWidth!==t&&(this._curLabelWidth=t,e=!0)}e&&this._updateWithCurWidths()}_updatePosition(){const e="legacy"===this._markerAlign;e||void 0!==this._curMarkerWidth?(this._updateWithCurWidths(),window.clearTimeout(this._widthTimeout),e||(this._widthTimeout=window.setTimeout((()=>this._updateIfWidthsChanged()),500))):this._updateIfWidthsChanged()}_renderTemplate(e){for(var t in this._values)if(this._values.hasOwnProperty(t)){const i=this._values[t];e=e.replace(new RegExp("{{"+t+"}}","g"),i)}return e}setFromPickResult(e){if(e.worldPos&&e.worldNormal){const t=d.normalizeVec3(e.worldNormal,Iy),i=this.plugin&&this.plugin.surfaceOffset||0,s=d.mulVec3Scalar(t,i,Ty),r=d.addVec3(e.worldPos,s,Dy);this.entity=e.entity,this.worldPos=r}else this.error("Param 'pickResult' does not have both worldPos and worldNormal")}setMarkerAlign(e){const t=["left","center","right","legacy"];t.includes(e)?(this._markerAlign=e,this._updatePosition()):this.error("Param 'align' should be one of: "+JSON.stringify(t))}setLabelPosition(e){"number"!=typeof e?this.error("Param 'position' is not a number"):0===e?this.error("Param 'position' is zero"):(this._labelPosition=e,this._updatePosition())}setMarkerShown(e){e=!!e,this._markerShown!==e&&(this._markerShown=e,this._visibilityDirty=!0)}getMarkerShown(){return this._markerShown}setLabelShown(e){e=!!e,this._labelShown!==e&&(this._labelShown=e,this._visibilityDirty=!0)}getLabelShown(){return this._labelShown}setField(e,t){this._values[e]=t||"",this._htmlDirty=!0}getField(e){return this._values[e]}setValues(e){for(var t in e)if(e.hasOwnProperty(t)){const i=e[t];this.setField(t,i)}}getValues(){return this._values}destroy(){window.clearTimeout(this._widthTimeout),this._marker&&(this._markerExternal?(this._marker.removeEventListener("click",this._onMouseClickedExternalMarker),this._onContextMenuExternalMarkerRemover(),this._marker.removeEventListener("mouseenter",this._onMouseEnterExternalMarker),this._marker.removeEventListener("mouseleave",this._onMouseLeaveExternalMarker),this._marker=null):(this._marker.parentNode.removeChild(this._marker),this._marker=null)),this._label&&(this._labelExternal||this._label.parentNode.removeChild(this._label),this._label=null),this.scene.off(this._onTick),super.destroy()}}class Uy extends ph{constructor(e,t){super("Annotations",e),this._labelHTML=t.labelHTML||"<div></div>",this._markerHTML=t.markerHTML||"<div></div>",this._container=t.container||document.body,this._values=t.values||{},this.annotations={},this.surfaceOffset=t.surfaceOffset}getContainerElement(){return this._container}send(e,t){if("clearAnnotations"===e)this.clear()}set surfaceOffset(e){null==e&&(e=.3),this._surfaceOffset=e}get surfaceOffset(){return this._surfaceOffset}createAnnotation(e){this.viewer.scene.components[e.id]&&(this.error("Viewer component with this ID already exists: "+e.id),delete e.id);var t=null;e.markerElementId&&((t=document.getElementById(e.markerElementId))||this.error("Can't find DOM element for 'markerElementId' value '"+e.markerElementId+"' - defaulting to internally-generated empty DIV"));var i=null;e.labelElementId&&((i=document.getElementById(e.labelElementId))||this.error("Can't find DOM element for 'labelElementId' value '"+e.labelElementId+"' - defaulting to internally-generated empty DIV"));const s=new Ry(this.viewer.scene,{id:e.id,plugin:this,container:this._container,markerElement:t,labelElement:i,markerHTML:e.markerHTML||this._markerHTML,labelHTML:e.labelHTML||this._labelHTML,occludable:e.occludable,values:y.apply(e.values,y.apply(this._values,{})),markerShown:e.markerShown,labelShown:e.labelShown,eye:e.eye,look:e.look,up:e.up,projection:e.projection,visible:!1!==e.visible});return e.pickResult=e.pickResult||e.pickRecord,e.pickResult?s.setFromPickResult(e.pickResult):(s.entity=e.entity,s.worldPos=e.worldPos),this.annotations[s.id]=s,s.on("destroyed",(()=>{delete this.annotations[s.id],this.fire("annotationDestroyed",s.id)})),this.fire("annotationCreated",s.id),s}destroyAnnotation(e){var t=this.annotations[e];t?t.destroy():this.log("Annotation not found: "+e)}clear(){const e=Object.keys(this.annotations);for(var t=0,i=e.length;t<i;t++)this.destroyAnnotation(e[t])}destroy(){this.clear(),super.destroy()}}class Ly extends ph{constructor(e,t){super("AxisGizmo",e,t=t||{});const i=e.scene.camera;t.canvasId||t.canvasElement||this.error("Config expected: either 'canvasId' or 'canvasElement'");try{this._axisGizmoScene=new Xu(e,{canvasId:t.canvasId,canvasElement:t.canvasElement,transparent:!0})}catch(e){return void this.error(e)}const s=this._axisGizmoScene;s.clearLights(),new Uc(s,{color:[.45,.45,.5],intensity:.9}),new kc(s,{dir:[-.5,.5,-.6],color:[.8,.8,.7],intensity:1,space:"view"}),new kc(s,{dir:[.5,-.5,-.6],color:[.8,.8,.8],intensity:1,space:"view"});const r=s.camera;i.on("matrix",(function(){const e=i.eye,t=i.look,s=i.up,o=d.mulVec3Scalar(d.normalizeVec3(d.subVec3(e,t,[])),22);r.look=[0,0,0],r.eye=o,r.up=s}));const o=new ve(s,Fe({radiusTop:.01,radiusBottom:.6,height:1.7,radialSegments:20,heightSegments:1,openEnded:!1})),n=new ve(s,Fe({radiusTop:.2,radiusBottom:.2,height:4.5,radialSegments:20,heightSegments:1,openEnded:!1})),a=new bs(s,{diffuse:[1,.3,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),l=new bs(s,{emissive:[1,.3,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),A=new bs(s,{diffuse:[.3,1,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),c=new bs(s,{emissive:[.3,1,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),h=new bs(s,{diffuse:[.3,.3,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),u=new bs(s,{emissive:[.3,.3,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),p=new bs(s,{diffuse:[.5,.5,.5],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2});this._meshes=[new fs(s,{geometry:new ve(s,De({radius:9,heightSegments:60,widthSegments:60})),material:new bs(s,{diffuse:[0,0,0],emissive:[.1,.1,.1],ambient:[.1,.1,.2],specular:[0,0,0],alpha:.4,alphaMode:"blend",frontface:"cw"}),pickable:!1,collidable:!1,visible:!1!==t.visible}),new fs(s,{geometry:new ve(s,De({radius:1})),material:p,pickable:!1,collidable:!1,visible:!1!==t.visible}),new fs(s,{geometry:o,material:a,pickable:!1,collidable:!1,visible:!1!==t.visible,position:[5,0,0],rotation:[0,0,-90]}),new fs(s,{geometry:n,material:a,pickable:!1,collidable:!1,visible:!1!==t.visible,position:[2,0,0],rotation:[0,0,90]}),new fs(s,{geometry:new ve(s,Ue({text:"X",size:1.5})),material:l,pickable:!1,collidable:!1,visible:!1!==t.visible,position:[7,0,0],billboard:"spherical"}),new fs(s,{geometry:o,material:A,pickable:!1,collidable:!1,visible:!1!==t.visible,position:[0,5,0]}),new fs(s,{geometry:n,material:A,pickable:!1,collidable:!1,visible:!1!==t.visible,position:[0,2,0]}),new fs(s,{geometry:new ve(s,Ue({text:"Y",size:1.5})),material:c,pickable:!1,collidable:!1,visible:!1!==t.visible,position:[0,7,0],billboard:"spherical"}),new fs(s,{geometry:o,material:h,pickable:!1,collidable:!1,visible:!1!==t.visible,position:[0,0,5],rotation:[90,0,0]}),new fs(s,{geometry:n,material:h,pickable:!1,collidable:!1,visible:!1!==t.visible,position:[0,0,2],rotation:[90,0,0]}),new fs(s,{geometry:new ve(s,Ue({text:"Z",size:1.5})),material:u,pickable:!1,collidable:!1,visible:!1!==t.visible,position:[0,0,7],billboard:"spherical"})]}setVisible(e){for(let t=0;t<this._meshes.length;t++)this._meshes[t].visible=e}destroy(){this._axisGizmoCanvas=null,this._axisGizmoScene.destroy(),this._axisGizmoScene=null,super.destroy()}}const ky=d.vec3(),Oy=d.vec3(),Ny=d.vec3(),Vy=d.vec3();class Qy extends ph{constructor(e,t={}){super("BCFViewpoints",e,t),this.originatingSystem=t.originatingSystem||"xeokit.io",this.authoringTool=t.authoringTool||"xeokit.io"}getViewpoint(e={}){const t=this.viewer.scene,i=t.camera,s=t.realWorldOffset,r=!0===e.reverseClippingPlanes;let o={},n=d.normalizeVec3(d.subVec3(i.look,i.eye,d.vec3())),a=i.eye,l=i.up;i.yUp&&(n=Gy(n),a=Gy(a),l=Gy(l));const A=Hy(d.addVec3(a,s));"ortho"===i.projection?o.orthogonal_camera={camera_view_point:A,camera_direction:Hy(n),camera_up_vector:Hy(l),view_to_world_scale:i.ortho.scale}:o.perspective_camera={camera_view_point:A,camera_direction:Hy(n),camera_up_vector:Hy(l),field_of_view:i.perspective.fov};const c=t.sectionPlanes;for(let e in c)if(c.hasOwnProperty(e)){let t=c[e];if(!t.active)continue;let n,a=t.pos;n=r?d.negateVec3(t.dir,d.vec3()):t.dir,i.yUp&&(a=Gy(a),n=Gy(n)),d.addVec3(a,s),a=Hy(a),n=Hy(n),o.clipping_planes||(o.clipping_planes=[]),o.clipping_planes.push({location:a,direction:n})}const h=t.lineSets;for(let e in h)if(h.hasOwnProperty(e)){const t=h[e];o.lines||(o.lines=[]);const i=t.positions,s=t.indices;for(let e=0,t=s.length/2;e<t;e++){const t=s[2*e],r=s[2*e+1];o.lines.push({start_point:{x:i[3*t+0],y:i[3*t+1],z:i[3*t+2]},end_point:{x:i[3*r+0],y:i[3*r+1],z:i[3*r+2]}})}}const u=t.bitmaps;for(let e in u)if(u.hasOwnProperty(e)){let t=u[e],r=t.pos,n=t.normal,a=t.up;i.yUp&&(r=Gy(r),n=Gy(n),a=Gy(a)),d.addVec3(r,s),o.bitmaps||(o.bitmaps=[]),o.bitmaps.push({bitmap_type:t.type,bitmap_data:t.imageData,location:Hy(r),normal:Hy(n),up:Hy(a),height:t.height})}o.components={visibility:{view_setup_hints:{spaces_visible:!!e.spacesVisible,space_boundaries_visible:!!e.spaceBoundariesVisible,openings_visible:!!e.openingsVisible,spaces_translucent:!!e.spaces_translucent,space_boundaries_translucent:!!e.space_boundaries_translucent,openings_translucent:!!e.openings_translucent}}};const p=new Set(t.opacityObjectIds),f=new Set(t.xrayedObjectIds),m=new Set(t.colorizedObjectIds),g=Object.values(t.objects).filter((e=>p.has(e.id)||m.has(e.id)||f.has(e.id))).reduce(((e,i)=>{let s,r=function(e){let t="";return t+=Math.round(255*e[0]).toString(16).padStart(2,"0"),t+=Math.round(255*e[1]).toString(16).padStart(2,"0"),t+=Math.round(255*e[2]).toString(16).padStart(2,"0"),t}(i.colorize);i.xrayed?(s=0===t.xrayMaterial.fillAlpha&&0!==t.xrayMaterial.edgeAlpha?.1:t.xrayMaterial.fillAlpha,s=Math.round(255*s).toString(16).padStart(2,"0"),r=s+r):p.has(i.id)&&(s=Math.round(255*i.opacity).toString(16).padStart(2,"0"),r=s+r),e[r]||(e[r]=[]);const o=i.id,n=i.originalSystemId,a={ifc_guid:n,originating_system:this.originatingSystem};return n!==o&&(a.authoring_tool_id=o),e[r].push(a),e}),{}),_=Object.entries(g).map((([e,t])=>({color:e,components:t})));o.components.coloring=_;const v=t.objectIds,b=t.visibleObjects,y=t.visibleObjectIds,w=v.filter((e=>!b[e])),B=t.selectedObjectIds;return e.defaultInvisible||y.length<w.length?(o.components.visibility.exceptions=this._createBCFComponents(y),o.components.visibility.default_visibility=!1):(o.components.visibility.exceptions=this._createBCFComponents(w),o.components.visibility.default_visibility=!0),o.components.selection=this._createBCFComponents(B),o.components.translucency=this._createBCFComponents(t.xrayedObjectIds),!1!==e.snapshot&&(o.snapshot={snapshot_type:"png",snapshot_data:this.viewer.getSnapshot({format:"png"})}),o}_createBCFComponents(e){const t=this.viewer.scene,i=[];for(let s=0,r=e.length;s<r;s++){const r=e[s],o=t.objects[r];if(o){const e={ifc_guid:o.originalSystemId,originating_system:this.originatingSystem};o.originalSystemId!==r&&(e.authoring_tool_id=r),i.push(e)}}return i}setViewpoint(e,t={}){if(!e)return;const i=this.viewer,s=i.scene,r=s.camera,o=!1!==t.rayCast,n=!1!==t.immediate,a=!1!==t.reset,l=s.realWorldOffset,A=!0===t.reverseClippingPlanes;if(s.clearSectionPlanes(),e.clipping_planes&&e.clipping_planes.length>0&&e.clipping_planes.forEach((function(e){let t=jy(e.location,ky),i=jy(e.direction,ky);A&&d.negateVec3(i),d.subVec3(t,l),r.yUp&&(t=zy(t),i=zy(i)),new ch(s,{pos:t,dir:i})})),s.clearLines(),e.lines&&e.lines.length>0){const t=[],i=[];let r=0;e.lines.forEach((e=>{e.start_point&&e.end_point&&(t.push(e.start_point.x),t.push(e.start_point.y),t.push(e.start_point.z),t.push(e.end_point.x),t.push(e.end_point.y),t.push(e.end_point.z),i.push(r++),i.push(r++))})),new Sc(s,{positions:t,indices:i,clippable:!1,collidable:!0})}if(s.clearBitmaps(),e.bitmaps&&e.bitmaps.length>0&&e.bitmaps.forEach((function(e){const t=e.bitmap_type||"jpg",i=e.bitmap_data;let o=jy(e.location,Oy),n=jy(e.normal,Ny),a=jy(e.up,Vy),l=e.height||1;t&&i&&o&&n&&a&&(r.yUp&&(o=zy(o),n=zy(n),a=zy(a)),new Ks(s,{src:i,type:t,pos:o,normal:n,up:a,clippable:!1,collidable:!0,height:l}))})),a&&(s.setObjectsXRayed(s.xrayedObjectIds,!1),s.setObjectsHighlighted(s.highlightedObjectIds,!1),s.setObjectsSelected(s.selectedObjectIds,!1)),e.components){if(e.components.visibility){e.components.visibility.default_visibility?(s.setObjectsVisible(s.objectIds,!0),e.components.visibility.exceptions&&e.components.visibility.exceptions.forEach((e=>this._withBCFComponent(t,e,(e=>e.visible=!1))))):(s.setObjectsVisible(s.objectIds,!1),e.components.visibility.exceptions&&e.components.visibility.exceptions.forEach((e=>this._withBCFComponent(t,e,(e=>e.visible=!0)))));const r=e.components.visibility.view_setup_hints;r&&(!1===r.spaces_visible&&s.setObjectsVisible(i.metaScene.getObjectIDsByType("IfcSpace"),!1),void 0!==r.spaces_translucent&&s.setObjectsXRayed(i.metaScene.getObjectIDsByType("IfcSpace"),!0),r.space_boundaries_visible,!1===r.openings_visible&&s.setObjectsVisible(i.metaScene.getObjectIDsByType("IfcOpening"),!0),r.space_boundaries_translucent,void 0!==r.openings_translucent&&s.setObjectsXRayed(i.metaScene.getObjectIDsByType("IfcOpening"),!0))}e.components.selection&&(s.setObjectsSelected(s.selectedObjectIds,!1),e.components.selection.forEach((e=>this._withBCFComponent(t,e,(e=>e.selected=!0))))),e.components.translucency&&(s.setObjectsXRayed(s.xrayedObjectIds,!1),e.components.translucency.forEach((e=>this._withBCFComponent(t,e,(e=>e.xrayed=!0))))),e.components.coloring&&(s.setObjectsColorized(s.colorizedObjectIds,null),e.components.coloring.forEach((e=>{let i=e.color,s=0,r=!1;8===i.length&&(s=parseInt(i.substring(0,2),16)/255,s<=1&&s>=.95&&(s=1),i=i.substring(2),r=!0);const o=[parseInt(i.substring(0,2),16)/255,parseInt(i.substring(2,4),16)/255,parseInt(i.substring(4,6),16)/255];e.components.map((e=>this._withBCFComponent(t,e,(e=>{e.colorize=o,r&&(e.opacity=s)}))))})))}if(e.perspective_camera||e.orthogonal_camera){let a,A,c,h;if(e.perspective_camera?(a=jy(e.perspective_camera.camera_view_point,ky),A=jy(e.perspective_camera.camera_direction,ky),c=jy(e.perspective_camera.camera_up_vector,ky),r.perspective.fov=e.perspective_camera.field_of_view,h="perspective"):(a=jy(e.orthogonal_camera.camera_view_point,ky),A=jy(e.orthogonal_camera.camera_direction,ky),c=jy(e.orthogonal_camera.camera_up_vector,ky),r.ortho.scale=e.orthogonal_camera.view_to_world_scale,h="ortho"),d.subVec3(a,l),r.yUp&&(a=zy(a),A=zy(A),c=zy(c)),o){const e=s.pick({pickSurface:!0,origin:a,direction:A});A=e?e.worldPos:d.addVec3(a,A,ky)}else A=d.addVec3(a,A,ky);n?(r.eye=a,r.look=A,r.up=c,r.projection=h):i.cameraFlight.flyTo({eye:a,look:A,up:c,duration:t.duration,projection:h})}}_withBCFComponent(e,t,i){const s=this.viewer,r=s.scene;if(t.authoring_tool_id&&t.originating_system===this.originatingSystem){const o=t.authoring_tool_id,n=r.objects[o];if(n)return void i(n);if(e.updateCompositeObjects){if(s.metaScene.metaObjects[o])return void r.withObjects(s.metaScene.getObjectIDsInSubtree(o),i)}}if(t.ifc_guid){const o=t.ifc_guid,n=r.objects[o];if(n)return void i(n);if(e.updateCompositeObjects){if(s.metaScene.metaObjects[o])return void r.withObjects(s.metaScene.getObjectIDsInSubtree(o),i)}Object.keys(r.models).forEach((t=>{const n=d.globalizeObjectId(t,o),a=r.objects[n];if(a)i(a);else if(e.updateCompositeObjects){s.metaScene.metaObjects[n]&&r.withObjects(s.metaScene.getObjectIDsInSubtree(n),i)}}))}}destroy(){super.destroy()}}function Hy(e){return{x:e[0],y:e[1],z:e[2]}}function jy(e,t){return(t=new Float64Array(3))[0]=e.x,t[1]=e.y,t[2]=e.z,t}function Gy(e){return new Float64Array([e[0],-e[2],e[1]])}function zy(e){return new Float64Array([e[0],e[2],-e[1]])}const Wy=d.vec3(),Xy=d.vec3(),Ky=d.vec3();d.vec4(),d.vec4(),d.vec4();class Zy extends R{constructor(e,t={}){const i=e.viewer.scene;super(i,t),this.plugin=e;const s=t.container;if(!s)throw"config missing: container";this._color=t.color||e.defaultColor;const r=function(e,t){const i=[];let s=void 0!==e?Boolean(e):t;return{reg:e=>i.push(e),get:()=>s,set:e=>{s=void 0!==e?Boolean(e):t,i.forEach((e=>e(s)))}}};this._visible=r(t.visible,e.defaultVisible),this._originVisible=r(t.originVisible,e.defaultOriginVisible),this._targetVisible=r(t.targetVisible,e.defaultTargetVisible),this._axisVisible=r(t.axisVisible,e.defaultAxisVisible),this._xAxisVisible=r(t.xAxisVisible,e.defaultAxisVisible),this._yAxisVisible=r(t.yAxisVisible,e.defaultAxisVisible),this._zAxisVisible=r(t.zAxisVisible,e.defaultAxisVisible),this._axisEnabled=r(!0,e.defaultAxisVisible),this._wireVisible=r(t.wireVisible,e.defaultWireVisible),this._xLabelEnabled=r(t.xLabelEnabled,e.defaultXLabelEnabled),this._yLabelEnabled=r(t.yLabelEnabled,e.defaultYLabelEnabled),this._zLabelEnabled=r(t.zLabelEnabled,e.defaultZLabelEnabled),this._lengthLabelEnabled=r(t.lengthLabelEnabled,e.defaultLengthLabelEnabled),this._labelsVisible=r(t.labelsVisible,e.defaultLabelsVisible),this._clickable=r(!1,!1),this._labelsOnWires=r(t.labelsOnWires,e.defaultLabelsOnWires),this._useRotationAdjustment=r(t.useRotationAdjustment,e.useRotationAdjustment),this._axesBasis=d.identityMat4(),this.approximate=t.approximate;const o=i.canvas.canvas,n=t.onMouseOver?e=>{t.onMouseOver(e,this),o.dispatchEvent(new MouseEvent("mouseover",e))}:null,a=t.onMouseLeave?e=>{t.onMouseLeave(e,this),o.dispatchEvent(new MouseEvent("mouseleave",e))}:null,l=t.onContextMenu?e=>{t.onContextMenu(e,this)}:null,A=e=>o.dispatchEvent(new MouseEvent("mousedown",e)),c=e=>o.dispatchEvent(new MouseEvent("mouseup",e)),h=e=>o.dispatchEvent(new MouseEvent("mousemove",e)),u=e=>o.dispatchEvent(new WheelEvent("wheel",e));this._cleanups=[],["units","scale"].forEach((e=>{const t=i.metrics.on("units",(()=>this._update()));this._cleanups.push((()=>i.metrics.off(t)))})),this._drawables=[];const p=(e,t)=>{const i=()=>e.setVisible(t.every((e=>e.get())));t.forEach((e=>e.reg(i))),this._drawables.push(e),this._cleanups.push((()=>e.destroy()))},f=(t,r,o)=>{const d=new oy(i,s,{color:t,thickness:r,thicknessClickable:6,zIndex:void 0!==e.zIndex?e.zIndex+1:void 0,onMouseOver:n,onMouseLeave:a,onMouseWheel:u,onMouseDown:A,onMouseUp:c,onMouseMove:h,onContextMenu:l});return p(d,o),{setEnds:(e,t)=>d.setEnds(e,t),setColor:e=>d.setColor(e)}};this._lengthWire=f(this._color,2,[this._visible,this._wireVisible]),this._xAxisWire=f("red",1,[this._visible,this._axisEnabled,this._axisVisible,this._xAxisVisible]),this._yAxisWire=f("green",1,[this._visible,this._axisEnabled,this._axisVisible,this._yAxisVisible]),this._zAxisWire=f("blue",1,[this._visible,this._axisEnabled,this._axisVisible,this._zAxisVisible]);const m=(t,r,o)=>{const d=new ry(i,s,{fillColor:t,zIndex:void 0!==e.zIndex?e.zIndex+r:void 0,onMouseOver:n,onMouseLeave:a,onMouseWheel:u,onMouseDown:A,onMouseUp:c,onMouseMove:h,onContextMenu:l});return p(d,o),{setFillColor:e=>d.setFillColor(e),setPosOnWire:(e,t,i,s)=>d.setPosOnWire(e,t,i,s),setPosBetween:(e,t,i)=>d.setPosBetween(e,t,i),setText:e=>d.setText(e.replace(/ /g,"&nbsp;"))}};this._lengthLabel=m(this._color,4,[this._visible,this._wireVisible,this._labelsVisible,this._clickable,this._axisEnabled,this._lengthLabelEnabled]),this._xAxisLabel=m("red",3,[this._visible,this._axisEnabled,this._axisVisible,this._xAxisVisible,this._labelsVisible,this._clickable,this._xLabelEnabled]),this._yAxisLabel=m("green",3,[this._visible,this._axisEnabled,this._axisVisible,this._yAxisVisible,this._labelsVisible,this._clickable,this._yLabelEnabled]),this._zAxisLabel=m("blue",3,[this._visible,this._axisEnabled,this._axisVisible,this._zAxisVisible,this._labelsVisible,this._clickable,this._zLabelEnabled]);const g=(t,r)=>{const o=new sy(i,t,s,{fillColor:this._color,zIndex:void 0!==e.zIndex?e.zIndex+2:void 0,onMouseOver:n,onMouseLeave:a,onMouseWheel:u,onMouseDown:A,onMouseUp:c,onMouseMove:h,onContextMenu:l});return o.on("worldPos",(()=>this._update())),p(o,r),o};this._originDot=g(t.origin,[this._visible,this._originVisible]),this._targetDot=g(t.target,[this._visible,this._targetVisible]),this._update()}_update(){if(!this._targetDot)return;const e=this._originDot.worldPos,t=this._targetDot.worldPos,i=this._axesBasis,s=d.subVec3(t,e,Wy),r=d.transformVec3(i,s,s),o=this._useRotationAdjustment.get()&&Math.abs(s[1])>0,n=(i,s)=>{const r=this.plugin.viewer.scene.metrics,n=r.scale,a=r.unitsInfo[r.units].abbrev,l=(i,s,r,o)=>{this._labelsOnWires.get()?i.setPosOnWire(s,r,0,this.plugin.labelMinAxisLength):i.setPosOnWire(e,t,35*o,0)},A=e=>(this._approximate?" ~ ":" = ")+e.toFixed(2)+a;this._xAxisWire.setEnds(e,i),l(this._xAxisLabel,e,i,1),this._xAxisLabel.setText("X"+A(d.distVec3(e,i)*n)),this._yAxisWire.setEnds(i,s),l(this._yAxisLabel,i,s,2),this._yAxisLabel.setText("Y"+A(d.distVec3(i,s)*n)),this._zAxisWire.setEnds(s,t),l(this._zAxisLabel,s,t,3),this._zAxisLabel.setText((o?"":"Z")+A(d.distVec3(s,t)*n)),this._lengthWire.setEnds(e,t),l(this._lengthLabel,e,t,0),this._length=d.distVec3(e,t)*n,this._lengthLabel.setText(A(this._length))};o?(Ky[0]=e[0],Ky[1]=t[1],Ky[2]=e[2],n(e,Ky)):(Xy[0]=e[0]+i[0]*r[0],Xy[1]=e[1]+i[4]*r[0],Xy[2]=e[2]+i[8]*r[0],Ky[0]=Xy[0]+i[1]*r[1],Ky[1]=Xy[1]+i[5]*r[1],Ky[2]=Xy[2]+i[9]*r[1],n(Xy,Ky))}set axesBasis(e){this._axesBasis.set(e),this._update()}get axesBasis(){return this._axesBasis}set approximate(e){e=!1!==e,this._approximate!==e&&(this._approximate=e,this._update())}get approximate(){return this._approximate}get origin(){return this._originDot}get target(){return this._targetDot}get length(){return this._length}get color(){return this._color}set color(e){this._color=e,this._originDot.setFillColor(e),this._targetDot.setFillColor(e),this._lengthWire.setColor(e),this._lengthLabel.setFillColor(e)}set visible(e){this._visible.set(e)}get visible(){return this._visible.get()}set originVisible(e){this._originVisible.set(e)}get originVisible(){return this._originVisible.get()}set targetVisible(e){this._targetVisible.set(e)}get targetVisible(){return this._targetVisible.get()}set useRotationAdjustment(e){this._useRotationAdjustment.set(e),this._update()}get useRotationAdjustment(){return this._useRotationAdjustment.get()}set axisEnabled(e){this._axisEnabled.set(e)}get axisEnabled(){return this._axisEnabled.get()}set axisVisible(e){this._axisVisible.set(e)}get axisVisible(){return this._axisVisible.get()}set xAxisVisible(e){this._xAxisVisible.set(e)}get xAxisVisible(){return this._xAxisVisible.get()}set yAxisVisible(e){this._yAxisVisible.set(e)}get yAxisVisible(){return this._yAxisVisible.get()}set zAxisVisible(e){this._zAxisVisible.set(e)}get zAxisVisible(){return this._zAxisVisible.get()}set wireVisible(e){this._wireVisible.set(e)}get wireVisible(){return this._wireVisible.get()}set labelsVisible(e){this._labelsVisible.set(e)}get labelsVisible(){return this._labelsVisible.get()}set xLabelEnabled(e){this._xLabelEnabled.set(e)}get xLabelEnabled(){return this._xLabelEnabled.get()}set yLabelEnabled(e){this._yLabelEnabled.set(e)}get yLabelEnabled(){return this._yLabelEnabled.get()}set zLabelEnabled(e){this._zLabelEnabled.set(e)}get zLabelEnabled(){return this._zLabelEnabled.get()}set lengthLabelEnabled(e){this._lengthLabelEnabled.set(e)}get lengthLabelEnabled(){return this._lengthLabelEnabled.get()}set labelsOnWires(e){this._labelsOnWires.set(e),this._update()}get labelsOnWires(){return this._labelsOnWires.get()}setHighlighted(e){this._drawables.forEach((t=>t.setHighlighted(e)))}set clickable(e){this._clickable.set(!!e),this._drawables.forEach((e=>e.setClickable(this._clickable.get())))}get clickable(){return this._clickable.get()}destroy(){this._cleanups.forEach((e=>e())),super.destroy()}}class Jy extends R{get active(){}set snapping(e){}get snapping(){return!0}activate(){}deactivate(){}reset(){}get currentMeasurement(){return null}destroy(){}}class Yy extends Jy{constructor(e,t={}){super(e.viewer.scene),this._canvasToPagePos=t.canvasToPagePos,this.pointerLens=t.pointerLens,this._active=!1,this._currentDistanceMeasurement=null,this._currentDistanceMeasurementInitState={wireVisible:null,axisVisible:null,xAxisVisible:null,yaxisVisible:null,zAxisVisible:null,targetVisible:null},this._initMarkerDiv(),this._snapping=!1!==t.snapping,this._mouseState=0,this._attachPlugin(e,t)}_initMarkerDiv(){const e=document.createElement("div"),t=this.scene.canvas.canvas;t.parentNode.insertBefore(e,t),e.style.background="black",e.style.border="2px solid blue",e.style.borderRadius="10px",e.style.width="5px",e.style.height="5px",e.style.top="-200px",e.style.left="-200px",e.style.margin="0 0",e.style.zIndex="100",e.style.position="absolute",e.style.pointerEvents="none",this._markerDiv=e}_destroyMarkerDiv(){this._markerDiv&&(this._markerDiv.parentNode.removeChild(this._markerDiv),this._markerDiv=null)}_attachPlugin(e,t={}){this.distanceMeasurementsPlugin=e,this.plugin=e}get active(){return this._active}set snapping(e){this._snapping=e}get snapping(){return this._snapping}activate(){if(this._active)return;this._markerDiv||this._initMarkerDiv(),this.fire("activated",!0);const e=this.distanceMeasurementsPlugin,t=this.scene,i=e.viewer.cameraControl,s=t.canvas.canvas;t.input;let r=!1;const o=d.vec3(),n=d.vec2();let a,l;let A=null;this._mouseState=0;const c=d.vec2(),h=e=>{const t=e.snappedCanvasPos||e.canvasPos;if(r=!0,o.set(e.worldPos),n.set(e.canvasPos),0===this._mouseState){if(this._canvasToPagePos)this._canvasToPagePos(s,t,c),this._markerDiv.style.left=c[0]-5+"px",this._markerDiv.style.top=c[1]-5+"px";else{const e=d.vec2(t);$b(s,this._markerDiv.parentNode,e),this._markerDiv.style.left=e[0]-5+"px",this._markerDiv.style.top=e[1]-5+"px"}this._markerDiv.style.background="pink",e.snappedToVertex||e.snappedToEdge?(this.pointerLens&&(this.pointerLens.visible=!0,this.pointerLens.canvasPos=e.canvasPos,this.pointerLens.snappedCanvasPos=e.snappedCanvasPos||e.canvasPos,this.pointerLens.snapped=!0),this._markerDiv.style.background="greenyellow",this._markerDiv.style.border="2px solid green"):(this.pointerLens&&(this.pointerLens.visible=!0,this.pointerLens.canvasPos=e.canvasPos,this.pointerLens.snappedCanvasPos=e.canvasPos,this.pointerLens.snapped=!1),this._markerDiv.style.background="pink",this._markerDiv.style.border="2px solid red"),A=e.entity}else this._markerDiv.style.left="-10000px",this._markerDiv.style.top="-10000px";s.style.cursor="pointer",this._currentDistanceMeasurement&&(this._currentDistanceMeasurement.wireVisible=this._currentDistanceMeasurementInitState.wireVisible,this._currentDistanceMeasurement.axisVisible=this._currentDistanceMeasurementInitState.axisVisible&&this.distanceMeasurementsPlugin.defaultAxisVisible,this._currentDistanceMeasurement.xAxisVisible=this._currentDistanceMeasurementInitState.xAxisVisible&&this.distanceMeasurementsPlugin.defaultXAxisVisible,this._currentDistanceMeasurement.yAxisVisible=this._currentDistanceMeasurementInitState.yAxisVisible&&this.distanceMeasurementsPlugin.defaultYAxisVisible,this._currentDistanceMeasurement.zAxisVisible=this._currentDistanceMeasurementInitState.zAxisVisible&&this.distanceMeasurementsPlugin.defaultZAxisVisible,this._currentDistanceMeasurement.targetVisible=this._currentDistanceMeasurementInitState.targetVisible,this._currentDistanceMeasurement.target.worldPos=o.slice(),this._markerDiv.style.left="-10000px",this._markerDiv.style.top="-10000px")};this._onHoverSnapOrSurface=i.on("hoverSnapOrSurface",(e=>{this._snapping&&h(e)})),this._onHoverSurface=i.on("hoverSurface",(e=>{this._snapping||h(e)})),s.addEventListener("mousedown",this._onMouseDown=e=>{1===e.which&&(a=e.clientX,l=e.clientY)}),s.addEventListener("mouseup",this._onMouseUp=t=>{1===t.which&&(t.clientX>a+20||t.clientX<a-20||t.clientY>l+20||t.clientY<l-20||(this._currentDistanceMeasurement?r?(this._currentDistanceMeasurement.target.entity=A,A=null,this._currentDistanceMeasurement.clickable=!0,this.distanceMeasurementsPlugin.fire("measurementEnd",this._currentDistanceMeasurement),this._currentDistanceMeasurement=null):(this._currentDistanceMeasurement.destroy(),this.distanceMeasurementsPlugin.fire("measurementCancel",this._currentDistanceMeasurement),this._currentDistanceMeasurement=null,A=null):r&&(this._currentDistanceMeasurement=e.createMeasurement({id:d.createUUID(),origin:{worldPos:o.slice(),entity:A},target:{worldPos:o.slice(),entity:A},approximate:!0}),this._currentDistanceMeasurementInitState.axisVisible=this._currentDistanceMeasurement.axisVisible&&this.distanceMeasurementsPlugin.defaultAxisVisible,this._currentDistanceMeasurementInitState.xAxisVisible=this._currentDistanceMeasurement.xAxisVisible&&this.distanceMeasurementsPlugin.defaultXAxisVisible,this._currentDistanceMeasurementInitState.yAxisVisible=this._currentDistanceMeasurement.yAxisVisible&&this.distanceMeasurementsPlugin.defaultYAxisVisible,this._currentDistanceMeasurementInitState.zAxisVisible=this._currentDistanceMeasurement.zAxisVisible&&this.distanceMeasurementsPlugin.defaultZAxisVisible,this._currentDistanceMeasurementInitState.wireVisible=this._currentDistanceMeasurement.wireVisible,this._currentDistanceMeasurementInitState.targetVisible=this._currentDistanceMeasurement.targetVisible,this._currentDistanceMeasurement.clickable=!1,this._currentDistanceMeasurement.origin.entity=A,A=null,this.distanceMeasurementsPlugin.fire("measurementStart",this._currentDistanceMeasurement))))});const u=e=>{this.pointerLens&&(this.pointerLens.visible=!0,this.pointerLens.canvasPos=e.canvasPos,this.pointerLens.snappedCanvasPos=e.snappedCanvasPos||e.canvasPos),r=!1,this._markerDiv.style.left="-100px",this._markerDiv.style.top="-100px",this._currentDistanceMeasurement&&(this._currentDistanceMeasurement.wireVisible=!1,this._currentDistanceMeasurement.targetVisible=!1,this._currentDistanceMeasurement.axisVisible=!1),s.style.cursor="default"};this._onHoverSnapOrSurfaceOff=i.on("hoverSnapOrSurfaceOff",(e=>{this._snapping&&u(e)})),this._onHoverOff=i.on("hoverOff",(e=>{this._snapping||u(e)})),this._active=!0}deactivate(){if(!this._active)return;this.fire("activated",!1),this.pointerLens&&(this.pointerLens.visible=!1),this.reset();const e=this.scene.canvas.canvas;e.removeEventListener("mousedown",this._onMouseDown),e.removeEventListener("mouseup",this._onMouseUp);const t=this.distanceMeasurementsPlugin.viewer.cameraControl;t.off(this._onHoverSnapOrSurface),t.off(this._onHoverSurface),t.off(this._onHoverSnapOrSurfaceOff),t.off(this._onHoverOff),this._active=!1}reset(){this._active&&(this._destroyMarkerDiv(),this._initMarkerDiv(),this._currentDistanceMeasurement&&(this.distanceMeasurementsPlugin.fire("measurementCancel",this._currentDistanceMeasurement),this._currentDistanceMeasurement.destroy(),this._currentDistanceMeasurement=null),this._mouseState=0)}get currentMeasurement(){return this._currentDistanceMeasurement}destroy(){this.deactivate(),super.destroy()}}class qy extends ph{constructor(e,t={}){super("DistanceMeasurements",e),this._pointerLens=t.pointerLens,this._container=t.container||document.body,this._defaultControl=null,this._measurements={},this.labelMinAxisLength=t.labelMinAxisLength,this.defaultVisible=!1!==t.defaultVisible,this.defaultOriginVisible=!1!==t.defaultOriginVisible,this.defaultTargetVisible=!1!==t.defaultTargetVisible,this.defaultWireVisible=!1!==t.defaultWireVisible,this.defaultXLabelEnabled=!1!==t.defaultXLabelEnabled,this.defaultYLabelEnabled=!1!==t.defaultYLabelEnabled,this.defaultZLabelEnabled=!1!==t.defaultZLabelEnabled,this.defaultLengthLabelEnabled=!1!==t.defaultLengthLabelEnabled,this.defaultLabelsVisible=!1!==t.defaultLabelsVisible,this.defaultAxisVisible=!1!==t.defaultAxisVisible,this.defaultXAxisVisible=!1!==t.defaultXAxisVisible,this.defaultYAxisVisible=!1!==t.defaultYAxisVisible,this.defaultZAxisVisible=!1!==t.defaultZAxisVisible,this.defaultColor=void 0!==t.defaultColor?t.defaultColor:"#00BBFF",this.zIndex=t.zIndex||1e4,this.defaultLabelsOnWires=!1!==t.defaultLabelsOnWires,this.useRotationAdjustment=void 0!==t.useRotationAdjustment&&!1!==t.useRotationAdjustment,this._onMouseOver=(e,t)=>{this.fire("mouseOver",{plugin:this,distanceMeasurement:t,measurement:t,event:e})},this._onMouseLeave=(e,t)=>{this.fire("mouseLeave",{plugin:this,distanceMeasurement:t,measurement:t,event:e})},this._onContextMenu=(e,t)=>{this.fire("contextMenu",{plugin:this,distanceMeasurement:t,measurement:t,event:e})}}getContainerElement(){return this._container}send(e,t){}get pointerLens(){return this._pointerLens}get control(){return this._defaultControl||(this._defaultControl=new Yy(this,{})),this._defaultControl}get measurements(){return this._measurements}set labelMinAxisLength(e){e<1&&(this.error("labelMinAxisLength must be >= 1; defaulting to 25"),e=25),this._labelMinAxisLength=e||25}get labelMinAxisLength(){return this._labelMinAxisLength}set useRotationAdjustment(e){e=void 0!==e&&Boolean(e),this._useRotationAdjustment=e}get useRotationAdjustment(){return this._useRotationAdjustment}createMeasurement(e={}){this.viewer.scene.components[e.id]&&(this.error("Viewer scene component with this ID already exists: "+e.id),delete e.id);const t=e.origin,i=e.target,s=new Zy(this,{id:e.id,plugin:this,container:this._container,origin:{entity:t.entity,worldPos:t.worldPos},target:{entity:i.entity,worldPos:i.worldPos},visible:e.visible,wireVisible:e.wireVisible,axisVisible:!1!==e.axisVisible&&!1!==this.defaultAxisVisible,xAxisVisible:!1!==e.xAxisVisible&&!1!==this.defaultXAxisVisible,yAxisVisible:!1!==e.yAxisVisible&&!1!==this.defaultYAxisVisible,zAxisVisible:!1!==e.zAxisVisible&&!1!==this.defaultZAxisVisible,xLabelEnabled:!1!==e.xLabelEnabled&&!1!==this.defaultXLabelEnabled,yLabelEnabled:!1!==e.yLabelEnabled&&!1!==this.defaultYLabelEnabled,zLabelEnabled:!1!==e.zLabelEnabled&&!1!==this.defaultZLabelEnabled,lengthLabelEnabled:!1!==e.lengthLabelEnabled&&!1!==this.defaultLengthLabelEnabled,labelsVisible:!1!==e.labelsVisible&&!1!==this.defaultLabelsVisible,useRotationAdjustment:this.useRotationAdjustment,originVisible:e.originVisible,targetVisible:e.targetVisible,color:e.color,labelsOnWires:!1!==e.labelsOnWires&&!1!==this.defaultLabelsOnWires,onMouseOver:this._onMouseOver,onMouseLeave:this._onMouseLeave,onContextMenu:this._onContextMenu});return this._measurements[s.id]=s,s.clickable=!0,s.on("destroyed",(()=>{delete this._measurements[s.id]})),this.fire("measurementCreated",s),s}destroyMeasurement(e){const t=this._measurements[e];t?(t.destroy(),this.fire("measurementDestroyed",t)):this.log("DistanceMeasurement not found: "+e)}setLabelsShown(e){for(const[t,i]of Object.entries(this.measurements))i.labelShown=e}setAxisVisible(e){for(const[t,i]of Object.entries(this.measurements))i.axisVisible=e;this.defaultAxisVisible=e}getAxisVisible(){return this.defaultAxisVisible}clear(){const e=Object.keys(this._measurements);for(var t=0,i=e.length;t<i;t++)this.destroyMeasurement(e[t])}destroy(){this.clear(),super.destroy()}}const $y=d.vec2();class ew extends Jy{constructor(e,t={}){super(e.viewer.scene),this.pointerLens=t.pointerLens,this.pointerCircle=new G(e.viewer),this._active=!1;const i=document.createElement("div"),s=this.scene.canvas.canvas;s.parentNode.insertBefore(i,s),i.style.background="black",i.style.border="2px solid blue",i.style.borderRadius="10px",i.style.width="5px",i.style.height="5px",i.style.margin="-200px -200px",i.style.zIndex="100",i.style.position="absolute",i.style.pointerEvents="none",this.markerDiv=i,this._currentDistanceMeasurement=null,this._currentDistanceMeasurementInitState={wireVisible:null,axisVisible:null,xAxisVisible:null,yaxisVisible:null,zAxisVisible:null,targetVisible:null},this._longTouchTimeoutMs=300,this._snapping=!1!==t.snapping,this._attachPlugin(e,t)}_attachPlugin(e){this.distanceMeasurementsPlugin=e,this.plugin=e}get active(){return this._active}set snapping(e){this._snapping=e}get snapping(){return this._snapping}activate(){if(this._active)return;const e=this.plugin,t=this.scene,i=t.canvas.canvas;e.pointerLens;const s=d.vec3(),r=20;let o=null;this._touchState=0;const n=d.vec2(),a=d.vec2(),l=d.vec2();let A=null;const c=()=>{this.plugin.viewer.cameraControl.active=!1},h=()=>{this.plugin.viewer.cameraControl.active=!0},u=()=>{o&&(clearTimeout(o),o=null),this._currentDistanceMeasurement&&(this._currentDistanceMeasurement.destroy(),this._currentDistanceMeasurement=null),h(),this._touchState=0},p=(e,t)=>(t[0]=e.clientX,t[1]=e.clientY,$b(i.ownerDocument.documentElement,i,t),t),f=(e,t)=>(t.set(e),$b(i,i.ownerDocument.documentElement,t),t);i.addEventListener("touchstart",this._onCanvasTouchStart=i=>{const l=i.touches.length;if(1!==l)return void(o&&(clearTimeout(o),o=null));const h=i.touches[0];switch(p(h,n),a.set(n),this._touchState){case 0:if(1!==l&&null!==o)return void u();const i=t.pick({canvasPos:a,snapping:this._snapping,snapToEdge:this._snapping});if(i&&i.snapped)s.set(i.worldPos),this.pointerCircle.start(f(i.snappedCanvasPos,$y));else{const e=t.pick({canvasPos:a,pickSurface:!0});if(!e||!e.worldPos)return;s.set(e.worldPos),this.pointerCircle.start(f(e.canvasPos,$y))}o=setTimeout((()=>{1!==l||a[0]>n[0]+r||a[0]<n[0]-r||a[1]>n[1]+r||a[1]<n[1]-r||(this.pointerLens&&(this.pointerLens.visible=!0,this.pointerLens.canvasPos=n,this.pointerLens.cursorPos=n),this.pointerLens&&(this.pointerLens.canvasPos=a,this.pointerLens.snapped=!1),this.pointerLens&&(this.pointerLens.cursorPos=i.canvasPos,this.pointerLens.snapped=!0),this._currentDistanceMeasurement?this._currentDistanceMeasurement.origin.worldPos=s:(this._currentDistanceMeasurement=e.createMeasurement({id:d.createUUID(),origin:{worldPos:s,entity:i.entity},target:{worldPos:s,entity:i.entity}}),this._currentDistanceMeasurement.labelsVisible=!1,this._currentDistanceMeasurement.xAxisVisible=!1,this._currentDistanceMeasurement.yAxisVisible=!1,this._currentDistanceMeasurement.zAxisVisible=!1,this._currentDistanceMeasurement.wireVisible=!1,this._currentDistanceMeasurement.originVisible=!0,this._currentDistanceMeasurement.targetVisible=!1,this._currentDistanceMeasurement.clickable=!1),this.distanceMeasurementsPlugin.fire("measurementStart",this._currentDistanceMeasurement),this._touchState=2,c())}),this._longTouchTimeoutMs),this._touchState=1,A=h.identifier;break;case 3:if(1!==l&&null!==o)return clearTimeout(o),void(o=null);1===l&&(o=setTimeout((()=>{if(o=null,1!==l||a[0]>n[0]+r||a[0]<n[0]-r||a[1]>n[1]+r||a[1]<n[1]-r)return;this.pointerLens&&(this.pointerLens.visible=!0,this.pointerLens.canvasPos=n,this.pointerLens.snapped=!1);const e=t.pick({canvasPos:a,snapToVertex:this._snapping,snapToEdge:this._snapping});if(e&&e.snapped)this.pointerLens&&(this.pointerLens.cursorPos=e.snappedCanvasPos,this.pointerLens.snapped=!0),this.pointerCircle.start(f(e.snappedCanvasPos,$y)),s.set(e.worldPos),this._currentDistanceMeasurement.target.worldPos=e.worldPos,this._currentDistanceMeasurement.target.entity=e.entity,this._currentDistanceMeasurement.targetVisible=!0,this._currentDistanceMeasurement.wireVisible=!0,this._currentDistanceMeasurement.labelsVisible=!0,this.distanceMeasurementsPlugin.fire("measurementStart",this._currentDistanceMeasurement);else{const e=t.pick({canvasPos:a,pickSurface:!0});e&&e.worldPos?(this.pointerLens&&(this.pointerLens.cursorPos=e.canvasPos,this.pointerLens.snapped=!1),this.pointerCircle.start(f(e.canvasPos,$y)),s.set(e.worldPos),this._currentDistanceMeasurement.target.worldPos=e.worldPos,this._currentDistanceMeasurement.target.entity=e.entity,this._currentDistanceMeasurement.targetVisible=!0,this._currentDistanceMeasurement.wireVisible=!0,this._currentDistanceMeasurement.labelsVisible=!0,this.distanceMeasurementsPlugin.fire("measurementStart",this._currentDistanceMeasurement)):this.pointerLens&&(this.pointerLens.cursorPos=null,this.pointerLens.snapped=!1)}this._touchState=5,c()}),this._longTouchTimeoutMs),this._touchState=4),A=h.identifier;break;default:return null!==o&&(clearTimeout(o),o=null),void(this._touchState=7)}},{passive:!0}),i.addEventListener("touchmove",(i=>{this.pointerCircle.stop();const r=i.touches.length;if(1!==r||1!==i.changedTouches.length)return void(o&&(clearTimeout(o),o=null));const n=i.touches[0];if(n.identifier!==A)return;let l,c;switch(p(n,a),this._touchState){case 2:this.pointerLens&&(this.pointerLens.canvasPos=a),l=t.pick({canvasPos:a,snapToVertex:this._snapping,snapToEdge:this._snapping}),l&&l.snapped?(this.pointerLens&&(this.pointerLens.snappedCanvasPos=l.snappedCanvasPos,this.pointerLens.snapped=!0),s.set(l.worldPos),this._currentDistanceMeasurement?this._currentDistanceMeasurement.origin.worldPos=l.worldPos:(this._currentDistanceMeasurement=e.createMeasurement({id:d.createUUID(),origin:{worldPos:l.worldPos,entity:l.entity},target:{worldPos:l.worldPos,entity:l.entity}}),this._currentDistanceMeasurement.labelsVisible=!1,this._currentDistanceMeasurement.xAxisVisible=!1,this._currentDistanceMeasurement.yAxisVisible=!1,this._currentDistanceMeasurement.zAxisVisible=!1,this._currentDistanceMeasurement.wireVisible=!1,this._currentDistanceMeasurement.originVisible=!0,this._currentDistanceMeasurement.targetVisible=!1,this._currentDistanceMeasurement.clickable=!1),this.distanceMeasurementsPlugin.fire("measurementStart",this._currentDistanceMeasurement)):(c=t.pick({canvasPos:a,pickSurface:!0}),c&&c.worldPos?(this.pointerLens&&(this.pointerLens.cursorPos=c.canvasPos,this.pointerLens.snapped=!1),s.set(c.worldPos),this._currentDistanceMeasurement?this._currentDistanceMeasurement.origin.worldPos=c.worldPos:(this._currentDistanceMeasurement=e.createMeasurement({id:d.createUUID(),origin:{worldPos:c.worldPos,entity:c.entity},target:{worldPos:c.worldPos,entity:c.entity}}),this._currentDistanceMeasurement.labelsVisible=!1,this._currentDistanceMeasurement.xAxisVisible=!1,this._currentDistanceMeasurement.yAxisVisible=!1,this._currentDistanceMeasurement.zAxisVisible=!1,this._currentDistanceMeasurement.wireVisible=!1,this._currentDistanceMeasurement.originVisible=!0,this._currentDistanceMeasurement.targetVisible=!1,this._currentDistanceMeasurement.clickable=!1),this.distanceMeasurementsPlugin.fire("measurementStart",this._currentDistanceMeasurement)):this.pointerLens&&(this.pointerLens.cursorPos=null,this.pointerLens.snapped=!1)),this._touchState=2;break;case 5:if(1!==r&&null!==o)return clearTimeout(o),o=null,this.pointerLens&&(this.pointerLens.visible=!1),void(this._touchState=7);this.pointerLens&&(this.pointerLens.canvasPos=a),l=t.pick({canvasPos:a,snapToVertex:this._snapping,snapToEdge:this._snapping}),l&&l.worldPos?(this.pointerLens&&(this.pointerLens.cursorPos=l.snappedCanvasPos,this.pointerLens.snapped=!0),this._currentDistanceMeasurement.target.worldPos=l.worldPos,this._currentDistanceMeasurement.target.entity=l.entity,this._currentDistanceMeasurement.targetVisible=!0,this._currentDistanceMeasurement.wireVisible=!0,this._currentDistanceMeasurement.labelsVisible=!0):(c=t.pick({canvasPos:a,pickSurface:!0}),c&&c.worldPos&&(this.pointerLens&&(this.pointerLens.cursorPos=c.canvasPos,this.pointerLens.snapped=!1),this._currentDistanceMeasurement.target.worldPos=c.worldPos,this._currentDistanceMeasurement.target.entity=c.entity,this._currentDistanceMeasurement.targetVisible=!0,this._currentDistanceMeasurement.wireVisible=!0,this._currentDistanceMeasurement.labelsVisible=!0)),this._touchState=5}}),{passive:!0}),i.addEventListener("touchend",this._onCanvasTouchEnd=i=>{this.pointerCircle.stop();const s=i.changedTouches.length;if(1!==s)return;const c=i.changedTouches[0];if(c.identifier!==A)return;o&&(clearTimeout(o),o=null),p(c,l);const u=l[0],f=l[1];switch(this._touchState){case 1:{if(1!==s||u>n[0]+r||u<n[0]-r||f>n[1]+r||f<n[1]-r)return void(this._touchState=0);const i=t.pick({canvasPos:a,pickSurface:!0});i&&i.worldPos?(this._currentDistanceMeasurement=e.createMeasurement({id:d.createUUID(),origin:{worldPos:i.worldPos,entity:i.entity},target:{worldPos:i.worldPos,entity:i.entity}}),this._currentDistanceMeasurement.labelsVisible=!1,this._currentDistanceMeasurement.xAxisVisible=!1,this._currentDistanceMeasurement.yAxisVisible=!1,this._currentDistanceMeasurement.zAxisVisible=!1,this._currentDistanceMeasurement.wireVisible=!1,this._currentDistanceMeasurement.originVisible=!0,this._currentDistanceMeasurement.targetVisible=!1,this._currentDistanceMeasurement.clickable=!1,this._touchState=3,this.distanceMeasurementsPlugin.fire("measurementStart",this._currentDistanceMeasurement)):(this._currentDistanceMeasurement&&this._currentDistanceMeasurement.destroy(),this._touchState=0)}h();break;case 2:this.pointerLens&&(this.pointerLens.visible=!1),this._currentDistanceMeasurement?this._touchState=3:(this.pointerLens&&(this.pointerLens.snapped=!1,this.pointerLens.visible=!1),this._touchState=0),h();break;case 4:{if(1!==s||u>n[0]+r||u<n[0]-r||f>n[1]+r||f<n[1]-r)return void(this._touchState=3);const e=t.pick({canvasPos:a,pickSurface:!0});e&&e.worldPos?(this._currentDistanceMeasurement.target.worldPos=e.worldPos,this._currentDistanceMeasurement.target.entity=e.entity,this._currentDistanceMeasurement.targetVisible=!0,this._currentDistanceMeasurement.wireVisible=!0,this._currentDistanceMeasurement.labelsVisible=!0,this._currentDistanceMeasurement.xAxisVisible=!0,this._currentDistanceMeasurement.yAxisVisible=!0,this._currentDistanceMeasurement.zAxisVisible=!0,this._currentDistanceMeasurement.clickable=!0,this.distanceMeasurementsPlugin.fire("measurementEnd",this._currentDistanceMeasurement),this._currentDistanceMeasurement=null):this._currentDistanceMeasurement&&(this._currentDistanceMeasurement.destroy(),this._currentDistanceMeasurement=null),this._touchState=0}h();break;case 5:console.log("long touch"),this.pointerLens&&(this.pointerLens.visible=!1),this._currentDistanceMeasurement&&this._currentDistanceMeasurement.targetVisible?(this._currentDistanceMeasurement.clickable=!0,this.distanceMeasurementsPlugin.fire("measurementEnd",this._currentDistanceMeasurement),this._currentDistanceMeasurement=null,this._touchState=0):(this._currentDistanceMeasurement&&(this._currentDistanceMeasurement.destroy(),this._currentDistanceMeasurement=null),this._touchState=0),h()}},{passive:!0}),this._active=!0}deactivate(){if(!this._active)return;this.plugin.pointerLens&&(this.plugin.pointerLens.visible=!1),this.reset();const e=this.plugin.viewer.scene.canvas.canvas;e.removeEventListener("touchstart",this._onCanvasTouchStart),e.removeEventListener("touchend",this._onCanvasTouchEnd),this._active=!1,this.plugin.viewer.cameraControl.active=!0}reset(){this._active&&this._currentDistanceMeasurement&&(this.distanceMeasurementsPlugin.fire("measurementCancel",this._currentDistanceMeasurement),this._currentDistanceMeasurement.destroy(),this._currentDistanceMeasurement=null)}get currentMeasurement(){return this._currentDistanceMeasurement}destroy(){this.deactivate(),super.destroy()}}class tw extends R{constructor(e,t,i,s){const r=e.plugin.viewer;super(r.scene);const o=Ay({viewer:r,handleMouseEvents:i,handleTouchEvents:s,pointerLens:t.pointerLens,dots:[e.origin,e.target],ray2WorldPos:(e,i,s)=>{const o=e=>{const t=r.scene.pick({canvasPos:s,snapToEdge:e,snapToVertex:e,pickSurface:!0});return t&&t.worldPos?t.worldPos:e&&o(!1)};return o(!!t.snapping)},onEnd:(e,t)=>{const i=!d.compareVec3(e,t.worldPos);return i&&this.fire("edited"),i}}),n=e.on("destroyed",o);this._deactivate=function(){e.off("destroyed",n),o()}}deactivate(){this._deactivate(),super.destroy()}}class iw extends tw{constructor(e,t){super(e,t,!0,!1)}}class sw extends tw{constructor(e,t){super(e,t,!1,!0)}}class rw extends ph{constructor(e,t={}){super("FastNav",e),this._hideColorTexture=!1!==t.hideColorTexture,this._hidePBR=!1!==t.hidePBR,this._hideSAO=!1!==t.hideSAO,this._hideEdges=!1!==t.hideEdges,this._hideTransparentObjects=!!t.hideTransparentObjects,this._scaleCanvasResolution=!!t.scaleCanvasResolution,this._defaultScaleCanvasResolutionFactor=t.defaultScaleCanvasResolutionFactor,this._scaleCanvasResolutionFactor=t.scaleCanvasResolutionFactor||.6,this._delayBeforeRestore=!1!==t.delayBeforeRestore,this._delayBeforeRestoreSeconds=t.delayBeforeRestoreSeconds||.5,this._onMoved=t.onMoved,this._onStopped=null;let i=1e3*this._delayBeforeRestoreSeconds,s=!1;const r=()=>{e.scene.canvas.resolutionScale=this._defaultScaleCanvasResolutionFactor||this._originalCanvasResolutionScale||1,e.scene._renderer.setEdgesEnabled(!0),e.scene._renderer.setColorTextureEnabled(!0),e.scene._renderer.setPBREnabled(!0),e.scene._renderer.setSAOEnabled(!0),e.scene._renderer.setTransparentEnabled(!0),this._onStopped&&this._onStopped(),s=!1};this._onCameraMatrix=e.scene.camera.on("matrix",(()=>{i=1e3*this._delayBeforeRestoreSeconds,s||(e.scene._renderer.setColorTextureEnabled(!this._hideColorTexture),e.scene._renderer.setPBREnabled(!this._hidePBR),e.scene._renderer.setSAOEnabled(!this._hideSAO),e.scene._renderer.setTransparentEnabled(!this._hideTransparentObjects),e.scene._renderer.setEdgesEnabled(!this._hideEdges),this._originalCanvasResolutionScale=e.scene.canvas.resolutionScale,this._scaleCanvasResolution?e.scene.canvas.resolutionScale=this._scaleCanvasResolutionFactor:e.scene.canvas.resolutionScale=this._defaultScaleCanvasResolutionFactor,this._onMoved&&(this._onStopped=this._onMoved()),s=!0)})),this._onSceneTick=e.scene.on("tick",(e=>{s&&(i-=e.deltaTime,(!this._delayBeforeRestore||i<=0)&&r())}))}get hideColorTexture(){return this._hideColorTexture}set hideColorTexture(e){this._hideColorTexture=e}get hidePBR(){return this._hidePBR}set hidePBR(e){this._hidePBR=e}get hideSAO(){return this._hideSAO}set hideSAO(e){this._hideSAO=e}get hideEdges(){return this._hideEdges}set hideEdges(e){this._hideEdges=e}get hideTransparentObjects(){return this._hideTransparentObjects}set hideTransparentObjects(e){this._hideTransparentObjects=!1!==e}get scaleCanvasResolution(){return this._scaleCanvasResolution}set scaleCanvasResolution(e){this._scaleCanvasResolution=e}get defaultScaleCanvasResolutionFactor(){return this._defaultScaleCanvasResolutionFactor}set defaultScaleCanvasResolutionFactor(e){this._defaultScaleCanvasResolutionFactor=e}get scaleCanvasResolutionFactor(){return this._scaleCanvasResolutionFactor}set scaleCanvasResolutionFactor(e){this._scaleCanvasResolutionFactor=e||.6}get delayBeforeRestore(){return this._delayBeforeRestore}set delayBeforeRestore(e){this._delayBeforeRestore=e}get delayBeforeRestoreSeconds(){return this._delayBeforeRestoreSeconds}set delayBeforeRestoreSeconds(e){this._delayBeforeRestoreSeconds=null!=e?e:.5}send(e,t){}destroy(){this.viewer.scene.camera.off(this._onCameraMatrix),this.viewer.scene.canvas.off(this._onCanvasBoundary),this.viewer.scene.input.off(this._onSceneMouseDown),this.viewer.scene.input.off(this._onSceneMouseUp),this.viewer.scene.input.off(this._onSceneMouseMove),this.viewer.scene.off(this._onSceneTick),super.destroy()}}class ow{constructor(e={}){this.cacheBuster=!1!==e.cacheBuster}_cacheBusterURL(e){if(!this.cacheBuster)return e;const t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}getMetaModel(e,t,i){y.loadJSON(this._cacheBusterURL(e),(e=>{t(e)}),(function(e){i(e)}))}getGLTF(e,t,i){y.loadArraybuffer(this._cacheBusterURL(e),(e=>{t(e)}),(function(e){i(e)}))}getGLB(e,t,i){y.loadArraybuffer(this._cacheBusterURL(e),(e=>{t(e)}),(function(e){i(e)}))}getArrayBuffer(e,t,i,s){!function(e,t,i,s){var r=()=>{};i=i||r,s=s||r;const o=/^data:(.*?)(;base64)?,(.*)$/,n=t.match(o);if(n){const e=!!n[2];var a=n[3];a=window.decodeURIComponent(a),e&&(a=window.atob(a));try{const e=new ArrayBuffer(a.length),t=new Uint8Array(e);for(var l=0;l<a.length;l++)t[l]=a.charCodeAt(l);I.scheduleTask((function(){i(e)}))}catch(e){I.scheduleTask((function(){s(e)}))}}else{const r=function(e){var t=e.lastIndexOf("/");return 0!==t?e.substring(0,t+1):""}(e),o=r+t,n=new XMLHttpRequest;n.open("GET",o,!0),n.responseType="arraybuffer",n.onreadystatechange=function(){4===n.readyState&&(200===n.status?i(n.response):s("loadArrayBuffer error : "+n.response))},n.send(null)}}(this._cacheBusterURL(e),t,(e=>{i(e)}),(function(e){s(e)}))}}async function nw(e,t,i,s){return s._parse(e,t,i,s)}function aw(e,t){if(!e)throw new Error(t||"loader assertion failed.")}const lw=Boolean("object"!=typeof process||"[object process]"!==String(process)||process.browser),Aw="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);Aw&&parseFloat(Aw[1]);const cw=globalThis,hw=globalThis.process||{};function uw(){return!("object"==typeof process&&"[object process]"===String(process)&&!process?.browser)||function(e){if("undefined"!=typeof window&&"renderer"===window.process?.type)return!0;if("undefined"!=typeof process&&Boolean(process.versions?.electron))return!0;const t="undefined"!=typeof navigator&&navigator.userAgent,i=e||t;return Boolean(i&&i.indexOf("Electron")>=0)}()}class dw{constructor(e,t,i="sessionStorage"){this.storage=function(e){try{const t=window[e],i="__storage_test__";return t.setItem(i,i),t.removeItem(i),t}catch(e){return null}}(i),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const e=JSON.stringify(this.config);this.storage.setItem(this.id,e)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}var pw;!function(e){e[e.BLACK=30]="BLACK",e[e.RED=31]="RED",e[e.GREEN=32]="GREEN",e[e.YELLOW=33]="YELLOW",e[e.BLUE=34]="BLUE",e[e.MAGENTA=35]="MAGENTA",e[e.CYAN=36]="CYAN",e[e.WHITE=37]="WHITE",e[e.BRIGHT_BLACK=90]="BRIGHT_BLACK",e[e.BRIGHT_RED=91]="BRIGHT_RED",e[e.BRIGHT_GREEN=92]="BRIGHT_GREEN",e[e.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",e[e.BRIGHT_BLUE=94]="BRIGHT_BLUE",e[e.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",e[e.BRIGHT_CYAN=96]="BRIGHT_CYAN",e[e.BRIGHT_WHITE=97]="BRIGHT_WHITE"}(pw||(pw={}));function fw(e){return"string"!=typeof e?e:(e=e.toUpperCase(),pw[e]||pw.WHITE)}function mw(e,t){if(!e)throw new Error(t||"Assertion failed")}function gw(){let e;if(uw()&&cw.performance)e=cw?.performance?.now?.();else if("hrtime"in hw){const t=hw?.hrtime?.();e=1e3*t[0]+t[1]/1e6}else e=Date.now();return e}const _w={debug:uw()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},vw={enabled:!0,level:0};function bw(){}const yw={},ww={once:!0};class Bw{constructor({id:e}={id:""}){this.VERSION="4.1.0",this._startTs=gw(),this._deltaTs=gw(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new dw(`__probe-${this.id}__`,vw),this.timeStamp(`${this.id} started`),function(e,t=["constructor"]){const i=Object.getPrototypeOf(e),s=Object.getOwnPropertyNames(i),r=e;for(const i of s){const s=r[i];"function"==typeof s&&(t.find((e=>i===e))||(r[i]=s.bind(e)))}}(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((gw()-this._startTs).toPrecision(10))}getDelta(){return Number((gw()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){if(!e)throw new Error(t||"Assertion failed")}warn(e){return this._getLogFunction(0,e,_w.warn,arguments,ww)}error(e){return this._getLogFunction(0,e,_w.error,arguments)}deprecated(e,t){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${t}\` instead`)}removed(e,t){return this.error(`\`${e}\` has been removed. Use \`${t}\` instead`)}probe(e,t){return this._getLogFunction(e,t,_w.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,_w.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,_w.debug||_w.info,arguments,ww)}table(e,t,i){return t?this._getLogFunction(e,t,console.table||bw,i&&[i],{tag:Cw(t)}):bw}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||bw)}group(e,t,i={collapsed:!1}){const s=xw({logLevel:e,message:t,opts:i}),{collapsed:r}=i;return s.method=(r?console.groupCollapsed:console.group)||console.info,this._getLogFunction(s)}groupCollapsed(e,t,i={}){return this.group(e,t,Object.assign({},i,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||bw)}withGroup(e,t,i){this.group(e,t)();try{i()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=Pw(e)}_getLogFunction(e,t,i,s,r){if(this._shouldLog(e)){r=xw({logLevel:e,message:t,args:s,opts:r}),mw(i=i||r.method),r.total=this.getTotal(),r.delta=this.getDelta(),this._deltaTs=gw();const o=r.tag||r.message;if(r.once&&o){if(yw[o])return bw;yw[o]=gw()}return t=function(e,t,i){if("string"==typeof t){const s=i.time?function(e,t=8){const i=Math.max(t-e.length,0);return`${" ".repeat(i)}${e}`}(function(e){let t;return t=e<10?`${e.toFixed(2)}ms`:e<100?`${e.toFixed(1)}ms`:e<1e3?`${e.toFixed(0)}ms`:`${(e/1e3).toFixed(2)}s`,t}(i.total)):"";t=i.time?`${e}: ${s}  ${t}`:`${e}: ${t}`,t=function(e,t,i){uw||"string"!=typeof e||(t&&(e=`[${fw(t)}m${e}[39m`),i&&(e=`[${fw(i)+10}m${e}[49m`));return e}(t,i.color,i.background)}return t}(this.id,r.message,r),i.bind(console,t,...r.args)}return bw}}function Pw(e){if(!e)return 0;let t;switch(typeof e){case"number":t=e;break;case"object":t=e.logLevel||e.priority||0;break;default:return 0}return mw(Number.isFinite(t)&&t>=0),t}function xw(e){const{logLevel:t,message:i}=e;e.logLevel=Pw(t);const s=e.args?Array.from(e.args):[];for(;s.length&&s.shift()!==i;);switch(typeof t){case"string":case"function":void 0!==i&&s.unshift(i),e.message=t;break;case"object":Object.assign(e,t)}"function"==typeof e.message&&(e.message=e.message());const r=typeof e.message;return mw("string"===r||"object"===r),Object.assign(e,{args:s},e.opts)}function Cw(e){for(const t in e)for(const i in e[t])return i||"untitled";return"empty"}Bw.VERSION="4.1.0";const Mw="4.3.2"[0]>="0"&&"4.3.2"[0]<="9"?"v4.3.2":"";const Ew=function(){const e=new Bw({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=e,globalThis.loaders.version=Mw,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=e,e}();function Fw(e,t){return Iw(e||{},t)}function Iw(e,t,i=0){if(i>3)return t;const s={...e};for(const[e,r]of Object.entries(t))r&&"object"==typeof r&&!Array.isArray(r)?s[e]=Iw(s[e]||{},t[e],i+1):s[e]=t[e];return s}const Tw=(globalThis._loadersgl_?.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.2"),globalThis._loadersgl_.version);function Dw(e,t){if(!e)throw new Error(t||"loaders.gl assertion failed.")}const Sw="object"!=typeof process||"[object process]"!==String(process)||process.browser,Rw="function"==typeof importScripts,Uw="undefined"!=typeof window&&void 0!==window.orientation,Lw="undefined"!=typeof process&&process.version&&/v([0-9]*)/.exec(process.version);Lw&&parseFloat(Lw[1]);class kw{name;workerThread;isRunning=!0;result;_resolve=()=>{};_reject=()=>{};constructor(e,t){this.name=e,this.workerThread=t,this.result=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){Dw(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){Dw(this.isRunning),this.isRunning=!1,this._reject(e)}}class Ow{terminate(){}}const Nw=new Map;function Vw(e){Dw(e.source&&!e.url||!e.source&&e.url);let t=Nw.get(e.source||e.url);return t||(e.url&&(t=function(e){if(!e.startsWith("http"))return e;return Qw((t=e,`try {\n  importScripts('${t}');\n} catch (error) {\n  console.error(error);\n  throw error;\n}`));var t}(e.url),Nw.set(e.url,t)),e.source&&(t=Qw(e.source),Nw.set(e.source,t))),Dw(t),t}function Qw(e){const t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}function Hw(e,t=!0,i){const s=i||new Set;if(e){if(jw(e))s.add(e);else if(jw(e.buffer))s.add(e.buffer);else if(ArrayBuffer.isView(e));else if(t&&"object"==typeof e)for(const i in e)Hw(e[i],t,s)}else;return void 0===i?Array.from(s):[]}function jw(e){return!!e&&(e instanceof ArrayBuffer||("undefined"!=typeof MessagePort&&e instanceof MessagePort||("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)))}const Gw=()=>{};class zw{name;source;url;terminated=!1;worker;onMessage;onError;_loadableURL="";static isSupported(){return"undefined"!=typeof Worker&&Sw||void 0!==Ow&&!Sw}constructor(e){const{name:t,source:i,url:s}=e;Dw(i||s),this.name=t,this.source=i,this.url=s,this.onMessage=Gw,this.onError=e=>console.log(e),this.worker=Sw?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=Gw,this.onError=Gw,this.worker.terminate(),this.terminated=!0}get isRunning(){return Boolean(this.onMessage)}postMessage(e,t){t=t||Hw(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),new Error(t)}_createBrowserWorker(){this._loadableURL=Vw({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(new Error("No data received"))},e.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},e.onmessageerror=e=>console.error(e),e}_createNodeWorker(){let e;if(this.url){const t=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new Ow(t,{eval:!1})}else{if(!this.source)throw new Error("no worker");e=new Ow(this.source,{eval:!0})}return e.on("message",(e=>{this.onMessage(e)})),e.on("error",(e=>{this.onError(e)})),e.on("exit",(e=>{})),e}}class Ww{name="unnamed";source;url;maxConcurrency=1;maxMobileConcurrency=1;onDebug=()=>{};reuseWorkers=!0;props={};jobQueue=[];idleQueue=[];count=0;isDestroyed=!1;static isSupported(){return zw.isSupported()}constructor(e){this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach((e=>e.destroy())),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},void 0!==e.name&&(this.name=e.name),void 0!==e.maxConcurrency&&(this.maxConcurrency=e.maxConcurrency),void 0!==e.maxMobileConcurrency&&(this.maxMobileConcurrency=e.maxMobileConcurrency),void 0!==e.reuseWorkers&&(this.reuseWorkers=e.reuseWorkers),void 0!==e.onDebug&&(this.onDebug=e.onDebug)}async startJob(e,t=((e,t,i)=>e.done(i)),i=((e,t)=>e.error(t))){const s=new Promise((s=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:s}),this)));return this._startQueuedJob(),await s}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const i=new kw(t.name,e);e.onMessage=e=>t.onMessage(i,e.type,e.payload),e.onError=e=>t.onError(i,e),t.onStart(i);try{await i.result}catch(e){console.error(`Worker exception: ${e}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!Sw||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new zw({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return Uw?this.maxMobileConcurrency:this.maxConcurrency}}const Xw={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class Kw{props;workerPools=new Map;static _workerFarm;static isSupported(){return zw.isSupported()}static getWorkerFarm(e={}){return Kw._workerFarm=Kw._workerFarm||new Kw({}),Kw._workerFarm.setProps(e),Kw._workerFarm}constructor(e){this.props={...Xw},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const e of this.workerPools.values())e.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:i,url:s}=e;let r=this.workerPools.get(t);return r||(r=new Ww({name:t,source:i,url:s}),r.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,r)),r}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}const Zw={};async function Jw(e,t=null,i={},s=null){return t&&(e=function(e,t,i={},s=null){if(!i.useLocalLibraries&&e.startsWith("http"))return e;s=s||e;const r=i.modules||{};if(r[s])return r[s];if(!Sw)return`modules/${t}/dist/libs/${s}`;if(i.CDN)return Dw(i.CDN.startsWith("http")),`${i.CDN}/${t}@${Tw}/dist/libs/${s}`;if(Rw)return`../src/libs/${s}`;return`modules/${t}/src/libs/${s}`}(e,t,i,s)),Zw[e]=Zw[e]||async function(e){if(e.endsWith("wasm"))return await async function(e){const{readFileAsArrayBuffer:t}=globalThis.loaders||{};if(Sw||!t||e.startsWith("http")){const t=await fetch(e);return await t.arrayBuffer()}return await t(e)}(e);if(!Sw)try{const{requireFromFile:t}=globalThis.loaders||{};return await(t?.(e))}catch(e){return console.error(e),null}if(Rw)return importScripts(e);return function(e,t){if(!Sw){const{requireFromString:i}=globalThis.loaders||{};return i?.(e,t)}if(Rw)return eval.call(globalThis,e),null;const i=document.createElement("script");i.id=t;try{i.appendChild(document.createTextNode(e))}catch(t){i.text=e}return document.body.appendChild(i),null}(await async function(e){const{readFileAsText:t}=globalThis.loaders||{};if(Sw||!t||e.startsWith("http")){const t=await fetch(e);return await t.text()}return await t(e)}(e),e)}(e),await Zw[e]}async function Yw(e,t,i,s,r){const o=e.id,n=function(e,t={}){const i=t[e.id]||{},s=Sw?`${e.id}-worker.js`:`${e.id}-worker-node.js`;let r=i.workerUrl;if(r||"compression"!==e.id||(r=t.workerUrl),"test"===t._workerType&&(r=Sw?`modules/${e.module}/dist/${s}`:`modules/${e.module}/src/workers/${e.id}-worker-node.ts`),!r){let t=e.version;"latest"===t&&(t="latest");const i=t?`@${t}`:"";r=`https://unpkg.com/@loaders.gl/${e.module}${i}/dist/${s}`}return Dw(r),r}(e,i),a=Kw.getWorkerFarm(i).getWorkerPool({name:o,url:n});i=JSON.parse(JSON.stringify(i)),s=JSON.parse(JSON.stringify(s||{}));const l=await a.startJob("process-on-worker",qw.bind(null,r));l.postMessage("process",{input:t,options:i,context:s});const A=await l.result;return await A.result}async function qw(e,t,i,s){switch(i){case"done":t.done(s);break;case"error":t.error(new Error(s.error));break;case"process":const{id:r,input:o,options:n}=s;try{const i=await e(o,n);t.postMessage("done",{id:r,result:i})}catch(e){const i=e instanceof Error?e.message:"unknown error";t.postMessage("error",{id:r,error:i})}break;default:console.warn(`parse-with-worker unknown message ${i}`)}}function $w(e,t,i){if(e.byteLength<=t+i)return"";const s=new DataView(e);let r="";for(let e=0;e<i;e++)r+=String.fromCharCode(s.getUint8(t+e));return r}function eB(e){try{return JSON.parse(e)}catch(t){throw new Error(`Failed to parse JSON from data starting with "${function(e,t=5){if("string"==typeof e)return e.slice(0,t);if(ArrayBuffer.isView(e))return $w(e.buffer,e.byteOffset,t);if(e instanceof ArrayBuffer)return $w(e,0,t);return""}(e)}"`)}}function tB(...e){return function(e){const t=e.map((e=>e instanceof ArrayBuffer?new Uint8Array(e):e)),i=t.reduce(((e,t)=>e+t.byteLength),0),s=new Uint8Array(i);let r=0;for(const e of t)s.set(e,r),r+=e.byteLength;return s.buffer}(e)}function iB(e,t,i){const s=void 0!==i?new Uint8Array(e).subarray(t,t+i):new Uint8Array(e).subarray(t);return new Uint8Array(s).buffer}function sB(e,t){return aw(e>=0),aw(t>0),e+(t-1)&~(t-1)}function rB(e,t,i){let s;if(e instanceof ArrayBuffer)s=new Uint8Array(e);else{const t=e.byteOffset,i=e.byteLength;s=new Uint8Array(e.buffer||e.arrayBuffer,t,i)}return t.set(s,i),i+sB(s.byteLength,4)}const oB={};function nB(e){if((t=e)&&"object"==typeof t&&t.isBuffer)return e;var t;if(e instanceof ArrayBuffer)return e;if(ArrayBuffer.isView(e))return 0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);if("string"==typeof e){const t=e;return(new TextEncoder).encode(t).buffer}if(e&&"object"==typeof e&&e._toArrayBuffer)return e._toArrayBuffer();throw new Error("toArrayBuffer")}function aB(e){const t=e?e.lastIndexOf("/"):-1;return t>=0?e.substr(t+1):""}const lB=e=>"function"==typeof e,AB=e=>null!==e&&"object"==typeof e,cB=e=>AB(e)&&e.constructor==={}.constructor,hB=e=>"undefined"!=typeof Response&&e instanceof Response||e&&e.arrayBuffer&&e.text&&e.json,uB=e=>"undefined"!=typeof Blob&&e instanceof Blob,dB=e=>(e=>"undefined"!=typeof ReadableStream&&e instanceof ReadableStream||AB(e)&&lB(e.tee)&&lB(e.cancel)&&lB(e.getReader))(e)||(e=>AB(e)&&lB(e.read)&&lB(e.pipe)&&(e=>"boolean"==typeof e)(e.readable))(e);class pB extends Error{constructor(e,t){super(e),this.reason=t.reason,this.url=t.url,this.response=t.response}reason;url;response}const fB=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,mB=/^([-\w.]+\/[-\w.+]+)/;function gB(e,t){return e.toLowerCase()===t.toLowerCase()}function _B(e){const t=fB.exec(e);return t?t[1]:""}const vB=/\?.*/;function bB(e){return e.replace(vB,"")}function yB(e){if(hB(e)){return e.url}if(uB(e)){return e.name||""}return"string"==typeof e?e:""}function wB(e){if(hB(e)){const t=e,i=t.headers.get("content-type")||"",s=bB(t.url);return function(e){const t=mB.exec(e);return t?t[1]:e}(i)||_B(s)}if(uB(e)){return e.type||""}return"string"==typeof e?_B(e):""}async function BB(e){if(hB(e))return e;const t={},i=function(e){if(hB(e))return e.headers["content-length"]||-1;if(uB(e))return e.size;return"string"==typeof e?e.length:e instanceof ArrayBuffer||ArrayBuffer.isView(e)?e.byteLength:-1}(e);i>=0&&(t["content-length"]=String(i));const s=yB(e),r=wB(e);r&&(t["content-type"]=r);const o=await async function(e){const t=5;if("string"==typeof e)return`data:,${e.slice(0,t)}`;if(e instanceof Blob){const t=e.slice(0,5);return await new Promise((e=>{const i=new FileReader;i.onload=t=>e(t?.target?.result),i.readAsDataURL(t)}))}if(e instanceof ArrayBuffer){const i=function(e){let t="";const i=new Uint8Array(e);for(let e=0;e<i.byteLength;e++)t+=String.fromCharCode(i[e]);return btoa(t)}(e.slice(0,t));return`data:base64,${i}`}return null}(e);o&&(t["x-first-bytes"]=o),"string"==typeof e&&(e=(new TextEncoder).encode(e));const n=new Response(e,{headers:t});return Object.defineProperty(n,"url",{value:s}),n}async function PB(e){if(!e.ok){const t=await async function(e){const t=function(e){if(e.length<50)return e;const t=e.slice(e.length-15);return`${e.substr(0,32)}...${t}`}(e.url);let i=`Failed to fetch resource (${e.status}) ${e.statusText}: ${t}`;i=i.length>100?`${i.slice(0,100)}...`:i;const s={reason:e.statusText,url:e.url,response:e};try{const t=e.headers.get("Content-Type");s.reason=!e.bodyUsed&&t?.includes("application/json")?await e.json():await e.text()}catch(e){}return new pB(i,s)}(e);throw t}}async function xB(e,t){if("string"==typeof e){const i=function(e){for(const t in oB)if(e.startsWith(t)){const i=oB[t];e=e.replace(t,i)}return e.startsWith("http://")||e.startsWith("https://")||(e=`${e}`),e}(e);return function(e){return!function(e){return e.startsWith("http:")||e.startsWith("https:")}(e)&&!function(e){return e.startsWith("data:")}(e)}(i)&&globalThis.loaders?.fetchNode?globalThis.loaders?.fetchNode(i,t):await fetch(i,t)}return await BB(e)}const CB=new Bw({id:"loaders.gl"});class MB{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}const EB={fetch:null,mimeType:void 0,nothrow:!1,log:new class{console;constructor(){this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}},useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:lw,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},FB={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function IB(){globalThis.loaders=globalThis.loaders||{};const{loaders:e}=globalThis;return e._state||(e._state={}),e._state}function TB(){const e=IB();return e.globalOptions=e.globalOptions||{...EB},e.globalOptions}function DB(e,t,i,s){return i=i||[],function(e,t){SB(e,null,EB,FB,t);for(const i of t){const s=e&&e[i.id]||{},r=i.options&&i.options[i.id]||{},o=i.deprecatedOptions&&i.deprecatedOptions[i.id]||{};SB(s,i.id,r,o,t)}}(e,i=Array.isArray(i)?i:[i]),function(e,t,i){const s={...e.options||{}};(function(e,t){t&&!("baseUri"in e)&&(e.baseUri=t)})(s,i),null===s.log&&(s.log=new MB);return UB(s,TB()),UB(s,t),s}(t,e,s)}function SB(e,t,i,s,r){const o=t||"Top level",n=t?`${t}.`:"";for(const a in e){const l=!t&&AB(e[a]),A="baseUri"===a&&!t,c="workerUrl"===a&&t;if(!(a in i)&&!A&&!c)if(a in s)CB.warn(`${o} loader option '${n}${a}' no longer supported, use '${s[a]}'`)();else if(!l){const e=RB(a,r);CB.warn(`${o} loader option '${n}${a}' not recognized. ${e}`)()}}}function RB(e,t){const i=e.toLowerCase();let s="";for(const r of t)for(const t in r.options){if(e===t)return`Did you mean '${r.id}.${t}'?`;const o=t.toLowerCase();(i.startsWith(o)||o.startsWith(i))&&(s=s||`Did you mean '${r.id}.${t}'?`)}return s}function UB(e,t){for(const i in t)if(i in t){const s=t[i];cB(s)&&cB(e[i])?e[i]={...e[i],...t[i]}:e[i]=t[i]}}function LB(e){if(!e)return!1;Array.isArray(e)&&(e=e[0]);return Array.isArray(e?.extensions)}function kB(e){let t;return aw(e,"null loader"),aw(LB(e),"invalid loader"),Array.isArray(e)&&(t=e[1],e=e[0],e={...e,options:{...e.options,...t}}),(e?.parseTextSync||e?.parseText)&&(e.text=!0),e.text||(e.binary=!0),e}function OB(){return(()=>{const e=IB();return e.loaderRegistry=e.loaderRegistry||[],e.loaderRegistry})()}const NB=/\.([^.]+)$/;function VB(e,t=[],i,s){if(!QB(e))return null;if(t&&!Array.isArray(t))return kB(t);let r=[];t&&(r=r.concat(t)),i?.ignoreRegisteredLoaders||r.push(...OB()),function(e){for(const t of e)kB(t)}(r);const o=function(e,t,i,s){const r=yB(e),o=wB(e),n=bB(r)||s?.url;let a=null,l="";i?.mimeType&&(a=jB(t,i?.mimeType),l=`match forced by supplied MIME type ${i?.mimeType}`);a=a||function(e,t){const i=t&&NB.exec(t),s=i&&i[1];return s?function(e,t){t=t.toLowerCase();for(const i of e)for(const e of i.extensions)if(e.toLowerCase()===t)return i;return null}(e,s):null}(t,n),l=l||(a?`matched url ${n}`:""),a=a||jB(t,o),l=l||(a?`matched MIME type ${o}`:""),a=a||function(e,t){if(!t)return null;for(const i of e)if("string"==typeof t){if(GB(t,i))return i}else if(ArrayBuffer.isView(t)){if(zB(t.buffer,t.byteOffset,i))return i}else if(t instanceof ArrayBuffer){if(zB(t,0,i))return i}return null}(t,e),l=l||(a?`matched initial data ${WB(e)}`:""),i?.fallbackMimeType&&(a=a||jB(t,i?.fallbackMimeType),l=l||(a?`matched fallback MIME type ${o}`:""));l&&Ew.log(1,`selectLoader selected ${a?.name}: ${l}.`);return a}(e,r,i,s);if(!o&&!i?.nothrow)throw new Error(HB(e));return o}function QB(e){return!(e instanceof Response&&204===e.status)}function HB(e){const t=yB(e),i=wB(e);let s="No valid loader found (";s+=t?`${aB(t)}, `:"no url provided, ",s+=`MIME type: ${i?`"${i}"`:"not provided"}, `;const r=e?WB(e):"";return s+=r?` first bytes: "${r}"`:"first bytes: not available",s+=")",s}function jB(e,t){for(const i of e){if(i.mimeTypes?.some((e=>gB(t,e))))return i;if(gB(t,`application/x.${i.id}`))return i}return null}function GB(e,t){if(t.testText)return t.testText(e);return(Array.isArray(t.tests)?t.tests:[t.tests]).some((t=>e.startsWith(t)))}function zB(e,t,i){return(Array.isArray(i.tests)?i.tests:[i.tests]).some((i=>function(e,t,i,s){if(s instanceof ArrayBuffer)return function(e,t,i){if(i=i||e.byteLength,e.byteLength<i||t.byteLength<i)return!1;const s=new Uint8Array(e),r=new Uint8Array(t);for(let e=0;e<s.length;++e)if(s[e]!==r[e])return!1;return!0}(s,e,s.byteLength);switch(typeof s){case"function":return s(e);case"string":return s===XB(e,t,s.length);default:return!1}}(e,t,0,i)))}function WB(e,t=5){if("string"==typeof e)return e.slice(0,t);if(ArrayBuffer.isView(e))return XB(e.buffer,e.byteOffset,t);if(e instanceof ArrayBuffer){return XB(e,0,t)}return""}function XB(e,t,i){if(e.byteLength<t+i)return"";const s=new DataView(e);let r="";for(let e=0;e<i;e++)r+=String.fromCharCode(s.getUint8(t+e));return r}const KB=262144;function ZB(e,t){return lw?async function*(e,t){const i=e.getReader();let s;try{for(;;){const e=s||i.read();t?._streamReadAhead&&(s=i.read());const{done:r,value:o}=await e;if(r)return;yield nB(o)}}catch(e){i.releaseLock()}}(e,t):async function*(e,t){for await(const t of e)yield nB(t)}(e)}function JB(e,t){if("string"==typeof e)return function*(e,t){const i=t?.chunkSize||262144;let s=0;const r=new TextEncoder;for(;s<e.length;){const t=Math.min(e.length-s,i),o=e.slice(s,s+t);s+=t,yield r.encode(o)}}(e,t);if(e instanceof ArrayBuffer)return function*(e,t={}){const{chunkSize:i=KB}=t;let s=0;for(;s<e.byteLength;){const t=Math.min(e.byteLength-s,i),r=new ArrayBuffer(t),o=new Uint8Array(e,s,t);new Uint8Array(r).set(o),s+=t,yield r}}(e,t);if(uB(e))return async function*(e,t){const i=t?.chunkSize||1048576;let s=0;for(;s<e.size;){const t=s+i,r=await e.slice(s,t).arrayBuffer();s=t,yield r}}(e,t);if(dB(e))return ZB(e,t);if(hB(e)){return ZB(e.body,t)}throw new Error("makeIterator")}const YB="Cannot convert supplied data type";async function qB(e,t,i){const s=e instanceof ArrayBuffer||ArrayBuffer.isView(e);if("string"==typeof e||s)return function(e,t,i){if(t.text&&"string"==typeof e)return e;var s;if((s=e)&&"object"==typeof s&&s.isBuffer&&(e=e.buffer),e instanceof ArrayBuffer){const i=e;return t.text&&!t.binary?new TextDecoder("utf8").decode(i):i}if(ArrayBuffer.isView(e)){if(t.text&&!t.binary)return new TextDecoder("utf8").decode(e);let i=e.buffer;const s=e.byteLength||e.length;return 0===e.byteOffset&&s===i.byteLength||(i=i.slice(e.byteOffset,e.byteOffset+s)),i}throw new Error(YB)}(e,t);if(uB(e)&&(e=await BB(e)),hB(e)){const i=e;return await PB(i),t.binary?await i.arrayBuffer():await i.text()}if(dB(e)&&(e=JB(e,i)),r=e,Boolean(r)&&"function"==typeof r[Symbol.iterator]||(e=>e&&"function"==typeof e[Symbol.asyncIterator])(e))return async function(e){const t=[];for await(const i of e)t.push(i);return tB(...t)}(e);var r;throw new Error(YB)}function $B(e,t){const i=TB(),s=e||i;return"function"==typeof s.fetch?s.fetch:AB(s.fetch)?e=>xB(e,s.fetch):t?.fetch?t?.fetch:xB}function eP(e,t,i){if(i)return i;const s={fetch:$B(t,e),...e};if(s.url){const e=bB(s.url);s.baseUrl=e,s.queryString=function(e){const t=e.match(vB);return t&&t[0]}(s.url),s.filename=aB(e),s.baseUrl=function(e){const t=e?e.lastIndexOf("/"):-1;return t>=0?e.substr(0,t):""}(e)}return Array.isArray(s.loaders)||(s.loaders=null),s}async function tP(e,t,i,s){!t||Array.isArray(t)||LB(t)||(s=void 0,i=t,t=void 0),i=i||{};const r=yB(e=await e),o=function(e,t){if(e&&!Array.isArray(e))return e;let i;if(e&&(i=Array.isArray(e)?e:[e]),t&&t.loaders){const e=Array.isArray(t.loaders)?t.loaders:[t.loaders];i=i?[...i,...e]:e}return i&&i.length?i:void 0}(t,s),n=await async function(e,t=[],i,s){if(!QB(e))return null;let r=VB(e,t,{...i,nothrow:!0},s);if(r)return r;if(uB(e)&&(r=VB(e=await e.slice(0,10).arrayBuffer(),t,i,s)),!r&&!i?.nothrow)throw new Error(HB(e));return r}(e,o,i);return n?(s=eP({url:r,_parse:tP,loaders:o},i=DB(i,n,o,r),s||null),await async function(e,t,i,s){if(function(e,t=Tw){Dw(e,"no worker provided");const i=e.version}(e),i=Fw(e.options,i),hB(t)){const e=t,{ok:i,redirected:r,status:o,statusText:n,type:a,url:l}=e,A=Object.fromEntries(e.headers.entries());s.response={headers:A,ok:i,redirected:r,status:o,statusText:n,type:a,url:l}}t=await qB(t,e,i);const r=e;if(r.parseTextSync&&"string"==typeof t)return r.parseTextSync(t,i,s);if(function(e,t){return!!Kw.isSupported()&&!(!Sw&&!t?._nodeWorkers)&&e.worker&&t?.worker}(e,i))return await Yw(e,t,i,s,tP);if(r.parseText&&"string"==typeof t)return await r.parseText(t,i,s);if(r.parse)return await r.parse(t,i,s);throw Dw(!r.parseSync),new Error(`${e.id} loader - no parser found and worker is disabled`)}(n,e,i,s)):null}function iP(e){let t=1/0,i=1/0,s=1/0,r=-1/0,o=-1/0,n=-1/0;const a=e.POSITION?e.POSITION.value:[],l=a&&a.length;for(let e=0;e<l;e+=3){const l=a[e],A=a[e+1],c=a[e+2];t=l<t?l:t,i=A<i?A:i,s=c<s?c:s,r=l>r?l:r,o=A>o?A:o,n=c>n?c:n}return[[t,i,s],[r,o,n]]}function sP(e,t={}){const i=function(e){const t=[];for(const i in e){const s=e[i];t.push(rP(i,s))}return t}(e);return{fields:i,metadata:t}}function rP(e,t,i){const s=function(e){switch(e.constructor){case Int8Array:return"int8";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int16Array:return"int16";case Uint16Array:return"uint16";case Int32Array:return"int32";case Uint32Array:return"uint32";case Float32Array:return"float32";case Float64Array:return"float64";default:return"null"}}(t.value),r=i||function(e){const t={};"byteOffset"in e&&(t.byteOffset=e.byteOffset.toString(10));"byteStride"in e&&(t.byteStride=e.byteStride.toString(10));"normalized"in e&&(t.normalized=e.normalized.toString());return t}(t);return{name:e,type:{type:"fixed-size-list",listSize:t.size,children:[{name:"value",type:s}]},nullable:!1,metadata:r}}const oP=globalThis.loaders?.parseImageNode,nP="undefined"!=typeof Image,aP="undefined"!=typeof ImageBitmap,lP=Boolean(oP),AP=!!lw||lP;function cP(e){const t=function(e){if("undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap)return"imagebitmap";if("undefined"!=typeof Image&&e instanceof Image)return"image";if(e&&"object"==typeof e&&e.data&&e.width&&e.height)return"data";return null}(e);if(!t)throw new Error("Not an image");return t}function hP(e){switch(cP(e)){case"data":return e;case"image":case"imagebitmap":const t=document.createElement("canvas"),i=t.getContext("2d");if(!i)throw new Error("getImageData");return t.width=e.width,t.height=e.height,i.drawImage(e,0,0),i.getImageData(0,0,e.width,e.height);default:throw new Error("getImageData")}}const uP=/^data:image\/svg\+xml/,dP=/\.svg((\?|#).*)?$/;function pP(e){return e&&(uP.test(e)||dP.test(e))}function fP(e,t){if(pP(t))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(e)])}async function mP(e,t,i){const s=function(e,t){if(pP(t)){let t=(new TextDecoder).decode(e);try{"function"==typeof unescape&&"function"==typeof encodeURIComponent&&(t=unescape(encodeURIComponent(t)))}catch(e){throw new Error(e.message)}return`data:image/svg+xml;base64,${btoa(t)}`}return fP(e,t)}(e,i),r=self.URL||self.webkitURL,o="string"!=typeof s&&r.createObjectURL(s);try{return await async function(e,t){const i=new Image;if(i.src=e,t.image&&t.image.decode&&i.decode)return await i.decode(),i;return await new Promise(((e,t)=>{try{i.onload=()=>e(i),i.onerror=e=>{const i=e instanceof Error?e.message:"error";t(new Error(i))}}catch(e){t(e)}}))}(o||s,t)}finally{o&&r.revokeObjectURL(o)}}const gP={};let _P=!0;async function vP(e,t,i){let s;if(pP(i)){s=await mP(e,t,i)}else s=fP(e,i);const r=t&&t.imagebitmap;return await async function(e,t=null){!function(e){for(const t in e||gP)return!1;return!0}(t)&&_P||(t=null);if(t)try{return await createImageBitmap(e,t)}catch(e){console.warn(e),_P=!1}return await createImageBitmap(e)}(s,r)}function bP(e){return function(e,t,i=0){const s=(r=t,[...r].map((e=>e.charCodeAt(0))));var r;for(let t=0;t<s.length;++t)if(s[t]!==e[t+i])return!1;return!0}(e,"ftyp",4)?0==(96&e[8])?null:function(e){switch((t=e,i=8,s=12,String.fromCharCode(...t.slice(i,s))).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}var t,i,s}(e):null}function yP(e){const t=wP(e);return function(e){const t=wP(e);if(!(t.byteLength>=24&&2303741511===t.getUint32(0,false)))return null;return{mimeType:"image/png",width:t.getUint32(16,false),height:t.getUint32(20,false)}}(t)||function(e){const t=wP(e);if(!(t.byteLength>=3&&65496===t.getUint16(0,false)&&255===t.getUint8(2)))return null;const{tableMarkers:i,sofMarkers:s}=function(){const e=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)e.add(t);const t=new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502]);return{tableMarkers:e,sofMarkers:t}}();let r=2;for(;r+9<t.byteLength;){const e=t.getUint16(r,false);if(s.has(e))return{mimeType:"image/jpeg",height:t.getUint16(r+5,false),width:t.getUint16(r+7,false)};if(!i.has(e))return null;r+=2,r+=t.getUint16(r,false)}return null}(t)||function(e){const t=wP(e);if(!(t.byteLength>=10&&1195984440===t.getUint32(0,false)))return null;return{mimeType:"image/gif",width:t.getUint16(6,true),height:t.getUint16(8,true)}}(t)||function(e){const t=wP(e);if(!(t.byteLength>=14&&16973===t.getUint16(0,false)&&t.getUint32(2,true)===t.byteLength))return null;return{mimeType:"image/bmp",width:t.getUint32(18,true),height:t.getUint32(22,true)}}(t)||function(e){const t=bP(new Uint8Array(e instanceof DataView?e.buffer:e));if(!t)return null;return{mimeType:t.mimeType,width:0,height:0}}(t)}function wP(e){if(e instanceof DataView)return e;if(ArrayBuffer.isView(e))return new DataView(e.buffer);if(e instanceof ArrayBuffer)return new DataView(e);throw new Error("toDataView")}const BP={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:"4.3.2",mimeTypes:["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],extensions:["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],parse:async function(e,t,i){const s=((t=t||{}).image||{}).type||"auto",{url:r}=i||{};let o;switch(function(e){switch(e){case"auto":case"data":return function(){if(aP)return"imagebitmap";if(nP)return"image";if(AP)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}();default:return function(e){switch(e){case"auto":return aP||nP||AP;case"imagebitmap":return aP;case"image":return nP;case"data":return AP;default:throw new Error(`@loaders.gl/images: image ${e} not supported in this environment`)}}(e),e}}(s)){case"imagebitmap":o=await vP(e,t,r);break;case"image":o=await mP(e,t,r);break;case"data":o=await async function(e,t){const{mimeType:i}=yP(e)||{},s=globalThis.loaders?.parseImageNode;return aw(s),await s(e,i)}(e);break;default:aw(!1)}return"data"===s&&(o=hP(o)),o},tests:[e=>Boolean(yP(new DataView(e)))],options:{image:{type:"auto",decode:!0}}},PP={};function xP(e){if(void 0===PP[e]){const t=lw?function(e){switch(e){case"image/avif":case"image/webp":return function(e){try{const t=document.createElement("canvas");return 0===t.toDataURL(e).indexOf(`data:${e}`)}catch{return!1}}(e);default:return!0}}(e):function(e){const t=["image/png","image/jpeg","image/gif"],i=globalThis.loaders?.imageFormatsNode||t,s=globalThis.loaders?.parseImageNode;return Boolean(s)&&i.includes(e)}(e);PP[e]=t}return PP[e]}function CP(e,t){if(!e)throw new Error(t||"assert failed: gltf")}const MP={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},EP={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},FP=["SCALAR","VEC2","VEC3","VEC4"],IP=[[Int8Array,5120],[Uint8Array,5121],[Int16Array,5122],[Uint16Array,5123],[Uint32Array,5125],[Float32Array,5126],[Float64Array,5130]],TP=new Map(IP),DP={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},SP={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},RP={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function UP(e){return FP[e-1]||FP[0]}function LP(e){const t=TP.get(e.constructor);if(!t)throw new Error("Illegal typed array");return t}function kP(e,t){const i=RP[e.componentType],s=DP[e.type],r=SP[e.componentType],o=e.count*s,n=e.count*s*r;CP(n>=0&&n<=t.byteLength);return{ArrayType:i,length:o,byteLength:n,componentByteSize:EP[e.componentType],numberOfComponentsInElement:MP[e.type]}}class OP{gltf;sourceBuffers;byteLength;constructor(e){this.gltf={json:e?.json||{asset:{version:"2.0",generator:"loaders.gl"},buffers:[],extensions:{},extensionsRequired:[],extensionsUsed:[]},buffers:e?.buffers||[],images:e?.images||[]},this.sourceBuffers=[],this.byteLength=0,this.gltf.buffers&&this.gltf.buffers[0]&&(this.byteLength=this.gltf.buffers[0].byteLength,this.sourceBuffers=[this.gltf.buffers[0]])}get json(){return this.gltf.json}getApplicationData(e){return this.json[e]}getExtraData(e){return(this.json.extras||{})[e]}hasExtension(e){const t=this.getUsedExtensions().find((t=>t===e)),i=this.getRequiredExtensions().find((t=>t===e));return"string"==typeof t||"string"==typeof i}getExtension(e){const t=this.getUsedExtensions().find((t=>t===e)),i=this.json.extensions||{};return t?i[e]:null}getRequiredExtension(e){const t=this.getRequiredExtensions().find((t=>t===e));return t?this.getExtension(e):null}getRequiredExtensions(){return this.json.extensionsRequired||[]}getUsedExtensions(){return this.json.extensionsUsed||[]}getRemovedExtensions(){return this.json.extensionsRemoved||[]}getObjectExtension(e,t){return(e.extensions||{})[t]}getScene(e){return this.getObject("scenes",e)}getNode(e){return this.getObject("nodes",e)}getSkin(e){return this.getObject("skins",e)}getMesh(e){return this.getObject("meshes",e)}getMaterial(e){return this.getObject("materials",e)}getAccessor(e){return this.getObject("accessors",e)}getTexture(e){return this.getObject("textures",e)}getSampler(e){return this.getObject("samplers",e)}getImage(e){return this.getObject("images",e)}getBufferView(e){return this.getObject("bufferViews",e)}getBuffer(e){return this.getObject("buffers",e)}getObject(e,t){if("object"==typeof t)return t;const i=this.json[e]&&this.json[e][t];if(!i)throw new Error(`glTF file error: Could not find ${e}[${t}]`);return i}getTypedArrayForBufferView(e){const t=(e=this.getBufferView(e)).buffer,i=this.gltf.buffers[t];CP(i);const s=(e.byteOffset||0)+i.byteOffset;return new Uint8Array(i.arrayBuffer,s,e.byteLength)}getTypedArrayForAccessor(e){const t=this.getAccessor(e);return function(e,t,i){const s="number"==typeof i?e.accessors?.[i]:i;if(!s)throw new Error(`No gltf accessor ${JSON.stringify(i)}`);const r=e.bufferViews?.[s.bufferView||0];if(!r)throw new Error(`No gltf buffer view for accessor ${r}`);const{arrayBuffer:o,byteOffset:n}=t[r.buffer],a=(n||0)+(s.byteOffset||0)+(r.byteOffset||0),{ArrayType:l,length:A,componentByteSize:c,numberOfComponentsInElement:h}=kP(s,r),u=c*h,d=r.byteStride||u;if(void 0===r.byteStride||r.byteStride===u)return new l(o,a,A);const p=new l(A);for(let e=0;e<s.count;e++){const t=new l(o,a+e*d,h);p.set(t,e*h)}return p}(this.gltf.json,this.gltf.buffers,t)}getTypedArrayForImageData(e){e=this.getAccessor(e);const t=this.getBufferView(e.bufferView),i=this.getBuffer(t.buffer).data,s=t.byteOffset||0;return new Uint8Array(i,s,t.byteLength)}addApplicationData(e,t){return this.json[e]=t,this}addExtraData(e,t){return this.json.extras=this.json.extras||{},this.json.extras[e]=t,this}addObjectExtension(e,t,i){return e.extensions=e.extensions||{},e.extensions[t]=i,this.registerUsedExtension(t),this}setObjectExtension(e,t,i){(e.extensions||{})[t]=i}removeObjectExtension(e,t){const i=e?.extensions||{};if(i[t]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];const e=this.json.extensionsRemoved;e.includes(t)||e.push(t)}delete i[t]}addExtension(e,t={}){return CP(t),this.json.extensions=this.json.extensions||{},this.json.extensions[e]=t,this.registerUsedExtension(e),t}addRequiredExtension(e,t={}){return CP(t),this.addExtension(e,t),this.registerRequiredExtension(e),t}registerUsedExtension(e){this.json.extensionsUsed=this.json.extensionsUsed||[],this.json.extensionsUsed.find((t=>t===e))||this.json.extensionsUsed.push(e)}registerRequiredExtension(e){this.registerUsedExtension(e),this.json.extensionsRequired=this.json.extensionsRequired||[],this.json.extensionsRequired.find((t=>t===e))||this.json.extensionsRequired.push(e)}removeExtension(e){if(this.json.extensions?.[e]){this.json.extensionsRemoved=this.json.extensionsRemoved||[];const t=this.json.extensionsRemoved;t.includes(e)||t.push(e)}this.json.extensions&&delete this.json.extensions[e],this.json.extensionsRequired&&this._removeStringFromArray(this.json.extensionsRequired,e),this.json.extensionsUsed&&this._removeStringFromArray(this.json.extensionsUsed,e)}setDefaultScene(e){this.json.scene=e}addScene(e){const{nodeIndices:t}=e;return this.json.scenes=this.json.scenes||[],this.json.scenes.push({nodes:t}),this.json.scenes.length-1}addNode(e){const{meshIndex:t,matrix:i}=e;this.json.nodes=this.json.nodes||[];const s={mesh:t};return i&&(s.matrix=i),this.json.nodes.push(s),this.json.nodes.length-1}addMesh(e){const{attributes:t,indices:i,material:s,mode:r=4}=e,o={primitives:[{attributes:this._addAttributes(t),mode:r}]};if(i){const e=this._addIndices(i);o.primitives[0].indices=e}return Number.isFinite(s)&&(o.primitives[0].material=s),this.json.meshes=this.json.meshes||[],this.json.meshes.push(o),this.json.meshes.length-1}addPointCloud(e){const t={primitives:[{attributes:this._addAttributes(e),mode:0}]};return this.json.meshes=this.json.meshes||[],this.json.meshes.push(t),this.json.meshes.length-1}addImage(e,t){const i=yP(e),s=t||i?.mimeType,r={bufferView:this.addBufferView(e),mimeType:s};return this.json.images=this.json.images||[],this.json.images.push(r),this.json.images.length-1}addBufferView(e,t=0,i=this.byteLength){const s=e.byteLength;CP(Number.isFinite(s)),this.sourceBuffers=this.sourceBuffers||[],this.sourceBuffers.push(e);const r={buffer:t,byteOffset:i,byteLength:s};return this.byteLength+=sB(s,4),this.json.bufferViews=this.json.bufferViews||[],this.json.bufferViews.push(r),this.json.bufferViews.length-1}addAccessor(e,t){const i={bufferView:e,type:UP(t.size),componentType:t.componentType,count:t.count,max:t.max,min:t.min};return this.json.accessors=this.json.accessors||[],this.json.accessors.push(i),this.json.accessors.length-1}addBinaryBuffer(e,t={size:3}){const i=this.addBufferView(e);let s={min:t.min,max:t.max};s.min&&s.max||(s=this._getAccessorMinMax(e,t.size));const r={size:t.size,componentType:LP(e),count:Math.round(e.length/t.size),min:s.min,max:s.max};return this.addAccessor(i,Object.assign(r,t))}addTexture(e){const{imageIndex:t}=e,i={source:t};return this.json.textures=this.json.textures||[],this.json.textures.push(i),this.json.textures.length-1}addMaterial(e){return this.json.materials=this.json.materials||[],this.json.materials.push(e),this.json.materials.length-1}createBinaryChunk(){const e=this.byteLength,t=new ArrayBuffer(e),i=new Uint8Array(t);let s=0;for(const e of this.sourceBuffers||[])s=rB(e,i,s);this.json?.buffers?.[0]?this.json.buffers[0].byteLength=e:this.json.buffers=[{byteLength:e}],this.gltf.binary=t,this.sourceBuffers=[t],this.gltf.buffers=[{arrayBuffer:t,byteOffset:0,byteLength:t.byteLength}]}_removeStringFromArray(e,t){let i=!0;for(;i;){const s=e.indexOf(t);s>-1?e.splice(s,1):i=!1}}_addAttributes(e={}){const t={};for(const i in e){const s=e[i],r=this._getGltfAttributeName(i),o=this.addBinaryBuffer(s.value,s);t[r]=o}return t}_addIndices(e){return this.addBinaryBuffer(e,{size:1})}_getGltfAttributeName(e){switch(e.toLowerCase()){case"position":case"positions":case"vertices":return"POSITION";case"normal":case"normals":return"NORMAL";case"color":case"colors":return"COLOR_0";case"texcoord":case"texcoords":return"TEXCOORD_0";default:return e}}_getAccessorMinMax(e,t){const i={min:null,max:null};if(e.length<t)return i;i.min=[],i.max=[];const s=e.subarray(0,t);for(const e of s)i.min.push(e),i.max.push(e);for(let s=t;s<e.length;s+=t)for(let r=0;r<t;r++)i.min[0+r]=Math.min(i.min[0+r],e[s+r]),i.max[0+r]=Math.max(i.max[0+r],e[s+r]);return i}}function NP(e){return(e%1+1)%1}const VP={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16,BOOLEAN:1,STRING:1,ENUM:1},QP={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:BigInt64Array,UINT64:BigUint64Array,FLOAT32:Float32Array,FLOAT64:Float64Array},HP={INT8:1,UINT8:1,INT16:2,UINT16:2,INT32:4,UINT32:4,INT64:8,UINT64:8,FLOAT32:4,FLOAT64:8};function jP(e,t){return HP[t]*VP[e]}function GP(e,t,i,s){if("UINT8"!==i&&"UINT16"!==i&&"UINT32"!==i&&"UINT64"!==i)return null;const r=zP(e.getTypedArrayForBufferView(t),"SCALAR",i,s+1);return r instanceof BigInt64Array||r instanceof BigUint64Array?null:r}function zP(e,t,i,s=1){const r=QP[i],o=HP[i],n=s*VP[t],a=n*o;let l=e.buffer,A=e.byteOffset;if(A%o!=0){l=new Uint8Array(l).slice(A,A+a).buffer,A=0}return new r(l,A,n)}function WP(e,t,i){const s=`TEXCOORD_${t.texCoord||0}`,r=i.attributes[s],o=e.getTypedArrayForAccessor(r),n=e.gltf.json,a=t.index,l=n.textures?.[a]?.source;if(void 0!==l){const i=n.images?.[l]?.mimeType,s=e.gltf.images?.[l];if(s&&void 0!==s.width){const e=[];for(let r=0;r<o.length;r+=2){const n=KP(s,i,o,r,t.channels);e.push(n)}return e}}return[]}function XP(e,t,i,s,r){if(!i?.length)return;const o=[];for(const e of i){let t=s.findIndex((t=>t===e));-1===t&&(t=s.push(e)-1),o.push(t)}const n=new Uint32Array(o),a=e.gltf.buffers.push({arrayBuffer:n.buffer,byteOffset:n.byteOffset,byteLength:n.byteLength})-1,l=e.addBufferView(n,a,0),A=e.addAccessor(l,{size:1,componentType:LP(n),count:n.length});r.attributes[t]=A}function KP(e,t,i,s,r=[0]){const o={r:{offset:0,shift:0},g:{offset:1,shift:8},b:{offset:2,shift:16},a:{offset:3,shift:24}},n=i[s],a=i[s+1];let l=1;!t||-1===t.indexOf("image/jpeg")&&-1===t.indexOf("image/png")||(l=4);const A=function(e,t,i,s=1){const r=i.width,o=NP(e)*(r-1),n=Math.round(o),a=i.height,l=NP(t)*(a-1),A=Math.round(l),c=i.components?i.components:s;return(A*r+n)*c}(n,a,e,l);let c=0;for(const t of r){const i="number"==typeof t?Object.values(o)[t]:o[t],s=A+i.offset,r=hP(e);if(r.data.length<=s)throw new Error(`${r.data.length} <= ${s}`);c|=r.data[s]<<i.shift}return c}function ZP(e,t,i,s,r){const o=[];for(let n=0;n<t;n++){const t=i[n],a=i[n+1]-i[n];if(a+t>s)break;const l=t/r,A=a/r;o.push(e.slice(l,l+A))}return o}function JP(e,t,i){const s=[];for(let r=0;r<t;r++){const t=r*i;s.push(e.slice(t,t+i))}return s}function YP(e,t,i,s){if(i)throw new Error("Not implemented - arrayOffsets for strings is specified");if(s){const i=[],r=new TextDecoder("utf8");let o=0;for(let n=0;n<e;n++){const e=s[n+1]-s[n];if(e+o<=t.length){const s=t.subarray(o,e+o),n=r.decode(s);i.push(n),o+=e}}return i}return[]}function qP(e,t,i){if(!i?.gltf?.loadBuffers)return;const s=t.extensions?.EXT_mesh_features,r=s?.featureIds;if(r)for(const s of r){let r;if(void 0!==s.attribute){const i=`_FEATURE_ID_${s.attribute}`,o=t.attributes[i];r=e.getTypedArrayForAccessor(o)}else r=void 0!==s.texture&&i?.gltf?.loadImages?WP(e,s.texture,t):[];s.data=r}}function $P(e,t){const i=t.extensions?.EXT_mesh_features;if(!i)return;const s=i.featureIds;s.forEach(((i,r)=>{if(i.data){const{accessorKey:o,index:n}=function(e){const t="_FEATURE_ID_",i=Object.keys(e).filter((e=>0===e.indexOf(t)));let s=-1;for(const e of i){const i=Number(e.substring(t.length));i>s&&(s=i)}s++;return{accessorKey:`${t}${s}`,index:s}}(t.attributes),a=new Uint32Array(i.data);s[r]={featureCount:a.length,propertyTable:i.propertyTable,attribute:n},e.gltf.buffers.push({arrayBuffer:a.buffer,byteOffset:a.byteOffset,byteLength:a.byteLength});const l=e.addBufferView(a),A=e.addAccessor(l,{size:1,componentType:LP(a),count:a.length});t.attributes[o]=A}}))}var ex=Object.freeze({__proto__:null,name:"EXT_mesh_features",decode:async function(e,t){!function(e,t){const i=e.gltf.json;if(!i.meshes)return;for(const s of i.meshes)for(const i of s.primitives)qP(e,i,t)}(new OP(e),t)},encode:function(e,t){const i=new OP(e);return function(e,t){const i=e.gltf.json.meshes;if(!i)return;for(const t of i)for(const i of t.primitives)$P(e,i)}(i),i.createBinaryChunk(),i.gltf},createExtMeshFeatures:function(e,t,i,s){t.extensions||(t.extensions={});let r=t.extensions.EXT_mesh_features;r||(r={featureIds:[]},t.extensions.EXT_mesh_features=r);const{featureIds:o}=r,n={featureCount:i.length,propertyTable:s,data:i};o.push(n),e.addObjectExtension(t,"EXT_mesh_features",r)}});function tx(e,t){for(const i of e)if(i.class===t)return i;return null}function ix(e,t,i,s){if(!t)return;const r=i.extensions?.EXT_structural_metadata,o=r?.propertyTextures;if(o)for(const r of o){sx(e,t[r],i,s)}}function sx(e,t,i,s){if(!t.properties)return;s.dataAttributeNames||(s.dataAttributeNames=[]);const r=t.class;for(const o in t.properties){const n=`${r}_${o}`,a=t.properties?.[o];if(!a)continue;a.data||(a.data=[]);const l=a.data,A=WP(e,a,i);null!==A&&(XP(e,n,A,l,i),a.data=l,s.dataAttributeNames.push(n))}}function rx(e,t,i){const s=t.classes?.[i.class];if(!s)throw new Error(`Incorrect data in the EXT_structural_metadata extension: no schema class with name ${i.class}`);const r=i.count;for(const o in s.properties){const n=s.properties[o],a=i.properties?.[o];if(a){const i=ox(e,t,n,r,a);a.data=i}}}function ox(e,t,i,s,r){let o=[];const n=r.values,a=e.getTypedArrayForBufferView(n),l=function(e,t,i,s){if(t.array&&void 0===t.count&&void 0!==i.arrayOffsets)return GP(e,i.arrayOffsets,i.arrayOffsetType||"UINT32",s);return null}(e,i,r,s),A=function(e,t,i){if(void 0!==t.stringOffsets)return GP(e,t.stringOffsets,t.stringOffsetType||"UINT32",i);return null}(e,r,s);switch(i.type){case"SCALAR":case"VEC2":case"VEC3":case"VEC4":case"MAT2":case"MAT3":case"MAT4":o=function(e,t,i,s){const r=e.array,o=e.count,n=jP(e.type,e.componentType),a=i.byteLength/n;let l;l=e.componentType?zP(i,e.type,e.componentType,a):i;if(r)return s?ZP(l,t,s,i.length,n):o?JP(l,t,o):[];return l}(i,s,a,l);break;case"BOOLEAN":throw new Error(`Not implemented - classProperty.type=${i.type}`);case"STRING":o=YP(s,a,l,A);break;case"ENUM":o=function(e,t,i,s,r){const o=t.enumType;if(!o)throw new Error("Incorrect data in the EXT_structural_metadata extension: classProperty.enumType is not set for type ENUM");const n=e.enums?.[o];if(!n)throw new Error(`Incorrect data in the EXT_structural_metadata extension: schema.enums does't contain ${o}`);const a=n.valueType||"UINT16",l=jP(t.type,a),A=s.byteLength/l;let c=zP(s,t.type,a,A);c||(c=s);if(t.array){if(r)return function(e){const{valuesData:t,numberOfElements:i,arrayOffsets:s,valuesDataBytesLength:r,elementSize:o,enumEntry:n}=e,a=[];for(let e=0;e<i;e++){const i=s[e],l=s[e+1]-s[e];if(l+i>r)break;const A=nx(t,i/o,l/o,n);a.push(A)}return a}({valuesData:c,numberOfElements:i,arrayOffsets:r,valuesDataBytesLength:s.length,elementSize:l,enumEntry:n});const e=t.count;return e?function(e,t,i,s){const r=[];for(let o=0;o<t;o++){const t=nx(e,i*o,i,s);r.push(t)}return r}(c,i,e,n):[]}return nx(c,0,i,n)}(t,i,s,a,l);break;default:throw new Error(`Unknown classProperty type ${i.type}`)}return o}function nx(e,t,i,s){const r=[];for(let o=0;o<i;o++)if(e instanceof BigInt64Array||e instanceof BigUint64Array)r.push("");else{const i=ax(s,e[t+o]);i?r.push(i.name):r.push("")}return r}function ax(e,t){for(const i of e.values)if(i.value===t)return i;return null}function lx(e,t,i){for(const s in e.properties){const r=e.properties[s].data;if(r){const o=t.properties[s];if(o){const t=Ax(r,o,i);e.properties[s]=t}}}}function Ax(e,t,i){const s={values:0};if("STRING"===t.type){const{stringData:t,stringOffsets:r}=function(e){const t=new TextEncoder,i=[];let s=0;for(const r of e){const e=t.encode(r);s+=e.length,i.push(e)}const r=new Uint8Array(s),o=[];let n=0;for(const e of i)r.set(e,n),o.push(n),n+=e.length;o.push(n);const a=new Uint32Array(o);return{stringData:r,stringOffsets:a}}(e);s.stringOffsets=hx(r,i),s.values=hx(t,i)}else if("SCALAR"===t.type&&t.componentType){const r=function(e,t){const i=[];for(const t of e)i.push(Number(t));const s=cx[t];if(!s)throw new Error("Illegal component type");return new s(i)}(e,t.componentType);s.values=hx(r,i)}return s}const cx={INT8:Int8Array,UINT8:Uint8Array,INT16:Int16Array,UINT16:Uint16Array,INT32:Int32Array,UINT32:Uint32Array,INT64:Int32Array,UINT64:Uint32Array,FLOAT32:Float32Array,FLOAT64:Float64Array};function hx(e,t){return t.gltf.buffers.push({arrayBuffer:e.buffer,byteOffset:e.byteOffset,byteLength:e.byteLength}),t.addBufferView(e)}var ux=Object.freeze({__proto__:null,name:"EXT_structural_metadata",decode:async function(e,t){!function(e,t){if(!t.gltf?.loadBuffers)return;const i=e.getExtension("EXT_structural_metadata");if(!i)return;t.gltf?.loadImages&&function(e,t){const i=t.propertyTextures,s=e.gltf.json;if(i&&s.meshes)for(const r of s.meshes)for(const s of r.primitives)ix(e,i,s,t)}(e,i);!function(e,t){const i=t.schema;if(!i)return;const s=i.classes,r=t.propertyTables;if(s&&r)for(const t in s){const s=tx(r,t);s&&rx(e,i,s)}}(e,i)}(new OP(e),t)},encode:function(e,t){const i=new OP(e);return function(e,t){const i=e.getExtension("EXT_structural_metadata");if(!i)return;if(i.propertyTables)for(const t of i.propertyTables){const s=t.class,r=i.schema?.classes?.[s];t.properties&&r&&lx(t,r,e)}}(i),i.createBinaryChunk(),i.gltf},createExtStructuralMetadata:function(e,t,i="schemaClassId"){let s=e.getExtension("EXT_structural_metadata");s||(s=e.addExtension("EXT_structural_metadata")),s.schema=function(e,t,i){const s=i??{id:"schema_id"},r={properties:{}};for(const t of e){const e={type:t.elementType,componentType:t.componentType};r.properties[t.name]=e}return s.classes={},s.classes[t]=r,s}(t,i,s.schema);const r=function(e,t,i){const s={class:t,count:0};let r=0;const o=i.classes?.[t];for(const t of e){if(0===r&&(r=t.values.length),r!==t.values.length&&t.values.length)throw new Error("Illegal values in attributes");const e=o?.properties[t.name];e&&(s.properties||(s.properties={}),s.properties[t.name]={values:0,data:t.values})}return s.count=r,s}(t,i,s.schema);return s.propertyTables||(s.propertyTables=[]),s.propertyTables.push(r)-1}});function dx(e,t){for(const i in e){const s=e[i];if(s.class===t)return s}return null}function px(e,t){for(const i in e){const s=e[i];if(s.class===t)return s}return null}function fx(e,t,i){if(!i.class)return;const s=t.classes?.[i.class];if(!s)throw new Error(`Incorrect data in the EXT_structural_metadata extension: no schema class with name ${i.class}`);const r=i.count;for(const o in s.properties){const n=s.properties[o],a=i.properties?.[o];if(a){const i=gx(e,t,n,r,a);a.data=i}}}function mx(e,t,i){const s=t.class;for(const r in i.properties){const i=t?.properties?.[r];if(i){const t=_x(e,i,s);i.data=t}}}function gx(e,t,i,s,r){let o=[];const n=r.bufferView,a=e.getTypedArrayForBufferView(n),l=function(e,t,i,s){if("ARRAY"===t.type&&void 0===t.componentCount&&void 0!==i.arrayOffsetBufferView)return GP(e,i.arrayOffsetBufferView,i.offsetType||"UINT32",s);return null}(e,i,r,s),A=function(e,t,i,s){if(void 0!==i.stringOffsetBufferView)return GP(e,i.stringOffsetBufferView,i.offsetType||"UINT32",s);return null}(e,0,r,s);return"STRING"===i.type||"STRING"===i.componentType?o=YP(s,a,l,A):function(e){const t=["UINT8","INT16","UINT16","INT32","UINT32","INT64","UINT64","FLOAT32","FLOAT64"];return t.includes(e.type)||void 0!==e.componentType&&t.includes(e.componentType)}(i)&&(o=function(e,t,i,s){const r="ARRAY"===e.type,o=e.componentCount,n="SCALAR",a=e.componentType||e.type,l=jP(n,a),A=i.byteLength/l,c=zP(i,n,a,A);if(r)return s?ZP(c,t,s,i.length,l):o?JP(c,t,o):[];return c}(i,s,a,l)),o}function _x(e,t,i){const s=e.gltf.json;if(!s.meshes)return[];const r=[];for(const o of s.meshes)for(const s of o.primitives)vx(e,i,t,r,s);return r}function vx(e,t,i,s,r){const o=WP(e,{channels:i.channels,...i.texture},r);o&&XP(e,t,o,s,r)}var bx=Object.freeze({__proto__:null,name:"EXT_feature_metadata",decode:async function(e,t){!function(e,t){if(!t.gltf?.loadBuffers)return;const i=e.getExtension("EXT_feature_metadata");if(!i)return;t.gltf?.loadImages&&function(e,t){const i=t.schema;if(!i)return;const s=i.classes,{featureTextures:r}=t;if(s&&r)for(const t in s){const i=s[t],o=px(r,t);o&&mx(e,o,i)}}(e,i);!function(e,t){const i=t.schema;if(!i)return;const s=i.classes,r=t.featureTables;if(s&&r)for(const t in s){const s=dx(r,t);s&&fx(e,i,s)}}(e,i)}(new OP(e),t)}});const yx="basis_transcoder.js",wx="basis_transcoder.wasm",Bx="basis_encoder.js",Px="basis_encoder.wasm";let xx,Cx;async function Mx(e){var t;t=e.modules,globalThis.loaders||={},globalThis.loaders.modules||={},Object.assign(globalThis.loaders.modules,t);const i=function(e){const t=globalThis.loaders?.modules?.[e];return t||null}("basis");return i||(xx||=async function(e){let t=null,i=null;return[t,i]=await Promise.all([await Jw(yx,"textures",e),await Jw(wx,"textures",e)]),t=t||globalThis.BASIS,await function(e,t){const i={};t&&(i.wasmBinary=t);return new Promise((t=>{e(i).then((e=>{const{BasisFile:i,initializeBasis:s}=e;s(),t({BasisFile:i})}))}))}(t,i)}(e),await xx)}async function Ex(e){const t=e.modules||{};return t.basisEncoder?t.basisEncoder:(Cx=Cx||async function(e){let t=null,i=null;return[t,i]=await Promise.all([await Jw(Bx,"textures",e),await Jw(Px,"textures",e)]),t=t||globalThis.BASIS,await function(e,t){const i={};t&&(i.wasmBinary=t);return new Promise((t=>{e(i).then((e=>{const{BasisFile:i,KTX2File:s,initializeBasis:r,BasisEncoder:o}=e;r(),t({BasisFile:i,KTX2File:s,BasisEncoder:o})}))}))}(t,i)}(e),await Cx)}const Fx=["","WEBKIT_","MOZ_"],Ix={WEBGL_compressed_texture_s3tc:"dxt",WEBGL_compressed_texture_s3tc_srgb:"dxt-srgb",WEBGL_compressed_texture_etc1:"etc1",WEBGL_compressed_texture_etc:"etc2",WEBGL_compressed_texture_pvrtc:"pvrtc",WEBGL_compressed_texture_atc:"atc",WEBGL_compressed_texture_astc:"astc",EXT_texture_compression_rgtc:"rgtc"};let Tx=null;function Dx(e){if(!Tx){e=e||function(){try{return document.createElement("canvas").getContext("webgl")}catch(e){return null}}()||void 0,Tx=new Set;for(const t of Fx)for(const i in Ix)if(e&&e.getExtension(`${t}${i}`)){const e=Ix[i];Tx.add(e)}}return Tx}const Sx=[171,75,84,88,32,50,48,187,13,10,26,10];const Rx={etc1:{basisFormat:0,compressed:!0,format:36196},etc2:{basisFormat:1,compressed:!0},bc1:{basisFormat:2,compressed:!0,format:33776},bc3:{basisFormat:3,compressed:!0,format:33779},bc4:{basisFormat:4,compressed:!0},bc5:{basisFormat:5,compressed:!0},"bc7-m6-opaque-only":{basisFormat:6,compressed:!0},"bc7-m5":{basisFormat:7,compressed:!0},"pvrtc1-4-rgb":{basisFormat:8,compressed:!0,format:35840},"pvrtc1-4-rgba":{basisFormat:9,compressed:!0,format:35842},"astc-4x4":{basisFormat:10,compressed:!0,format:37808},"atc-rgb":{basisFormat:11,compressed:!0},"atc-rgba-interpolated-alpha":{basisFormat:12,compressed:!0},rgba32:{basisFormat:13,compressed:!1},rgb565:{basisFormat:14,compressed:!1},bgr565:{basisFormat:15,compressed:!1},rgba4444:{basisFormat:16,compressed:!1}};function Ux(e,t,i){const s=new e(new Uint8Array(t));try{if(!s.startTranscoding())throw new Error("Failed to start basis transcoding");const e=s.getNumImages(),t=[];for(let r=0;r<e;r++){const e=s.getNumLevels(r),o=[];for(let t=0;t<e;t++)o.push(Lx(s,r,t,i));t.push(o)}return t}finally{s.close(),s.delete()}}function Lx(e,t,i,s){const r=e.getImageWidth(t,i),o=e.getImageHeight(t,i),n=e.getHasAlpha(),{compressed:a,format:l,basisFormat:A}=Nx(s,n),c=e.getImageTranscodedSizeInBytes(t,i,A),h=new Uint8Array(c);if(!e.transcodeImage(h,t,i,A,0,0))throw new Error("failed to start Basis transcoding");return{width:r,height:o,data:h,compressed:a,format:l,hasAlpha:n}}function kx(e,t,i){const s=new e(new Uint8Array(t));try{if(!s.startTranscoding())throw new Error("failed to start KTX2 transcoding");const e=s.getLevels(),t=[];for(let r=0;r<e;r++)t.push(Ox(s,r,i));return[t]}finally{s.close(),s.delete()}}function Ox(e,t,i){const{alphaFlag:s,height:r,width:o}=e.getImageLevelInfo(t,0,0),{compressed:n,format:a,basisFormat:l}=Nx(i,s),A=e.getImageTranscodedSizeInBytes(t,0,0,l),c=new Uint8Array(A);if(!e.transcodeImage(c,t,0,0,l,0,-1,-1))throw new Error("Failed to transcode KTX2 image");return{width:o,height:r,data:c,compressed:n,levelSize:A,hasAlpha:s,format:a}}function Nx(e,t){let i=e&&e.basis&&e.basis.format;return"auto"===i&&(i=Vx()),"object"==typeof i&&(i=t?i.alpha:i.noAlpha),i=i.toLowerCase(),Rx[i]}function Vx(){const e=Dx();return e.has("astc")?"astc-4x4":e.has("dxt")?{alpha:"bc3",noAlpha:"bc1"}:e.has("pvrtc")?{alpha:"pvrtc1-4-rgba",noAlpha:"pvrtc1-4-rgb"}:e.has("etc1")?"etc1":e.has("etc2")?"etc2":"rgb565"}const Qx={...{dataType:null,batchType:null,name:"Basis",id:"basis",module:"textures",version:"4.3.2",worker:!0,extensions:["basis","ktx2"],mimeTypes:["application/octet-stream","image/ktx2"],tests:["sB"],binary:!0,options:{basis:{format:"auto",libraryPath:"libs/",containerFormat:"auto",module:"transcoder"}}},parse:async function(e,t){if("auto"===t.basis.containerFormat){if(function(e){const t=new Uint8Array(e);return!(t.byteLength<Sx.length||t[0]!==Sx[0]||t[1]!==Sx[1]||t[2]!==Sx[2]||t[3]!==Sx[3]||t[4]!==Sx[4]||t[5]!==Sx[5]||t[6]!==Sx[6]||t[7]!==Sx[7]||t[8]!==Sx[8]||t[9]!==Sx[9]||t[10]!==Sx[10]||t[11]!==Sx[11])}(e)){return kx((await Ex(t)).KTX2File,e,t)}const{BasisFile:i}=await Mx(t);return Ux(i,e,t)}if("encoder"===t.basis.module){const i=await Ex(t);return"ktx2"===t.basis.containerFormat?kx(i.KTX2File,e,t):Ux(i.BasisFile,e,t)}{const{BasisFile:i}=await Mx(t);return Ux(i,e,t)}}},Hx=1735152710;function jx(e,t,i=0,s={}){const r=new DataView(t),o=function(e,t=0){return`${String.fromCharCode(e.getUint8(t+0))}${String.fromCharCode(e.getUint8(t+1))}${String.fromCharCode(e.getUint8(t+2))}${String.fromCharCode(e.getUint8(t+3))}`}(r,i+0),n=r.getUint32(i+4,true),a=r.getUint32(i+8,true);switch(Object.assign(e,{header:{byteOffset:i,byteLength:a,hasBinChunk:!1},type:o,version:n,json:{},binChunks:[]}),i+=12,e.version){case 1:return function(e,t,i){aw(e.header.byteLength>20);const s=t.getUint32(i+0,true),r=t.getUint32(i+4,true);return i+=8,aw(0===r),Gx(e,t,i,s),i+=s,i+=zx(e,t,i,e.header.byteLength)}(e,r,i);case 2:return function(e,t,i,s){return aw(e.header.byteLength>20),function(e,t,i,s){for(;i+8<=e.header.byteLength;){const r=t.getUint32(i+0,true),o=t.getUint32(i+4,true);switch(i+=8,o){case 1313821514:Gx(e,t,i,r);break;case 5130562:zx(e,t,i,r);break;case 0:s.strict||Gx(e,t,i,r);break;case 1:s.strict||zx(e,t,i,r)}i+=sB(r,4)}}(e,t,i,s),i+e.header.byteLength}(e,r,i,{});default:throw new Error(`Invalid GLB version ${e.version}. Only supports version 1 and 2.`)}}function Gx(e,t,i,s){const r=new Uint8Array(t.buffer,i,s),o=new TextDecoder("utf8").decode(r);return e.json=JSON.parse(o),sB(s,4)}function zx(e,t,i,s){return e.header.hasBinChunk=!0,e.binChunks.push({byteOffset:i,byteLength:s,arrayBuffer:t.buffer}),sB(s,4)}function Wx(e,t){if(e.startsWith("data:")||e.startsWith("http:")||e.startsWith("https:"))return e;const i=t.baseUri||t.uri;if(!i)throw new Error(`'baseUri' must be provided to resolve relative url ${e}`);return i.substr(0,i.lastIndexOf("/")+1)+e}const Xx="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",Kx="B9h9z9tFBBBF8dL9gBB9gLaaaaaFa9gEaaaB9gGaaB9gFaFaEQSBBFBFFGEGEGIILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBNn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBcI9z9iqlBMc/j9JSIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMkRIbaG97FaK978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAnDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAnDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAnDeBJAeCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPD8dBhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBAeCx+YUUBJDBBBHnAnDQBBBBBBBBBBBBBBBBAPD8dFhUg/8/4/w/goB9+h84k7HeCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAnDeBJAeCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBRnCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBHiCFD9tAiAPD9OD9hD9RHiDQBTFtGmEYIPLdKeOnH8ZAIAQJDBIBHpCFD9tApAPD9OD9hD9RHpAIASJDBIBHyCFD9tAyAPD9OD9hD9RHyDQBTFtGmEYIPLdKeOnH8cDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAnD9uHnDyBjGBAEAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnA8ZA8cDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNiV8ZcpMyS8cQ8df8eb8fHdApAyDQNiV8ZcpMyS8cQ8df8eb8fHiDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJHIAnAdAiDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHnDyBjGBAIAGJHIAnAPAPDQILKOILKOILKOILKOD9uHnDyBjGBAIAGJHIAnAPAPDQNVcMNVcMNVcMNVcMD9uHnDyBjGBAIAGJHIAnAPAPDQSQfbSQfbSQfbSQfbD9uHnDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/xLGEaK978jUUUUBCAlHE8kUUUUBGXGXAGCI9HQBGXAFC98ZHI9FQBABRGCBRLEXAGAGDBBBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMBBAGCTJRGALCIJHLAI9JQBMMAIAF9PQFAEAFCEZHLCGWHGqCBCTAGl/8MBAEABAICGWJHIAG/8cBBGXAL9FQBAEAEDBIBHKCiD+rFCiD+sFD/6FHOAKCND+rFCiD+sFD/6FAOD/gFAKCTD+rFCiD+sFD/6FHND/gFD/kFD/lFHVCBDtD+2FHcAOCUUUU94DtHMD9OD9RD/kFHO9DBB/+hDYAOAOD/mFAVAVD/mFANAcANAMD9OD9RD/kFHOAOD/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHcD/kFCgFDtD9OAKCUUU94DtD9OD9QAOAND/mFAcD/kFCND+rFCU/+EDtD9OD9QAVAND/mFAcD/kFCTD+rFCUU/8ODtD9OD9QDMIBMAIAEAG/8cBBSFMABAFC98ZHGT+HUUUBAGAF9PQBAEAFCEZHICEWHLJCBCAALl/8MBAEABAGCEWJHGAL/8cBBAEAIT+HUUUBAGAEAL/8cBBMAECAJ8kUUUUBM+yEGGaO97GXAF9FQBCBRGEXABCTJHEAEDBBBHICBDtHLCUU98D8cFCUU98D8cEHKD9OABDBBBHOAIDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAOAIDQBFGENVcMTtmYi8ZpyHICTD+sFD/6FHND/gFAICTD+rFCTD+sFD/6FHVD/gFD/kFD/lFHI9DB/+g6DYAVAIALD+2FHLAVCUUUU94DtHcD9OD9RD/kFHVAVD/mFAIAID/mFANALANAcD9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHND/mF9DBBX9LDYHLD/kFCTD+rFAVAND/mFALD/kFCggEDtD9OD9QHVAIAND/mFALD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHIDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAOAKD9OAVAIDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM94FEa8jUUUUBCAlHE8kUUUUBABAFC98ZHIT+JUUUBGXAIAF9PQBAEAFCEZHLCEWHFJCBCAAFl/8MBAEABAICEWJHBAF/8cBBAEALT+JUUUBABAEAF/8cBBMAECAJ8kUUUUBM/hEIGaF97FaL978jUUUUBCTlRGGXAF9FQBCBREEXAGABDBBBHIABCTJHLDBBBHKDQILKOSQfbPden8c8d8e8fHOCTD+sFHNCID+rFDMIBAB9DBBU8/DY9D/zI818/DYANCEDtD9QD/6FD/nFHNAIAKDQBFGENVcMTtmYi8ZpyHICTD+rFCTD+sFD/6FD/mFHKAKD/mFANAICTD+sFD/6FD/mFHVAVD/mFANAOCTD+rFCTD+sFD/6FD/mFHOAOD/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHND/mF9DBBX9LDYHID/kFCggEDtHcD9OAVAND/mFAID/kFCTD+rFD9QHVAOAND/mFAID/kFCTD+rFAKAND/mFAID/kFAcD9OD9QHNDQBFTtGEmYILPdKOenHID8dBAGDBIBDyB+t+J83EBABCNJAID8dFAGDBIBDyF+t+J83EBALAVANDQNVi8ZcMpySQ8c8dfb8e8fHND8dBAGDBIBDyG+t+J83EBABCiJAND8dFAGDBIBDyE+t+J83EBABCAJRBAECIJHEAF9JQBMMM/3FGEaF978jUUUUBCoBlREGXAGCGrAF9sHIC98ZHL9FQBCBRGABRFEXAFAFDBBBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBAFCTJRFAGCIJHGAL9JQBMMGXALAI9PQBAEAICEZHGCGWHFqCBCoBAFl/8MBAEABALCGWJHLAF/8cBBGXAG9FQBAEAEDBIBHKCND+rFCND+sFD/6FAKCiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMIBMALAEAF/8cBBMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",Zx=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),Jx=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]),Yx={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},qx={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};async function $x(e,t,i,s,r,o="NONE"){const n=await async function(){eC||(eC=async function(){let e=Xx;WebAssembly.validate(Zx)&&(e=Kx,console.log("Warning: meshopt_decoder is using experimental SIMD support"));const t=await WebAssembly.instantiate(function(e){const t=new Uint8Array(e.length);for(let i=0;i<e.length;++i){const s=e.charCodeAt(i);t[i]=s>96?s-71:s>64?s-65:s>47?s+4:s>46?63:62}let i=0;for(let s=0;s<e.length;++s)t[i++]=t[s]<60?Jx[t[s]]:64*(t[s]-60)+t[++s];return t.buffer.slice(0,i)}(e),{});return await t.instance.exports.__wasm_call_ctors(),t.instance}());return eC}();!function(e,t,i,s,r,o,n){const a=e.exports.sbrk,l=s+3&-4,A=a(l*r),c=a(o.length),h=new Uint8Array(e.exports.memory.buffer);h.set(o,c);const u=t(A,s,r,c,o.length);0===u&&n&&n(A,l,r);if(i.set(h.subarray(A,A+s*r)),a(A-a(0)),0!==u)throw new Error(`Malformed buffer data: ${u}`)}(n,n.exports[qx[r]],e,t,i,s,n.exports[Yx[o||"NONE"]])}let eC;async function tC(e,t){const i=e.getObjectExtension(t,"EXT_meshopt_compression");if(i){const{byteOffset:s=0,byteLength:r=0,byteStride:o,count:n,mode:a,filter:l="NONE",buffer:A}=i,c=e.gltf.buffers[A],h=new Uint8Array(c.arrayBuffer,c.byteOffset+s,r),u=new Uint8Array(e.gltf.buffers[t.buffer].arrayBuffer,t.byteOffset,t.byteLength);await $x(u,n,o,h,a,l),e.removeObjectExtension(t,"EXT_meshopt_compression")}}var iC=Object.freeze({__proto__:null,name:"EXT_meshopt_compression",decode:async function(e,t){const i=new OP(e);if(!t?.gltf?.decompressMeshes||!t.gltf?.loadBuffers)return;const s=[];for(const t of e.json.bufferViews||[])s.push(tC(i,t));await Promise.all(s),i.removeExtension("EXT_meshopt_compression")}});var sC=Object.freeze({__proto__:null,name:"EXT_texture_webp",preprocess:function(e,t){const i=new OP(e);if(!xP("image/webp")){if(i.getRequiredExtensions().includes("EXT_texture_webp"))throw new Error("gltf: Required extension EXT_texture_webp not supported by browser");return}const{json:s}=i;for(const e of s.textures||[]){const t=i.getObjectExtension(e,"EXT_texture_webp");t&&(e.source=t.source),i.removeObjectExtension(e,"EXT_texture_webp")}i.removeExtension("EXT_texture_webp")}});var rC=Object.freeze({__proto__:null,name:"KHR_texture_basisu",preprocess:function(e,t){const i=new OP(e),{json:s}=i;for(const e of s.textures||[]){const t=i.getObjectExtension(e,"KHR_texture_basisu");t&&(e.source=t.source,i.removeObjectExtension(e,"KHR_texture_basisu"))}i.removeExtension("KHR_texture_basisu")}});const oC={dataType:null,batchType:null,name:"Draco",id:"draco",module:"draco",version:"4.3.2",worker:!0,extensions:["drc"],mimeTypes:["application/octet-stream"],binary:!0,tests:["DRACO"],options:{draco:{decoderType:"object"==typeof WebAssembly?"wasm":"js",libraryPath:"libs/",extraAttributes:{},attributeNameEntry:void 0}}};function nC(e,t,i){return rP(e,t,i?aC(i.metadata):void 0)}function aC(e){const t={};for(const i in e)t[`${i}.string`]=JSON.stringify(e[i]);return t}const lC={POSITION:"POSITION",NORMAL:"NORMAL",COLOR:"COLOR_0",TEX_COORD:"TEXCOORD_0"},AC={1:Int8Array,2:Uint8Array,3:Int16Array,4:Uint16Array,5:Int32Array,6:Uint32Array,9:Float32Array};class cC{draco;decoder;metadataQuerier;constructor(e){this.draco=e,this.decoder=new this.draco.Decoder,this.metadataQuerier=new this.draco.MetadataQuerier}destroy(){this.draco.destroy(this.decoder),this.draco.destroy(this.metadataQuerier)}parseSync(e,t={}){const i=new this.draco.DecoderBuffer;i.Init(new Int8Array(e),e.byteLength),this._disableAttributeTransforms(t);const s=this.decoder.GetEncodedGeometryType(i),r=s===this.draco.TRIANGULAR_MESH?new this.draco.Mesh:new this.draco.PointCloud;try{let e;switch(s){case this.draco.TRIANGULAR_MESH:e=this.decoder.DecodeBufferToMesh(i,r);break;case this.draco.POINT_CLOUD:e=this.decoder.DecodeBufferToPointCloud(i,r);break;default:throw new Error("DRACO: Unknown geometry type.")}if(!e.ok()||!r.ptr){const t=`DRACO decompression failed: ${e.error_msg()}`;throw new Error(t)}const o=this._getDracoLoaderData(r,s,t),n=this._getMeshData(r,o,t),a=iP(n.attributes),l=function(e,t,i){const s=aC(t.metadata),r=[],o=function(e){const t={};for(const i in e){const s=e[i];t[s.name||"undefined"]=s}return t}(t.attributes);for(const t in e){const i=nC(t,e[t],o[t]);r.push(i)}if(i){const e=nC("indices",i);r.push(e)}return{fields:r,metadata:s}}(n.attributes,o,n.indices);return{loader:"draco",loaderData:o,header:{vertexCount:r.num_points(),boundingBox:a},...n,schema:l}}finally{this.draco.destroy(i),r&&this.draco.destroy(r)}}_getDracoLoaderData(e,t,i){const s=this._getTopLevelMetadata(e),r=this._getDracoAttributes(e,i);return{geometry_type:t,num_attributes:e.num_attributes(),num_points:e.num_points(),num_faces:e instanceof this.draco.Mesh?e.num_faces():0,metadata:s,attributes:r}}_getDracoAttributes(e,t){const i={};for(let s=0;s<e.num_attributes();s++){const r=this.decoder.GetAttribute(e,s),o=this._getAttributeMetadata(e,s);i[r.unique_id()]={unique_id:r.unique_id(),attribute_type:r.attribute_type(),data_type:r.data_type(),num_components:r.num_components(),byte_offset:r.byte_offset(),byte_stride:r.byte_stride(),normalized:r.normalized(),attribute_index:s,metadata:o};const n=this._getQuantizationTransform(r,t);n&&(i[r.unique_id()].quantization_transform=n);const a=this._getOctahedronTransform(r,t);a&&(i[r.unique_id()].octahedron_transform=a)}return i}_getMeshData(e,t,i){const s=this._getMeshAttributes(t,e,i);if(!s.POSITION)throw new Error("DRACO: No position attribute found.");return e instanceof this.draco.Mesh?"triangle-strip"===i.topology?{topology:"triangle-strip",mode:4,attributes:s,indices:{value:this._getTriangleStripIndices(e),size:1}}:{topology:"triangle-list",mode:5,attributes:s,indices:{value:this._getTriangleListIndices(e),size:1}}:{topology:"point-list",mode:0,attributes:s}}_getMeshAttributes(e,t,i){const s={};for(const r of Object.values(e.attributes)){const e=this._deduceAttributeName(r,i);r.name=e;const o=this._getAttributeValues(t,r);if(o){const{value:t,size:i}=o;s[e]={value:t,size:i,byteOffset:r.byte_offset,byteStride:r.byte_stride,normalized:r.normalized}}}return s}_getTriangleListIndices(e){const t=3*e.num_faces(),i=4*t,s=this.draco._malloc(i);try{return this.decoder.GetTrianglesUInt32Array(e,i,s),new Uint32Array(this.draco.HEAPF32.buffer,s,t).slice()}finally{this.draco._free(s)}}_getTriangleStripIndices(e){const t=new this.draco.DracoInt32Array;try{return this.decoder.GetTriangleStripsFromMesh(e,t),function(e){const t=e.size(),i=new Int32Array(t);for(let s=0;s<t;s++)i[s]=e.GetValue(s);return i}(t)}finally{this.draco.destroy(t)}}_getAttributeValues(e,t){const i=AC[t.data_type];if(!i)return console.warn(`DRACO: Unsupported attribute type ${t.data_type}`),null;const s=t.num_components,r=e.num_points()*s,o=r*i.BYTES_PER_ELEMENT,n=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32;default:return e.DT_INVALID}}(this.draco,i);let a;const l=this.draco._malloc(o);try{const s=this.decoder.GetAttribute(e,t.attribute_index);this.decoder.GetAttributeDataArrayForAllPoints(e,s,n,o,l),a=new i(this.draco.HEAPF32.buffer,l,r).slice()}finally{this.draco._free(l)}return{value:a,size:s}}_deduceAttributeName(e,t){const i=e.unique_id;for(const[e,s]of Object.entries(t.extraAttributes||{}))if(s===i)return e;const s=e.attribute_type;for(const e in lC){if(this.draco[e]===s)return lC[e]}const r=t.attributeNameEntry||"name";return e.metadata[r]?e.metadata[r].string:`CUSTOM_ATTRIBUTE_${i}`}_getTopLevelMetadata(e){const t=this.decoder.GetMetadata(e);return this._getDracoMetadata(t)}_getAttributeMetadata(e,t){const i=this.decoder.GetAttributeMetadata(e,t);return this._getDracoMetadata(i)}_getDracoMetadata(e){if(!e||!e.ptr)return{};const t={},i=this.metadataQuerier.NumEntries(e);for(let s=0;s<i;s++){const i=this.metadataQuerier.GetEntryName(e,s);t[i]=this._getDracoMetadataField(e,i)}return t}_getDracoMetadataField(e,t){const i=new this.draco.DracoInt32Array;try{this.metadataQuerier.GetIntEntryArray(e,t,i);const s=function(e){const t=e.size(),i=new Int32Array(t);for(let s=0;s<t;s++)i[s]=e.GetValue(s);return i}(i);return{int:this.metadataQuerier.GetIntEntry(e,t),string:this.metadataQuerier.GetStringEntry(e,t),double:this.metadataQuerier.GetDoubleEntry(e,t),intArray:s}}finally{this.draco.destroy(i)}}_disableAttributeTransforms(e){const{quantizedAttributes:t=[],octahedronAttributes:i=[]}=e,s=[...t,...i];for(const e of s)this.decoder.SkipAttributeTransform(this.draco[e])}_getQuantizationTransform(e,t){const{quantizedAttributes:i=[]}=t,s=e.attribute_type();if(i.map((e=>this.decoder[e])).includes(s)){const t=new this.draco.AttributeQuantizationTransform;try{if(t.InitFromAttribute(e))return{quantization_bits:t.quantization_bits(),range:t.range(),min_values:new Float32Array([1,2,3]).map((e=>t.min_value(e)))}}finally{this.draco.destroy(t)}}return null}_getOctahedronTransform(e,t){const{octahedronAttributes:i=[]}=t,s=e.attribute_type();if(i.map((e=>this.decoder[e])).includes(s)){const t=new this.draco.AttributeQuantizationTransform;try{if(t.InitFromAttribute(e))return{quantization_bits:t.quantization_bits()}}finally{this.draco.destroy(t)}}return null}}const hC="https://www.gstatic.com/draco/versioned/decoders/1.5.6",uC="draco_wasm_wrapper.js",dC="draco_decoder.wasm",pC="draco_decoder.js",fC="draco_encoder.js",mC={[uC]:`${hC}/${uC}`,[dC]:`${hC}/${dC}`,[pC]:`${hC}/${pC}`,[fC]:`https://raw.githubusercontent.com/google/draco/1.4.1/javascript/${fC}`};let gC;async function _C(e){const t=e.modules||{};return t.draco3d?gC||=t.draco3d.createDecoderModule({}).then((e=>({draco:e}))):gC||=async function(e){let t,i;if("js"===(e.draco&&e.draco.decoderType))t=await Jw(mC[pC],"draco",e,pC);else[t,i]=await Promise.all([await Jw(mC[uC],"draco",e,uC),await Jw(mC[dC],"draco",e,dC)]);return t=t||globalThis.DracoDecoderModule,await function(e,t){const i={};t&&(i.wasmBinary=t);return new Promise((t=>{e({...i,onModuleLoaded:e=>t({draco:e})})}))}(t,i)}(e),await gC}const vC={...oC,parse:async function(e,t){const{draco:i}=await _C(t),s=new cC(i);try{return s.parseSync(e,t?.draco)}finally{s.destroy()}}};function bC(e){const{buffer:t,size:i,count:s}=function(e){let t=e,i=1,s=0;e&&e.value&&(t=e.value,i=e.size||1);t&&(ArrayBuffer.isView(t)||(t=function(e,t,i=!1){if(!e)return null;if(Array.isArray(e))return new t(e);if(i&&!(e instanceof t))return new t(e);return e}(t,Float32Array)),s=t.length/i);return{buffer:t,size:i,count:s}}(e);return{value:t,size:i,byteOffset:0,count:s,type:UP(i),componentType:LP(t)}}async function yC(e,t,i,s){const r=e.getObjectExtension(t,"KHR_draco_mesh_compression");if(!r)return;const o=e.getTypedArrayForBufferView(r.bufferView),n=iB(o.buffer,o.byteOffset),a={...i};delete a["3d-tiles"];const l=await nw(n,vC,a,s),A=function(e){const t={};for(const i in e){const s=e[i];if("indices"!==i){const e=bC(s);t[i]=e}}return t}(l.attributes);for(const[i,s]of Object.entries(A))if(i in t.attributes){const r=t.attributes[i],o=e.getAccessor(r);o?.min&&o?.max&&(s.min=o.min,s.max=o.max)}t.attributes=A,l.indices&&(t.indices=bC(l.indices)),e.removeObjectExtension(t,"KHR_draco_mesh_compression"),function(e){if(!e.attributes&&Object.keys(e.attributes).length>0)throw new Error("glTF: Empty primitive detected: Draco decompression failure?")}(t)}function wC(e,t,i=4,s,r){if(!s.DracoWriter)throw new Error("options.gltf.DracoWriter not provided");const o=s.DracoWriter.encodeSync({attributes:e}),n=r?.parseSync?.({attributes:e}),a=s._addFauxAttributes(n.attributes);return{primitives:[{attributes:a,mode:i,extensions:{KHR_draco_mesh_compression:{bufferView:s.addBufferView(o),attributes:a}}}]}}function*BC(e){for(const t of e.json.meshes||[])for(const e of t.primitives)yield e}var PC=Object.freeze({__proto__:null,name:"KHR_draco_mesh_compression",preprocess:function(e,t,i){const s=new OP(e);for(const e of BC(s))s.getObjectExtension(e,"KHR_draco_mesh_compression")},decode:async function(e,t,i){if(!t?.gltf?.decompressMeshes)return;const s=new OP(e),r=[];for(const e of BC(s))s.getObjectExtension(e,"KHR_draco_mesh_compression")&&r.push(yC(s,e,t,i));await Promise.all(r),s.removeExtension("KHR_draco_mesh_compression")},encode:function(e,t={}){const i=new OP(e);for(const e of i.json.meshes||[])wC(e),i.addRequiredExtension("KHR_draco_mesh_compression")}});globalThis.mathgl=globalThis.mathgl||{config:{EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1}};const xC=globalThis.mathgl.config;function CC(e,{precision:t=xC.precision}={}){return e=function(e){return Math.round(e/xC.EPSILON)*xC.EPSILON}(e),`${parseFloat(e.toPrecision(t))}`}function MC(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&!(e instanceof DataView)}function EC(e,t,i){const s=xC.EPSILON;i&&(xC.EPSILON=i);try{if(e===t)return!0;if(MC(e)&&MC(t)){if(e.length!==t.length)return!1;for(let i=0;i<e.length;++i)if(!EC(e[i],t[i]))return!1;return!0}return e&&e.equals?e.equals(t):t&&t.equals?t.equals(e):"number"==typeof e&&"number"==typeof t&&Math.abs(e-t)<=xC.EPSILON*Math.max(1,Math.abs(e),Math.abs(t))}finally{xC.EPSILON=s}}class FC extends Array{clone(){return(new this.constructor).copy(this)}fromArray(e,t=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=e[i+t];return this.check()}toArray(e=[],t=0){for(let i=0;i<this.ELEMENTS;++i)e[t+i]=this[i];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:MC(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(xC)}formatString(e){let t="";for(let i=0;i<this.ELEMENTS;++i)t+=(i>0?", ":"")+CC(this[i],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!EC(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,i){if(void 0===i)return this.lerp(this,e,t);for(let s=0;s<this.ELEMENTS;++s){const r=e[s],o="number"==typeof t?t:t[s];this[s]=r+i*(o-r)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e[i]),t[i]);return this.check()}add(...e){for(const t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]+=t[e];return this.check()}subtract(...e){for(const t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]-=t[e];return this.check()}scale(e){if("number"==typeof e)for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(xC.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e),t);return this.check()}get elements(){return this}}function IC(e){if(!Number.isFinite(e))throw new Error(`Invalid number ${JSON.stringify(e)}`);return e}function TC(e,t,i=""){if(xC.debug&&!function(e,t){if(e.length!==t)return!1;for(let t=0;t<e.length;++t)if(!Number.isFinite(e[t]))return!1;return!0}(e,t))throw new Error(`math.gl: ${i} some fields set to invalid numbers'`);return e}function DC(e,t){if(!e)throw new Error(`math.gl assertion ${t}`)}class SC extends FC{get x(){return this[0]}set x(e){this[0]=IC(e)}get y(){return this[1]}set y(e){this[1]=IC(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let i=0;i<this.ELEMENTS;++i){const s=this[i]-e[i];t+=s*s}return IC(t)}dot(e){let t=0;for(let i=0;i<this.ELEMENTS;++i)t+=this[i]*e[i];return IC(t)}normalize(){const e=this.magnitude();if(0!==e)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]*=t[e];return this.check()}divide(...e){for(const t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t[e];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return DC(e>=0&&e<this.ELEMENTS,"index is out of range"),IC(this[e])}setComponent(e,t){return DC(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}let RC="undefined"!=typeof Float32Array?Float32Array:Array;function UC(e,t,i){const s=t[0],r=t[1],o=t[2];return e[0]=s*i[0]+r*i[3]+o*i[6],e[1]=s*i[1]+r*i[4]+o*i[7],e[2]=s*i[2]+r*i[5]+o*i[8],e}!function(){const e=function(){const e=new RC(2);return RC!=Float32Array&&(e[0]=0,e[1]=0),e}()}(),function(){const e=function(){const e=new RC(3);return RC!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}()}();const LC=[0,0,0];let kC;class OC extends SC{static get ZERO(){return kC||(kC=new OC(0,0,0),Object.freeze(kC)),kC}constructor(e=0,t=0,i=0){super(-0,-0,-0),1===arguments.length&&MC(e)?this.copy(e):(xC.debug&&(IC(e),IC(t),IC(i)),this[0]=e,this[1]=t,this[2]=i)}set(e,t,i){return this[0]=e,this[1]=t,this[2]=i,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return xC.debug&&(IC(e.x),IC(e.y),IC(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=IC(e)}angle(e){return function(e,t){const i=e[0],s=e[1],r=e[2],o=t[0],n=t[1],a=t[2],l=Math.sqrt((i*i+s*s+r*r)*(o*o+n*n+a*a)),A=l&&function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}(e,t)/l;return Math.acos(Math.min(Math.max(A,-1),1))}(this,e)}cross(e){return function(e,t,i){const s=t[0],r=t[1],o=t[2],n=i[0],a=i[1],l=i[2];e[0]=r*l-o*a,e[1]=o*n-s*l,e[2]=s*a-r*n}(this,this,e),this.check()}rotateX({radians:e,origin:t=LC}){return function(e,t,i,s){const r=[],o=[];r[0]=t[0]-i[0],r[1]=t[1]-i[1],r[2]=t[2]-i[2],o[0]=r[0],o[1]=r[1]*Math.cos(s)-r[2]*Math.sin(s),o[2]=r[1]*Math.sin(s)+r[2]*Math.cos(s),e[0]=o[0]+i[0],e[1]=o[1]+i[1],e[2]=o[2]+i[2]}(this,this,t,e),this.check()}rotateY({radians:e,origin:t=LC}){return function(e,t,i,s){const r=[],o=[];r[0]=t[0]-i[0],r[1]=t[1]-i[1],r[2]=t[2]-i[2],o[0]=r[2]*Math.sin(s)+r[0]*Math.cos(s),o[1]=r[1],o[2]=r[2]*Math.cos(s)-r[0]*Math.sin(s),e[0]=o[0]+i[0],e[1]=o[1]+i[1],e[2]=o[2]+i[2]}(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=LC}){return function(e,t,i,s){const r=[],o=[];r[0]=t[0]-i[0],r[1]=t[1]-i[1],r[2]=t[2]-i[2],o[0]=r[0]*Math.cos(s)-r[1]*Math.sin(s),o[1]=r[0]*Math.sin(s)+r[1]*Math.cos(s),o[2]=r[2],e[0]=o[0]+i[0],e[1]=o[1]+i[1],e[2]=o[2]+i[2]}(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return function(e,t,i){const s=t[0],r=t[1],o=t[2];let n=i[3]*s+i[7]*r+i[11]*o+i[15];n=n||1,e[0]=(i[0]*s+i[4]*r+i[8]*o+i[12])/n,e[1]=(i[1]*s+i[5]*r+i[9]*o+i[13])/n,e[2]=(i[2]*s+i[6]*r+i[10]*o+i[14])/n}(this,this,e),this.check()}transformAsVector(e){return function(e,t,i){const s=t[0],r=t[1],o=t[2],n=i[3]*s+i[7]*r+i[11]*o||1;e[0]=(i[0]*s+i[4]*r+i[8]*o)/n,e[1]=(i[1]*s+i[5]*r+i[9]*o)/n,e[2]=(i[2]*s+i[6]*r+i[10]*o)/n}(this,this,e),this.check()}transformByMatrix3(e){return UC(this,this,e),this.check()}transformByMatrix2(e){return function(e,t,i){const s=t[0],r=t[1];e[0]=i[0]*s+i[2]*r,e[1]=i[1]*s+i[3]*r,e[2]=t[2]}(this,this,e),this.check()}transformByQuaternion(e){return function(e,t,i){const s=i[0],r=i[1],o=i[2],n=i[3],a=t[0],l=t[1],A=t[2];let c=r*A-o*l,h=o*a-s*A,u=s*l-r*a,d=r*u-o*h,p=o*c-s*u,f=s*h-r*c;const m=2*n;c*=m,h*=m,u*=m,d*=2,p*=2,f*=2,e[0]=a+c+d,e[1]=l+h+p,e[2]=A+u+f}(this,this,e),this.check()}}class NC extends FC{toString(){let e="[";if(xC.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let i=0;i<this.RANK;++i)e+=` ${this[i*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,i){return this[t*this.RANK+e]=IC(i),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const i=e*this.RANK;for(let e=0;e<this.RANK;++e)t[e]=this[i+e];return t}setColumn(e,t){const i=e*this.RANK;for(let e=0;e<this.RANK;++e)this[i+e]=t[e];return this}}function VC(e,t,i){const s=t[0],r=t[1],o=t[2],n=t[3],a=t[4],l=t[5],A=t[6],c=t[7],h=t[8],u=i[0],d=i[1],p=i[2],f=i[3],m=i[4],g=i[5],_=i[6],v=i[7],b=i[8];return e[0]=u*s+d*n+p*A,e[1]=u*r+d*a+p*c,e[2]=u*o+d*l+p*h,e[3]=f*s+m*n+g*A,e[4]=f*r+m*a+g*c,e[5]=f*o+m*l+g*h,e[6]=_*s+v*n+b*A,e[7]=_*r+v*a+b*c,e[8]=_*o+v*l+b*h,e}function QC(e,t,i){const s=i[0],r=i[1];return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=r*t[3],e[4]=r*t[4],e[5]=r*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}var HC;!function(e){e[e.COL0ROW0=0]="COL0ROW0",e[e.COL0ROW1=1]="COL0ROW1",e[e.COL0ROW2=2]="COL0ROW2",e[e.COL1ROW0=3]="COL1ROW0",e[e.COL1ROW1=4]="COL1ROW1",e[e.COL1ROW2=5]="COL1ROW2",e[e.COL2ROW0=6]="COL2ROW0",e[e.COL2ROW1=7]="COL2ROW1",e[e.COL2ROW2=8]="COL2ROW2"}(HC||(HC={}));const jC=Object.freeze([1,0,0,0,1,0,0,0,1]);class GC extends NC{static get IDENTITY(){return function(){WC||(WC=new GC,Object.freeze(WC));return WC}()}static get ZERO(){return function(){zC||(zC=new GC([0,0,0,0,0,0,0,0,0]),Object.freeze(zC));return zC}()}get ELEMENTS(){return 9}get RANK(){return 3}get INDICES(){return HC}constructor(e,...t){super(-0,-0,-0,-0,-0,-0,-0,-0,-0),1===arguments.length&&Array.isArray(e)?this.copy(e):t.length>0?this.copy([e,...t]):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this.check()}identity(){return this.copy(jC)}fromObject(e){return this.check()}fromQuaternion(e){return function(e,t){const i=t[0],s=t[1],r=t[2],o=t[3],n=i+i,a=s+s,l=r+r,A=i*n,c=s*n,h=s*a,u=r*n,d=r*a,p=r*l,f=o*n,m=o*a,g=o*l;e[0]=1-h-p,e[3]=c-g,e[6]=u+m,e[1]=c+g,e[4]=1-A-p,e[7]=d-f,e[2]=u-m,e[5]=d+f,e[8]=1-A-h}(this,e),this.check()}set(e,t,i,s,r,o,n,a,l){return this[0]=e,this[1]=t,this[2]=i,this[3]=s,this[4]=r,this[5]=o,this[6]=n,this[7]=a,this[8]=l,this.check()}setRowMajor(e,t,i,s,r,o,n,a,l){return this[0]=e,this[1]=s,this[2]=n,this[3]=t,this[4]=r,this[5]=a,this[6]=i,this[7]=o,this[8]=l,this.check()}determinant(){return function(e){const t=e[0],i=e[1],s=e[2],r=e[3],o=e[4],n=e[5],a=e[6],l=e[7],A=e[8];return t*(A*o-n*l)+i*(-A*r+n*a)+s*(l*r-o*a)}(this)}transpose(){return function(e,t){if(e===t){const i=t[1],s=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=s,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8]}(this,this),this.check()}invert(){return function(e,t){const i=t[0],s=t[1],r=t[2],o=t[3],n=t[4],a=t[5],l=t[6],A=t[7],c=t[8],h=c*n-a*A,u=-c*o+a*l,d=A*o-n*l;let p=i*h+s*u+r*d;p&&(p=1/p,e[0]=h*p,e[1]=(-c*s+r*A)*p,e[2]=(a*s-r*n)*p,e[3]=u*p,e[4]=(c*i-r*l)*p,e[5]=(-a*i+r*o)*p,e[6]=d*p,e[7]=(-A*i+s*l)*p,e[8]=(n*i-s*o)*p)}(this,this),this.check()}multiplyLeft(e){return VC(this,e,this),this.check()}multiplyRight(e){return VC(this,this,e),this.check()}rotate(e){return function(e,t,i){const s=t[0],r=t[1],o=t[2],n=t[3],a=t[4],l=t[5],A=t[6],c=t[7],h=t[8],u=Math.sin(i),d=Math.cos(i);e[0]=d*s+u*n,e[1]=d*r+u*a,e[2]=d*o+u*l,e[3]=d*n-u*s,e[4]=d*a-u*r,e[5]=d*l-u*o,e[6]=A,e[7]=c,e[8]=h}(this,this,e),this.check()}scale(e){return Array.isArray(e)?QC(this,this,e):QC(this,this,[e,e]),this.check()}translate(e){return function(e,t,i){const s=t[0],r=t[1],o=t[2],n=t[3],a=t[4],l=t[5],A=t[6],c=t[7],h=t[8],u=i[0],d=i[1];e[0]=s,e[1]=r,e[2]=o,e[3]=n,e[4]=a,e[5]=l,e[6]=u*s+d*n+A,e[7]=u*r+d*a+c,e[8]=u*o+d*l+h}(this,this,e),this.check()}transform(e,t){let i;switch(e.length){case 2:i=function(e,t,i){const s=t[0],r=t[1];return e[0]=i[0]*s+i[3]*r+i[6],e[1]=i[1]*s+i[4]*r+i[7],e}(t||[-0,-0],e,this);break;case 3:i=UC(t||[-0,-0,-0],e,this);break;case 4:i=function(e,t,i){const s=t[0],r=t[1],o=t[2];return e[0]=i[0]*s+i[3]*r+i[6]*o,e[1]=i[1]*s+i[4]*r+i[7]*o,e[2]=i[2]*s+i[5]*r+i[8]*o,e[3]=t[3],e}(t||[-0,-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return TC(i,e.length),i}transformVector(e,t){return this.transform(e,t)}transformVector2(e,t){return this.transform(e,t)}transformVector3(e,t){return this.transform(e,t)}}let zC,WC=null;const XC=new OC,KC=new GC,ZC=new GC;function JC(e,t){const i=t.json.materials?.[e],s=[i?.pbrMetallicRoughness?.baseColorTexture,i?.emissiveTexture,i?.normalTexture,i?.occlusionTexture,i?.pbrMetallicRoughness?.metallicRoughnessTexture],r=[];for(const i of s)i&&i?.extensions?.KHR_texture_transform&&YC(t,e,i,r)}function YC(e,t,i,s){const r=function(e,t){const i=e.extensions?.KHR_texture_transform,{texCoord:s=0}=e,{texCoord:r=s}=i;if(-1===t.findIndex((([e,t])=>e===s&&t===r))){const o=function(e){const{offset:t=[0,0],rotation:i=0,scale:s=[1,1]}=e,r=(new GC).set(1,0,0,0,1,0,t[0],t[1],1),o=KC.set(Math.cos(i),Math.sin(i),0,-Math.sin(i),Math.cos(i),0,0,0,1),n=ZC.set(s[0],0,0,0,s[1],0,0,0,1);return r.multiplyRight(o).multiplyRight(n)}(i);return s!==r&&(e.texCoord=r),t.push([s,r]),{originalTexCoord:s,texCoord:r,matrix:o}}return null}(i,s);if(!r)return;const o=e.json.meshes||[];for(const i of o)for(const s of i.primitives){const i=s.material;Number.isFinite(i)&&t===i&&qC(e,s,r)}}function qC(e,t,i){const{originalTexCoord:s,texCoord:r,matrix:o}=i,n=t.attributes[`TEXCOORD_${s}`];if(Number.isFinite(n)){const i=e.json.accessors?.[n];if(i&&i.bufferView){const n=e.json.bufferViews?.[i.bufferView];if(n){const{arrayBuffer:a,byteOffset:l}=e.buffers[n.buffer],A=(l||0)+(i.byteOffset||0)+(n.byteOffset||0),{ArrayType:c,length:h}=kP(i,n),u=EP[i.componentType],d=MP[i.type],p=n.byteStride||u*d,f=new Float32Array(h);for(let e=0;e<i.count;e++){const t=new c(a,A+e*p,2);XC.set(t[0],t[1],1),XC.transformByMatrix3(o),f.set([XC[0],XC[1]],e*d)}s===r?function(e,t,i,s){e.componentType=5126,i.push({arrayBuffer:s.buffer,byteOffset:0,byteLength:s.buffer.byteLength}),t.buffer=i.length-1,t.byteLength=s.buffer.byteLength,t.byteOffset=0,delete t.byteStride}(i,n,e.buffers,f):function(e,t,i,s,r){s.buffers.push({arrayBuffer:r.buffer,byteOffset:0,byteLength:r.buffer.byteLength});const o=s.json.bufferViews;if(!o)return;o.push({buffer:s.buffers.length-1,byteLength:r.buffer.byteLength,byteOffset:0});const n=s.json.accessors;if(!n)return;n.push({bufferView:o?.length-1,byteOffset:0,componentType:5126,count:t.count,type:"VEC2"}),i.attributes[`TEXCOORD_${e}`]=n.length-1}(r,i,t,e,f)}}}}var $C=Object.freeze({__proto__:null,name:"KHR_texture_transform",decode:async function(e,t){if(!new OP(e).hasExtension("KHR_texture_transform")||!t.gltf?.loadBuffers)return;const i=e.json.materials||[];for(let t=0;t<i.length;t++)JC(t,e)}});function eM(e,t){const i=Object.assign({},e.values);return Object.keys(e.uniforms||{}).forEach((t=>{e.uniforms[t].value&&!(t in i)&&(i[t]=e.uniforms[t].value)})),Object.keys(i).forEach((e=>{"object"==typeof i[e]&&void 0!==i[e].index&&(i[e].texture=t.getTexture(i[e].index))})),i}const tM=[ux,ex,iC,sC,rC,PC,Object.freeze({__proto__:null,name:"KHR_lights_punctual",decode:async function(e){const t=new OP(e),{json:i}=t,s=t.getExtension("KHR_lights_punctual");s&&(t.json.lights=s.lights,t.removeExtension("KHR_lights_punctual"));for(const e of i.nodes||[]){const i=t.getObjectExtension(e,"KHR_lights_punctual");i&&(e.light=i.light),t.removeObjectExtension(e,"KHR_lights_punctual")}},encode:async function(e){const t=new OP(e),{json:i}=t;if(i.lights){const e=t.addExtension("KHR_lights_punctual");CP(!e.lights),e.lights=i.lights,delete i.lights}if(t.json.lights){for(const e of t.json.lights){const i=e.node;t.addObjectExtension(i,"KHR_lights_punctual",e)}delete t.json.lights}}}),Object.freeze({__proto__:null,name:"KHR_materials_unlit",decode:async function(e){const t=new OP(e),{json:i}=t;for(const e of i.materials||[]){e.extensions&&e.extensions.KHR_materials_unlit&&(e.unlit=!0),t.removeObjectExtension(e,"KHR_materials_unlit")}t.removeExtension("KHR_materials_unlit")},encode:function(e){const t=new OP(e),{json:i}=t;if(t.materials)for(const e of i.materials||[])e.unlit&&(delete e.unlit,t.addObjectExtension(e,"KHR_materials_unlit",{}),t.addExtension("KHR_materials_unlit"))}}),Object.freeze({__proto__:null,name:"KHR_techniques_webgl",decode:async function(e){const t=new OP(e),{json:i}=t,s=t.getExtension("KHR_techniques_webgl");if(s){const e=function(e,t){const{programs:i=[],shaders:s=[],techniques:r=[]}=e,o=new TextDecoder;return s.forEach((e=>{if(!Number.isFinite(e.bufferView))throw new Error("KHR_techniques_webgl: no shader code");e.code=o.decode(t.getTypedArrayForBufferView(e.bufferView))})),i.forEach((e=>{e.fragmentShader=s[e.fragmentShader],e.vertexShader=s[e.vertexShader]})),r.forEach((e=>{e.program=i[e.program]})),r}(s,t);for(const s of i.materials||[]){const i=t.getObjectExtension(s,"KHR_techniques_webgl");i&&(s.technique=Object.assign({},i,e[i.technique]),s.technique.values=eM(s.technique,t)),t.removeObjectExtension(s,"KHR_techniques_webgl")}t.removeExtension("KHR_techniques_webgl")}},encode:async function(e,t){}}),$C,bx];function iM(e,t){const i=t?.gltf?.excludeExtensions||{};return!(e in i&&!i[e])}const sM={accessors:"accessor",animations:"animation",buffers:"buffer",bufferViews:"bufferView",images:"image",materials:"material",meshes:"mesh",nodes:"node",samplers:"sampler",scenes:"scene",skins:"skin",textures:"texture"},rM={accessor:"accessors",animations:"animation",buffer:"buffers",bufferView:"bufferViews",image:"images",material:"materials",mesh:"meshes",node:"nodes",sampler:"samplers",scene:"scenes",skin:"skins",texture:"textures"};class oM{idToIndexMap={animations:{},accessors:{},buffers:{},bufferViews:{},images:{},materials:{},meshes:{},nodes:{},samplers:{},scenes:{},skins:{},textures:{}};json;normalize(e,t){this.json=e.json;const i=e.json;switch(i.asset&&i.asset.version){case"2.0":return;case void 0:case"1.0":break;default:return void console.warn(`glTF: Unknown version ${i.asset.version}`)}if(!t.normalize)throw new Error("glTF v1 is not supported.");console.warn("Converting glTF v1 to glTF v2 format. This is experimental and may fail."),this._addAsset(i),this._convertTopLevelObjectsToArrays(i),function(e){const t=new OP(e),{json:i}=t;for(const e of i.images||[]){const i=t.getObjectExtension(e,"KHR_binary_glTF");i&&Object.assign(e,i),t.removeObjectExtension(e,"KHR_binary_glTF")}i.buffers&&i.buffers[0]&&delete i.buffers[0].uri,t.removeExtension("KHR_binary_glTF")}(e),this._convertObjectIdsToArrayIndices(i),this._updateObjects(i),this._updateMaterial(i)}_addAsset(e){e.asset=e.asset||{},e.asset.version="2.0",e.asset.generator=e.asset.generator||"Normalized to glTF 2.0 by loaders.gl"}_convertTopLevelObjectsToArrays(e){for(const t in sM)this._convertTopLevelObjectToArray(e,t)}_convertTopLevelObjectToArray(e,t){const i=e[t];if(i&&!Array.isArray(i)){e[t]=[];for(const s in i){const r=i[s];r.id=r.id||s;const o=e[t].length;e[t].push(r),this.idToIndexMap[t][s]=o}}}_convertObjectIdsToArrayIndices(e){for(const t in sM)this._convertIdsToIndices(e,t);"scene"in e&&(e.scene=this._convertIdToIndex(e.scene,"scene"));for(const t of e.textures)this._convertTextureIds(t);for(const t of e.meshes)this._convertMeshIds(t);for(const t of e.nodes)this._convertNodeIds(t);for(const t of e.scenes)this._convertSceneIds(t)}_convertTextureIds(e){e.source&&(e.source=this._convertIdToIndex(e.source,"image"))}_convertMeshIds(e){for(const t of e.primitives){const{attributes:e,indices:i,material:s}=t;for(const t in e)e[t]=this._convertIdToIndex(e[t],"accessor");i&&(t.indices=this._convertIdToIndex(i,"accessor")),s&&(t.material=this._convertIdToIndex(s,"material"))}}_convertNodeIds(e){e.children&&(e.children=e.children.map((e=>this._convertIdToIndex(e,"node")))),e.meshes&&(e.meshes=e.meshes.map((e=>this._convertIdToIndex(e,"mesh"))))}_convertSceneIds(e){e.nodes&&(e.nodes=e.nodes.map((e=>this._convertIdToIndex(e,"node"))))}_convertIdsToIndices(e,t){e[t]||(console.warn(`gltf v1: json doesn't contain attribute ${t}`),e[t]=[]);for(const i of e[t])for(const e in i){const t=i[e],s=this._convertIdToIndex(t,e);i[e]=s}}_convertIdToIndex(e,t){const i=rM[t];if(i in this.idToIndexMap){const s=this.idToIndexMap[i][e];if(!Number.isFinite(s))throw new Error(`gltf v1: failed to resolve ${t} with id ${e}`);return s}return e}_updateObjects(e){for(const e of this.json.buffers)delete e.type}_updateMaterial(e){for(const t of e.materials){t.pbrMetallicRoughness={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1};const i=t.values?.tex||t.values?.texture2d_0||t.values?.diffuseTex,s=e.textures.findIndex((e=>e.id===i));-1!==s&&(t.pbrMetallicRoughness.baseColorTexture={index:s})}}}async function nM(e,t,i=0,s,r){return function(e,t,i,s){s.uri&&(e.baseUri=s.uri);if(t instanceof ArrayBuffer&&!function(e,t=0,i={}){const s=new DataView(e),{magic:r=Hx}=i,o=s.getUint32(t,!1);return o===r||o===Hx}(t,i,s)){t=(new TextDecoder).decode(t)}if("string"==typeof t)e.json=eB(t);else if(t instanceof ArrayBuffer){const r={};i=jx(r,t,i,s.glb),CP("glTF"===r.type,`Invalid GLB magic string ${r.type}`),e._glb=r,e.json=r.json}else CP(!1,"GLTF: must be ArrayBuffer or string");const r=e.json.buffers||[];if(e.buffers=new Array(r.length).fill(null),e._glb&&e._glb.header.hasBinChunk){const{binChunks:t}=e._glb;e.buffers[0]={arrayBuffer:t[0].arrayBuffer,byteOffset:t[0].byteOffset,byteLength:t[0].byteLength}}const o=e.json.images||[];e.images=new Array(o.length).fill({})}(e,t,i,s),function(e,t={}){(new oM).normalize(e,t)}(e,{normalize:s?.gltf?.normalize}),function(e,t={},i){const s=tM.filter((e=>iM(e.name,t)));for(const r of s)r.preprocess?.(e,t,i)}(e,s,r),s?.gltf?.loadBuffers&&e.json.buffers&&await async function(e,t,i){const s=e.json.buffers||[];for(let r=0;r<s.length;++r){const o=s[r];if(o.uri){const{fetch:s}=i;CP(s);const n=Wx(o.uri,t),a=await(i?.fetch?.(n)),l=await(a?.arrayBuffer?.());e.buffers[r]={arrayBuffer:l,byteOffset:0,byteLength:l.byteLength},delete o.uri}else null===e.buffers[r]&&(e.buffers[r]={arrayBuffer:new ArrayBuffer(o.byteLength),byteOffset:0,byteLength:o.byteLength})}}(e,s,r),s?.gltf?.loadImages&&await async function(e,t,i){const s=function(e){const t=new Set,i=e.json.textures||[];for(const e of i)void 0!==e.source&&t.add(e.source);return Array.from(t).sort()}(e),r=e.json.images||[],o=[];for(const n of s)o.push(aM(e,r[n],n,t,i));return await Promise.all(o)}(e,s,r),await async function(e,t={},i){const s=tM.filter((e=>iM(e.name,t)));for(const r of s)await(r.decode?.(e,t,i))}(e,s,r),e}async function aM(e,t,i,s,r){let o;if(t.uri&&!t.hasOwnProperty("bufferView")){const e=Wx(t.uri,s),{fetch:i}=r,n=await i(e);o=await n.arrayBuffer(),t.bufferView={data:o}}if(Number.isFinite(t.bufferView)){const i=function(e,t,i){const s=e.bufferViews[i];CP(s);const r=t[s.buffer];CP(r);const o=(s.byteOffset||0)+r.byteOffset;return new Uint8Array(r.arrayBuffer,o,s.byteLength)}(e.json,e.buffers,t.bufferView);o=iB(i.buffer,i.byteOffset,i.byteLength)}CP(o,"glTF image has no data");let n=await nw(o,[BP,Qx],{...s,mimeType:t.mimeType,basis:s.basis||{format:Vx()}},r);n&&n[0]&&(n={compressed:!0,mipmaps:!1,width:n[0].width,height:n[0].height,data:n[0]}),e.images=e.images||[],e.images[i]=n}const lM={dataType:null,batchType:null,name:"glTF",id:"gltf",module:"gltf",version:"4.3.2",extensions:["gltf","glb"],mimeTypes:["model/gltf+json","model/gltf-binary"],text:!0,binary:!0,tests:["glTF"],parse:async function(e,t={},i){(t={...lM.options,...t}).gltf={...lM.options.gltf,...t.gltf};const{byteOffset:s=0}=t;return await nM({},e,s,t,i)},options:{gltf:{normalize:!0,loadBuffers:!0,loadImages:!0,decompressMeshes:!0},log:console}};const AM={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},cM={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4},hM=10240,uM=10241,dM=10242,pM=10243,fM=10497,mM={magFilter:hM,minFilter:uM,wrapS:dM,wrapT:pM},gM={[hM]:9729,[uM]:9986,[dM]:fM,[pM]:fM};class _M{baseUri="";jsonUnprocessed;json;buffers=[];images=[];postProcess(e,t={}){const{json:i,buffers:s=[],images:r=[]}=e,{baseUri:o=""}=e;return CP(i),this.baseUri=o,this.buffers=s,this.images=r,this.jsonUnprocessed=i,this.json=this._resolveTree(e.json,t),this.json}_resolveTree(e,t={}){const i={...e};return this.json=i,e.bufferViews&&(i.bufferViews=e.bufferViews.map(((e,t)=>this._resolveBufferView(e,t)))),e.images&&(i.images=e.images.map(((e,t)=>this._resolveImage(e,t)))),e.samplers&&(i.samplers=e.samplers.map(((e,t)=>this._resolveSampler(e,t)))),e.textures&&(i.textures=e.textures.map(((e,t)=>this._resolveTexture(e,t)))),e.accessors&&(i.accessors=e.accessors.map(((e,t)=>this._resolveAccessor(e,t)))),e.materials&&(i.materials=e.materials.map(((e,t)=>this._resolveMaterial(e,t)))),e.meshes&&(i.meshes=e.meshes.map(((e,t)=>this._resolveMesh(e,t)))),e.nodes&&(i.nodes=e.nodes.map(((e,t)=>this._resolveNode(e,t))),i.nodes=i.nodes.map(((e,t)=>this._resolveNodeChildren(e)))),e.skins&&(i.skins=e.skins.map(((e,t)=>this._resolveSkin(e,t)))),e.scenes&&(i.scenes=e.scenes.map(((e,t)=>this._resolveScene(e,t)))),"number"==typeof this.json.scene&&i.scenes&&(i.scene=i.scenes[this.json.scene]),i}getScene(e){return this._get(this.json.scenes,e)}getNode(e){return this._get(this.json.nodes,e)}getSkin(e){return this._get(this.json.skins,e)}getMesh(e){return this._get(this.json.meshes,e)}getMaterial(e){return this._get(this.json.materials,e)}getAccessor(e){return this._get(this.json.accessors,e)}getCamera(e){return this._get(this.json.cameras,e)}getTexture(e){return this._get(this.json.textures,e)}getSampler(e){return this._get(this.json.samplers,e)}getImage(e){return this._get(this.json.images,e)}getBufferView(e){return this._get(this.json.bufferViews,e)}getBuffer(e){return this._get(this.json.buffers,e)}_get(e,t){if("object"==typeof t)return t;const i=e&&e[t];return i||console.warn(`glTF file error: Could not find ${e}[${t}]`),i}_resolveScene(e,t){return{...e,id:e.id||`scene-${t}`,nodes:(e.nodes||[]).map((e=>this.getNode(e)))}}_resolveNode(e,t){const i={...e,id:e?.id||`node-${t}`};return void 0!==e.mesh&&(i.mesh=this.getMesh(e.mesh)),void 0!==e.camera&&(i.camera=this.getCamera(e.camera)),void 0!==e.skin&&(i.skin=this.getSkin(e.skin)),void 0!==e.meshes&&e.meshes.length&&(i.mesh=e.meshes.reduce(((e,t)=>{const i=this.getMesh(t);return e.id=i.id,e.primitives=e.primitives.concat(i.primitives),e}),{primitives:[]})),i}_resolveNodeChildren(e){return e.children&&(e.children=e.children.map((e=>this.getNode(e)))),e}_resolveSkin(e,t){const i="number"==typeof e.inverseBindMatrices?this.getAccessor(e.inverseBindMatrices):void 0;return{...e,id:e.id||`skin-${t}`,inverseBindMatrices:i}}_resolveMesh(e,t){const i={...e,id:e.id||`mesh-${t}`,primitives:[]};return e.primitives&&(i.primitives=e.primitives.map((e=>{const t={...e,attributes:{},indices:void 0,material:void 0},i=e.attributes;for(const e in i)t.attributes[e]=this.getAccessor(i[e]);return void 0!==e.indices&&(t.indices=this.getAccessor(e.indices)),void 0!==e.material&&(t.material=this.getMaterial(e.material)),t}))),i}_resolveMaterial(e,t){const i={...e,id:e.id||`material-${t}`};if(i.normalTexture&&(i.normalTexture={...i.normalTexture},i.normalTexture.texture=this.getTexture(i.normalTexture.index)),i.occlusionTexture&&(i.occlusionTexture={...i.occlusionTexture},i.occlusionTexture.texture=this.getTexture(i.occlusionTexture.index)),i.emissiveTexture&&(i.emissiveTexture={...i.emissiveTexture},i.emissiveTexture.texture=this.getTexture(i.emissiveTexture.index)),i.emissiveFactor||(i.emissiveFactor=i.emissiveTexture?[1,1,1]:[0,0,0]),i.pbrMetallicRoughness){i.pbrMetallicRoughness={...i.pbrMetallicRoughness};const e=i.pbrMetallicRoughness;e.baseColorTexture&&(e.baseColorTexture={...e.baseColorTexture},e.baseColorTexture.texture=this.getTexture(e.baseColorTexture.index)),e.metallicRoughnessTexture&&(e.metallicRoughnessTexture={...e.metallicRoughnessTexture},e.metallicRoughnessTexture.texture=this.getTexture(e.metallicRoughnessTexture.index))}return i}_resolveAccessor(e,t){const i=(s=e.componentType,cM[s]);var s;const r=(o=e.type,AM[o]);var o;const n=i*r,a={...e,id:e.id||`accessor-${t}`,bytesPerComponent:i,components:r,bytesPerElement:n,value:void 0,bufferView:void 0,sparse:void 0};if(void 0!==e.bufferView&&(a.bufferView=this.getBufferView(e.bufferView)),a.bufferView){const e=a.bufferView.buffer,{ArrayType:t,byteLength:i}=kP(a,a.bufferView),s=(a.bufferView.byteOffset||0)+(a.byteOffset||0)+e.byteOffset;let r=e.arrayBuffer.slice(s,s+i);a.bufferView.byteStride&&(r=this._getValueFromInterleavedBuffer(e,s,a.bufferView.byteStride,a.bytesPerElement,a.count)),a.value=new t(r)}return a}_getValueFromInterleavedBuffer(e,t,i,s,r){const o=new Uint8Array(r*s);for(let n=0;n<r;n++){const r=t+n*i;o.set(new Uint8Array(e.arrayBuffer.slice(r,r+s)),n*s)}return o.buffer}_resolveTexture(e,t){return{...e,id:e.id||`texture-${t}`,sampler:"number"==typeof e.sampler?this.getSampler(e.sampler):{id:"default-sampler",parameters:gM},source:"number"==typeof e.source?this.getImage(e.source):void 0}}_resolveSampler(e,t){const i={id:e.id||`sampler-${t}`,...e,parameters:{}};for(const e in i){const t=this._enumSamplerParameter(e);void 0!==t&&(i.parameters[t]=i[e])}return i}_enumSamplerParameter(e){return mM[e]}_resolveImage(e,t){const i={...e,id:e.id||`image-${t}`,image:null,bufferView:void 0!==e.bufferView?this.getBufferView(e.bufferView):void 0},s=this.images[t];return s&&(i.image=s),i}_resolveBufferView(e,t){const i=e.buffer,s=this.buffers[i].arrayBuffer;let r=this.buffers[i].byteOffset||0;e.byteOffset&&(r+=e.byteOffset);return{id:`bufferView-${t}`,...e,buffer:this.buffers[i],data:new Uint8Array(s,r,e.byteLength)}}_resolveCamera(e,t){return{...e,id:e.id||`camera-${t}`}}}class vM{constructor(e){}load(e,t,i,s,r,o,n){!function(e,t,i,s,r,o,n){const a=e.viewer.scene.canvas.spinner;a.processes++;"glb"===t.split(".").pop()?e.dataSource.getGLB(t,(l=>{s.basePath=bM(t),yM(e,t,l,i,s,r,o,n),a.processes--}),(e=>{a.processes--,n(e)})):e.dataSource.getGLTF(t,(l=>{s.basePath=bM(t),yM(e,t,l,i,s,r,o,n),a.processes--}),(e=>{a.processes--,n(e)}))}(e,t,i,s=s||{},r,(function(){I.scheduleTask((function(){r.scene.fire("modelLoaded",r.id),r.fire("loaded",!0,!1)})),o&&o()}),(function(t){e.error(t),n&&n(t),r.fire("error",t)}))}parse(e,t,i,s,r,o,n){yM(e,"",t,i,s=s||{},r,(function(){r.scene.fire("modelLoaded",r.id),r.fire("loaded",!0,!1),o&&o()}),(function(e){r.error(e),r.fire("error",e),n&&n(e)}))}}function bM(e){const t=e.lastIndexOf("/");return 0!==t?e.substring(0,t+1):""}function yM(e,t,i,s,r,o,n,a){const l=e.viewer.scene.canvas.spinner;l.processes++,tP(i,lM,{baseUri:r.basePath}).then((i=>{const a=function(e,t){return(new _M).postProcess(e,t)}(i),A={src:t,entityId:r.entityId,metaModelJSON:s,autoMetaModel:r.autoMetaModel,globalizeObjectIds:r.globalizeObjectIds,metaObjects:[],loadBuffer:r.loadBuffer,basePath:r.basePath,handlenode:r.handlenode,backfaces:!!r.backfaces,gltfData:a,scene:o.scene,plugin:e,sceneModel:o,numObjects:0,nodes:[],nextId:0,log:t=>{e.log(t)}};!function(e){const t=e.gltfData.textures;if(t)for(let i=0,s=t.length;i<s;i++)wM(e,t[i])}(A),function(e){const t=e.gltfData.materials;if(t)for(let i=0,s=t.length;i<s;i++){const s=t[i];s._textureSetId=BM(e,s),s._attributes=PM(e,s)}}(A),r.autoMetaModel&&A.metaObjects.push({id:o.id,type:"Default",name:o.id}),xM(A),o.finalize(),r.autoMetaModel&&e.viewer.metaScene.createMetaModel(o.id,{metaObjects:A.metaObjects}),l.processes--,n()})).catch((e=>{a&&a(e)}))}function wM(e,t){if(!t.source||!t.source.image)return;const i="texture-"+e.nextId++;let s=1005;switch(t.sampler.minFilter){case 9728:s=1003;break;case 9729:s=1006;break;case 9984:s=1004;break;case 9985:s=1007;break;case 9986:s=1005;break;case 9987:s=1008}let r=1006;switch(t.sampler.magFilter){case 9728:r=1003;break;case 9729:r=1006}let o=1e3;switch(t.sampler.wrapS){case 33071:o=1001;break;case 33648:o=1002;break;case 10497:o=1e3}let n=1e3;switch(t.sampler.wrapT){case 33071:n=1001;break;case 33648:n=1002;break;case 10497:n=1e3}let a=1e3;switch(t.sampler.wrapR){case 33071:a=1001;break;case 33648:a=1002;break;case 10497:a=1e3}e.sceneModel.createTexture({id:i,image:t.source.image,flipY:!!t.flipY,minFilter:s,magFilter:r,wrapS:o,wrapT:n,wrapR:a,encoding:3001}),t._textureId=i}function BM(e,t){const i={};switch(t.normalTexture&&(i.normalTextureId=t.normalTexture.texture._textureId),t.occlusionTexture&&(i.occlusionTextureId=t.occlusionTexture.texture._textureId),t.emissiveTexture&&(i.emissiveTextureId=t.emissiveTexture.texture._textureId),t.alphaMode){case"OPAQUE":break;case"MASK":const e=t.alphaCutoff;i.alphaCutoff=void 0!==e?e:.5}const s=t.pbrMetallicRoughness;if(t.pbrMetallicRoughness){const r=t.pbrMetallicRoughness,o=r.baseColorTexture||r.colorTexture;o&&(o.texture?i.colorTextureId=o.texture._textureId:i.colorTextureId=e.gltfData.textures[o.index]._textureId),s.metallicRoughnessTexture&&(i.metallicRoughnessTextureId=s.metallicRoughnessTexture.texture._textureId)}const r=t.extensions;if(r){const t=r.KHR_materials_pbrSpecularGlossiness;if(t){t.specularTexture;const s=t.specularColorTexture;null!=s&&(i.colorTextureId=e.gltfData.textures[s.index]._textureId)}}return void 0!==i.normalTextureId||void 0!==i.occlusionTextureId||void 0!==i.emissiveTextureId||void 0!==i.colorTextureId||void 0!==i.metallicRoughnessTextureId?(i.id=`textureSet-${e.nextId++};`,e.sceneModel.createTextureSet(i),i.id):null}function PM(e,t){const i=t.extensions,s={color:new Float32Array([1,1,1,1]),opacity:1,metallic:0,roughness:1,doubleSided:!0};if(i){const e=i.KHR_materials_pbrSpecularGlossiness;if(e){const t=e.diffuseFactor;null!=t&&s.color.set(t)}const t=i.KHR_materials_common;if(t){const e=t.technique,i=t.values||{},r="BLINN"===e,o="PHONG"===e,n="LAMBERT"===e,a=i.diffuse;a&&(r||o||n)&&(y.isString(a)||s.color.set(a));const l=i.transparency;null!=l&&(s.opacity=l);const A=i.transparent;null!=A&&(s.opacity=A)}}const r=t.pbrMetallicRoughness;if(r){const e=r.baseColorFactor;e&&(s.color[0]=e[0],s.color[1]=e[1],s.color[2]=e[2],s.opacity=e[3]);const t=r.metallicFactor;null!=t&&(s.metallic=t);const i=r.roughnessFactor;null!=i&&(s.roughness=i)}return s.doubleSided=!1!==t.doubleSided,s}function xM(e){const t=e.gltfData,i=t.scene||t.scenes[0];if(!i)return void function(e,t){e.plugin.error(t)}(e,"glTF has no default scene");const s=i.nodes;if(!s)return;!function e(t){t.forEach((t=>{const i=t.mesh;i&&(i.instances||=0,i.instances+=1),t.children&&e(t.children)}))}(s);const r=[];let o=null;!function t(i,s,n){i.forEach((i=>{const a=i.name;let l=null!=a&&a||0===s&&"entity-"+e.nextId++;if(l){for(;e.sceneModel.objects[l];)l="entity-"+e.nextId++;r.push(o),o=[]}const A=function(e,t){let i;e.matrix&&(i=e.matrix,t=t?d.mulMat4(t,i,d.mat4()):i);e.translation&&(i=d.translationMat4v(e.translation),t=t?d.mulMat4(t,i,d.mat4()):i);e.rotation&&(i=d.quaternionToMat4(e.rotation),t=t?d.mulMat4(t,i,d.mat4()):i);e.scale&&(i=d.scalingMat4v(e.scale),t=t?d.mulMat4(t,i,d.mat4()):i);return t}(i,n);if(i.mesh&&function(e,t,i,s){const r=e.mesh;if(!r)return;const o=r.primitives.length;if(o>0)for(let e=0;e<o;e++){const o=r.primitives[e];if(o.mode<4)continue;const n={id:t.sceneModel.id+"."+t.numObjects++},a=o.material;a?(n.textureSetId=a._textureSetId,n.color=a._attributes.color,n.opacity=a._attributes.opacity,n.metallic=a._attributes.metallic,n.roughness=a._attributes.roughness):(n.color=new Float32Array([1,1,1]),n.opacity=1);const l=!1!==t.backfaces||a&&!1!==a.doubleSided;switch(o.mode){case 0:n.primitive="points";break;case 1:case 2:case 3:n.primitive="lines";break;default:n.primitive=l?"triangles":"solid"}const A=o.attributes.POSITION;if(!A)continue;n.localPositions=A.value,n.positions=new Float64Array(n.localPositions.length),o.attributes.NORMAL&&(n.normals=o.attributes.NORMAL.value),o.attributes.TEXCOORD_0&&(n.uv=o.attributes.TEXCOORD_0.value),o.indices&&(n.indices=o.indices.value),i?d.transformPositions3(i,n.localPositions,n.positions):n.positions.set(n.localPositions);const c=d.vec3();$e(n.positions,n.positions,c)&&(n.origin=c),t.sceneModel.createMesh(n),s.push(n.id)}}(i,e,A,o),i.children&&t(i.children,s+1,A),l){if(o.length>0){const t=e.globalizeObjectIds?d.globalizeObjectId(e.sceneModel.id,l):l;e.sceneModel.createEntity({id:t,meshIds:o,isObject:!0}),e.autoMetaModel&&e.metaObjects.push({id:t,type:"Default",name:t,parent:e.sceneModel.id})}o=r.pop()}}))}(s,0,null)}const CM={DEFAULT:{}};class MM extends ph{constructor(e,t={}){super("GLTFLoader",e,t),this._sceneModelLoader=new vM(this,t),this.dataSource=t.dataSource,this.objectDefaults=t.objectDefaults}set dataSource(e){this._dataSource=e||new ow}get dataSource(){return this._dataSource}set objectDefaults(e){this._objectDefaults=e||CM}get objectDefaults(){return this._objectDefaults}load(e={}){e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);const t=new Tc(this.viewer.scene,y.apply(e,{isModel:!0,dtxEnabled:e.dtxEnabled})),i=t.id;if(!e.src&&!e.gltf)return this.error("load() param expected: src or gltf"),t;if(e.metaModelSrc||e.metaModelJSON){const s=s=>{this.viewer.metaScene.createMetaModel(i,s,{}),this.viewer.scene.canvas.spinner.processes--,e.src?this._sceneModelLoader.load(this,e.src,s,e,t):this._sceneModelLoader.parse(this,e.gltf,s,e,t)};if(e.metaModelSrc){const t=e.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(t,(e=>{this.viewer.scene.canvas.spinner.processes--,s(e)}),(e=>{this.error(`load(): Failed to load model metadata for model '${i} from  '${t}' - ${e}`),this.viewer.scene.canvas.spinner.processes--}))}else e.metaModelJSON&&s(e.metaModelJSON)}else e.src?this._sceneModelLoader.load(this,e.src,null,e,t):this._sceneModelLoader.parse(this,e.gltf,null,e,t);return t.once("destroyed",(()=>{this.viewer.metaScene.destroyMetaModel(i)})),t}destroy(){super.destroy()}}function EM(e,t,i={}){const s="lightgrey",r=i.hoverColor||"rgba(0,0,0,0.4)",o=i.textColor||"black",n=i.canvasElement||document.body,a=500,l=a+a/3,A=l/24,c=[{boundary:[6,6,6,6],color:i.frontColor||i.color||"#55FF55"},{boundary:[18,6,6,6],color:i.backColor||i.color||"#55FF55"},{boundary:[12,6,6,6],color:i.rightColor||i.color||"#FF5555"},{boundary:[0,6,6,6],color:i.leftColor||i.color||"#FF5555"},{boundary:[6,0,6,6],color:i.topColor||i.color||"#7777FF"},{boundary:[6,12,6,6],color:i.bottomColor||i.color||"#7777FF"}],h=[{label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,1,0],up:[0,0,1]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,-1,0],up:[0,0,1]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,0,1]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,0,1]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,0,1],up:[0,-1,0]},{boundaries:[[7,5,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,0,-1],up:[1,0,1]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-1,-1],up:[0,-1,1]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,0,-1],up:[-1,0,1]},{boundaries:[[7,11,4,2]],dir:[0,1,1],up:[0,-1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,0,1],up:[-1,0,1]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,-1,1],up:[0,1,1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,0,1],up:[1,0,1]},{boundaries:[[5,7,2,4]],dir:[1,1,0],up:[0,0,1]},{boundaries:[[11,7,2,4]],dir:[-1,1,0],up:[0,0,1]},{boundaries:[[17,7,2,4]],dir:[-1,-1,0],up:[0,0,1]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,-1,0],up:[0,0,1]},{boundaries:[[5,11,2,2]],dir:[1,1,1],up:[-1,-1,1]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[1,-1,1],up:[-1,1,1]},{boundaries:[[5,5,2,2]],dir:[1,1,-1],up:[1,1,1]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-1,-1,1],up:[1,1,1]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-1,-1,-1],up:[-1,-1,1]},{boundaries:[[11,11,2,2]],dir:[-1,1,1],up:[1,-1,1]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[1,-1,-1],up:[1,-1,1]},{boundaries:[[11,5,2,2]],dir:[-1,1,-1],up:[-1,1,1]}];i.frontColor||i.color,i.backColor||i.color,i.rightColor||i.color,i.leftColor||i.color,i.topColor||i.color,i.bottomColor||i.color;const u=[{yUp:"",label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,0,1],up:[0,1,0]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,1,0]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,1,0]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,-1,0],up:[0,0,-1]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,1,0],up:[0,0,1]},{boundaries:[[7,5,4,2]],dir:[0,-.7071,-.7071],up:[0,.7071,-.7071]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,-1,0],up:[1,1,0]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-.7071,.7071],up:[0,.7071,.7071]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,-1,0],up:[-1,1,0]},{boundaries:[[7,11,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,1,0],up:[-1,1,0]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,1,1],up:[0,1,-1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,1,0],up:[1,1,0]},{boundaries:[[5,7,2,4]],dir:[1,0,-1],up:[0,1,0]},{boundaries:[[11,7,2,4]],dir:[-1,0,-1],up:[0,1,0]},{boundaries:[[17,7,2,4]],dir:[-1,0,1],up:[0,1,0]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,0,1],up:[0,1,0]},{boundaries:[[5,11,2,2]],dir:[.5,.7071,-.5],up:[-.5,.7071,.5]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[.5,.7071,.5],up:[-.5,.7071,-.5]},{boundaries:[[5,5,2,2]],dir:[.5,-.7071,-.5],up:[.5,.7071,-.5]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-.5,.7071,.5],up:[.5,.7071,-.5]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-.5,-.7071,.5],up:[-.5,.7071,.5]},{boundaries:[[11,11,2,2]],dir:[-.5,.7071,-.5],up:[.5,.7071,.5]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[.5,-.7071,.5],up:[.5,.7071,.5]},{boundaries:[[11,5,2,2]],dir:[-.5,-.7071,-.5],up:[-.5,.7071,-.5]}];for(let e=0,t=h.length;e<t;e++)d.normalizeVec3(h[e].dir,h[e].dir),d.normalizeVec3(h[e].up,h[e].up);for(let e=0,t=u.length;e<t;e++)d.normalizeVec3(u[e].dir,u[e].dir),d.normalizeVec3(u[e].up,u[e].up);var p=u;this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=l,this._textureCanvas.height=a,this._textureCanvas.style.width=l+"px",this._textureCanvas.style.height="500px",this._textureCanvas.style.padding="0",this._textureCanvas.style.margin="0",this._textureCanvas.style.top="0",this._textureCanvas.style.background=s,this._textureCanvas.style.position="absolute",this._textureCanvas.style.opacity="1.0",this._textureCanvas.style.visibility="hidden",this._textureCanvas.style["z-index"]=2e6,n.appendChild(this._textureCanvas);const f=this._textureCanvas.getContext("2d");let m=!1;function g(){for(let e=0,t=c.length;e<t;e++){const t=c[e],i=t.boundary,s=Math.round(i[0]*A),r=Math.round(i[1]*A),o=Math.round(i[2]*A),n=Math.round(i[3]*A);f.fillStyle=t.color,f.fillRect(s,r,o,n)}for(let t=0,l=p.length;t<l;t++){let l,c,h,u;const d=p[t],m=d.boundaries;for(var e=0,i=m.length;e<i;e++){const t=m[e];l=Math.round(t[0]*A),c=Math.round(t[1]*A),h=Math.round(t[2]*A),u=Math.round(t[3]*A),d.highlighted&&(f.fillStyle=d.highlighted?r:d.color||s,f.fillRect(l,c,h,u))}if(d.label){f.fillStyle=o,f.font="60px sans-serif",f.textAlign="center";var n=l+.5*h,a=c+.7*u;f.fillText(_(d.label),n,a,80)}}t.glRedraw()}const _=function(){const t={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},i={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},s={"NavCube.front":"FRONT","NavCube.back":"BACK","NavCube.right":"RIGHT","NavCube.left":"LEFT","NavCube.top":"TOP","NavCube.bottom":"BOTTOM"};return function(r){const o=m?i:t,n=o?o[r]:null;return n?e.localeService.translate(n)||s[n]||n:r}}();this.setZUp=function(){m=!0,p=h,this.clear()},this.setYUp=function(){m=!1,p=u,this.clear()},this.clear=function(){f.fillStyle=s,f.fillRect(0,0,l,a);for(var e=0,t=p.length;e<t;e++){p[e].highlighted=!1}g()},this.getArea=function(e){const t=e[0]*l,i=a-e[1]*a;for(var s=0,r=p.length;s<r;s++){const e=p[s].boundaries;for(var o=0,n=e.length;o<n;o++){const r=e[o];if(t>=r[0]*A&&t<=(r[0]+r[2])*A&&i>=r[1]*A&&i<=(r[1]+r[3])*A)return s}}return-1},this.setAreaHighlighted=function(e,t){var i=p[e];if(!i)throw"Area not found: "+e;i.highlighted=!!t,g()},this.getAreaDir=function(e){var t=p[e];if(!t)throw"Unknown area: "+e;return t.dir},this.getAreaUp=function(e){var t=p[e];if(!t)throw"Unknown area: "+e;return t.up},this.getImage=function(){return this._textureCanvas},this.destroy=function(){this._textureCanvas&&(this._textureCanvas.parentNode.removeChild(this._textureCanvas),this._textureCanvas=null)}}const FM=d.vec3(),IM=d.vec3();d.mat4();class TM extends ph{constructor(e,t={}){super("NavCube",e,t),e.navCube=this;try{this._navCubeScene=new Xu(e,{canvasId:t.canvasId,canvasElement:t.canvasElement,transparent:!0}),this._navCubeCanvas=this._navCubeScene.canvas.canvas,this._navCubeScene.input.keyboardEnabled=!1}catch(e){return void this.error(e)}const i=this._navCubeScene;i.clearLights(),new kc(i,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new kc(i,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new kc(i,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._navCubeCamera=i.camera,this._navCubeCamera.ortho.scale=7,this._navCubeCamera.ortho.near=.1,this._navCubeCamera.ortho.far=2e3,i.edgeMaterial.edgeColor=[.2,.2,.2],i.edgeMaterial.edgeAlpha=.6,this._zUp=Boolean(e.camera.zUp);var s=this;this.setIsProjectNorth(t.isProjectNorth),this.setProjectNorthOffsetAngle(t.projectNorthOffsetAngle);const r=function(){const e=d.mat4();return function(t,i,r){return d.identityMat4(e),d.rotationMat4v(t*s._projectNorthOffsetAngle*d.DEGTORAD,[0,1,0],e),d.transformVec3(e,i,r)}}();this._synchCamera=function(){var t=d.rotationMat4c(-90*d.DEGTORAD,1,0,0),i=d.vec3(),o=d.vec3(),n=d.vec3();return function(){var a=e.camera.eye,l=e.camera.look,A=e.camera.up;i=d.mulVec3Scalar(d.normalizeVec3(d.subVec3(a,l,i)),5),s._isProjectNorth&&s._projectNorthOffsetAngle&&(i=r(-1,i,FM),A=r(-1,A,IM)),s._zUp?(d.transformVec3(t,i,o),d.transformVec3(t,A,n),s._navCubeCamera.look=[0,0,0],s._navCubeCamera.eye=d.transformVec3(t,i,o),s._navCubeCamera.up=d.transformPoint3(t,A,n)):(s._navCubeCamera.look=[0,0,0],s._navCubeCamera.eye=i,s._navCubeCamera.up=A)}}(),this._cubeTextureCanvas=new EM(e,i,t),this._cubeSampler=new Is(i,{image:this._cubeTextureCanvas.getImage(),flipY:!0,wrapS:1001,wrapT:1001}),this._cubeMesh=new fs(i,{geometry:new ve(i,{primitive:"triangles",normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),material:new bs(i,{diffuse:[.4,.4,.4],specular:[.4,.4,.4],emissive:[.6,.6,.6],diffuseMap:this._cubeSampler,emissiveMap:this._cubeSampler}),visible:!0,edges:!0}),this._shadow=!1===t.shadowVisible?null:new fs(i,{geometry:new ve(i,Fe({center:[0,0,0],radiusTop:.001,radiusBottom:1.4,height:.01,radialSegments:20,heightSegments:1,openEnded:!0})),material:new bs(i,{diffuse:[0,0,0],specular:[0,0,0],emissive:[0,0,0],alpha:.5}),position:[0,-1.5,0],visible:!0,pickable:!1,backfaces:!1}),this._onCameraMatrix=e.camera.on("matrix",this._synchCamera),this._onCameraWorldAxis=e.camera.on("worldAxis",(()=>{e.camera.zUp?(this._zUp=!0,this._cubeTextureCanvas.setZUp(),this._repaint(),this._synchCamera()):e.camera.yUp&&(this._zUp=!1,this._cubeTextureCanvas.setYUp(),this._repaint(),this._synchCamera())})),this._onCameraFOV=e.camera.perspective.on("fov",(e=>{this._synchProjection&&(this._navCubeCamera.perspective.fov=e)})),this._onCameraProjection=e.camera.on("projection",(e=>{this._synchProjection&&(this._navCubeCamera.projection="ortho"===e||"perspective"===e?e:"perspective")}));var o=-1;function n(e){var t=[0,0];if(e){for(var i=e.target,s=0,r=0;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t[0]=e.x,t[1]=e.y;return t}var a,l,A=null,c=null,h=!1,u=!1,p=.5;s._navCubeCanvas.addEventListener("mouseenter",s._onMouseEnter=function(e){u=!0}),s._navCubeCanvas.addEventListener("mouseleave",s._onMouseLeave=function(e){u=!1}),s._navCubeCanvas.addEventListener("mousedown",s._onMouseDown=function(e){if(1===e.which){A=e.x,c=e.y,a=e.clientX,l=e.clientY;var t=n(e),s=i.pick({canvasPos:t});h=!!s}}),s._navCubeCanvas.addEventListener("mouseup",s._onMouseUp=function(e){if(1===e.which&&(h=!1,null!==A)){var t=n(e),a=i.pick({canvasPos:t,pickSurface:!0});if(a&&a.uv){var l=s._cubeTextureCanvas.getArea(a.uv);if(l>=0&&(s._navCubeCanvas.style.cursor="pointer",o>=0&&(s._cubeTextureCanvas.setAreaHighlighted(o,!1),s._repaint(),o=-1),l>=0)){if(s._cubeTextureCanvas.setAreaHighlighted(l,!0),o=l,s._repaint(),e.x<A-3||e.x>A+3||e.y<c-3||e.y>c+3)return;var u=s._cubeTextureCanvas.getAreaDir(l);if(u){var d=s._cubeTextureCanvas.getAreaUp(l);s._isProjectNorth&&s._projectNorthOffsetAngle&&(u=r(1,u,FM),d=r(1,d,IM)),f(u,d,(function(){o>=0&&(s._cubeTextureCanvas.setAreaHighlighted(o,!1),s._repaint(),o=-1),s._navCubeCanvas.style.cursor="pointer",o>=0&&(s._cubeTextureCanvas.setAreaHighlighted(o,!1),s._repaint(),o=-1),l>=0&&(s._cubeTextureCanvas.setAreaHighlighted(l,!1),o=-1,s._repaint())}))}}}}}),s._navCubeCanvas.addEventListener("mousemove",s._onMouseMove=function(t){if(o>=0&&(s._cubeTextureCanvas.setAreaHighlighted(o,!1),s._repaint(),o=-1),1!==t.buttons||h){if(h){var r=t.clientX,A=t.clientY;return s._navCubeCanvas.style.cursor="move",void function(t,i){var s=(t-a)*-p,r=(i-l)*-p;e.camera.orbitYaw(s),e.camera.orbitPitch(-r),a=t,l=i}(r,A)}if(u){var c=n(t),d=i.pick({canvasPos:c,pickSurface:!0});if(d){if(d.uv){s._navCubeCanvas.style.cursor="pointer";var f=s._cubeTextureCanvas.getArea(d.uv);if(f===o)return;o>=0&&s._cubeTextureCanvas.setAreaHighlighted(o,!1),f>=0&&(s._cubeTextureCanvas.setAreaHighlighted(f,!0),s._repaint(),o=f)}}else s._navCubeCanvas.style.cursor="default",o>=0&&(s._cubeTextureCanvas.setAreaHighlighted(o,!1),s._repaint(),o=-1)}}});var f=function(){var t=d.vec3();return function(i,r,o){var n=s._fitVisible?e.scene.getAABB(e.scene.visibleObjectIds):e.scene.aabb,a=d.getAABB3Diag(n);d.getAABB3Center(n,t);var l=Math.abs(a/Math.tan(s._cameraFitFOV*d.DEGTORAD));e.cameraControl.pivotPos=t,s._cameraFly?e.cameraFlight.flyTo({look:t,eye:[t[0]-l*i[0],t[1]-l*i[1],t[2]-l*i[2]],up:r||[0,1,0],orthoScale:1.1*a,fitFOV:s._cameraFitFOV,duration:s._cameraFlyDuration},o):e.cameraFlight.jumpTo({look:t,eye:[t[0]-l*i[0],t[1]-l*i[1],t[2]-l*i[2]],up:r||[0,1,0],orthoScale:1.1*a,fitFOV:s._cameraFitFOV},o)}}();this._onUpdated=e.localeService.on("updated",(()=>{this._cubeTextureCanvas.clear(),this._repaint()})),this.setVisible(t.visible),this.setCameraFitFOV(t.cameraFitFOV),this.setCameraFly(t.cameraFly),this.setCameraFlyDuration(t.cameraFlyDuration),this.setFitVisible(t.fitVisible),this.setSynchProjection(t.synchProjection)}send(e,t){if("language"===e)this._cubeTextureCanvas.clear(),this._repaint()}_repaint(){const e=this._cubeTextureCanvas.getImage();this._cubeMesh.material.diffuseMap.image=e,this._cubeMesh.material.emissiveMap.image=e}setVisible(e=!0){this._navCubeCanvas&&(this._cubeMesh.visible=e,this._shadow&&(this._shadow.visible=e),this._navCubeCanvas.style.visibility=e?"visible":"hidden")}getVisible(){return!!this._navCubeCanvas&&this._cubeMesh.visible}setFitVisible(e=!1){this._fitVisible=e}getFitVisible(){return this._fitVisible}setCameraFly(e=!0){this._cameraFly=e}getCameraFly(){return this._cameraFly}setCameraFitFOV(e=45){this._cameraFitFOV=e}getCameraFitFOV(){return this._cameraFitFOV}setCameraFlyDuration(e=.5){this._cameraFlyDuration=e}getCameraFlyDuration(){return this._cameraFlyDuration}setSynchProjection(e=!1){this._synchProjection=e}getSynchProjection(){return this._synchProjection}setIsProjectNorth(e=!1){this._isProjectNorth=e}getIsProjectNorth(){return this._isProjectNorth}setProjectNorthOffsetAngle(e){this._projectNorthOffsetAngle=e}getProjectNorthOffsetAngle(){return this._projectNorthOffsetAngle}destroy(){this._navCubeCanvas&&(this.viewer.localeService.off(this._onUpdated),this.viewer.camera.off(this._onCameraMatrix),this.viewer.camera.off(this._onCameraWorldAxis),this.viewer.camera.perspective.off(this._onCameraFOV),this.viewer.camera.off(this._onCameraProjection),this._navCubeCanvas.removeEventListener("mouseenter",this._onMouseEnter),this._navCubeCanvas.removeEventListener("mouseleave",this._onMouseLeave),this._navCubeCanvas.removeEventListener("mousedown",this._onMouseDown),this._navCubeCanvas.removeEventListener("mousemove",this._onMouseMove),this._navCubeCanvas.removeEventListener("mouseup",this._onMouseUp),this._navCubeCanvas=null,this._cubeTextureCanvas.destroy(),this._cubeTextureCanvas=null,this._onMouseEnter=null,this._onMouseLeave=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null),this._navCubeScene.destroy(),this._navCubeScene=null,this._cubeMesh=null,this._shadow=null,super.destroy()}}const DM=d.vec3();class SM{load(e,t,i={}){var s=e.scene.canvas.spinner;s.processes++,RM(e,t,(function(t){!function(e,t,i){for(var s=t.basePath,r=Object.keys(t.materialLibraries),o=r.length,n=0,a=o;n<a;n++)LM(e,s,s+r[n],(function(){0==--o&&i()}))}(e,t,(function(){OM(e,t),s.processes--,I.scheduleTask((function(){e.fire("loaded",!0,!1)}))}))}))}parse(e,t,i,s){if(t){var r=UM(e,t,null);i&&kM(e,i,s),OM(e,r),e.src=null,e.fire("loaded",!0,!1)}else this.warn("load() param expected: objText")}}var RM=function(e,t,i){NM(t,(function(s){var r=UM(e,s,t);i(r)}),(function(t){e.error(t)}))},UM=function(){const e={vertex_pattern:/^v\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,normal_pattern:/^vn\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,uv_pattern:/^vt\s+([\d|\.|\+|\-|e|E]+)\s+([\d|\.|\+|\-|e|E]+)/,face_vertex:/^f\s+(-?\d+)\s+(-?\d+)\s+(-?\d+)(?:\s+(-?\d+))?/,face_vertex_uv:/^f\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+))?/,face_vertex_uv_normal:/^f\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)\s+(-?\d+)\/(-?\d+)\/(-?\d+)(?:\s+(-?\d+)\/(-?\d+)\/(-?\d+))?/,face_vertex_normal:/^f\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)\s+(-?\d+)\/\/(-?\d+)(?:\s+(-?\d+)\/\/(-?\d+))?/,object_pattern:/^[og]\s*(.+)?/,smoothing_pattern:/^s\s+(\d+|on|off)/,material_library_pattern:/^mtllib /,material_use_pattern:/^usemtl /};return function(i,s,r){var o,n,a={src:r=r||"",basePath:(o=r,n=o.lastIndexOf("/"),-1===n?o:o.substring(0,n+1)),objects:[],object:{},positions:[],normals:[],uv:[],materialLibraries:{}};t(a,"",!1),-1!==s.indexOf("\r\n")&&(s=s.replace("\r\n","\n"));for(var l=s.split("\n"),A="",u="",d="",p=[],f="function"==typeof"".trimLeft,m=0,g=l.length;m<g;m++)if(A=l[m],0!==(A=f?A.trimLeft():A.trim()).length&&"#"!==(u=A.charAt(0)))if("v"===u)if(" "===(d=A.charAt(1))&&null!==(p=e.vertex_pattern.exec(A)))a.positions.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3]));else if("n"===d&&null!==(p=e.normal_pattern.exec(A)))a.normals.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3]));else{if("t"!==d||null===(p=e.uv_pattern.exec(A)))return void i.error("Unexpected vertex/normal/uv line: '"+A+"'");a.uv.push(parseFloat(p[1]),parseFloat(p[2]))}else if("f"===u)if(null!==(p=e.face_vertex_uv_normal.exec(A)))c(a,p[1],p[4],p[7],p[10],p[2],p[5],p[8],p[11],p[3],p[6],p[9],p[12]);else if(null!==(p=e.face_vertex_uv.exec(A)))c(a,p[1],p[3],p[5],p[7],p[2],p[4],p[6],p[8]);else if(null!==(p=e.face_vertex_normal.exec(A)))c(a,p[1],p[3],p[5],p[7],void 0,void 0,void 0,void 0,p[2],p[4],p[6],p[8]);else{if(null===(p=e.face_vertex.exec(A)))return void i.error("Unexpected face line: '"+A+"'");c(a,p[1],p[2],p[3],p[4])}else if("l"===u){var _=A.substring(1).trim().split(" "),v=[],b=[];if(-1===A.indexOf("/"))v=_;else for(var y=0,w=_.length;y<w;y++){var B=_[y].split("/");""!==B[0]&&v.push(B[0]),""!==B[1]&&b.push(B[1])}h(a,v,b)}else if(null!==(p=e.object_pattern.exec(A))){t(a,P=p[0].substr(1).trim(),!0)}else if(e.material_use_pattern.test(A)){var P=A.substring(7).trim();a.object.material.id=P}else if(e.material_library_pattern.test(A))a.materialLibraries[A.substring(7).trim()]=!0;else{if(null===(p=e.smoothing_pattern.exec(A))){if("\0"===A)continue;return void i.error("Unexpected line: '"+A+"'")}var x=p[1].trim().toLowerCase();a.object.material.smooth="1"===x||"on"===x}return a};function t(e,t,i){if(e.object&&!1===e.object.fromDeclaration)return e.object.id=t,void(e.object.fromDeclaration=!1!==i);e.object={id:t||"",geometry:{positions:[],normals:[],uv:[]},material:{id:"",smooth:!0},fromDeclaration:!1!==i},e.objects.push(e.object)}function i(e,t){var i=parseInt(e,10);return 3*(i>=0?i-1:i+t/3)}function s(e,t){var i=parseInt(e,10);return 3*(i>=0?i-1:i+t/3)}function r(e,t){var i=parseInt(e,10);return 2*(i>=0?i-1:i+t/2)}function o(e,t,i,s){var r=e.positions,o=e.object.geometry.positions;o.push(r[t+0]),o.push(r[t+1]),o.push(r[t+2]),o.push(r[i+0]),o.push(r[i+1]),o.push(r[i+2]),o.push(r[s+0]),o.push(r[s+1]),o.push(r[s+2])}function n(e,t){var i=e.positions,s=e.object.geometry.positions;s.push(i[t+0]),s.push(i[t+1]),s.push(i[t+2])}function a(e,t,i,s){var r=e.normals,o=e.object.geometry.normals;o.push(r[t+0]),o.push(r[t+1]),o.push(r[t+2]),o.push(r[i+0]),o.push(r[i+1]),o.push(r[i+2]),o.push(r[s+0]),o.push(r[s+1]),o.push(r[s+2])}function l(e,t,i,s){var r=e.uv,o=e.object.geometry.uv;o.push(r[t+0]),o.push(r[t+1]),o.push(r[i+0]),o.push(r[i+1]),o.push(r[s+0]),o.push(r[s+1])}function A(e,t){var i=e.uv,s=e.object.geometry.uv;s.push(i[t+0]),s.push(i[t+1])}function c(e,t,n,A,c,h,u,d,p,f,m,g,_){var v,b=e.positions.length,y=i(t,b),w=i(n,b),B=i(A,b);if(void 0===c?o(e,y,w,B):(o(e,y,w,v=i(c,b)),o(e,w,B,v)),void 0!==h){var P=e.uv.length;y=r(h,P),w=r(u,P),B=r(d,P),void 0===c?l(e,y,w,B):(l(e,y,w,v=r(p,P)),l(e,w,B,v))}if(void 0!==f){var x=e.normals.length;y=s(f,x),w=f===m?y:s(m,x),B=f===g?y:s(g,x),void 0===c?a(e,y,w,B):(a(e,y,w,v=s(_,x)),a(e,w,B,v))}}function h(e,t,s){e.object.geometry.type="Line";for(var o=e.positions.length,a=e.uv.length,l=0,c=t.length;l<c;l++)n(e,i(t[l],o));for(var h=0,u=s.length;h<u;h++)A(e,r(s[h],a))}}();var LM=function(e,t,i,s){NM(i,(function(i){kM(e,i,t),s()}),(function(t){e.error(t),s()}))},kM=function(){var e=/\s+/;return function(e,r,o){var n,a,l,A,c,h=r.split("\n"),u={id:"Default"},d=!1;o=o||"";for(var p=0;p<h.length;p++)if(0!==(n=h[p].trim()).length&&"#"!==n.charAt(0))switch(l=(l=(a=n.indexOf(" "))>=0?n.substring(0,a):n).toLowerCase(),A=(A=a>=0?n.substring(a+1):"").trim(),l.toLowerCase()){case"newmtl":i(e,u),u={id:A},d=!0;break;case"ka":u.ambient=s(A);break;case"kd":u.diffuse=s(A);break;case"ks":u.specular=s(A);break;case"map_kd":u.diffuseMap||(u.diffuseMap=t(e,o,A,"sRGB"));break;case"map_ks":u.specularMap||(u.specularMap=t(e,o,A,"linear"));break;case"map_bump":case"bump":u.normalMap||(u.normalMap=t(e,o,A));break;case"ns":u.shininess=parseFloat(A);break;case"d":(c=parseFloat(A))<1&&(u.alpha=c,u.alphaMode="blend");break;case"tr":(c=parseFloat(A))>0&&(u.alpha=1-c,u.alphaMode="blend")}d&&i(e,u)};function t(e,t,i,s){var r={},o=i.split(/\s+/),n=o.indexOf("-bm");return n>=0&&o.splice(n,2),(n=o.indexOf("-s"))>=0&&(r.scale=[parseFloat(o[n+1]),parseFloat(o[n+2])],o.splice(n,4)),(n=o.indexOf("-o"))>=0&&(r.translate=[parseFloat(o[n+1]),parseFloat(o[n+2])],o.splice(n,4)),r.src=t+o.join(" ").trim(),r.flipY=!0,r.encoding=s||"linear",new Is(e,r).id}function i(e,t){new bs(e,t)}function s(t){var i=t.split(e,3);return[parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2])]}}();function OM(e,t){for(var i=0,s=t.objects.length;i<s;i++){var r=t.objects[i],o=r.geometry;if(o.type,0===o.positions.length)continue;var n={primitive:"triangles",compressGeometry:!1};n.positions=o.positions,o.normals.length>0&&(n.normals=o.normals),o.uv.length>0&&(n.uv=o.uv);for(var a=new Array(n.positions.length/3),l=0;l<a.length;l++)a[l]=l;n.indices=a;const s=DM;$e(o.positions,o.positions,s);var A,c=new ve(e,n),h=r.material.id;h&&""!==h?(A=e.scene.components[h])||e.error("Material not found: "+h):A=new bs(e,{diffuse:[.6,.6,.6],backfaces:!0});var u=new fs(e,{id:e.id+"#"+r.id,origin:0!==s[0]||0!==s[1]||0!==s[2]?s:null,isObject:!0,geometry:c,material:A,pickable:!0});e.addChild(u)}}function NM(e,t,i){var s=new XMLHttpRequest;s.open("GET",e,!0),s.addEventListener("load",(function(e){var s=e.target.response;200===this.status?t&&t(s):0===this.status?(console.warn("loadFile: HTTP Status 0 received."),t&&t(s)):i&&i(e)}),!1),s.addEventListener("error",(function(e){i&&i(e)}),!1),s.send(null)}class VM extends ph{constructor(e,t){super("OBJLoader",e,t),this._sceneGraphLoader=new SM}load(e={}){e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);var t=new Ke(this.viewer.scene,y.apply(e,{isModel:!0}));const i=t.id,s=e.src;if(!s)return this.error("load() param expected: src"),t;if(e.metaModelSrc){const r=e.metaModelSrc;y.loadJSON(r,(r=>{this.viewer.metaScene.createMetaModel(i,r),this._sceneGraphLoader.load(t,s,e)}),(e=>{this.error(`load(): Failed to load model modelMetadata for model '${i} from  '${r}' - ${e}`)}))}else this._sceneGraphLoader.load(t,s,e);return t.once("destroyed",(()=>{this.viewer.metaScene.destroyMetaModel(i)})),t}destroy(){super.destroy()}}class QM{constructor(e){const t=e.cameraControl,i=e.scene,s=i.canvas.canvas,r=!1,o=.09,n=.01,a=new Ke(i,{position:[0,0,0],scale:[5,5,5],isObject:!1}),l=d.vec3();this._setPosition=function(){const e=d.vec3(),t=d.vec3();return function(i){l.set(i),qe(i,e,t),a.origin=e,a.position=t}}(),this._setQuaternion=e=>{a.quaternion=e};const A=(e,t)=>new ve(a,Fe({radiusTop:.001,radiusBottom:e,radialSegments:32,heightSegments:1,height:t,openEnded:!1})),c=(e,t,i)=>new ve(a,Fe({radiusTop:e,radiusBottom:e,radialSegments:i,heightSegments:1,height:t,openEnded:!1})),h=(e,t,i)=>new ve(a,Se({radius:.8,tube:e,radialSegments:64,tubeSegments:i,arc:2*Math.PI*t})),u={curve:h(n,.25,14),curveHandle:h(o,.25,14),hoop:h(n,1,8),arrowHead:A(.07,.2),arrowHeadBig:A(.09,.25),arrowHeadHandle:c(o,.37,8),axis:c(n,1,20),axisHandle:c(o,1,20)},p=(e,t)=>new Gs(a,{edges:!1,fill:!0,fillColor:e,fillAlpha:t}),f=new bs(a,{diffuse:[1,1,0],alpha:0,alphaMode:"blend"}),m={},g=(e,t)=>{d.mulVec3Scalar(e,-1,d.vec3());const o=(e=>new bs(a,{diffuse:e,emissive:e,ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}))(e),n=d.quaternionToRotationMat4(t,d.identityMat4());d.mulMat4(d.rotationMat4v(Math.PI,[0,1,0],d.mat4()),n,n);const A=d.scaleMat4v([.6,.6,.6],d.identityMat4()),c=(e,t)=>{const i=d.translateMat4v(e,d.identityMat4()),s=d.identityMat4();return d.mulMat4(i,t,s),d.mulMat4(n,s,s),d.mulMat4(s,A,d.identityMat4())},h=a.addChild(new fs(a,{geometry:u.curve,material:o,matrix:n,pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1,isUI:!0,isObject:!1}),r),g=a.addChild(new fs(a,{geometry:u.curveHandle,material:f,matrix:n,pickable:!0,collidable:!0,clippable:!1,backfaces:!0,visible:!1,isUI:!0,isObject:!1}),r),_=a.addChild(new fs(a,{geometry:u.arrowHead,material:o,matrix:c([.8,.07,0],d.rotationMat4v(180*d.DEGTORAD,[0,0,1],d.identityMat4())),pickable:!0,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),r),v=a.addChild(new fs(a,{geometry:u.arrowHead,material:o,matrix:c([.07,.8,0],d.rotationMat4v(90*d.DEGTORAD,[0,0,1],d.identityMat4())),pickable:!0,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),r),b=a.addChild(new fs(a,{geometry:u.hoop,material:o,highlighted:!0,highlightMaterial:p(e,.6),matrix:n,pickable:!1,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),r),y=d.quaternionToRotationMat4(d.vec3PairToQuaternion([0,1,0],e),d.identityMat4());d.mulMat4(d.rotationMat4v(Math.PI,[0,1,0],d.mat4()),y,y);const w=e=>d.mulMat4(y,d.translateMat4c(0,e,0,d.identityMat4()),d.identityMat4()),B=w(1.1),P=w(.5),x=a.addChild(new fs(a,{geometry:u.arrowHead,material:o,matrix:B,pickable:!1,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),r),C=a.addChild(new fs(a,{geometry:u.arrowHeadHandle,material:f,matrix:B,pickable:!0,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),r),M=a.addChild(new fs(a,{geometry:u.axis,material:o,matrix:P,pickable:!1,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),r),E=a.addChild(new fs(a,{geometry:u.axisHandle,material:f,matrix:P,pickable:!0,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),r),F=a.addChild(new fs(a,{geometry:u.arrowHeadBig,material:o,matrix:B,pickable:!1,collidable:!0,clippable:!1,visible:!1,isUI:!0,isObject:!1}),r),I=(e,t)=>d.vec3ApplyQuaternion(a.quaternion,e,t),T=function(){const t=d.vec3(),r=d.vec3(),o=d.vec3();return(n,a)=>{I(e,t);const A=l,c=t;d.canvasPosToWorldRay(s,i.camera.viewMatrix,i.camera.projMatrix,i.camera.projection,n,r,o);const h=d.dotVec3(c,o),u=d.subVec3(r,A,a),p=d.dotVec3(u,c),f=d.dotVec3(u,o),m=1-h*h;if(Math.abs(m)>1e-10){const e=(p-h*f)/m;return d.addVec3(A,d.mulVec3Scalar(c,e,a),a),!0}return!1}}(),D=d.vec3(),S=d.vec3();m[C.id]=m[E.id]={setActivated:e=>F.visible=e,initDragAction:e=>T(e,D)&&d.subVec3(D,l,D)&&(e=>{T(e,S)&&(d.subVec3(S,D,S),this._setPosition(S),this._handlers&&this._handlers.onPosition(S))})},m[g.id]={setActivated:e=>b.visible=e,initDragAction:t=>{const s=function(){const t=i.camera.projectWorldPos(l);I(e,S),d.transformVec3(i.camera.normalMatrix,S,S);const s=Math.sign(S[2]);return e=>{const i=e[0]-t[0],r=e[1]-t[1];return s*Math.atan2(-r,i)}}();let r=s(t);return t=>{const i=s(t);a.rotate(e,180*(i-r)/Math.PI),this._handlers&&this._handlers.onQuaternion(a.quaternion),r=i}}};let R=!1,U=!1,L=!1;const k=()=>{const e=L&&R;C.visible=E.visible=x.visible=M.visible=!!e,e||(F.visible=!1)},O=()=>{const e=L&&U;g.visible=h.visible=_.visible=v.visible=!!e,e||(b.visible=!1)};return{setPositionActive:e=>{R=e,k()},setRotationActive:e=>{U=e,O()},set visible(e){L=e,k(),O()}}};this._displayMeshes={center:a.addChild(new fs(a,{geometry:new ve(a,De({radius:.05})),material:new bs(a,{diffuse:[0,0,0],emissive:[0,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80}),pickable:!1,collidable:!0,clippable:!1,visible:!1,isObject:!1}),r),x:g([1,0,0],d.vec3PairToQuaternion([1,0,0],[0,0,1])),y:g([0,1,0],d.eulerToQuaternion([90,0,0],"XYZ")),z:g([0,0,1],d.identityQuaternion())};const _=[];{let e=-1;const t=e=>{a.scale[0]!==e&&(a.scale=[e,e,e],this._handlers&&this._handlers.onScreenScale&&this._handlers.onScreenScale(a.scale))},s=i.on("tick",(()=>{const s=i.camera,r=Math.abs(d.distVec3(s.eye,l));"perspective"===s.projection?r!==e&&t(.07*r*Math.tan(s.perspective.fov*d.DEGTORAD)):"ortho"===s.projection&&t(s.ortho.scale/10),e=r}));_.push((()=>i.off(s)))}{let e=null,r=null;_.push((()=>{r&&r.cleanup()}));const o=d.vec2(),n=(e,t)=>{t[0]=e.pageX,t[1]=e.pageY,$b(s.ownerDocument.documentElement,s,t)},a=e=>{n(e,o);const t=i.pick({canvasPos:o}),s=t&&t.entity,r=s&&s.id;return r in m&&m[r]},l=(e,i)=>{const s=a(i(e));if(s){r&&r.cleanup();const e=s.initDragAction(o);return e&&(t.pointerEnabled=!1,s.setActivated(!0),r={onChange:t=>{const s=i(t);s&&(n(s,o),e(o))},cleanup:function(){r=null,t.pointerEnabled=!0,s.setActivated(!1)}}),!!e}return!1},A=(e,t)=>{s.addEventListener(e,t),_.push((()=>s.removeEventListener(e,t)))},c=e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation()};A("mousedown",(e=>{1===e.which&&l(e,(e=>1===e.which&&e))&&c(e)})),A("mousemove",(t=>{if(r)r.onChange(t),c(t);else{e&&e();const i=a(t);i?(i.setActivated(!0),e=()=>i.setActivated(!1)):e=null}})),A("mouseup",(e=>{r&&(r.onChange(e),r.cleanup())})),A("touchstart",(e=>{if(e.preventDefault(),1===e.touches.length){const t=e.touches[0].identifier;l(e,(e=>[...e.changedTouches].find((e=>e.identifier===t))))&&c(e)}})),A("touchmove",(e=>{r&&(r.onChange(e),c(e))})),A("touchend",(e=>{r&&(r.onChange(e),r.cleanup())}))}this.__destroy=()=>{_.forEach((e=>e())),a.destroy();for(let e in m)delete m[e]}}destroy(){this.__destroy()}setHandlers(e){Object.values(this._displayMeshes).forEach((t=>t.visible=!!e)),this._handlers=e,this._displayMeshes.x.setPositionActive(e&&e.onPosition),this._displayMeshes.y.setPositionActive(e&&e.onPosition),this._displayMeshes.z.setPositionActive(e&&e.onPosition),this._displayMeshes.x.setRotationActive(e&&e.onQuaternion),this._displayMeshes.y.setRotationActive(e&&e.onQuaternion),this._displayMeshes.z.setRotationActive(e&&e.onQuaternion)}setPosition(e){this._setPosition(e)}setQuaternion(e){this._setQuaternion(e)}}class HM{constructor(e,t,i){this.id=i.id,this._sectionPlane=i,this._mesh=new fs(t,{id:i.id,geometry:new ve(t,Ce({xSize:.5,ySize:.5,zSize:.001})),material:new bs(t,{emissive:[1,1,1],diffuse:[0,0,0],backfaces:!1}),edgeMaterial:new Ws(t,{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),highlightMaterial:new Gs(t,{fill:!0,fillColor:[.5,1,.5],fillAlpha:.7,edges:!0,edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),selectedMaterial:new Gs(t,{fill:!0,fillColor:[0,0,1],fillAlpha:.7,edges:!0,edgeColor:[1,0,0],edgeAlpha:1,edgeWidth:1}),highlighted:!0,scale:[3,3,3],position:[0,0,0],rotation:[0,0,0],opacity:.3,edges:!0});{const e=d.vec3([0,0,0]),t=d.vec3(),i=d.vec3([0,0,1]),s=d.vec4(4),r=d.vec3(),o=()=>{const o=this._sectionPlane.scene.center,n=[-this._sectionPlane.dir[0],-this._sectionPlane.dir[1],-this._sectionPlane.dir[2]];d.subVec3(o,this._sectionPlane.pos,e);const a=-d.dotVec3(n,e);d.normalizeVec3(n),d.mulVec3Scalar(n,a,t);const l=d.vec3PairToQuaternion(i,this._sectionPlane.dir,s);r[0]=.1*t[0],r[1]=.1*t[1],r[2]=.1*t[2],this._mesh.quaternion=l,this._mesh.position=r};this._onSectionPlanePos=this._sectionPlane.on("pos",o),this._onSectionPlaneDir=this._sectionPlane.on("dir",o)}this._highlighted=!1,this._selected=!1}setHighlighted(e){this._highlighted=!!e,this._mesh.highlighted=this._highlighted,this._mesh.highlightMaterial.fillColor=e?[0,.7,0]:[0,0,0]}getHighlighted(){return this._highlighted}setSelected(e){this._selected=!!e,this._mesh.edgeMaterial.edgeWidth=e?3:1,this._mesh.highlightMaterial.edgeWidth=e?3:1}getSelected(){return this._selected}destroy(){this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._mesh.destroy()}}class jM{constructor(e,t){if(!(t.onHoverEnterPlane&&t.onHoverLeavePlane&&t.onClickedNothing&&t.onClickedPlane))throw"Missing config(s): onHoverEnterPlane, onHoverLeavePlane, onClickedNothing || onClickedPlane";this.plugin=e,this._viewer=e.viewer,this._onHoverEnterPlane=t.onHoverEnterPlane,this._onHoverLeavePlane=t.onHoverLeavePlane,this._onClickedNothing=t.onClickedNothing,this._onClickedPlane=t.onClickedPlane,this._visible=!0,this._planes={},this._canvas=t.overviewCanvas,this._scene=new Xu(this._viewer,{canvasId:this._canvas.id,transparent:!0}),this._scene.clearLights(),new kc(this._scene,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new kc(this._scene,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new kc(this._scene,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._scene.camera,this._scene.camera.perspective.fov=70,this._zUp=!1;{const e=this._scene.camera,t=d.rotationMat4c(-90*d.DEGTORAD,1,0,0),i=d.vec3(),s=d.vec3(),r=d.vec3();this._synchCamera=()=>{const o=this._viewer.camera.eye,n=this._viewer.camera.look,a=this._viewer.camera.up;d.mulVec3Scalar(d.normalizeVec3(d.subVec3(o,n,i)),7),this._zUp?(d.transformVec3(t,i,s),d.transformVec3(t,a,r),e.look=[0,0,0],e.eye=d.transformVec3(t,i,s),e.up=d.transformPoint3(t,a,r)):(e.look=[0,0,0],e.eye=i,e.up=a)}}this._onViewerCameraMatrix=this._viewer.camera.on("matrix",this._synchCamera),this._onViewerCameraWorldAxis=this._viewer.camera.on("worldAxis",this._synchCamera),this._onViewerCameraFOV=this._viewer.camera.perspective.on("fov",(e=>{this._scene.camera.perspective.fov=e}));var i=null;this._onInputMouseMove=this._scene.input.on("mousemove",(e=>{const t=this._scene.pick({canvasPos:e});if(t){if(!i||t.entity.id!==i.id){if(i){this._planes[i.id]&&this._onHoverLeavePlane(i.id)}i=t.entity;this._planes[i.id]&&this._onHoverEnterPlane(i.id)}}else i&&(this._onHoverLeavePlane(i.id),i=null)})),this._scene.canvas.canvas.addEventListener("mouseup",this._onCanvasMouseUp=()=>{if(i){this._planes[i.id]&&this._onClickedPlane(i.id)}else this._onClickedNothing()}),this._scene.canvas.canvas.addEventListener("mouseout",this._onCanvasMouseOut=()=>{i&&(this._onHoverLeavePlane(i.id),i=null)}),this.setVisible(t.overviewVisible)}addSectionPlane(e){this._planes[e.id]=new HM(this,this._scene,e)}setPlaneHighlighted(e,t){const i=this._planes[e];i&&i.setHighlighted(t)}setPlaneSelected(e,t){const i=this._planes[e];i&&i.setSelected(t)}removeSectionPlane(e){const t=this._planes[e.id];t&&(t.destroy(),delete this._planes[e.id])}setVisible(e=!0){this._visible=e,this._canvas.style.visibility=e?"visible":"hidden"}getVisible(){return this._visible}destroy(){this._viewer.camera.off(this._onViewerCameraMatrix),this._viewer.camera.off(this._onViewerCameraWorldAxis),this._viewer.camera.perspective.off(this._onViewerCameraFOV),this._scene.input.off(this._onInputMouseMove),this._scene.canvas.canvas.removeEventListener("mouseup",this._onCanvasMouseUp),this._scene.canvas.canvas.removeEventListener("mouseout",this._onCanvasMouseOut),this._scene.destroy()}}const GM=d.AABB3(),zM=d.vec3();class WM extends ph{constructor(e,t={}){if(super("SectionPlanes",e),this._freeControls=[],this._sectionPlanes=e.scene.sectionPlanes,this._controls={},this._shownControlId=null,null!==t.overviewCanvasId&&void 0!==t.overviewCanvasId){const e=document.getElementById(t.overviewCanvasId);e?this._overview=new jM(this,{overviewCanvas:e,visible:t.overviewVisible,onHoverEnterPlane:e=>{this._overview.setPlaneHighlighted(e,!0)},onHoverLeavePlane:e=>{this._overview.setPlaneHighlighted(e,!1)},onClickedPlane:e=>{if(this.getShownControl()===e)return void this.hideControl();this.showControl(e);const t=this.sectionPlanes[e].pos;GM.set(this.viewer.scene.aabb),d.getAABB3Center(GM,zM),GM[0]+=t[0]-zM[0],GM[1]+=t[1]-zM[1],GM[2]+=t[2]-zM[2],GM[3]+=t[0]-zM[0],GM[4]+=t[1]-zM[1],GM[5]+=t[2]-zM[2],this.viewer.cameraFlight.flyTo({aabb:GM,fitFOV:65})},onClickedNothing:()=>{this.hideControl()}}):this.warn("Can't find overview canvas: '"+t.overviewCanvasId+"' - will create plugin without overview")}this._onSceneSectionPlaneCreated=e.scene.on("sectionPlaneCreated",(e=>{this._sectionPlaneCreated(e)}))}setOverviewVisible(e){this._overview&&this._overview.setVisible(e)}getOverviewVisible(){if(this._overview)return this._overview.getVisible()}get sectionPlanes(){return this._sectionPlanes}createSectionPlane(e={}){void 0!==e.id&&null!==e.id&&this.viewer.scene.components[e.id]&&(this.error("Viewer component with this ID already exists: "+e.id),delete e.id);return new ch(this.viewer.scene,{id:e.id,pos:e.pos,dir:e.dir,active:!0})}_sectionPlaneCreated(e){const t=this._freeControls.length>0?this._freeControls.pop():(()=>{const e=this.viewer.scene,t=function(){const t=new Ke(e,{isObject:!1});return t.addChild(new fs(t,{geometry:new ve(t,{primitive:"triangles",positions:[.5,.5,0,.5,-.5,0,-.5,-.5,0,-.5,.5,0,.5,.5,-0,.5,-.5,-0,-.5,-.5,-0,-.5,.5,-0],indices:[0,1,2,2,3,0]}),material:new bs(t,{emissive:[0,0,0],diffuse:[0,0,0],backfaces:!0}),opacity:.6,ghosted:!0,ghostMaterial:new Gs(t,{edges:!1,filled:!0,fillColor:[1,1,0],edgeColor:[0,0,0],fillAlpha:.1,backfaces:!0}),pickable:!1,collidable:!0,clippable:!1,visible:!1,scale:[2.4,2.4,1],isObject:!1})),t.addChild(new fs(t,{geometry:new ve(t,Se({center:[0,0,0],radius:1.7,tube:.02,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new bs(t,{emissive:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],shininess:0}),highlightMaterial:new Gs(t,{edges:!1,edgeColor:[0,0,0],filled:!0,fillColor:[.8,.8,.8],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,.1],rotation:[0,0,45],isObject:!1})),{setPosition:function(){const e=d.vec3(),i=d.vec3();return function(s){qe(s,e,i),t.origin=e,t.position=i}}(),setQuaternion:e=>{t.quaternion=e},setScale:e=>{t.scale=e},setVisible:e=>{t.visible=e}}}();let i=()=>{};const s=new QM(this.viewer);let r=!1,o=!1,n=null;const a=()=>{const e=o&&!r;t.setVisible(e),s.setHandlers(e&&n)};return{_destroy:()=>{i(),s.destroy()},setCulled:e=>{r=e,a()},setVisible:e=>{o=e,a()},_setSectionPlane:e=>{if(i(),e){let r=!1;n={onPosition:i=>{t.setPosition(i),e.pos=i},onQuaternion:i=>{t.setQuaternion(i),r=!0,e.quaternion=i},onScreenScale:e=>{t.setScale(e)}};const o=()=>{t.setPosition(e.pos),s.setPosition(e.pos)},a=()=>{t.setQuaternion(e.quaternion),s.setQuaternion(e.quaternion)};o(),a();const l=e.on("pos",o),A=e.on("dir",(()=>{r?r=!1:a()}));i=()=>{e.off(l),e.off(A),i=()=>{}}}}}})();t._setSectionPlane(e),t.setVisible(!1),this._controls[e.id]=t,this._overview&&this._overview.addSectionPlane(e),e.once("destroyed",(()=>{this._sectionPlaneDestroyed(e)}))}flipSectionPlanes(){const e=this.viewer.scene.sectionPlanes;for(let t in e){e[t].flipDir()}}showControl(e){const t=this._controls[e];t?(this.hideControl(),t.setVisible(!0),this._overview&&this._overview.setPlaneSelected(e,!0),this._shownControlId=e):this.error("Control not found: "+e)}getShownControl(){return this._shownControlId}hideControl(){for(var e in this._controls)this._controls.hasOwnProperty(e)&&(this._controls[e].setVisible(!1),this._overview&&this._overview.setPlaneSelected(e,!1));this._shownControlId=null}destroySectionPlane(e){var t=this.viewer.scene.sectionPlanes[e];t?(this._sectionPlaneDestroyed(t),t.destroy(),e===this._shownControlId&&(this._shownControlId=null)):this.error("SectionPlane not found: "+e)}_sectionPlaneDestroyed(e){this._overview&&this._overview.removeSectionPlane(e);const t=this._controls[e.id];t&&(t.setVisible(!1),t._setSectionPlane(null),delete this._controls[e.id],this._freeControls.push(t))}clear(){const e=Object.keys(this._sectionPlanes);for(var t=0,i=e.length;t<i;t++)this.destroySectionPlane(e[t])}send(e,t){switch(e){case"snapshotStarting":for(let e in this._controls)this._controls.hasOwnProperty(e)&&this._controls[e].setCulled(!0);break;case"snapshotFinished":for(let e in this._controls)this._controls.hasOwnProperty(e)&&this._controls[e].setCulled(!1);break;case"clearSectionPlanes":this.clear()}}destroy(){this.clear(),this._overview&&this._overview.destroy(),this._destroyFreeControls(),super.destroy()}_destroyFreeControls(){for(var e=this._freeControls.pop();e;)e._destroy(),e=this._freeControls.pop();this.viewer.scene.off(this._onSceneSectionPlaneCreated)}}class XM{constructor(e,t,i,s,r,o){this.plugin=e,this.storeyId=r,this.modelId=s,this.storeyAABB=i.slice(),this.aabb=this.storeyAABB,this.modelAABB=t.slice(),this.numObjects=o}}class KM{constructor(e,t,i,s,r,o){this.storeyId=e,this.imageData=t,this.format=i,this.width=s,this.height=r}}const ZM=d.vec3(),JM=d.mat4();class YM extends ph{constructor(e,t={}){super("StoreyViews",e),this._objectsMemento=new $c,this._cameraMemento=new Zc,this.storeys={},this._storeysList=null,this.modelStoreys={},this._fitStoreyMaps=!!t.fitStoreyMaps,this._onModelLoaded=this.viewer.scene.on("modelLoaded",(e=>{this._registerModelStoreys(e),this.fire("storeys",this.storeys)}))}_registerModelStoreys(e){const t=this.viewer,i=t.scene,s=t.metaScene,r=s.metaModels[e],o=i.models[e];if(!r||!r.rootMetaObjects)return;const n=r.rootMetaObjects;for(let t=0,r=n.length;t<r;t++){const r=n[t].getObjectIDsInSubtreeByType(["IfcBuildingStorey"]);for(let t=0,n=r.length;t<n;t++){const n=r[t],a=s.metaObjects[n].getObjectIDsInSubtree(),l=i.getAABB(a),A=Math.random()>.5?a.length:0,c=new XM(this,o.aabb,l,e,n,A);c._onModelDestroyed=o.once("destroyed",(()=>{this._deregisterModelStoreys(e),this.fire("storeys",this.storeys)})),this.storeys[n]=c,this._storeysList=null,this.modelStoreys[e]||(this.modelStoreys[e]={}),this.modelStoreys[e][n]=c}}this._clipBoundingBoxes()}_clipBoundingBoxes(){const e=this.storeysList,t=this.viewer.metaScene,i=this.viewer.camera.worldUp,s=i[0]>i[1]&&i[0]>i[2],r=!s&&i[1]>i[0]&&i[1]>i[2];let o;!s&&!r&&i[2]>i[0]&&(i[2],i[1]),o=s?0:r?1:2;for(let i=0,s=e.length;i<s;i++){const s=t.metaObjects[e[i].storeyId].attributes.elevation;if(isNaN(s))return;const r=e[i].storeyAABB;if(r[o]=Math.max(r[1],parseFloat(s)),i>0){const s=t.metaObjects[e[i-1].storeyId].attributes.elevation;r[4]=Math.min(r[o+3],parseFloat(s))}this.storeys[e[i].storeyId].storeyAABB=r}}_deregisterModelStoreys(e){const t=this.modelStoreys[e];if(t){const i=this.viewer.scene;for(let e in t)if(t.hasOwnProperty(e)){const s=t[e],r=i.models[s.modelId];r&&r.off(s._onModelDestroyed),delete this.storeys[e],this._storeysList=null}delete this.modelStoreys[e]}}get fitStoreyMaps(){return this._fitStoreyMaps}gotoStoreyCamera(e,t={}){const i=this.storeys[e];if(!i)return this.error("IfcBuildingStorey not found with this ID: "+e),void(t.done&&t.done());const s=this.viewer,r=s.scene.camera,o=i.storeyAABB;if(o[3]<o[0]||o[4]<o[1]||o[5]<o[2])return void(t.done&&t.done());if(o[3]===o[0]&&o[4]===o[1]&&o[5]===o[2])return void(t.done&&t.done());const n=d.getAABB3Center(o),a=d.getAABB3Diag(o),l=Math.abs(a/Math.tan(45*d.DEGTORAD)),A=1.3*a,c=ZM;c[0]=n[0]+r.worldUp[0]*l,c[1]=n[1]+r.worldUp[1]*l,c[2]=n[2]+r.worldUp[2]*l;const h=r.worldForward;t.done?s.cameraFlight.flyTo(y.apply(t,{eye:c,look:n,up:h,orthoScale:A}),(()=>{t.done()})):(s.cameraFlight.jumpTo(y.apply(t,{eye:c,look:n,up:h,orthoScale:A})),s.camera.ortho.scale=A)}showStoreyObjects(e,t={}){if(!this.storeys[e])return void this.error("IfcBuildingStorey not found with this ID: "+e);const i=this.viewer,s=i.scene;i.metaScene.metaObjects[e]&&(t.hideOthers&&s.setObjectsVisible(i.scene.visibleObjectIds,!1),this.withStoreyObjects(e,((e,t)=>{e&&(e.visible=!0)})))}withStoreyObjects(e,t){const i=this.viewer,s=i.scene,r=i.metaScene,o=r.metaObjects[e];if(!o)return;const n=o.getObjectIDsInSubtree();for(var a=0,l=n.length;a<l;a++){const e=n[a],i=r.metaObjects[e],o=s.objects[e];o&&t(o,i)}}createStoreyMap(e,t={}){const i=this.storeys[e];if(!i)return this.error("IfcBuildingStorey not found with this ID: "+e),"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==";const s=this.viewer,r=s.scene,o=t.format||"png",n=this._fitStoreyMaps?i.storeyAABB:i.modelAABB,a=Math.abs((n[5]-n[2])/(n[3]-n[0])),l=t.padding||0,A=!!t.captureSectionPlanes;let c,h;t.width&&t.height?(c=t.width,h=t.height):t.height?(h=t.height,c=Math.round(h/a)):t.width?(c=t.width,h=Math.round(c*a)):(c=300,h=Math.round(c*a));const u={visible:!0};this._objectsMemento.saveObjects(r,u),this._cameraMemento.saveCamera(r),this.showStoreyObjects(e,y.apply(t,{hideOthers:!0})),A&&this._toggleSectionPlanes(!1),this._arrangeStoreyMapCamera(i);const d=s.getSnapshot({width:c,height:h,format:o});return this._objectsMemento.restoreObjects(r,u),this._cameraMemento.restoreCamera(r),A&&this._toggleSectionPlanes(!0),new KM(e,d,o,c,h,l)}_toggleSectionPlanes(e){const t=this.viewer.scene.sectionPlanes;for(const i in t)t[i].active=e}_arrangeStoreyMapCamera(e){const t=this.viewer,i=t.scene.camera,s=this._fitStoreyMaps?e.storeyAABB:e.modelAABB,r=d.getAABB3Center(s),o=ZM;o[0]=r[0]+.5*i.worldUp[0],o[1]=r[1]+.5*i.worldUp[1],o[2]=r[2]+.5*i.worldUp[2];const n=i.worldForward;t.cameraFlight.jumpTo({eye:o,look:r,up:n});const a=(s[3]-s[0])/2,l=(s[4]-s[1])/2,A=(s[5]-s[2])/2,c=-a,h=+a,u=-l,p=+l,f=-A,m=+A;t.camera.customProjection.matrix=d.orthoMat4c(c,h,f,m,u,p,JM),t.camera.projection="customProjection"}pickStoreyMap(e,t,i={}){const s=e.storeyId,r=this.storeys[s];if(!r)return this.error("IfcBuildingStorey not found with this ID: "+s),null;const o=1-t[0]/e.width,n=1-t[1]/e.height,a=this._fitStoreyMaps?r.storeyAABB:r.modelAABB,l=a[0],A=a[1],c=a[2],h=a[3]-l,u=a[4]-A,p=a[5]-c,f=d.vec3([l+h*o,A+.5*u,c+p*n]),m=d.vec3([0,-1,0]),g=d.addVec3(f,m,ZM),_=this.viewer.camera.worldForward,v=d.lookAtMat4v(f,g,_,JM);return this.viewer.scene.pick({pickSurface:i.pickSurface,pickInvisible:!0,matrix:v})}storeyMapToWorldPos(e,t,i={}){const s=e.storeyId,r=this.storeys[s];if(!r)return this.error("IfcBuildingStorey not found with this ID: "+s),null;const o=1-t[0]/e.width,n=1-t[1]/e.height,a=this._fitStoreyMaps?r.storeyAABB:r.modelAABB,l=a[0],A=a[1],c=a[2],h=a[3]-l,u=a[4]-A,p=a[5]-c;return d.vec3([l+h*o,A+.5*u,c+p*n])}getStoreyContainingWorldPos(e,t=null){const i=t?this._filterStoreys(t):this.storeys;for(let t in i){const s=i[t];if(d.point3AABB3AbsoluteIntersect(s.storeyAABB,e))return t}return null}getStoreyInVerticalRange(e,t=null){const i=t?this._filterStoreys(t):this.storeys;for(let t in i){const s=i[t],r=[0,0,0,0,0,0],o=[0,0,0];if(r[1]=s.storeyAABB[1],r[4]=s.storeyAABB[4],o[1]=e[1],d.point3AABB3AbsoluteIntersect(r,o))return t}return null}isPositionAboveOrBelowBuilding(e,t=null){const i=t?this._filterStoreys(t):this.storeys,s=Object.keys(i);if(s.length<=0)return null;const r=[s[0],s[s.length-1]];return e[1]<i[r[0]].storeyAABB[1]?r[0]:e[1]>i[r[1]].storeyAABB[4]?r[1]:null}worldPosToStoreyMap(e,t,i){const s=e.storeyId,r=this.storeys[s];if(!r)return this.error("IfcBuildingStorey not found with this ID: "+s),!1;const o=this._fitStoreyMaps?r.storeyAABB:r.modelAABB,n=o[0],a=o[1],l=o[2],A=o[3]-n,c=o[4]-a,h=o[5]-l,u=this.viewer.camera.worldUp,d=u[0]>u[1]&&u[0]>u[2],p=!d&&u[1]>u[0]&&u[1]>u[2];!d&&!p&&u[2]>u[0]&&(u[2],u[1]);const f=e.width/A,m=p?e.height/h:e.height/c;return i[0]=Math.floor(e.width-(t[0]-n)*f),i[1]=Math.floor(e.height-(t[2]-l)*m),i[0]>=0&&i[0]<e.width&&i[1]>=0&&i[1]<=e.height}worldDirToStoreyMap(e,t,i){const s=this.viewer.camera,r=s.eye,o=s.look,n=d.subVec3(o,r,ZM),a=s.worldUp,l=a[0]>a[1]&&a[0]>a[2],A=!l&&a[1]>a[0]&&a[1]>a[2];!l&&!A&&a[2]>a[0]&&(a[2],a[1]),l?(i[0]=n[1],i[1]=n[2]):A?(i[0]=n[0],i[1]=n[2]):(i[0]=n[0],i[1]=n[1]),d.normalizeVec2(i)}destroy(){this.viewer.scene.off(this._onModelLoaded),super.destroy()}get storeysList(){return this._storeysList||(this._storeysList=Object.values(this.storeys),this._storeysList.sort(this._getSpatialSortFunc())),this._storeysList}_getSpatialSortFunc(){const e=this.viewer.scene.camera;return this._spatialSortFunc||(this._spatialSortFunc=(t,i)=>{let s=0;s=e.xUp?0:e.yUp?1:2;const r=this.viewer.metaScene,o=r.metaObjects[t.storeyId],n=r.metaObjects[i.storeyId];if(o&&o.attributes&&void 0!==o.attributes.elevation&&n&&n.attributes&&void 0!==n.attributes.elevation){const e=Number.parseFloat(o.attributes.elevation),t=Number.parseFloat(n.attributes.elevation);return e>t?-1:e<t?1:0}return t.aabb[s]>i.aabb[s]?-1:t.aabb[s]<i.aabb[s]?1:0})}_filterStoreys(e){return Object.fromEntries(Object.entries(this.storeys).filter((([t,i])=>i.modelId===e)))}}const qM=new Float64Array([0,0,1]),$M=new Float64Array(4);class eE{constructor(e){this.id=null,this._viewer=e.viewer,this._plugin=e,this._visible=!1,this._pos=d.vec3(),this._origin=d.vec3(),this._rtcPos=d.vec3(),this._baseDir=d.vec3(),this._rootNode=null,this._displayMeshes=null,this._affordanceMeshes=null,this._ignoreNextSectionPlaneDirUpdate=!1,this._createNodes(),this._bindEvents()}_setSectionPlane(e){this._sectionPlane&&(this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._onSectionPlanePos=null,this._onSectionPlaneDir=null,this._sectionPlane=null),e&&(this.id=e.id,this._setPos(e.pos),this._setDir(e.dir),this._sectionPlane=e,this._onSectionPlanePos=e.on("pos",(()=>{this._setPos(this._sectionPlane.pos)})),this._onSectionPlaneDir=e.on("dir",(()=>{this._ignoreNextSectionPlaneDirUpdate?this._ignoreNextSectionPlaneDirUpdate=!1:this._setDir(this._sectionPlane.dir)})))}get sectionPlane(){return this._sectionPlane}_setPos(e){this._pos.set(e),qe(this._pos,this._origin,this._rtcPos),this._rootNode.origin=this._origin,this._rootNode.position=this._rtcPos}_setDir(e){this._baseDir.set(e),this._rootNode.quaternion=d.vec3PairToQuaternion(qM,e,$M)}_setSectionPlaneDir(e){this._sectionPlane&&(this._ignoreNextSectionPlaneDirUpdate=!0,this._sectionPlane.dir=e)}setVisible(e=!0){if(this._visible!==e){var t;for(t in this._visible=e,this._displayMeshes)this._displayMeshes.hasOwnProperty(t)&&(this._displayMeshes[t].visible=e);if(!e)for(t in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(t)&&(this._affordanceMeshes[t].visible=e)}}getVisible(){return this._visible}setCulled(e){var t;for(t in this._displayMeshes)this._displayMeshes.hasOwnProperty(t)&&(this._displayMeshes[t].culled=e);if(!e)for(t in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(t)&&(this._affordanceMeshes[t].culled=e)}_createNodes(){const e=!1,t=this._viewer.scene,i=.01;this._rootNode=new Ke(t,{position:[0,0,0],scale:[5,5,5]});const s=this._rootNode,r={arrowHead:new ve(s,Fe({radiusTop:.001,radiusBottom:.07,radialSegments:32,heightSegments:1,height:.2,openEnded:!1})),arrowHeadBig:new ve(s,Fe({radiusTop:.001,radiusBottom:.09,radialSegments:32,heightSegments:1,height:.25,openEnded:!1})),axis:new ve(s,Fe({radiusTop:i,radiusBottom:i,radialSegments:20,heightSegments:1,height:1,openEnded:!1}))},o={red:new bs(s,{diffuse:[1,0,0],emissive:[1,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),green:new bs(s,{diffuse:[0,1,0],emissive:[1,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),blue:new bs(s,{diffuse:[0,0,1],emissive:[1,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightRed:new Gs(s,{edges:!1,fill:!0,fillColor:[1,0,0],fillAlpha:.6})};this._displayMeshes={plane:s.addChild(new fs(s,{geometry:new ve(s,{primitive:"triangles",positions:[.5,.5,0,.5,-.5,0,-.5,-.5,0,-.5,.5,0,.5,.5,-0,.5,-.5,-0,-.5,-.5,-0,-.5,.5,-0],indices:[0,1,2,2,3,0]}),material:new bs(s,{emissive:[0,0,0],diffuse:[0,0,0],backfaces:!0}),opacity:.6,ghosted:!0,pickable:!1,collidable:!0,clippable:!1,visible:!1,scale:[2.4,2.4,1]}),e),planeFrame:s.addChild(new fs(s,{geometry:new ve(s,Se({center:[0,0,0],radius:1.7,tube:.02,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new bs(s,{emissive:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],shininess:0}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,.1],rotation:[0,0,45]}),e),center:s.addChild(new fs(s,{geometry:new ve(s,De({radius:.05})),material:o.center,pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),zAxisArrow:s.addChild(new fs(s,{geometry:r.arrowHead,material:o.blue,matrix:function(){const e=d.translateMat4c(0,1.1,0,d.identityMat4()),t=d.rotationMat4v(-90*d.DEGTORAD,[.8,0,0],d.identityMat4());return d.mulMat4(t,e,d.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e),zShaft:s.addChild(new fs(s,{geometry:r.axis,material:o.blue,matrix:function(){const e=d.translateMat4c(0,.5,0,d.identityMat4()),t=d.rotationMat4v(-90*d.DEGTORAD,[1,0,0],d.identityMat4());return d.mulMat4(t,e,d.identityMat4())}(),clippable:!1,pickable:!1,collidable:!0,visible:!1}),e)},this._affordanceMeshes={planeFrame:s.addChild(new fs(s,{geometry:new ve(s,Se({center:[0,0,0],radius:2,tube:i,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new bs(s,{ambient:[1,1,1],diffuse:[0,0,0],emissive:[1,1,0]}),highlighted:!0,highlightMaterial:new Gs(s,{edges:!1,filled:!0,fillColor:[1,1,0],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,1],rotation:[0,0,45]}),e),zAxisArrow:s.addChild(new fs(s,{geometry:r.arrowHeadBig,material:o.blue,matrix:function(){const e=d.translateMat4c(0,1.1,0,d.identityMat4()),t=d.rotationMat4v(-90*d.DEGTORAD,[.8,0,0],d.identityMat4());return d.mulMat4(t,e,d.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),e)}}_bindEvents(){const e=this._rootNode,t=d.vec2(),i=this._viewer.camera,s=this._viewer.scene;let r=0,o=!1;{const t=d.vec3([0,0,0]);let n=-1;this._onCameraViewMatrix=s.camera.on("viewMatrix",(()=>{})),this._onCameraProjMatrix=s.camera.on("projMatrix",(()=>{})),this._onSceneTick=s.on("tick",(()=>{o=!1;const l=Math.abs(d.lenVec3(d.subVec3(s.camera.eye,this._pos,t)));if(l!==n&&"perspective"===i.projection){const t=.07*(Math.tan(i.perspective.fov*d.DEGTORAD)*l);e.scale=[t,t,t],n=l}if("ortho"===i.projection){const t=i.ortho.scale/10;e.scale=[t,t,t],n=l}0!==r&&(a(r),r=0)}))}const n=function(){const e=new Float64Array(2);return function(t){if(t){for(var i=t.target,s=0,r=0;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e[0]=t.x,e[1]=t.y;return e}}(),a=e=>{const t=this._sectionPlane.pos,i=this._sectionPlane.dir;d.addVec3(t,d.mulVec3Scalar(i,.1*e*this._plugin.getDragSensitivity(),d.vec3())),this._sectionPlane.pos=t};{let e=!1;this._plugin._controlElement.addEventListener("mousedown",this._canvasMouseDownListener=i=>{if(i.preventDefault(),this._visible&&(this._viewer.cameraControl.pointerEnabled=!1,1===i.which)){e=!0;var s=n(i);t[0]=s[0],t[1]=s[1]}}),this._plugin._controlElement.addEventListener("mousemove",this._canvasMouseMoveListener=i=>{if(!this._visible)return;if(!e)return;if(o)return;var s=n(i);const r=s[0],l=s[1];a(l-t[1]),t[0]=r,t[1]=l}),this._plugin._controlElement.addEventListener("mouseup",this._canvasMouseUpListener=t=>{this._visible&&(this._viewer.cameraControl.pointerEnabled=!0,e&&(t.which,e=!1))}),this._plugin._controlElement.addEventListener("wheel",this._canvasWheelListener=e=>{this._visible&&(r+=Math.max(-1,Math.min(1,40*-e.deltaY)))})}{let e,t,i=null;this._plugin._controlElement.addEventListener("touchstart",this._handleTouchStart=t=>{t.stopPropagation(),t.preventDefault(),this._visible&&(e=t.touches[0].clientY,i=e,r=0)}),this._plugin._controlElement.addEventListener("touchmove",this._handleTouchMove=e=>{e.stopPropagation(),e.preventDefault(),this._visible&&(o||(o=!0,t=e.touches[0].clientY,null!==i&&(r+=t-i),i=t))}),this._plugin._controlElement.addEventListener("touchend",this._handleTouchEnd=i=>{i.stopPropagation(),i.preventDefault(),this._visible&&(e=null,t=null,r=0)})}}_destroy(){this._unbindEvents(),this._destroyNodes()}_unbindEvents(){const e=this._viewer,t=e.scene,i=t.canvas.canvas,s=e.camera,r=this._plugin._controlElement;t.off(this._onSceneTick),i.removeEventListener("mousedown",this._canvasMouseDownListener),i.removeEventListener("mousemove",this._canvasMouseMoveListener),i.removeEventListener("mouseup",this._canvasMouseUpListener),i.removeEventListener("wheel",this._canvasWheelListener),r.removeEventListener("touchstart",this._handleTouchStart),r.removeEventListener("touchmove",this._handleTouchMove),r.removeEventListener("touchend",this._handleTouchEnd),s.off(this._onCameraViewMatrix),s.off(this._onCameraProjMatrix)}_destroyNodes(){this._setSectionPlane(null),this._rootNode.destroy(),this._displayMeshes={},this._affordanceMeshes={}}}class tE{constructor(e,t,i){this.id=i.id,this._sectionPlane=i,this._mesh=new fs(t,{id:i.id,geometry:new ve(t,Ce({xSize:.5,ySize:.5,zSize:.001})),material:new bs(t,{emissive:[1,1,1],diffuse:[0,0,0],backfaces:!1}),edgeMaterial:new Ws(t,{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),highlightMaterial:new Gs(t,{fill:!0,fillColor:[.5,1,.5],fillAlpha:.7,edges:!0,edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),selectedMaterial:new Gs(t,{fill:!0,fillColor:[0,0,1],fillAlpha:.7,edges:!0,edgeColor:[1,0,0],edgeAlpha:1,edgeWidth:1}),highlighted:!0,scale:[3,3,3],position:[0,0,0],rotation:[0,0,0],opacity:.3,edges:!0});{const e=d.vec3([0,0,0]),t=d.vec3(),i=d.vec3([0,0,1]),s=d.vec4(4),r=d.vec3(),o=()=>{const o=this._sectionPlane.scene.center,n=[-this._sectionPlane.dir[0],-this._sectionPlane.dir[1],-this._sectionPlane.dir[2]];d.subVec3(o,this._sectionPlane.pos,e);const a=-d.dotVec3(n,e);d.normalizeVec3(n),d.mulVec3Scalar(n,a,t);const l=d.vec3PairToQuaternion(i,this._sectionPlane.dir,s);r[0]=.1*t[0],r[1]=.1*t[1],r[2]=.1*t[2],this._mesh.quaternion=l,this._mesh.position=r};this._onSectionPlanePos=this._sectionPlane.on("pos",o),this._onSectionPlaneDir=this._sectionPlane.on("dir",o)}this._highlighted=!1,this._selected=!1}setHighlighted(e){this._highlighted=!!e,this._mesh.highlighted=this._highlighted,this._mesh.highlightMaterial.fillColor=e?[0,.7,0]:[0,0,0]}getHighlighted(){return this._highlighted}setSelected(e){this._selected=!!e,this._mesh.edgeMaterial.edgeWidth=e?3:1,this._mesh.highlightMaterial.edgeWidth=e?3:1}getSelected(){return this._selected}destroy(){this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._mesh.destroy()}}class iE{constructor(e,t){if(!(t.onHoverEnterPlane&&t.onHoverLeavePlane&&t.onClickedNothing&&t.onClickedPlane))throw"Missing config(s): onHoverEnterPlane, onHoverLeavePlane, onClickedNothing || onClickedPlane";this.plugin=e,this._viewer=e.viewer,this._onHoverEnterPlane=t.onHoverEnterPlane,this._onHoverLeavePlane=t.onHoverLeavePlane,this._onClickedNothing=t.onClickedNothing,this._onClickedPlane=t.onClickedPlane,this._visible=!0,this._planes={},this._canvas=t.overviewCanvas,this._scene=new Xu(this._viewer,{canvasId:this._canvas.id,transparent:!0}),this._scene.clearLights(),new kc(this._scene,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new kc(this._scene,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new kc(this._scene,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._scene.camera,this._scene.camera.perspective.fov=70,this._zUp=!1;{const e=this._scene.camera,t=d.rotationMat4c(-90*d.DEGTORAD,1,0,0),i=d.vec3(),s=d.vec3(),r=d.vec3();this._synchCamera=()=>{const o=this._viewer.camera.eye,n=this._viewer.camera.look,a=this._viewer.camera.up;d.mulVec3Scalar(d.normalizeVec3(d.subVec3(o,n,i)),7),this._zUp?(d.transformVec3(t,i,s),d.transformVec3(t,a,r),e.look=[0,0,0],e.eye=d.transformVec3(t,i,s),e.up=d.transformPoint3(t,a,r)):(e.look=[0,0,0],e.eye=i,e.up=a)}}this._onViewerCameraMatrix=this._viewer.camera.on("matrix",this._synchCamera),this._onViewerCameraWorldAxis=this._viewer.camera.on("worldAxis",this._synchCamera),this._onViewerCameraFOV=this._viewer.camera.perspective.on("fov",(e=>{this._scene.camera.perspective.fov=e}));var i=null;this._onInputMouseMove=this._scene.input.on("mousemove",(e=>{const t=this._scene.pick({canvasPos:e});if(t){if(!i||t.entity.id!==i.id){if(i){this._planes[i.id]&&this._onHoverLeavePlane(i.id)}i=t.entity;this._planes[i.id]&&this._onHoverEnterPlane(i.id)}}else i&&(this._onHoverLeavePlane(i.id),i=null)})),this._scene.canvas.canvas.addEventListener("mouseup",this._onCanvasMouseUp=()=>{if(i){this._planes[i.id]&&this._onClickedPlane(i.id)}else this._onClickedNothing()}),this._scene.canvas.canvas.addEventListener("mouseout",this._onCanvasMouseOut=()=>{i&&(this._onHoverLeavePlane(i.id),i=null)}),this.setVisible(t.overviewVisible)}addSectionPlane(e){this._planes[e.id]=new tE(this,this._scene,e)}setPlaneHighlighted(e,t){const i=this._planes[e];i&&i.setHighlighted(t)}setPlaneSelected(e,t){const i=this._planes[e];i&&i.setSelected(t)}removeSectionPlane(e){const t=this._planes[e.id];t&&(t.destroy(),delete this._planes[e.id])}setVisible(e=!0){this._visible=e,this._canvas.style.visibility=e?"visible":"hidden"}getVisible(){return this._visible}destroy(){this._viewer.camera.off(this._onViewerCameraMatrix),this._viewer.camera.off(this._onViewerCameraWorldAxis),this._viewer.camera.perspective.off(this._onViewerCameraFOV),this._scene.input.off(this._onInputMouseMove),this._scene.canvas.canvas.removeEventListener("mouseup",this._onCanvasMouseUp),this._scene.canvas.canvas.removeEventListener("mouseout",this._onCanvasMouseOut),this._scene.destroy()}}const sE=d.AABB3(),rE=d.vec3();class oE extends ph{constructor(e,t={}){if(super("FaceAlignedSectionPlanesPlugin",e),this._freeControls=[],this._sectionPlanes=e.scene.sectionPlanes,this._controls={},this._shownControlId=null,this._dragSensitivity=t.dragSensitivity||1,null!==t.overviewCanvasId&&void 0!==t.overviewCanvasId){const e=document.getElementById(t.overviewCanvasId);e?this._overview=new iE(this,{overviewCanvas:e,visible:t.overviewVisible,onHoverEnterPlane:e=>{this._overview.setPlaneHighlighted(e,!0)},onHoverLeavePlane:e=>{this._overview.setPlaneHighlighted(e,!1)},onClickedPlane:e=>{if(this.getShownControl()===e)return void this.hideControl();this.showControl(e);const t=this.sectionPlanes[e].pos;sE.set(this.viewer.scene.aabb),d.getAABB3Center(sE,rE),sE[0]+=t[0]-rE[0],sE[1]+=t[1]-rE[1],sE[2]+=t[2]-rE[2],sE[3]+=t[0]-rE[0],sE[4]+=t[1]-rE[1],sE[5]+=t[2]-rE[2],this.viewer.cameraFlight.flyTo({aabb:sE,fitFOV:65})},onClickedNothing:()=>{this.hideControl()}}):this.warn("Can't find overview canvas: '"+t.overviewCanvasId+"' - will create plugin without overview")}null===t.controlElementId||void 0===t.controlElementId?this.error("Parameter expected: controlElementId"):(this._controlElement=document.getElementById(t.controlElementId),this._controlElement||this.warn("Can't find control element: '"+t.controlElementId+"' - will create plugin without control element")),this._onSceneSectionPlaneCreated=e.scene.on("sectionPlaneCreated",(e=>{this._sectionPlaneCreated(e)}))}setDragSensitivity(e){this._dragSensitivity=e||1}getDragSensitivity(){return this._dragSensitivity}setOverviewVisible(e){this._overview&&this._overview.setVisible(e)}getOverviewVisible(){if(this._overview)return this._overview.getVisible()}get sectionPlanes(){return this._sectionPlanes}createSectionPlane(e={}){void 0!==e.id&&null!==e.id&&this.viewer.scene.components[e.id]&&(this.error("Viewer component with this ID already exists: "+e.id),delete e.id);return new ch(this.viewer.scene,{id:e.id,pos:e.pos,dir:e.dir,active:!0})}_sectionPlaneCreated(e){const t=this._freeControls.length>0?this._freeControls.pop():new eE(this);t._setSectionPlane(e),t.setVisible(!1),this._controls[e.id]=t,this._overview&&this._overview.addSectionPlane(e),e.once("destroyed",(()=>{this._sectionPlaneDestroyed(e)}))}flipSectionPlanes(){const e=this.viewer.scene.sectionPlanes;for(let t in e){e[t].flipDir()}}showControl(e){const t=this._controls[e];t?(this.hideControl(),t.setVisible(!0),this._overview&&this._overview.setPlaneSelected(e,!0),this._shownControlId=e):this.error("Control not found: "+e)}getShownControl(){return this._shownControlId}hideControl(){for(let e in this._controls)this._controls.hasOwnProperty(e)&&(this._controls[e].setVisible(!1),this._overview&&this._overview.setPlaneSelected(e,!1));this._shownControlId=null}destroySectionPlane(e){let t=this.viewer.scene.sectionPlanes[e];t?(this._sectionPlaneDestroyed(t),t.destroy(),e===this._shownControlId&&(this._shownControlId=null)):this.error("SectionPlane not found: "+e)}_sectionPlaneDestroyed(e){this._overview&&this._overview.removeSectionPlane(e);const t=this._controls[e.id];t&&(t.setVisible(!1),t._setSectionPlane(null),delete this._controls[e.id],this._freeControls.push(t))}clear(){const e=Object.keys(this._sectionPlanes);for(let t=0,i=e.length;t<i;t++)this.destroySectionPlane(e[t])}send(e,t){switch(e){case"snapshotStarting":for(let e in this._controls)this._controls.hasOwnProperty(e)&&this._controls[e].setCulled(!0);break;case"snapshotFinished":for(let e in this._controls)this._controls.hasOwnProperty(e)&&this._controls[e].setCulled(!1);break;case"clearSectionPlanes":this.clear()}}destroy(){this.clear(),this._overview&&this._overview.destroy(),this._destroyFreeControls(),super.destroy()}_destroyFreeControls(){let e=this._freeControls.pop();for(;e;)e._destroy(),e=this._freeControls.pop();this.viewer.scene.off(this._onSceneSectionPlaneCreated)}}class nE{constructor(e={}){this.cacheBuster=!1!==e.cacheBuster}_cacheBusterURL(e){if(!this.cacheBuster)return e;const t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}getSTL(e,t,i){e=this._cacheBusterURL(e);const s=new XMLHttpRequest;s.overrideMimeType("application/json"),s.open("GET",e,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?t(s.response):i(s.statusText))},s.send(null)}}const aE=d.vec3();class lE{load(e,t,i,s,r,o){s=s||{};const n=e.viewer.scene.canvas.spinner;n.processes++,e.dataSource.getSTL(i,(function(i){!function(e,t,i,s){try{const r=pE(i);AE(r)?cE(e,r,t,s):hE(e,dE(i),t,s)}catch(e){t.fire("error",e)}}(e,t,i,s);try{const o=pE(i);AE(o)?cE(e,o,t,s):hE(e,dE(i),t,s),n.processes--,I.scheduleTask((function(){t.fire("loaded",!0,!1)})),r&&r()}catch(i){n.processes--,e.error(i),o&&o(i),t.fire("error",i)}}),(function(i){n.processes--,e.error(i),o&&o(i),t.fire("error",i)}))}parse(e,t,i,s){const r=e.viewer.scene.canvas.spinner;r.processes++;try{const o=pE(i);AE(o)?cE(e,o,t,s):hE(e,dE(i),t,s),r.processes--,I.scheduleTask((function(){t.fire("loaded",!0,!1)}))}catch(e){r.processes--,t.fire("error",e)}}}function AE(e){const t=new DataView(e);if(84+50*t.getUint32(80,!0)===t.byteLength)return!0;const i=[115,111,108,105,100];for(var s=0;s<5;s++)if(i[s]!==t.getUint8(s,!1))return!0;return!1}function cE(e,t,i,s){const r=new DataView(t),o=r.getUint32(80,!0);let n,a,l,A,c,h,u,d=!1,p=null,f=null,m=null,g=!1;for(let e=0;e<70;e++)1129270351===r.getUint32(e,!1)&&82===r.getUint8(e+4)&&61===r.getUint8(e+5)&&(d=!0,A=[],c=r.getUint8(e+6)/255,h=r.getUint8(e+7)/255,u=r.getUint8(e+8)/255,r.getUint8(e+9));const _=new Ns(i,{roughness:.5});let v=[],b=[],y=s.splitMeshes;for(let e=0;e<o;e++){let t=84+50*e,o=r.getFloat32(t,!0),w=r.getFloat32(t+4,!0),B=r.getFloat32(t+8,!0);if(d){let e=r.getUint16(t+48,!0);0==(32768&e)?(n=(31&e)/31,a=(e>>5&31)/31,l=(e>>10&31)/31):(n=c,a=h,l=u),(y&&n!==p||a!==f||l!==m)&&(null!==p&&(g=!0),p=n,f=a,m=l)}for(let e=1;e<=3;e++){let i=t+12*e;v.push(r.getFloat32(i,!0)),v.push(r.getFloat32(i+4,!0)),v.push(r.getFloat32(i+8,!0)),b.push(o,w,B),d&&A.push(n,a,l,1)}y&&g&&(uE(i,v,b,A,_,s),v=[],b=[],A=A?[]:null,g=!1)}v.length>0&&uE(i,v,b,A,_,s)}function hE(e,t,i,s){const r=/facet([\s\S]*?)endfacet/g;let o=0;const n=/[\s]+([+-]?(?:\d+.\d+|\d+.|\d+|.\d+)(?:[eE][+-]?\d+)?)/.source,a=new RegExp("vertex"+n+n+n,"g"),l=new RegExp("normal"+n+n+n,"g"),A=[],c=[];let h,u,d,p,f,m,g;for(;null!==(p=r.exec(t));){for(f=0,m=0,g=p[0];null!==(p=l.exec(g));)h=parseFloat(p[1]),u=parseFloat(p[2]),d=parseFloat(p[3]),m++;for(;null!==(p=a.exec(g));)A.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3])),c.push(h,u,d),f++;1!==m&&e.error("Error in normal of face "+o),3!==f&&e.error("Error in positions of face "+o),o++}uE(i,A,c,null,new Ns(i,{roughness:.5}),s)}function uE(e,t,i,s,r,o){const n=new Int32Array(t.length/3);for(let e=0,t=n.length;e<t;e++)n[e]=e;i=i&&i.length>0?i:null,s=s&&s.length>0?s:null,o.smoothNormals&&d.faceToVertexNormals(t,i,o);const a=aE;$e(t,t,a);const l=new ve(e,{primitive:"triangles",positions:t,normals:i,colors:s,indices:n}),A=new fs(e,{origin:0!==a[0]||0!==a[1]||0!==a[2]?a:null,geometry:l,material:r,edges:o.edges});e.addChild(A)}function dE(e){return"string"!=typeof e?function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let i=0,s=e.length;i<s;i++)t+=String.fromCharCode(e[i]);return decodeURIComponent(escape(t))}(new Uint8Array(e)):e}function pE(e){if("string"==typeof e){const t=new Uint8Array(e.length);for(let i=0;i<e.length;i++)t[i]=255&e.charCodeAt(i);return t.buffer||t}return e}class fE extends ph{constructor(e,t={}){super("STLLoader",e,t),this._sceneGraphLoader=new lE,this.dataSource=t.dataSource}set dataSource(e){this._dataSource=e||new nE}get dataSource(){return this._dataSource}load(e){e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);const t=new Ke(this.viewer.scene,y.apply(e,{isModel:!0})),i=e.src,s=e.stl;return i||s?(i?this._sceneGraphLoader.load(this,t,i,e):this._sceneGraphLoader.parse(this,t,s,e),t):(this.error("load() param expected: either 'src' or 'stl'"),t)}}class mE{constructor(e){this._treeViewContainer=e}createRootNode(){return document.createElement("ul")}createNodeElement(e,t,i,s,r){const o=document.createElement("li");if(o.id=e.nodeId,e.xrayed&&o.classList.add("xrayed-node"),e.children.length>0){const i=document.createElement("a");i.href="#",i.id=`switch-${e.nodeId}`,i.textContent="+",i.classList.add("plus"),t&&i.addEventListener("click",t),o.appendChild(i)}const n=document.createElement("input");n.id=`checkbox-${e.nodeId}`,n.type="checkbox",n.checked=e.checked,n.style["pointer-events"]="all",i&&n.addEventListener("change",i),o.appendChild(n);const a=document.createElement("span");return a.textContent=e.title,o.appendChild(a),s&&Ub(a,s),r&&(a.onclick=r),o}createDisabledNodeElement(e){const t=document.createElement("li"),i=document.createElement("a");i.href="#",i.textContent="!",i.classList.add("warn"),i.classList.add("warning"),t.appendChild(i);const s=document.createElement("span");return s.textContent=e,t.appendChild(s),t}addChildren(e,t){const i=document.createElement("ul");t.forEach((e=>{i.appendChild(e)})),e.parentElement.appendChild(i)}expand(e,t,i){e.classList.remove("plus"),e.classList.add("minus"),e.textContent="-",e.removeEventListener("click",t),e.addEventListener("click",i)}collapse(e,t,i){if(!e)return;const s=e.parentElement;if(!s)return;const r=s.querySelector("ul");r&&(s.removeChild(r),e.classList.remove("minus"),e.classList.add("plus"),e.textContent="+",e.removeEventListener("click",i),e.addEventListener("click",t))}isExpanded(e){return void 0!==e.parentElement.getElementsByTagName("li")[0]}getId(e){return e.parentElement.id}getIdFromCheckbox(e){return e.id.replace("checkbox-","")}getSwitchElement(e){return this._treeViewContainer.querySelector(`[id="switch-${e}"]`)}isChecked(e){return e.checked}setCheckbox(e,t,i=!1){const s=this._treeViewContainer.querySelector(`[id="checkbox-${e}"]`);s&&(t!==s.checked&&(s.checked=t),i!==s.indeterminate&&(s.indeterminate=i,i&&(s.checked=!1)))}setXRayed(e,t){const i=this._treeViewContainer.querySelector(`[id="${e}"]`);i&&(t?i.classList.add("xrayed-node"):i.classList.remove("xrayed-node"))}setHighlighted(e,t){const i=this._treeViewContainer.querySelector(`[id="${e}"]`);i&&(t?(i.scrollIntoView({block:"center"}),i.classList.add("highlighted-node")):i.classList.remove("highlighted-node"))}}const gE=[];class _E extends ph{constructor(e,t={}){super("TreeViewPlugin",e),this.errors=[],this.valid=!0;const i=t.containerElement||document.getElementById(t.containerElementId);if(i instanceof HTMLElement){for(let e=0;;e++)if(!gE[e]){gE[e]=this,this._index=e,this._id=`tree-${e}`;break}if(this._containerElement=i,this._metaModels={},this._autoAddModels=!1!==t.autoAddModels,this._autoExpandDepth=t.autoExpandDepth||0,this._sortNodes=!1!==t.sortNodes,this._viewer=e,this._rootElement=null,this._muteSceneEvents=!1,this._muteTreeEvents=!1,this._rootNodes=[],this._objectNodes={},this._nodeNodes={},this._rootNames={},this._sortNodes=t.sortNodes,this._pruneEmptyNodes=t.pruneEmptyNodes,this._showListItemElementId=null,this._renderService=t.renderService||new mE(this._containerElement),this._showIndeterminate=t.showIndeterminate??!1,this._showProjectNode=t.showProjectNode??!1,this._elevationSortFunction=t.elevationSortFunction??void 0,this._defaultSortFunction=t.defaultSortFunction??void 0,!this._renderService)throw new Error("TreeViewPlugin: no render service set");if(this._containerElement.oncontextmenu=e=>{e.preventDefault()},this._onObjectVisibility=this._viewer.scene.on("objectVisibility",(e=>{if(this._muteSceneEvents)return;const t=e.id,i=this._objectNodes[t];if(!i)return;const s=e.visible;if(!(s!==i.checked))return;this._muteTreeEvents=!0,i.checked=s,s?i.numVisibleEntities++:i.numVisibleEntities--,this._renderService.setCheckbox(i.nodeId,s);let r=i.parent;for(;r;){r.checked=s,s?r.numVisibleEntities++:r.numVisibleEntities--;const e=this._showIndeterminate&&r.numVisibleEntities>0&&r.numVisibleEntities<r.numEntities;r.checked=r.numVisibleEntities>0,this._renderService.setCheckbox(r.nodeId,r.checked,e),r=r.parent}this._muteTreeEvents=!1})),this._onObjectXrayed=this._viewer.scene.on("objectXRayed",(e=>{if(this._muteSceneEvents)return;const t=e.id,i=this._objectNodes[t];if(!i)return;this._muteTreeEvents=!0;const s=e.xrayed;s!==i.xrayed&&(i.xrayed=s,this._renderService.setXRayed(i.nodeId,s),this._muteTreeEvents=!1)})),this._switchExpandHandler=e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this._expandSwitchElement(t)},this._switchCollapseHandler=e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this._collapseSwitchElement(t)},this._checkboxChangeHandler=e=>{if(this._muteTreeEvents)return;this._muteSceneEvents=!0;const t=e.target,i=this._renderService.isChecked(t),s=this._renderService.getIdFromCheckbox(t),r=this._nodeNodes[s],o=this._viewer.scene.objects;let n=0;this._withNodeTree(r,(e=>{const t=e.objectId,s=o[t],r=0===e.children.length;e.numVisibleEntities=i?e.numEntities:0,r&&i!==e.checked&&n++,e.checked=i,this._renderService.setCheckbox(e.nodeId,i),s&&(s.visible=i)}));let a=r.parent;for(;a;){i?a.numVisibleEntities+=n:a.numVisibleEntities-=n;const e=this._showIndeterminate&&a.numVisibleEntities>0&&a.numVisibleEntities<a.numEntities;a.checked=a.numVisibleEntities>0,this._renderService.setCheckbox(a.nodeId,a.checked,e),a=a.parent}this._muteSceneEvents=!1},this._hierarchy=t.hierarchy||"containment",this._autoExpandDepth=t.autoExpandDepth||0,this._autoAddModels){const e=Object.keys(this.viewer.metaScene.metaModels);for(let t=0,i=e.length;t<i;t++){const i=e[t];this.viewer.metaScene.metaModels[i].finalized&&this.addModel(i)}this.viewer.scene.on("modelLoaded",(e=>{this.viewer.metaScene.metaModels[e]&&this.addModel(e)}))}this.hierarchy=t.hierarchy}else this.error("Mandatory config expected: valid containerElementId or containerElement")}set hierarchy(e){"containment"!==(e=e||"containment")&&"storeys"!==e&&"types"!==e&&(this.error("Unsupported value for `hierarchy' - defaulting to 'containment'"),e="containment"),this._hierarchy!==e&&(this._hierarchy=e,this._createNodes())}get hierarchy(){return this._hierarchy}addModel(e,t={}){if(!this._containerElement)return;const i=this.viewer.scene.models[e];if(!i)throw"Model not found: "+e;const s=this.viewer.metaScene.metaModels[e];s?this._metaModels[e]?this.warn("Model already added: "+e):(this._metaModels[e]=s,t&&t.rootName&&(this._rootNames[e]=t.rootName),i.on("destroyed",(()=>{this.removeModel(i.id)})),this._createNodes()):this.error("MetaModel not found: "+e)}removeModel(e){if(!this._containerElement)return;this._metaModels[e]&&(this._rootNames[e]&&delete this._rootNames[e],delete this._metaModels[e],this._createNodes())}showNode(e){this.unShowNode();const t=this._objectNodes[e];if(!t)return;this.collapse();const i=t.nodeId,s=this._renderService.getSwitchElement(i);if(s)return this._expandSwitchElement(s),s.scrollIntoView(),!0;const r=[];r.unshift(t);let o=t.parent;for(;o;)r.unshift(o),o=o.parent;for(let e=0,t=r.length;e<t;e++){const t=this._renderService.getSwitchElement(r[e].nodeId);t&&this._expandSwitchElement(t)}this._renderService.setHighlighted(i,!0),this._showListItemElementId=i}unShowNode(){this._showListItemElementId&&(this._renderService.setHighlighted(this._showListItemElementId,!1),this._showListItemElementId=null)}expandToDepth(e){this.collapse();const t=(i,s)=>{if(s===e)return;const r=this._renderService.getSwitchElement(i.nodeId);if(r){this._expandSwitchElement(r);const e=i.children;for(var o=0,n=e.length;o<n;o++){const i=e[o];t(i,s+1)}}};for(let e=0,i=this._rootNodes.length;e<i;e++){const i=this._rootNodes[e];t(i,0)}}collapse(){for(let e=0,t=this._rootNodes.length;e<t;e++){const t=this._rootNodes[e].nodeId;this._collapseNode(t)}}withNodeTree(e,t){t(e);const i=e.children;if(i)for(let e=0,s=i.length;e<s;e++)this.withNodeTree(i[e],t)}destroy(){this._containerElement&&(this._metaModels={},this._rootElement&&!this._destroyed&&(this._rootElement.parentNode.removeChild(this._rootElement),this._viewer.scene.off(this._onObjectVisibility),this._destroyed=!0),delete gE[this._index],super.destroy())}_createNodes(){this._rootElement&&(this._rootElement.parentNode.removeChild(this._rootElement),this._rootElement=null),this._rootNodes=[],this._objectNodes={},this._nodeNodes={},this._validate(),this.valid||"storeys"!==this._hierarchy?this._createEnabledNodes():this._createDisabledNodes()}_validate(){if(this.errors=[],"storeys"===this._hierarchy)this.valid=this._validateMetaModelForStoreysHierarchy();else this.valid=this._rootNodes.length>0;return this.valid}_validateMetaModelForStoreysHierarchy(e=0,t,i){return!0}_createEnabledNodes(){switch(this._pruneEmptyNodes&&this._findEmptyNodes(),this._hierarchy){case"storeys":this._createStoreysNodes(),0===this._rootNodes.length&&this.error("Failed to build storeys hierarchy");break;case"types":this._createTypesNodes();break;default:this._createContainmentNodes()}this._sortNodes&&this._doSortNodes(),this._synchNodesToEntities(),this._createTrees(),this.expandToDepth(this._autoExpandDepth)}_createDisabledNodes(){const e=this._renderService.createRootNode();this._rootElement=e,this._containerElement.appendChild(e);const t=this._viewer.metaScene.rootMetaObjects;for(let i in t){const s=t[i],r=s.type,o=s.name,n=o&&""!==o&&"Undefined"!==o&&"Default"!==o?o:r,a=this._renderService.createDisabledNodeElement(n);e.appendChild(a)}}_findEmptyNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let t in e)this._findEmptyNodes2(e[t])}_findEmptyNodes2(e,t=0){const i=this.viewer.scene,s=e.children,r=e.id,o=i.objects[r];if(e._countEntities=0,o&&e._countEntities++,s)for(let t=0,i=s.length;t<i;t++){const i=s[t];i._countEntities=this._findEmptyNodes2(i),e._countEntities+=i._countEntities}return e._countEntities}_createStoreysNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let t in e)this._createStoreysNodes2(e[t],null,null,null,null)}_createStoreysNodes2(e,t,i,s,r){if(this._pruneEmptyNodes&&0===e._countEntities)return;const o=e.type,n=e.name,a=e.children,l=e.id;if(this._showProjectNode&&"IfcProject"===o)t={nodeId:`${this._id}-${l}`,objectId:l,title:0===e.metaModels.length?n:this._rootNames[e.metaModels[0].id]||(n&&""!==n&&"Undefined"!==n&&"Default"!==n?n:o),type:o,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},this._rootNodes.push(t),this._objectNodes[t.objectId]=t,this._nodeNodes[t.nodeId]=t;else if("IfcBuilding"===o)i={nodeId:`${this._id}-${l}`,objectId:l,title:0===e.metaModels.length?n:this._rootNames[e.metaModels[0].id]||(n&&""!==n&&"Undefined"!==n&&"Default"!==n?n:o),type:o,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},t?t.children.push(i):this._rootNodes.push(i),this._objectNodes[i.objectId]=i,this._nodeNodes[i.nodeId]=i;else if("IfcBuildingStorey"===o){if(!i)return void this.error("Failed to build storeys hierarchy for model - model does not have an IfcBuilding object, or is not an IFC model");s={nodeId:`${this._id}-${l}`,objectId:l,title:n&&""!==n&&"Undefined"!==n&&"Default"!==n?n:o,type:o,parent:i,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},i.children.push(s),this._objectNodes[s.objectId]=s,this._nodeNodes[s.nodeId]=s,r={}}else if(s){if(this._viewer.scene.objects[l]){let e=(r=r||{})[o];e||(e={nodeId:`${this._id}-${s.objectId}-${o}`,objectId:`${s.objectId}-${o}`,title:o,type:o,parent:s,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},s.children.push(e),this._objectNodes[e.objectId]=e,this._nodeNodes[e.nodeId]=e,r[o]=e);const t={nodeId:`${this._id}-${l}`,objectId:l,title:n&&""!==n&&"Undefined"!==n&&"Default"!==n?n:o,type:o,parent:e,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};e.children.push(t),this._objectNodes[t.objectId]=t,this._nodeNodes[t.nodeId]=t}}if(a)for(let e=0,o=a.length;e<o;e++){const o=a[e];this._createStoreysNodes2(o,t,i,s,r)}}_createTypesNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let t in e)this._createTypesNodes2(e[t],null,null)}_createTypesNodes2(e,t,i){if(this._pruneEmptyNodes&&0===e._countEntities)return;const s=e.type,r=e.name,o=e.children,n=e.id;if(e.parent){if(t){if(this._viewer.scene.objects[n]){let e=i[s];e||(e={nodeId:`${this._id}-${t.objectId}-${s}`,objectId:`${t.objectId}-${s}`,title:s,type:s,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},t.children.push(e),this._objectNodes[e.objectId]=e,this._nodeNodes[e.nodeId]=e,i[s]=e);const o={nodeId:`${this._id}-${n}`,objectId:n,title:r&&""!==r&&"Default"!==r?r:s,type:s,parent:e,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};e.children.push(o),this._objectNodes[o.objectId]=o,this._nodeNodes[o.nodeId]=o}}}else t={nodeId:`${this._id}-${n}`,objectId:n,title:0===e.metaModels.length?r:this._rootNames[e.metaModels[0].id]||(r&&""!==r&&"Undefined"!==r&&"Default"!==r?r:s),type:s,parent:null,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]},this._rootNodes.push(t),this._objectNodes[t.objectId]=t,this._nodeNodes[t.nodeId]=t,i={};if(o)for(let e=0,s=o.length;e<s;e++){const s=o[e];this._createTypesNodes2(s,t,i)}}_createContainmentNodes(){const e=this._viewer.metaScene.rootMetaObjects;for(let t in e)this._createContainmentNodes2(e[t],null)}_createContainmentNodes2(e,t){if(this._pruneEmptyNodes&&0===e._countEntities)return;const i=e.type,s=e.name||i,r=e.children,o=e.id,n={nodeId:`${this._id}-${o}`,objectId:o,title:t?s&&""!==s&&"Undefined"!==s&&"Default"!==s?s:i:0===e.metaModels.length?s:this._rootNames[e.metaModels[0].id]||s,type:i,parent:t,numEntities:0,numVisibleEntities:0,checked:!1,xrayed:!1,children:[]};if(t?t.children.push(n):this._rootNodes.push(n),this._objectNodes[n.objectId]=n,this._nodeNodes[n.nodeId]=n,r)for(let e=0,t=r.length;e<t;e++){const t=r[e];this._createContainmentNodes2(t,n)}}_doSortNodes(){for(let e=0,t=this._rootNodes.length;e<t;e++){const t=this._rootNodes[e];this._sortChildren(t)}}_sortChildren(e){const t=e.children;if(!t||0===t.length)return;const i=t[0];"storeys"!==this._hierarchy&&"containment"!==this._hierarchy||"IfcBuildingStorey"!==i.type?this._defaultSortFunction?t.sort(this._defaultSortFunction):t.sort(this._alphaSortFunc):this._elevationSortFunction?t.sort(this._elevationSortFunction):t.sort(this._getSpatialSortFunc());for(let e=0,i=t.length;e<i;e++){const i=t[e];this._sortChildren(i)}}_getSpatialSortFunc(){const e=this.viewer.scene.camera;return this._spatialSortFunc||(this._spatialSortFunc=(t,i)=>{e.xUp||e.yUp;const s=this.viewer.metaScene,r=s.metaObjects[t.objectId],o=s.metaObjects[i.objectId];if(r&&r.attributes&&void 0!==r.attributes.elevation&&o&&o.attributes&&void 0!==o.attributes.elevation){const e=Number.parseFloat(r.attributes.elevation),t=Number.parseFloat(o.attributes.elevation);return e>t?-1:e<t?1:0}return 0})}_alphaSortFunc(e,t){const i=e.title.toUpperCase(),s=t.title.toUpperCase();return i<s?-1:i>s?1:0}_synchNodesToEntities(){const e=Object.keys(this.viewer.metaScene.metaObjects),t=this._viewer.metaScene.metaObjects,i=this._viewer.scene.objects;for(let s=0,r=e.length;s<r;s++){const r=e[s];if(t[r]){const e=this._objectNodes[r];if(e){const t=i[r];if(t){const i=t.visible;e.numEntities=1,e.xrayed=t.xrayed,i?(e.numVisibleEntities=1,e.checked=!0):(e.numVisibleEntities=0,e.checked=!1);let s=e.parent;for(;s;)s.numEntities++,i&&(s.numVisibleEntities++,s.checked=!0),s=s.parent}}}}}_withNodeTree(e,t){t(e);const i=e.children;if(i)for(let e=0,s=i.length;e<s;e++)this._withNodeTree(i[e],t)}_createTrees(){if(0===this._rootNodes.length)return;const e=this._rootNodes.map((e=>this._createNodeElement(e))),t=this._renderService.createRootNode();e.forEach((e=>{t.appendChild(e)})),this._containerElement.appendChild(t),this._rootElement=t}_createNodeElement(e){return this._renderService.createNodeElement(e,this._switchExpandHandler,this._checkboxChangeHandler,(t=>{this.fire("contextmenu",{event:t,viewer:this._viewer,treeViewPlugin:this,treeViewNode:e}),t.preventDefault()}),(t=>{this.fire("nodeTitleClicked",{event:t,viewer:this._viewer,treeViewPlugin:this,treeViewNode:e}),t.preventDefault()}))}_expandSwitchElement(e){if(this._renderService.isExpanded(e))return;const t=this._renderService.getId(e),i=this._nodeNodes[t].children.map((e=>this._createNodeElement(e)));this._renderService.addChildren(e,i),this._renderService.expand(e,this._switchExpandHandler,this._switchCollapseHandler)}_collapseNode(e){const t=this._renderService.getSwitchElement(e);this._collapseSwitchElement(t)}_collapseSwitchElement(e){this._renderService.collapse(e,this._switchExpandHandler,this._switchCollapseHandler)}}class vE{constructor(e){this._scene=e,this._objects=[],this._objectsViewCulled=[],this._objectsDetailCulled=[],this._objectsChanged=[],this._objectsChangedList=[],this._modelInfos={},this._numObjects=0,this._lenObjectsChangedList=0,this._dirty=!0,this._onModelLoaded=e.on("modelLoaded",(t=>{const i=e.models[t];i&&this._addModel(i)})),this._onTick=e.on("tick",(()=>{this._dirty&&this._build(),this._applyChanges()}))}_addModel(e){const t={model:e,onDestroyed:e.on("destroyed",(()=>{this._removeModel(e)}))};this._modelInfos[e.id]=t,this._dirty=!0}_removeModel(e){const t=this._modelInfos[e.id];t&&(t.model.off(t.onDestroyed),delete this._modelInfos[e.id],this._dirty=!0)}_build(){if(!this._dirty)return;this._applyChanges();const e=this._scene.objects;for(let e=0;e<this._numObjects;e++)this._objects[e]=null;this._numObjects=0;for(let t in e){const i=e[t];this._objects[this._numObjects++]=i}this._lenObjectsChangedList=0,this._dirty=!1}_applyChanges(){if(this._lenObjectsChangedList>0){for(let e=0;e<this._lenObjectsChangedList;e++){const t=this._objectsChangedList[e],i=this._objects[t],s=this._objectsViewCulled[t],r=this._objectsDetailCulled[t],o=s||r;i.culled=o,this._objectsChanged[t]=!1}this._lenObjectsChangedList=0}}get objects(){return this._dirty&&this._build(),this._objects}get numObjects(){return this._dirty&&this._build(),this._numObjects}setObjectViewCulled(e,t){this._dirty&&this._build(),this._objectsViewCulled[e]!==t&&(this._objectsViewCulled[e]=t,this._objectsChanged[e]||(this._objectsChanged[e]=!0,this._objectsChangedList[this._lenObjectsChangedList++]=e))}setObjectDetailCulled(e,t){this._dirty&&this._build(),this._objectsDetailCulled[e]!==t&&(this._objectsDetailCulled[e]=t,this._objectsChanged[e]||(this._objectsChanged[e]=!0,this._objectsChangedList[this._lenObjectsChangedList++]=e))}_destroy(){this._clear(),this._scene.off(this._onModelLoaded),this._scene.off(this._onTick)}_clear(){for(let e in this._modelInfos){const t=this._modelInfos[e];t.model.off(t.onDestroyed)}this._modelInfos={},this._dirty=!0}}const bE={};const yE=new Float32Array(3);class wE extends ph{constructor(e,t={}){super("ViewCull",e),this._objectCullStates=function(e){const t=e.id;let i=bE[t];return i||(i=new vE(e),bE[t]=i,e.on("destroyed",(()=>{delete bE[t],i._destroy()}))),i}(e.scene),this._maxTreeDepth=t.maxTreeDepth||8,this._modelInfos={},this._frustum=new N,this._kdRoot=null,this._frustumDirty=!1,this._kdTreeDirty=!1,this._onViewMatrix=e.scene.camera.on("viewMatrix",(()=>{this._frustumDirty=!0})),this._onProjMatrix=e.scene.camera.on("projMatMatrix",(()=>{this._frustumDirty=!0})),this._onModelLoaded=e.scene.on("modelLoaded",(e=>{const t=this.viewer.scene.models[e];t&&this._addModel(t)})),this._onSceneTick=e.scene.on("tick",(()=>{this._doCull()}))}set enabled(e){this._enabled=e}get enabled(){return this._enabled}_addModel(e){const t={model:e,onDestroyed:e.on("destroyed",(()=>{this._removeModel(e)}))};this._modelInfos[e.id]=t,this._kdTreeDirty=!0}_removeModel(e){const t=this._modelInfos[e.id];t&&(t.model.off(t.onDestroyed),delete this._modelInfos[e.id],this._kdTreeDirty=!0)}_doCull(){const e=this._frustumDirty||this._kdTreeDirty;if(this._frustumDirty&&this._buildFrustum(),this._kdTreeDirty&&this._buildKDTree(),e){const e=this._kdRoot;e&&this._visitKDNode(e)}}_buildFrustum(){const e=this.viewer.scene.camera;V(this._frustum,e.viewMatrix,e.projMatrix),this._frustumDirty=!1}_buildKDTree(){const e=this.viewer.scene;this._kdRoot,this._kdRoot={aabb:e.getAABB(),intersection:N.INTERSECT};for(let e=0,t=this._objectCullStates.numObjects;e<t;e++){const t=this._objectCullStates.objects[e];this._insertEntityIntoKDTree(this._kdRoot,t,e,1)}this._kdTreeDirty=!1}_insertEntityIntoKDTree(e,t,i,s){const r=t.aabb;if(s>=this._maxTreeDepth)return e.objects=e.objects||[],e.objects.push(i),void d.expandAABB3(e.aabb,r);if(e.left&&d.containsAABB3(e.left.aabb,r))return void this._insertEntityIntoKDTree(e.left,t,i,s+1);if(e.right&&d.containsAABB3(e.right.aabb,r))return void this._insertEntityIntoKDTree(e.right,t,i,s+1);const o=e.aabb;yE[0]=o[3]-o[0],yE[1]=o[4]-o[1],yE[2]=o[5]-o[2];let n=0;if(yE[1]>yE[n]&&(n=1),yE[2]>yE[n]&&(n=2),!e.left){const a=o.slice();if(a[n+3]=(o[n]+o[n+3])/2,e.left={aabb:a,intersection:N.INTERSECT},d.containsAABB3(a,r))return void this._insertEntityIntoKDTree(e.left,t,i,s+1)}if(!e.right){const a=o.slice();if(a[n]=(o[n]+o[n+3])/2,e.right={aabb:a,intersection:N.INTERSECT},d.containsAABB3(a,r))return void this._insertEntityIntoKDTree(e.right,t,i,s+1)}e.objects=e.objects||[],e.objects.push(i),d.expandAABB3(e.aabb,r)}_visitKDNode(e,t=N.INTERSECT){if(t!==N.INTERSECT&&e.intersects===t)return;t===N.INTERSECT&&(t=Q(this._frustum,e.aabb),e.intersects=t);const i=t===N.OUTSIDE,s=e.objects;if(s&&s.length>0)for(let e=0,t=s.length;e<t;e++){const t=s[e];this._objectCullStates.setObjectViewCulled(t,i)}e.left&&this._visitKDNode(e.left,t),e.right&&this._visitKDNode(e.right,t)}send(e,t){}destroy(){super.destroy(),this._clear();const e=this.viewer.scene,t=e.camera;e.off(this._onModelLoaded),e.off(this._onSceneTick),t.off(this._onViewMatrix),t.off(this._onProjMatrix)}_clear(){for(let e in this._modelInfos){const t=this._modelInfos[e];t.model.off(t.onDestroyed)}this._modelInfos={},this._kdRoot=null,this._kdTreeDirty=!0}}class BE{constructor(e={}){this.cacheBuster=!1!==e.cacheBuster}_cacheBusterURL(e){if(!this.cacheBuster)return e;const t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}getManifest(e,t,i){y.loadJSON(this._cacheBusterURL(e),(e=>{t(e)}),(function(e){i(e)}))}getMetaModel(e,t,i){y.loadJSON(this._cacheBusterURL(e),(e=>{t(e)}),(function(e){i(e)}))}getXKT(e,t,i){var s=()=>{};t=t||s,i=i||s;const r=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const e=!!r[2];var o=r[3];o=window.decodeURIComponent(o),e&&(o=window.atob(o));try{const e=new ArrayBuffer(o.length),i=new Uint8Array(e);for(var n=0;n<o.length;n++)i[n]=o.charCodeAt(n);t(e)}catch(e){i(e)}}else{const s=new XMLHttpRequest;s.open("GET",this._cacheBusterURL(e),!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?t(s.response):i("getXKT error : "+s.response))},s.send(null)}}}
/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).pako={})}(void 0,(function(e){function t(e){let t=e.length;for(;--t>=0;)e[t]=0}const i=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),s=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),r=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),o=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),n=new Array(576);t(n);const a=new Array(60);t(a);const l=new Array(512);t(l);const A=new Array(256);t(A);const c=new Array(29);t(c);const h=new Array(30);function u(e,t,i,s,r){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=s,this.max_length=r,this.has_stree=e&&e.length}let d,p,f;function m(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}t(h);const g=e=>e<256?l[e]:l[256+(e>>>7)],_=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},v=(e,t,i)=>{e.bi_valid>16-i?(e.bi_buf|=t<<e.bi_valid&65535,_(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=i-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)},b=(e,t,i)=>{v(e,i[2*t],i[2*t+1])},y=(e,t)=>{let i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1},w=(e,t,i)=>{const s=new Array(16);let r,o,n=0;for(r=1;r<=15;r++)n=n+i[r-1]<<1,s[r]=n;for(o=0;o<=t;o++){let t=e[2*o+1];0!==t&&(e[2*o]=y(s[t]++,t))}},B=e=>{let t;for(t=0;t<286;t++)e.dyn_ltree[2*t]=0;for(t=0;t<30;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},P=e=>{e.bi_valid>8?_(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},x=(e,t,i,s)=>{const r=2*t,o=2*i;return e[r]<e[o]||e[r]===e[o]&&s[t]<=s[i]},C=(e,t,i)=>{const s=e.heap[i];let r=i<<1;for(;r<=e.heap_len&&(r<e.heap_len&&x(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!x(t,s,e.heap[r],e.depth));)e.heap[i]=e.heap[r],i=r,r<<=1;e.heap[i]=s},M=(e,t,r)=>{let o,n,a,l,u=0;if(0!==e.sym_next)do{o=255&e.pending_buf[e.sym_buf+u++],o+=(255&e.pending_buf[e.sym_buf+u++])<<8,n=e.pending_buf[e.sym_buf+u++],0===o?b(e,n,t):(a=A[n],b(e,a+256+1,t),l=i[a],0!==l&&(n-=c[a],v(e,n,l)),o--,a=g(o),b(e,a,r),l=s[a],0!==l&&(o-=h[a],v(e,o,l)))}while(u<e.sym_next);b(e,256,t)},E=(e,t)=>{const i=t.dyn_tree,s=t.stat_desc.static_tree,r=t.stat_desc.has_stree,o=t.stat_desc.elems;let n,a,l,A=-1;for(e.heap_len=0,e.heap_max=573,n=0;n<o;n++)0!==i[2*n]?(e.heap[++e.heap_len]=A=n,e.depth[n]=0):i[2*n+1]=0;for(;e.heap_len<2;)l=e.heap[++e.heap_len]=A<2?++A:0,i[2*l]=1,e.depth[l]=0,e.opt_len--,r&&(e.static_len-=s[2*l+1]);for(t.max_code=A,n=e.heap_len>>1;n>=1;n--)C(e,i,n);l=o;do{n=e.heap[1],e.heap[1]=e.heap[e.heap_len--],C(e,i,1),a=e.heap[1],e.heap[--e.heap_max]=n,e.heap[--e.heap_max]=a,i[2*l]=i[2*n]+i[2*a],e.depth[l]=(e.depth[n]>=e.depth[a]?e.depth[n]:e.depth[a])+1,i[2*n+1]=i[2*a+1]=l,e.heap[1]=l++,C(e,i,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((e,t)=>{const i=t.dyn_tree,s=t.max_code,r=t.stat_desc.static_tree,o=t.stat_desc.has_stree,n=t.stat_desc.extra_bits,a=t.stat_desc.extra_base,l=t.stat_desc.max_length;let A,c,h,u,d,p,f=0;for(u=0;u<=15;u++)e.bl_count[u]=0;for(i[2*e.heap[e.heap_max]+1]=0,A=e.heap_max+1;A<573;A++)c=e.heap[A],u=i[2*i[2*c+1]+1]+1,u>l&&(u=l,f++),i[2*c+1]=u,c>s||(e.bl_count[u]++,d=0,c>=a&&(d=n[c-a]),p=i[2*c],e.opt_len+=p*(u+d),o&&(e.static_len+=p*(r[2*c+1]+d)));if(0!==f){do{for(u=l-1;0===e.bl_count[u];)u--;e.bl_count[u]--,e.bl_count[u+1]+=2,e.bl_count[l]--,f-=2}while(f>0);for(u=l;0!==u;u--)for(c=e.bl_count[u];0!==c;)h=e.heap[--A],h>s||(i[2*h+1]!==u&&(e.opt_len+=(u-i[2*h+1])*i[2*h],i[2*h+1]=u),c--)}})(e,t),w(i,A,e.bl_count)},F=(e,t,i)=>{let s,r,o=-1,n=t[1],a=0,l=7,A=4;for(0===n&&(l=138,A=3),t[2*(i+1)+1]=65535,s=0;s<=i;s++)r=n,n=t[2*(s+1)+1],++a<l&&r===n||(a<A?e.bl_tree[2*r]+=a:0!==r?(r!==o&&e.bl_tree[2*r]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,o=r,0===n?(l=138,A=3):r===n?(l=6,A=3):(l=7,A=4))},I=(e,t,i)=>{let s,r,o=-1,n=t[1],a=0,l=7,A=4;for(0===n&&(l=138,A=3),s=0;s<=i;s++)if(r=n,n=t[2*(s+1)+1],!(++a<l&&r===n)){if(a<A)do{b(e,r,e.bl_tree)}while(0!=--a);else 0!==r?(r!==o&&(b(e,r,e.bl_tree),a--),b(e,16,e.bl_tree),v(e,a-3,2)):a<=10?(b(e,17,e.bl_tree),v(e,a-3,3)):(b(e,18,e.bl_tree),v(e,a-11,7));a=0,o=r,0===n?(l=138,A=3):r===n?(l=6,A=3):(l=7,A=4)}};let T=!1;const D=(e,t,i,s)=>{v(e,0+(s?1:0),3),P(e),_(e,i),_(e,~i),i&&e.pending_buf.set(e.window.subarray(t,t+i),e.pending),e.pending+=i};var S={_tr_init:e=>{T||((()=>{let e,t,o,m,g;const _=new Array(16);for(o=0,m=0;m<28;m++)for(c[m]=o,e=0;e<1<<i[m];e++)A[o++]=m;for(A[o-1]=m,g=0,m=0;m<16;m++)for(h[m]=g,e=0;e<1<<s[m];e++)l[g++]=m;for(g>>=7;m<30;m++)for(h[m]=g<<7,e=0;e<1<<s[m]-7;e++)l[256+g++]=m;for(t=0;t<=15;t++)_[t]=0;for(e=0;e<=143;)n[2*e+1]=8,e++,_[8]++;for(;e<=255;)n[2*e+1]=9,e++,_[9]++;for(;e<=279;)n[2*e+1]=7,e++,_[7]++;for(;e<=287;)n[2*e+1]=8,e++,_[8]++;for(w(n,287,_),e=0;e<30;e++)a[2*e+1]=5,a[2*e]=y(e,5);d=new u(n,i,257,286,15),p=new u(a,s,0,30,15),f=new u(new Array(0),r,0,19,7)})(),T=!0),e.l_desc=new m(e.dyn_ltree,d),e.d_desc=new m(e.dyn_dtree,p),e.bl_desc=new m(e.bl_tree,f),e.bi_buf=0,e.bi_valid=0,B(e)},_tr_stored_block:D,_tr_flush_block:(e,t,i,s)=>{let r,l,A=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=(e=>{let t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<256;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0})(e)),E(e,e.l_desc),E(e,e.d_desc),A=(e=>{let t;for(F(e,e.dyn_ltree,e.l_desc.max_code),F(e,e.dyn_dtree,e.d_desc.max_code),E(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*o[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t})(e),r=e.opt_len+3+7>>>3,l=e.static_len+3+7>>>3,l<=r&&(r=l)):r=l=i+5,i+4<=r&&-1!==t?D(e,t,i,s):4===e.strategy||l===r?(v(e,2+(s?1:0),3),M(e,n,a)):(v(e,4+(s?1:0),3),((e,t,i,s)=>{let r;for(v(e,t-257,5),v(e,i-1,5),v(e,s-4,4),r=0;r<s;r++)v(e,e.bl_tree[2*o[r]+1],3);I(e,e.dyn_ltree,t-1),I(e,e.dyn_dtree,i-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,A+1),M(e,e.dyn_ltree,e.dyn_dtree)),B(e),s&&P(e)},_tr_tally:(e,t,i)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=i,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(A[i]+256+1)]++,e.dyn_dtree[2*g(t)]++),e.sym_next===e.sym_end),_tr_align:e=>{v(e,2,3),b(e,256,n),(e=>{16===e.bi_valid?(_(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(e)}},R=(e,t,i,s)=>{let r=65535&e|0,o=e>>>16&65535|0,n=0;for(;0!==i;){n=i>2e3?2e3:i,i-=n;do{r=r+t[s++]|0,o=o+r|0}while(--n);r%=65521,o%=65521}return r|o<<16|0};const U=new Uint32Array((()=>{let e,t=[];for(var i=0;i<256;i++){e=i;for(var s=0;s<8;s++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t})());var L=(e,t,i,s)=>{const r=U,o=s+i;e^=-1;for(let i=s;i<o;i++)e=e>>>8^r[255&(e^t[i])];return-1^e},k={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},O={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:N,_tr_stored_block:V,_tr_flush_block:Q,_tr_tally:H,_tr_align:j}=S,{Z_NO_FLUSH:G,Z_PARTIAL_FLUSH:z,Z_FULL_FLUSH:W,Z_FINISH:X,Z_BLOCK:K,Z_OK:Z,Z_STREAM_END:J,Z_STREAM_ERROR:Y,Z_DATA_ERROR:q,Z_BUF_ERROR:$,Z_DEFAULT_COMPRESSION:ee,Z_FILTERED:te,Z_HUFFMAN_ONLY:ie,Z_RLE:se,Z_FIXED:re,Z_DEFAULT_STRATEGY:oe,Z_UNKNOWN:ne,Z_DEFLATED:ae}=O,le=258,Ae=262,ce=42,he=113,ue=666,de=(e,t)=>(e.msg=k[t],t),pe=e=>2*e-(e>4?9:0),fe=e=>{let t=e.length;for(;--t>=0;)e[t]=0},me=e=>{let t,i,s,r=e.w_size;t=e.hash_size,s=t;do{i=e.head[--s],e.head[s]=i>=r?i-r:0}while(--t);t=r,s=t;do{i=e.prev[--s],e.prev[s]=i>=r?i-r:0}while(--t)};let ge=(e,t,i)=>(t<<e.hash_shift^i)&e.hash_mask;const _e=e=>{const t=e.state;let i=t.pending;i>e.avail_out&&(i=e.avail_out),0!==i&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+i),e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,0===t.pending&&(t.pending_out=0))},ve=(e,t)=>{Q(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,_e(e.strm)},be=(e,t)=>{e.pending_buf[e.pending++]=t},ye=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},we=(e,t,i,s)=>{let r=e.avail_in;return r>s&&(r=s),0===r?0:(e.avail_in-=r,t.set(e.input.subarray(e.next_in,e.next_in+r),i),1===e.state.wrap?e.adler=R(e.adler,t,r,i):2===e.state.wrap&&(e.adler=L(e.adler,t,r,i)),e.next_in+=r,e.total_in+=r,r)},Be=(e,t)=>{let i,s,r=e.max_chain_length,o=e.strstart,n=e.prev_length,a=e.nice_match;const l=e.strstart>e.w_size-Ae?e.strstart-(e.w_size-Ae):0,A=e.window,c=e.w_mask,h=e.prev,u=e.strstart+le;let d=A[o+n-1],p=A[o+n];e.prev_length>=e.good_match&&(r>>=2),a>e.lookahead&&(a=e.lookahead);do{if(i=t,A[i+n]===p&&A[i+n-1]===d&&A[i]===A[o]&&A[++i]===A[o+1]){o+=2,i++;do{}while(A[++o]===A[++i]&&A[++o]===A[++i]&&A[++o]===A[++i]&&A[++o]===A[++i]&&A[++o]===A[++i]&&A[++o]===A[++i]&&A[++o]===A[++i]&&A[++o]===A[++i]&&o<u);if(s=le-(u-o),o=u-le,s>n){if(e.match_start=t,n=s,s>=a)break;d=A[o+n-1],p=A[o+n]}}}while((t=h[t&c])>l&&0!=--r);return n<=e.lookahead?n:e.lookahead},Pe=e=>{const t=e.w_size;let i,s,r;do{if(s=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-Ae)&&(e.window.set(e.window.subarray(t,t+t-s),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),me(e),s+=t),0===e.strm.avail_in)break;if(i=we(e.strm,e.window,e.strstart+e.lookahead,s),e.lookahead+=i,e.lookahead+e.insert>=3)for(r=e.strstart-e.insert,e.ins_h=e.window[r],e.ins_h=ge(e,e.ins_h,e.window[r+1]);e.insert&&(e.ins_h=ge(e,e.ins_h,e.window[r+3-1]),e.prev[r&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=r,r++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<Ae&&0!==e.strm.avail_in)},xe=(e,t)=>{let i,s,r,o=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,n=0,a=e.strm.avail_in;do{if(i=65535,r=e.bi_valid+42>>3,e.strm.avail_out<r)break;if(r=e.strm.avail_out-r,s=e.strstart-e.block_start,i>s+e.strm.avail_in&&(i=s+e.strm.avail_in),i>r&&(i=r),i<o&&(0===i&&t!==X||t===G||i!==s+e.strm.avail_in))break;n=t===X&&i===s+e.strm.avail_in?1:0,V(e,0,0,n),e.pending_buf[e.pending-4]=i,e.pending_buf[e.pending-3]=i>>8,e.pending_buf[e.pending-2]=~i,e.pending_buf[e.pending-1]=~i>>8,_e(e.strm),s&&(s>i&&(s=i),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+s),e.strm.next_out),e.strm.next_out+=s,e.strm.avail_out-=s,e.strm.total_out+=s,e.block_start+=s,i-=s),i&&(we(e.strm,e.strm.output,e.strm.next_out,i),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i)}while(0===n);return a-=e.strm.avail_in,a&&(a>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=a&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-a,e.strm.next_in),e.strstart),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),n?4:t!==G&&t!==X&&0===e.strm.avail_in&&e.strstart===e.block_start?2:(r=e.window_size-e.strstart,e.strm.avail_in>r&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,r+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),r>e.strm.avail_in&&(r=e.strm.avail_in),r&&(we(e.strm,e.window,e.strstart,r),e.strstart+=r,e.insert+=r>e.w_size-e.insert?e.w_size-e.insert:r),e.high_water<e.strstart&&(e.high_water=e.strstart),r=e.bi_valid+42>>3,r=e.pending_buf_size-r>65535?65535:e.pending_buf_size-r,o=r>e.w_size?e.w_size:r,s=e.strstart-e.block_start,(s>=o||(s||t===X)&&t!==G&&0===e.strm.avail_in&&s<=r)&&(i=s>r?r:s,n=t===X&&0===e.strm.avail_in&&i===s?1:0,V(e,e.block_start,i,n),e.block_start+=i,_e(e.strm)),n?3:1)},Ce=(e,t)=>{let i,s;for(;;){if(e.lookahead<Ae){if(Pe(e),e.lookahead<Ae&&t===G)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=ge(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-Ae&&(e.match_length=Be(e,i)),e.match_length>=3)if(s=H(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=ge(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=ge(e,e.ins_h,e.window[e.strstart+1]);else s=H(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(s&&(ve(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,t===X?(ve(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(ve(e,!1),0===e.strm.avail_out)?1:2},Me=(e,t)=>{let i,s,r;for(;;){if(e.lookahead<Ae){if(Pe(e),e.lookahead<Ae&&t===G)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=ge(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-Ae&&(e.match_length=Be(e,i),e.match_length<=5&&(e.strategy===te||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-3,s=H(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=r&&(e.ins_h=ge(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,s&&(ve(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if(s=H(e,0,e.window[e.strstart-1]),s&&ve(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(s=H(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===X?(ve(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(ve(e,!1),0===e.strm.avail_out)?1:2};function Ee(e,t,i,s,r){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=s,this.func=r}const Fe=[new Ee(0,0,0,0,xe),new Ee(4,4,8,4,Ce),new Ee(4,5,16,8,Ce),new Ee(4,6,32,32,Ce),new Ee(4,4,16,16,Me),new Ee(8,16,32,32,Me),new Ee(8,16,128,128,Me),new Ee(8,32,128,256,Me),new Ee(32,128,258,1024,Me),new Ee(32,258,258,4096,Me)];function Ie(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=ae,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),fe(this.dyn_ltree),fe(this.dyn_dtree),fe(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),fe(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),fe(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Te=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==ce&&57!==t.status&&69!==t.status&&73!==t.status&&91!==t.status&&103!==t.status&&t.status!==he&&t.status!==ue?1:0},De=e=>{if(Te(e))return de(e,Y);e.total_in=e.total_out=0,e.data_type=ne;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=2===t.wrap?57:t.wrap?ce:he,e.adler=2===t.wrap?0:1,t.last_flush=-2,N(t),Z},Se=e=>{const t=De(e);var i;return t===Z&&((i=e.state).window_size=2*i.w_size,fe(i.head),i.max_lazy_match=Fe[i.level].max_lazy,i.good_match=Fe[i.level].good_length,i.nice_match=Fe[i.level].nice_length,i.max_chain_length=Fe[i.level].max_chain,i.strstart=0,i.block_start=0,i.lookahead=0,i.insert=0,i.match_length=i.prev_length=2,i.match_available=0,i.ins_h=0),t},Re=(e,t,i,s,r,o)=>{if(!e)return Y;let n=1;if(t===ee&&(t=6),s<0?(n=0,s=-s):s>15&&(n=2,s-=16),r<1||r>9||i!==ae||s<8||s>15||t<0||t>9||o<0||o>re||8===s&&1!==n)return de(e,Y);8===s&&(s=9);const a=new Ie;return e.state=a,a.strm=e,a.status=ce,a.wrap=n,a.gzhead=null,a.w_bits=s,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=t,a.strategy=o,a.method=i,Se(e)};var Ue=Re,Le=(e,t)=>Te(e)||2!==e.state.wrap?Y:(e.state.gzhead=t,Z),ke=(e,t)=>{if(Te(e)||t>K||t<0)return e?de(e,Y):Y;const i=e.state;if(!e.output||0!==e.avail_in&&!e.input||i.status===ue&&t!==X)return de(e,0===e.avail_out?$:Y);const s=i.last_flush;if(i.last_flush=t,0!==i.pending){if(_e(e),0===e.avail_out)return i.last_flush=-1,Z}else if(0===e.avail_in&&pe(t)<=pe(s)&&t!==X)return de(e,$);if(i.status===ue&&0!==e.avail_in)return de(e,$);if(i.status===ce&&0===i.wrap&&(i.status=he),i.status===ce){let t=ae+(i.w_bits-8<<4)<<8,s=-1;if(s=i.strategy>=ie||i.level<2?0:i.level<6?1:6===i.level?2:3,t|=s<<6,0!==i.strstart&&(t|=32),t+=31-t%31,ye(i,t),0!==i.strstart&&(ye(i,e.adler>>>16),ye(i,65535&e.adler)),e.adler=1,i.status=he,_e(e),0!==i.pending)return i.last_flush=-1,Z}if(57===i.status)if(e.adler=0,be(i,31),be(i,139),be(i,8),i.gzhead)be(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),be(i,255&i.gzhead.time),be(i,i.gzhead.time>>8&255),be(i,i.gzhead.time>>16&255),be(i,i.gzhead.time>>24&255),be(i,9===i.level?2:i.strategy>=ie||i.level<2?4:0),be(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(be(i,255&i.gzhead.extra.length),be(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(e.adler=L(e.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69;else if(be(i,0),be(i,0),be(i,0),be(i,0),be(i,0),be(i,9===i.level?2:i.strategy>=ie||i.level<2?4:0),be(i,3),i.status=he,_e(e),0!==i.pending)return i.last_flush=-1,Z;if(69===i.status){if(i.gzhead.extra){let t=i.pending,s=(65535&i.gzhead.extra.length)-i.gzindex;for(;i.pending+s>i.pending_buf_size;){let r=i.pending_buf_size-i.pending;if(i.pending_buf.set(i.gzhead.extra.subarray(i.gzindex,i.gzindex+r),i.pending),i.pending=i.pending_buf_size,i.gzhead.hcrc&&i.pending>t&&(e.adler=L(e.adler,i.pending_buf,i.pending-t,t)),i.gzindex+=r,_e(e),0!==i.pending)return i.last_flush=-1,Z;t=0,s-=r}let r=new Uint8Array(i.gzhead.extra);i.pending_buf.set(r.subarray(i.gzindex,i.gzindex+s),i.pending),i.pending+=s,i.gzhead.hcrc&&i.pending>t&&(e.adler=L(e.adler,i.pending_buf,i.pending-t,t)),i.gzindex=0}i.status=73}if(73===i.status){if(i.gzhead.name){let t,s=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>s&&(e.adler=L(e.adler,i.pending_buf,i.pending-s,s)),_e(e),0!==i.pending)return i.last_flush=-1,Z;s=0}t=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,be(i,t)}while(0!==t);i.gzhead.hcrc&&i.pending>s&&(e.adler=L(e.adler,i.pending_buf,i.pending-s,s)),i.gzindex=0}i.status=91}if(91===i.status){if(i.gzhead.comment){let t,s=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>s&&(e.adler=L(e.adler,i.pending_buf,i.pending-s,s)),_e(e),0!==i.pending)return i.last_flush=-1,Z;s=0}t=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,be(i,t)}while(0!==t);i.gzhead.hcrc&&i.pending>s&&(e.adler=L(e.adler,i.pending_buf,i.pending-s,s))}i.status=103}if(103===i.status){if(i.gzhead.hcrc){if(i.pending+2>i.pending_buf_size&&(_e(e),0!==i.pending))return i.last_flush=-1,Z;be(i,255&e.adler),be(i,e.adler>>8&255),e.adler=0}if(i.status=he,_e(e),0!==i.pending)return i.last_flush=-1,Z}if(0!==e.avail_in||0!==i.lookahead||t!==G&&i.status!==ue){let s=0===i.level?xe(i,t):i.strategy===ie?((e,t)=>{let i;for(;;){if(0===e.lookahead&&(Pe(e),0===e.lookahead)){if(t===G)return 1;break}if(e.match_length=0,i=H(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(ve(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===X?(ve(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(ve(e,!1),0===e.strm.avail_out)?1:2})(i,t):i.strategy===se?((e,t)=>{let i,s,r,o;const n=e.window;for(;;){if(e.lookahead<=le){if(Pe(e),e.lookahead<=le&&t===G)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(r=e.strstart-1,s=n[r],s===n[++r]&&s===n[++r]&&s===n[++r])){o=e.strstart+le;do{}while(s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&r<o);e.match_length=le-(o-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(i=H(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=H(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(ve(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===X?(ve(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(ve(e,!1),0===e.strm.avail_out)?1:2})(i,t):Fe[i.level].func(i,t);if(3!==s&&4!==s||(i.status=ue),1===s||3===s)return 0===e.avail_out&&(i.last_flush=-1),Z;if(2===s&&(t===z?j(i):t!==K&&(V(i,0,0,!1),t===W&&(fe(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),_e(e),0===e.avail_out))return i.last_flush=-1,Z}return t!==X?Z:i.wrap<=0?J:(2===i.wrap?(be(i,255&e.adler),be(i,e.adler>>8&255),be(i,e.adler>>16&255),be(i,e.adler>>24&255),be(i,255&e.total_in),be(i,e.total_in>>8&255),be(i,e.total_in>>16&255),be(i,e.total_in>>24&255)):(ye(i,e.adler>>>16),ye(i,65535&e.adler)),_e(e),i.wrap>0&&(i.wrap=-i.wrap),0!==i.pending?Z:J)},Oe=e=>{if(Te(e))return Y;const t=e.state.status;return e.state=null,t===he?de(e,q):Z},Ne=(e,t)=>{let i=t.length;if(Te(e))return Y;const s=e.state,r=s.wrap;if(2===r||1===r&&s.status!==ce||s.lookahead)return Y;if(1===r&&(e.adler=R(e.adler,t,i,0)),s.wrap=0,i>=s.w_size){0===r&&(fe(s.head),s.strstart=0,s.block_start=0,s.insert=0);let e=new Uint8Array(s.w_size);e.set(t.subarray(i-s.w_size,i),0),t=e,i=s.w_size}const o=e.avail_in,n=e.next_in,a=e.input;for(e.avail_in=i,e.next_in=0,e.input=t,Pe(s);s.lookahead>=3;){let e=s.strstart,t=s.lookahead-2;do{s.ins_h=ge(s,s.ins_h,s.window[e+3-1]),s.prev[e&s.w_mask]=s.head[s.ins_h],s.head[s.ins_h]=e,e++}while(--t);s.strstart=e,s.lookahead=2,Pe(s)}return s.strstart+=s.lookahead,s.block_start=s.strstart,s.insert=s.lookahead,s.lookahead=0,s.match_length=s.prev_length=2,s.match_available=0,e.next_in=n,e.input=a,e.avail_in=o,s.wrap=r,Z};const Ve=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var Qe=function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const i=t.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(const t in i)Ve(i,t)&&(e[t]=i[t])}}return e},He=e=>{let t=0;for(let i=0,s=e.length;i<s;i++)t+=e[i].length;const i=new Uint8Array(t);for(let t=0,s=0,r=e.length;t<r;t++){let r=e[t];i.set(r,s),s+=r.length}return i};let je=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){je=!1}const Ge=new Uint8Array(256);for(let e=0;e<256;e++)Ge[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;Ge[254]=Ge[254]=1;var ze=e=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(e);let t,i,s,r,o,n=e.length,a=0;for(r=0;r<n;r++)i=e.charCodeAt(r),55296==(64512&i)&&r+1<n&&(s=e.charCodeAt(r+1),56320==(64512&s)&&(i=65536+(i-55296<<10)+(s-56320),r++)),a+=i<128?1:i<2048?2:i<65536?3:4;for(t=new Uint8Array(a),o=0,r=0;o<a;r++)i=e.charCodeAt(r),55296==(64512&i)&&r+1<n&&(s=e.charCodeAt(r+1),56320==(64512&s)&&(i=65536+(i-55296<<10)+(s-56320),r++)),i<128?t[o++]=i:i<2048?(t[o++]=192|i>>>6,t[o++]=128|63&i):i<65536?(t[o++]=224|i>>>12,t[o++]=128|i>>>6&63,t[o++]=128|63&i):(t[o++]=240|i>>>18,t[o++]=128|i>>>12&63,t[o++]=128|i>>>6&63,t[o++]=128|63&i);return t},We=(e,t)=>{const i=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(e.subarray(0,t));let s,r;const o=new Array(2*i);for(r=0,s=0;s<i;){let t=e[s++];if(t<128){o[r++]=t;continue}let n=Ge[t];if(n>4)o[r++]=65533,s+=n-1;else{for(t&=2===n?31:3===n?15:7;n>1&&s<i;)t=t<<6|63&e[s++],n--;n>1?o[r++]=65533:t<65536?o[r++]=t:(t-=65536,o[r++]=55296|t>>10&1023,o[r++]=56320|1023&t)}}return((e,t)=>{if(t<65534&&e.subarray&&je)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let i="";for(let s=0;s<t;s++)i+=String.fromCharCode(e[s]);return i})(o,r)},Xe=(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let i=t-1;for(;i>=0&&128==(192&e[i]);)i--;return i<0||0===i?t:i+Ge[e[i]]>t?i:t},Ke=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const Ze=Object.prototype.toString,{Z_NO_FLUSH:Je,Z_SYNC_FLUSH:Ye,Z_FULL_FLUSH:qe,Z_FINISH:$e,Z_OK:et,Z_STREAM_END:tt,Z_DEFAULT_COMPRESSION:it,Z_DEFAULT_STRATEGY:st,Z_DEFLATED:rt}=O;function ot(e){this.options=Qe({level:it,method:rt,chunkSize:16384,windowBits:15,memLevel:8,strategy:st},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Ke,this.strm.avail_out=0;let i=Ue(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(i!==et)throw new Error(k[i]);if(t.header&&Le(this.strm,t.header),t.dictionary){let e;if(e="string"==typeof t.dictionary?ze(t.dictionary):"[object ArrayBuffer]"===Ze.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,i=Ne(this.strm,e),i!==et)throw new Error(k[i]);this._dict_set=!0}}function nt(e,t){const i=new ot(t);if(i.push(e,!0),i.err)throw i.msg||k[i.err];return i.result}ot.prototype.push=function(e,t){const i=this.strm,s=this.options.chunkSize;let r,o;if(this.ended)return!1;for(o=t===~~t?t:!0===t?$e:Je,"string"==typeof e?i.input=ze(e):"[object ArrayBuffer]"===Ze.call(e)?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;;)if(0===i.avail_out&&(i.output=new Uint8Array(s),i.next_out=0,i.avail_out=s),(o===Ye||o===qe)&&i.avail_out<=6)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else{if(r=ke(i,o),r===tt)return i.next_out>0&&this.onData(i.output.subarray(0,i.next_out)),r=Oe(this.strm),this.onEnd(r),this.ended=!0,r===et;if(0!==i.avail_out){if(o>0&&i.next_out>0)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else if(0===i.avail_in)break}else this.onData(i.output)}return!0},ot.prototype.onData=function(e){this.chunks.push(e)},ot.prototype.onEnd=function(e){e===et&&(this.result=He(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var at={Deflate:ot,deflate:nt,deflateRaw:function(e,t){return(t=t||{}).raw=!0,nt(e,t)},gzip:function(e,t){return(t=t||{}).gzip=!0,nt(e,t)},constants:O};const lt=16209;var At=function(e,t){let i,s,r,o,n,a,l,A,c,h,u,d,p,f,m,g,_,v,b,y,w,B,P,x;const C=e.state;i=e.next_in,P=e.input,s=i+(e.avail_in-5),r=e.next_out,x=e.output,o=r-(t-e.avail_out),n=r+(e.avail_out-257),a=C.dmax,l=C.wsize,A=C.whave,c=C.wnext,h=C.window,u=C.hold,d=C.bits,p=C.lencode,f=C.distcode,m=(1<<C.lenbits)-1,g=(1<<C.distbits)-1;e:do{d<15&&(u+=P[i++]<<d,d+=8,u+=P[i++]<<d,d+=8),_=p[u&m];t:for(;;){if(v=_>>>24,u>>>=v,d-=v,v=_>>>16&255,0===v)x[r++]=65535&_;else{if(!(16&v)){if(0==(64&v)){_=p[(65535&_)+(u&(1<<v)-1)];continue t}if(32&v){C.mode=16191;break e}e.msg="invalid literal/length code",C.mode=lt;break e}b=65535&_,v&=15,v&&(d<v&&(u+=P[i++]<<d,d+=8),b+=u&(1<<v)-1,u>>>=v,d-=v),d<15&&(u+=P[i++]<<d,d+=8,u+=P[i++]<<d,d+=8),_=f[u&g];i:for(;;){if(v=_>>>24,u>>>=v,d-=v,v=_>>>16&255,!(16&v)){if(0==(64&v)){_=f[(65535&_)+(u&(1<<v)-1)];continue i}e.msg="invalid distance code",C.mode=lt;break e}if(y=65535&_,v&=15,d<v&&(u+=P[i++]<<d,d+=8,d<v&&(u+=P[i++]<<d,d+=8)),y+=u&(1<<v)-1,y>a){e.msg="invalid distance too far back",C.mode=lt;break e}if(u>>>=v,d-=v,v=r-o,y>v){if(v=y-v,v>A&&C.sane){e.msg="invalid distance too far back",C.mode=lt;break e}if(w=0,B=h,0===c){if(w+=l-v,v<b){b-=v;do{x[r++]=h[w++]}while(--v);w=r-y,B=x}}else if(c<v){if(w+=l+c-v,v-=c,v<b){b-=v;do{x[r++]=h[w++]}while(--v);if(w=0,c<b){v=c,b-=v;do{x[r++]=h[w++]}while(--v);w=r-y,B=x}}}else if(w+=c-v,v<b){b-=v;do{x[r++]=h[w++]}while(--v);w=r-y,B=x}for(;b>2;)x[r++]=B[w++],x[r++]=B[w++],x[r++]=B[w++],b-=3;b&&(x[r++]=B[w++],b>1&&(x[r++]=B[w++]))}else{w=r-y;do{x[r++]=x[w++],x[r++]=x[w++],x[r++]=x[w++],b-=3}while(b>2);b&&(x[r++]=x[w++],b>1&&(x[r++]=x[w++]))}break}}break}}while(i<s&&r<n);b=d>>3,i-=b,d-=b<<3,u&=(1<<d)-1,e.next_in=i,e.next_out=r,e.avail_in=i<s?s-i+5:5-(i-s),e.avail_out=r<n?n-r+257:257-(r-n),C.hold=u,C.bits=d};const ct=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),ht=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),ut=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),dt=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var pt=(e,t,i,s,r,o,n,a)=>{const l=a.bits;let A,c,h,u,d,p,f=0,m=0,g=0,_=0,v=0,b=0,y=0,w=0,B=0,P=0,x=null;const C=new Uint16Array(16),M=new Uint16Array(16);let E,F,I,T=null;for(f=0;f<=15;f++)C[f]=0;for(m=0;m<s;m++)C[t[i+m]]++;for(v=l,_=15;_>=1&&0===C[_];_--);if(v>_&&(v=_),0===_)return r[o++]=20971520,r[o++]=20971520,a.bits=1,0;for(g=1;g<_&&0===C[g];g++);for(v<g&&(v=g),w=1,f=1;f<=15;f++)if(w<<=1,w-=C[f],w<0)return-1;if(w>0&&(0===e||1!==_))return-1;for(M[1]=0,f=1;f<15;f++)M[f+1]=M[f]+C[f];for(m=0;m<s;m++)0!==t[i+m]&&(n[M[t[i+m]]++]=m);if(0===e?(x=T=n,p=20):1===e?(x=ct,T=ht,p=257):(x=ut,T=dt,p=0),P=0,m=0,f=g,d=o,b=v,y=0,h=-1,B=1<<v,u=B-1,1===e&&B>852||2===e&&B>592)return 1;for(;;){E=f-y,n[m]+1<p?(F=0,I=n[m]):n[m]>=p?(F=T[n[m]-p],I=x[n[m]-p]):(F=96,I=0),A=1<<f-y,c=1<<b,g=c;do{c-=A,r[d+(P>>y)+c]=E<<24|F<<16|I|0}while(0!==c);for(A=1<<f-1;P&A;)A>>=1;if(0!==A?(P&=A-1,P+=A):P=0,m++,0==--C[f]){if(f===_)break;f=t[i+n[m]]}if(f>v&&(P&u)!==h){for(0===y&&(y=v),d+=g,b=f-y,w=1<<b;b+y<_&&(w-=C[b+y],!(w<=0));)b++,w<<=1;if(B+=1<<b,1===e&&B>852||2===e&&B>592)return 1;h=P&u,r[h]=v<<24|b<<16|d-o|0}}return 0!==P&&(r[d+P]=f-y<<24|64<<16|0),a.bits=v,0};const{Z_FINISH:ft,Z_BLOCK:mt,Z_TREES:gt,Z_OK:_t,Z_STREAM_END:vt,Z_NEED_DICT:bt,Z_STREAM_ERROR:yt,Z_DATA_ERROR:wt,Z_MEM_ERROR:Bt,Z_BUF_ERROR:Pt,Z_DEFLATED:xt}=O,Ct=16180,Mt=16190,Et=16191,Ft=16192,It=16194,Tt=16199,Dt=16200,St=16206,Rt=16209,Ut=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function Lt(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const kt=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<Ct||t.mode>16211?1:0},Ot=e=>{if(kt(e))return yt;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=Ct,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,_t},Nt=e=>{if(kt(e))return yt;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,Ot(e)},Vt=(e,t)=>{let i;if(kt(e))return yt;const s=e.state;return t<0?(i=0,t=-t):(i=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?yt:(null!==s.window&&s.wbits!==t&&(s.window=null),s.wrap=i,s.wbits=t,Nt(e))},Qt=(e,t)=>{if(!e)return yt;const i=new Lt;e.state=i,i.strm=e,i.window=null,i.mode=Ct;const s=Vt(e,t);return s!==_t&&(e.state=null),s};let Ht,jt,Gt=!0;const zt=e=>{if(Gt){Ht=new Int32Array(512),jt=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(pt(1,e.lens,0,288,Ht,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;pt(2,e.lens,0,32,jt,0,e.work,{bits:5}),Gt=!1}e.lencode=Ht,e.lenbits=9,e.distcode=jt,e.distbits=5},Wt=(e,t,i,s)=>{let r;const o=e.state;return null===o.window&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),s>=o.wsize?(o.window.set(t.subarray(i-o.wsize,i),0),o.wnext=0,o.whave=o.wsize):(r=o.wsize-o.wnext,r>s&&(r=s),o.window.set(t.subarray(i-s,i-s+r),o.wnext),(s-=r)?(o.window.set(t.subarray(i-s,i),0),o.wnext=s,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0};var Xt=Nt,Kt=Qt,Zt=(e,t)=>{let i,s,r,o,n,a,l,A,c,h,u,d,p,f,m,g,_,v,b,y,w,B,P=0;const x=new Uint8Array(4);let C,M;const E=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(kt(e)||!e.output||!e.input&&0!==e.avail_in)return yt;i=e.state,i.mode===Et&&(i.mode=Ft),n=e.next_out,r=e.output,l=e.avail_out,o=e.next_in,s=e.input,a=e.avail_in,A=i.hold,c=i.bits,h=a,u=l,B=_t;e:for(;;)switch(i.mode){case Ct:if(0===i.wrap){i.mode=Ft;break}for(;c<16;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}if(2&i.wrap&&35615===A){0===i.wbits&&(i.wbits=15),i.check=0,x[0]=255&A,x[1]=A>>>8&255,i.check=L(i.check,x,2,0),A=0,c=0,i.mode=16181;break}if(i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&A)<<8)+(A>>8))%31){e.msg="incorrect header check",i.mode=Rt;break}if((15&A)!==xt){e.msg="unknown compression method",i.mode=Rt;break}if(A>>>=4,c-=4,w=8+(15&A),0===i.wbits&&(i.wbits=w),w>15||w>i.wbits){e.msg="invalid window size",i.mode=Rt;break}i.dmax=1<<i.wbits,i.flags=0,e.adler=i.check=1,i.mode=512&A?16189:Et,A=0,c=0;break;case 16181:for(;c<16;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}if(i.flags=A,(255&i.flags)!==xt){e.msg="unknown compression method",i.mode=Rt;break}if(57344&i.flags){e.msg="unknown header flags set",i.mode=Rt;break}i.head&&(i.head.text=A>>8&1),512&i.flags&&4&i.wrap&&(x[0]=255&A,x[1]=A>>>8&255,i.check=L(i.check,x,2,0)),A=0,c=0,i.mode=16182;case 16182:for(;c<32;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}i.head&&(i.head.time=A),512&i.flags&&4&i.wrap&&(x[0]=255&A,x[1]=A>>>8&255,x[2]=A>>>16&255,x[3]=A>>>24&255,i.check=L(i.check,x,4,0)),A=0,c=0,i.mode=16183;case 16183:for(;c<16;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}i.head&&(i.head.xflags=255&A,i.head.os=A>>8),512&i.flags&&4&i.wrap&&(x[0]=255&A,x[1]=A>>>8&255,i.check=L(i.check,x,2,0)),A=0,c=0,i.mode=16184;case 16184:if(1024&i.flags){for(;c<16;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}i.length=A,i.head&&(i.head.extra_len=A),512&i.flags&&4&i.wrap&&(x[0]=255&A,x[1]=A>>>8&255,i.check=L(i.check,x,2,0)),A=0,c=0}else i.head&&(i.head.extra=null);i.mode=16185;case 16185:if(1024&i.flags&&(d=i.length,d>a&&(d=a),d&&(i.head&&(w=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Uint8Array(i.head.extra_len)),i.head.extra.set(s.subarray(o,o+d),w)),512&i.flags&&4&i.wrap&&(i.check=L(i.check,s,d,o)),a-=d,o+=d,i.length-=d),i.length))break e;i.length=0,i.mode=16186;case 16186:if(2048&i.flags){if(0===a)break e;d=0;do{w=s[o+d++],i.head&&w&&i.length<65536&&(i.head.name+=String.fromCharCode(w))}while(w&&d<a);if(512&i.flags&&4&i.wrap&&(i.check=L(i.check,s,d,o)),a-=d,o+=d,w)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=16187;case 16187:if(4096&i.flags){if(0===a)break e;d=0;do{w=s[o+d++],i.head&&w&&i.length<65536&&(i.head.comment+=String.fromCharCode(w))}while(w&&d<a);if(512&i.flags&&4&i.wrap&&(i.check=L(i.check,s,d,o)),a-=d,o+=d,w)break e}else i.head&&(i.head.comment=null);i.mode=16188;case 16188:if(512&i.flags){for(;c<16;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}if(4&i.wrap&&A!==(65535&i.check)){e.msg="header crc mismatch",i.mode=Rt;break}A=0,c=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=Et;break;case 16189:for(;c<32;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}e.adler=i.check=Ut(A),A=0,c=0,i.mode=Mt;case Mt:if(0===i.havedict)return e.next_out=n,e.avail_out=l,e.next_in=o,e.avail_in=a,i.hold=A,i.bits=c,bt;e.adler=i.check=1,i.mode=Et;case Et:if(t===mt||t===gt)break e;case Ft:if(i.last){A>>>=7&c,c-=7&c,i.mode=St;break}for(;c<3;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}switch(i.last=1&A,A>>>=1,c-=1,3&A){case 0:i.mode=16193;break;case 1:if(zt(i),i.mode=Tt,t===gt){A>>>=2,c-=2;break e}break;case 2:i.mode=16196;break;case 3:e.msg="invalid block type",i.mode=Rt}A>>>=2,c-=2;break;case 16193:for(A>>>=7&c,c-=7&c;c<32;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}if((65535&A)!=(A>>>16^65535)){e.msg="invalid stored block lengths",i.mode=Rt;break}if(i.length=65535&A,A=0,c=0,i.mode=It,t===gt)break e;case It:i.mode=16195;case 16195:if(d=i.length,d){if(d>a&&(d=a),d>l&&(d=l),0===d)break e;r.set(s.subarray(o,o+d),n),a-=d,o+=d,l-=d,n+=d,i.length-=d;break}i.mode=Et;break;case 16196:for(;c<14;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}if(i.nlen=257+(31&A),A>>>=5,c-=5,i.ndist=1+(31&A),A>>>=5,c-=5,i.ncode=4+(15&A),A>>>=4,c-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=Rt;break}i.have=0,i.mode=16197;case 16197:for(;i.have<i.ncode;){for(;c<3;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}i.lens[E[i.have++]]=7&A,A>>>=3,c-=3}for(;i.have<19;)i.lens[E[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,C={bits:i.lenbits},B=pt(0,i.lens,0,19,i.lencode,0,i.work,C),i.lenbits=C.bits,B){e.msg="invalid code lengths set",i.mode=Rt;break}i.have=0,i.mode=16198;case 16198:for(;i.have<i.nlen+i.ndist;){for(;P=i.lencode[A&(1<<i.lenbits)-1],m=P>>>24,g=P>>>16&255,_=65535&P,!(m<=c);){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}if(_<16)A>>>=m,c-=m,i.lens[i.have++]=_;else{if(16===_){for(M=m+2;c<M;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}if(A>>>=m,c-=m,0===i.have){e.msg="invalid bit length repeat",i.mode=Rt;break}w=i.lens[i.have-1],d=3+(3&A),A>>>=2,c-=2}else if(17===_){for(M=m+3;c<M;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}A>>>=m,c-=m,w=0,d=3+(7&A),A>>>=3,c-=3}else{for(M=m+7;c<M;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}A>>>=m,c-=m,w=0,d=11+(127&A),A>>>=7,c-=7}if(i.have+d>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=Rt;break}for(;d--;)i.lens[i.have++]=w}}if(i.mode===Rt)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=Rt;break}if(i.lenbits=9,C={bits:i.lenbits},B=pt(1,i.lens,0,i.nlen,i.lencode,0,i.work,C),i.lenbits=C.bits,B){e.msg="invalid literal/lengths set",i.mode=Rt;break}if(i.distbits=6,i.distcode=i.distdyn,C={bits:i.distbits},B=pt(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,C),i.distbits=C.bits,B){e.msg="invalid distances set",i.mode=Rt;break}if(i.mode=Tt,t===gt)break e;case Tt:i.mode=Dt;case Dt:if(a>=6&&l>=258){e.next_out=n,e.avail_out=l,e.next_in=o,e.avail_in=a,i.hold=A,i.bits=c,At(e,u),n=e.next_out,r=e.output,l=e.avail_out,o=e.next_in,s=e.input,a=e.avail_in,A=i.hold,c=i.bits,i.mode===Et&&(i.back=-1);break}for(i.back=0;P=i.lencode[A&(1<<i.lenbits)-1],m=P>>>24,g=P>>>16&255,_=65535&P,!(m<=c);){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}if(g&&0==(240&g)){for(v=m,b=g,y=_;P=i.lencode[y+((A&(1<<v+b)-1)>>v)],m=P>>>24,g=P>>>16&255,_=65535&P,!(v+m<=c);){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}A>>>=v,c-=v,i.back+=v}if(A>>>=m,c-=m,i.back+=m,i.length=_,0===g){i.mode=16205;break}if(32&g){i.back=-1,i.mode=Et;break}if(64&g){e.msg="invalid literal/length code",i.mode=Rt;break}i.extra=15&g,i.mode=16201;case 16201:if(i.extra){for(M=i.extra;c<M;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}i.length+=A&(1<<i.extra)-1,A>>>=i.extra,c-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=16202;case 16202:for(;P=i.distcode[A&(1<<i.distbits)-1],m=P>>>24,g=P>>>16&255,_=65535&P,!(m<=c);){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}if(0==(240&g)){for(v=m,b=g,y=_;P=i.distcode[y+((A&(1<<v+b)-1)>>v)],m=P>>>24,g=P>>>16&255,_=65535&P,!(v+m<=c);){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}A>>>=v,c-=v,i.back+=v}if(A>>>=m,c-=m,i.back+=m,64&g){e.msg="invalid distance code",i.mode=Rt;break}i.offset=_,i.extra=15&g,i.mode=16203;case 16203:if(i.extra){for(M=i.extra;c<M;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}i.offset+=A&(1<<i.extra)-1,A>>>=i.extra,c-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=Rt;break}i.mode=16204;case 16204:if(0===l)break e;if(d=u-l,i.offset>d){if(d=i.offset-d,d>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=Rt;break}d>i.wnext?(d-=i.wnext,p=i.wsize-d):p=i.wnext-d,d>i.length&&(d=i.length),f=i.window}else f=r,p=n-i.offset,d=i.length;d>l&&(d=l),l-=d,i.length-=d;do{r[n++]=f[p++]}while(--d);0===i.length&&(i.mode=Dt);break;case 16205:if(0===l)break e;r[n++]=i.length,l--,i.mode=Dt;break;case St:if(i.wrap){for(;c<32;){if(0===a)break e;a--,A|=s[o++]<<c,c+=8}if(u-=l,e.total_out+=u,i.total+=u,4&i.wrap&&u&&(e.adler=i.check=i.flags?L(i.check,r,u,n-u):R(i.check,r,u,n-u)),u=l,4&i.wrap&&(i.flags?A:Ut(A))!==i.check){e.msg="incorrect data check",i.mode=Rt;break}A=0,c=0}i.mode=16207;case 16207:if(i.wrap&&i.flags){for(;c<32;){if(0===a)break e;a--,A+=s[o++]<<c,c+=8}if(4&i.wrap&&A!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=Rt;break}A=0,c=0}i.mode=16208;case 16208:B=vt;break e;case Rt:B=wt;break e;case 16210:return Bt;default:return yt}return e.next_out=n,e.avail_out=l,e.next_in=o,e.avail_in=a,i.hold=A,i.bits=c,(i.wsize||u!==e.avail_out&&i.mode<Rt&&(i.mode<St||t!==ft))&&Wt(e,e.output,e.next_out,u-e.avail_out),h-=e.avail_in,u-=e.avail_out,e.total_in+=h,e.total_out+=u,i.total+=u,4&i.wrap&&u&&(e.adler=i.check=i.flags?L(i.check,r,u,e.next_out-u):R(i.check,r,u,e.next_out-u)),e.data_type=i.bits+(i.last?64:0)+(i.mode===Et?128:0)+(i.mode===Tt||i.mode===It?256:0),(0===h&&0===u||t===ft)&&B===_t&&(B=Pt),B},Jt=e=>{if(kt(e))return yt;let t=e.state;return t.window&&(t.window=null),e.state=null,_t},Yt=(e,t)=>{if(kt(e))return yt;const i=e.state;return 0==(2&i.wrap)?yt:(i.head=t,t.done=!1,_t)},qt=(e,t)=>{const i=t.length;let s,r,o;return kt(e)?yt:(s=e.state,0!==s.wrap&&s.mode!==Mt?yt:s.mode===Mt&&(r=1,r=R(r,t,i,0),r!==s.check)?wt:(o=Wt(e,t,i,i),o?(s.mode=16210,Bt):(s.havedict=1,_t)))},$t=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const ei=Object.prototype.toString,{Z_NO_FLUSH:ti,Z_FINISH:ii,Z_OK:si,Z_STREAM_END:ri,Z_NEED_DICT:oi,Z_STREAM_ERROR:ni,Z_DATA_ERROR:ai,Z_MEM_ERROR:li}=O;function Ai(e){this.options=Qe({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Ke,this.strm.avail_out=0;let i=Kt(this.strm,t.windowBits);if(i!==si)throw new Error(k[i]);if(this.header=new $t,Yt(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=ze(t.dictionary):"[object ArrayBuffer]"===ei.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(i=qt(this.strm,t.dictionary),i!==si)))throw new Error(k[i])}function ci(e,t){const i=new Ai(t);if(i.push(e),i.err)throw i.msg||k[i.err];return i.result}Ai.prototype.push=function(e,t){const i=this.strm,s=this.options.chunkSize,r=this.options.dictionary;let o,n,a;if(this.ended)return!1;for(n=t===~~t?t:!0===t?ii:ti,"[object ArrayBuffer]"===ei.call(e)?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;;){for(0===i.avail_out&&(i.output=new Uint8Array(s),i.next_out=0,i.avail_out=s),o=Zt(i,n),o===oi&&r&&(o=qt(i,r),o===si?o=Zt(i,n):o===ai&&(o=oi));i.avail_in>0&&o===ri&&i.state.wrap>0&&0!==e[i.next_in];)Xt(i),o=Zt(i,n);switch(o){case ni:case ai:case oi:case li:return this.onEnd(o),this.ended=!0,!1}if(a=i.avail_out,i.next_out&&(0===i.avail_out||o===ri))if("string"===this.options.to){let e=Xe(i.output,i.next_out),t=i.next_out-e,r=We(i.output,e);i.next_out=t,i.avail_out=s-t,t&&i.output.set(i.output.subarray(e,e+t),0),this.onData(r)}else this.onData(i.output.length===i.next_out?i.output:i.output.subarray(0,i.next_out));if(o!==si||0!==a){if(o===ri)return o=Jt(this.strm),this.onEnd(o),this.ended=!0,!0;if(0===i.avail_in)break}}return!0},Ai.prototype.onData=function(e){this.chunks.push(e)},Ai.prototype.onEnd=function(e){e===si&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=He(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var hi={Inflate:Ai,inflate:ci,inflateRaw:function(e,t){return(t=t||{}).raw=!0,ci(e,t)},ungzip:ci,constants:O};const{Deflate:ui,deflate:di,deflateRaw:pi,gzip:fi}=at,{Inflate:mi,inflate:gi,inflateRaw:_i,ungzip:vi}=hi;var bi=ui,yi=di,wi=pi,Bi=fi,Pi=mi,xi=gi,Ci=_i,Mi=vi,Ei=O,Fi={Deflate:bi,deflate:yi,deflateRaw:wi,gzip:Bi,Inflate:Pi,inflate:xi,inflateRaw:Ci,ungzip:Mi,constants:Ei};e.Deflate=bi,e.Inflate=Pi,e.constants=Ei,e.default=Fi,e.deflate=yi,e.deflateRaw=wi,e.gzip=Bi,e.inflate=xi,e.inflateRaw=Ci,e.ungzip=Mi,Object.defineProperty(e,"__esModule",{value:!0})}));var PE=Object.freeze({__proto__:null});let xE=window.pako||PE;xE.inflate||(xE=xE.default);const CE=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const ME={version:1,parse:function(e,t,i,s,r,o){const n=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],positionsDecodeMatrix:e[11]}}(i),a=function(e){return{positions:new Uint16Array(xE.inflate(e.positions).buffer),normals:new Int8Array(xE.inflate(e.normals).buffer),indices:new Uint32Array(xE.inflate(e.indices).buffer),edgeIndices:new Uint32Array(xE.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(xE.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(xE.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(xE.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(xE.inflate(e.meshColors).buffer),entityIDs:xE.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(xE.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(xE.inflate(e.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(xE.inflate(e.positionsDecodeMatrix).buffer)}}(n);!function(e,t,i,s,r,o){o.getNextId(),s.positionsCompression="precompressed",s.normalsCompression="precompressed";const n=i.positions,a=i.normals,l=i.indices,A=i.edgeIndices,c=i.meshPositions,h=i.meshIndices,u=i.meshEdgesIndices,p=i.meshColors,f=JSON.parse(i.entityIDs),m=i.entityMeshes,g=i.entityIsObjects,_=c.length,v=m.length;for(let r=0;r<v;r++){const o=f[r],b=t.globalizeObjectIds?d.globalizeObjectId(s.id,o):o,w=e.metaScene.metaObjects[b],B={},P={};if(w){if(t.excludeTypesMap&&w.type&&t.excludeTypesMap[w.type])continue;if(t.includeTypesMap&&w.type&&!t.includeTypesMap[w.type])continue;const e=t.objectDefaults?t.objectDefaults[w.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(B.visible=!1),!1===e.pickable&&(B.pickable=!1),e.colorize&&(P.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(P.opacity=e.opacity))}else if(t.excludeUnclassifiedObjects)continue;const x=r===v-1,C=[];for(let e=m[r],t=x?m.length:m[r+1];e<t;e++){const t=e===_-1,r=b+".mesh."+e,o=CE(p.subarray(4*e,4*e+3)),d=p[4*e+3]/255;s.createMesh(y.apply(P,{id:r,primitive:"triangles",positionsCompressed:n.subarray(c[e],t?n.length:c[e+1]),normalsCompressed:a.subarray(c[e],t?n.length:c[e+1]),indices:l.subarray(h[e],t?l.length:h[e+1]),edgeIndices:A.subarray(u[e],t?A.length:u[e+1]),positionsDecodeMatrix:i.positionsDecodeMatrix,color:o,opacity:d})),C.push(r)}s.createEntity(y.apply(B,{id:b,isObject:1===g[r],meshIds:C}))}}(e,t,a,s,0,o)}};let EE=window.pako||PE;EE.inflate||(EE=EE.default);const FE=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const IE={version:2,parse:function(e,t,i,s,r,o){const n=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],positionsDecodeMatrix:e[11],entityMeshIds:e[12],entityMatrices:e[13],entityUsesInstancing:e[14]}}(i),a=function(e){return{positions:new Uint16Array(EE.inflate(e.positions).buffer),normals:new Int8Array(EE.inflate(e.normals).buffer),indices:new Uint32Array(EE.inflate(e.indices).buffer),edgeIndices:new Uint32Array(EE.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(EE.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(EE.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(EE.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(EE.inflate(e.meshColors).buffer),entityIDs:EE.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(EE.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(EE.inflate(e.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(EE.inflate(e.positionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(EE.inflate(e.entityMeshIds).buffer),entityMatrices:new Float32Array(EE.inflate(e.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(EE.inflate(e.entityUsesInstancing).buffer)}}(n);!function(e,t,i,s,r,o){const n=o.getNextId();s.positionsCompression="precompressed",s.normalsCompression="precompressed";const a=i.positions,l=i.normals,A=i.indices,c=i.edgeIndices,h=i.meshPositions,u=i.meshIndices,p=i.meshEdgesIndices,f=i.meshColors,m=JSON.parse(i.entityIDs),g=i.entityMeshes,_=i.entityIsObjects,v=i.entityMeshIds,b=i.entityMatrices,w=i.entityUsesInstancing,B=h.length,P=g.length,x={};for(let r=0;r<P;r++){const C=m[r],M=t.globalizeObjectIds?d.globalizeObjectId(s.id,C):C,E=e.metaScene.metaObjects[M],F={},I={},T=b.subarray(16*r,16*r+16);if(E){if(t.excludeTypesMap&&E.type&&t.excludeTypesMap[E.type])continue;if(t.includeTypesMap&&E.type&&!t.includeTypesMap[E.type])continue;const e=t.objectDefaults?t.objectDefaults[E.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(F.visible=!1),!1===e.pickable&&(F.pickable=!1),e.colorize&&(I.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(I.opacity=e.opacity))}else if(t.excludeUnclassifiedObjects)continue;const D=r===P-1,S=[];for(let e=g[r],t=D?v.length:g[r+1];e<t;e++){const t=v[e],d=t===B-1,m=o.getNextId(),g=FE(f.subarray(4*t,4*t+3)),_=f[4*t+3]/255,b=a.subarray(h[t],d?a.length:h[t+1]),P=l.subarray(h[t],d?a.length:h[t+1]),C=A.subarray(u[t],d?A.length:u[t+1]),M=c.subarray(p[t],d?c.length:p[t+1]);if(1===w[r]){const e=`${n}.geometry.${m}.${t}`;e in x||(s.createGeometry({id:e,positionsCompressed:b,normalsCompressed:P,indices:C,edgeIndices:M,primitive:"triangles",positionsDecodeMatrix:i.positionsDecodeMatrix}),x[e]=!0),s.createMesh(y.apply(I,{id:m,color:g,opacity:_,matrix:T,geometryId:e})),S.push(m)}else s.createMesh(y.apply(I,{id:m,primitive:"triangles",positionsCompressed:b,normalsCompressed:P,indices:C,edgeIndices:M,positionsDecodeMatrix:i.positionsDecodeMatrix,color:g,opacity:_})),S.push(m)}S.length&&s.createEntity(y.apply(F,{id:M,isObject:1===_[r],meshIds:S}))}}(e,t,a,s,0,o)}};let TE=window.pako||PE;TE.inflate||(TE=TE.default);const DE=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const SE={version:3,parse:function(e,t,i,s,r,o){const n=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],meshPositions:e[4],meshIndices:e[5],meshEdgesIndices:e[6],meshColors:e[7],entityIDs:e[8],entityMeshes:e[9],entityIsObjects:e[10],instancedPositionsDecodeMatrix:e[11],batchedPositionsDecodeMatrix:e[12],entityMeshIds:e[13],entityMatrices:e[14],entityUsesInstancing:e[15]}}(i),a=function(e){return{positions:new Uint16Array(TE.inflate(e.positions).buffer),normals:new Int8Array(TE.inflate(e.normals).buffer),indices:new Uint32Array(TE.inflate(e.indices).buffer),edgeIndices:new Uint32Array(TE.inflate(e.edgeIndices).buffer),meshPositions:new Uint32Array(TE.inflate(e.meshPositions).buffer),meshIndices:new Uint32Array(TE.inflate(e.meshIndices).buffer),meshEdgesIndices:new Uint32Array(TE.inflate(e.meshEdgesIndices).buffer),meshColors:new Uint8Array(TE.inflate(e.meshColors).buffer),entityIDs:TE.inflate(e.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(TE.inflate(e.entityMeshes).buffer),entityIsObjects:new Uint8Array(TE.inflate(e.entityIsObjects).buffer),instancedPositionsDecodeMatrix:new Float32Array(TE.inflate(e.instancedPositionsDecodeMatrix).buffer),batchedPositionsDecodeMatrix:new Float32Array(TE.inflate(e.batchedPositionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(TE.inflate(e.entityMeshIds).buffer),entityMatrices:new Float32Array(TE.inflate(e.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(TE.inflate(e.entityUsesInstancing).buffer)}}(n);!function(e,t,i,s,r,o){const n=o.getNextId();s.positionsCompression="precompressed",s.normalsCompression="precompressed";const a=i.positions,l=i.normals,A=i.indices,c=i.edgeIndices,h=i.meshPositions,u=i.meshIndices,p=i.meshEdgesIndices,f=i.meshColors,m=JSON.parse(i.entityIDs),g=i.entityMeshes,_=i.entityIsObjects,v=i.entityMeshIds,b=i.entityMatrices,w=i.entityUsesInstancing,B=h.length,P=g.length,x={};for(let r=0;r<P;r++){const o=m[r],T=t.globalizeObjectIds?d.globalizeObjectId(s.id,o):o,D=e.metaScene.metaObjects[T],S={},R={},U=b.subarray(16*r,16*r+16);if(D){if(t.excludeTypesMap&&D.type&&t.excludeTypesMap[D.type])continue;if(t.includeTypesMap&&D.type&&!t.includeTypesMap[D.type])continue;const e=t.objectDefaults?t.objectDefaults[D.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(S.visible=!1),!1===e.pickable&&(S.pickable=!1),e.colorize&&(R.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(R.opacity=e.opacity))}else if(t.excludeUnclassifiedObjects)continue;const L=r===P-1,k=[];for(let e=g[r],t=L?v.length:g[r+1];e<t;e++){var C=v[e];const t=C===B-1,o=`${n}.${T}.mesh.${C}`,d=DE(f.subarray(4*C,4*C+3)),m=f[4*C+3]/255;var M=a.subarray(h[C],t?a.length:h[C+1]),E=l.subarray(h[C],t?a.length:h[C+1]),F=A.subarray(u[C],t?A.length:u[C+1]),I=c.subarray(p[C],t?c.length:p[C+1]);if(1===w[r]){const e=`${n}.geometry.${o}.${C}`;e in x||(s.createGeometry({id:e,positionsCompressed:M,normalsCompressed:E,indices:F,edgeIndices:I,primitive:"triangles",positionsDecodeMatrix:i.instancedPositionsDecodeMatrix}),x[e]=!0),s.createMesh(y.apply(R,{id:o,color:d,opacity:m,matrix:U,geometryId:e})),k.push(o)}else s.createMesh(y.apply(R,{id:o,primitive:"triangles",positionsCompressed:M,normalsCompressed:E,indices:F,edgeIndices:I,positionsDecodeMatrix:i.batchedPositionsDecodeMatrix,color:d,opacity:m})),k.push(o)}k.length&&s.createEntity(y.apply(S,{id:T,isObject:1===_[r],meshIds:k}))}}(e,t,a,s,0,o)}};let RE=window.pako||PE;RE.inflate||(RE=RE.default);const UE=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const LE={version:4,parse:function(e,t,i,s,r,o){const n=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],decodeMatrices:e[4],matrices:e[5],eachPrimitivePositionsAndNormalsPortion:e[6],eachPrimitiveIndicesPortion:e[7],eachPrimitiveEdgeIndicesPortion:e[8],eachPrimitiveDecodeMatricesPortion:e[9],eachPrimitiveColor:e[10],primitiveInstances:e[11],eachEntityId:e[12],eachEntityPrimitiveInstancesPortion:e[13],eachEntityMatricesPortion:e[14],eachEntityMatrix:e[15]}}(i),a=function(e){return{positions:new Uint16Array(RE.inflate(e.positions).buffer),normals:new Int8Array(RE.inflate(e.normals).buffer),indices:new Uint32Array(RE.inflate(e.indices).buffer),edgeIndices:new Uint32Array(RE.inflate(e.edgeIndices).buffer),decodeMatrices:new Float32Array(RE.inflate(e.decodeMatrices).buffer),matrices:new Float32Array(RE.inflate(e.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(RE.inflate(e.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(RE.inflate(e.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(RE.inflate(e.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveDecodeMatricesPortion:new Uint32Array(RE.inflate(e.eachPrimitiveDecodeMatricesPortion).buffer),eachPrimitiveColor:new Uint8Array(RE.inflate(e.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(RE.inflate(e.primitiveInstances).buffer),eachEntityId:RE.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(RE.inflate(e.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(RE.inflate(e.eachEntityMatricesPortion).buffer)}}(n);!function(e,t,i,s,r,o){const n=o.getNextId();s.positionsCompression="precompressed",s.normalsCompression="precompressed";const a=i.positions,l=i.normals,A=i.indices,c=i.edgeIndices,h=i.decodeMatrices,u=i.matrices,d=i.eachPrimitivePositionsAndNormalsPortion,p=i.eachPrimitiveIndicesPortion,f=i.eachPrimitiveEdgeIndicesPortion,m=i.eachPrimitiveDecodeMatricesPortion,g=i.eachPrimitiveColor,_=i.primitiveInstances,v=JSON.parse(i.eachEntityId),b=i.eachEntityPrimitiveInstancesPortion,w=i.eachEntityMatricesPortion,B=d.length,P=_.length,x=new Uint8Array(B),C=new Uint32Array(B),M=v.length;for(let e=0;e<B;e++)C[e]=e;C.sort(((e,t)=>m[e]<m[t]?-1:m[e]>m[t]?1:0));for(let e=0;e<P;e++)x[_[e]]++;const E={};for(let e=0;e<M;e++){const t=M-1,i=e===t,s=b[e],r=i?b[t]:b[e+1];for(let t=s;t<r;t++){const i=_[t];x[i]>1||(E[i]=e)}}for(let e=0;e<B;e++){const t=C[e],i=t===B-1,r=x[t]>1,o=UE(g.subarray(4*t,4*t+3)),u=g[4*t+3]/255,_=a.subarray(d[t],i?a.length:d[t+1]),b=l.subarray(d[t],i?l.length:d[t+1]),w=A.subarray(p[t],i?A.length:p[t+1]),P=c.subarray(f[t],i?c.length:f[t+1]),M=h.subarray(m[t],m[t]+16);if(r){const e=`${n}-geometry.${t}`;s.createGeometry({id:e,primitive:"triangles",positionsCompressed:_,normalsCompressed:b,indices:w,edgeIndices:P,positionsDecodeMatrix:M})}else{const e=`${n}-${t}`;v[E[t]];const i={};s.createMesh(y.apply(i,{id:e,primitive:"triangles",positionsCompressed:_,normalsCompressed:b,indices:w,edgeIndices:P,positionsDecodeMatrix:M,color:o,opacity:u}))}}let F=0;for(let e=0;e<M;e++){const t=M-1,i=e===t,r=v[e],o=b[e],a=i?b[t]:b[e+1],l=[];for(let t=o;t<a;t++){const i=_[t];if(x[i]>1){const t={},r=`${n}-instance.${F++}`,o=`${n}-geometry.${i}`,a=16*w[e],A=u.subarray(a,a+16);s.createMesh(y.apply(t,{id:r,geometryId:o,matrix:A})),l.push(r)}else l.push(i)}if(l.length>0){const e={};s.createEntity(y.apply(e,{id:r,isObject:!0,meshIds:l}))}}}(0,0,a,s,0,o)}};let kE=window.pako||PE;kE.inflate||(kE=kE.default);const OE=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const NE={version:5,parse:function(e,t,i,s,r,o){const n=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],matrices:e[4],eachPrimitivePositionsAndNormalsPortion:e[5],eachPrimitiveIndicesPortion:e[6],eachPrimitiveEdgeIndicesPortion:e[7],eachPrimitiveColor:e[8],primitiveInstances:e[9],eachEntityId:e[10],eachEntityPrimitiveInstancesPortion:e[11],eachEntityMatricesPortion:e[12]}}(i),a=function(e){return{positions:new Float32Array(kE.inflate(e.positions).buffer),normals:new Int8Array(kE.inflate(e.normals).buffer),indices:new Uint32Array(kE.inflate(e.indices).buffer),edgeIndices:new Uint32Array(kE.inflate(e.edgeIndices).buffer),matrices:new Float32Array(kE.inflate(e.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(kE.inflate(e.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(kE.inflate(e.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(kE.inflate(e.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveColor:new Uint8Array(kE.inflate(e.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(kE.inflate(e.primitiveInstances).buffer),eachEntityId:kE.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(kE.inflate(e.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(kE.inflate(e.eachEntityMatricesPortion).buffer)}}(n);!function(e,t,i,s,r,o){const n=o.getNextId();s.positionsCompression="disabled",s.normalsCompression="precompressed";const a=i.positions,l=i.normals,A=i.indices,c=i.edgeIndices,h=i.matrices,u=i.eachPrimitivePositionsAndNormalsPortion,d=i.eachPrimitiveIndicesPortion,p=i.eachPrimitiveEdgeIndicesPortion,f=i.eachPrimitiveColor,m=i.primitiveInstances,g=JSON.parse(i.eachEntityId),_=i.eachEntityPrimitiveInstancesPortion,v=i.eachEntityMatricesPortion,b=u.length,w=m.length,B=new Uint8Array(b),P=g.length;for(let e=0;e<w;e++)B[m[e]]++;const x={};for(let e=0;e<P;e++){const t=P-1,i=e===t,s=_[e],r=i?_[t]:_[e+1];for(let t=s;t<r;t++){const i=m[t];B[i]>1||(x[i]=e)}}for(let e=0;e<b;e++){const t=e===b-1,i=B[e]>1,r=OE(f.subarray(4*e,4*e+3)),o=f[4*e+3]/255,h=a.subarray(u[e],t?a.length:u[e+1]),m=l.subarray(u[e],t?l.length:u[e+1]),_=A.subarray(d[e],t?A.length:d[e+1]),v=c.subarray(p[e],t?c.length:p[e+1]);if(i){const t=`${n}-geometry.${e}`;s.createGeometry({id:t,primitive:"triangles",positionsCompressed:h,normalsCompressed:m,indices:_,edgeIndices:v})}else{const t=e;g[x[e]];const i={};s.createMesh(y.apply(i,{id:t,primitive:"triangles",positionsCompressed:h,normalsCompressed:m,indices:_,edgeIndices:v,color:r,opacity:o}))}}let C=0;for(let e=0;e<P;e++){const t=P-1,i=e===t,r=g[e],o=_[e],n=i?_[t]:_[e+1],a=[];for(let t=o;t<n;t++){const i=m[t];if(B[i]>1){const t={},r="instance."+C++,o="geometry"+i,n=16*v[e],l=h.subarray(n,n+16);s.createMesh(y.apply(t,{id:r,geometryId:o,matrix:l})),a.push(r)}else a.push(i)}if(a.length>0){const e={};s.createEntity(y.apply(e,{id:r,isObject:!0,meshIds:a}))}}}(0,0,a,s,0,o)}};let VE=window.pako||PE;VE.inflate||(VE=VE.default);const QE=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const HE={version:6,parse:function(e,t,i,s,r,o){const n=function(e){return{positions:e[0],normals:e[1],indices:e[2],edgeIndices:e[3],matrices:e[4],reusedPrimitivesDecodeMatrix:e[5],eachPrimitivePositionsAndNormalsPortion:e[6],eachPrimitiveIndicesPortion:e[7],eachPrimitiveEdgeIndicesPortion:e[8],eachPrimitiveColorAndOpacity:e[9],primitiveInstances:e[10],eachEntityId:e[11],eachEntityPrimitiveInstancesPortion:e[12],eachEntityMatricesPortion:e[13],eachTileAABB:e[14],eachTileEntitiesPortion:e[15]}}(i),a=function(e){function t(e,t){return 0===e.length?[]:VE.inflate(e,t).buffer}return{positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedPrimitivesDecodeMatrix:new Float32Array(t(e.reusedPrimitivesDecodeMatrix)),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(t(e.eachPrimitivePositionsAndNormalsPortion)),eachPrimitiveIndicesPortion:new Uint32Array(t(e.eachPrimitiveIndicesPortion)),eachPrimitiveEdgeIndicesPortion:new Uint32Array(t(e.eachPrimitiveEdgeIndicesPortion)),eachPrimitiveColorAndOpacity:new Uint8Array(t(e.eachPrimitiveColorAndOpacity)),primitiveInstances:new Uint32Array(t(e.primitiveInstances)),eachEntityId:VE.inflate(e.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(t(e.eachEntityPrimitiveInstancesPortion)),eachEntityMatricesPortion:new Uint32Array(t(e.eachEntityMatricesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(n);!function(e,t,i,s,r,o){const n=o.getNextId(),a=i.positions,l=i.normals,A=i.indices,c=i.edgeIndices,h=i.matrices,u=i.reusedPrimitivesDecodeMatrix,p=i.eachPrimitivePositionsAndNormalsPortion,f=i.eachPrimitiveIndicesPortion,m=i.eachPrimitiveEdgeIndicesPortion,g=i.eachPrimitiveColorAndOpacity,_=i.primitiveInstances,v=JSON.parse(i.eachEntityId),b=i.eachEntityPrimitiveInstancesPortion,w=i.eachEntityMatricesPortion,B=i.eachTileAABB,P=i.eachTileEntitiesPortion,x=p.length,C=_.length,M=v.length,E=P.length,F=new Uint32Array(x);for(let e=0;e<C;e++){const t=_[e];void 0!==F[t]?F[t]++:F[t]=1}const I=d.vec3(),T=d.AABB3();for(let i=0;i<E;i++){const r=i===E-1,C=P[i],D=r?M:P[i+1],S=6*i,R=B.subarray(S,S+6);d.getAABB3Center(R,I),T[0]=R[0]-I[0],T[1]=R[1]-I[1],T[2]=R[2]-I[2],T[3]=R[3]-I[0],T[4]=R[4]-I[1],T[5]=R[5]-I[2];const U=me.createPositionsDecodeMatrix(T),L={};for(let r=C;r<D;r++){const B=v[r],P=t.globalizeObjectIds?d.globalizeObjectId(s.id,B):B,C=w[r],E=h.slice(C,C+16),T=r===M-1,D=b[r],S=T?_.length:b[r+1],R=[],k=e.metaScene.metaObjects[P],O={},N={};if(k){if(t.excludeTypesMap&&k.type&&t.excludeTypesMap[k.type])continue;if(t.includeTypesMap&&k.type&&!t.includeTypesMap[k.type])continue;if(t.includeIdsMap&&k.id&&!t.includeIdsMap[k.id])continue;const e=t.objectDefaults?t.objectDefaults[k.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(O.visible=!1),!1===e.pickable&&(O.pickable=!1),e.colorize&&(N.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(N.opacity=e.opacity))}else if(t.excludeUnclassifiedObjects)continue;for(let e=D;e<S;e++){const t=_[e],r=F[t]>1,h=t===x-1,d=a.subarray(p[t],h?a.length:p[t+1]),v=l.subarray(p[t],h?l.length:p[t+1]),b=A.subarray(f[t],h?A.length:f[t+1]),w=c.subarray(m[t],h?c.length:m[t+1]),B=QE(g.subarray(4*t,4*t+3)),P=g[4*t+3]/255,C=o.getNextId();if(r){const e=`${n}-geometry.${i}.${t}`;L[e]||(s.createGeometry({id:e,primitive:"triangles",positionsCompressed:d,indices:b,edgeIndices:w,positionsDecodeMatrix:u}),L[e]=!0),s.createMesh(y.apply(N,{id:C,geometryId:e,origin:I,matrix:E,color:B,opacity:P})),R.push(C)}else s.createMesh(y.apply(N,{id:C,origin:I,primitive:"triangles",positionsCompressed:d,normalsCompressed:v,indices:b,edgeIndices:w,positionsDecodeMatrix:U,color:B,opacity:P})),R.push(C)}R.length>0&&s.createEntity(y.apply(O,{id:P,isObject:!0,meshIds:R}))}}}(e,t,a,s,0,o)}};let jE=window.pako||PE;jE.inflate||(jE=jE.default);const GE=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function zE(e){const t=[];for(let i=0,s=e.length;i<s;i+=3)t.push(e[i]),t.push(e[i+1]),t.push(e[i+2]),t.push(1);return t}const WE={version:7,parse:function(e,t,i,s,r,o){const n=function(e){return{positions:e[0],normals:e[1],colors:e[2],indices:e[3],edgeIndices:e[4],matrices:e[5],reusedGeometriesDecodeMatrix:e[6],eachGeometryPrimitiveType:e[7],eachGeometryPositionsPortion:e[8],eachGeometryNormalsPortion:e[9],eachGeometryColorsPortion:e[10],eachGeometryIndicesPortion:e[11],eachGeometryEdgeIndicesPortion:e[12],eachMeshGeometriesPortion:e[13],eachMeshMatricesPortion:e[14],eachMeshMaterial:e[15],eachEntityId:e[16],eachEntityMeshesPortion:e[17],eachTileAABB:e[18],eachTileEntitiesPortion:e[19]}}(i),a=function(e){function t(e,t){return 0===e.length?[]:jE.inflate(e,t).buffer}return{positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityId:jE.inflate(e.eachEntityId,{to:"string"}),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(n);!function(e,t,i,s,r,o){const n=o.getNextId(),a=i.positions,l=i.normals,A=i.colors,c=i.indices,h=i.edgeIndices,u=i.matrices,p=i.reusedGeometriesDecodeMatrix,f=i.eachGeometryPrimitiveType,m=i.eachGeometryPositionsPortion,g=i.eachGeometryNormalsPortion,_=i.eachGeometryColorsPortion,v=i.eachGeometryIndicesPortion,b=i.eachGeometryEdgeIndicesPortion,w=i.eachMeshGeometriesPortion,B=i.eachMeshMatricesPortion,P=i.eachMeshMaterial,x=JSON.parse(i.eachEntityId),C=i.eachEntityMeshesPortion,M=i.eachTileAABB,E=i.eachTileEntitiesPortion,F=m.length,I=w.length,T=x.length,D=E.length,S=new Uint32Array(F);for(let e=0;e<I;e++){const t=w[e];void 0!==S[t]?S[t]++:S[t]=1}const R=d.vec3(),U=d.AABB3();for(let i=0;i<D;i++){const r=i===D-1,I=E[i],L=r?T:E[i+1],k=6*i,O=M.subarray(k,k+6);d.getAABB3Center(O,R),U[0]=O[0]-R[0],U[1]=O[1]-R[1],U[2]=O[2]-R[2],U[3]=O[3]-R[0],U[4]=O[4]-R[1],U[5]=O[5]-R[2];const N=me.createPositionsDecodeMatrix(U),V={};for(let r=I;r<L;r++){const M=x[r],E=t.globalizeObjectIds?d.globalizeObjectId(s.id,M):M,I=r===T-1,D=C[r],U=I?w.length:C[r+1],L=[],k=e.metaScene.metaObjects[E],O={},Q={};if(k){if(t.excludeTypesMap&&k.type&&t.excludeTypesMap[k.type])continue;if(t.includeTypesMap&&k.type&&!t.includeTypesMap[k.type])continue;if(t.includeIdsMap&&k.id&&!t.includeIdsMap[k.id])continue;const e=t.objectDefaults?t.objectDefaults[k.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(O.visible=!1),!1===e.pickable&&(O.pickable=!1),e.colorize&&(Q.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(Q.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(Q.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(Q.roughness=e.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(let e=D;e<U;e++){const t=w[e],r=S[t]>1,d=t===F-1,x=GE(P.subarray(6*e,6*e+3)),C=P[6*e+3]/255,M=P[6*e+4]/255,E=P[6*e+5]/255,I=o.getNextId();if(r){const r=B[e],o=u.slice(r,r+16),w=`${n}-geometry.${i}.${t}`;if(!V[w]){let e,i,r,o,n,u;switch(f[t]){case 0:e="solid",i=a.subarray(m[t],d?a.length:m[t+1]),r=l.subarray(g[t],d?l.length:g[t+1]),n=c.subarray(v[t],d?c.length:v[t+1]),u=h.subarray(b[t],d?h.length:b[t+1]);break;case 1:e="surface",i=a.subarray(m[t],d?a.length:m[t+1]),r=l.subarray(g[t],d?l.length:g[t+1]),n=c.subarray(v[t],d?c.length:v[t+1]),u=h.subarray(b[t],d?h.length:b[t+1]);break;case 2:e="points",i=a.subarray(m[t],d?a.length:m[t+1]),o=zE(A.subarray(_[t],d?A.length:_[t+1]));break;case 3:e="lines",i=a.subarray(m[t],d?a.length:m[t+1]),n=c.subarray(v[t],d?c.length:v[t+1]);break;default:continue}s.createGeometry({id:w,primitive:e,positionsCompressed:i,normalsCompressed:r,colors:o,indices:n,edgeIndices:u,positionsDecodeMatrix:p}),V[w]=!0}s.createMesh(y.apply(Q,{id:I,geometryId:w,origin:R,matrix:o,color:x,metallic:M,roughness:E,opacity:C})),L.push(I)}else{let e,i,r,o,n,u;switch(f[t]){case 0:e="solid",i=a.subarray(m[t],d?a.length:m[t+1]),r=l.subarray(g[t],d?l.length:g[t+1]),n=c.subarray(v[t],d?c.length:v[t+1]),u=h.subarray(b[t],d?h.length:b[t+1]);break;case 1:e="surface",i=a.subarray(m[t],d?a.length:m[t+1]),r=l.subarray(g[t],d?l.length:g[t+1]),n=c.subarray(v[t],d?c.length:v[t+1]),u=h.subarray(b[t],d?h.length:b[t+1]);break;case 2:e="points",i=a.subarray(m[t],d?a.length:m[t+1]),o=zE(A.subarray(_[t],d?A.length:_[t+1]));break;case 3:e="lines",i=a.subarray(m[t],d?a.length:m[t+1]),n=c.subarray(v[t],d?c.length:v[t+1]);break;default:continue}s.createMesh(y.apply(Q,{id:I,origin:R,primitive:e,positionsCompressed:i,normalsCompressed:r,colors:o,indices:n,edgeIndices:u,positionsDecodeMatrix:N,color:x,metallic:M,roughness:E,opacity:C})),L.push(I)}}L.length>0&&s.createEntity(y.apply(O,{id:E,isObject:!0,meshIds:L}))}}}(e,t,a,s,0,o)}};let XE=window.pako||PE;XE.inflate||(XE=XE.default);const KE=d.vec4(),ZE=d.vec4();const JE=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function YE(e){const t=[];for(let i=0,s=e.length;i<s;i+=3)t.push(e[i]),t.push(e[i+1]),t.push(e[i+2]),t.push(1);return t}const qE={version:8,parse:function(e,t,i,s,r,o){const n=function(e){return{types:e[0],eachMetaObjectId:e[1],eachMetaObjectType:e[2],eachMetaObjectName:e[3],eachMetaObjectParent:e[4],positions:e[5],normals:e[6],colors:e[7],indices:e[8],edgeIndices:e[9],matrices:e[10],reusedGeometriesDecodeMatrix:e[11],eachGeometryPrimitiveType:e[12],eachGeometryPositionsPortion:e[13],eachGeometryNormalsPortion:e[14],eachGeometryColorsPortion:e[15],eachGeometryIndicesPortion:e[16],eachGeometryEdgeIndicesPortion:e[17],eachMeshGeometriesPortion:e[18],eachMeshMatricesPortion:e[19],eachMeshMaterial:e[20],eachEntityMetaObject:e[21],eachEntityMeshesPortion:e[22],eachTileAABB:e[23],eachTileEntitiesPortion:e[24]}}(i),a=function(e){function t(e,t){return 0===e.length?[]:XE.inflate(e,t).buffer}return{types:XE.inflate(e.types,{to:"string"}),eachMetaObjectId:XE.inflate(e.eachMetaObjectId,{to:"string"}),eachMetaObjectType:new Uint32Array(t(e.eachMetaObjectType)),eachMetaObjectName:XE.inflate(e.eachMetaObjectName,{to:"string"}),eachMetaObjectParent:new Uint32Array(t(e.eachMetaObjectParent)),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityMetaObject:new Uint32Array(t(e.eachEntityMetaObject)),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(n);!function(e,t,i,s,r,o){const n=o.getNextId(),a=JSON.parse(i.types),l=JSON.parse(i.eachMetaObjectId),A=i.eachMetaObjectType,c=JSON.parse(i.eachMetaObjectName),h=i.eachMetaObjectParent,u=i.positions,p=i.normals,f=i.colors,m=i.indices,g=i.edgeIndices,_=i.matrices,v=i.reusedGeometriesDecodeMatrix,b=i.eachGeometryPrimitiveType,w=i.eachGeometryPositionsPortion,B=i.eachGeometryNormalsPortion,P=i.eachGeometryColorsPortion,x=i.eachGeometryIndicesPortion,C=i.eachGeometryEdgeIndicesPortion,M=i.eachMeshGeometriesPortion,E=i.eachMeshMatricesPortion,F=i.eachMeshMaterial,I=i.eachEntityMetaObject,T=i.eachEntityMeshesPortion,D=i.eachTileAABB,S=i.eachTileEntitiesPortion,R=l.length,U=w.length,L=M.length,k=I.length,O=S.length;if(r){const e={metaObjects:[]};for(let t=0;t<R;t++){const i=l[t],s=a[A[t]]||"default",r=c[t],o=h[t],n=o!==t?l[o]:null;e.metaObjects.push({id:i,type:s,name:r,parent:n})}r.loadData(e,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds})}const N=new Uint32Array(U);for(let e=0;e<L;e++){const t=M[e];void 0!==N[t]?N[t]++:N[t]=1}const V=d.vec3(),Q=d.AABB3(),H={};for(let i=0;i<O;i++){const r=i===O-1,a=S[i],A=r?k:S[i+1],c=6*i,h=D.subarray(c,c+6);d.getAABB3Center(h,V),Q[0]=h[0]-V[0],Q[1]=h[1]-V[1],Q[2]=h[2]-V[2],Q[3]=h[3]-V[0],Q[4]=h[4]-V[1],Q[5]=h[5]-V[2];const R=me.createPositionsDecodeMatrix(Q),L={};for(let r=a;r<A;r++){const a=l[I[r]],A=t.globalizeObjectIds?d.globalizeObjectId(s.id,a):a,c=r===k-1,h=T[r],D=c?M.length:T[r+1],S=[],O=e.metaScene.metaObjects[A],j={},G={};if(O){if(t.excludeTypesMap&&O.type&&t.excludeTypesMap[O.type])continue;if(t.includeTypesMap&&O.type&&!t.includeTypesMap[O.type])continue;if(t.includeIdsMap&&O.id&&!t.includeIdsMap[O.id])continue;const e=t.objectDefaults?t.objectDefaults[O.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(j.visible=!1),!1===e.pickable&&(j.pickable=!1),e.colorize&&(G.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(G.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(G.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(G.roughness=e.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(let e=h;e<D;e++){const r=M[e],a=N[r]>1,l=r===U-1,A=JE(F.subarray(6*e,6*e+3)),c=F[6*e+3]/255,h=F[6*e+4]/255,I=F[6*e+5]/255,T=o.getNextId();if(a){const o=E[e],a=_.slice(o,o+16),M=`${n}-geometry.${i}.${r}`;let F=H[M];if(!F){F={batchThisMesh:!t.reuseGeometries};let e=!1;switch(b[r]){case 0:F.primitiveName="solid",F.geometryPositions=u.subarray(w[r],l?u.length:w[r+1]),F.geometryNormals=p.subarray(B[r],l?p.length:B[r+1]),F.geometryIndices=m.subarray(x[r],l?m.length:x[r+1]),F.geometryEdgeIndices=g.subarray(C[r],l?g.length:C[r+1]),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;case 1:F.primitiveName="surface",F.geometryPositions=u.subarray(w[r],l?u.length:w[r+1]),F.geometryNormals=p.subarray(B[r],l?p.length:B[r+1]),F.geometryIndices=m.subarray(x[r],l?m.length:x[r+1]),F.geometryEdgeIndices=g.subarray(C[r],l?g.length:C[r+1]),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;case 2:F.primitiveName="points",F.geometryPositions=u.subarray(w[r],l?u.length:w[r+1]),F.geometryColors=YE(f.subarray(P[r],l?f.length:P[r+1])),e=F.geometryPositions.length>0;break;case 3:F.primitiveName="lines",F.geometryPositions=u.subarray(w[r],l?u.length:w[r+1]),F.geometryIndices=m.subarray(x[r],l?m.length:x[r+1]),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;default:continue}if(e||(F=null),F&&(F.geometryPositions.length,F.batchThisMesh)){F.decompressedPositions=new Float32Array(F.geometryPositions.length);const e=F.geometryPositions,t=F.decompressedPositions;for(let i=0,s=e.length;i<s;i+=3)t[i+0]=e[i+0]*v[0]+v[12],t[i+1]=e[i+1]*v[5]+v[13],t[i+2]=e[i+2]*v[10]+v[14];F.geometryPositions=null,H[M]=F}}if(F)if(F.batchThisMesh){const e=F.decompressedPositions,t=new Uint16Array(e.length);for(let i=0,s=e.length;i<s;i+=3)KE[0]=e[i+0],KE[1]=e[i+1],KE[2]=e[i+2],KE[3]=1,d.transformVec4(a,KE,ZE),me.compressPosition(ZE,Q,KE),t[i+0]=KE[0],t[i+1]=KE[1],t[i+2]=KE[2];s.createMesh(y.apply(G,{id:T,origin:V,primitive:F.primitiveName,positionsCompressed:t,normalsCompressed:F.geometryNormals,colorsCompressed:F.geometryColors,indices:F.geometryIndices,edgeIndices:F.geometryEdgeIndices,positionsDecodeMatrix:R,color:A,metallic:h,roughness:I,opacity:c})),S.push(T)}else L[M]||(s.createGeometry({id:M,primitive:F.primitiveName,positionsCompressed:F.geometryPositions,normalsCompressed:F.geometryNormals,colorsCompressed:F.geometryColors,indices:F.geometryIndices,edgeIndices:F.geometryEdgeIndices,positionsDecodeMatrix:v}),L[M]=!0),s.createMesh(y.apply(G,{id:T,geometryId:M,origin:V,matrix:a,color:A,metallic:h,roughness:I,opacity:c})),S.push(T)}else{let e,t,i,o,n,a,d=!1;switch(b[r]){case 0:e="solid",t=u.subarray(w[r],l?u.length:w[r+1]),i=p.subarray(B[r],l?p.length:B[r+1]),n=m.subarray(x[r],l?m.length:x[r+1]),a=g.subarray(C[r],l?g.length:C[r+1]),d=t.length>0&&n.length>0;break;case 1:e="surface",t=u.subarray(w[r],l?u.length:w[r+1]),i=p.subarray(B[r],l?p.length:B[r+1]),n=m.subarray(x[r],l?m.length:x[r+1]),a=g.subarray(C[r],l?g.length:C[r+1]),d=t.length>0&&n.length>0;break;case 2:e="points",t=u.subarray(w[r],l?u.length:w[r+1]),o=YE(f.subarray(P[r],l?f.length:P[r+1])),d=t.length>0;break;case 3:e="lines",t=u.subarray(w[r],l?u.length:w[r+1]),n=m.subarray(x[r],l?m.length:x[r+1]),d=t.length>0&&n.length>0;break;default:continue}d&&(s.createMesh(y.apply(G,{id:T,origin:V,primitive:e,positionsCompressed:t,normalsCompressed:i,colorsCompressed:o,indices:n,edgeIndices:a,positionsDecodeMatrix:R,color:A,metallic:h,roughness:I,opacity:c})),S.push(T))}}S.length>0&&s.createEntity(y.apply(j,{id:A,isObject:!0,meshIds:S}))}}}(e,t,a,s,r,o)}};let $E=window.pako||PE;$E.inflate||($E=$E.default);const eF=d.vec4(),tF=d.vec4();const iF=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();const sF={version:9,parse:function(e,t,i,s,r,o){const n=function(e){return{metadata:e[0],positions:e[1],normals:e[2],colors:e[3],indices:e[4],edgeIndices:e[5],matrices:e[6],reusedGeometriesDecodeMatrix:e[7],eachGeometryPrimitiveType:e[8],eachGeometryPositionsPortion:e[9],eachGeometryNormalsPortion:e[10],eachGeometryColorsPortion:e[11],eachGeometryIndicesPortion:e[12],eachGeometryEdgeIndicesPortion:e[13],eachMeshGeometriesPortion:e[14],eachMeshMatricesPortion:e[15],eachMeshMaterial:e[16],eachEntityId:e[17],eachEntityMeshesPortion:e[18],eachTileAABB:e[19],eachTileEntitiesPortion:e[20]}}(i),a=function(e){function t(e,t){return 0===e.length?[]:$E.inflate(e,t).buffer}return{metadata:JSON.parse($E.inflate(e.metadata,{to:"string"})),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(t(e.eachMeshMaterial)),eachEntityId:JSON.parse($E.inflate(e.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(n);!function(e,t,i,s,r,o){const n=o.getNextId(),a=i.metadata,l=i.positions,A=i.normals,c=i.colors,h=i.indices,u=i.edgeIndices,p=i.matrices,f=i.reusedGeometriesDecodeMatrix,m=i.eachGeometryPrimitiveType,g=i.eachGeometryPositionsPortion,_=i.eachGeometryNormalsPortion,v=i.eachGeometryColorsPortion,b=i.eachGeometryIndicesPortion,w=i.eachGeometryEdgeIndicesPortion,B=i.eachMeshGeometriesPortion,P=i.eachMeshMatricesPortion,x=i.eachMeshMaterial,C=i.eachEntityId,M=i.eachEntityMeshesPortion,E=i.eachTileAABB,F=i.eachTileEntitiesPortion,I=g.length,T=B.length,D=M.length,S=F.length;r&&r.loadData(a,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds});const R=new Uint32Array(I);for(let e=0;e<T;e++){const t=B[e];void 0!==R[t]?R[t]++:R[t]=1}const U=d.vec3(),L=d.AABB3(),k={};for(let i=0;i<S;i++){const r=i===S-1,a=F[i],T=r?D-1:F[i+1]-1,O=6*i,N=E.subarray(O,O+6);d.getAABB3Center(N,U),L[0]=N[0]-U[0],L[1]=N[1]-U[1],L[2]=N[2]-U[2],L[3]=N[3]-U[0],L[4]=N[4]-U[1],L[5]=N[5]-U[2];const V=me.createPositionsDecodeMatrix(L),Q={};for(let r=a;r<=T;r++){const a=C[r],E=t.globalizeObjectIds?d.globalizeObjectId(s.id,a):a,F=r===D-1,T=M[r],S=F?B.length-1:M[r+1]-1,O=[],N=e.metaScene.metaObjects[E],H={},j={};if(N){if(t.excludeTypesMap&&N.type&&t.excludeTypesMap[N.type])continue;if(t.includeTypesMap&&N.type&&!t.includeTypesMap[N.type])continue;if(t.includeIdsMap&&N.id&&!t.includeIdsMap[N.id])continue;const e=t.objectDefaults?t.objectDefaults[N.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(H.visible=!1),!1===e.pickable&&(H.pickable=!1),e.colorize&&(j.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(j.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(j.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(j.roughness=e.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(let e=T;e<=S;e++){const r=B[e],a=R[r]>1,C=r===I-1,M=iF(x.subarray(6*e,6*e+3)),E=x[6*e+3]/255,F=x[6*e+4]/255,T=x[6*e+5]/255,D=o.getNextId();if(a){const o=P[e],a=p.slice(o,o+16),B=`${n}-geometry.${i}.${r}`;let x=k[B];if(!x){x={batchThisMesh:!t.reuseGeometries};let e=!1;switch(m[r]){case 0:x.primitiveName="solid",x.geometryPositions=l.subarray(g[r],C?l.length:g[r+1]),x.geometryNormals=A.subarray(_[r],C?A.length:_[r+1]),x.geometryIndices=h.subarray(b[r],C?h.length:b[r+1]),x.geometryEdgeIndices=u.subarray(w[r],C?u.length:w[r+1]),e=x.geometryPositions.length>0&&x.geometryIndices.length>0;break;case 1:x.primitiveName="surface",x.geometryPositions=l.subarray(g[r],C?l.length:g[r+1]),x.geometryNormals=A.subarray(_[r],C?A.length:_[r+1]),x.geometryIndices=h.subarray(b[r],C?h.length:b[r+1]),x.geometryEdgeIndices=u.subarray(w[r],C?u.length:w[r+1]),e=x.geometryPositions.length>0&&x.geometryIndices.length>0;break;case 2:x.primitiveName="points",x.geometryPositions=l.subarray(g[r],C?l.length:g[r+1]),x.geometryColors=c.subarray(v[r],C?c.length:v[r+1]),e=x.geometryPositions.length>0;break;case 3:x.primitiveName="lines",x.geometryPositions=l.subarray(g[r],C?l.length:g[r+1]),x.geometryIndices=h.subarray(b[r],C?h.length:b[r+1]),e=x.geometryPositions.length>0&&x.geometryIndices.length>0;break;default:continue}if(e||(x=null),x&&(x.geometryPositions.length,x.batchThisMesh)){x.decompressedPositions=new Float32Array(x.geometryPositions.length),x.transformedAndRecompressedPositions=new Uint16Array(x.geometryPositions.length);const e=x.geometryPositions,t=x.decompressedPositions;for(let i=0,s=e.length;i<s;i+=3)t[i+0]=e[i+0]*f[0]+f[12],t[i+1]=e[i+1]*f[5]+f[13],t[i+2]=e[i+2]*f[10]+f[14];x.geometryPositions=null,k[B]=x}}if(x)if(x.batchThisMesh){const e=x.decompressedPositions,t=x.transformedAndRecompressedPositions;for(let i=0,s=e.length;i<s;i+=3)eF[0]=e[i+0],eF[1]=e[i+1],eF[2]=e[i+2],eF[3]=1,d.transformVec4(a,eF,tF),me.compressPosition(tF,L,eF),t[i+0]=eF[0],t[i+1]=eF[1],t[i+2]=eF[2];s.createMesh(y.apply(j,{id:D,origin:U,primitive:x.primitiveName,positionsCompressed:t,normalsCompressed:x.geometryNormals,colorsCompressed:x.geometryColors,indices:x.geometryIndices,edgeIndices:x.geometryEdgeIndices,positionsDecodeMatrix:V,color:M,metallic:F,roughness:T,opacity:E})),O.push(D)}else Q[B]||(s.createGeometry({id:B,primitive:x.primitiveName,positionsCompressed:x.geometryPositions,normalsCompressed:x.geometryNormals,colorsCompressed:x.geometryColors,indices:x.geometryIndices,edgeIndices:x.geometryEdgeIndices,positionsDecodeMatrix:f}),Q[B]=!0),s.createMesh(y.apply(j,{id:D,geometryId:B,origin:U,matrix:a,color:M,metallic:F,roughness:T,opacity:E})),O.push(D)}else{let e,t,i,o,n,a,d=!1;switch(m[r]){case 0:e="solid",t=l.subarray(g[r],C?l.length:g[r+1]),i=A.subarray(_[r],C?A.length:_[r+1]),n=h.subarray(b[r],C?h.length:b[r+1]),a=u.subarray(w[r],C?u.length:w[r+1]),d=t.length>0&&n.length>0;break;case 1:e="surface",t=l.subarray(g[r],C?l.length:g[r+1]),i=A.subarray(_[r],C?A.length:_[r+1]),n=h.subarray(b[r],C?h.length:b[r+1]),a=u.subarray(w[r],C?u.length:w[r+1]),d=t.length>0&&n.length>0;break;case 2:e="points",t=l.subarray(g[r],C?l.length:g[r+1]),o=c.subarray(v[r],C?c.length:v[r+1]),d=t.length>0;break;case 3:e="lines",t=l.subarray(g[r],C?l.length:g[r+1]),n=h.subarray(b[r],C?h.length:b[r+1]),d=t.length>0&&n.length>0;break;default:continue}d&&(s.createMesh(y.apply(j,{id:D,origin:U,primitive:e,positionsCompressed:t,normalsCompressed:i,colorsCompressed:o,indices:n,edgeIndices:a,positionsDecodeMatrix:V,color:M,metallic:F,roughness:T,opacity:E})),O.push(D))}}O.length>0&&s.createEntity(y.apply(H,{id:E,isObject:!0,meshIds:O}))}}}(e,t,a,s,r,o)}};let rF=window.pako||PE;rF.inflate||(rF=rF.default);const oF=d.vec4(),nF=d.vec4();const aF=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function lF(e,t){const i=[];if(t.length>1)for(let e=0,s=t.length-1;e<s;e++)i.push(t[e]),i.push(t[e+1]);else if(e.length>1)for(let t=0,s=e.length/3-1;t<s;t++)i.push(t),i.push(t+1);return i}!function(){const e=document.createElement("canvas"),t=e.getContext("2d")}();const AF={version:10,parse:function(e,t,i,s,r,o){const n=function(e){let t=0;return{metadata:e[t++],textureData:e[t++],eachTextureDataPortion:e[t++],eachTextureAttributes:e[t++],positions:e[t++],normals:e[t++],colors:e[t++],uvs:e[t++],indices:e[t++],edgeIndices:e[t++],eachTextureSetTextures:e[t++],matrices:e[t++],reusedGeometriesDecodeMatrix:e[t++],eachGeometryPrimitiveType:e[t++],eachGeometryPositionsPortion:e[t++],eachGeometryNormalsPortion:e[t++],eachGeometryColorsPortion:e[t++],eachGeometryUVsPortion:e[t++],eachGeometryIndicesPortion:e[t++],eachGeometryEdgeIndicesPortion:e[t++],eachMeshGeometriesPortion:e[t++],eachMeshMatricesPortion:e[t++],eachMeshTextureSet:e[t++],eachMeshMaterialAttributes:e[t++],eachEntityId:e[t++],eachEntityMeshesPortion:e[t++],eachTileAABB:e[t++],eachTileEntitiesPortion:e[t++]}}(i),a=function(e){function t(e,t){return 0===e.length?[]:rF.inflate(e,t).buffer}return{metadata:JSON.parse(rF.inflate(e.metadata,{to:"string"})),textureData:new Uint8Array(t(e.textureData)),eachTextureDataPortion:new Uint32Array(t(e.eachTextureDataPortion)),eachTextureAttributes:new Uint16Array(t(e.eachTextureAttributes)),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),uvs:new Float32Array(t(e.uvs)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),eachTextureSetTextures:new Int32Array(t(e.eachTextureSetTextures)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryUVsPortion:new Uint32Array(t(e.eachGeometryUVsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshTextureSet:new Int32Array(t(e.eachMeshTextureSet)),eachMeshMaterialAttributes:new Uint8Array(t(e.eachMeshMaterialAttributes)),eachEntityId:JSON.parse(rF.inflate(e.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(n);!function(e,t,i,s,r,o){const n=o.getNextId(),a=i.metadata,l=i.textureData,A=i.eachTextureDataPortion,c=i.eachTextureAttributes,h=i.positions,u=i.normals,p=i.colors,f=i.uvs,m=i.indices,g=i.edgeIndices,_=i.eachTextureSetTextures,v=i.matrices,b=i.reusedGeometriesDecodeMatrix,w=i.eachGeometryPrimitiveType,B=i.eachGeometryPositionsPortion,P=i.eachGeometryNormalsPortion,x=i.eachGeometryColorsPortion,C=i.eachGeometryUVsPortion,M=i.eachGeometryIndicesPortion,E=i.eachGeometryEdgeIndicesPortion,F=i.eachMeshGeometriesPortion,I=i.eachMeshMatricesPortion,T=i.eachMeshTextureSet,D=i.eachMeshMaterialAttributes,S=i.eachEntityId,R=i.eachEntityMeshesPortion,U=i.eachTileAABB,L=i.eachTileEntitiesPortion,k=A.length,O=_.length/5,N=B.length,V=F.length,Q=R.length,H=L.length;r&&r.loadData(a,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds});for(let e=0;e<k;e++){const t=e===k-1,i=A[e],r=t?l.length:A[e+1],o=r-i>0,a=9*e,h=1===c[a+0],u=c[a+1];c[a+2],c[a+3];const d=c[a+4],p=c[a+5],f=c[a+6],m=c[a+7],g=c[a+8];if(o){const t=new Uint8Array(l.subarray(i,r)).buffer,o=`${n}-texture-${e}`;if(h)s.createTexture({id:o,buffers:[t],minFilter:d,magFilter:p,wrapS:f,wrapT:m,wrapR:g});else{const e=new Blob([t],{type:10001===u?"image/jpeg":10002===u?"image/png":"image/gif"}),i=(window.URL||window.webkitURL).createObjectURL(e),r=document.createElement("img");r.src=i,s.createTexture({id:o,image:r,minFilter:d,magFilter:p,wrapS:f,wrapT:m,wrapR:g})}}}for(let e=0;e<O;e++){const t=5*e,i=`${n}-textureSet-${e}`,r=_[t+0],o=_[t+1],a=_[t+2],l=_[t+3],A=_[t+4];s.createTextureSet({id:i,colorTextureId:r>=0?`${n}-texture-${r}`:null,normalsTextureId:a>=0?`${n}-texture-${a}`:null,metallicRoughnessTextureId:o>=0?`${n}-texture-${o}`:null,emissiveTextureId:l>=0?`${n}-texture-${l}`:null,occlusionTextureId:A>=0?`${n}-texture-${A}`:null})}const j=new Uint32Array(N);for(let e=0;e<V;e++){const t=F[e];void 0!==j[t]?j[t]++:j[t]=1}const G=d.vec3(),z=d.AABB3(),W={};for(let i=0;i<H;i++){const r=i===H-1,a=L[i],l=r?Q-1:L[i+1]-1,A=6*i,c=U.subarray(A,A+6);d.getAABB3Center(c,G),z[0]=c[0]-G[0],z[1]=c[1]-G[1],z[2]=c[2]-G[2],z[3]=c[3]-G[0],z[4]=c[4]-G[1],z[5]=c[5]-G[2];const _=me.createPositionsDecodeMatrix(z),k={};for(let r=a;r<=l;r++){const a=S[r],l=t.globalizeObjectIds?d.globalizeObjectId(s.id,a):a,A=r===Q-1,c=R[r],U=A?F.length-1:R[r+1]-1,L=[],O=e.metaScene.metaObjects[l],V={},H={};if(O){if(t.excludeTypesMap&&O.type&&t.excludeTypesMap[O.type])continue;if(t.includeTypesMap&&O.type&&!t.includeTypesMap[O.type])continue;if(t.includeIdsMap&&O.id&&!t.includeIdsMap[O.id])continue;const e=t.objectDefaults?t.objectDefaults[O.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(V.visible=!1),!1===e.pickable&&(V.pickable=!1),e.colorize&&(H.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(H.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(H.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(H.roughness=e.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(let e=c;e<=U;e++){const r=F[e],a=j[r]>1,l=r===N-1,A=T[e],c=A>=0?`${n}-textureSet-${A}`:null,S=aF(D.subarray(6*e,6*e+3)),R=D[6*e+3]/255,U=D[6*e+4]/255,O=D[6*e+5]/255,V=o.getNextId();if(a){const o=I[e],a=v.slice(o,o+16),A=`${n}-geometry.${i}.${r}`;let F=W[A];if(!F){F={batchThisMesh:!t.reuseGeometries};let e=!1;switch(w[r]){case 0:F.primitiveName="solid",F.geometryPositions=h.subarray(B[r],l?h.length:B[r+1]),F.geometryNormals=u.subarray(P[r],l?u.length:P[r+1]),F.geometryUVs=f.subarray(C[r],l?f.length:C[r+1]),F.geometryIndices=m.subarray(M[r],l?m.length:M[r+1]),F.geometryEdgeIndices=g.subarray(E[r],l?g.length:E[r+1]),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;case 1:F.primitiveName="surface",F.geometryPositions=h.subarray(B[r],l?h.length:B[r+1]),F.geometryNormals=u.subarray(P[r],l?u.length:P[r+1]),F.geometryUVs=f.subarray(C[r],l?f.length:C[r+1]),F.geometryIndices=m.subarray(M[r],l?m.length:M[r+1]),F.geometryEdgeIndices=g.subarray(E[r],l?g.length:E[r+1]),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;case 2:F.primitiveName="points",F.geometryPositions=h.subarray(B[r],l?h.length:B[r+1]),F.geometryColors=p.subarray(x[r],l?p.length:x[r+1]),e=F.geometryPositions.length>0;break;case 3:F.primitiveName="lines",F.geometryPositions=h.subarray(B[r],l?h.length:B[r+1]),F.geometryIndices=m.subarray(M[r],l?m.length:M[r+1]),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;case 4:F.primitiveName="lines",F.geometryPositions=h.subarray(B[r],l?h.length:B[r+1]),F.geometryIndices=lF(F.geometryPositions,m.subarray(M[r],l?m.length:M[r+1])),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;default:continue}if(e||(F=null),F&&(F.geometryPositions.length,F.batchThisMesh)){F.decompressedPositions=new Float32Array(F.geometryPositions.length),F.transformedAndRecompressedPositions=new Uint16Array(F.geometryPositions.length);const e=F.geometryPositions,t=F.decompressedPositions;for(let i=0,s=e.length;i<s;i+=3)t[i+0]=e[i+0]*b[0]+b[12],t[i+1]=e[i+1]*b[5]+b[13],t[i+2]=e[i+2]*b[10]+b[14];F.geometryPositions=null,W[A]=F}}if(F)if(F.batchThisMesh){const e=F.decompressedPositions,t=F.transformedAndRecompressedPositions;for(let i=0,s=e.length;i<s;i+=3)oF[0]=e[i+0],oF[1]=e[i+1],oF[2]=e[i+2],oF[3]=1,d.transformVec4(a,oF,nF),me.compressPosition(nF,z,oF),t[i+0]=oF[0],t[i+1]=oF[1],t[i+2]=oF[2];s.createMesh(y.apply(H,{id:V,textureSetId:c,origin:G,primitive:F.primitiveName,positionsCompressed:t,normalsCompressed:F.geometryNormals,uv:F.geometryUVs,colorsCompressed:F.geometryColors,indices:F.geometryIndices,edgeIndices:F.geometryEdgeIndices,positionsDecodeMatrix:_,color:S,metallic:U,roughness:O,opacity:R})),L.push(V)}else k[A]||(s.createGeometry({id:A,primitive:F.primitiveName,positionsCompressed:F.geometryPositions,normalsCompressed:F.geometryNormals,uv:F.geometryUVs,colorsCompressed:F.geometryColors,indices:F.geometryIndices,edgeIndices:F.geometryEdgeIndices,positionsDecodeMatrix:b}),k[A]=!0),s.createMesh(y.apply(H,{id:V,geometryId:A,textureSetId:c,matrix:a,color:S,metallic:U,roughness:O,opacity:R,origin:G})),L.push(V)}else{let e,t,i,o,n,a,A,d=!1;switch(w[r]){case 0:e="solid",t=h.subarray(B[r],l?h.length:B[r+1]),i=u.subarray(P[r],l?u.length:P[r+1]),o=f.subarray(C[r],l?f.length:C[r+1]),a=m.subarray(M[r],l?m.length:M[r+1]),A=g.subarray(E[r],l?g.length:E[r+1]),d=t.length>0&&a.length>0;break;case 1:e="surface",t=h.subarray(B[r],l?h.length:B[r+1]),i=u.subarray(P[r],l?u.length:P[r+1]),o=f.subarray(C[r],l?f.length:C[r+1]),a=m.subarray(M[r],l?m.length:M[r+1]),A=g.subarray(E[r],l?g.length:E[r+1]),d=t.length>0&&a.length>0;break;case 2:e="points",t=h.subarray(B[r],l?h.length:B[r+1]),n=p.subarray(x[r],l?p.length:x[r+1]),d=t.length>0;break;case 3:e="lines",t=h.subarray(B[r],l?h.length:B[r+1]),a=m.subarray(M[r],l?m.length:M[r+1]),d=t.length>0&&a.length>0;break;case 4:e="lines",t=h.subarray(B[r],l?h.length:B[r+1]),a=lF(t,m.subarray(M[r],l?m.length:M[r+1])),d=t.length>0&&a.length>0;break;default:continue}d&&(s.createMesh(y.apply(H,{id:V,textureSetId:c,origin:G,primitive:e,positionsCompressed:t,normalsCompressed:i,uv:o&&o.length>0?o:null,colorsCompressed:n,indices:a,edgeIndices:A,positionsDecodeMatrix:_,color:S,metallic:U,roughness:O,opacity:R})),L.push(V))}}L.length>0&&s.createEntity(y.apply(V,{id:l,isObject:!0,meshIds:L}))}}}(e,t,a,s,r,o)}},cF=d.vec4(),hF=d.vec4();const uF=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function dF(e,t){const i=[];if(t.length>1)for(let e=0,s=t.length-1;e<s;e++)i.push(t[e]),i.push(t[e+1]);else if(e.length>1)for(let t=0,s=e.length/3-1;t<s;t++)i.push(t),i.push(t+1);return i}!function(){const e=document.createElement("canvas"),t=e.getContext("2d")}();const pF={version:11,parseArrayBuffer:function(e,t,i,s,r,o){const n=function(e){const t=function(){const e=new ArrayBuffer(2);return new Uint16Array(e)[0]=1,1!==new Uint8Array(e)[0]}(),i=function(){let i=0;const s=new DataView(e);return function(r){const o=1+2*i++,n=s.getUint32(4*o,!0),a=s.getUint32(4*(o+1),!0),l=r.BYTES_PER_ELEMENT;if(t&&l>1){const t=new Uint8Array(e,n,a),i=l/2,s=t.length/l;for(let e=0;e<s;e++){const s=e*l;for(let e=0;e<i;e++){const i=s+e,r=s-e+l-1,o=t[i];t[i]=t[r],t[r]=o}}}return new r(e,n,a/l)}}(),s=function(){const e=new TextDecoder;return()=>JSON.parse(e.decode(i(Uint8Array)))}();return{metadata:s(),textureData:i(Uint8Array),eachTextureDataPortion:i(Uint32Array),eachTextureAttributes:i(Uint16Array),positions:i(Uint16Array),normals:i(Int8Array),colors:i(Uint8Array),uvs:i(Float32Array),indices:i(Uint32Array),edgeIndices:i(Uint32Array),eachTextureSetTextures:i(Int32Array),matrices:i(Float32Array),reusedGeometriesDecodeMatrix:i(Float32Array),eachGeometryPrimitiveType:i(Uint8Array),eachGeometryPositionsPortion:i(Uint32Array),eachGeometryNormalsPortion:i(Uint32Array),eachGeometryColorsPortion:i(Uint32Array),eachGeometryUVsPortion:i(Uint32Array),eachGeometryIndicesPortion:i(Uint32Array),eachGeometryEdgeIndicesPortion:i(Uint32Array),eachMeshGeometriesPortion:i(Uint32Array),eachMeshMatricesPortion:i(Uint32Array),eachMeshTextureSet:i(Int32Array),eachMeshMaterialAttributes:i(Uint8Array),eachEntityId:s(),eachEntityMeshesPortion:i(Uint32Array),eachTileAABB:i(Float64Array),eachTileEntitiesPortion:i(Uint32Array)}}(i);!function(e,t,i,s,r,o){const n=o.getNextId(),a=i.metadata,l=i.textureData,A=i.eachTextureDataPortion,c=i.eachTextureAttributes,h=i.positions,u=i.normals,p=i.colors,f=i.uvs,m=i.indices,g=i.edgeIndices,_=i.eachTextureSetTextures,v=i.matrices,b=i.reusedGeometriesDecodeMatrix,w=i.eachGeometryPrimitiveType,B=i.eachGeometryPositionsPortion,P=i.eachGeometryNormalsPortion,x=i.eachGeometryColorsPortion,C=i.eachGeometryUVsPortion,M=i.eachGeometryIndicesPortion,E=i.eachGeometryEdgeIndicesPortion,F=i.eachMeshGeometriesPortion,I=i.eachMeshMatricesPortion,T=i.eachMeshTextureSet,D=i.eachMeshMaterialAttributes,S=i.eachEntityId,R=i.eachEntityMeshesPortion,U=i.eachTileAABB,L=i.eachTileEntitiesPortion,k=A.length,O=_.length/5,N=B.length,V=F.length,Q=R.length,H=L.length;r&&r.loadData(a,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds});for(let e=0;e<k;e++){const t=e===k-1,i=A[e],r=t?l.length:A[e+1],o=r-i>0,a=9*e,h=1===c[a+0],u=c[a+1];c[a+2],c[a+3];const d=c[a+4],p=c[a+5],f=c[a+6],m=c[a+7],g=c[a+8];if(o){const t=new Uint8Array(l.subarray(i,r)).buffer,o=`${n}-texture-${e}`;if(h)s.createTexture({id:o,buffers:[t],minFilter:d,magFilter:p,wrapS:f,wrapT:m,wrapR:g});else{const e=new Blob([t],{type:10001===u?"image/jpeg":10002===u?"image/png":"image/gif"}),i=(window.URL||window.webkitURL).createObjectURL(e),r=document.createElement("img");r.src=i,s.createTexture({id:o,image:r,minFilter:d,magFilter:p,wrapS:f,wrapT:m,wrapR:g})}}}for(let e=0;e<O;e++){const t=5*e,i=`${n}-textureSet-${e}`,r=_[t+0],o=_[t+1],a=_[t+2],l=_[t+3],A=_[t+4];s.createTextureSet({id:i,colorTextureId:r>=0?`${n}-texture-${r}`:null,normalsTextureId:a>=0?`${n}-texture-${a}`:null,metallicRoughnessTextureId:o>=0?`${n}-texture-${o}`:null,emissiveTextureId:l>=0?`${n}-texture-${l}`:null,occlusionTextureId:A>=0?`${n}-texture-${A}`:null})}const j=new Uint32Array(N);for(let e=0;e<V;e++){const t=F[e];void 0!==j[t]?j[t]++:j[t]=1}const G=d.vec3(),z=d.AABB3(),W={};for(let i=0;i<H;i++){const r=i===H-1,a=L[i],l=r?Q-1:L[i+1]-1,A=6*i,c=U.subarray(A,A+6);d.getAABB3Center(c,G),z[0]=c[0]-G[0],z[1]=c[1]-G[1],z[2]=c[2]-G[2],z[3]=c[3]-G[0],z[4]=c[4]-G[1],z[5]=c[5]-G[2];const _=me.createPositionsDecodeMatrix(z),k={};for(let r=a;r<=l;r++){const a=S[r],l=t.globalizeObjectIds?d.globalizeObjectId(s.id,a):a,A=r===Q-1,c=R[r],U=A?F.length-1:R[r+1]-1,L=[],O=e.metaScene.metaObjects[l],V={},H={};if(O){if(t.excludeTypesMap&&O.type&&t.excludeTypesMap[O.type])continue;if(t.includeTypesMap&&O.type&&!t.includeTypesMap[O.type])continue;if(t.includeIdsMap&&O.id&&!t.includeIdsMap[O.id])continue;const e=t.objectDefaults?t.objectDefaults[O.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(V.visible=!1),!1===e.pickable&&(V.pickable=!1),e.colorize&&(H.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(H.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(H.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(H.roughness=e.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(let e=c;e<=U;e++){const r=F[e],a=j[r]>1,l=r===N-1,A=T[e],c=A>=0?`${n}-textureSet-${A}`:null,S=uF(D.subarray(6*e,6*e+3)),R=D[6*e+3]/255,U=D[6*e+4]/255,O=D[6*e+5]/255,V=o.getNextId();if(a){const o=I[e],a=v.slice(o,o+16),A=`${n}-geometry.${i}.${r}`;let F=W[A];if(!F){F={batchThisMesh:!t.reuseGeometries};let e=!1;switch(w[r]){case 0:F.primitiveName="solid",F.geometryPositions=h.subarray(B[r],l?h.length:B[r+1]),F.geometryNormals=u.subarray(P[r],l?u.length:P[r+1]),F.geometryUVs=f.subarray(C[r],l?f.length:C[r+1]),F.geometryIndices=m.subarray(M[r],l?m.length:M[r+1]),F.geometryEdgeIndices=g.subarray(E[r],l?g.length:E[r+1]),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;case 1:F.primitiveName="surface",F.geometryPositions=h.subarray(B[r],l?h.length:B[r+1]),F.geometryNormals=u.subarray(P[r],l?u.length:P[r+1]),F.geometryUVs=f.subarray(C[r],l?f.length:C[r+1]),F.geometryIndices=m.subarray(M[r],l?m.length:M[r+1]),F.geometryEdgeIndices=g.subarray(E[r],l?g.length:E[r+1]),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;case 2:F.primitiveName="points",F.geometryPositions=h.subarray(B[r],l?h.length:B[r+1]),F.geometryColors=p.subarray(x[r],l?p.length:x[r+1]),e=F.geometryPositions.length>0;break;case 3:F.primitiveName="lines",F.geometryPositions=h.subarray(B[r],l?h.length:B[r+1]),F.geometryIndices=m.subarray(M[r],l?m.length:M[r+1]),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;case 4:F.primitiveName="lines",F.geometryPositions=h.subarray(B[r],l?h.length:B[r+1]),F.geometryIndices=dF(F.geometryPositions,m.subarray(M[r],l?m.length:M[r+1])),e=F.geometryPositions.length>0&&F.geometryIndices.length>0;break;default:continue}if(e||(F=null),F&&(F.geometryPositions.length,F.batchThisMesh)){F.decompressedPositions=new Float32Array(F.geometryPositions.length),F.transformedAndRecompressedPositions=new Uint16Array(F.geometryPositions.length);const e=F.geometryPositions,t=F.decompressedPositions;for(let i=0,s=e.length;i<s;i+=3)t[i+0]=e[i+0]*b[0]+b[12],t[i+1]=e[i+1]*b[5]+b[13],t[i+2]=e[i+2]*b[10]+b[14];F.geometryPositions=null,W[A]=F}}if(F)if(F.batchThisMesh){const e=F.decompressedPositions,t=F.transformedAndRecompressedPositions;for(let i=0,s=e.length;i<s;i+=3)cF[0]=e[i+0],cF[1]=e[i+1],cF[2]=e[i+2],cF[3]=1,d.transformVec4(a,cF,hF),me.compressPosition(hF,z,cF),t[i+0]=cF[0],t[i+1]=cF[1],t[i+2]=cF[2];s.createMesh(y.apply(H,{id:V,textureSetId:c,origin:G,primitive:F.primitiveName,positionsCompressed:t,normalsCompressed:F.geometryNormals,uv:F.geometryUVs,colorsCompressed:F.geometryColors,indices:F.geometryIndices,edgeIndices:F.geometryEdgeIndices,positionsDecodeMatrix:_,color:S,metallic:U,roughness:O,opacity:R})),L.push(V)}else k[A]||(s.createGeometry({id:A,primitive:F.primitiveName,positionsCompressed:F.geometryPositions,normalsCompressed:F.geometryNormals,uv:F.geometryUVs,colorsCompressed:F.geometryColors,indices:F.geometryIndices,edgeIndices:F.geometryEdgeIndices,positionsDecodeMatrix:b}),k[A]=!0),s.createMesh(y.apply(H,{id:V,geometryId:A,textureSetId:c,matrix:a,color:S,metallic:U,roughness:O,opacity:R,origin:G})),L.push(V)}else{let e,t,i,o,n,a,A,d=!1;switch(w[r]){case 0:e="solid",t=h.subarray(B[r],l?h.length:B[r+1]),i=u.subarray(P[r],l?u.length:P[r+1]),o=f.subarray(C[r],l?f.length:C[r+1]),a=m.subarray(M[r],l?m.length:M[r+1]),A=g.subarray(E[r],l?g.length:E[r+1]),d=t.length>0&&a.length>0;break;case 1:e="surface",t=h.subarray(B[r],l?h.length:B[r+1]),i=u.subarray(P[r],l?u.length:P[r+1]),o=f.subarray(C[r],l?f.length:C[r+1]),a=m.subarray(M[r],l?m.length:M[r+1]),A=g.subarray(E[r],l?g.length:E[r+1]),d=t.length>0&&a.length>0;break;case 2:e="points",t=h.subarray(B[r],l?h.length:B[r+1]),n=p.subarray(x[r],l?p.length:x[r+1]),d=t.length>0;break;case 3:e="lines",t=h.subarray(B[r],l?h.length:B[r+1]),a=m.subarray(M[r],l?m.length:M[r+1]),d=t.length>0&&a.length>0;break;case 4:e="lines",t=h.subarray(B[r],l?h.length:B[r+1]),a=dF(t,m.subarray(M[r],l?m.length:M[r+1])),d=t.length>0&&a.length>0;break;default:continue}d&&(s.createMesh(y.apply(H,{id:V,textureSetId:c,origin:G,primitive:e,positionsCompressed:t,normalsCompressed:i,uv:o&&o.length>0?o:null,colorsCompressed:n,indices:a,edgeIndices:A,positionsDecodeMatrix:_,color:S,metallic:U,roughness:O,opacity:R})),L.push(V))}}L.length>0&&s.createEntity(y.apply(V,{id:l,isObject:!0,meshIds:L}))}}}(e,t,n,s,r,o)}};let fF=window.pako||PE;fF.inflate||(fF=fF.default);const mF=d.vec4(),gF=d.vec4();const _F=function(){const e=new Float32Array(3);return function(t){return e[0]=t[0]/255,e[1]=t[1]/255,e[2]=t[2]/255,e}}();function vF(e,t,i,s,r,o){const n=o.getNextId(),a=i.metadata,l=i.textureData,A=i.eachTextureDataPortion,c=i.eachTextureAttributes,h=i.positions,u=i.normals,p=i.colors,f=i.uvs,m=i.indices,g=i.edgeIndices,_=i.eachTextureSetTextures,v=i.matrices,b=i.reusedGeometriesDecodeMatrix,w=i.eachGeometryPrimitiveType,B=i.eachGeometryAxisLabel,P=i.eachGeometryPositionsPortion,x=i.eachGeometryNormalsPortion,C=i.eachGeometryColorsPortion,M=i.eachGeometryUVsPortion,E=i.eachGeometryIndicesPortion,F=i.eachGeometryEdgeIndicesPortion,I=i.eachMeshGeometriesPortion,T=i.eachMeshMatricesPortion,D=i.eachMeshTextureSet,S=i.eachMeshMaterialAttributes,R=i.eachEntityId,U=i.eachEntityMeshesPortion,L=i.eachTileAABB,k=i.eachTileEntitiesPortion,O=A.length,N=_.length/5,V=P.length,Q=I.length,H=U.length,j=k.length;r&&r.loadData(a,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes,globalizeObjectIds:t.globalizeObjectIds});for(let e=0;e<O;e++){const t=e===O-1,i=A[e],r=t?l.length:A[e+1],o=r-i>0,a=9*e,h=1===c[a+0],u=c[a+1];c[a+2],c[a+3];const d=c[a+4],p=c[a+5],f=c[a+6],m=c[a+7],g=c[a+8];if(o){const t=new Uint8Array(l.subarray(i,r)).buffer,o=`${n}-texture-${e}`;if(h)s.createTexture({id:o,buffers:[t],minFilter:d,magFilter:p,wrapS:f,wrapT:m,wrapR:g});else{const e=new Blob([t],{type:10001===u?"image/jpeg":10002===u?"image/png":"image/gif"}),i=(window.URL||window.webkitURL).createObjectURL(e),r=document.createElement("img");r.src=i,s.createTexture({id:o,image:r,minFilter:d,magFilter:p,wrapS:f,wrapT:m,wrapR:g})}}}for(let e=0;e<N;e++){const t=5*e,i=`${n}-textureSet-${e}`,r=_[t+0],o=_[t+1],a=_[t+2],l=_[t+3],A=_[t+4];s.createTextureSet({id:i,colorTextureId:r>=0?`${n}-texture-${r}`:null,normalsTextureId:a>=0?`${n}-texture-${a}`:null,metallicRoughnessTextureId:o>=0?`${n}-texture-${o}`:null,emissiveTextureId:l>=0?`${n}-texture-${l}`:null,occlusionTextureId:A>=0?`${n}-texture-${A}`:null})}const G=new Uint32Array(V);for(let e=0;e<Q;e++){const t=I[e];void 0!==G[t]?G[t]++:G[t]=1}const z=d.vec3(),W=d.AABB3(),X={};for(let i=0;i<j;i++){const r=i===j-1,a=k[i],l=r?H-1:k[i+1]-1,A=6*i,c=L.subarray(A,A+6);d.getAABB3Center(c,z),W[0]=c[0]-z[0],W[1]=c[1]-z[1],W[2]=c[2]-z[2],W[3]=c[3]-z[0],W[4]=c[4]-z[1],W[5]=c[5]-z[2];const _=me.createPositionsDecodeMatrix(W),O={};for(let r=a;r<=l;r++){const a=R[r],l=t.globalizeObjectIds?d.globalizeObjectId(s.id,a):a,A=r===H-1,c=U[r],L=A?I.length-1:U[r+1]-1,k=[],N=e.metaScene.metaObjects[l],Q={},j={};if(N){if(t.excludeTypesMap&&N.type&&t.excludeTypesMap[N.type])continue;if(t.includeTypesMap&&N.type&&!t.includeTypesMap[N.type])continue;if(t.includeIdsMap&&N.id&&!t.includeIdsMap[N.id])continue;const e=t.objectDefaults?t.objectDefaults[N.type]||t.objectDefaults.DEFAULT:null;e&&(!1===e.visible&&(Q.visible=!1),!1===e.pickable&&(Q.pickable=!1),e.colorize&&(j.color=e.colorize),void 0!==e.opacity&&null!==e.opacity&&(j.opacity=e.opacity),void 0!==e.metallic&&null!==e.metallic&&(j.metallic=e.metallic),void 0!==e.roughness&&null!==e.roughness&&(j.roughness=e.roughness))}else if(t.excludeUnclassifiedObjects)continue;for(let e=c;e<=L;e++){const r=I[e],a=G[r]>1,l=r===V-1,A=D[e],c=A>=0?`${n}-textureSet-${A}`:null,R=_F(S.subarray(6*e,6*e+3)),U=S[6*e+3]/255,L=S[6*e+4]/255,N=S[6*e+5]/255,Q=o.getNextId();if(a){const o=T[e],a=v.slice(o,o+16),A=`${n}-geometry.${i}.${r}`;let I=X[A];if(!I){I={batchThisMesh:!t.reuseGeometries};const e=w[r],i=B[r];let s,o=!1;switch(e){case 0:I.primitiveName="solid",I.geometryPositions=h.subarray(P[r],l?h.length:P[r+1]),I.geometryNormals=u.subarray(x[r],l?u.length:x[r+1]),I.geometryUVs=f.subarray(M[r],l?f.length:M[r+1]),I.geometryIndices=m.subarray(E[r],l?m.length:E[r+1]),I.geometryEdgeIndices=g.subarray(F[r],l?g.length:F[r+1]),o=I.geometryPositions.length>0&&I.geometryIndices.length>0;break;case 1:I.primitiveName="surface",I.geometryPositions=h.subarray(P[r],l?h.length:P[r+1]),I.geometryNormals=u.subarray(x[r],l?u.length:x[r+1]),I.geometryUVs=f.subarray(M[r],l?f.length:M[r+1]),I.geometryIndices=m.subarray(E[r],l?m.length:E[r+1]),I.geometryEdgeIndices=g.subarray(F[r],l?g.length:F[r+1]),o=I.geometryPositions.length>0&&I.geometryIndices.length>0;break;case 2:I.primitiveName="points",I.geometryPositions=h.subarray(P[r],l?h.length:P[r+1]),I.geometryColors=p.subarray(C[r],l?p.length:C[r+1]),o=I.geometryPositions.length>0;break;case 3:I.primitiveName="lines",I.geometryPositions=h.subarray(P[r],l?h.length:P[r+1]),I.geometryIndices=m.subarray(E[r],l?m.length:E[r+1]),o=I.geometryPositions.length>0&&I.geometryIndices.length>0;break;case 4:I.primitiveName="lines",I.geometryPositions=h.subarray(P[r],l?h.length:P[r+1]),I.geometryIndices=bF(I.geometryPositions,m.subarray(E[r],l?m.length:E[r+1])),o=I.geometryPositions.length>0&&I.geometryIndices.length>0;break;case 7:I.primitiveName="lines",I.geometryPositions=h.subarray(P[r],l?h.length:P[r+1]),I.decompressedPositions=me.decompressPositions(I.geometryPositions,b),s=Ue({origin:I.decompressedPositions,text:i,size:2}),I.decompressedPositions=s.positions,I.geometryIndices=s.indices,I.geometryPositions=null,o=I.decompressedPositions.length>0&&I.geometryIndices.length>0;break;default:continue}if(o||(I=null),I&&(I.geometryPositions&&I.geometryPositions.length,I.batchThisMesh)){if(7===e)I.transformedAndRecompressedPositions=new Uint16Array(I.decompressedPositions.length);else{I.decompressedPositions=new Float32Array(I.geometryPositions.length),I.transformedAndRecompressedPositions=new Uint16Array(I.geometryPositions.length);const e=I.geometryPositions,t=I.decompressedPositions;for(let i=0,s=e.length;i<s;i+=3)t[i+0]=e[i+0]*b[0]+b[12],t[i+1]=e[i+1]*b[5]+b[13],t[i+2]=e[i+2]*b[10]+b[14];I.geometryPositions=null}X[A]=I}}if(I)if(I.batchThisMesh){const e=I.decompressedPositions,t=I.transformedAndRecompressedPositions;for(let i=0,s=e.length;i<s;i+=3)mF[0]=e[i+0],mF[1]=e[i+1],mF[2]=e[i+2],mF[3]=1,d.transformVec4(a,mF,gF),me.compressPosition(gF,W,mF),t[i+0]=mF[0],t[i+1]=mF[1],t[i+2]=mF[2];s.createMesh(y.apply(j,{id:Q,textureSetId:c,origin:z,primitive:I.primitiveName,positionsCompressed:t,normalsCompressed:I.geometryNormals,uv:I.geometryUVs,colorsCompressed:I.geometryColors,indices:I.geometryIndices,edgeIndices:I.geometryEdgeIndices,positionsDecodeMatrix:_,color:R,metallic:L,roughness:N,opacity:U})),k.push(Q)}else{if(!O[A]){let e={id:A,primitive:I.primitiveName,normalsCompressed:I.geometryNormals,uv:I.geometryUVs,colorsCompressed:I.geometryColors,indices:I.geometryIndices,edgeIndices:I.geometryEdgeIndices};e=I.geometryPositions?{...e,positionsCompressed:I.geometryPositions,positionsDecodeMatrix:b}:{...e,positions:I.decompressedPositions},s.createGeometry(e),O[A]=!0}s.createMesh(y.apply(j,{id:Q,geometryId:A,textureSetId:c,matrix:a,color:R,metallic:L,roughness:N,opacity:U,origin:z})),k.push(Q)}}else{const e=w[r],t=B[r];let i,o,n,a,A,d,v,b,I=!1;switch(e){case 0:i="solid",o=h.subarray(P[r],l?h.length:P[r+1]),n=u.subarray(x[r],l?u.length:x[r+1]),a=f.subarray(M[r],l?f.length:M[r+1]),d=m.subarray(E[r],l?m.length:E[r+1]),v=g.subarray(F[r],l?g.length:F[r+1]),I=o.length>0&&d.length>0;break;case 1:i="surface",o=h.subarray(P[r],l?h.length:P[r+1]),n=u.subarray(x[r],l?u.length:x[r+1]),a=f.subarray(M[r],l?f.length:M[r+1]),d=m.subarray(E[r],l?m.length:E[r+1]),v=g.subarray(F[r],l?g.length:F[r+1]),I=o.length>0&&d.length>0;break;case 2:i="points",o=h.subarray(P[r],l?h.length:P[r+1]),A=p.subarray(C[r],l?p.length:C[r+1]),I=o.length>0;break;case 3:i="lines",o=h.subarray(P[r],l?h.length:P[r+1]),d=m.subarray(E[r],l?m.length:E[r+1]),I=o.length>0&&d.length>0;break;case 4:i="lines",o=h.subarray(P[r],l?h.length:P[r+1]),d=bF(o,m.subarray(E[r],l?m.length:E[r+1])),I=o.length>0&&d.length>0;break;case 7:i="lines",o=h.subarray(P[r],l?h.length:P[r+1]),o=me.decompressPositions(o,_),b=Ue({origin:o,text:t,size:2}),o=b.positions,d=b.indices,I=o.length>0&&d.length>0;break;default:continue}if(I){let t=y.apply(j,{id:Q,textureSetId:c,origin:z,primitive:i,normalsCompressed:n,uv:a&&a.length>0?a:null,colorsCompressed:A,indices:d,edgeIndices:v,color:R,metallic:L,roughness:N,opacity:U});t=7!==e?{...t,positionsCompressed:o,positionsDecodeMatrix:_}:{...t,positions:o},s.createMesh(t),k.push(Q)}}}k.length>0&&s.createEntity(y.apply(Q,{id:l,isObject:!0,meshIds:k}))}}}function bF(e,t){const i=[];if(t.length>1)for(let e=0,s=t.length-1;e<s;e++)i.push(t[e]),i.push(t[e+1]);else if(e.length>1)for(let t=0,s=e.length/3-1;t<s;t++)i.push(t),i.push(t+1);return i}!function(){const e=document.createElement("canvas"),t=e.getContext("2d")}();const yF={version:12,parseArrayBuffer:function(e,t,i,s,r,o){const n=function(e){const t=function(){const e=new ArrayBuffer(2);return new Uint16Array(e)[0]=1,1!==new Uint8Array(e)[0]}(),i=function(){let i=0;const s=new DataView(e);return function(r){const o=1+2*i++,n=s.getUint32(4*o,!0),a=s.getUint32(4*(o+1),!0),l=r.BYTES_PER_ELEMENT;if(t&&l>1){const t=new Uint8Array(e,n,a),i=l/2,s=t.length/l;for(let e=0;e<s;e++){const s=e*l;for(let e=0;e<i;e++){const i=s+e,r=s-e+l-1,o=t[i];t[i]=t[r],t[r]=o}}}return new r(e,n,a/l)}}(),s=function(){const e=new TextDecoder;return()=>JSON.parse(e.decode(i(Uint8Array)))}();return{metadata:s(),textureData:i(Uint8Array),eachTextureDataPortion:i(Uint32Array),eachTextureAttributes:i(Uint16Array),positions:i(Uint16Array),normals:i(Int8Array),colors:i(Uint8Array),uvs:i(Float32Array),indices:i(Uint32Array),edgeIndices:i(Uint32Array),eachTextureSetTextures:i(Int32Array),matrices:i(Float32Array),reusedGeometriesDecodeMatrix:i(Float32Array),eachGeometryPrimitiveType:i(Uint8Array),eachGeometryAxisLabel:s(),eachGeometryPositionsPortion:i(Uint32Array),eachGeometryNormalsPortion:i(Uint32Array),eachGeometryColorsPortion:i(Uint32Array),eachGeometryUVsPortion:i(Uint32Array),eachGeometryIndicesPortion:i(Uint32Array),eachGeometryEdgeIndicesPortion:i(Uint32Array),eachMeshGeometriesPortion:i(Uint32Array),eachMeshMatricesPortion:i(Uint32Array),eachMeshTextureSet:i(Int32Array),eachMeshMaterialAttributes:i(Uint8Array),eachEntityId:s(),eachEntityMeshesPortion:i(Uint32Array),eachTileAABB:i(Float64Array),eachTileEntitiesPortion:i(Uint32Array)}}(i);vF(e,t,n,s,r,o)},parse:function(e,t,i,s,r,o){const n=function(e){let t=0;return{metadata:e[t++],textureData:e[t++],eachTextureDataPortion:e[t++],eachTextureAttributes:e[t++],positions:e[t++],normals:e[t++],colors:e[t++],uvs:e[t++],indices:e[t++],edgeIndices:e[t++],eachTextureSetTextures:e[t++],matrices:e[t++],reusedGeometriesDecodeMatrix:e[t++],eachGeometryPrimitiveType:e[t++],eachGeometryAxisLabel:e[t++],eachGeometryPositionsPortion:e[t++],eachGeometryNormalsPortion:e[t++],eachGeometryColorsPortion:e[t++],eachGeometryUVsPortion:e[t++],eachGeometryIndicesPortion:e[t++],eachGeometryEdgeIndicesPortion:e[t++],eachMeshGeometriesPortion:e[t++],eachMeshMatricesPortion:e[t++],eachMeshTextureSet:e[t++],eachMeshMaterialAttributes:e[t++],eachEntityId:e[t++],eachEntityMeshesPortion:e[t++],eachTileAABB:e[t++],eachTileEntitiesPortion:e[t++]}}(i),a=function(e){function t(e,t){return 0===e.length?[]:fF.inflate(e,t).buffer}return{metadata:JSON.parse(fF.inflate(e.metadata,{to:"string"})),textureData:new Uint8Array(t(e.textureData)),eachTextureDataPortion:new Uint32Array(t(e.eachTextureDataPortion)),eachTextureAttributes:new Uint16Array(t(e.eachTextureAttributes)),positions:new Uint16Array(t(e.positions)),normals:new Int8Array(t(e.normals)),colors:new Uint8Array(t(e.colors)),uvs:new Float32Array(t(e.uvs)),indices:new Uint32Array(t(e.indices)),edgeIndices:new Uint32Array(t(e.edgeIndices)),eachTextureSetTextures:new Int32Array(t(e.eachTextureSetTextures)),matrices:new Float32Array(t(e.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(t(e.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(t(e.eachGeometryPrimitiveType)),eachGeometryAxisLabel:JSON.parse(fF.inflate(e.eachGeometryAxisLabel,{to:"string"})),eachGeometryPositionsPortion:new Uint32Array(t(e.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(t(e.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(t(e.eachGeometryColorsPortion)),eachGeometryUVsPortion:new Uint32Array(t(e.eachGeometryUVsPortion)),eachGeometryIndicesPortion:new Uint32Array(t(e.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(t(e.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(t(e.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(t(e.eachMeshMatricesPortion)),eachMeshTextureSet:new Int32Array(t(e.eachMeshTextureSet)),eachMeshMaterialAttributes:new Uint8Array(t(e.eachMeshMaterialAttributes)),eachEntityId:JSON.parse(fF.inflate(e.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(t(e.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(t(e.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(t(e.eachTileEntitiesPortion))}}(n);vF(e,t,a,s,r,o)}},wF={};wF[ME.version]=ME,wF[IE.version]=IE,wF[SE.version]=SE,wF[LE.version]=LE,wF[NE.version]=NE,wF[HE.version]=HE,wF[WE.version]=WE,wF[qE.version]=qE,wF[sF.version]=sF,wF[AF.version]=AF,wF[pF.version]=pF,wF[yF.version]=yF;class BF extends ph{constructor(e,t={}){super("XKTLoader",e,t),this._maxGeometryBatchSize=t.maxGeometryBatchSize,this.textureTranscoder=t.textureTranscoder,this.dataSource=t.dataSource,this.objectDefaults=t.objectDefaults,this.includeTypes=t.includeTypes,this.excludeTypes=t.excludeTypes,this.excludeUnclassifiedObjects=t.excludeUnclassifiedObjects,this.reuseGeometries=t.reuseGeometries}get supportedVersions(){return Object.keys(wF)}get textureTranscoder(){return this._textureTranscoder}set textureTranscoder(e){this._textureTranscoder=e}get dataSource(){return this._dataSource}set dataSource(e){this._dataSource=e||new BE}get objectDefaults(){return this._objectDefaults}set objectDefaults(e){this._objectDefaults=e||CM}get includeTypes(){return this._includeTypes}set includeTypes(e){this._includeTypes=e}get excludeTypes(){return this._excludeTypes}set excludeTypes(e){this._excludeTypes=e}get includeIds(){return this._includeIds}set includeIds(e){this._includeIds=e}get excludeUnclassifiedObjects(){return this._excludeUnclassifiedObjects}set excludeUnclassifiedObjects(e){this._excludeUnclassifiedObjects=!!e}get globalizeObjectIds(){return this._globalizeObjectIds}set globalizeObjectIds(e){this._globalizeObjectIds=!!e}get reuseGeometries(){return this._reuseGeometries}set reuseGeometries(e){this._reuseGeometries=!1!==e}load(e={}){if(e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id),!(e.src||e.xkt||e.manifestSrc||e.manifest))throw new Error("XKTLoaderPlugin: load() param expected: src, xkt, manifestSrc or manifestData");const t={},i=e.includeTypes||this._includeTypes,s=e.excludeTypes||this._excludeTypes,r=e.includeIds||this._includeIds,o=e.objectDefaults||this._objectDefaults;if(t.reuseGeometries=null!==e.reuseGeometries&&void 0!==e.reuseGeometries?e.reuseGeometries:!1!==this._reuseGeometries,i){t.includeTypesMap={};for(let e=0,s=i.length;e<s;e++)t.includeTypesMap[i[e]]=!0}if(s){t.excludeTypesMap={};for(let e=0,i=s.length;e<i;e++)t.excludeTypesMap[s[e]]=!0}if(r){t.includeIdsMap={};for(let e=0,i=r.length;e<i;e++)t.includeIdsMap[r[e]]=!0}o&&(t.objectDefaults=o),t.excludeUnclassifiedObjects=void 0!==e.excludeUnclassifiedObjects?!!e.excludeUnclassifiedObjects:this._excludeUnclassifiedObjects,t.globalizeObjectIds=void 0!==e.globalizeObjectIds&&null!==e.globalizeObjectIds?!!e.globalizeObjectIds:this._globalizeObjectIds;const n=new Tc(this.viewer.scene,y.apply(e,{isModel:!0,textureTranscoder:this._textureTranscoder,maxGeometryBatchSize:this._maxGeometryBatchSize,origin:e.origin,disableVertexWelding:e.disableVertexWelding||!1,disableIndexRebucketing:e.disableIndexRebucketing||!1,dtxEnabled:e.dtxEnabled,renderOrder:e.renderOrder})),a=n.id,l=new Ud({metaScene:this.viewer.metaScene,id:a});this.viewer.scene.canvas.spinner.processes++;const A=()=>{n.destroyed||(n.finalize(),l.finalize(),this.viewer.scene.canvas.spinner.processes--,n.once("destroyed",(()=>{this.viewer.metaScene.destroyMetaModel(l.id)})),this.scheduleTask((()=>{n.destroyed||(n.scene.fire("modelLoaded",n.id),n.fire("loaded",!0,!1))})))},c=e=>{this.viewer.scene.canvas.spinner.processes--,this.error(e),n.fire("error",e)};let h=0;const u={getNextId:()=>`${a}.${h++}`};if(e.metaModelSrc||e.metaModelData)if(e.metaModelSrc){const r=e.metaModelSrc;this._dataSource.getMetaModel(r,(r=>{n.destroyed||(l.loadData(r,{includeTypes:i,excludeTypes:s,globalizeObjectIds:t.globalizeObjectIds}),e.src?this._loadModel(e.src,t,n,null,u,A,c):(this._parseModel(e.xkt,t,n,null,u),A()))}),(e=>{c(`load(): Failed to load model metadata for model '${a} from  '${r}' - ${e}`)}))}else e.metaModelData&&(l.loadData(e.metaModelData,{includeTypes:i,excludeTypes:s,globalizeObjectIds:t.globalizeObjectIds}),e.src?this._loadModel(e.src,t,n,null,u,A,c):(this._parseModel(e.xkt,t,n,null,u),A()));else if(e.src)this._loadModel(e.src,t,n,l,u,A,c);else if(e.xkt)this._parseModel(e.xkt,t,n,l,u),A();else if(e.manifestSrc||e.manifest){const r=e.manifestSrc?function(e){e.indexOf("?")>-1&&(e=e.split("?")[0]);const t=e.split("/");return t.pop(),t.join("/")+"/"}(e.manifestSrc):"",o=(e,o,a)=>{let A=0;const c=()=>{n.destroyed||A>=e.length?o():this._dataSource.getMetaModel(`${r}${e[A]}`,(e=>{l.loadData(e,{includeTypes:i,excludeTypes:s,globalizeObjectIds:t.globalizeObjectIds}),A++,this.scheduleTask(c,200)}),a)};c()},a=(e,i,s)=>{let o=0;const a=()=>{n.destroyed||o>=e.length?i():this._dataSource.getXKT(`${r}${e[o]}`,(e=>{this._parseModel(e,t,n,null,u),n.preFinalize(),o++,this.scheduleTask(a,200)}),s)};a()},h=(e,i,s)=>{let o=0;const a=()=>{n.destroyed||o>=e.length?i():this._dataSource.getXKT(`${r}${e[o]}`,(e=>{this._parseModel(e,t,n,l,u),n.preFinalize(),o++,this.scheduleTask(a,200)}),s)};a()};if(e.manifest){const t=e.manifest,i=t.xktFiles;if(!i||0===i.length)return void c("load(): Failed to load model manifest - manifest not valid");const s=t.metaModelFiles;s?o(s,(()=>{a(i,A,c)}),c):h(i,A,c)}else this._dataSource.getManifest(e.manifestSrc,(e=>{if(n.destroyed)return;const t=e.xktFiles;if(!t||0===t.length)return void c("load(): Failed to load model manifest - manifest not valid");const i=e.metaModelFiles;i?o(i,(()=>{a(t,A,c)}),c):h(t,A,c)}),c)}return n}_loadModel(e,t,i,s,r,o,n){this._dataSource.getXKT(e,(e=>{this._parseModel(e,t,i,s,r),i.preFinalize(),o()}),n)}async _parseModel(e,t,i,s,r){if(i.destroyed)return;const o=new DataView(e),n=new Uint8Array(e),a=o.getUint32(0,!0),l=2147483647&a,A=l<11||l>=12&&a>>>31,c=wF[l];if(!c)return void this.error("Unsupported .XKT file version: "+l+" - this XKTLoaderPlugin supports versions "+Object.keys(wF));if(!A)return void c.parseArrayBuffer(this.viewer,t,e,i,s,r);const h=o.getUint32(4,!0),u=[];let d=4*(h+2);for(let e=0;e<h;e++){const t=o.getUint32(4*(e+2),!0);u.push(n.subarray(d,d+t)),d+=t}c.parse(this.viewer,t,u,i,s,r)}}var PF={};!function(e){var t,i="File format is not recognized.",s="Error while reading zip file.",r="Error while reading file data.",o=524288,n="text/plain";try{t=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(e){}function a(){this.crc=-1}function l(){}function A(e,t){var i,s;return i=new ArrayBuffer(e),s=new Uint8Array(i),t&&s.set(t,0),{buffer:i,array:s,view:new DataView(i)}}function c(){}function h(e){var t,i=this;i.size=0,i.init=function(s,r){var o=new Blob([e],{type:n});(t=new d(o)).init((function(){i.size=t.size,s()}),r)},i.readUint8Array=function(e,i,s,r){t.readUint8Array(e,i,s,r)}}function u(t){var i,s=this;s.size=0,s.init=function(e){for(var r=t.length;"="==t.charAt(r-1);)r--;i=t.indexOf(",")+1,s.size=Math.floor(.75*(r-i)),e()},s.readUint8Array=function(s,r,o){var n,a=A(r),l=4*Math.floor(s/3),c=4*Math.ceil((s+r)/3),h=e.atob(t.substring(l+i,c+i)),u=s-3*Math.floor(l/4);for(n=u;n<u+r;n++)a.array[n-u]=h.charCodeAt(n);o(a.array)}}function d(e){var t=this;t.size=0,t.init=function(i){t.size=e.size,i()},t.readUint8Array=function(t,i,s,r){var o=new FileReader;o.onload=function(e){s(new Uint8Array(e.target.result))},o.onerror=r;try{o.readAsArrayBuffer(function(e,t,i){if(t<0||i<0||t+i>e.size)throw new RangeError("offset:"+t+", length:"+i+", size:"+e.size);return e.slice?e.slice(t,t+i):e.webkitSlice?e.webkitSlice(t,t+i):e.mozSlice?e.mozSlice(t,t+i):e.msSlice?e.msSlice(t,t+i):void 0}(e,t,i))}catch(e){r(e)}}}function p(){}function f(e){var i,s=this;s.init=function(e){i=new Blob([],{type:n}),e()},s.writeUint8Array=function(e,s){i=new Blob([i,t?e:e.buffer],{type:n}),s()},s.getData=function(t,s){var r=new FileReader;r.onload=function(e){t(e.target.result)},r.onerror=s,r.readAsText(i,e)}}function m(t){var i=this,s="",r="";i.init=function(e){s+="data:"+(t||"")+";base64,",e()},i.writeUint8Array=function(t,i){var o,n=r.length,a=r;for(r="",o=0;o<3*Math.floor((n+t.length)/3)-n;o++)a+=String.fromCharCode(t[o]);for(;o<t.length;o++)r+=String.fromCharCode(t[o]);a.length>2?s+=e.btoa(a):r=a,i()},i.getData=function(t){t(s+e.btoa(r))}}function g(e){var i,s=this;s.init=function(t){i=new Blob([],{type:e}),t()},s.writeUint8Array=function(s,r){i=new Blob([i,t?s:s.buffer],{type:e}),r()},s.getData=function(e){e(i)}}function _(e,t,i,s,r,n,a,l,A,c){var h,u,d,p=0,f=t.sn;function m(){e.removeEventListener("message",g,!1),l(u,d)}function g(t){var i=t.data,r=i.data,o=i.error;if(o)return o.toString=function(){return"Error: "+this.message},void A(o);if(i.sn===f)switch("number"==typeof i.codecTime&&(e.codecTime+=i.codecTime),"number"==typeof i.crcTime&&(e.crcTime+=i.crcTime),i.type){case"append":r?(u+=r.length,s.writeUint8Array(r,(function(){_()}),c)):_();break;case"flush":d=i.crc,r?(u+=r.length,s.writeUint8Array(r,(function(){m()}),c)):m();break;case"progress":a&&a(h+i.loaded,n);break;case"importScripts":case"newTask":case"echo":break;default:console.warn("zip.js:launchWorkerProcess: unknown message: ",i)}}function _(){(h=p*o)<=n?i.readUint8Array(r+h,Math.min(o,n-h),(function(i){a&&a(h,n);var s=0===h?t:{sn:f};s.type="append",s.data=i;try{e.postMessage(s,[i.buffer])}catch(t){e.postMessage(s)}p++}),A):e.postMessage({sn:f,type:"flush"})}u=0,e.addEventListener("message",g,!1),_()}function v(e,t,i,s,r,n,l,A,c,h){var u,d=0,p=0,f="input"===n,m="output"===n,g=new a;!function n(){var a;if((u=d*o)<r)t.readUint8Array(s+u,Math.min(o,r-u),(function(t){var s;try{s=e.append(t,(function(e){l&&l(u+e,r)}))}catch(e){return void c(e)}s?(p+=s.length,i.writeUint8Array(s,(function(){d++,setTimeout(n,1)}),h),m&&g.append(s)):(d++,setTimeout(n,1)),f&&g.append(t),l&&l(u,r)}),c);else{try{a=e.flush()}catch(e){return void c(e)}a?(m&&g.append(a),p+=a.length,i.writeUint8Array(a,(function(){A(p,g.get())}),h)):A(p,g.get())}}()}function b(t,i,s,r,o,n,a,A,c,h,u){var d="input";e.zip.useWebWorkers&&a?_(t,{sn:i,codecClass:"NOOP",crcType:d},s,r,o,n,c,A,h,u):v(new l,s,r,o,n,d,c,A,h,u)}function y(e){var t,i,s="",r=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(t=0;t<e.length;t++)s+=(i=255&e.charCodeAt(t))>127?r[i-128]:String.fromCharCode(i);return s}function w(e){return decodeURIComponent(escape(e))}function B(e){var t,i="";for(t=0;t<e.length;t++)i+=String.fromCharCode(e[t]);return i}function P(e,t,i,s,r){e.version=t.view.getUint16(i,!0),e.bitFlag=t.view.getUint16(i+2,!0),e.compressionMethod=t.view.getUint16(i+4,!0),e.lastModDateRaw=t.view.getUint32(i+6,!0),e.lastModDate=function(e){var t=(4294901760&e)>>16,i=65535&e;try{return new Date(1980+((65024&t)>>9),((480&t)>>5)-1,31&t,(63488&i)>>11,(2016&i)>>5,2*(31&i),0)}catch(e){}}(e.lastModDateRaw),1!=(1&e.bitFlag)?((s||8!=(8&e.bitFlag))&&(e.crc32=t.view.getUint32(i+10,!0),e.compressedSize=t.view.getUint32(i+14,!0),e.uncompressedSize=t.view.getUint32(i+18,!0)),4294967295!==e.compressedSize&&4294967295!==e.uncompressedSize?(e.filenameLength=t.view.getUint16(i+22,!0),e.extraFieldLength=t.view.getUint16(i+24,!0)):r("File is using Zip64 (4gb+ file size).")):r("File contains encrypted entry.")}function x(t,o,n){var a=0;function l(){}l.prototype.getData=function(s,o,l,c){var h=this;function u(e,t){c&&!function(e){var t=A(4);return t.view.setUint32(0,e),h.crc32==t.view.getUint32(0)}(t)?n("CRC failed."):s.getData((function(e){o(e)}))}function d(e){n(e||r)}function p(e){n(e||"Error while writing file data.")}t.readUint8Array(h.offset,30,(function(r){var o,f=A(r.length,r);1347093252==f.view.getUint32(0)?(P(h,f,4,!1,n),o=h.offset+30+h.filenameLength+h.extraFieldLength,s.init((function(){0===h.compressionMethod?b(h._worker,a++,t,s,o,h.compressedSize,c,u,l,d,p):function(t,i,s,r,o,n,a,l,A,c,h){var u=a?"output":"none";e.zip.useWebWorkers?_(t,{sn:i,codecClass:"Inflater",crcType:u},s,r,o,n,A,l,c,h):v(new e.zip.Inflater,s,r,o,n,u,A,l,c,h)}(h._worker,a++,t,s,o,h.compressedSize,c,u,l,d,p)}),p)):n(i)}),d)};var c={getEntries:function(e){var r=this._worker;!function(e){t.size<22?n(i):r(22,(function(){r(Math.min(65558,t.size),(function(){n(i)}))}));function r(i,r){t.readUint8Array(t.size-i,i,(function(t){for(var i=t.length-22;i>=0;i--)if(80===t[i]&&75===t[i+1]&&5===t[i+2]&&6===t[i+3])return void e(new DataView(t.buffer,i,22));r()}),(function(){n(s)}))}}((function(o){var a,c;a=o.getUint32(16,!0),c=o.getUint16(8,!0),a<0||a>=t.size?n(i):t.readUint8Array(a,t.size-a,(function(t){var s,o,a,h,u=0,d=[],p=A(t.length,t);for(s=0;s<c;s++){if((o=new l)._worker=r,1347092738!=p.view.getUint32(u))return void n(i);P(o,p,u+6,!0,n),o.commentLength=p.view.getUint16(u+32,!0),o.directory=16==(16&p.view.getUint8(u+38)),o.offset=p.view.getUint32(u+42,!0),a=B(p.array.subarray(u+46,u+46+o.filenameLength)),o.filename=2048==(2048&o.bitFlag)?w(a):y(a),o.directory||"/"!=o.filename.charAt(o.filename.length-1)||(o.directory=!0),h=B(p.array.subarray(u+46+o.filenameLength+o.extraFieldLength,u+46+o.filenameLength+o.extraFieldLength+o.commentLength)),o.comment=2048==(2048&o.bitFlag)?w(h):y(h),d.push(o),u+=46+o.filenameLength+o.extraFieldLength+o.commentLength}e(d)}),(function(){n(s)}))}))},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null),e&&e()},_worker:null};e.zip.useWebWorkers?I("inflater",(function(e){c._worker=e,o(c)}),(function(e){n(e)})):o(c)}function C(e){return unescape(encodeURIComponent(e))}function M(e){var t,i=[];for(t=0;t<e.length;t++)i.push(e.charCodeAt(t));return i}function E(t,i,s,o){var n={},a=[],l=0,c=0;function h(e){s(e||"Error while writing zip file.")}function u(e){s(e||r)}var d={add:function(i,r,d,p,f){var m,g,y,w=this._worker;function B(e,i){var s=A(16);l+=e||0,s.view.setUint32(0,1347094280),void 0!==i&&(m.view.setUint32(10,i,!0),s.view.setUint32(4,i,!0)),r&&(s.view.setUint32(8,e,!0),m.view.setUint32(14,e,!0),s.view.setUint32(12,r.size,!0),m.view.setUint32(18,r.size,!0)),t.writeUint8Array(s.array,(function(){l+=16,d()}),h)}function P(){f=f||{},i=i.trim(),f.directory&&"/"!=i.charAt(i.length-1)&&(i+="/"),n.hasOwnProperty(i)?s("File already exists."):(g=M(C(i)),a.push(i),function(e){var s;y=f.lastModDate||new Date,m=A(26),n[i]={headerArray:m.array,directory:f.directory,filename:g,offset:l,comment:M(C(f.comment||""))},m.view.setUint32(0,335546376),f.version&&m.view.setUint8(0,f.version),o||0===f.level||f.directory||m.view.setUint16(4,2048),m.view.setUint16(6,(y.getHours()<<6|y.getMinutes())<<5|y.getSeconds()/2,!0),m.view.setUint16(8,(y.getFullYear()-1980<<4|y.getMonth()+1)<<5|y.getDate(),!0),m.view.setUint16(22,g.length,!0),(s=A(30+g.length)).view.setUint32(0,1347093252),s.array.set(m.array,4),s.array.set(g,30),l+=s.array.length,t.writeUint8Array(s.array,e,h)}((function(){r?o||0===f.level?b(w,c++,r,t,0,r.size,!0,B,p,u,h):function(t,i,s,r,o,n,a,l,A){var c="input";e.zip.useWebWorkers?_(t,{sn:i,options:{level:o},codecClass:"Deflater",crcType:c},s,r,0,s.size,a,n,l,A):v(new e.zip.Deflater,s,r,0,s.size,c,a,n,l,A)}(w,c++,r,t,f.level,B,p,u,h):B()})))}r?r.init(P,u):P()},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null);var i,s,r,o=0,c=0;for(s=0;s<a.length;s++)o+=46+(r=n[a[s]]).filename.length+r.comment.length;for(i=A(o+22),s=0;s<a.length;s++)r=n[a[s]],i.view.setUint32(c,1347092738),i.view.setUint16(c+4,5120),i.array.set(r.headerArray,c+6),i.view.setUint16(c+32,r.comment.length,!0),r.directory&&i.view.setUint8(c+38,16),i.view.setUint32(c+42,r.offset,!0),i.array.set(r.filename,c+46),i.array.set(r.comment,c+46+r.filename.length),c+=46+r.filename.length+r.comment.length;i.view.setUint32(c,1347093766),i.view.setUint16(c+8,a.length,!0),i.view.setUint16(c+10,a.length,!0),i.view.setUint32(c+12,o,!0),i.view.setUint32(c+16,l,!0),t.writeUint8Array(i.array,(function(){t.getData(e)}),h)},_worker:null};e.zip.useWebWorkers?I("deflater",(function(e){d._worker=e,i(d)}),(function(e){s(e)})):i(d)}a.prototype.append=function(e){for(var t=0|this.crc,i=this.table,s=0,r=0|e.length;s<r;s++)t=t>>>8^i[255&(t^e[s])];this.crc=t},a.prototype.get=function(){return~this.crc},a.prototype.table=function(){var e,t,i,s=[];for(e=0;e<256;e++){for(i=e,t=0;t<8;t++)1&i?i=i>>>1^3988292384:i>>>=1;s[e]=i}return s}(),l.prototype.append=function(e,t){return e},l.prototype.flush=function(){},h.prototype=new c,h.prototype.constructor=h,u.prototype=new c,u.prototype.constructor=u,d.prototype=new c,d.prototype.constructor=d,p.prototype.getData=function(e){e(this.data)},f.prototype=new p,f.prototype.constructor=f,m.prototype=new p,m.prototype.constructor=m,g.prototype=new p,g.prototype.constructor=g;var F={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};function I(t,i,s){if(null===e.zip.workerScripts||null===e.zip.workerScriptsPath){var r;if(e.zip.workerScripts){if(r=e.zip.workerScripts[t],!Array.isArray(r))return void s(new Error("zip.workerScripts."+t+" is not an array!"));r=function(e){var t=document.createElement("a");return e.map((function(e){return t.href=e,t.href}))}(r)}else(r=F[t].slice(0))[0]=(e.zip.workerScriptsPath||"")+r[0];var o=new Worker(r[0]);o.codecTime=o.crcTime=0,o.postMessage({type:"importScripts",scripts:r.slice(1)}),o.addEventListener("message",(function e(t){var r=t.data;if(r.error)return o.terminate(),void s(r.error);"importScripts"===r.type&&(o.removeEventListener("message",e),o.removeEventListener("error",n),i(o))})),o.addEventListener("error",n)}else s(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."));function n(e){o.terminate(),s(e)}}function T(e){console.error(e)}e.zip={Reader:c,Writer:p,BlobReader:d,Data64URIReader:u,TextReader:h,BlobWriter:g,Data64URIWriter:m,TextWriter:f,createReader:function(e,t,i){i=i||T,e.init((function(){x(e,t,i)}),i)},createWriter:function(e,t,i,s){i=i||T,s=!!s,e.init((function(){E(e,t,i,s)}),i)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}}(PF);const xF=PF.zip;!function(e){var t,i,s=e.Reader,r=e.Writer;try{i=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(e){}function o(e){var t=this;function i(i,s){var r;t.data?i():((r=new XMLHttpRequest).addEventListener("load",(function(){t.size||(t.size=Number(r.getResponseHeader("Content-Length"))||Number(r.response.byteLength)),t.data=new Uint8Array(r.response),i()}),!1),r.addEventListener("error",s,!1),r.open("GET",e),r.responseType="arraybuffer",r.send())}t.size=0,t.init=function(s,r){if(function(e){var t=document.createElement("a");return t.href=e,"http:"===t.protocol||"https:"===t.protocol}(e)){var o=new XMLHttpRequest;o.addEventListener("load",(function(){t.size=Number(o.getResponseHeader("Content-Length")),t.size?s():i(s,r)}),!1),o.addEventListener("error",r,!1),o.open("HEAD",e),o.send()}else i(s,r)},t.readUint8Array=function(e,s,r,o){i((function(){r(new Uint8Array(t.data.subarray(e,e+s)))}),o)}}function n(e){var t=this;t.size=0,t.init=function(i,s){var r=new XMLHttpRequest;r.addEventListener("load",(function(){t.size=Number(r.getResponseHeader("Content-Length")),"bytes"==r.getResponseHeader("Accept-Ranges")?i():s("HTTP Range not supported.")}),!1),r.addEventListener("error",s,!1),r.open("HEAD",e),r.send()},t.readUint8Array=function(t,i,s,r){!function(t,i,s,r){var o=new XMLHttpRequest;o.open("GET",e),o.responseType="arraybuffer",o.setRequestHeader("Range","bytes="+t+"-"+(t+i-1)),o.addEventListener("load",(function(){s(o.response)}),!1),o.addEventListener("error",r,!1),o.send()}(t,i,(function(e){s(new Uint8Array(e))}),r)}}function a(e){var t=this;t.size=0,t.init=function(i,s){t.size=e.byteLength,i()},t.readUint8Array=function(t,i,s,r){s(new Uint8Array(e.slice(t,t+i)))}}function l(){var e,t=this;t.init=function(t,i){e=new Uint8Array,t()},t.writeUint8Array=function(t,i,s){var r=new Uint8Array(e.length+t.length);r.set(e),r.set(t,e.length),e=r,i()},t.getData=function(t){t(e.buffer)}}function A(e,t){var s,r=this;r.init=function(t,i){e.createWriter((function(e){s=e,t()}),i)},r.writeUint8Array=function(e,r,o){var n=new Blob([i?e:e.buffer],{type:t});s.onwrite=function(){s.onwrite=null,r()},s.onerror=o,s.write(n)},r.getData=function(t){e.file(t)}}o.prototype=new s,o.prototype.constructor=o,n.prototype=new s,n.prototype.constructor=n,a.prototype=new s,a.prototype.constructor=a,l.prototype=new r,l.prototype.constructor=l,A.prototype=new r,A.prototype.constructor=A,e.FileWriter=A,e.HttpReader=o,e.HttpRangeReader=n,e.ArrayBufferReader=a,e.ArrayBufferWriter=l,e.fs&&((t=e.fs.ZipDirectoryEntry).prototype.addHttpContent=function(i,s,r){return function(i,s,r,o){if(i.directory)return o?new t(i.fs,s,r,i):new e.fs.ZipFileEntry(i.fs,s,r,i);throw"Parent entry is not a directory."}(this,i,{data:s,Reader:r?n:o})},t.prototype.importHttpContent=function(e,t,i,s){this.importZip(t?new n(e):new o(e),i,s)},e.fs.FS.prototype.importHttpContent=function(e,i,s,r){this.entries=[],this.root=new t(this),this.root.importHttpContent(e,i,s,r)})}(xF);const CF=["4.2"];class MF{constructor(e,t={}){this.supportedSchemas=CF,this._xrayOpacity=.7,this._src=null,this._options=t,this.viewpoint=null,t.workerScriptsPath?(xF.workerScriptsPath=t.workerScriptsPath,this.src=t.src,this.xrayOpacity=.7,this.displayEffect=t.displayEffect,this.createMetaModel=t.createMetaModel):e.error("Config expected: workerScriptsPath")}load(e,t,i,s,r,o){switch(s.materialType){case"MetallicMaterial":t._defaultMaterial=new Ns(t,{baseColor:[1,1,1],metallic:.6,roughness:.6});break;case"SpecularMaterial":t._defaultMaterial=new Hs(t,{diffuse:[1,1,1],specular:d.vec3([1,1,1]),glossiness:.5});break;default:t._defaultMaterial=new bs(t,{reflectivity:.75,shiness:100,diffuse:[1,1,1]})}t._wireframeMaterial=new Ls(t,{color:[0,0,0],lineWidth:2});var n=t.scene.canvas.spinner;n.processes++,EF(e,t,i,s,(function(){n.processes--,r&&r(),t.fire("loaded",!0,!1)}),(function(e){n.processes--,t.error(e),o&&o(e),t.fire("error",e)}),(function(e){console.log("Error, Will Robinson: "+e)}))}}var EF=function(e,t,i,s,r,o){!function(e,t,i){var s=new LF;s.load(e,(function(){t(s)}),(function(e){i("Error loading ZIP archive: "+e)}))}(i,(function(i){FF(e,i,s,t,r,o)}),o)},FF=function(){return function(t,i,s,r,o){var n={plugin:t,zip:i,edgeThreshold:30,materialType:s.materialType,scene:r.scene,modelNode:r,info:{references:{}},materials:{}};s.createMetaModel&&(n.metaModelData={modelId:r.id,metaObjects:[{name:r.id,type:"Default",id:r.id}]}),r.scene.loading++,function(t,i){t.zip.getFile("Manifest.xml",(function(s,r){for(var o=r.children,n=0,a=o.length;n<a;n++){var l=o[n];if("Manifest"===l.type)e(t,l,i)}}))}(n,(function(){n.metaModelData&&t.viewer.metaScene.createMetaModel(r.id,n.metaModelData),r.scene.loading--,o()}))};function e(e,i,s){for(var r=i.children,o=0,n=r.length;o<n;o++){var a=r[o];if("Root"===a.type){var l=a.children[0];e.zip.getFile(l,(function(i,r){t(e,r,s)}))}}}function t(e,t,s){for(var r=t.children,o=0,n=r.length;o<n;o++){var a=r[o];if("Model_3dxml"===a.type)i(e,a,s)}}function i(e,t,i){for(var r=t.children,a=0,l=r.length;a<l;a++){var A=r[a];switch(A.type){case"Header":s(e,A);break;case"ProductStructure":o(e,A,i);break;case"DefaultView":n(e,A)}}}function s(e,t){for(var i=t.children,s={},o=0,n=i.length;o<n;o++){var a=i[o];switch(a.type){case"SchemaVersion":s.schemaVersion=a.children[0],r(e,s.schemaVersion)||e.plugin.error("Schema version not supported: "+s.schemaVersion+" - supported versions are: "+CF.join(","));break;case"Title":s.title=a.children[0];break;case"Author":s.author=a.children[0];break;case"Created":s.created=a.children[0]}}e.modelNode.meta=s}function r(e,t){for(var i=0,s=CF.length;i<s;i++)if(t===CF[i])return!0;return!1}function o(e,t,i){!function(e,t,i){for(var s={},r=t.children,o=0,n=0,l=r.length;n<l;n++){"ReferenceRep"===(A=r[n]).type&&o++}for(n=0,l=r.length;n<l;n++){var A;if("ReferenceRep"===(A=r[n]).type)if(A.associatedFile){var c=kF(A.associatedFile);!function(){var t=A.id;e.zip.getFile(c,(function(r,n){var l=r.getElementsByTagName("MaterialId");IF(e,l,(function(){var r={id:t};a(e,n,r),s[t]=r,0==--o&&i(s)}))}),(function(e){}))}()}}}(e,t,(function(s){for(var r=t.children,o={},n={},a={},l=0,A=r.length;l<A;l++){var c=r[l];switch(c.type){case"Reference3D":o[c.id]={type:"Reference3D",id:c.id,name:c.name,instance3Ds:{},instanceReps:{}};break;case"InstanceRep":for(var h=0,u=c.children.length;h<u;h++){switch((_=c.children[h]).type){case"IsAggregatedBy":p=_.children[0];break;case"IsInstanceOf":f=_.children[0]}}n[c.id]={type:"InstanceRep",id:c.id,name:c.name,isAggregatedBy:p,isInstanceOf:f,referenceReps:{}};break;case"Instance3D":var p,f,g;for(h=0,u=c.children.length;h<u;h++){var _;switch((_=c.children[h]).type){case"IsAggregatedBy":p=_.children[0];break;case"IsInstanceOf":f=_.children[0];break;case"RelativeMatrix":g=_.children[0]}}a[c.id]={type:"Instance3D",id:c.id,name:c.name,isAggregatedBy:p,isInstanceOf:f,relativeMatrix:g,reference3Ds:{}}}}for(var v in a){(y=o[(b=a[v]).isAggregatedBy])?y.instance3Ds[b.id]=b:alert("foo")}for(var v in a){var b,y=o[(b=a[v]).isInstanceOf];b.reference3Ds[y.id]=y,y.instance3D=b}for(var v in n){var w=s[(B=n[v]).isInstanceOf];w&&(B.referenceReps[w.id]=w)}for(var v in n){var B;(y=o[(B=n[v]).isAggregatedBy])&&(y.instanceReps[B.id]=B)}function P(e,t,i){for(var s in t.instance3Ds)x(e,t.instance3Ds[s],i);for(var s in t.instanceReps)C(e,t.instanceReps[s],i)}function x(e,t,i){if(t.relativeMatrix){var s=m(t.relativeMatrix,12),r=[s[9],s[10],s[11]],o=s.slice(0,9),n=d.mat3ToMat4(o,d.identityMat4()),a=new Ke(e.modelNode,{position:r});e.metaModelData&&e.metaModelData.metaObjects.push({id:a.id,type:"Default",name:t.name,parent:i?i.id:e.modelNode.id}),i?i.addChild(a,!0):e.modelNode.addChild(a,!0),i=a,a=new Ke(e.modelNode,{matrix:n}),e.metaModelData&&e.metaModelData.metaObjects.push({id:a.id,type:"Default",name:t.name,parent:i?i.id:e.modelNode.id}),i.addChild(a,!0),i=a}else{a=new Ke(e.modelNode,{});e.metaModelData&&e.metaModelData.metaObjects.push({id:a.id,type:"Default",name:t.name,parent:i?i.id:e.modelNode.id}),i?i.addChild(a,!0):e.modelNode.addChild(a,!0),i=a}for(var l in t.reference3Ds)P(e,t.reference3Ds[l],i)}function C(e,t,i){if(t.referenceReps)for(var s in t.referenceReps){var r=t.referenceReps[s];for(var o in r)if("id"!==o){var n=r[o],a="lines"===n.geometry.primitive?e.modelNode._wireframeMaterial:n.materialId?e.materials[n.materialId]:null,l=n.color,A=new fs(e.modelNode,{isObject:!0,geometry:n.geometry,material:a||e.modelNode._defaultMaterial,colorize:l,backfaces:!1});e.metaModelData&&e.metaModelData.metaObjects.push({id:A.id,type:"Default",name:t.name,parent:i?i.id:e.modelNode.id}),i?i.addChild(A,!0):e.modelNode.addChild(A,!0),A.colorize=l}}}for(var v in o){if(!(y=o[v]).instance3D)return P(e,y,null),void i()}alert("No root Reference3D element found in this modelNode - can't load."),i()}))}function n(e,t){for(var i=t.children,s=0,r=i.length;s<r;s++){var o=i[s];if("Viewpoint"===o.type){var n=o.children;e.modelNode.viewpoint={};for(var a=0,l=n.length;a<l;a++){var A=n[s];switch(A.type){case"Position":e.modelNode.viewpoint.eye=m(A.children[0],3);break;case"Sight":e.modelNode.viewpoint.look=m(A.children[0],3);break;case"Up":e.modelNode.viewpoint.up=m(A.children[0],3)}}}}}function a(e,t,i){for(var s=t.children,r=0,o=s.length;r<o;r++){var n=s[r];if("XMLRepresentation"===n.type)l(e,n,i)}}function l(e,t,i){for(var s=t.children,r=0,o=s.length;r<o;r++){var n=s[r];if("Root"===n.type)A(e,n,i)}}function A(e,t,i){t["xsi:type"];for(var s=t.children,r=0,o=s.length;r<o;r++){var n=s[r];if("Rep"===n.type)c(e,n,i)}}function c(e,t,i){t["xsi:type"];for(var s={edgeThreshold:e.edgeThreshold||30,compressGeometry:!0},r=t.children,o=0,n=r.length;o<n;o++){var a=r[o];switch(a.type){case"Rep":c(e,a,i);break;case"Edges":break;case"Faces":s.primitive="triangles",h(e,a,s);break;case"VertexBuffer":f(e,a,s);break;case"SurfaceAttributes":g(e,a,s)}}if(s.positions){var l=new ve(e.modelNode,s);i[l.id]={geometry:l,color:s.color||[1,1,1,1],materialId:s.materialId}}}function h(e,t,i){for(var s=t.children,r=0,o=s.length;r<o;r++){var n=s[r];if("Face"===n.type)u(e,n,i)}}function u(e,t,i){var s=t.strips;if(s){var r=function(e){for(var t=e.split(","),i=[],s=0,r=t.length;s<r;s++){var o=t[s].trim();if(o.length>0){for(var n=o.trim().split(" "),a=new Int16Array(n.length),l=0,A=0,c=n.length;A<c;A++)""!==n[A]&&(a[l++]=parseInt(n[A]));i.push(a)}}return i}(s);if(r.length>0){i.primitive="triangles";for(var o=[],n=0,a=r.length;n<a;n++)for(var l=p(r[n]),A=0,c=l.length;A<c;A++)o.push(l[A]);i.indices=o}}else{var h=t.triangles;h&&(i.primitive="triangles",i.indices=function(e){e=e.trim().split(" ");for(var t=new Int32Array(e.length),i=0,s=e.length;i<s;i++){var r=e[i];t[i]=parseInt(r)}return t}(h))}var u=t.children;for(n=0,a=u.length;n<a;n++){var d=u[n];if("SurfaceAttributes"===d.type)g(e,d,i)}}function p(e){for(var t=[],i=0,s=e.length;i<s-2;i++)1&i?(t.push(e[i]),t.push(e[i+2]),t.push(e[i+1])):(t.push(e[i]),t.push(e[i+1]),t.push(e[i+2]));return t}function f(e,t,i){for(var s=t.children,r=0,o=s.length;r<o;r++){var n=s[r];switch(n.type){case"Positions":i.positions=m(n.children[0],3);break;case"Normals":i.normals=m(n.children[0],3);break;case"TextureCoordinates":i.uv=m(n.children[0],2)}}}function m(e,t){e=e.split(",");for(var i=new Float32Array(e.length*t),s=0,r=0,o=e.length;r<o;r++)for(var n=e[r],a=0,l=(n=n.split(" ")).length;a<l;a++)""!==n[a]&&(i[s++]=parseFloat(n[a]));return i}function g(e,t,i){i.color=[1,1,1,1];for(var s,r,o=t.children,n=0,a=o.length;n<a;n++){var l=o[n];switch(l.type){case"Color":i.color[0]=l.red,i.color[1]=l.green,i.color[2]=l.blue,i.color[3]=l.alpha;break;case"MaterialApplication":for(var A=l.children,c=0,h=A.length;c<h;c++){var u=A[c];if("MaterialId"===u.type){var d=(s=u.id,r=void 0,-1!==(r=s.lastIndexOf("#"))?s.substring(r+1):s);e.materials[d]||e.plugin.error("material  not found: "+d),i.materialId=d}}}}}}();function IF(e,t,i){var s={};!function r(o,n){if(o>=t.length)i();else{var a=t[o].id,l=a.lastIndexOf(":");l>0&&(a=a.substring(l+1));var A=a.lastIndexOf("#");A>0&&(a=a.substring(0,A)),s[a]?r(o+1):function(e,t,i){e.zip.getFile(t,(function(t,s){!function(e,t,i){for(var s,r=t.children,o=0,n=r.length;o<n;o++)"Model_3dxml"===(s=r[o]).type&&TF(e,s,i)}(e,s,i)}))}(e,a,(function(){s[a]=!0,r(o+1)}))}}(0)}function TF(e,t,i){for(var s,r=t.children,o=0,n=r.length;o<n;o++)"CATMaterialRef"===(s=r[o]).type&&DF(e,s,i)}function DF(e,t,i){for(var s={},r=t.children,o=0,n=0,a=r.length;n<a;n++){if("MaterialDomainInstance"===(d=r[n]).type){for(var l,A,c=0,h=d.children.length;c<h;c++){var u=d.children[c];switch(u.type){case"IsAggregatedBy":l=u.children[0];break;case"IsInstanceOf":A=u.children[0]}}s[A]=l}}for(n=0,a=r.length;n<a;n++){if("MaterialDomain"===(d=r[n]).type)o++}for(n=0,a=r.length;n<a;n++){var d;if("MaterialDomain"===(d=r[n]).type)d.associatedFile&&function(){var t=d.id,r=kF(d.associatedFile);e.zip.getFile(r,(function(r,n){e.materials[s[t]]=SF(e,n),0==--o&&i()}),(function(e){}))}()}}function SF(e,t){for(var i=t.children,s=0,r=i.length;s<r;s++){var o=i[s];if("Osm"===o.type)return RF(e,o)}}function RF(e,t){for(var i=t.children,s=0,r=i.length;s<r;s++){var o=i[s];switch(o.type){case"RenderingRootFeature":break;case"Feature":if("RenderingFeature"===o.Alias){var n,a,l,A,c={},h={},u=o.children;for(n=0,a=u.length;n<a;n++)switch((l=u[n]).Name){case"AmbientCoef":c.ambient=parseFloat(l.Value);break;case"DiffuseCoef":c.diffuse=parseFloat(l.Value);break;case"EmissiveCoef":c.emissive=parseFloat(l.Value);break;case"SpecularExponent":c.specular=parseFloat(l.Value)}for(n=0,a=u.length;n<a;n++)switch((l=u[n]).Name){case"AmbientColor":h.ambient=UF(l.Value,c.ambient);break;case"DiffuseColor":h.diffuse=UF(l.Value,c.diffuse);break;case"EmissiveColor":h.emissive=UF(l.Value,c.emissive);break;case"SpecularColor":h.specular=UF(l.Value,c.specular);break;case"Transparency":var d=1-parseFloat(l.Value);d<1&&(h.alpha=d,h.alphaMode="blend")}switch(e.materialType){case"MetallicMaterial":A=new Ns(e.modelNode,{baseColor:h.diffuse,metallic:.7,roughness:.5,emissive:h.emissive,alpha:h.alpha,alphaMode:h.alphaMode});break;case"SpecularMaterial":A=new Hs(e.modelNode,{diffuse:h.diffuse,specular:h.specular,glossiness:.5,emissive:h.emissive,alpha:h.alpha,alphaMode:h.alphaMode});break;default:A=new bs(e.modelNode,{reflectivity:.5,ambient:h.ambient,diffuse:h.diffuse,specular:h.specular,emissive:h.emissive,alphaMode:h.alphaMode,alpha:t.alpha})}return A}}}}function UF(e,t){t=void 0!==t?t:.5;var i=e.indexOf("["),s=e.indexOf("]");e=(e=e.substring(i+1,s-i)).split(",");for(var r=new Float32Array(e.length),o=0,n=0,a=e.length;n<a;n++)for(var l=e[n],A=0,c=(l=l.trim().split(" ")).length;A<c;A++)""!==l[A]&&(r[o++]=parseFloat(l[A])*t);return r}var LF=function(){var e={};function t(e,i){if(e.nodeType===e.TEXT_NODE){var s=e.nodeValue;if(null===s.match(/^\s+$/))return s}else if(e.nodeType===e.ELEMENT_NODE||e.nodeType===e.DOCUMENT_NODE){var r={type:e.nodeName,children:[]};if(e.nodeType===e.ELEMENT_NODE)for(var o=0;o<e.attributes.length;o++){var n=e.attributes[o];r[i[n.nodeName]||n.nodeName]=n.nodeValue}for(var a=0;a<e.childNodes.length;a++){(o=t(e.childNodes[a],i))&&r.children.push(o)}return r}}this.load=function(t,i,s){xF.createReader(new xF.HttpReader(t),(function(t){t.getEntries((function(t){if(t.length>0)for(var s=0,r=t.length;s<r;s++){var o=t[s];e[o.filename]=o}i()}))}),s)},this.getFile=function(i,s,r){var o=e[i];if(!o){var n="ZIP entry not found: "+i;return console.error(n),void(r&&r(n))}o.getData(new xF.TextWriter,(function(e){var i=(new DOMParser).parseFromString(e,"text/xml"),r=t(i,{});s(i,r)}))},this.destroy=function(){undefined.close((function(){}))}};function kF(e){var t="urn:3DXML:";return 0===e.indexOf(t)?e.substring(t.length):e}class OF extends ph{constructor(e,t={}){super("XML3DLoader",e,t),t.workerScriptsPath?(this._workerScriptsPath=t.workerScriptsPath,this._loader=new MF(this,t),this.supportedSchemas=this._loader.supportedSchemas):this.error("Config expected: workerScriptsPath")}load(e={}){e.workerScriptsPath=this._workerScriptsPath,e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);const t=new Ke(this.viewer.scene,y.apply(e,{isModel:!0})),i=e.src;return i?(this._loader.load(this,t,i,e),t):(this.error("load() param expected: src"),t)}}class NF{constructor(e={}){this.cacheBuster=!1!==e.cacheBuster}_cacheBusterURL(e){if(!this.cacheBuster)return e;const t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}getIFC(e,t,i){e=this._cacheBusterURL(e);var s=()=>{};t=t||s,i=i||s;const r=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const e=!!r[2];var o=r[3];o=window.decodeURIComponent(o),e&&(o=window.atob(o));try{const e=new ArrayBuffer(o.length),i=new Uint8Array(e);for(var n=0;n<o.length;n++)i[n]=o.charCodeAt(n);t(e)}catch(e){i(e)}}else{const s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?t(s.response):i("getXKT error : "+s.response))},s.send(null)}}}class VF extends ph{constructor(e,t={}){if(super("ifcLoader",e,t),this.dataSource=t.dataSource,this.objectDefaults=t.objectDefaults,this.includeTypes=t.includeTypes,this.excludeTypes=t.excludeTypes,this.excludeUnclassifiedObjects=t.excludeUnclassifiedObjects,!t.WebIFC)throw"Parameter expected: WebIFC";if(!t.IfcAPI)throw"Parameter expected: IfcAPI";this._webIFC=t.WebIFC,this._ifcAPI=t.IfcAPI}get supportedVersions(){return["2x3","4"]}get dataSource(){return this._dataSource}set dataSource(e){this._dataSource=e||new NF}get objectDefaults(){return this._objectDefaults}set objectDefaults(e){this._objectDefaults=e||CM}get includeTypes(){return this._includeTypes}set includeTypes(e){this._includeTypes=e}get excludeTypes(){return this._excludeTypes}set excludeTypes(e){this._excludeTypes=e}get excludeUnclassifiedObjects(){return this._excludeUnclassifiedObjects}set excludeUnclassifiedObjects(e){this._excludeUnclassifiedObjects=!!e}get globalizeObjectIds(){return this._globalizeObjectIds}set globalizeObjectIds(e){this._globalizeObjectIds=!!e}load(e={}){e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);const t=new Tc(this.viewer.scene,y.apply(e,{isModel:!0}));if(!e.src&&!e.ifc)return this.error("load() param expected: src or IFC"),t;const i={autoNormals:!0};if(!1!==e.loadMetadata){const t=e.includeTypes||this._includeTypes,s=e.excludeTypes||this._excludeTypes,r=e.objectDefaults||this._objectDefaults;if(t){i.includeTypesMap={};for(let e=0,s=t.length;e<s;e++)i.includeTypesMap[t[e]]=!0}if(s){i.excludeTypesMap={};for(let e=0,t=s.length;e<t;e++)i.excludeTypesMap[s[e]]=!0}r&&(i.objectDefaults=r),i.excludeUnclassifiedObjects=void 0!==e.excludeUnclassifiedObjects?!!e.excludeUnclassifiedObjects:this._excludeUnclassifiedObjects,i.globalizeObjectIds=void 0!==e.globalizeObjectIds?!!e.globalizeObjectIds:this._globalizeObjectIds}try{e.src?this._loadModel(e.src,e,i,t):this._parseModel(e.ifc,e,i,t)}catch(e){this.error(e),t.fire("error",e)}return t}_loadModel(e,t,i,s){const r=this.viewer.scene.canvas.spinner;r.processes++,this._dataSource.getIFC(t.src,(e=>{this._parseModel(e,t,i,s),r.processes--}),(e=>{r.processes--,this.error(e),s.fire("error",e)}))}_parseModel(e,t,i,s){if(s.destroyed)return;const r=t.stats||{};if(r.sourceFormat="IFC",r.schemaVersion="",r.title="",r.author="",r.created="",r.numMetaObjects=0,r.numPropertySets=0,r.numObjects=0,r.numGeometries=0,r.numTriangles=0,r.numVertices=0,!this._ifcAPI)throw"WebIFCLoaderPlugin has no WebIFC instance configured - please inject via WebIFCLoaderPlugin constructor";const o=new Uint8Array(e),n=this._ifcAPI.OpenModel(o),a=this._ifcAPI.GetModelSchema(n),l=this._ifcAPI.GetLineIDsWithType(n,this._webIFC.IFCPROJECT).get(0),A=!1!==t.loadMetadata,c={modelID:n,modelSchema:a,sceneModel:s,loadMetadata:A,metadata:A?{id:"",projectId:""+l,author:"",createdAt:"",schema:"",creatingApplication:"",metaObjects:[],propertySets:[]}:null,metaObjects:{},options:i,log:function(e){},nextId:0,stats:r};if(A){if(i.includeTypes){c.includeTypes={};for(let e=0,t=i.includeTypes.length;e<t;e++)c.includeTypes[i.includeTypes[e]]=!0}if(i.excludeTypes){c.excludeTypes={};for(let e=0,t=i.excludeTypes.length;e<t;e++)c.excludeTypes[i.excludeTypes[e]]=!0}this._parseMetaObjects(c),this._parsePropertySets(c)}if(this._parseGeometry(c),s.finalize(),A){const e=s.id;this.viewer.metaScene.createMetaModel(e,c.metadata,i)}s.scene.once("tick",(()=>{s.destroyed||(s.scene.fire("modelLoaded",s.id),s.fire("loaded",!0,!1))}))}_parseMetaObjects(e){const t=this._ifcAPI.GetLineIDsWithType(e.modelID,this._webIFC.IFCPROJECT).get(0),i=this._ifcAPI.GetLine(e.modelID,t);this._parseSpatialChildren(e,i)}_parseSpatialChildren(e,t,i){const s=this._ifcAPI.GetNameFromTypeCode(t.type);if(e.includeTypes&&!e.includeTypes[s])return;if(e.excludeTypes&&e.excludeTypes[s])return;this._createMetaObject(e,t,i);const r=t.GlobalId.value;this._parseRelatedItemsOfType(e,t.expressID,"RelatingObject","RelatedObjects",this._webIFC.IFCRELAGGREGATES,r),this._parseRelatedItemsOfType(e,t.expressID,"RelatingStructure","RelatedElements",this._webIFC.IFCRELCONTAINEDINSPATIALSTRUCTURE,r)}_createMetaObject(e,t,i){const s=t.GlobalId.value,r=this._ifcAPI.GetNameFromTypeCode(t.type),o={id:s,name:t.Name&&""!==t.Name.value?t.Name.value:r,type:r,parent:i};e.metadata.metaObjects.push(o),e.metaObjects[s]=o,e.stats.numMetaObjects++}_parseRelatedItemsOfType(e,t,i,s,r,o){const n=this._ifcAPI.GetLineIDsWithType(e.modelID,r);for(let r=0;r<n.size();r++){const a=n.get(r),l=this._ifcAPI.GetLine(e.modelID,a),A=l[i];let c=!1;if(Array.isArray(A)){c=A.map((e=>e.value)).includes(t)}else c=A.value===t;if(c){const t=l[s];if(Array.isArray(t))t.forEach((t=>{const i=this._ifcAPI.GetLine(e.modelID,t.value);this._parseSpatialChildren(e,i,o)}));else{const i=this._ifcAPI.GetLine(e.modelID,t.value);this._parseSpatialChildren(e,i,o)}}}}_parsePropertySets(e){const t=this._ifcAPI.GetLineIDsWithType(e.modelID,this._webIFC.IFCRELDEFINESBYPROPERTIES);for(let i=0;i<t.size();i++){let s=t.get(i),r=this._ifcAPI.GetLine(e.modelID,s,!0);if(r){const t=r.RelatingPropertyDefinition;if(!t)continue;const i=t.GlobalId.value,s=t.HasProperties;if(s&&s.length>0){const o="Default",n=t.Name.value,a=[];for(let e=0,t=s.length;e<t;e++){const t=s[e],i=t.Name,r=t.NominalValue;if(i&&r){const e={name:i.value,type:r.type,value:r.value,valueType:r.valueType};t.Description?e.description=t.Description.value:r.description&&(e.description=r.description),a.push(e)}}const l={id:i,type:o,name:n,properties:a};e.metadata.propertySets.push(l),e.stats.numPropertySets++;const A=r.RelatedObjects;if(!A||0===A.length)return;for(let t=0,s=A.length;t<s;t++){const s=A[t].GlobalId.value,r=e.metaObjects[s];r&&(r.propertySetIds||(r.propertySetIds=[]),r.propertySetIds.push(i))}}}}}_parseGeometry(e){this._ifcAPI.StreamAllMeshes(e.modelID,(t=>{const i=t.expressID,s=t.geometries,r=[],o=this._ifcAPI.GetLine(e.modelID,i).GlobalId.value;if(e.loadMetadata){const t=o,i=e.metaObjects[t];if(e.includeTypes&&(!i||!e.includeTypes[i.type]))return;if(e.excludeTypes&&(!i||e.excludeTypes[i.type]))return}const n=d.mat4(),a=d.vec3();for(let t=0,i=s.size();t<i;t++){const i=s.get(t),o=this._ifcAPI.GetGeometry(e.modelID,i.geometryExpressID),l=this._ifcAPI.GetVertexArray(o.GetVertexData(),o.GetVertexDataSize()),A=this._ifcAPI.GetIndexArray(o.GetIndexData(),o.GetIndexDataSize()),c=new Float64Array(l.length/2),h=new Float32Array(l.length/2);for(let e=0,t=0,i=l.length/6;e<i;e++,t+=3)c[t+0]=l[6*e+0],c[t+1]=l[6*e+1],c[t+2]=l[6*e+2];n.set(i.flatTransformation),d.transformPositions3(n,c);const u=$e(c,c,a);if(!e.options.autoNormals)for(let e=0,t=0,i=l.length/6;e<i;e++,t+=3)h[t+0]=l[6*e+3],h[t+1]=l[6*e+4],h[t+2]=l[6*e+5];e.stats.numGeometries++,e.stats.numVertices+=c.length/3,e.stats.numTriangles+=A.length/3;const p="mesh"+e.nextId++;e.sceneModel.createMesh({id:p,primitive:"triangles",origin:u?a:null,positions:c,normals:e.options.autoNormals?null:h,indices:A,color:[i.color.x,i.color.y,i.color.z],opacity:i.color.w}),r.push(p)}const l=e.options.globalizeObjectIds?d.globalizeObjectId(e.sceneModel.id,o):o;e.sceneModel.createEntity({id:l,meshIds:r,isObject:!0}),e.stats.numObjects++}))}}const QF="0.0.3-alpha";var HF=Object.defineProperty,jF=(e,t,i)=>(((e,t,i)=>{t in e?HF(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i),GF=(()=>async function(e={}){var t,i,s,r=e,o=new Promise(((e,s)=>{t=e,i=s})),n=[],a="./this.program",l=(e,t)=>{throw t},A=import.meta.url,c="";try{c=new URL(".",A).href}catch{}s=async e=>{var t=await fetch(e,{credentials:"same-origin"});if(t.ok)return t.arrayBuffer();throw new Error(t.status+" : "+t.url)};var h,u,d,p,f,m,g,_,v,b,y,w,B,P=console.log.bind(console),x=console.error.bind(console),C=!1;function M(){var e=u.buffer;p=new Int8Array(e),m=new Int16Array(e),f=new Uint8Array(e),g=new Uint16Array(e),_=new Int32Array(e),v=new Uint32Array(e),b=new Float32Array(e),B=new Float64Array(e),y=new BigInt64Array(e),w=new BigUint64Array(e)}var E,F=0,I=null;function T(e){F++,r.monitorRunDependencies?.(F)}function D(e){if(F--,r.monitorRunDependencies?.(F),0==F&&I){var t=I;I=null,t()}}function S(e){r.onAbort?.(e),x(e="Aborted("+e+")"),C=!0,e+=". Build with -sASSERTIONS for more info.";var t=new WebAssembly.RuntimeError(e);throw i(t),t}function R(){return r.locateFile?(e="ifcdb.wasm",r.locateFile?r.locateFile(e,c):c+e):new URL("ifcdb.wasm",import.meta.url).href;var e}async function U(e){if(!h)try{var t=await s(e);return new Uint8Array(t)}catch{}return function(e){if(e==E&&h)return new Uint8Array(h);throw"both async and sync fetching of the wasm failed"}(e)}async function L(e,t,i){if(!e&&"function"==typeof WebAssembly.instantiateStreaming)try{var s=fetch(t,{credentials:"same-origin"});return await WebAssembly.instantiateStreaming(s,i)}catch(e){x(`wasm streaming compile failed: ${e}`),x("falling back to ArrayBuffer instantiation")}return async function(e,t){try{var i=await U(e);return await WebAssembly.instantiate(i,t)}catch(e){x(`failed to asynchronously prepare wasm: ${e}`),S(e)}}(t,i)}class k{constructor(e){jF(this,"name","ExitStatus"),this.message=`Program terminated with exit(${e})`,this.status=e}}var O=e=>{for(;e.length>0;)e.shift()(r)},N=[],V=e=>N.push(e),Q=[],H=e=>Q.push(e),j=(e,t,i=[],s=!1)=>{var o=((e,t,i)=>(e=e.replace(/p/g,"i"),(0,r["dynCall_"+e])(t,...i)))(e,t,i);return o},G=!0;class z{constructor(e){this.excPtr=e,this.ptr=e-24}set_type(e){v[this.ptr+4>>2]=e}get_type(){return v[this.ptr+4>>2]}set_destructor(e){v[this.ptr+8>>2]=e}get_destructor(){return v[this.ptr+8>>2]}set_caught(e){e=e?1:0,p[this.ptr+12]=e}get_caught(){return 0!=p[this.ptr+12]}set_rethrown(e){e=e?1:0,p[this.ptr+13]=e}get_rethrown(){return 0!=p[this.ptr+13]}init(e,t){this.set_adjusted_ptr(0),this.set_type(e),this.set_destructor(t)}set_adjusted_ptr(e){v[this.ptr+16>>2]=e}get_adjusted_ptr(){return v[this.ptr+16>>2]}}var W=()=>{var e=_[+he.varargs>>2];return he.varargs+=4,e},X=W,K={isAbs:e=>"/"===e.charAt(0),splitPath:e=>/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(e).slice(1),normalizeArray:(e,t)=>{for(var i=0,s=e.length-1;s>=0;s--){var r=e[s];"."===r?e.splice(s,1):".."===r?(e.splice(s,1),i++):i&&(e.splice(s,1),i--)}if(t)for(;i;i--)e.unshift("..");return e},normalize:e=>{var t=K.isAbs(e),i="/"===e.slice(-1);return e=K.normalizeArray(e.split("/").filter((e=>!!e)),!t).join("/"),e||t||(e="."),e&&i&&(e+="/"),(t?"/":"")+e},dirname:e=>{var t=K.splitPath(e),i=t[0],s=t[1];return i||s?(s&&(s=s.slice(0,-1)),i+s):"."},basename:e=>e&&e.match(/([^\/]+|\/)\/*$/)[1],join:(...e)=>K.normalize(e.join("/")),join2:(e,t)=>K.normalize(e+"/"+t)},Z=e=>{(Z=e=>crypto.getRandomValues(e))(e)},J={resolve:(...e)=>{for(var t="",i=!1,s=e.length-1;s>=-1&&!i;s--){var r=s>=0?e[s]:Ae.cwd();if("string"!=typeof r)throw new TypeError("Arguments to path.resolve must be strings");if(!r)return"";t=r+"/"+t,i=K.isAbs(r)}return t=K.normalizeArray(t.split("/").filter((e=>!!e)),!i).join("/"),(i?"/":"")+t||"."},relative:(e,t)=>{function i(e){for(var t=0;t<e.length&&""===e[t];t++);for(var i=e.length-1;i>=0&&""===e[i];i--);return t>i?[]:e.slice(t,i-t+1)}e=J.resolve(e).slice(1),t=J.resolve(t).slice(1);for(var s=i(e.split("/")),r=i(t.split("/")),o=Math.min(s.length,r.length),n=o,a=0;a<o;a++)if(s[a]!==r[a]){n=a;break}var l=[];for(a=n;a<s.length;a++)l.push("..");return(l=l.concat(r.slice(n))).join("/")}},Y="undefined"!=typeof TextDecoder?new TextDecoder:void 0,q=(e,t=0,i=NaN)=>{for(var s=t+i,r=t;e[r]&&!(r>=s);)++r;if(r-t>16&&e.buffer&&Y)return Y.decode(e.subarray(t,r));for(var o="";t<r;){var n=e[t++];if(128&n){var a=63&e[t++];if(192!=(224&n)){var l=63&e[t++];if((n=224==(240&n)?(15&n)<<12|a<<6|l:(7&n)<<18|a<<12|l<<6|63&e[t++])<65536)o+=String.fromCharCode(n);else{var A=n-65536;o+=String.fromCharCode(55296|A>>10,56320|1023&A)}}else o+=String.fromCharCode((31&n)<<6|a)}else o+=String.fromCharCode(n)}return o},$=[],ee=e=>{for(var t=0,i=0;i<e.length;++i){var s=e.charCodeAt(i);s<=127?t++:s<=2047?t+=2:s>=55296&&s<=57343?(t+=4,++i):t+=3}return t},te=(e,t,i,s)=>{if(!(s>0))return 0;for(var r=i,o=i+s-1,n=0;n<e.length;++n){var a=e.charCodeAt(n);if(a>=55296&&a<=57343)a=65536+((1023&a)<<10)|1023&e.charCodeAt(++n);if(a<=127){if(i>=o)break;t[i++]=a}else if(a<=2047){if(i+1>=o)break;t[i++]=192|a>>6,t[i++]=128|63&a}else if(a<=65535){if(i+2>=o)break;t[i++]=224|a>>12,t[i++]=128|a>>6&63,t[i++]=128|63&a}else{if(i+3>=o)break;t[i++]=240|a>>18,t[i++]=128|a>>12&63,t[i++]=128|a>>6&63,t[i++]=128|63&a}}return t[i]=0,i-r},ie=(e,t,i)=>{var s=i>0?i:ee(e)+1,r=new Array(s),o=te(e,r,0,r.length);return t&&(r.length=o),r},se={ttys:[],init(){},shutdown(){},register(e,t){se.ttys[e]={input:[],output:[],ops:t},Ae.registerDevice(e,se.stream_ops)},stream_ops:{open(e){var t=se.ttys[e.node.rdev];if(!t)throw new Ae.ErrnoError(43);e.tty=t,e.seekable=!1},close(e){e.tty.ops.fsync(e.tty)},fsync(e){e.tty.ops.fsync(e.tty)},read(e,t,i,s,r){if(!e.tty||!e.tty.ops.get_char)throw new Ae.ErrnoError(60);for(var o=0,n=0;n<s;n++){var a;try{a=e.tty.ops.get_char(e.tty)}catch(e){throw new Ae.ErrnoError(29)}if(void 0===a&&0===o)throw new Ae.ErrnoError(6);if(null==a)break;o++,t[i+n]=a}return o&&(e.node.atime=Date.now()),o},write(e,t,i,s,r){if(!e.tty||!e.tty.ops.put_char)throw new Ae.ErrnoError(60);try{for(var o=0;o<s;o++)e.tty.ops.put_char(e.tty,t[i+o])}catch(e){throw new Ae.ErrnoError(29)}return s&&(e.node.mtime=e.node.ctime=Date.now()),o}},default_tty_ops:{get_char:e=>(()=>{if(!$.length){var e=null;if("undefined"!=typeof window&&"function"==typeof window.prompt&&null!==(e=window.prompt("Input: "))&&(e+="\n"),!e)return null;$=ie(e,!0)}return $.shift()})(),put_char(e,t){null===t||10===t?(P(q(e.output)),e.output=[]):0!=t&&e.output.push(t)},fsync(e){e.output?.length>0&&(P(q(e.output)),e.output=[])},ioctl_tcgets:e=>({c_iflag:25856,c_oflag:5,c_cflag:191,c_lflag:35387,c_cc:[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}),ioctl_tcsets:(e,t,i)=>0,ioctl_tiocgwinsz:e=>[24,80]},default_tty1_ops:{put_char(e,t){null===t||10===t?(x(q(e.output)),e.output=[]):0!=t&&e.output.push(t)},fsync(e){e.output?.length>0&&(x(q(e.output)),e.output=[])}}},re=e=>{S()},oe={ops_table:null,mount:e=>oe.createNode(null,"/",16895,0),createNode(e,t,i,s){if(Ae.isBlkdev(i)||Ae.isFIFO(i))throw new Ae.ErrnoError(63);oe.ops_table||(oe.ops_table={dir:{node:{getattr:oe.node_ops.getattr,setattr:oe.node_ops.setattr,lookup:oe.node_ops.lookup,mknod:oe.node_ops.mknod,rename:oe.node_ops.rename,unlink:oe.node_ops.unlink,rmdir:oe.node_ops.rmdir,readdir:oe.node_ops.readdir,symlink:oe.node_ops.symlink},stream:{llseek:oe.stream_ops.llseek}},file:{node:{getattr:oe.node_ops.getattr,setattr:oe.node_ops.setattr},stream:{llseek:oe.stream_ops.llseek,read:oe.stream_ops.read,write:oe.stream_ops.write,mmap:oe.stream_ops.mmap,msync:oe.stream_ops.msync}},link:{node:{getattr:oe.node_ops.getattr,setattr:oe.node_ops.setattr,readlink:oe.node_ops.readlink},stream:{}},chrdev:{node:{getattr:oe.node_ops.getattr,setattr:oe.node_ops.setattr},stream:Ae.chrdev_stream_ops}});var r=Ae.createNode(e,t,i,s);return Ae.isDir(r.mode)?(r.node_ops=oe.ops_table.dir.node,r.stream_ops=oe.ops_table.dir.stream,r.contents={}):Ae.isFile(r.mode)?(r.node_ops=oe.ops_table.file.node,r.stream_ops=oe.ops_table.file.stream,r.usedBytes=0,r.contents=null):Ae.isLink(r.mode)?(r.node_ops=oe.ops_table.link.node,r.stream_ops=oe.ops_table.link.stream):Ae.isChrdev(r.mode)&&(r.node_ops=oe.ops_table.chrdev.node,r.stream_ops=oe.ops_table.chrdev.stream),r.atime=r.mtime=r.ctime=Date.now(),e&&(e.contents[t]=r,e.atime=e.mtime=e.ctime=r.atime),r},getFileDataAsTypedArray:e=>e.contents?e.contents.subarray?e.contents.subarray(0,e.usedBytes):new Uint8Array(e.contents):new Uint8Array(0),expandFileStorage(e,t){var i=e.contents?e.contents.length:0;if(!(i>=t)){t=Math.max(t,i*(i<1048576?2:1.125)>>>0),0!=i&&(t=Math.max(t,256));var s=e.contents;e.contents=new Uint8Array(t),e.usedBytes>0&&e.contents.set(s.subarray(0,e.usedBytes),0)}},resizeFileStorage(e,t){if(e.usedBytes!=t)if(0==t)e.contents=null,e.usedBytes=0;else{var i=e.contents;e.contents=new Uint8Array(t),i&&e.contents.set(i.subarray(0,Math.min(t,e.usedBytes))),e.usedBytes=t}},node_ops:{getattr(e){var t={};return t.dev=Ae.isChrdev(e.mode)?e.id:1,t.ino=e.id,t.mode=e.mode,t.nlink=1,t.uid=0,t.gid=0,t.rdev=e.rdev,Ae.isDir(e.mode)?t.size=4096:Ae.isFile(e.mode)?t.size=e.usedBytes:Ae.isLink(e.mode)?t.size=e.link.length:t.size=0,t.atime=new Date(e.atime),t.mtime=new Date(e.mtime),t.ctime=new Date(e.ctime),t.blksize=4096,t.blocks=Math.ceil(t.size/t.blksize),t},setattr(e,t){for(const i of["mode","atime","mtime","ctime"])null!=t[i]&&(e[i]=t[i]);void 0!==t.size&&oe.resizeFileStorage(e,t.size)},lookup(e,t){throw oe.doesNotExistError},mknod:(e,t,i,s)=>oe.createNode(e,t,i,s),rename(e,t,i){var s;try{s=Ae.lookupNode(t,i)}catch(e){}if(s){if(Ae.isDir(e.mode))for(var r in s.contents)throw new Ae.ErrnoError(55);Ae.hashRemoveNode(s)}delete e.parent.contents[e.name],t.contents[i]=e,e.name=i,t.ctime=t.mtime=e.parent.ctime=e.parent.mtime=Date.now()},unlink(e,t){delete e.contents[t],e.ctime=e.mtime=Date.now()},rmdir(e,t){var i=Ae.lookupNode(e,t);for(var s in i.contents)throw new Ae.ErrnoError(55);delete e.contents[t],e.ctime=e.mtime=Date.now()},readdir:e=>[".","..",...Object.keys(e.contents)],symlink(e,t,i){var s=oe.createNode(e,t,41471,0);return s.link=i,s},readlink(e){if(!Ae.isLink(e.mode))throw new Ae.ErrnoError(28);return e.link}},stream_ops:{read(e,t,i,s,r){var o=e.node.contents;if(r>=e.node.usedBytes)return 0;var n=Math.min(e.node.usedBytes-r,s);if(n>8&&o.subarray)t.set(o.subarray(r,r+n),i);else for(var a=0;a<n;a++)t[i+a]=o[r+a];return n},write(e,t,i,s,r,o){if(t.buffer===p.buffer&&(o=!1),!s)return 0;var n=e.node;if(n.mtime=n.ctime=Date.now(),t.subarray&&(!n.contents||n.contents.subarray)){if(o)return n.contents=t.subarray(i,i+s),n.usedBytes=s,s;if(0===n.usedBytes&&0===r)return n.contents=t.slice(i,i+s),n.usedBytes=s,s;if(r+s<=n.usedBytes)return n.contents.set(t.subarray(i,i+s),r),s}if(oe.expandFileStorage(n,r+s),n.contents.subarray&&t.subarray)n.contents.set(t.subarray(i,i+s),r);else for(var a=0;a<s;a++)n.contents[r+a]=t[i+a];return n.usedBytes=Math.max(n.usedBytes,r+s),s},llseek(e,t,i){var s=t;if(1===i?s+=e.position:2===i&&Ae.isFile(e.node.mode)&&(s+=e.node.usedBytes),s<0)throw new Ae.ErrnoError(28);return s},mmap(e,t,i,s,r){if(!Ae.isFile(e.node.mode))throw new Ae.ErrnoError(43);var o,n,a=e.node.contents;if(2&r||!a||a.buffer!==p.buffer){if(n=!0,!(o=re()))throw new Ae.ErrnoError(48);a&&((i>0||i+t<a.length)&&(a=a.subarray?a.subarray(i,i+t):Array.prototype.slice.call(a,i,i+t)),p.set(a,o))}else n=!1,o=a.byteOffset;return{ptr:o,allocated:n}},msync:(e,t,i,s,r)=>(oe.stream_ops.write(e,t,0,s,i,!1),0)}},ne=async e=>{var t=await s(e);return new Uint8Array(t)};ne.isAsync=!0;var ae=[],le=(e,t)=>{var i=0;return e&&(i|=365),t&&(i|=146),i},Ae={root:null,mounts:[],devices:{},streams:[],nextInode:1,nameTable:null,currentPath:"/",initialized:!1,ignorePermissions:!0,filesystems:null,syncFSRequests:0,readFiles:{},ErrnoError:class{constructor(e){jF(this,"name","ErrnoError"),this.errno=e}},FSStream:class{constructor(){jF(this,"shared",{})}get object(){return this.node}set object(e){this.node=e}get isRead(){return 1!=(2097155&this.flags)}get isWrite(){return 0!=(2097155&this.flags)}get isAppend(){return 1024&this.flags}get flags(){return this.shared.flags}set flags(e){this.shared.flags=e}get position(){return this.shared.position}set position(e){this.shared.position=e}},FSNode:class{constructor(e,t,i,s){jF(this,"node_ops",{}),jF(this,"stream_ops",{}),jF(this,"readMode",365),jF(this,"writeMode",146),jF(this,"mounted",null),e||(e=this),this.parent=e,this.mount=e.mount,this.id=Ae.nextInode++,this.name=t,this.mode=i,this.rdev=s,this.atime=this.mtime=this.ctime=Date.now()}get read(){return(this.mode&this.readMode)===this.readMode}set read(e){e?this.mode|=this.readMode:this.mode&=~this.readMode}get write(){return(this.mode&this.writeMode)===this.writeMode}set write(e){e?this.mode|=this.writeMode:this.mode&=~this.writeMode}get isFolder(){return Ae.isDir(this.mode)}get isDevice(){return Ae.isChrdev(this.mode)}},lookupPath(e,t={}){if(!e)throw new Ae.ErrnoError(44);t.follow_mount??(t.follow_mount=!0),K.isAbs(e)||(e=Ae.cwd()+"/"+e);e:for(var i=0;i<40;i++){for(var s=e.split("/").filter((e=>!!e)),r=Ae.root,o="/",n=0;n<s.length;n++){var a=n===s.length-1;if(a&&t.parent)break;if("."!==s[n])if(".."!==s[n]){o=K.join2(o,s[n]);try{r=Ae.lookupNode(r,s[n])}catch(e){if(44===e?.errno&&a&&t.noent_okay)return{path:o};throw e}if(!Ae.isMountpoint(r)||a&&!t.follow_mount||(r=r.mounted.root),Ae.isLink(r.mode)&&(!a||t.follow)){if(!r.node_ops.readlink)throw new Ae.ErrnoError(52);var l=r.node_ops.readlink(r);K.isAbs(l)||(l=K.dirname(o)+"/"+l),e=l+"/"+s.slice(n+1).join("/");continue e}}else{if(o=K.dirname(o),Ae.isRoot(r)){e=o+"/"+s.slice(n+1).join("/");continue e}r=r.parent}}return{path:o,node:r}}throw new Ae.ErrnoError(32)},getPath(e){for(var t;;){if(Ae.isRoot(e)){var i=e.mount.mountpoint;return t?"/"!==i[i.length-1]?`${i}/${t}`:i+t:i}t=t?`${e.name}/${t}`:e.name,e=e.parent}},hashName(e,t){for(var i=0,s=0;s<t.length;s++)i=(i<<5)-i+t.charCodeAt(s)|0;return(e+i>>>0)%Ae.nameTable.length},hashAddNode(e){var t=Ae.hashName(e.parent.id,e.name);e.name_next=Ae.nameTable[t],Ae.nameTable[t]=e},hashRemoveNode(e){var t=Ae.hashName(e.parent.id,e.name);if(Ae.nameTable[t]===e)Ae.nameTable[t]=e.name_next;else for(var i=Ae.nameTable[t];i;){if(i.name_next===e){i.name_next=e.name_next;break}i=i.name_next}},lookupNode(e,t){var i=Ae.mayLookup(e);if(i)throw new Ae.ErrnoError(i);for(var s=Ae.hashName(e.id,t),r=Ae.nameTable[s];r;r=r.name_next){var o=r.name;if(r.parent.id===e.id&&o===t)return r}return Ae.lookup(e,t)},createNode(e,t,i,s){var r=new Ae.FSNode(e,t,i,s);return Ae.hashAddNode(r),r},destroyNode(e){Ae.hashRemoveNode(e)},isRoot:e=>e===e.parent,isMountpoint:e=>!!e.mounted,isFile:e=>32768==(61440&e),isDir:e=>16384==(61440&e),isLink:e=>40960==(61440&e),isChrdev:e=>8192==(61440&e),isBlkdev:e=>24576==(61440&e),isFIFO:e=>4096==(61440&e),isSocket:e=>49152==(49152&e),flagsToPermissionString(e){var t=["r","w","rw"][3&e];return 512&e&&(t+="w"),t},nodePermissions:(e,t)=>Ae.ignorePermissions||(!t.includes("r")||292&e.mode)&&(!t.includes("w")||146&e.mode)&&(!t.includes("x")||73&e.mode)?0:2,mayLookup(e){if(!Ae.isDir(e.mode))return 54;var t=Ae.nodePermissions(e,"x");return t||(e.node_ops.lookup?0:2)},mayCreate(e,t){if(!Ae.isDir(e.mode))return 54;try{Ae.lookupNode(e,t);return 20}catch(e){}return Ae.nodePermissions(e,"wx")},mayDelete(e,t,i){var s;try{s=Ae.lookupNode(e,t)}catch(e){return e.errno}var r=Ae.nodePermissions(e,"wx");if(r)return r;if(i){if(!Ae.isDir(s.mode))return 54;if(Ae.isRoot(s)||Ae.getPath(s)===Ae.cwd())return 10}else if(Ae.isDir(s.mode))return 31;return 0},mayOpen:(e,t)=>e?Ae.isLink(e.mode)?32:Ae.isDir(e.mode)&&("r"!==Ae.flagsToPermissionString(t)||576&t)?31:Ae.nodePermissions(e,Ae.flagsToPermissionString(t)):44,checkOpExists(e,t){if(!e)throw new Ae.ErrnoError(t);return e},MAX_OPEN_FDS:4096,nextfd(){for(var e=0;e<=Ae.MAX_OPEN_FDS;e++)if(!Ae.streams[e])return e;throw new Ae.ErrnoError(33)},getStreamChecked(e){var t=Ae.getStream(e);if(!t)throw new Ae.ErrnoError(8);return t},getStream:e=>Ae.streams[e],createStream:(e,t=-1)=>(e=Object.assign(new Ae.FSStream,e),-1==t&&(t=Ae.nextfd()),e.fd=t,Ae.streams[t]=e,e),closeStream(e){Ae.streams[e]=null},dupStream(e,t=-1){var i=Ae.createStream(e,t);return i.stream_ops?.dup?.(i),i},doSetAttr(e,t,i){var s=e?.stream_ops.setattr,r=s?e:t;s??(s=t.node_ops.setattr),Ae.checkOpExists(s,63),s(r,i)},chrdev_stream_ops:{open(e){var t=Ae.getDevice(e.node.rdev);e.stream_ops=t.stream_ops,e.stream_ops.open?.(e)},llseek(){throw new Ae.ErrnoError(70)}},major:e=>e>>8,minor:e=>255&e,makedev:(e,t)=>e<<8|t,registerDevice(e,t){Ae.devices[e]={stream_ops:t}},getDevice:e=>Ae.devices[e],getMounts(e){for(var t=[],i=[e];i.length;){var s=i.pop();t.push(s),i.push(...s.mounts)}return t},syncfs(e,t){"function"==typeof e&&(t=e,e=!1),Ae.syncFSRequests++,Ae.syncFSRequests>1&&x(`warning: ${Ae.syncFSRequests} FS.syncfs operations in flight at once, probably just doing extra work`);var i=Ae.getMounts(Ae.root.mount),s=0;function r(e){return Ae.syncFSRequests--,t(e)}function o(e){if(e)return o.errored?void 0:(o.errored=!0,r(e));++s>=i.length&&r(null)}i.forEach((t=>{if(!t.type.syncfs)return o(null);t.type.syncfs(t,e,o)}))},mount(e,t,i){var s,r="/"===i,o=!i;if(r&&Ae.root)throw new Ae.ErrnoError(10);if(!r&&!o){var n=Ae.lookupPath(i,{follow_mount:!1});if(i=n.path,s=n.node,Ae.isMountpoint(s))throw new Ae.ErrnoError(10);if(!Ae.isDir(s.mode))throw new Ae.ErrnoError(54)}var a={type:e,opts:t,mountpoint:i,mounts:[]},l=e.mount(a);return l.mount=a,a.root=l,r?Ae.root=l:s&&(s.mounted=a,s.mount&&s.mount.mounts.push(a)),l},unmount(e){var t=Ae.lookupPath(e,{follow_mount:!1});if(!Ae.isMountpoint(t.node))throw new Ae.ErrnoError(28);var i=t.node,s=i.mounted,r=Ae.getMounts(s);Object.keys(Ae.nameTable).forEach((e=>{for(var t=Ae.nameTable[e];t;){var i=t.name_next;r.includes(t.mount)&&Ae.destroyNode(t),t=i}})),i.mounted=null;var o=i.mount.mounts.indexOf(s);i.mount.mounts.splice(o,1)},lookup:(e,t)=>e.node_ops.lookup(e,t),mknod(e,t,i){var s=Ae.lookupPath(e,{parent:!0}).node,r=K.basename(e);if(!r)throw new Ae.ErrnoError(28);if("."===r||".."===r)throw new Ae.ErrnoError(20);var o=Ae.mayCreate(s,r);if(o)throw new Ae.ErrnoError(o);if(!s.node_ops.mknod)throw new Ae.ErrnoError(63);return s.node_ops.mknod(s,r,t,i)},statfs:e=>Ae.statfsNode(Ae.lookupPath(e,{follow:!0}).node),statfsStream:e=>Ae.statfsNode(e.node),statfsNode(e){var t={bsize:4096,frsize:4096,blocks:1e6,bfree:5e5,bavail:5e5,files:Ae.nextInode,ffree:Ae.nextInode-1,fsid:42,flags:2,namelen:255};return e.node_ops.statfs&&Object.assign(t,e.node_ops.statfs(e.mount.opts.root)),t},create:(e,t=438)=>(t&=4095,t|=32768,Ae.mknod(e,t,0)),mkdir:(e,t=511)=>(t&=1023,t|=16384,Ae.mknod(e,t,0)),mkdirTree(e,t){var i=e.split("/"),s="";for(var r of i)if(r){(s||K.isAbs(e))&&(s+="/"),s+=r;try{Ae.mkdir(s,t)}catch(e){if(20!=e.errno)throw e}}},mkdev:(e,t,i)=>(void 0===i&&(i=t,t=438),t|=8192,Ae.mknod(e,t,i)),symlink(e,t){if(!J.resolve(e))throw new Ae.ErrnoError(44);var i=Ae.lookupPath(t,{parent:!0}).node;if(!i)throw new Ae.ErrnoError(44);var s=K.basename(t),r=Ae.mayCreate(i,s);if(r)throw new Ae.ErrnoError(r);if(!i.node_ops.symlink)throw new Ae.ErrnoError(63);return i.node_ops.symlink(i,s,e)},rename(e,t){var i,s,r=K.dirname(e),o=K.dirname(t),n=K.basename(e),a=K.basename(t);if(i=Ae.lookupPath(e,{parent:!0}).node,s=Ae.lookupPath(t,{parent:!0}).node,!i||!s)throw new Ae.ErrnoError(44);if(i.mount!==s.mount)throw new Ae.ErrnoError(75);var l,A=Ae.lookupNode(i,n),c=J.relative(e,o);if("."!==c.charAt(0))throw new Ae.ErrnoError(28);if("."!==(c=J.relative(t,r)).charAt(0))throw new Ae.ErrnoError(55);try{l=Ae.lookupNode(s,a)}catch(e){}if(A!==l){var h=Ae.isDir(A.mode),u=Ae.mayDelete(i,n,h);if(u)throw new Ae.ErrnoError(u);if(u=l?Ae.mayDelete(s,a,h):Ae.mayCreate(s,a))throw new Ae.ErrnoError(u);if(!i.node_ops.rename)throw new Ae.ErrnoError(63);if(Ae.isMountpoint(A)||l&&Ae.isMountpoint(l))throw new Ae.ErrnoError(10);if(s!==i&&(u=Ae.nodePermissions(i,"w")))throw new Ae.ErrnoError(u);Ae.hashRemoveNode(A);try{i.node_ops.rename(A,s,a),A.parent=s}catch(e){throw e}finally{Ae.hashAddNode(A)}}},rmdir(e){var t=Ae.lookupPath(e,{parent:!0}).node,i=K.basename(e),s=Ae.lookupNode(t,i),r=Ae.mayDelete(t,i,!0);if(r)throw new Ae.ErrnoError(r);if(!t.node_ops.rmdir)throw new Ae.ErrnoError(63);if(Ae.isMountpoint(s))throw new Ae.ErrnoError(10);t.node_ops.rmdir(t,i),Ae.destroyNode(s)},readdir(e){var t=Ae.lookupPath(e,{follow:!0}).node;return Ae.checkOpExists(t.node_ops.readdir,54)(t)},unlink(e){var t=Ae.lookupPath(e,{parent:!0}).node;if(!t)throw new Ae.ErrnoError(44);var i=K.basename(e),s=Ae.lookupNode(t,i),r=Ae.mayDelete(t,i,!1);if(r)throw new Ae.ErrnoError(r);if(!t.node_ops.unlink)throw new Ae.ErrnoError(63);if(Ae.isMountpoint(s))throw new Ae.ErrnoError(10);t.node_ops.unlink(t,i),Ae.destroyNode(s)},readlink(e){var t=Ae.lookupPath(e).node;if(!t)throw new Ae.ErrnoError(44);if(!t.node_ops.readlink)throw new Ae.ErrnoError(28);return t.node_ops.readlink(t)},stat(e,t){var i=Ae.lookupPath(e,{follow:!t}).node;return Ae.checkOpExists(i.node_ops.getattr,63)(i)},fstat(e){var t=Ae.getStreamChecked(e),i=t.node,s=t.stream_ops.getattr,r=s?t:i;return s??(s=i.node_ops.getattr),Ae.checkOpExists(s,63),s(r)},lstat:e=>Ae.stat(e,!0),doChmod(e,t,i,s){Ae.doSetAttr(e,t,{mode:4095&i|-4096&t.mode,ctime:Date.now(),dontFollow:s})},chmod(e,t,i){var s;"string"==typeof e?s=Ae.lookupPath(e,{follow:!i}).node:s=e;Ae.doChmod(null,s,t,i)},lchmod(e,t){Ae.chmod(e,t,!0)},fchmod(e,t){var i=Ae.getStreamChecked(e);Ae.doChmod(i,i.node,t,!1)},doChown(e,t,i){Ae.doSetAttr(e,t,{timestamp:Date.now(),dontFollow:i})},chown(e,t,i,s){var r;"string"==typeof e?r=Ae.lookupPath(e,{follow:!s}).node:r=e;Ae.doChown(null,r,s)},lchown(e,t,i){Ae.chown(e,t,i,!0)},fchown(e,t,i){var s=Ae.getStreamChecked(e);Ae.doChown(s,s.node,!1)},doTruncate(e,t,i){if(Ae.isDir(t.mode))throw new Ae.ErrnoError(31);if(!Ae.isFile(t.mode))throw new Ae.ErrnoError(28);var s=Ae.nodePermissions(t,"w");if(s)throw new Ae.ErrnoError(s);Ae.doSetAttr(e,t,{size:i,timestamp:Date.now()})},truncate(e,t){if(t<0)throw new Ae.ErrnoError(28);var i;"string"==typeof e?i=Ae.lookupPath(e,{follow:!0}).node:i=e;Ae.doTruncate(null,i,t)},ftruncate(e,t){var i=Ae.getStreamChecked(e);if(t<0||0==(2097155&i.flags))throw new Ae.ErrnoError(28);Ae.doTruncate(i,i.node,t)},utime(e,t,i){var s=Ae.lookupPath(e,{follow:!0}).node;Ae.checkOpExists(s.node_ops.setattr,63)(s,{atime:t,mtime:i})},open(e,t,i=438){if(""===e)throw new Ae.ErrnoError(44);var s,o;if(i=64&(t="string"==typeof t?(e=>{var t={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090}[e];if(void 0===t)throw new Error(`Unknown file open mode: ${e}`);return t})(t):t)?4095&i|32768:0,"object"==typeof e)s=e;else{o=e.endsWith("/");var n=Ae.lookupPath(e,{follow:!(131072&t),noent_okay:!0});s=n.node,e=n.path}var a=!1;if(64&t)if(s){if(128&t)throw new Ae.ErrnoError(20)}else{if(o)throw new Ae.ErrnoError(31);s=Ae.mknod(e,511|i,0),a=!0}if(!s)throw new Ae.ErrnoError(44);if(Ae.isChrdev(s.mode)&&(t&=-513),65536&t&&!Ae.isDir(s.mode))throw new Ae.ErrnoError(54);if(!a){var l=Ae.mayOpen(s,t);if(l)throw new Ae.ErrnoError(l)}512&t&&!a&&Ae.truncate(s,0),t&=-131713;var A=Ae.createStream({node:s,path:Ae.getPath(s),flags:t,seekable:!0,position:0,stream_ops:s.stream_ops,ungotten:[],error:!1});return A.stream_ops.open&&A.stream_ops.open(A),a&&Ae.chmod(s,511&i),!r.logReadFiles||1&t||e in Ae.readFiles||(Ae.readFiles[e]=1),A},close(e){if(Ae.isClosed(e))throw new Ae.ErrnoError(8);e.getdents&&(e.getdents=null);try{e.stream_ops.close&&e.stream_ops.close(e)}catch(e){throw e}finally{Ae.closeStream(e.fd)}e.fd=null},isClosed:e=>null===e.fd,llseek(e,t,i){if(Ae.isClosed(e))throw new Ae.ErrnoError(8);if(!e.seekable||!e.stream_ops.llseek)throw new Ae.ErrnoError(70);if(0!=i&&1!=i&&2!=i)throw new Ae.ErrnoError(28);return e.position=e.stream_ops.llseek(e,t,i),e.ungotten=[],e.position},read(e,t,i,s,r){if(s<0||r<0)throw new Ae.ErrnoError(28);if(Ae.isClosed(e))throw new Ae.ErrnoError(8);if(1==(2097155&e.flags))throw new Ae.ErrnoError(8);if(Ae.isDir(e.node.mode))throw new Ae.ErrnoError(31);if(!e.stream_ops.read)throw new Ae.ErrnoError(28);var o=void 0!==r;if(o){if(!e.seekable)throw new Ae.ErrnoError(70)}else r=e.position;var n=e.stream_ops.read(e,t,i,s,r);return o||(e.position+=n),n},write(e,t,i,s,r,o){if(s<0||r<0)throw new Ae.ErrnoError(28);if(Ae.isClosed(e))throw new Ae.ErrnoError(8);if(0==(2097155&e.flags))throw new Ae.ErrnoError(8);if(Ae.isDir(e.node.mode))throw new Ae.ErrnoError(31);if(!e.stream_ops.write)throw new Ae.ErrnoError(28);e.seekable&&1024&e.flags&&Ae.llseek(e,0,2);var n=void 0!==r;if(n){if(!e.seekable)throw new Ae.ErrnoError(70)}else r=e.position;var a=e.stream_ops.write(e,t,i,s,r,o);return n||(e.position+=a),a},mmap(e,t,i,s,r){if(0!=(2&s)&&0==(2&r)&&2!=(2097155&e.flags))throw new Ae.ErrnoError(2);if(1==(2097155&e.flags))throw new Ae.ErrnoError(2);if(!e.stream_ops.mmap)throw new Ae.ErrnoError(43);if(!t)throw new Ae.ErrnoError(28);return e.stream_ops.mmap(e,t,i,s,r)},msync:(e,t,i,s,r)=>e.stream_ops.msync?e.stream_ops.msync(e,t,i,s,r):0,ioctl(e,t,i){if(!e.stream_ops.ioctl)throw new Ae.ErrnoError(59);return e.stream_ops.ioctl(e,t,i)},readFile(e,t={}){if(t.flags=t.flags||0,t.encoding=t.encoding||"binary","utf8"!==t.encoding&&"binary"!==t.encoding)throw new Error(`Invalid encoding type "${t.encoding}"`);var i,s=Ae.open(e,t.flags),r=Ae.stat(e).size,o=new Uint8Array(r);return Ae.read(s,o,0,r,0),"utf8"===t.encoding?i=q(o):"binary"===t.encoding&&(i=o),Ae.close(s),i},writeFile(e,t,i={}){i.flags=i.flags||577;var s=Ae.open(e,i.flags,i.mode);if("string"==typeof t){var r=new Uint8Array(ee(t)+1),o=te(t,r,0,r.length);Ae.write(s,r,0,o,void 0,i.canOwn)}else{if(!ArrayBuffer.isView(t))throw new Error("Unsupported data type");Ae.write(s,t,0,t.byteLength,void 0,i.canOwn)}Ae.close(s)},cwd:()=>Ae.currentPath,chdir(e){var t=Ae.lookupPath(e,{follow:!0});if(null===t.node)throw new Ae.ErrnoError(44);if(!Ae.isDir(t.node.mode))throw new Ae.ErrnoError(54);var i=Ae.nodePermissions(t.node,"x");if(i)throw new Ae.ErrnoError(i);Ae.currentPath=t.path},createDefaultDirectories(){Ae.mkdir("/tmp"),Ae.mkdir("/home"),Ae.mkdir("/home/web_user")},createDefaultDevices(){Ae.mkdir("/dev"),Ae.registerDevice(Ae.makedev(1,3),{read:()=>0,write:(e,t,i,s,r)=>s,llseek:()=>0}),Ae.mkdev("/dev/null",Ae.makedev(1,3)),se.register(Ae.makedev(5,0),se.default_tty_ops),se.register(Ae.makedev(6,0),se.default_tty1_ops),Ae.mkdev("/dev/tty",Ae.makedev(5,0)),Ae.mkdev("/dev/tty1",Ae.makedev(6,0));var e=new Uint8Array(1024),t=0,i=()=>(0===t&&(Z(e),t=e.byteLength),e[--t]);Ae.createDevice("/dev","random",i),Ae.createDevice("/dev","urandom",i),Ae.mkdir("/dev/shm"),Ae.mkdir("/dev/shm/tmp")},createSpecialDirectories(){Ae.mkdir("/proc");var e=Ae.mkdir("/proc/self");Ae.mkdir("/proc/self/fd"),Ae.mount({mount(){var t=Ae.createNode(e,"fd",16895,73);return t.stream_ops={llseek:oe.stream_ops.llseek},t.node_ops={lookup(e,t){var i=+t,s=Ae.getStreamChecked(i),r={parent:null,mount:{mountpoint:"fake"},node_ops:{readlink:()=>s.path},id:i+1};return r.parent=r,r},readdir:()=>Array.from(Ae.streams.entries()).filter((([e,t])=>t)).map((([e,t])=>e.toString()))},t}},{},"/proc/self/fd")},createStandardStreams(e,t,i){e?Ae.createDevice("/dev","stdin",e):Ae.symlink("/dev/tty","/dev/stdin"),t?Ae.createDevice("/dev","stdout",null,t):Ae.symlink("/dev/tty","/dev/stdout"),i?Ae.createDevice("/dev","stderr",null,i):Ae.symlink("/dev/tty1","/dev/stderr"),Ae.open("/dev/stdin",0),Ae.open("/dev/stdout",1),Ae.open("/dev/stderr",1)},staticInit(){Ae.nameTable=new Array(4096),Ae.mount(oe,{},"/"),Ae.createDefaultDirectories(),Ae.createDefaultDevices(),Ae.createSpecialDirectories(),Ae.filesystems={MEMFS:oe}},init(e,t,i){Ae.initialized=!0,e??(e=r.stdin),t??(t=r.stdout),i??(i=r.stderr),Ae.createStandardStreams(e,t,i)},quit(){for(var e of(Ae.initialized=!1,Ae.streams))e&&Ae.close(e)},findObject(e,t){var i=Ae.analyzePath(e,t);return i.exists?i.object:null},analyzePath(e,t){try{e=(s=Ae.lookupPath(e,{follow:!t})).path}catch(e){}var i={isRoot:!1,exists:!1,error:0,name:null,path:null,object:null,parentExists:!1,parentPath:null,parentObject:null};try{var s=Ae.lookupPath(e,{parent:!0});i.parentExists=!0,i.parentPath=s.path,i.parentObject=s.node,i.name=K.basename(e),s=Ae.lookupPath(e,{follow:!t}),i.exists=!0,i.path=s.path,i.object=s.node,i.name=s.node.name,i.isRoot="/"===s.path}catch(e){i.error=e.errno}return i},createPath(e,t,i,s){e="string"==typeof e?e:Ae.getPath(e);for(var r=t.split("/").reverse();r.length;){var o=r.pop();if(o){var n=K.join2(e,o);try{Ae.mkdir(n)}catch(e){if(20!=e.errno)throw e}e=n}}return n},createFile(e,t,i,s,r){var o=K.join2("string"==typeof e?e:Ae.getPath(e),t),n=le(s,r);return Ae.create(o,n)},createDataFile(e,t,i,s,r,o){var n=t;e&&(e="string"==typeof e?e:Ae.getPath(e),n=t?K.join2(e,t):e);var a=le(s,r),l=Ae.create(n,a);if(i){if("string"==typeof i){for(var A=new Array(i.length),c=0,h=i.length;c<h;++c)A[c]=i.charCodeAt(c);i=A}Ae.chmod(l,146|a);var u=Ae.open(l,577);Ae.write(u,i,0,i.length,0,o),Ae.close(u),Ae.chmod(l,a)}},createDevice(e,t,i,s){var r,o=K.join2("string"==typeof e?e:Ae.getPath(e),t),n=le(!!i,!!s);(r=Ae.createDevice).major??(r.major=64);var a=Ae.makedev(Ae.createDevice.major++,0);return Ae.registerDevice(a,{open(e){e.seekable=!1},close(e){s?.buffer?.length&&s(10)},read(e,t,s,r,o){for(var n=0,a=0;a<r;a++){var l;try{l=i()}catch(e){throw new Ae.ErrnoError(29)}if(void 0===l&&0===n)throw new Ae.ErrnoError(6);if(null==l)break;n++,t[s+a]=l}return n&&(e.node.atime=Date.now()),n},write(e,t,i,r,o){for(var n=0;n<r;n++)try{s(t[i+n])}catch(e){throw new Ae.ErrnoError(29)}return r&&(e.node.mtime=e.node.ctime=Date.now()),n}}),Ae.mkdev(o,n,a)},forceLoadFile(e){if(e.isDevice||e.isFolder||e.link||e.contents)return!0;if("undefined"!=typeof XMLHttpRequest)throw new Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.");try{e.contents=undefined(e.url),e.usedBytes=e.contents.length}catch(e){throw new Ae.ErrnoError(29)}},createLazyFile(e,t,i,s,r){if("undefined"!=typeof XMLHttpRequest)throw"Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc";var o={isDevice:!1,url:i},n=Ae.createFile(e,t,o,s,r);o.contents?n.contents=o.contents:o.url&&(n.contents=null,n.url=o.url),Object.defineProperties(n,{usedBytes:{get:function(){return this.contents.length}}});var a={};function l(e,t,i,s,r){var o=e.node.contents;if(r>=o.length)return 0;var n=Math.min(o.length-r,s);if(o.slice)for(var a=0;a<n;a++)t[i+a]=o[r+a];else for(a=0;a<n;a++)t[i+a]=o.get(r+a);return n}return Object.keys(n.stream_ops).forEach((e=>{var t=n.stream_ops[e];a[e]=(...e)=>(Ae.forceLoadFile(n),t(...e))})),a.read=(e,t,i,s,r)=>(Ae.forceLoadFile(n),l(e,t,i,s,r)),a.mmap=(e,t,i,s,r)=>{Ae.forceLoadFile(n);var o=re();if(!o)throw new Ae.ErrnoError(48);return l(e,p,o,t,i),{ptr:o,allocated:!0}},n.stream_ops=a,n}},ce=(e,t)=>e?q(f,e,t):"",he={DEFAULT_POLLMASK:5,calculateAt(e,t,i){if(K.isAbs(t))return t;var s;-100===e?s=Ae.cwd():s=he.getStreamFromFD(e).path;if(0==t.length){if(!i)throw new Ae.ErrnoError(44);return s}return s+"/"+t},writeStat(e,t){_[e>>2]=t.dev,_[e+4>>2]=t.mode,v[e+8>>2]=t.nlink,_[e+12>>2]=t.uid,_[e+16>>2]=t.gid,_[e+20>>2]=t.rdev,y[e+24>>3]=BigInt(t.size),_[e+32>>2]=4096,_[e+36>>2]=t.blocks;var i=t.atime.getTime(),s=t.mtime.getTime(),r=t.ctime.getTime();return y[e+40>>3]=BigInt(Math.floor(i/1e3)),v[e+48>>2]=i%1e3*1e3*1e3,y[e+56>>3]=BigInt(Math.floor(s/1e3)),v[e+64>>2]=s%1e3*1e3*1e3,y[e+72>>3]=BigInt(Math.floor(r/1e3)),v[e+80>>2]=r%1e3*1e3*1e3,y[e+88>>3]=BigInt(t.ino),0},writeStatFs(e,t){_[e+4>>2]=t.bsize,_[e+40>>2]=t.bsize,_[e+8>>2]=t.blocks,_[e+12>>2]=t.bfree,_[e+16>>2]=t.bavail,_[e+20>>2]=t.files,_[e+24>>2]=t.ffree,_[e+28>>2]=t.fsid,_[e+44>>2]=t.flags,_[e+36>>2]=t.namelen},doMsync(e,t,i,s,r){if(!Ae.isFile(t.node.mode))throw new Ae.ErrnoError(43);if(2&s)return 0;var o=f.slice(e,e+i);Ae.msync(t,o,r,i,s)},getStreamFromFD:e=>Ae.getStreamChecked(e),varargs:void 0,getStr:e=>ce(e)};var ue={},de=e=>{for(;e.length;){var t=e.pop();e.pop()(t)}};function pe(e){return this.fromWireType(v[e>>2])}var fe,me={},ge={},_e={},ve=class extends Error{constructor(e){super(e),this.name="InternalError"}},be=e=>{throw new ve(e)},ye=(e,t,i)=>{function s(t){var s=i(t);s.length!==e.length&&be("Mismatched type converter count");for(var r=0;r<e.length;++r)xe(e[r],s[r])}e.forEach((e=>_e[e]=t));var r=new Array(t.length),o=[],n=0;t.forEach(((e,t)=>{ge.hasOwnProperty(e)?r[t]=ge[e]:(o.push(e),me.hasOwnProperty(e)||(me[e]=[]),me[e].push((()=>{r[t]=ge[e],++n===o.length&&s(r)})))})),0===o.length&&s(r)},we=e=>{for(var t="",i=e;f[i];)t+=fe[f[i++]];return t},Be=class extends Error{constructor(e){super(e),this.name="BindingError"}},Pe=e=>{throw new Be(e)};function xe(e,t,i={}){return function(e,t,i={}){var s=t.name;if(e||Pe(`type "${s}" must have a positive integer typeid pointer`),ge.hasOwnProperty(e)){if(i.ignoreDuplicateRegistrations)return;Pe(`Cannot register type '${s}' twice`)}if(ge[e]=t,delete _e[e],me.hasOwnProperty(e)){var r=me[e];delete me[e],r.forEach((e=>e()))}}(e,t,i)}var Ce=(e,t,i)=>{switch(t){case 1:return i?e=>p[e]:e=>f[e];case 2:return i?e=>m[e>>1]:e=>g[e>>1];case 4:return i?e=>_[e>>2]:e=>v[e>>2];case 8:return i?e=>y[e>>3]:e=>w[e>>3];default:throw new TypeError(`invalid integer width (${t}): ${e}`)}},Me=8,Ee=[],Fe=[0,1,,1,null,1,!0,1,!1,1],Ie=e=>{e>9&&0==--Fe[e+1]&&(Fe[e]=void 0,Ee.push(e))},Te=e=>(e||Pe(`Cannot use deleted val. handle = ${e}`),Fe[e]),De=e=>{switch(e){case void 0:return 2;case null:return 4;case!0:return 6;case!1:return 8;default:{const t=Ee.pop()||Fe.length;return Fe[t]=e,Fe[t+1]=1,t}}},Se={name:"emscripten::val",fromWireType:e=>{var t=Te(e);return Ie(e),t},toWireType:(e,t)=>De(t),argPackAdvance:Me,readValueFromPointer:pe,destructorFunction:null},Re=(e,t)=>{switch(t){case 4:return function(e){return this.fromWireType(b[e>>2])};case 8:return function(e){return this.fromWireType(B[e>>3])};default:throw new TypeError(`invalid float width (${t}): ${e}`)}},Ue=(e,t)=>Object.defineProperty(t,"name",{value:e});function Le(e){for(var t=1;t<e.length;++t)if(null!==e[t]&&void 0===e[t].destructorFunction)return!0;return!1}var ke=e=>{try{return e()}catch(e){S(e)}},Oe=e=>{if(e instanceof k||"unwind"==e)return d;l(0,e)},Ne=()=>G||!1,Ve=(e,t)=>{var i;d=e,d=i=e,Ne()||(r.onExit?.(i),C=!0),l(0,new k(i))},Qe=Ve,He=e=>{if(!C)try{e(),(()=>{if(!Ne())try{Qe(d)}catch(e){Oe(e)}})()}catch(e){Oe(e)}},je={instrumentWasmImports(e){var t=/^(invoke_.*|__asyncjs__.*)$/;for(let[i,s]of Object.entries(e))"function"==typeof s&&(s.isAsync||t.test(i))},instrumentWasmExports(e){var t={};for(let[i,s]of Object.entries(e))t[i]="function"==typeof s?(...e)=>{je.exportCallStack.push(i);try{return s(...e)}finally{C||(je.exportCallStack.pop(),je.maybeStopUnwind())}}:s;return t},State:{Normal:0,Unwinding:1,Rewinding:2,Disabled:3},state:0,StackSize:4096,currData:null,handleSleepReturnValue:0,exportCallStack:[],callStackNameToId:{},callStackIdToName:{},callStackId:0,asyncPromiseHandlers:null,sleepCallbacks:[],getCallStackId(e){var t=je.callStackNameToId[e];return void 0===t&&(t=je.callStackId++,je.callStackNameToId[e]=t,je.callStackIdToName[t]=e),t},maybeStopUnwind(){je.currData&&je.state===je.State.Unwinding&&0===je.exportCallStack.length&&(je.state=je.State.Normal,ke(Et),"undefined"!=typeof Fibers&&Fibers.trampoline())},whenDone:()=>new Promise(((e,t)=>{je.asyncPromiseHandlers={resolve:e,reject:t}})),allocateData(){var e=Bt(12+je.StackSize);return je.setDataHeader(e,e+12,je.StackSize),je.setDataRewindFunc(e),e},setDataHeader(e,t,i){v[e>>2]=t,v[e+4>>2]=t+i},setDataRewindFunc(e){var t=je.exportCallStack[0],i=je.getCallStackId(t);_[e+8>>2]=i},getDataRewindFuncName(e){var t=_[e+8>>2];return je.callStackIdToName[t]},getDataRewindFunc:e=>yt[e],doRewind(e){var t=je.getDataRewindFuncName(e);return je.getDataRewindFunc(t)()},handleSleep(e){if(!C){if(je.state===je.State.Normal){var t=!1,i=!1;e(((e=0)=>{if(!C&&(je.handleSleepReturnValue=e,t=!0,i)){je.state=je.State.Rewinding,ke((()=>Ft(je.currData))),"undefined"!=typeof MainLoop&&MainLoop.func&&MainLoop.resume();var s,r=!1;try{s=je.doRewind(je.currData)}catch(e){s=e,r=!0}var o=!1;if(!je.currData){var n=je.asyncPromiseHandlers;n&&(je.asyncPromiseHandlers=null,(r?n.reject:n.resolve)(s),o=!0)}if(r&&!o)throw s}})),i=!0,t||(je.state=je.State.Unwinding,je.currData=je.allocateData(),"undefined"!=typeof MainLoop&&MainLoop.func&&MainLoop.pause(),ke((()=>Mt(je.currData))))}else je.state===je.State.Rewinding?(je.state=je.State.Normal,ke(It),Pt(je.currData),je.currData=null,je.sleepCallbacks.forEach(He)):S(`invalid state: ${je.state}`);return je.handleSleepReturnValue}},handleAsync:e=>je.handleSleep((t=>{e().then(t)}))};function Ge(e,t,i,s,r,o){var n=t.length;n<2&&Pe("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var a=null!==t[1]&&null!==i,l=Le(t),A="void"!==t[0].name,c=[e,Pe,s,r,de,t[0],t[1]],h=0;h<n-2;++h)c.push(t[h+2]);if(c.push(je),!l)for(h=a?1:2;h<t.length;++h)null!==t[h].destructorFunction&&c.push(t[h].destructorFunction);let[u,d]=function(e,t,i,s){var r=Le(e),o=e.length-2,n=[],a=["fn"];t&&a.push("thisWired");for(var l=0;l<o;++l)n.push(`arg${l}`),a.push(`arg${l}Wired`);n=n.join(","),a=a.join(",");var A=`return function (${n}) {\n`;r&&(A+="var destructors = [];\n");var c=r?"destructors":"null",h=["humanName","throwBindingError","invoker","fn","runDestructors","retType","classParam"];for(t&&(A+=`var thisWired = classParam['toWireType'](${c}, this);\n`),l=0;l<o;++l)A+=`var arg${l}Wired = argType${l}['toWireType'](${c}, arg${l});\n`,h.push(`argType${l}`);A+=(i||s?"var rv = ":"")+`invoker(${a});\n`;var u=i?"rv":"";if(h.push("Asyncify"),A+=`function onDone(${u}) {\n`,r)A+="runDestructors(destructors);\n";else for(l=t?1:2;l<e.length;++l){var d=1===l?"thisWired":"arg"+(l-2)+"Wired";null!==e[l].destructorFunction&&(A+=`${d}_dtor(${d});\n`,h.push(`${d}_dtor`))}return i&&(A+="var ret = retType['fromWireType'](rv);\nreturn ret;\n"),A+="}\n",A+=`return Asyncify.currData ? Asyncify.whenDone().then(onDone) : onDone(${u});\n`,[h,A+="}\n"]}(t,a,A,o);var p=new Function(...u,d)(...c);return Ue(e,p)}var ze=(e,t,i)=>{if(void 0===e[t].overloadTable){var s=e[t];e[t]=function(...s){return e[t].overloadTable.hasOwnProperty(s.length)||Pe(`Function '${i}' called with an invalid number of arguments (${s.length}) - expects one of (${e[t].overloadTable})!`),e[t].overloadTable[s.length].apply(this,s)},e[t].overloadTable=[],e[t].overloadTable[s.argCount]=s}},We=(e,t,i=!1)=>{var s=((e,t,i=!1)=>(...s)=>j(e,t,s,i))(e=we(e),t);return"function"!=typeof s&&Pe(`unknown function pointer with signature ${e}: ${t}`),s};class Xe extends Error{}var Ke=e=>{var t=wt(e),i=we(t);return Pt(t),i},Ze=(e,t,i)=>te(e,f,t,i),Je="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0,Ye=(e,t)=>{for(var i=e>>1,s=i+t/2,r=i;!(r>=s)&&g[r];)++r;if(r-i>16&&Je)return Je.decode(g.subarray(i,r));for(var o="",n=i;!(n>=s);++n){var a=g[n];if(0==a)break;o+=String.fromCharCode(a)}return o},qe=(e,t,i)=>{if(i??(i=2147483647),i<2)return 0;for(var s=t,r=(i-=2)<2*e.length?i/2:e.length,o=0;o<r;++o){var n=e.charCodeAt(o);m[t>>1]=n,t+=2}return m[t>>1]=0,t-s},$e=e=>2*e.length,et=(e,t)=>{for(var i=0,s="";!(i>=t/4);){var r=_[e+4*i>>2];if(0==r)break;if(++i,r>=65536){var o=r-65536;s+=String.fromCharCode(55296|o>>10,56320|1023&o)}else s+=String.fromCharCode(r)}return s},tt=(e,t,i)=>{if(i??(i=2147483647),i<4)return 0;for(var s=t,r=s+i-4,o=0;o<e.length;++o){var n=e.charCodeAt(o);if(n>=55296&&n<=57343)n=65536+((1023&n)<<10)|1023&e.charCodeAt(++o);if(_[t>>2]=n,(t+=4)+4>r)break}return _[t>>2]=0,t-s},it=e=>{for(var t=0,i=0;i<e.length;++i){var s=e.charCodeAt(i);s>=55296&&s<=57343&&++i,t+=4}return t},st=(e,t)=>{var i=ge[e];return void 0===i&&Pe(`${t} has unknown type ${Ke(e)}`),i},rt=(e,t,i)=>{var s=[],r=e.toWireType(s,i);return s.length&&(v[t>>2]=De(s)),r},ot=[],nt={},at=()=>"object"==typeof globalThis?globalThis:function(){return Function}()("return this")(),lt=e=>e<-9007199254740992||e>9007199254740992?NaN:Number(e);var At=[0,31,60,91,121,152,182,213,244,274,305,335],ct=[0,31,59,90,120,151,181,212,243,273,304,334];var ht=()=>Date.now();var ut=[],dt=(e,t,i)=>{var s=((e,t)=>{var i;for(ut.length=0;i=f[e++];){var s=105!=i;t+=(s&=112!=i)&&t%8?4:0,ut.push(112==i?v[t>>2]:106==i?y[t>>3]:105==i?_[t>>2]:B[t>>3]),t+=s?8:4}return ut})(t,i);return vt[e](...s)},pt=e=>{var t=(e-u.buffer.byteLength+65535)/65536|0;try{return u.grow(t),M(),1}catch(e){}},ft=e=>je.handleSleep((t=>((e,t)=>setTimeout((()=>{He(e)}),t))(t,e)));ft.isAsync=!0;var mt={},gt=()=>{if(!gt.strings){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:a||"./this.program"};for(var t in mt)void 0===mt[t]?delete e[t]:e[t]=mt[t];var i=[];for(var t in e)i.push(`${t}=${e[t]}`);gt.strings=i}return gt.strings};var _t=e=>Ct(e);Ae.createPreloadedFile=(e,t,i,s,r,o,n,a,l,A)=>{var c=t?J.resolve(K.join2(e,t)):e;function h(i){function h(i){A?.(),a||((...e)=>{Ae.createDataFile(...e)})(e,t,i,s,r,l),o?.(),D()}((e,t,i,s)=>{"undefined"!=typeof Browser&&Browser.init();var r=!1;return ae.forEach((o=>{r||o.canHandle(t)&&(o.handle(e,t,i,s),r=!0)})),r})(i,c,h,(()=>{n?.(),D()}))||h(i)}T(),"string"==typeof i?ne(i).then(h,n):h(i)},Ae.staticInit(),oe.doesNotExistError=new Ae.ErrnoError(44),oe.doesNotExistError.stack="<generic error, no stack>",(()=>{for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);fe=e})(),r.noExitRuntime&&(G=r.noExitRuntime),r.preloadPlugins&&(ae=r.preloadPlugins),r.print&&(P=r.print),r.printErr&&(x=r.printErr),r.wasmBinary&&(h=r.wasmBinary),r.arguments&&(n=r.arguments),r.thisProgram&&(a=r.thisProgram);var vt={1473352:()=>{console.error("progress callback is not set.")}},bt={a:(e,t,i)=>{throw new z(e).init(t,i),e},j:function(e,t,i){he.varargs=i;try{var s=he.getStreamFromFD(e);switch(t){case 0:if((r=W())<0)return-28;for(;Ae.streams[r];)r++;return Ae.dupStream(s,r).fd;case 1:case 2:case 13:case 14:return 0;case 3:return s.flags;case 4:var r=W();return s.flags|=r,0;case 12:r=X();return m[r+0>>1]=2,0}return-28}catch(e){if(void 0===Ae||"ErrnoError"!==e.name)throw e;return-e.errno}},G:function(e,t,i){he.varargs=i;try{var s=he.getStreamFromFD(e);switch(t){case 21509:case 21510:case 21511:case 21512:case 21524:case 21515:return s.tty?0:-59;case 21505:if(!s.tty)return-59;if(s.tty.ops.ioctl_tcgets){var r=s.tty.ops.ioctl_tcgets(s),o=X();_[o>>2]=r.c_iflag||0,_[o+4>>2]=r.c_oflag||0,_[o+8>>2]=r.c_cflag||0,_[o+12>>2]=r.c_lflag||0;for(var n=0;n<32;n++)p[o+n+17]=r.c_cc[n]||0;return 0}return 0;case 21506:case 21507:case 21508:if(!s.tty)return-59;if(s.tty.ops.ioctl_tcsets){o=X();var a=_[o>>2],l=_[o+4>>2],A=_[o+8>>2],c=_[o+12>>2],h=[];for(n=0;n<32;n++)h.push(p[o+n+17]);return s.tty.ops.ioctl_tcsets(s.tty,t,{c_iflag:a,c_oflag:l,c_cflag:A,c_lflag:c,c_cc:h})}return 0;case 21519:if(!s.tty)return-59;o=X();return _[o>>2]=0,0;case 21520:return s.tty?-28:-59;case 21531:o=X();return Ae.ioctl(s,t,o);case 21523:if(!s.tty)return-59;if(s.tty.ops.ioctl_tiocgwinsz){var u=s.tty.ops.ioctl_tiocgwinsz(s.tty);o=X();m[o>>1]=u[0],m[o+2>>1]=u[1]}return 0;default:return-28}}catch(e){if(void 0===Ae||"ErrnoError"!==e.name)throw e;return-e.errno}},H:function(e,t,i,s){he.varargs=s;try{t=he.getStr(t),t=he.calculateAt(e,t);var r=s?W():0;return Ae.open(t,i,r).fd}catch(e){if(void 0===Ae||"ErrnoError"!==e.name)throw e;return-e.errno}},r:function(e,t,i,s){try{return t=he.getStr(t),s=he.getStr(s),t=he.calculateAt(e,t),s=he.calculateAt(i,s),Ae.rename(t,s),0}catch(e){if(void 0===Ae||"ErrnoError"!==e.name)throw e;return-e.errno}},s:function(e){try{return e=he.getStr(e),Ae.rmdir(e),0}catch(e){if(void 0===Ae||"ErrnoError"!==e.name)throw e;return-e.errno}},w:function(e,t){try{return e=he.getStr(e),he.writeStat(t,Ae.stat(e))}catch(e){if(void 0===Ae||"ErrnoError"!==e.name)throw e;return-e.errno}},t:function(e,t,i){try{if(t=he.getStr(t),t=he.calculateAt(e,t),i){if(512!==i)return-28;Ae.rmdir(t)}else Ae.unlink(t);return 0}catch(e){if(void 0===Ae||"ErrnoError"!==e.name)throw e;return-e.errno}},u:()=>S(""),L:e=>{var t=ue[e];delete ue[e];var i=t.rawConstructor,s=t.rawDestructor,r=t.fields,o=r.map((e=>e.getterReturnType)).concat(r.map((e=>e.setterArgumentType)));ye([e],o,(e=>{var o={};return r.forEach(((t,i)=>{var s=t.fieldName,n=e[i],a=e[i].optional,l=t.getter,A=t.getterContext,c=e[i+r.length],h=t.setter,u=t.setterContext;o[s]={read:e=>n.fromWireType(l(A,e)),write:(e,t)=>{var i=[];h(u,e,c.toWireType(i,t)),de(i)},optional:a}})),[{name:t.name,fromWireType:e=>{var t={};for(var i in o)t[i]=o[i].read(e);return s(e),t},toWireType:(e,t)=>{for(var r in o)if(!(r in t)&&!o[r].optional)throw new TypeError(`Missing field: "${r}"`);var n=i();for(r in o)o[r].write(n,t[r]);return null!==e&&e.push(s,n),n},argPackAdvance:Me,readValueFromPointer:pe,destructorFunction:s}]}))},m:(e,t,i,s,r)=>{t=we(t);const o=0n===s;let n=e=>e;if(o){const e=8*i;n=t=>BigInt.asUintN(e,t),r=n(r)}xe(e,{name:t,fromWireType:n,toWireType:(e,t)=>("number"==typeof t&&(t=BigInt(t)),t),argPackAdvance:Me,readValueFromPointer:Ce(t,i,!o),destructorFunction:null})},R:(e,t,i,s)=>{xe(e,{name:t=we(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?i:s},argPackAdvance:Me,readValueFromPointer:function(e){return this.fromWireType(f[e])},destructorFunction:null})},P:e=>xe(e,Se),l:(e,t,i)=>{xe(e,{name:t=we(t),fromWireType:e=>e,toWireType:(e,t)=>t,argPackAdvance:Me,readValueFromPointer:Re(t,i),destructorFunction:null})},f:(e,t,i,s,o,n,a,l)=>{var A=((e,t)=>{for(var i=[],s=0;s<e;s++)i.push(v[t+4*s>>2]);return i})(t,i);e=(e=>{const t=(e=e.trim()).indexOf("(");return-1===t?e:e.slice(0,t)})(e=we(e)),o=We(s,o,a),((e,t,i)=>{r.hasOwnProperty(e)?((void 0===i||void 0!==r[e].overloadTable&&void 0!==r[e].overloadTable[i])&&Pe(`Cannot register public name '${e}' twice`),ze(r,e,e),r[e].overloadTable.hasOwnProperty(i)&&Pe(`Cannot register multiple overloads of a function with the same number of arguments (${i})!`),r[e].overloadTable[i]=t):(r[e]=t,r[e].argCount=i)})(e,(function(){((e,t)=>{var i=[],s={};throw t.forEach((function e(t){s[t]||ge[t]||(_e[t]?_e[t].forEach(e):(i.push(t),s[t]=!0))})),new Xe(`${e}: `+i.map(Ke).join([", "]))})(`Cannot call ${e} due to unbound types`,A)}),t-1),ye([],A,(i=>{var s=[i[0],null].concat(i.slice(1));return((e,t,i)=>{r.hasOwnProperty(e)||be("Replacing nonexistent public symbol"),void 0!==r[e].overloadTable&&void 0!==i?r[e].overloadTable[i]=t:(r[e]=t,r[e].argCount=i)})(e,Ge(e,s,null,o,n,a),t-1),[]}))},c:(e,t,i,s,r)=>{t=we(t);let o=e=>e;if(0===s){var n=32-8*i;o=e=>e<<n>>>n,r=o(r)}xe(e,{name:t,fromWireType:o,toWireType:(e,t)=>t,argPackAdvance:Me,readValueFromPointer:Ce(t,i,0!==s),destructorFunction:null})},b:(e,t,i)=>{var s=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,BigInt64Array,BigUint64Array][t];function r(e){var t=v[e>>2],i=v[e+4>>2];return new s(p.buffer,i,t)}xe(e,{name:i=we(i),fromWireType:r,argPackAdvance:Me,readValueFromPointer:r},{ignoreDuplicateRegistrations:!0})},Q:(e,t)=>{xe(e,{name:t=we(t),fromWireType(e){for(var t,i=v[e>>2],s=e+4,r=s,o=0;o<=i;++o){var n=s+o;if(o==i||0==f[n]){var a=ce(r,n-r);void 0===t?t=a:(t+=String.fromCharCode(0),t+=a),r=n+1}}return Pt(e),t},toWireType(e,t){var i;t instanceof ArrayBuffer&&(t=new Uint8Array(t));var s="string"==typeof t;s||ArrayBuffer.isView(t)&&1==t.BYTES_PER_ELEMENT||Pe("Cannot pass non-string to std::string"),i=s?ee(t):t.length;var r=Bt(4+i+1),o=r+4;return v[r>>2]=i,s?Ze(t,o,i+1):f.set(t,o),null!==e&&e.push(Pt,r),r},argPackAdvance:Me,readValueFromPointer:pe,destructorFunction(e){Pt(e)}})},g:(e,t,i)=>{var s,r,o,n;i=we(i),2===t?(s=Ye,r=qe,n=$e,o=e=>g[e>>1]):4===t&&(s=et,r=tt,n=it,o=e=>v[e>>2]),xe(e,{name:i,fromWireType:e=>{for(var i,r=v[e>>2],n=e+4,a=0;a<=r;++a){var l=e+4+a*t;if(a==r||0==o(l)){var A=s(n,l-n);void 0===i?i=A:(i+=String.fromCharCode(0),i+=A),n=l+t}}return Pt(e),i},toWireType:(e,s)=>{"string"!=typeof s&&Pe(`Cannot pass non-string to C++ string type ${i}`);var o=n(s),a=Bt(4+o+t);return v[a>>2]=o/t,r(s,a+4,o+t),null!==e&&e.push(Pt,a),a},argPackAdvance:Me,readValueFromPointer:pe,destructorFunction(e){Pt(e)}})},O:(e,t,i,s,r,o)=>{ue[e]={name:we(t),rawConstructor:We(i,s),rawDestructor:We(r,o),fields:[]}},M:(e,t,i,s,r,o,n,a,l,A)=>{ue[e].fields.push({fieldName:we(t),getterReturnType:i,getter:We(s,r),getterContext:o,setterArgumentType:n,setter:We(a,l),setterContext:A})},S:(e,t)=>{xe(e,{isVoid:!0,name:t=we(t),argPackAdvance:0,fromWireType:()=>{},toWireType:(e,t)=>{}})},N:(e,t,i)=>(e=Te(e),t=st(t,"emval::as"),rt(t,i,e)),d:(e,t,i,s)=>(e=ot[e])(null,t=Te(t),i,s),q:Ie,F:e=>{return 0===e?De(at()):(e=void 0===(i=nt[t=e])?we(t):i,De(at()[e]));var t,i},e:(e,t,i)=>{var s=((e,t)=>{for(var i=new Array(e),s=0;s<e;++s)i[s]=st(v[t+4*s>>2],`parameter ${s}`);return i})(e,t),r=s.shift();e--;var o="return function (obj, func, destructorsRef, args) {\n",n=0,a=[];0===i&&a.push("obj");for(var l=["retType"],A=[r],c=0;c<e;++c)a.push(`arg${c}`),l.push(`argType${c}`),A.push(s[c]),o+=`  var arg${c} = argType${c}.readValueFromPointer(args${n?"+"+n:""});\n`,n+=s[c].argPackAdvance;o+=`  var rv = ${1===i?"new func":"func.call"}(${a.join(", ")});\n`,r.isVoid||(l.push("emval_returnValue"),A.push(rt),o+="  return emval_returnValue(retType, destructorsRef, rv);\n"),o+="};\n";var h,u,d=new Function(...l,o)(...A),p=`methodCaller<(${s.map((e=>e.name)).join(", ")}) => ${r.name}>`;return h=Ue(p,d),u=ot.length,ot.push(h),u},o:e=>{e>9&&(Fe[e+1]+=1)},T:e=>"string"==typeof(e=Te(e)),n:e=>{var t=Te(e);de(t),Ie(e)},p:(e,t)=>{var i=(e=st(e,"_emval_take_value")).readValueFromPointer(t);return De(i)},x:function(e,t){e=lt(e);var i=new Date(1e3*e);_[t>>2]=i.getUTCSeconds(),_[t+4>>2]=i.getUTCMinutes(),_[t+8>>2]=i.getUTCHours(),_[t+12>>2]=i.getUTCDate(),_[t+16>>2]=i.getUTCMonth(),_[t+20>>2]=i.getUTCFullYear()-1900,_[t+24>>2]=i.getUTCDay();var s=Date.UTC(i.getUTCFullYear(),0,1,0,0,0,0),r=(i.getTime()-s)/864e5|0;_[t+28>>2]=r},y:function(e,t){e=lt(e);var i=new Date(1e3*e);_[t>>2]=i.getSeconds(),_[t+4>>2]=i.getMinutes(),_[t+8>>2]=i.getHours(),_[t+12>>2]=i.getDate(),_[t+16>>2]=i.getMonth(),_[t+20>>2]=i.getFullYear()-1900,_[t+24>>2]=i.getDay();var s=0|(e=>{var t;return((t=e.getFullYear())%4!=0||t%100==0&&t%400!=0?ct:At)[e.getMonth()]+e.getDate()-1})(i);_[t+28>>2]=s,_[t+36>>2]=-60*i.getTimezoneOffset();var r=new Date(i.getFullYear(),0,1),o=new Date(i.getFullYear(),6,1).getTimezoneOffset(),n=r.getTimezoneOffset(),a=0|(o!=n&&i.getTimezoneOffset()==Math.min(n,o));_[t+32>>2]=a},z:(e,t,i,s)=>{var r=(new Date).getFullYear(),o=new Date(r,0,1),n=new Date(r,6,1),a=o.getTimezoneOffset(),l=n.getTimezoneOffset(),A=Math.max(a,l);v[e>>2]=60*A,_[t>>2]=Number(a!=l);var c=e=>{var t=e>=0?"-":"+",i=Math.abs(e);return`UTC${t}${String(Math.floor(i/60)).padStart(2,"0")}${String(i%60).padStart(2,"0")}`},h=c(a),u=c(l);l<a?(Ze(h,i,17),Ze(u,s,17)):(Ze(h,s,17),Ze(u,i,17))},J:function(e,t,i){if(!((s=e)>=0&&s<=3))return 28;var s,r;r=0===e?ht():performance.now();var o=Math.round(1e3*r*1e3);return y[i>>3]=BigInt(o),0},K:(e,t,i)=>dt(e,t,i),I:ht,v:e=>{var t,i,s=f.length,r=2147483648;if((e>>>=0)>r)return!1;for(var o=1;o<=4;o*=2){var n=s*(1+.2/o);n=Math.min(n,e+100663296);var a=Math.min(r,(t=Math.max(e,n),i=65536,Math.ceil(t/i)*i));if(pt(a))return!0}return!1},k:ft,C:(e,t)=>{var i=0,s=0;for(var r of gt()){var o=t+i;v[e+s>>2]=o,i+=Ze(r,o,1/0)+1,s+=4}return 0},D:(e,t)=>{var i=gt();v[e>>2]=i.length;var s=0;for(var r of i)s+=ee(r)+1;return v[t>>2]=s,0},h:function(e){try{var t=he.getStreamFromFD(e);return Ae.close(t),0}catch(e){if(void 0===Ae||"ErrnoError"!==e.name)throw e;return e.errno}},B:function(e,t){try{var i=he.getStreamFromFD(e),s=i.tty?2:Ae.isDir(i.mode)?3:Ae.isLink(i.mode)?7:4;return p[t]=s,m[t+2>>1]=0,y[t+8>>3]=BigInt(0),y[t+16>>3]=BigInt(0),0}catch(e){if(void 0===Ae||"ErrnoError"!==e.name)throw e;return e.errno}},E:function(e,t,i,s){try{var r=((e,t,i,s)=>{for(var r=0,o=0;o<i;o++){var n=v[t>>2],a=v[t+4>>2];t+=8;var l=Ae.read(e,p,n,a,s);if(l<0)return-1;if(r+=l,l<a)break;void 0!==s&&(s+=l)}return r})(he.getStreamFromFD(e),t,i);return v[s>>2]=r,0}catch(e){if(void 0===Ae||"ErrnoError"!==e.name)throw e;return e.errno}},A:function(e,t,i,s){t=lt(t);try{if(isNaN(t))return 61;var r=he.getStreamFromFD(e);return Ae.llseek(r,t,i),y[s>>3]=BigInt(r.position),r.getdents&&0===t&&0===i&&(r.getdents=null),0}catch(e){if(void 0===Ae||"ErrnoError"!==e.name)throw e;return e.errno}},i:function(e,t,i,s){try{var r=((e,t,i,s)=>{for(var r=0,o=0;o<i;o++){var n=v[t>>2],a=v[t+4>>2];t+=8;var l=Ae.write(e,p,n,a,s);if(l<0)return-1;if(r+=l,l<a)break;void 0!==s&&(s+=l)}return r})(he.getStreamFromFD(e),t,i);return v[s>>2]=r,0}catch(e){if(void 0===Ae||"ErrnoError"!==e.name)throw e;return e.errno}}},yt=await async function(){function e(e,t){return yt=e.exports,yt=je.instrumentWasmExports(yt),u=yt.U,M(),D(),yt}T();var t={a:bt};if(r.instantiateWasm)return new Promise(((i,s)=>{r.instantiateWasm(t,((t,s)=>{i(e(t))}))}));E??(E=R());try{var s=await L(h,E,t);return e(s.instance)}catch(e){return i(e),Promise.reject(e)}}();yt.V;var wt=yt.W,Bt=yt.X,Pt=yt.Y,xt=r._main=yt.Z,Ct=yt._;r.dynCall_ii=yt.$,r.dynCall_vi=yt.aa,r.dynCall_vii=yt.ba,r.dynCall_iii=yt.ca,r.dynCall_viii=yt.da,r.dynCall_v=yt.ea,r.dynCall_diiii=yt.fa,r.dynCall_viif=yt.ga,r.dynCall_iiiii=yt.ha,r.dynCall_iiii=yt.ia,r.dynCall_ddd=yt.ja,r.dynCall_i=yt.ka,r.dynCall_fii=yt.la,r.dynCall_viiii=yt.ma,r.dynCall_iiiiii=yt.na,r.dynCall_idd=yt.oa,r.dynCall_jiji=yt.pa,r.dynCall_iidiiii=yt.qa,r.dynCall_viijii=yt.ra,r.dynCall_iiiiiiiii=yt.sa,r.dynCall_iiiiiii=yt.ta,r.dynCall_iiiiij=yt.ua,r.dynCall_iiiiid=yt.va,r.dynCall_iiiiijj=yt.wa,r.dynCall_iiiiiiii=yt.xa,r.dynCall_iiiiiijj=yt.ya,r.dynCall_viiiiii=yt.za,r.dynCall_viiiii=yt.Aa;var Mt=yt.Ba,Et=yt.Ca,Ft=yt.Da,It=yt.Ea;function Tt(e=[]){var t=xt;e.unshift(a);var i=e.length,s=_t(4*(i+1)),r=s;e.forEach((e=>{v[r>>2]=(e=>{var t=ee(e)+1,i=_t(t);return Ze(e,i,t),i})(e),r+=4})),v[r>>2]=0;try{var o=t(i,s);return Ve(o),o}catch(e){return Oe(e)}}return function(){if(r.preInit)for("function"==typeof r.preInit&&(r.preInit=[r.preInit]);r.preInit.length>0;)r.preInit.shift()()}(),function e(i=n){function s(){(r.calledRun=!0,C)||(r.noFSInit||Ae.initialized||Ae.init(),yt.V(),Ae.ignorePermissions=!1,t(r),r.onRuntimeInitialized?.(),r.noInitialRun||!0||Tt(i),function(){if(r.postRun)for("function"==typeof r.postRun&&(r.postRun=[r.postRun]);r.postRun.length;)V(r.postRun.shift());O(N)}())}F>0?I=e:(!function(){if(r.preRun)for("function"==typeof r.preRun&&(r.preRun=[r.preRun]);r.preRun.length;)H(r.preRun.shift());O(Q)}(),F>0?I=e:r.setStatus?(r.setStatus("Running..."),setTimeout((()=>{setTimeout((()=>r.setStatus("")),1),s()}),1)):s())}(),o})(),zF=Object.defineProperty,WF=(e,t,i)=>(((e,t,i)=>{t in e?zF(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i})(e,"symbol"!=typeof t?t+"":t,i),i);const XF=`https://cdn.jsdelivr.net/npm/@creooxag/cxconverter@${QF}/dist/`,KF=class e{constructor(){WF(this,"module")}static async getInstance(t="remote"){let i="./";if(t&&(i="remote"==t?XF:t),!e.instance){e.instance=new e;const t={locateFile:function(e){const t=i+e;return e.endsWith(".wasm")?(console.log(`Loading wasm file from ${t}`),t):e}};try{e.instance.module=await GF(t)}catch(e){console.error("Error on wasm import:",e)}}return e.instance}static async getModule(t){return(await e.getInstance(t)).module}};WF(KF,"instance");let ZF=KF;const JF={inputParameters:{exportPropertySets:"yes",exportIfcPropertyTypes:"yes",exportIfcValueTypes:"yes",exportPolylines:"yes",excludeGeometryForIfcTypes:["IfcOpeningElement"],excludeGUIDs:[""],exportOnlyGUIDs:[""],centerModelAtOrigin:"yes",ignoreProfileRadius:"yes",enableGltfCompression:"yes",enableGltfQuantization:"no",exportNormals:"no",numPointsPerCircle:18,licenceKey:"",loadingPriorityTypes:["IFCWALL","IFCSLAB","IFCWINDOW","IFCROOF","IFCFURNISHINGELEMENT","IFCAIRTERMINAL"]}};class YF extends ph{constructor(e,t={}){super("ifcLoader",e,t),this.gltfLoader=new MM(this.viewer)}async load(e={}){e.src||this.error("load() param expected: src");const t=await async function(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return t.text()}catch(e){console.error("Error fetching file:",e)}}(e.src),{gltf:i,metaData:s}=await async function(e,t={remote:!0}){null==t.remote&&(t.remote=!0);const i=t.inputOptions?t.inputOptions:JSON.stringify(JF);let s,r;const o=t.remote?"remote":t.urlPath,n=await ZF.getModule(o);t.progressCallback?n.setProgressCallback(t.progressCallback):n.setProgressCallback((e=>{console.log(`Progress: ${e}`)})),t.progressTextCallback?n.setProgressTextCallback(t.progressTextCallback):n.setProgressTextCallback((e=>{console.log(`Progress text: ${e}`)})),n.setInputOptions(i);const a=new Promise((e=>{s=e})),l=new Promise((e=>{r=e}));s&&n.setGltfCompleteCallback(s),r&&n.setMetaDataCompleteCallback(r),n.loadModel(e,{maxFileSizeInMegaBytes:1e3}),await Promise.all([a,l]);const A=await n.getGeometry(),c=await n.getMetaData(),h=(new TextDecoder).decode(c);return{gltf:A,metaData:await JSON.parse(h)}}(t,{remote:!0,progressCallback:e.progressCallback,progressTextCallback:e.progressTextCallback});return this.gltfLoader.load({id:"myModel",gltf:i,metaModelJSON:s})}}class qF{constructor(e={}){this.cacheBuster=!1!==e.cacheBuster}_cacheBusterURL(e){if(!this.cacheBuster)return e;const t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}getLAS(e,t,i){e=this._cacheBusterURL(e);var s=()=>{};t=t||s,i=i||s;const r=e.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const e=!!r[2];var o=r[3];o=window.decodeURIComponent(o),e&&(o=window.atob(o));try{const e=new ArrayBuffer(o.length),i=new Uint8Array(e);for(var n=0;n<o.length;n++)i[n]=o.charCodeAt(n);t(e)}catch(e){i(e)}}else{const s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?t(s.response):i("getLAS error : "+s.response))},s.send(null)}}getManifest(e,t,i){y.loadJSON(this._cacheBusterURL(e),(e=>{t(e)}),(function(e){i(e)}))}}const $F={dataType:null,batchType:null,name:"LAS",id:"las",module:"las",version:"4.3.2",worker:!0,extensions:["las","laz"],mimeTypes:["application/octet-stream"],text:!0,binary:!0,tests:["LAS"],options:{las:{shape:"mesh",fp64:!1,skip:1,colorDepth:8}}};function eI(){var e,t=void 0!==t?t:{},i={};for(e in t)t.hasOwnProperty(e)&&(i[e]=t[e]);var s,r,o,n;s="object"==typeof window,r="function"==typeof importScripts,o="object"==typeof process&&"object"==typeof process.versions&&"string"==typeof process.versions.node,n=!s&&!o&&!r;var a,l,A,c,h,u="";if(o){if(r)u=require("path").dirname(u)+"/";else{const e="undefined"!=typeof __dirname?__dirname:"";u=e+"/"}a=function(e,t){var i=ht(e);return i?t?i:i.toString():(c||(c=require("fs")),h||(h=require("path")),e=h.normalize(e),c.readFileSync(e,t?null:"utf8"))},A=function(e){var t=a(e,!0);return t.buffer||(t=new Uint8Array(t)),g(t.buffer),t},process.argv.length>1&&process.argv[1].replace(/\\/g,"/"),process.argv.slice(2),"undefined"!=typeof module&&(module.exports=t),process.on("uncaughtException",(function(e){if(!(e instanceof Ct))throw e})),process.on("unhandledRejection",z),t.inspect=function(){return"[Emscripten Module object]"}}else n?("undefined"!=typeof read&&(a=function(e){var t=ht(e);return t?At(t):read(e)}),A=function(e){var t;return(t=ht(e))?t:"function"==typeof readbuffer?new Uint8Array(readbuffer(e)):(g("object"==typeof(t=read(e,"binary"))),t)},"undefined"!=typeof scriptArgs&&scriptArgs,"undefined"!=typeof print&&("undefined"==typeof console&&(console={}),console.log=print,console.warn=console.error="undefined"!=typeof printErr?printErr:print)):(s||r)&&(r?u=self.location.href:document.currentScript&&(u=document.currentScript.src),u=0!==u.indexOf("blob:")?u.substr(0,u.lastIndexOf("/")+1):"",a=function(e){try{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText}catch(t){var i=ht(e);if(i)return At(i);throw t}},r&&(A=function(e){try{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}catch(t){var i=ht(e);if(i)return i;throw t}}),l=function(e,t,i){var s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=function(){if(200==s.status||0==s.status&&s.response)t(s.response);else{var r=ht(e);r?t(r.buffer):i()}},s.onerror=i,s.send(null)});var d=t.print||console.log.bind(console),p=t.printErr||console.warn.bind(console);for(e in i)i.hasOwnProperty(e)&&(t[e]=i[e]);i=null,t.arguments,t.thisProgram,t.quit,new Array(0);var f=0;t.wasmBinary,t.noExitRuntime;var m=!1;function g(e,t){e||z("Assertion failed: "+t)}var _="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function v(e,t){return e?function(e,t,i){for(var s=t+i,r=t;e[r]&&!(r>=s);)++r;if(r-t>16&&e.subarray&&_)return _.decode(e.subarray(t,r));for(var o="";t<r;){var n=e[t++];if(128&n){var a=63&e[t++];if(192!=(224&n)){var l=63&e[t++];if((n=224==(240&n)?(15&n)<<12|a<<6|l:(7&n)<<18|a<<12|l<<6|63&e[t++])<65536)o+=String.fromCharCode(n);else{var A=n-65536;o+=String.fromCharCode(55296|A>>10,56320|1023&A)}}else o+=String.fromCharCode((31&n)<<6|a)}else o+=String.fromCharCode(n)}return o}(w,e,t):""}var b,y,w,B,P,x,C,M,E,F="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0;function I(e,t){for(var i=e,s=i>>1,r=s+t/2;!(s>=r)&&P[s];)++s;if((i=s<<1)-e>32&&F)return F.decode(w.subarray(e,i));for(var o=0,n="";;){var a=B[e+2*o>>1];if(0==a||o==t/2)return n;++o,n+=String.fromCharCode(a)}}function T(e,t,i){if(void 0===i&&(i=2147483647),i<2)return 0;for(var s=t,r=(i-=2)<2*e.length?i/2:e.length,o=0;o<r;++o){var n=e.charCodeAt(o);B[t>>1]=n,t+=2}return B[t>>1]=0,t-s}function D(e){return 2*e.length}function S(e,t){for(var i=0,s="";!(i>=t/4);){var r=x[e+4*i>>2];if(0==r)break;if(++i,r>=65536){var o=r-65536;s+=String.fromCharCode(55296|o>>10,56320|1023&o)}else s+=String.fromCharCode(r)}return s}function R(e,t,i){if(void 0===i&&(i=2147483647),i<4)return 0;for(var s=t,r=s+i-4,o=0;o<e.length;++o){var n=e.charCodeAt(o);if(n>=55296&&n<=57343)n=65536+((1023&n)<<10)|1023&e.charCodeAt(++o);if(x[t>>2]=n,(t+=4)+4>r)break}return x[t>>2]=0,t-s}function U(e){for(var t=0,i=0;i<e.length;++i){var s=e.charCodeAt(i);s>=55296&&s<=57343&&++i,t+=4}return t}var L,k=t.INITIAL_MEMORY||167772160;function O(e){for(;e.length>0;){var i=e.shift();if("function"!=typeof i){var s=i.func;"number"==typeof s?void 0===i.arg?t.dynCall_v(s):t.dynCall_vi(s,i.arg):s(void 0===i.arg?null:i.arg)}else i(t)}}k=(b=t.buffer?t.buffer:new ArrayBuffer(k)).byteLength,b=L=b,t.HEAP8=y=new Int8Array(L),t.HEAP16=B=new Int16Array(L),t.HEAP32=x=new Int32Array(L),t.HEAPU8=w=new Uint8Array(L),t.HEAPU16=P=new Uint16Array(L),t.HEAPU32=C=new Uint32Array(L),t.HEAPF32=M=new Float32Array(L),t.HEAPF64=E=new Float64Array(L),x[5544]=5265264;var N=[],V=[],Q=[],H=[];var j=0,G=null;function z(e){throw t.onAbort&&t.onAbort(e),d(e+=""),p(e),m=!0,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info."}t.preloadedImages={},t.preloadedAudios={};var W=null;var X="data:application/octet-stream;base64,";function K(e){return t=e,i=X,String.prototype.startsWith?t.startsWith(i):0===t.indexOf(i);var t,i}V.push({func:function(){bt()}}),W="data:application/octet-stream;base64,AAAAAAAAAAAPDg0MCwoJCA4AAQMGCgoJDQECBAcLCwoMAwQFCAwMCwsGBwgJDQ0MCgoLDA0ODg0JCgsMDQ4PDggJCgsMDQ4PAAECAwQFBgcBAAECAwQFBgIBAAECAwQFAwIBAAECAwQEAwIBAAECAwUEAwIBAAECBgUEAwIBAAEHBgUEAwIBAMgPAAAoDQAAEBAAACAQAADIDwAAUA0AABAQAAAgEAAAEQAKABEREQAAAAAFAAAAAAAACQAAAAALAAAAAAAAAAARAA8KERERAwoHAAEACQsLAAAJBgsAAAsABhEAAAAREREAAAAAAAAAAAAAAAAAAAAACwAAAAAAAAAAEQAKChEREQAKAAACAAkLAAAACQALAAALAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAAAAAAAAAAAAAAwAAAAADAAAAAAJDAAAAAAADAAADAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAANAAAABA0AAAAACQ4AAAAAAA4AAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAADwAAAAAPAAAAAAkQAAAAAAAQAAAQAAASAAAAEhISAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABIAAAASEhIAAAAAAAAJAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALAAAAAAAAAAAAAAAKAAAAAAoAAAAACQsAAAAAAAsAAAsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAAAAAAADAAAAAAMAAAAAAkMAAAAAAAMAAAMAAAwMTIzNDU2Nzg5QUJDREVGGRJEOwI/LEcUPTMwChsGRktFNw9JDo4XA0AdPGkrNh9KLRwBICUpIQgMFRYiLhA4Pgs0MRhkdHV2L0EJfzkRI0MyQomKiwUEJignDSoeNYwHGkiTE5SVAAAAAAAAAAAASWxsZWdhbCBieXRlIHNlcXVlbmNlAERvbWFpbiBlcnJvcgBSZXN1bHQgbm90IHJlcHJlc2VudGFibGUATm90IGEgdHR5AFBlcm1pc3Npb24gZGVuaWVkAE9wZXJhdGlvbiBub3QgcGVybWl0dGVkAE5vIHN1Y2ggZmlsZSBvciBkaXJlY3RvcnkATm8gc3VjaCBwcm9jZXNzAEZpbGUgZXhpc3RzAFZhbHVlIHRvbyBsYXJnZSBmb3IgZGF0YSB0eXBlAE5vIHNwYWNlIGxlZnQgb24gZGV2aWNlAE91dCBvZiBtZW1vcnkAUmVzb3VyY2UgYnVzeQBJbnRlcnJ1cHRlZCBzeXN0ZW0gY2FsbABSZXNvdXJjZSB0ZW1wb3JhcmlseSB1bmF2YWlsYWJsZQBJbnZhbGlkIHNlZWsAQ3Jvc3MtZGV2aWNlIGxpbmsAUmVhZC1vbmx5IGZpbGUgc3lzdGVtAERpcmVjdG9yeSBub3QgZW1wdHkAQ29ubmVjdGlvbiByZXNldCBieSBwZWVyAE9wZXJhdGlvbiB0aW1lZCBvdXQAQ29ubmVjdGlvbiByZWZ1c2VkAEhvc3QgaXMgZG93bgBIb3N0IGlzIHVucmVhY2hhYmxlAEFkZHJlc3MgaW4gdXNlAEJyb2tlbiBwaXBlAEkvTyBlcnJvcgBObyBzdWNoIGRldmljZSBvciBhZGRyZXNzAEJsb2NrIGRldmljZSByZXF1aXJlZABObyBzdWNoIGRldmljZQBOb3QgYSBkaXJlY3RvcnkASXMgYSBkaXJlY3RvcnkAVGV4dCBmaWxlIGJ1c3kARXhlYyBmb3JtYXQgZXJyb3IASW52YWxpZCBhcmd1bWVudABBcmd1bWVudCBsaXN0IHRvbyBsb25nAFN5bWJvbGljIGxpbmsgbG9vcABGaWxlbmFtZSB0b28gbG9uZwBUb28gbWFueSBvcGVuIGZpbGVzIGluIHN5c3RlbQBObyBmaWxlIGRlc2NyaXB0b3JzIGF2YWlsYWJsZQBCYWQgZmlsZSBkZXNjcmlwdG9yAE5vIGNoaWxkIHByb2Nlc3MAQmFkIGFkZHJlc3MARmlsZSB0b28gbGFyZ2UAVG9vIG1hbnkgbGlua3MATm8gbG9ja3MgYXZhaWxhYmxlAFJlc291cmNlIGRlYWRsb2NrIHdvdWxkIG9jY3VyAFN0YXRlIG5vdCByZWNvdmVyYWJsZQBQcmV2aW91cyBvd25lciBkaWVkAE9wZXJhdGlvbiBjYW5jZWxlZABGdW5jdGlvbiBub3QgaW1wbGVtZW50ZWQATm8gbWVzc2FnZSBvZiBkZXNpcmVkIHR5cGUASWRlbnRpZmllciByZW1vdmVkAERldmljZSBub3QgYSBzdHJlYW0ATm8gZGF0YSBhdmFpbGFibGUARGV2aWNlIHRpbWVvdXQAT3V0IG9mIHN0cmVhbXMgcmVzb3VyY2VzAExpbmsgaGFzIGJlZW4gc2V2ZXJlZABQcm90b2NvbCBlcnJvcgBCYWQgbWVzc2FnZQBGaWxlIGRlc2NyaXB0b3IgaW4gYmFkIHN0YXRlAE5vdCBhIHNvY2tldABEZXN0aW5hdGlvbiBhZGRyZXNzIHJlcXVpcmVkAE1lc3NhZ2UgdG9vIGxhcmdlAFByb3RvY29sIHdyb25nIHR5cGUgZm9yIHNvY2tldABQcm90b2NvbCBub3QgYXZhaWxhYmxlAFByb3RvY29sIG5vdCBzdXBwb3J0ZWQAU29ja2V0IHR5cGUgbm90IHN1cHBvcnRlZABOb3Qgc3VwcG9ydGVkAFByb3RvY29sIGZhbWlseSBub3Qgc3VwcG9ydGVkAEFkZHJlc3MgZmFtaWx5IG5vdCBzdXBwb3J0ZWQgYnkgcHJvdG9jb2wAQWRkcmVzcyBub3QgYXZhaWxhYmxlAE5ldHdvcmsgaXMgZG93bgBOZXR3b3JrIHVucmVhY2hhYmxlAENvbm5lY3Rpb24gcmVzZXQgYnkgbmV0d29yawBDb25uZWN0aW9uIGFib3J0ZWQATm8gYnVmZmVyIHNwYWNlIGF2YWlsYWJsZQBTb2NrZXQgaXMgY29ubmVjdGVkAFNvY2tldCBub3QgY29ubmVjdGVkAENhbm5vdCBzZW5kIGFmdGVyIHNvY2tldCBzaHV0ZG93bgBPcGVyYXRpb24gYWxyZWFkeSBpbiBwcm9ncmVzcwBPcGVyYXRpb24gaW4gcHJvZ3Jlc3MAU3RhbGUgZmlsZSBoYW5kbGUAUmVtb3RlIEkvTyBlcnJvcgBRdW90YSBleGNlZWRlZABObyBtZWRpdW0gZm91bmQAV3JvbmcgbWVkaXVtIHR5cGUATm8gZXJyb3IgaW5mb3JtYXRpb24AAAAAAADgFgAAmRgAAGAQAAAAAAAA4BYAAEIZAABgEAAAAAAAAOAWAAAqGgAASA8AAAAAAAC4FgAANBsAAOAWAACfGgAAMAoAAAAAAADgFgAAaRsAAEgPAAAAAAAA4BYAAIobAABIDwAAAAAAALgWAAAPHAAA4BYAAHwcAABIDwAAAAAAAOAWAACVHAAASA8AAAAAAADgFgAAHh0AAEgPAAAAAAAA4BYAAHcdAABIDwAAAAAAAOAWAACQHQAASA8AAAAAAADgFgAAQh4AAEgPAAAAAAAA4BYAAIceAABgEAAAAAAAAOAWAACkHwAASA8AAAAAAAC4FgAAZyAAAOAWAADkHwAA8AoAAAAAAADgFgAAjyAAAGAQAAAAAAAAuBYAAMMiAADgFgAAAiIAABgLAAAAAAAA4BYAAOEiAABgEAAAAAAAAOAWAADQJAAAGAsAAAAAAADgFgAAkSUAAGAQAAAAAAAA4BYAAIAnAAAYCwAAAAAAAOAWAAA9KAAAYBAAAAAAAADgFgAAJCoAABgLAAAAAAAA4BYAAOkqAABgEAAAAAAAAOAWAADgLAAA8AoAAAAAAADgFgAAui0AAGAQAAAAAAAA4BYAANsvAADwCgAAAAAAAOAWAADTMAAAYBAAAAAAAADgFgAAMDMAAPAKAAAAAAAA4BYAACQ0AABgEAAAAAAAAOAWAAB5NgAA8AoAAAAAAADgFgAAizcAAGAQAAAAAAAA4BYAABw6AABgEAAAAAAAAOAWAACdOgAAYBAAAAAAAADgFgAAXjsAAPAKAAAAAAAA4BYAALU7AABgEAAAAAAAAOAWAADMPAAAGAsAAAAAAADgFgAATz0AAGAQAAAAAAAA4BYAAL4+AAAYCwAAAAAAAOAWAABBPwAAYBAAAAAAAADgFgAAsEAAABgLAAAAAAAA4BYAADNBAABgEAAAAAAAAOAWAACiQgAAGAsAAAAAAADgFgAAJUMAAGAQAAAAAAAA4BYAAJREAAAYCwAAAAAAAOAWAAAXRQAAYBAAAAAAAADgFgAAhkYAABgLAAAAAAAA4BYAAAlHAABgEAAAAAAAALgWAAB4SAAAiBcAAIBIAAAAAAAAIA0AAIgXAACJSAAAAQAAACANAAC4FgAAqkgAAIgXAAC6SAAAAAAAAEgNAACIFwAAy0gAAAEAAABIDQAAuBYAABhMAAC4FgAAN0wAALgWAABWTAAAuBYAAHVMAAC4FgAAlEwAALgWAACzTAAAuBYAANJMAAC4FgAA8UwAALgWAAAQTQAAuBYAAC9NAAC4FgAATk0AALgWAABtTQAAuBYAAIxNAACkFwAAn00AAAAAAAABAAAA8A0AAAAAAAC4FgAA4U0AAKQXAAAHTgAAAAAAAAEAAADwDQAAAAAAAKQXAABJTgAAAAAAAAEAAADwDQAAAAAAAKQXAACITgAAAAAAAAEAAADwDQAAAAAAAKQXAADHTgAAAAAAAAEAAADwDQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP//////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALgWAADNTwAA4BYAAC1QAAAADwAAAAAAAOAWAADaTwAAEA8AAAAAAAC4FgAA+08AAOAWAAAIUAAA8A4AAAAAAADgFgAAhlAAAOgOAAAAAAAA4BYAAJNQAADoDgAAAAAAAOAWAACjUAAA6A4AAAAAAADgFgAAtVAAADgPAAAAAAAA4BYAAMZQAAA4DwAAAAAAAOAWAADXUAAAAA8AAAAAAADgFgAA+VAAAHgPAAAAAAAA4BYAAB1RAAAADwAAAAAAAOAWAABCUQAAeA8AAAAAAADgFgAAjlEAAAAPAAAAAAAAbBcAALZRAABsFwAAuFEAAGwXAAC7UQAAbBcAAL1RAABsFwAAv1EAAGwXAADBUQAAbBcAAMNRAABsFwAAxVEAAGwXAADHUQAAbBcAAMlRAABsFwAAy1EAAGwXAADNUQAAbBcAAM9RAABsFwAA0VEAAOAWAADTUQAA8A4AAAAAAADgFgAARlIAAOgOAAAAAAAAuBYAAGJSAACkFwAAe1IAAAAAAAABAAAAWBAAAAAAAADgFgAA9FIAAIgQAAAAAAAA4BYAABdTAACYEAAAAAAAALgWAAAuUwAA4BYAAHBTAACIEAAAAAAAAOAWAACSUwAASA8AAAAAAAAAAAAAAAoAAAEAAAACAAAAAwAAAAEAAAAEAAAAAAAAABAKAAABAAAABQAAAAYAAAACAAAABwAAAAAAAAAgCgAACAAAAAkAAAABAAAAAAAAADgKAAAKAAAACwAAAAIAAAABAAAADAAAAA0AAAACAAAAAwAAAAMAAAAAAAAASAoAAAgAAAAOAAAAAQAAAAAAAABYCgAACAAAAA8AAAABAAAAAAAAAIAKAAAIAAAAEAAAAAEAAAAAAAAAcAoAAAgAAAARAAAAAQAAAAAAAACQCgAACAAAABIAAAABAAAAAAAAAKAKAAAIAAAAEwAAAAEAAAAAAAAAsAoAAAgAAAAUAAAAAQAAAAAAAADACgAACAAAABUAAAABAAAAAAAAANAKAAABAAAAFgAAABcAAAAEAAAAGAAAAAAAAADgCgAACAAAABkAAAABAAAAAAAAAPgKAAAFAAAAGgAAABsAAAAAAAAA8AoAAAEAAAAcAAAAHQAAAAAAAAAICwAAAQAAAB4AAAAfAAAABgAAACAAAAAAAAAAIAsAACEAAAAiAAAABwAAAAgAAAAAAAAAGAsAACMAAAAkAAAABwAAAAkAAAAAAAAAMAsAAAEAAAAlAAAAJgAAAAoAAAAnAAAAAAAAAEALAAAoAAAAKQAAAAcAAAALAAAAAAAAAFALAAABAAAAKgAAACsAAAAMAAAALAAAAAAAAABgCwAALQAAAC4AAAAHAAAADQAAAAAAAABwCwAAAQAAAC8AAAAwAAAADgAAADEAAAAAAAAAgAsAADIAAAAzAAAABwAAAA8AAAAAAAAAkAsAAAEAAAA0AAAANQAAABAAAAA2AAAAAAAAAKALAAARAAAANwAAADgAAAAAAAAAsAsAAAEAAAA5AAAAOgAAABIAAAA7AAAAAAAAAMALAAATAAAAPAAAAD0AAAAAAAAA0AsAAAEAAAA+AAAAPwAAABQAAABAAAAAAAAAAOALAAAVAAAAQQAAAEIAAAAAAAAA8AsAAAEAAABDAAAARAAAABYAAABFAAAAAAAAAAAMAAAXAAAARgAAAEcAAAAAAAAAEAwAAAEAAABIAAAASQAAABgAAABKAAAAAAAAACAMAAABAAAASwAAAEwAAAAZAAAATQAAAAAAAAAwDAAAAQAAAE4AAABPAAAAGgAAAFAAAAAAAAAAQAwAABsAAABRAAAAUgAAAAAAAABQDAAAAQAAAFMAAABUAAAAHAAAAFUAAAAAAAAAYAwAAFYAAABXAAAABwAAAB0AAAAAAAAAcAwAAAEAAABYAAAAWQAAAB4AAABaAAAAAAAAAIAMAABbAAAAXAAAAAcAAAAfAAAAAAAAAJAMAAABAAAAXQAAAF4AAAAgAAAAXwAAAAAAAACgDAAAYAAAAGEAAAAHAAAAIQAAAAAAAACwDAAAAQAAAGIAAABjAAAAIgAAAGQAAAAAAAAAwAwAAGUAAABmAAAABwAAACMAAAAAAAAA0AwAAAEAAABnAAAAaAAAACQAAABpAAAAAAAAAOAMAABqAAAAawAAAAcAAAAlAAAAAAAAAPAMAAABAAAAbAAAAG0AAAAmAAAAbgAAAAAAAAAADQAAbwAAAHAAAAAHAAAAJwAAAAAAAAAQDQAAAQAAAHEAAAByAAAAKAAAAHMAAAAoDQAAyA8AACgNAAAIEAAAEBAAACgNAABQDQAAyA8AAFANAAAgEAAAyA8AAFANAAAIEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABsVAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwDgAAdAAAAHUAAAB2AAAAdwAAAAIAAAABAAAAAQAAAAEAAAAAAAAAGA8AAHQAAAB4AAAAdgAAAHcAAAACAAAAAgAAAAIAAAACAAAAAAAAACgPAAB5AAAAegAAAAQAAAAAAAAAOA8AAHsAAAB8AAAABQAAAAAAAABIDwAACAAAAH0AAAABAAAAAAAAAFgPAAB7AAAAfgAAAAUAAAAAAAAAaA8AAHsAAAB/AAAABQAAAAAAAAC4DwAAdAAAAIAAAAB2AAAAdwAAAAMAAAAAAAAAiA8AAHQAAACBAAAAdgAAAHcAAAAEAAAAAAAAADgQAAB0AAAAggAAAHYAAAB3AAAAAgAAAAMAAAADAAAAAwAAAAAAAABIEAAAgwAAAIQAAAAGAAAAAAAAAHgQAACFAAAAhgAAAAcAAAABAAAABQAAAAYAAAACAAAAAAAAAKAQAACFAAAAhwAAAAgAAAADAAAABQAAAAYAAAAEAAAA4BcAAAQYAAAAAAAAsBAAAIgAAACJAAAAAQAAAExBU1ppcABvcGVuAGdldFBvaW50AGdldENvdW50AER5bmFtaWNMQVNaaXAAYWRkRmllbGRGbG9hdGluZwBhZGRGaWVsZFNpZ25lZABhZGRGaWVsZFVuc2lnbmVkAE5TdDNfXzIyMF9fc2hhcmVkX3B0cl9wb2ludGVySVBONmxhc3ppcDdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRU5TXzE0ZGVmYXVsdF9kZWxldGVJUzNfRUVOU185YWxsb2NhdG9ySVMzX0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJTjZsYXN6aXA3c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRQBOU3QzX18yMjBfX3NoYXJlZF9wdHJfcG9pbnRlcklQTjZsYXN6aXAyaW82cmVhZGVyMTBiYXNpY19maWxlSU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRU5TXzE0ZGVmYXVsdF9kZWxldGVJUzdfRUVOU185YWxsb2NhdG9ySVM3X0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJTjZsYXN6aXAyaW82cmVhZGVyMTBiYXNpY19maWxlSU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFAExBU0YATjZsYXN6aXAxM2ludmFsaWRfbWFnaWNFAGFsbG9jYXRvcjxUPjo6YWxsb2NhdGUoc2l6ZV90IG4pICduJyBleGNlZWRzIG1heGltdW0gc3VwcG9ydGVkIHNpemUARmlsZSBtYWdpYyBpcyBub3QgdmFsaWQATlN0M19fMjEwX19mdW5jdGlvbjZfX2Z1bmNJWk42bGFzemlwMmlvNnJlYWRlcjEwYmFzaWNfZmlsZUlOUzJfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRTExX3ZhbGlkYXRvcnNFdkVVbFJOUzNfNmhlYWRlckVFX05TXzlhbGxvY2F0b3JJU0JfRUVGdlNBX0VFRQBOU3QzX18yMTBfX2Z1bmN0aW9uNl9fYmFzZUlGdlJONmxhc3ppcDJpbzZoZWFkZXJFRUVFAE42bGFzemlwMjFvbGRfc3R5bGVfY29tcHJlc3Npb25FAE42bGFzemlwMTRub3RfY29tcHJlc3NlZEUAVGhlIGZpbGUgc2VlbXMgdG8gaGF2ZSBvbGQgc3R5bGUgY29tcHJlc3Npb24gd2hpY2ggaXMgbm90IHN1cHBvcnRlZABUaGUgZmlsZSBkb2Vzbid0IHNlZW0gdG8gYmUgY29tcHJlc3NlZABaTjZsYXN6aXAyaW82cmVhZGVyMTBiYXNpY19maWxlSU5TXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUUxMV92YWxpZGF0b3JzRXZFVWxSTlMwXzZoZWFkZXJFRV8AbGFzemlwIGVuY29kZWQATjZsYXN6aXAxM25vX2xhc3ppcF92bHJFAE42bGFzemlwMjVsYXN6aXBfZm9ybWF0X3Vuc3VwcG9ydGVkRQBPbmx5IExBU3ppcCBQT0lOVFdJU0UgQ0hVTktFRCBkZWNvbXByZXNzb3IgaXMgc3VwcG9ydGVkAE5vIExBU3ppcCBWTFIgd2FzIGZvdW5kIGluIHRoZSBWTFJzIHNlY3Rpb24ATjZsYXN6aXAyMmNodW5rX3RhYmxlX3JlYWRfZXJyb3JFAENodW5rIHRhYmxlIG9mZnNldCA9PSAtMSBpcyBub3Qgc3VwcG9ydGVkIGF0IHRoaXMgdGltZQBONmxhc3ppcDEzbm90X3N1cHBvcnRlZEUATjZsYXN6aXAyNnVua25vd25fY2h1bmtfdGFibGVfZm9ybWF0RQBjaHVua19zaXplID09IHVpbnQubWF4IGlzIG5vdCBzdXBwb3J0ZWQgYXQgdGhpcyB0aW1lLgBUaGVyZSB3YXMgYSBwcm9ibGVtIHJlYWRpbmcgdGhlIGNodW5rIHRhYmxlAFRoZSBjaHVuayB0YWJsZSB2ZXJzaW9uIG51bWJlciBpcyB1bmtub3duAE42bGFzemlwMTFlbmRfb2ZfZmlsZUUAUmVhY2hlZCBFbmQgb2YgZmlsZQBJbnZhbGlkIG51bWJlciBvZiBzeW1ib2xzAE5TdDNfXzIyMF9fc2hhcmVkX3B0cl9wb2ludGVySVBONmxhc3ppcDhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOU18xNGRlZmF1bHRfZGVsZXRlSVM5X0VFTlNfOWFsbG9jYXRvcklTOV9FRUVFAE5TdDNfXzIxNGRlZmF1bHRfZGVsZXRlSU42bGFzemlwOGRlY29kZXJzMTBhcml0aG1ldGljSU5TMV8yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOUzFfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRUVFAE42bGFzemlwMTl1bmtub3duX3NjaGVtYV90eXBlRQBUaGUgTEFaIHNjaGVtYSBpcyBub3QgcmVjb2duaXplZABONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2ZpZWxkX2RlY29tcHJlc3NvcklOU184ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlNfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlNfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyMGR5bmFtaWNfZGVjb21wcmVzc29yRQBOU3QzX18yMjBfX3NoYXJlZF9wdHJfcG9pbnRlcklQTjZsYXN6aXA3Zm9ybWF0czI2ZHluYW1pY19maWVsZF9kZWNvbXByZXNzb3JJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVFRU5TXzE0ZGVmYXVsdF9kZWxldGVJU0NfRUVOU185YWxsb2NhdG9ySVNDX0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJTjZsYXN6aXA3Zm9ybWF0czI2ZHluYW1pY19maWVsZF9kZWNvbXByZXNzb3JJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOU18yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOU183c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMwXzVmaWVsZElOUzBfM2xhczdwb2ludDEwRU5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNDX0VFRUVFRQBONmxhc3ppcDdmb3JtYXRzMTBiYXNlX2ZpZWxkRQBOU3QzX18yMjBfX3NoYXJlZF9wdHJfcG9pbnRlcklQTjZsYXN6aXA3Zm9ybWF0czI2ZHluYW1pY19kZWNvbXByZXNzb3JfZmllbGRJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzJfNWZpZWxkSU5TMl8zbGFzN3BvaW50MTBFTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0VfRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTSV9FRU5TXzlhbGxvY2F0b3JJU0lfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSU5TMV8yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOUzFfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRU5TMl81ZmllbGRJTlMyXzNsYXM3cG9pbnQxMEVOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTRV9FRUVFRUVFRQBONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOU184ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlNfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlNfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRU5TMF81ZmllbGRJTlMwXzNsYXM3Z3BzdGltZUVOUzBfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTQ19FRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzVmaWVsZElOUzJfM2xhczdncHN0aW1lRU5TMl8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNFX0VFRUVFRU5TXzE0ZGVmYXVsdF9kZWxldGVJU0lfRUVOU185YWxsb2NhdG9ySVNJX0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJTjZsYXN6aXA3Zm9ybWF0czI2ZHluYW1pY19kZWNvbXByZXNzb3JfZmllbGRJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzJfNWZpZWxkSU5TMl8zbGFzN2dwc3RpbWVFTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0VfRUVFRUVFRUUATjZsYXN6aXA3Zm9ybWF0czI2ZHluYW1pY19kZWNvbXByZXNzb3JfZmllbGRJTlNfOGRlY29kZXJzMTBhcml0aG1ldGljSU5TXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzBfNWZpZWxkSU5TMF8zbGFzM3JnYkVOUzBfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTQ19FRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzVmaWVsZElOUzJfM2xhczNyZ2JFTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0VfRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTSV9FRU5TXzlhbGxvY2F0b3JJU0lfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSU5TMV8yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOUzFfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRU5TMl81ZmllbGRJTlMyXzNsYXMzcmdiRU5TMl8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNFX0VFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOU18yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOU183c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMwXzVmaWVsZElOUzBfM2xhczEwZXh0cmFieXRlc0VOUzBfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTQ19FRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzVmaWVsZElOUzJfM2xhczEwZXh0cmFieXRlc0VOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTRV9FRUVFRUVOU18xNGRlZmF1bHRfZGVsZXRlSVNJX0VFTlNfOWFsbG9jYXRvcklTSV9FRUVFAE5TdDNfXzIxNGRlZmF1bHRfZGVsZXRlSU42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzVmaWVsZElOUzJfM2xhczEwZXh0cmFieXRlc0VOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTRV9FRUVFRUVFRQBONmxhc3ppcDdmb3JtYXRzMjFkeW5hbWljX2RlY29tcHJlc3NvcjFJTlNfOGRlY29kZXJzMTBhcml0aG1ldGljSU5TXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzBfMTlyZWNvcmRfZGVjb21wcmVzc29ySUpOUzBfNWZpZWxkSU5TMF8zbGFzN3BvaW50MTBFTlMwXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0RfRUVFRUVFRUVFAE5TdDNfXzIyMF9fc2hhcmVkX3B0cl9wb2ludGVySVBONmxhc3ppcDdmb3JtYXRzMjFkeW5hbWljX2RlY29tcHJlc3NvcjFJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzJfMTlyZWNvcmRfZGVjb21wcmVzc29ySUpOUzJfNWZpZWxkSU5TMl8zbGFzN3BvaW50MTBFTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0ZfRUVFRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTS19FRU5TXzlhbGxvY2F0b3JJU0tfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjFkeW5hbWljX2RlY29tcHJlc3NvcjFJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzJfMTlyZWNvcmRfZGVjb21wcmVzc29ySUpOUzJfNWZpZWxkSU5TMl8zbGFzN3BvaW50MTBFTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0ZfRUVFRUVFRUVFRUUATjZsYXN6aXA3Zm9ybWF0czIxZHluYW1pY19kZWNvbXByZXNzb3IxSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOU18yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOU183c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMwXzE5cmVjb3JkX2RlY29tcHJlc3NvcklKTlMwXzVmaWVsZElOUzBfM2xhczdwb2ludDEwRU5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNEX0VFRUVOU0JfSU5TQ183Z3BzdGltZUVOU0VfSVNIX0VFRUVFRUVFRQBOU3QzX18yMjBfX3NoYXJlZF9wdHJfcG9pbnRlcklQTjZsYXN6aXA3Zm9ybWF0czIxZHluYW1pY19kZWNvbXByZXNzb3IxSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzE5cmVjb3JkX2RlY29tcHJlc3NvcklKTlMyXzVmaWVsZElOUzJfM2xhczdwb2ludDEwRU5TMl8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNGX0VFRUVOU0RfSU5TRV83Z3BzdGltZUVOU0dfSVNKX0VFRUVFRUVFRU5TXzE0ZGVmYXVsdF9kZWxldGVJU05fRUVOU185YWxsb2NhdG9ySVNOX0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJTjZsYXN6aXA3Zm9ybWF0czIxZHluYW1pY19kZWNvbXByZXNzb3IxSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzE5cmVjb3JkX2RlY29tcHJlc3NvcklKTlMyXzVmaWVsZElOUzJfM2xhczdwb2ludDEwRU5TMl8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNGX0VFRUVOU0RfSU5TRV83Z3BzdGltZUVOU0dfSVNKX0VFRUVFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyMWR5bmFtaWNfZGVjb21wcmVzc29yMUlOU184ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlNfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlNfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRU5TMF8xOXJlY29yZF9kZWNvbXByZXNzb3JJSk5TMF81ZmllbGRJTlMwXzNsYXM3cG9pbnQxMEVOUzBfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTRF9FRUVFTlNCX0lOU0NfM3JnYkVOU0VfSVNIX0VFRUVFRUVFRQBOU3QzX18yMjBfX3NoYXJlZF9wdHJfcG9pbnRlcklQTjZsYXN6aXA3Zm9ybWF0czIxZHluYW1pY19kZWNvbXByZXNzb3IxSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzE5cmVjb3JkX2RlY29tcHJlc3NvcklKTlMyXzVmaWVsZElOUzJfM2xhczdwb2ludDEwRU5TMl8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNGX0VFRUVOU0RfSU5TRV8zcmdiRU5TR19JU0pfRUVFRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTTl9FRU5TXzlhbGxvY2F0b3JJU05fRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjFkeW5hbWljX2RlY29tcHJlc3NvcjFJTlMxXzhkZWNvZGVyczEwYXJpdGhtZXRpY0lOUzFfMmlvMThfX2lmc3RyZWFtX3dyYXBwZXJJTlMxXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzJfMTlyZWNvcmRfZGVjb21wcmVzc29ySUpOUzJfNWZpZWxkSU5TMl8zbGFzN3BvaW50MTBFTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0ZfRUVFRU5TRF9JTlNFXzNyZ2JFTlNHX0lTSl9FRUVFRUVFRUVFRQBONmxhc3ppcDdmb3JtYXRzMjFkeW5hbWljX2RlY29tcHJlc3NvcjFJTlNfOGRlY29kZXJzMTBhcml0aG1ldGljSU5TXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TXzdzdHJlYW1zMTNtZW1vcnlfc3RyZWFtRUVFRUVOUzBfMTlyZWNvcmRfZGVjb21wcmVzc29ySUpOUzBfNWZpZWxkSU5TMF8zbGFzN3BvaW50MTBFTlMwXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJU0RfRUVFRU5TQl9JTlNDXzdncHN0aW1lRU5TRV9JU0hfRUVFRU5TQl9JTlNDXzNyZ2JFTlNFX0lTS19FRUVFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyMWR5bmFtaWNfZGVjb21wcmVzc29yMUlOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSU5TMV8yaW8xOF9faWZzdHJlYW1fd3JhcHBlcklOUzFfN3N0cmVhbXMxM21lbW9yeV9zdHJlYW1FRUVFRU5TMl8xOXJlY29yZF9kZWNvbXByZXNzb3JJSk5TMl81ZmllbGRJTlMyXzNsYXM3cG9pbnQxMEVOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElTRl9FRUVFTlNEX0lOU0VfN2dwc3RpbWVFTlNHX0lTSl9FRUVFTlNEX0lOU0VfM3JnYkVOU0dfSVNNX0VFRUVFRUVFRU5TXzE0ZGVmYXVsdF9kZWxldGVJU1FfRUVOU185YWxsb2NhdG9ySVNRX0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJTjZsYXN6aXA3Zm9ybWF0czIxZHluYW1pY19kZWNvbXByZXNzb3IxSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJTlMxXzJpbzE4X19pZnN0cmVhbV93cmFwcGVySU5TMV83c3RyZWFtczEzbWVtb3J5X3N0cmVhbUVFRUVFTlMyXzE5cmVjb3JkX2RlY29tcHJlc3NvcklKTlMyXzVmaWVsZElOUzJfM2xhczdwb2ludDEwRU5TMl8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSVNGX0VFRUVOU0RfSU5TRV83Z3BzdGltZUVOU0dfSVNKX0VFRUVOU0RfSU5TRV8zcmdiRU5TR19JU01fRUVFRUVFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUDEwYnVmX3N0cmVhbU5TXzE0ZGVmYXVsdF9kZWxldGVJUzFfRUVOU185YWxsb2NhdG9ySVMxX0VFRUUATlN0M19fMjE0ZGVmYXVsdF9kZWxldGVJMTBidWZfc3RyZWFtRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTNV9FRU5TXzlhbGxvY2F0b3JJUzVfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZmllbGRfZGVjb21wcmVzc29ySU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRUVFAE5TdDNfXzIyMF9fc2hhcmVkX3B0cl9wb2ludGVySVBONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2ZpZWxkX2RlY29tcHJlc3NvcklOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFRUVOU18xNGRlZmF1bHRfZGVsZXRlSVM4X0VFTlNfOWFsbG9jYXRvcklTOF9FRUVFAE5TdDNfXzIxNGRlZmF1bHRfZGVsZXRlSU42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZmllbGRfZGVjb21wcmVzc29ySU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRU5TMF81ZmllbGRJaU5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSWlFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVOUzJfNWZpZWxkSWlOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElpRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTQ19FRU5TXzlhbGxvY2F0b3JJU0NfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlMyXzVmaWVsZElpTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJaUVFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRU5TMF81ZmllbGRJak5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSWpFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVOUzJfNWZpZWxkSWpOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElqRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTQ19FRU5TXzlhbGxvY2F0b3JJU0NfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlMyXzVmaWVsZElqTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJakVFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRU5TMF81ZmllbGRJYU5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSWFFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVOUzJfNWZpZWxkSWFOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElhRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTQ19FRU5TXzlhbGxvY2F0b3JJU0NfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlMyXzVmaWVsZElhTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJYUVFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRU5TMF81ZmllbGRJc05TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSXNFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVOUzJfNWZpZWxkSXNOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZElzRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTQ19FRU5TXzlhbGxvY2F0b3JJU0NfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlMyXzVmaWVsZElzTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJc0VFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRU5TMF81ZmllbGRJaE5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSWhFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVOUzJfNWZpZWxkSWhOUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZEloRUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTQ19FRU5TXzlhbGxvY2F0b3JJU0NfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlMyXzVmaWVsZEloTlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJaEVFRUVFRUVFAE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TXzhkZWNvZGVyczEwYXJpdGhtZXRpY0kxMGJ1Zl9zdHJlYW1FRU5TMF81ZmllbGRJdE5TMF8yMHN0YW5kYXJkX2RpZmZfbWV0aG9kSXRFRUVFRUUATlN0M19fMjIwX19zaGFyZWRfcHRyX3BvaW50ZXJJUE42bGFzemlwN2Zvcm1hdHMyNmR5bmFtaWNfZGVjb21wcmVzc29yX2ZpZWxkSU5TMV84ZGVjb2RlcnMxMGFyaXRobWV0aWNJMTBidWZfc3RyZWFtRUVOUzJfNWZpZWxkSXROUzJfMjBzdGFuZGFyZF9kaWZmX21ldGhvZEl0RUVFRUVFTlNfMTRkZWZhdWx0X2RlbGV0ZUlTQ19FRU5TXzlhbGxvY2F0b3JJU0NfRUVFRQBOU3QzX18yMTRkZWZhdWx0X2RlbGV0ZUlONmxhc3ppcDdmb3JtYXRzMjZkeW5hbWljX2RlY29tcHJlc3Nvcl9maWVsZElOUzFfOGRlY29kZXJzMTBhcml0aG1ldGljSTEwYnVmX3N0cmVhbUVFTlMyXzVmaWVsZEl0TlMyXzIwc3RhbmRhcmRfZGlmZl9tZXRob2RJdEVFRUVFRUVFADZMQVNaaXAAUDZMQVNaaXAAUEs2TEFTWmlwAGlpAHYAdmkAdmlpaWkAdmlpaQBpaWkAMTNEeW5hbWljTEFTWmlwAFAxM0R5bmFtaWNMQVNaaXAAUEsxM0R5bmFtaWNMQVNaaXAAdm9pZABib29sAGNoYXIAc2lnbmVkIGNoYXIAdW5zaWduZWQgY2hhcgBzaG9ydAB1bnNpZ25lZCBzaG9ydABpbnQAdW5zaWduZWQgaW50AGxvbmcAdW5zaWduZWQgbG9uZwBmbG9hdABkb3VibGUAc3RkOjpzdHJpbmcAc3RkOjpiYXNpY19zdHJpbmc8dW5zaWduZWQgY2hhcj4Ac3RkOjp3c3RyaW5nAHN0ZDo6dTE2c3RyaW5nAHN0ZDo6dTMyc3RyaW5nAGVtc2NyaXB0ZW46OnZhbABlbXNjcmlwdGVuOjptZW1vcnlfdmlldzxjaGFyPgBlbXNjcmlwdGVuOjptZW1vcnlfdmlldzxzaWduZWQgY2hhcj4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8dW5zaWduZWQgY2hhcj4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8c2hvcnQ+AGVtc2NyaXB0ZW46Om1lbW9yeV92aWV3PHVuc2lnbmVkIHNob3J0PgBlbXNjcmlwdGVuOjptZW1vcnlfdmlldzxpbnQ+AGVtc2NyaXB0ZW46Om1lbW9yeV92aWV3PHVuc2lnbmVkIGludD4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8bG9uZz4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8dW5zaWduZWQgbG9uZz4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8aW50OF90PgBlbXNjcmlwdGVuOjptZW1vcnlfdmlldzx1aW50OF90PgBlbXNjcmlwdGVuOjptZW1vcnlfdmlldzxpbnQxNl90PgBlbXNjcmlwdGVuOjptZW1vcnlfdmlldzx1aW50MTZfdD4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8aW50MzJfdD4AZW1zY3JpcHRlbjo6bWVtb3J5X3ZpZXc8dWludDMyX3Q+AGVtc2NyaXB0ZW46Om1lbW9yeV92aWV3PGZsb2F0PgBlbXNjcmlwdGVuOjptZW1vcnlfdmlldzxkb3VibGU+AGVtc2NyaXB0ZW46Om1lbW9yeV92aWV3PGxvbmcgZG91YmxlPgBOMTBlbXNjcmlwdGVuMTFtZW1vcnlfdmlld0llRUUATjEwZW1zY3JpcHRlbjExbWVtb3J5X3ZpZXdJZEVFAE4xMGVtc2NyaXB0ZW4xMW1lbW9yeV92aWV3SWZFRQBOMTBlbXNjcmlwdGVuMTFtZW1vcnlfdmlld0ltRUUATjEwZW1zY3JpcHRlbjExbWVtb3J5X3ZpZXdJbEVFAE4xMGVtc2NyaXB0ZW4xMW1lbW9yeV92aWV3SWpFRQBOMTBlbXNjcmlwdGVuMTFtZW1vcnlfdmlld0lpRUUATjEwZW1zY3JpcHRlbjExbWVtb3J5X3ZpZXdJdEVFAE4xMGVtc2NyaXB0ZW4xMW1lbW9yeV92aWV3SXNFRQBOMTBlbXNjcmlwdGVuMTFtZW1vcnlfdmlld0loRUUATjEwZW1zY3JpcHRlbjExbWVtb3J5X3ZpZXdJYUVFAE4xMGVtc2NyaXB0ZW4xMW1lbW9yeV92aWV3SWNFRQBOMTBlbXNjcmlwdGVuM3ZhbEUATlN0M19fMjEyYmFzaWNfc3RyaW5nSURpTlNfMTFjaGFyX3RyYWl0c0lEaUVFTlNfOWFsbG9jYXRvcklEaUVFRUUATlN0M19fMjIxX19iYXNpY19zdHJpbmdfY29tbW9uSUxiMUVFRQBOU3QzX18yMTJiYXNpY19zdHJpbmdJRHNOU18xMWNoYXJfdHJhaXRzSURzRUVOU185YWxsb2NhdG9ySURzRUVFRQBOU3QzX18yMTJiYXNpY19zdHJpbmdJd05TXzExY2hhcl90cmFpdHNJd0VFTlNfOWFsbG9jYXRvckl3RUVFRQBOU3QzX18yMTJiYXNpY19zdHJpbmdJaE5TXzExY2hhcl90cmFpdHNJaEVFTlNfOWFsbG9jYXRvckloRUVFRQBOU3QzX18yMTJiYXNpY19zdHJpbmdJY05TXzExY2hhcl90cmFpdHNJY0VFTlNfOWFsbG9jYXRvckljRUVFRQAtKyAgIDBYMHgAKG51bGwpAC0wWCswWCAwWC0weCsweCAweABpbmYASU5GAG5hbgBOQU4ALgB0ZXJtaW5hdGluZyB3aXRoICVzIGV4Y2VwdGlvbiBvZiB0eXBlICVzOiAlcwB0ZXJtaW5hdGluZyB3aXRoICVzIGV4Y2VwdGlvbiBvZiB0eXBlICVzAHRlcm1pbmF0aW5nIHdpdGggJXMgZm9yZWlnbiBleGNlcHRpb24AdGVybWluYXRpbmcAdW5jYXVnaHQAU3Q5ZXhjZXB0aW9uAE4xMF9fY3h4YWJpdjExNl9fc2hpbV90eXBlX2luZm9FAFN0OXR5cGVfaW5mbwBOMTBfX2N4eGFiaXYxMjBfX3NpX2NsYXNzX3R5cGVfaW5mb0UATjEwX19jeHhhYml2MTE3X19jbGFzc190eXBlX2luZm9FAHRlcm1pbmF0ZV9oYW5kbGVyIHVuZXhwZWN0ZWRseSByZXR1cm5lZABzdGQ6OmJhZF9hbGxvYwBTdDliYWRfYWxsb2MAU3QxMWxvZ2ljX2Vycm9yAFN0MTNydW50aW1lX2Vycm9yAFN0MTJsZW5ndGhfZXJyb3IAU3QxMm91dF9vZl9yYW5nZQBOMTBfX2N4eGFiaXYxMTdfX3BiYXNlX3R5cGVfaW5mb0UATjEwX19jeHhhYml2MTE5X19wb2ludGVyX3R5cGVfaW5mb0UATjEwX19jeHhhYml2MTIwX19mdW5jdGlvbl90eXBlX2luZm9FAE4xMF9fY3h4YWJpdjEyOV9fcG9pbnRlcl90b19tZW1iZXJfdHlwZV9pbmZvRQBQdXJlIHZpcnR1YWwgZnVuY3Rpb24gY2FsbGVkIQBOMTBfX2N4eGFiaXYxMjNfX2Z1bmRhbWVudGFsX3R5cGVfaW5mb0UAdgBEbgBiAGMAaABhAHMAdABpAGoAbABtAGYAZABOMTBfX2N4eGFiaXYxMjFfX3ZtaV9jbGFzc190eXBlX2luZm9FAF9fY3hhX2d1YXJkX2FjcXVpcmUgZGV0ZWN0ZWQgcmVjdXJzaXZlIGluaXRpYWxpemF0aW9uAHN0ZDo6YmFkX2Z1bmN0aW9uX2NhbGwATlN0M19fMjE3YmFkX2Z1bmN0aW9uX2NhbGxFAE5TdDNfXzIxNF9fc2hhcmVkX2NvdW50RQBOU3QzX18yMTlfX3NoYXJlZF93ZWFrX2NvdW50RQBtdXRleCBsb2NrIGZhaWxlZABiYXNpY19zdHJpbmcAdW5zcGVjaWZpZWQgZ2VuZXJpY19jYXRlZ29yeSBlcnJvcgBVbmtub3duIGVycm9yICVkAGdlbmVyaWMATlN0M19fMjI0X19nZW5lcmljX2Vycm9yX2NhdGVnb3J5RQBOU3QzX18yMTJfX2RvX21lc3NhZ2VFAE5TdDNfXzIxNGVycm9yX2NhdGVnb3J5RQB1bnNwZWNpZmllZCBzeXN0ZW1fY2F0ZWdvcnkgZXJyb3IAc3lzdGVtAE5TdDNfXzIyM19fc3lzdGVtX2Vycm9yX2NhdGVnb3J5RQBOU3QzX18yMTJzeXN0ZW1fZXJyb3JFADogAHZlY3Rvcg==";var Z={};function J(e){e&&Z[e].refcount++}function Y(e){if(!e||Z[e])return e;for(var t in Z)for(var i=+t,s=Z[i].adjusted,r=s.length,o=0;o<r;o++)if(s[o]===e)return i;return e}function q(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}var $=void 0;function ee(e){for(var t="",i=e;w[i];)t+=$[w[i++]];return t}var te={},ie={},se={};function re(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=48&&t<=57?"_"+e:e}function oe(e,t){return e=re(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function ne(e,t){var i=oe(t,(function(e){this.name=t,this.message=e;var i=new Error(e).stack;void 0!==i&&(this.stack=this.toString()+"\n"+i.replace(/^Error(:[^\n]*)?\n/,""))}));return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},i}var ae=void 0;function le(e){throw new ae(e)}var Ae=void 0;function ce(e){throw new Ae(e)}function he(e,t,i){function s(t){var s=i(t);s.length!==e.length&&ce("Mismatched type converter count");for(var r=0;r<e.length;++r)ue(e[r],s[r])}e.forEach((function(e){se[e]=t}));var r=new Array(t.length),o=[],n=0;t.forEach((function(e,t){ie.hasOwnProperty(e)?r[t]=ie[e]:(o.push(e),te.hasOwnProperty(e)||(te[e]=[]),te[e].push((function(){r[t]=ie[e],++n===o.length&&s(r)})))})),0===o.length&&s(r)}function ue(e,t,i){if(i=i||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var s=t.name;if(e||le('type "'+s+'" must have a positive integer typeid pointer'),ie.hasOwnProperty(e)){if(i.ignoreDuplicateRegistrations)return;le("Cannot register type '"+s+"' twice")}if(ie[e]=t,delete se[e],te.hasOwnProperty(e)){var r=te[e];delete te[e],r.forEach((function(e){e()}))}}function de(e){if(!(this instanceof Ce))return!1;if(!(e instanceof Ce))return!1;for(var t=this.$$.ptrType.registeredClass,i=this.$$.ptr,s=e.$$.ptrType.registeredClass,r=e.$$.ptr;t.baseClass;)i=t.upcast(i),t=t.baseClass;for(;s.baseClass;)r=s.upcast(r),s=s.baseClass;return t===s&&i===r}function pe(e){le(e.$$.ptrType.registeredClass.name+" instance already deleted")}var fe=!1;function me(e){}function ge(e){e.count.value-=1,0===e.count.value&&function(e){e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr)}(e)}function _e(e){return"undefined"==typeof FinalizationGroup?(_e=function(e){return e},e):(fe=new FinalizationGroup((function(e){for(var t=e.next();!t.done;t=e.next()){var i=t.value;i.ptr?ge(i):console.warn("object already deleted: "+i.ptr)}})),_e=function(e){return fe.register(e,e.$$,e.$$),e},me=function(e){fe.unregister(e.$$)},_e(e))}function ve(){if(this.$$.ptr||pe(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var e,t=_e(Object.create(Object.getPrototypeOf(this),{$$:{value:(e=this.$$,{count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType})}}));return t.$$.count.value+=1,t.$$.deleteScheduled=!1,t}function be(){this.$$.ptr||pe(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&le("Object already scheduled for deletion"),me(this),ge(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)}function ye(){return!this.$$.ptr}var we=void 0,Be=[];function Pe(){for(;Be.length;){var e=Be.pop();e.$$.deleteScheduled=!1,e.delete()}}function xe(){return this.$$.ptr||pe(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&le("Object already scheduled for deletion"),Be.push(this),1===Be.length&&we&&we(Pe),this.$$.deleteScheduled=!0,this}function Ce(){}var Me={};function Ee(e,t,i){if(void 0===e[t].overloadTable){var s=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||le("Function '"+i+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[s.argCount]=s}}function Fe(e,t,i,s,r,o,n,a){this.name=e,this.constructor=t,this.instancePrototype=i,this.rawDestructor=s,this.baseClass=r,this.getActualType=o,this.upcast=n,this.downcast=a,this.pureVirtualFunctions=[]}function Ie(e,t,i){for(;t!==i;)t.upcast||le("Expected null or instance of "+i.name+", got an instance of "+t.name),e=t.upcast(e),t=t.baseClass;return e}function Te(e,t){if(null===t)return this.isReference&&le("null is not a valid "+this.name),0;t.$$||le('Cannot pass "'+nt(t)+'" as a '+this.name),t.$$.ptr||le("Cannot pass deleted object as a pointer of type "+this.name);var i=t.$$.ptrType.registeredClass;return Ie(t.$$.ptr,i,this.registeredClass)}function De(e,t){var i;if(null===t)return this.isReference&&le("null is not a valid "+this.name),this.isSmartPointer?(i=this.rawConstructor(),null!==e&&e.push(this.rawDestructor,i),i):0;t.$$||le('Cannot pass "'+nt(t)+'" as a '+this.name),t.$$.ptr||le("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&t.$$.ptrType.isConst&&le("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);var s=t.$$.ptrType.registeredClass;if(i=Ie(t.$$.ptr,s,this.registeredClass),this.isSmartPointer)switch(void 0===t.$$.smartPtr&&le("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?i=t.$$.smartPtr:le("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:i=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)i=t.$$.smartPtr;else{var r=t.clone();i=this.rawShare(i,ot((function(){r.delete()}))),null!==e&&e.push(this.rawDestructor,i)}break;default:le("Unsupporting sharing policy")}return i}function Se(e,t){if(null===t)return this.isReference&&le("null is not a valid "+this.name),0;t.$$||le('Cannot pass "'+nt(t)+'" as a '+this.name),t.$$.ptr||le("Cannot pass deleted object as a pointer of type "+this.name),t.$$.ptrType.isConst&&le("Cannot convert argument of type "+t.$$.ptrType.name+" to parameter type "+this.name);var i=t.$$.ptrType.registeredClass;return Ie(t.$$.ptr,i,this.registeredClass)}function Re(e){return this.fromWireType(C[e>>2])}function Ue(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e}function Le(e){this.rawDestructor&&this.rawDestructor(e)}function ke(e){null!==e&&e.delete()}function Oe(e,t,i){if(t===i)return e;if(void 0===i.baseClass)return null;var s=Oe(e,t,i.baseClass);return null===s?null:i.downcast(s)}function Ne(){return Object.keys(He).length}function Ve(){var e=[];for(var t in He)He.hasOwnProperty(t)&&e.push(He[t]);return e}function Qe(e){we=e,Be.length&&we&&we(Pe)}var He={};function je(e,t){return t=function(e,t){for(void 0===t&&le("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t}(e,t),He[t]}function Ge(e,t){return t.ptrType&&t.ptr||ce("makeClassHandle requires ptr and ptrType"),!!t.smartPtrType!==!!t.smartPtr&&ce("Both smartPtrType and smartPtr must be specified"),t.count={value:1},_e(Object.create(e,{$$:{value:t}}))}function ze(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var i=je(this.registeredClass,t);if(void 0!==i){if(0===i.$$.count.value)return i.$$.ptr=t,i.$$.smartPtr=e,i.clone();var s=i.clone();return this.destructor(e),s}function r(){return this.isSmartPointer?Ge(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):Ge(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var o,n=this.registeredClass.getActualType(t),a=Me[n];if(!a)return r.call(this);o=this.isConst?a.constPointerType:a.pointerType;var l=Oe(t,this.registeredClass,o.registeredClass);return null===l?r.call(this):this.isSmartPointer?Ge(o.registeredClass.instancePrototype,{ptrType:o,ptr:l,smartPtrType:this,smartPtr:e}):Ge(o.registeredClass.instancePrototype,{ptrType:o,ptr:l})}function We(e,t,i,s,r,o,n,a,l,A,c){this.name=e,this.registeredClass=t,this.isReference=i,this.isConst=s,this.isSmartPointer=r,this.pointeeType=o,this.sharingPolicy=n,this.rawGetPointee=a,this.rawConstructor=l,this.rawShare=A,this.rawDestructor=c,r||void 0!==t.baseClass?this.toWireType=De:s?(this.toWireType=Te,this.destructorFunction=null):(this.toWireType=Se,this.destructorFunction=null)}function Xe(e,i){e=ee(e);var s=function(t){for(var s=[],r=1;r<e.length;++r)s.push("a"+r);var o="return function "+("dynCall_"+e+"_"+i)+"("+s.join(", ")+") {\n";return o+="    return dynCall(rawFunction"+(s.length?", ":"")+s.join(", ")+");\n",o+="};\n",new Function("dynCall","rawFunction",o)(t,i)}(t["dynCall_"+e]);return"function"!=typeof s&&le("unknown function pointer with signature "+e+": "+i),s}var Ke=void 0;function Ze(e){var t=ft(e),i=ee(t);return mt(t),i}function Je(e,t){var i=[],s={};throw t.forEach((function e(t){s[t]||ie[t]||(se[t]?se[t].forEach(e):(i.push(t),s[t]=!0))})),new Ke(e+": "+i.map(Ze).join([", "]))}function Ye(e,t){for(var i=[],s=0;s<e;s++)i.push(x[(t>>2)+s]);return i}function qe(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function $e(e,t,i,s,r){var o=t.length;o<2&&le("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var n=null!==t[1]&&null!==i,a=!1,l=1;l<t.length;++l)if(null!==t[l]&&void 0===t[l].destructorFunction){a=!0;break}var A="void"!==t[0].name,c="",h="";for(l=0;l<o-2;++l)c+=(0!==l?", ":"")+"arg"+l,h+=(0!==l?", ":"")+"arg"+l+"Wired";var u="return function "+re(e)+"("+c+") {\nif (arguments.length !== "+(o-2)+") {\nthrowBindingError('function "+e+" called with ' + arguments.length + ' arguments, expected "+(o-2)+" args!');\n}\n";a&&(u+="var destructors = [];\n");var d=a?"destructors":"null",p=["throwBindingError","invoker","fn","runDestructors","retType","classParam"],f=[le,s,r,qe,t[0],t[1]];n&&(u+="var thisWired = classParam.toWireType("+d+", this);\n");for(l=0;l<o-2;++l)u+="var arg"+l+"Wired = argType"+l+".toWireType("+d+", arg"+l+"); // "+t[l+2].name+"\n",p.push("argType"+l),f.push(t[l+2]);if(n&&(h="thisWired"+(h.length>0?", ":"")+h),u+=(A?"var rv = ":"")+"invoker(fn"+(h.length>0?", ":"")+h+");\n",a)u+="runDestructors(destructors);\n";else for(l=n?1:2;l<t.length;++l){var m=1===l?"thisWired":"arg"+(l-2)+"Wired";null!==t[l].destructorFunction&&(u+=m+"_dtor("+m+"); // "+t[l].name+"\n",p.push(m+"_dtor"),f.push(t[l].destructorFunction))}return A&&(u+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),u+="}\n",p.push(u),function(e,t){if(!(e instanceof Function))throw new TypeError("new_ called with constructor type "+typeof e+" which is not a function");var i=oe(e.name||"unknownFunctionName",(function(){}));i.prototype=e.prototype;var s=new i,r=e.apply(s,t);return r instanceof Object?r:s}(Function,p).apply(null,f)}var et=[],tt=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function it(e){e>4&&0==--tt[e].refcount&&(tt[e]=void 0,et.push(e))}function st(){for(var e=0,t=5;t<tt.length;++t)void 0!==tt[t]&&++e;return e}function rt(){for(var e=5;e<tt.length;++e)if(void 0!==tt[e])return tt[e];return null}function ot(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=et.length?et.pop():tt.length;return tt[t]={refcount:1,value:e},t}}function nt(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}function at(e,t){switch(t){case 2:return function(e){return this.fromWireType(M[e>>2])};case 3:return function(e){return this.fromWireType(E[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function lt(e,t,i){switch(t){case 0:return i?function(e){return y[e]}:function(e){return w[e]};case 1:return i?function(e){return B[e>>1]}:function(e){return P[e>>1]};case 2:return i?function(e){return x[e>>2]}:function(e){return C[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function At(e){for(var t=[],i=0;i<e.length;i++){var s=e[i];s>255&&(s&=255),t.push(String.fromCharCode(s))}return t.join("")}!function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);$=e}(),ae=t.BindingError=ne(Error,"BindingError"),Ae=t.InternalError=ne(Error,"InternalError"),Ce.prototype.isAliasOf=de,Ce.prototype.clone=ve,Ce.prototype.delete=be,Ce.prototype.isDeleted=ye,Ce.prototype.deleteLater=xe,We.prototype.getPointee=Ue,We.prototype.destructor=Le,We.prototype.argPackAdvance=8,We.prototype.readValueFromPointer=Re,We.prototype.deleteObject=ke,We.prototype.fromWireType=ze,t.getInheritedInstanceCount=Ne,t.getLiveInheritedInstances=Ve,t.flushPendingDeletes=Pe,t.setDelayFunction=Qe,Ke=t.UnboundTypeError=ne(Error,"UnboundTypeError"),t.count_emval_handles=st,t.get_first_emval=rt;var ct="function"==typeof atob?atob:function(e){var t,i,s,r,o,n,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l="",A=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{t=a.indexOf(e.charAt(A++))<<2|(r=a.indexOf(e.charAt(A++)))>>4,i=(15&r)<<4|(o=a.indexOf(e.charAt(A++)))>>2,s=(3&o)<<6|(n=a.indexOf(e.charAt(A++))),l+=String.fromCharCode(t),64!==o&&(l+=String.fromCharCode(i)),64!==n&&(l+=String.fromCharCode(s))}while(A<e.length);return l};function ht(e){if(K(e))return function(e){if("boolean"==typeof o&&o){var t;try{t=Buffer.from(e,"base64")}catch(i){t=new Buffer(e,"base64")}return new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}try{for(var i=ct(e),s=new Uint8Array(i.length),r=0;r<i.length;++r)s[r]=i.charCodeAt(r);return s}catch(e){throw new Error("Converting base64 string to bytes failed.")}}(e.slice(X.length))}var ut={A:function(e,t,i){w.copyWithin(e,t,t+i)},B:function(e){z("OOM")},C:function(){z("trap!")},D:22368,a:z,b:function(e){f=e},c:function(){return f},d:function(e){return gt(e)},e:function(e){var t=Z[e];return t&&!t.caught&&(t.caught=!0,pt.uncaught_exceptions--),t&&(t.rethrown=!1),J(Y(e)),e},f:function(e,t,i){throw Z[e]={ptr:e,adjusted:[e],type:t,destructor:i,refcount:0,caught:!1,rethrown:!1},"uncaught_exception"in pt?pt.uncaught_exceptions++:pt.uncaught_exceptions=1,e},g:function(){return pt.uncaught_exceptions},h:J,i:Y,j:function(){},k:function(e,t,i,s,r){var o=q(i);ue(e,{name:t=ee(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?s:r},argPackAdvance:8,readValueFromPointer:function(e){var s;if(1===i)s=y;else if(2===i)s=B;else{if(4!==i)throw new TypeError("Unknown boolean type size: "+t);s=x}return this.fromWireType(s[e>>o])},destructorFunction:null})},l:function(e,i,s,r,o,n,a,l,A,c,h,u,d){h=ee(h),n=Xe(o,n),l&&(l=Xe(a,l)),c&&(c=Xe(A,c)),d=Xe(u,d);var p=re(h);!function(e,i,s){t.hasOwnProperty(e)?((void 0===s||void 0!==t[e].overloadTable&&void 0!==t[e].overloadTable[s])&&le("Cannot register public name '"+e+"' twice"),Ee(t,e,e),t.hasOwnProperty(s)&&le("Cannot register multiple overloads of a function with the same number of arguments ("+s+")!"),t[e].overloadTable[s]=i):(t[e]=i,void 0!==s&&(t[e].numArguments=s))}(p,(function(){Je("Cannot construct "+h+" due to unbound types",[r])})),he([e,i,s],r?[r]:[],(function(i){var s,o;i=i[0],o=r?(s=i.registeredClass).instancePrototype:Ce.prototype;var a=oe(p,(function(){if(Object.getPrototypeOf(this)!==A)throw new ae("Use 'new' to construct "+h);if(void 0===u.constructor_body)throw new ae(h+" has no accessible constructor");var e=u.constructor_body[arguments.length];if(void 0===e)throw new ae("Tried to invoke ctor of "+h+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(u.constructor_body).toString()+") parameters instead!");return e.apply(this,arguments)})),A=Object.create(o,{constructor:{value:a}});a.prototype=A;var u=new Fe(h,a,A,d,s,n,l,c),f=new We(h,u,!0,!1,!1),m=new We(h+"*",u,!1,!1,!1),g=new We(h+" const*",u,!1,!0,!1);return Me[e]={pointerType:m,constPointerType:g},function(e,i,s){t.hasOwnProperty(e)||ce("Replacing nonexistant public symbol"),void 0!==t[e].overloadTable&&void 0!==s?t[e].overloadTable[s]=i:(t[e]=i,t[e].argCount=s)}(p,a),[f,m,g]}))},m:function(e,t,i,s,r,o){g(t>0);var n=Ye(t,i);r=Xe(s,r);var a=[o],l=[];he([],[e],(function(e){var i="constructor "+(e=e[0]).name;if(void 0===e.registeredClass.constructor_body&&(e.registeredClass.constructor_body=[]),void 0!==e.registeredClass.constructor_body[t-1])throw new ae("Cannot register multiple constructors with identical number of parameters ("+(t-1)+") for class '"+e.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return e.registeredClass.constructor_body[t-1]=function(){Je("Cannot construct "+e.name+" due to unbound types",n)},he([],n,(function(s){return e.registeredClass.constructor_body[t-1]=function(){arguments.length!==t-1&&le(i+" called with "+arguments.length+" arguments, expected "+(t-1)),l.length=0,a.length=t;for(var e=1;e<t;++e)a[e]=s[e].toWireType(l,arguments[e-1]);var o=r.apply(null,a);return qe(l),s[0].fromWireType(o)},[]})),[]}))},n:function(e,t,i,s,r,o,n,a){var l=Ye(i,s);t=ee(t),o=Xe(r,o),he([],[e],(function(e){var s=(e=e[0]).name+"."+t;function r(){Je("Cannot call "+s+" due to unbound types",l)}a&&e.registeredClass.pureVirtualFunctions.push(t);var A=e.registeredClass.instancePrototype,c=A[t];return void 0===c||void 0===c.overloadTable&&c.className!==e.name&&c.argCount===i-2?(r.argCount=i-2,r.className=e.name,A[t]=r):(Ee(A,t,s),A[t].overloadTable[i-2]=r),he([],l,(function(r){var a=$e(s,r,e,o,n);return void 0===A[t].overloadTable?(a.argCount=i-2,A[t]=a):A[t].overloadTable[i-2]=a,[]})),[]}))},o:function(e,t){ue(e,{name:t=ee(t),fromWireType:function(e){var t=tt[e].value;return it(e),t},toWireType:function(e,t){return ot(t)},argPackAdvance:8,readValueFromPointer:Re,destructorFunction:null})},p:function(e,t,i){var s=q(i);ue(e,{name:t=ee(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+nt(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:at(t,s),destructorFunction:null})},q:function(e,t,i,s,r){t=ee(t),-1===r&&(r=4294967295);var o=q(i),n=function(e){return e};if(0===s){var a=32-8*i;n=function(e){return e<<a>>>a}}var l=-1!=t.indexOf("unsigned");ue(e,{name:t,fromWireType:n,toWireType:function(e,i){if("number"!=typeof i&&"boolean"!=typeof i)throw new TypeError('Cannot convert "'+nt(i)+'" to '+this.name);if(i<s||i>r)throw new TypeError('Passing a number "'+nt(i)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+s+", "+r+"]!");return l?i>>>0:0|i},argPackAdvance:8,readValueFromPointer:lt(t,o,0!==s),destructorFunction:null})},r:function(e,t,i){var s=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function r(e){var t=C,i=t[e>>=2],r=t[e+1];return new s(b,r,i)}ue(e,{name:i=ee(i),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{ignoreDuplicateRegistrations:!0})},s:function(e,t){var i="std::string"===(t=ee(t));ue(e,{name:t,fromWireType:function(e){var t,s=C[e>>2];if(i)for(var r=e+4,o=0;o<=s;++o){var n=e+4+o;if(0==w[n]||o==s){var a=v(r,n-r);void 0===t?t=a:(t+=String.fromCharCode(0),t+=a),r=n+1}}else{var l=new Array(s);for(o=0;o<s;++o)l[o]=String.fromCharCode(w[e+4+o]);t=l.join("")}return mt(e),t},toWireType:function(e,t){var s;t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r="string"==typeof t;r||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||le("Cannot pass non-string to std::string"),s=i&&r?function(){return function(e){for(var t=0,i=0;i<e.length;++i){var s=e.charCodeAt(i);s>=55296&&s<=57343&&(s=65536+((1023&s)<<10)|1023&e.charCodeAt(++i)),s<=127?++t:t+=s<=2047?2:s<=65535?3:4}return t}(t)}:function(){return t.length};var o=s(),n=gt(4+o+1);if(C[n>>2]=o,i&&r)(function(e,t,i,s){if(!(s>0))return 0;for(var r=i,o=i+s-1,n=0;n<e.length;++n){var a=e.charCodeAt(n);if(a>=55296&&a<=57343&&(a=65536+((1023&a)<<10)|1023&e.charCodeAt(++n)),a<=127){if(i>=o)break;t[i++]=a}else if(a<=2047){if(i+1>=o)break;t[i++]=192|a>>6,t[i++]=128|63&a}else if(a<=65535){if(i+2>=o)break;t[i++]=224|a>>12,t[i++]=128|a>>6&63,t[i++]=128|63&a}else{if(i+3>=o)break;t[i++]=240|a>>18,t[i++]=128|a>>12&63,t[i++]=128|a>>6&63,t[i++]=128|63&a}}t[i]=0})(t,w,n+4,o+1);else if(r)for(var a=0;a<o;++a){var l=t.charCodeAt(a);l>255&&(mt(n),le("String has UTF-16 code units that do not fit in 8 bits")),w[n+4+a]=l}else for(a=0;a<o;++a)w[n+4+a]=t[a];return null!==e&&e.push(mt,n),n},argPackAdvance:8,readValueFromPointer:Re,destructorFunction:function(e){mt(e)}})},t:function(e,t,i){var s,r,o,n,a;i=ee(i),2===t?(s=I,r=T,n=D,o=function(){return P},a=1):4===t&&(s=S,r=R,n=U,o=function(){return C},a=2),ue(e,{name:i,fromWireType:function(e){for(var i,r=C[e>>2],n=o(),l=e+4,A=0;A<=r;++A){var c=e+4+A*t;if(0==n[c>>a]||A==r){var h=s(l,c-l);void 0===i?i=h:(i+=String.fromCharCode(0),i+=h),l=c+t}}return mt(e),i},toWireType:function(e,s){"string"!=typeof s&&le("Cannot pass non-string to C++ string type "+i);var o=n(s),l=gt(4+o+t);return C[l>>2]=o>>a,r(s,l+4,o+t),null!==e&&e.push(mt,l),l},argPackAdvance:8,readValueFromPointer:Re,destructorFunction:function(e){mt(e)}})},u:function(e,t){ue(e,{isVoid:!0,name:t=ee(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}})},v:it,w:ot,x:function(){z()},y:nt,z:function(){return w.length}},dt=function(e,t,i){"use asm";var s=new e.Int8Array(i),r=new e.Int16Array(i),o=new e.Int32Array(i),n=new e.Uint8Array(i),a=new e.Uint16Array(i),l=new e.Float32Array(i),A=new e.Float64Array(i),c=t.D|0,h=0,u=0,d=0,p=0,f=0,m=0,g=0,_=0.0,v=e.Math.imul,b=e.Math.clz32,y=t.a,w=t.b,B=t.c,P=t.d,x=t.e,C=t.f,M=t.g,E=t.h,F=t.i,I=t.j,T=t.k,D=t.l,S=t.m,R=t.n,U=t.o,L=t.p,k=t.q,O=t.r,N=t.s,V=t.t,Q=t.u,H=t.v,j=t.w,G=t.x,z=t.y,W=t.z,X=t.A,K=t.B,Z=t.C,J=22384,Y=5265264,q=0.0;function $(){Jh();Yh()}function ee(){te(0);return}function te(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0;e=J;J=J+16|0;t=e+8|0;i=e;dc();u=fc()|0;n=mc()|0;r=_c()|0;a=vc()|0;l=bc()|0;A=yc()|0;c=Mc()|0;h=Ec()|0;s=Ec()|0;D(r|0,a|0,l|0,A|0,c|0,9,h|0,u|0,s|0,n|0,6204,Fc()|0,138);Tc(1);o[i>>2]=5;o[i+4>>2]=0;o[t>>2]=o[i>>2];o[t+4>>2]=o[i+4>>2];Oc(6211,t);o[i>>2]=3;o[i+4>>2]=0;o[t>>2]=o[i>>2];o[t+4>>2]=o[i+4>>2];Kc(6216,t);o[i>>2]=10;o[i+4>>2]=0;o[t>>2]=o[i>>2];o[t+4>>2]=o[i+4>>2];ih(6225,t);ch();n=uh()|0;s=dh()|0;u=fh()|0;h=mh()|0;c=gh()|0;A=yc()|0;l=Mc()|0;a=Ec()|0;r=Ec()|0;D(u|0,h|0,c|0,A|0,l|0,11,a|0,n|0,r|0,s|0,6234,Fc()|0,139);Ph(2);o[i>>2]=6;o[i+4>>2]=0;o[t>>2]=o[i>>2];o[t+4>>2]=o[i+4>>2];Th(6211,t);o[i>>2]=4;o[i+4>>2]=0;o[t>>2]=o[i>>2];o[t+4>>2]=o[i+4>>2];Oh(6248,t);o[i>>2]=5;o[i+4>>2]=0;o[t>>2]=o[i>>2];o[t+4>>2]=o[i+4>>2];Oh(6265,t);o[i>>2]=6;o[i+4>>2]=0;o[t>>2]=o[i>>2];o[t+4>>2]=o[i+4>>2];Oh(6280,t);o[i>>2]=7;o[i+4>>2]=0;o[t>>2]=o[i>>2];o[t+4>>2]=o[i+4>>2];Gh(6216,t);J=e;return}function ie(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0,n=0,a=0,l=0;s=J;J=J+32|0;a=s+16|0;r=s+8|0;l=s;n=Zf(20)|0;ce(n,t,i);o[l>>2]=0;o[a>>2]=o[l>>2];ue(r,n,a);t=o[r>>2]|0;o[r>>2]=o[e>>2];o[e>>2]=t;t=r+4|0;i=e+4|0;n=o[t>>2]|0;o[t>>2]=o[i>>2];o[i>>2]=n;de(r);i=Zf(352)|0;he(i,o[e>>2]|0);n=e+8|0;o[l>>2]=0;o[a>>2]=o[l>>2];we(r,i,a);i=o[r>>2]|0;o[r>>2]=o[n>>2];o[n>>2]=i;n=r+4|0;i=e+12|0;t=o[n>>2]|0;o[n>>2]=o[i>>2];o[i>>2]=t;Be(r);J=s;return}function se(e,t){e=e|0;t=t|0;Ki(o[e+8>>2]|0,t);return}function re(e){e=e|0;e=(Ra(o[e+8>>2]|0)|0)+107|0;return n[e>>0]|n[e+1>>0]<<8|n[e+2>>0]<<16|n[e+3>>0]<<24|0}function oe(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0,n=0,a=0,l=0;s=J;J=J+32|0;n=s+16|0;r=s+8|0;a=s;l=Zf(12)|0;Ua(l,t,i);o[a>>2]=0;o[n>>2]=o[a>>2];Na(r,l,n);l=o[r>>2]|0;o[r>>2]=o[e>>2];o[e>>2]=l;l=r+4|0;i=e+4|0;t=o[l>>2]|0;o[l>>2]=o[i>>2];o[i>>2]=t;Va(r);i=e+8|0;t=Zf(12)|0;La(t,o[e>>2]|0);o[a>>2]=0;o[n>>2]=o[a>>2];Wa(r,t,n);t=o[r>>2]|0;o[r>>2]=o[i>>2];o[i>>2]=t;t=r+4|0;a=e+12|0;l=o[t>>2]|0;o[t>>2]=o[a>>2];o[a>>2]=l;Xa(r);ka(r,o[i>>2]|0);i=e+16|0;a=o[r>>2]|0;l=r+4|0;t=o[l>>2]|0;o[r>>2]=0;o[l>>2]=0;o[n>>2]=o[i>>2];o[i>>2]=a;i=e+20|0;o[n+4>>2]=o[i>>2];o[i>>2]=t;Oa(n);Oa(r);J=s;return}function ne(e,t){e=e|0;t=t|0;var i=0;e=e+16|0;i=o[e>>2]|0;e:do{if(i|0)switch(t|0){case 4:{ul(i);break e}case 8:{dl(i);dl(o[e>>2]|0);break e}default:break e}}while(0);return}function ae(e,t){e=e|0;t=t|0;var i=0;i=e+16|0;e=o[i>>2]|0;e:do{if(e|0){switch(t|0){case 1:{$l(e);break e}case 2:{eA(e);break e}case 8:{ul(e);e=o[i>>2]|0;break}case 4:break;default:break e}ul(e)}}while(0);return}function le(e,t){e=e|0;t=t|0;var i=0;i=e+16|0;e=o[i>>2]|0;e:do{if(e|0){switch(t|0){case 1:{UA(e);break e}case 2:{LA(e);break e}case 8:{dl(e);e=o[i>>2]|0;break}case 4:break;default:break e}dl(e)}}while(0);return}function Ae(e,t){e=e|0;t=t|0;e=o[e+16>>2]|0;if(e|0)Qg[o[o[e>>2]>>2]&63](e,t)|0;return}function ce(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=t;o[e+4>>2]=i;o[e+8>>2]=0;s[e+12>>0]=0;s[e+13>>0]=0;o[e+16>>2]=0;return}function he(e,t){e=e|0;t=t|0;o[e>>2]=t;Oe(e+4|0,t);Ne(e+247|0);o[e+288>>2]=0;o[e+292>>2]=0;o[e+296>>2]=0;Ve(e+300|0);t=e+312|0;o[t>>2]=0;o[t+4>>2]=0;o[t+8>>2]=0;o[t+12>>2]=0;Qe(e+328|0);He(e);return}function ue(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=4296;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;pe(e,s);J=i;return}function de(e){e=e|0;var t=0,i=0;e=o[e+4>>2]|0;if(e|0?(i=e+4|0,t=o[i>>2]|0,o[i>>2]=t+-1,(t|0)==0):0){Gg[o[(o[e>>2]|0)+8>>2]&255](e);am(e)}return}function pe(e,t){e=e|0;t=t|0;return}function fe(e){e=e|0;x(e|0)|0;tf()}function me(e){e=e|0;nm(e);$p(e);return}function ge(e){e=e|0;e=o[e+12>>2]|0;if(e|0)$p(e);return}function _e(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==6407?e+12|0:0)|0}function ve(e){e=e|0;be(e,16);return}function be(e,t){e=e|0;t=t|0;ye(e);return}function ye(e){e=e|0;$p(e);return}function we(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=4324;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Pe(e,s);J=i;return}function Be(e){e=e|0;var t=0,i=0;e=o[e+4>>2]|0;if(e|0?(i=e+4|0,t=o[i>>2]|0,o[i>>2]=t+-1,(t|0)==0):0){Gg[o[(o[e>>2]|0)+8>>2]&255](e);am(e)}return}function Pe(e,t){e=e|0;t=t|0;return}function xe(e){e=e|0;nm(e);$p(e);return}function Ce(e){e=e|0;e=o[e+12>>2]|0;if(e|0){Fe(e);$p(e)}return}function Me(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==6605?e+12|0:0)|0}function Ee(e){e=e|0;be(e,16);return}function Fe(e){e=e|0;Ie(e+320|0);Te(e+312|0);De(e+300|0);Le(e+288|0);Se(e+247|0);Re(e+4|0);return}function Ie(e){e=e|0;var t=0,i=0;e=o[e+4>>2]|0;if(e|0?(i=e+4|0,t=o[i>>2]|0,o[i>>2]=t+-1,(t|0)==0):0){Gg[o[(o[e>>2]|0)+8>>2]&255](e);am(e)}return}function Te(e){e=e|0;var t=0,i=0;e=o[e+4>>2]|0;if(e|0?(i=e+4|0,t=o[i>>2]|0,o[i>>2]=t+-1,(t|0)==0):0){Gg[o[(o[e>>2]|0)+8>>2]&255](e);am(e)}return}function De(e){e=e|0;Ue(e);return}function Se(e){e=e|0;e=e+34|0;e=n[e>>0]|n[e+1>>0]<<8|n[e+2>>0]<<16|n[e+3>>0]<<24;if(e|0)Yf(e);return}function Re(e){e=e|0;ke(o[e+12>>2]|0);return}function Ue(e){e=e|0;var t=0,i=0;t=o[e>>2]|0;i=t;if(t|0){o[e+4>>2]=i;be(t,(o[e+8>>2]|0)-i|0)}return}function Le(e){e=e|0;var t=0,i=0;t=o[e>>2]|0;i=t;if(t|0){o[e+4>>2]=i;be(t,(o[e+8>>2]|0)-i|0)}return}function ke(e){e=e|0;Zm(o[e+-4>>2]|0);return}function Oe(e,t){e=e|0;t=t|0;o[e>>2]=t;o[e+4>>2]=0;o[e+8>>2]=0;o[e+12>>2]=je(1048576)|0;return}function Ne(e){e=e|0;var t=0;t=e+32|0;s[t>>0]=0;s[t+1>>0]=0;e=e+34|0;s[e>>0]=0;s[e+1>>0]=0;s[e+2>>0]=0;s[e+3>>0]=0;return}function Ve(e){e=e|0;o[e>>2]=0;o[e+4>>2]=0;o[e+8>>2]=0;return}function Qe(e){e=e|0;o[e>>2]=0;o[e+4>>2]=0;o[e+8>>2]=0;o[e+12>>2]=0;e=e+16|0;o[e>>2]=-1;o[e+4>>2]=-1;return}function He(e){e=e|0;var t=0,i=0,r=0,n=0,a=0,l=0;l=J;J=J+64|0;n=l+32|0;i=l+56|0;t=l+16|0;a=l;Ge(o[e>>2]|0,i,4);st(n,i,i+4|0);i=it(6693)|0;r=s[n+11>>0]|0;if((i|0)==((r<<24>>24<0?o[n+4>>2]|0:r&255)|0)){r=(Pm(n,0,-1,6693,i)|0)==0;vm(n);if(r){i=o[e>>2]|0;o[t>>2]=0;o[t+4>>2]=0;o[t+8>>2]=0;o[t+12>>2]=0;o[n>>2]=o[t>>2];o[n+4>>2]=o[t+4>>2];o[n+8>>2]=o[t+8>>2];o[n+12>>2]=o[t+12>>2];We(i,n);i=e+20|0;Ge(o[e>>2]|0,i,227);Xe(e,i);r=Ke()|0;t=o[r>>2]|0;r=o[r+4>>2]|0;if((t|0)!=(r|0))do{Ze(n,t);Je(n,i);Ye(n);t=t+24|0}while((t|0)!=(r|0));qe(e);$e(e);et(o[e>>2]|0);r=o[e>>2]|0;t=(o[e+116>>2]|0)+8|0;i=a;o[i>>2]=0;o[i+4>>2]=0;i=a+8|0;o[i>>2]=t;o[i+4>>2]=0;o[n>>2]=o[a>>2];o[n+4>>2]=o[a+4>>2];o[n+8>>2]=o[a+8>>2];o[n+12>>2]=o[a+12>>2];We(r,n);tt(e+4|0);J=l;return}}else vm(n);l=P(8)|0;ze(l);C(l|0,2592,8)}function je(e){e=e|0;var t=0;t=Km(e+68|0)|0;e=t+68&-64;o[e+-4>>2]=t;return e|0}function Ge(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0,l=0,A=0,c=0;l=e+13|0;if(!(s[l>>0]|0)){a=e+4|0;r=o[a>>2]|0;A=e+8|0;n=o[A>>2]|0;c=r-n|0;i=(c|0)<(i|0)?c:i;if(i){ug(t|0,(o[e>>2]|0)+n|0,i|0)|0;n=o[A>>2]|0;r=o[a>>2]|0}c=n+i|0;o[A>>2]=c;o[e+16>>2]=i;if((c|0)>=(r|0))s[l>>0]=1}else s[e+12>>0]=1;return}function ze(e){e=e|0;pm(e,6791);o[e>>2]=4352;return}function We(e,t){e=e|0;t=t|0;var i=0,r=0,n=0;n=t+8|0;t=o[n>>2]|0;n=o[n+4>>2]|0;i=o[e+4>>2]|0;r=((i|0)<0)<<31>>31;if((n|0)<(r|0)|(n|0)==(r|0)&t>>>0<i>>>0)o[e+8>>2]=t;else s[e+12>>0]=1;return}function Xe(e,t){e=e|0;t=t|0;var i=0.0,r=0.0,o=0,n=0.0,a=0,l=0.0,h=0,u=0.0,d=0,p=0.0;d=t+179|0;s[c>>0]=s[d>>0];s[c+1>>0]=s[d+1>>0];s[c+2>>0]=s[d+2>>0];s[c+3>>0]=s[d+3>>0];s[c+4>>0]=s[d+4>>0];s[c+5>>0]=s[d+5>>0];s[c+6>>0]=s[d+6>>0];s[c+7>>0]=s[d+7>>0];u=+A[c>>3];a=t+187|0;s[c>>0]=s[a>>0];s[c+1>>0]=s[a+1>>0];s[c+2>>0]=s[a+2>>0];s[c+3>>0]=s[a+3>>0];s[c+4>>0]=s[a+4>>0];s[c+5>>0]=s[a+5>>0];s[c+6>>0]=s[a+6>>0];s[c+7>>0]=s[a+7>>0];p=+A[c>>3];e=t+195|0;s[c>>0]=s[e>>0];s[c+1>>0]=s[e+1>>0];s[c+2>>0]=s[e+2>>0];s[c+3>>0]=s[e+3>>0];s[c+4>>0]=s[e+4>>0];s[c+5>>0]=s[e+5>>0];s[c+6>>0]=s[e+6>>0];s[c+7>>0]=s[e+7>>0];n=+A[c>>3];h=t+203|0;s[c>>0]=s[h>>0];s[c+1>>0]=s[h+1>>0];s[c+2>>0]=s[h+2>>0];s[c+3>>0]=s[h+3>>0];s[c+4>>0]=s[h+4>>0];s[c+5>>0]=s[h+5>>0];s[c+6>>0]=s[h+6>>0];s[c+7>>0]=s[h+7>>0];l=+A[c>>3];o=t+211|0;s[c>>0]=s[o>>0];s[c+1>>0]=s[o+1>>0];s[c+2>>0]=s[o+2>>0];s[c+3>>0]=s[o+3>>0];s[c+4>>0]=s[o+4>>0];s[c+5>>0]=s[o+5>>0];s[c+6>>0]=s[o+6>>0];s[c+7>>0]=s[o+7>>0];i=+A[c>>3];t=t+219|0;s[c>>0]=s[t>>0];s[c+1>>0]=s[t+1>>0];s[c+2>>0]=s[t+2>>0];s[c+3>>0]=s[t+3>>0];s[c+4>>0]=s[t+4>>0];s[c+5>>0]=s[t+5>>0];s[c+6>>0]=s[t+6>>0];s[c+7>>0]=s[t+7>>0];r=+A[c>>3];A[c>>3]=p;s[d>>0]=s[c>>0];s[d+1>>0]=s[c+1>>0];s[d+2>>0]=s[c+2>>0];s[d+3>>0]=s[c+3>>0];s[d+4>>0]=s[c+4>>0];s[d+5>>0]=s[c+5>>0];s[d+6>>0]=s[c+6>>0];s[d+7>>0]=s[c+7>>0];A[c>>3]=u;s[h>>0]=s[c>>0];s[h+1>>0]=s[c+1>>0];s[h+2>>0]=s[c+2>>0];s[h+3>>0]=s[c+3>>0];s[h+4>>0]=s[c+4>>0];s[h+5>>0]=s[c+5>>0];s[h+6>>0]=s[c+6>>0];s[h+7>>0]=s[c+7>>0];A[c>>3]=l;s[a>>0]=s[c>>0];s[a+1>>0]=s[c+1>>0];s[a+2>>0]=s[c+2>>0];s[a+3>>0]=s[c+3>>0];s[a+4>>0]=s[c+4>>0];s[a+5>>0]=s[c+5>>0];s[a+6>>0]=s[c+6>>0];s[a+7>>0]=s[c+7>>0];A[c>>3]=n;s[o>>0]=s[c>>0];s[o+1>>0]=s[c+1>>0];s[o+2>>0]=s[c+2>>0];s[o+3>>0]=s[c+3>>0];s[o+4>>0]=s[c+4>>0];s[o+5>>0]=s[c+5>>0];s[o+6>>0]=s[c+6>>0];s[o+7>>0]=s[c+7>>0];A[c>>3]=r;s[e>>0]=s[c>>0];s[e+1>>0]=s[c+1>>0];s[e+2>>0]=s[c+2>>0];s[e+3>>0]=s[c+3>>0];s[e+4>>0]=s[c+4>>0];s[e+5>>0]=s[c+5>>0];s[e+6>>0]=s[c+6>>0];s[e+7>>0]=s[c+7>>0];A[c>>3]=i;s[t>>0]=s[c>>0];s[t+1>>0]=s[c+1>>0];s[t+2>>0]=s[c+2>>0];s[t+3>>0]=s[c+3>>0];s[t+4>>0]=s[c+4>>0];s[t+5>>0]=s[c+5>>0];s[t+6>>0]=s[c+6>>0];s[t+7>>0]=s[c+7>>0];return}function Ke(){var e=0,t=0,i=0,r=0,n=0,a=0,l=0,A=0;n=J;J=J+48|0;i=n+24|0;r=n;e=n+44|0;if((s[21440]|0)==0?Lf(21440)|0:0){o[5374]=0;o[5375]=0;o[5376]=0;Gf(21440)}if((s[21448]|0)==0?Lf(21448)|0:0)Gf(21448);if((o[5374]|0)==(o[5375]|0)){lm(21508);if((o[5374]|0)==(o[5375]|0)){s[i>>0]=s[e>>0]|0;nt(r,i);e=o[5375]|0;do{if(e>>>0>=(o[5376]|0)>>>0){e=((e-(o[5374]|0)|0)/24|0)+1|0;t=pt(21496)|0;if(t>>>0<e>>>0)Xm(21496);else{a=o[5374]|0;A=((o[5376]|0)-a|0)/24|0;l=A<<1;ht(i,A>>>0<t>>>1>>>0?l>>>0<e>>>0?e:l:t,((o[5375]|0)-a|0)/24|0,21504);t=i+8|0;At(o[t>>2]|0,r);o[t>>2]=(o[t>>2]|0)+24;ut(21496,i);dt(i);break}}else{at(i,21496,1);A=i+4|0;At(o[A>>2]|0,r);o[A>>2]=(o[A>>2]|0)+24;lt(i)}}while(0);Ye(r)}Am(21508)}J=n;return 21496}function Ze(e,t){e=e|0;t=t|0;var i=0,s=0;i=t+16|0;s=o[i>>2]|0;do{if(s)if((t|0)==(s|0)){s=ct(e)|0;o[e+16>>2]=s;i=o[i>>2]|0;zg[o[(o[i>>2]|0)+12>>2]&15](i,s);break}else{o[e+16>>2]=Ng[o[(o[s>>2]|0)+8>>2]&15](s)|0;break}else o[e+16>>2]=0}while(0);return}function Je(e,t){e=e|0;t=t|0;e=o[e+16>>2]|0;if(!e){t=P(4)|0;o[t>>2]=0;It(t);C(t|0,4168,131)}else{zg[o[(o[e>>2]|0)+24>>2]&15](e,t);return}}function Ye(e){e=e|0;var t=0;t=o[e+16>>2]|0;if((e|0)!=(t|0)){if(t|0)Gg[o[(o[t>>2]|0)+20>>2]&255](t)}else Gg[o[(o[t>>2]|0)+16>>2]&255](t);return}function qe(e){e=e|0;var t=0,i=0,r=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0;m=J;J=J+96|0;l=m+16|0;p=m;h=m+72|0;A=o[e>>2]|0;u=a[e+114>>1]|0;d=p;o[d>>2]=0;o[d+4>>2]=0;d=p+8|0;o[d>>2]=u;o[d+4>>2]=0;o[l>>2]=o[p>>2];o[l+4>>2]=o[p+4>>2];o[l+8>>2]=o[p+8>>2];o[l+12>>2]=o[p+12>>2];We(A,l);A=e+120|0;e:do{if(o[A>>2]|0){c=l+2|0;u=l+16|0;d=l+20|0;p=l+18|0;i=0;while(1){if(!(Tt(o[e>>2]|0)|0))break e;if(Dt(o[e>>2]|0)|0)break e;Ge(o[e>>2]|0,l,54);t=7277;r=c;while(1){if((s[r>>0]|0)!=(s[t>>0]|0))break;r=r+1|0;if((r|0)==(u|0)){f=8;break}else t=t+1|0}if((f|0)==8?(f=0,(n[p>>0]|n[p+1>>0]<<8)<<16>>16==22204):0)break;Rt(o[e>>2]|0,(n[d>>0]|n[d+1>>0]<<8)&65535,0,1);i=i+1|0;if(i>>>0>=(o[A>>2]|0)>>>0)break e}p=(n[d>>0]|n[d+1>>0]<<8)&65535;f=Jf(p)|0;Ge(o[e>>2]|0,f,p);St(e,f);$p(f);f=e+125|0;Lt(h,e+247|0,(n[f>>0]|n[f+1>>0]<<8)&65535);kt(e+300|0,h)|0;De(h);J=m;return}}while(0);m=P(8)|0;Ut(m);C(m|0,2672,8)}function $e(e){e=e|0;var t=0,i=0,s=0,r=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0;d=J;J=J+176|0;r=d+40|0;a=d+24|0;t=d+16|0;s=d;c=d+152|0;h=d+136|0;u=d+56|0;A=o[e>>2]|0;l=e+116|0;p=o[l>>2]|0;i=a;o[i>>2]=0;o[i+4>>2]=0;i=a+8|0;o[i>>2]=p;o[i+4>>2]=0;o[r>>2]=o[a>>2];o[r+4>>2]=o[a+4>>2];o[r+8>>2]=o[a+8>>2];o[r+12>>2]=o[a+12>>2];We(A,r);A=t;o[A>>2]=0;o[A+4>>2]=0;Ge(o[e>>2]|0,t,8);if(!(Tt(o[e>>2]|0)|0)){p=P(8)|0;qt(p);C(p|0,2704,8)}i=t;t=o[i>>2]|0;i=o[i+4>>2]|0;if((t|0)==-1&(i|0)==-1){p=P(8)|0;$t(p,7488);C(p|0,2720,8)}p=o[e>>2]|0;A=s;o[A>>2]=0;o[A+4>>2]=0;A=s+8|0;o[A>>2]=t;o[A+4>>2]=i;o[r>>2]=o[s>>2];o[r+4>>2]=o[s+4>>2];o[r+8>>2]=o[s+8>>2];o[r+12>>2]=o[s+12>>2];We(p,r);if(!(Tt(o[e>>2]|0)|0)){p=P(8)|0;qt(p);C(p|0,2704,8)}Ge(o[e>>2]|0,r,8);if(!(Tt(o[e>>2]|0)|0)){p=P(8)|0;qt(p);C(p|0,2704,8)}if(o[r>>2]|0){p=P(8)|0;ei(p);C(p|0,2736,8)}a=e+288|0;A=e+292|0;o[A>>2]=o[a>>2];p=e+259|0;if((n[p>>0]|n[p+1>>0]<<8|n[p+2>>0]<<16|n[p+3>>0]<<24|0)==-1){p=P(8)|0;$t(p,7606);C(p|0,2720,8)}s=r+4|0;ti(a,(o[s>>2]|0)+1|0);p=o[a>>2]|0;o[p>>2]=(o[l>>2]|0)+8;o[p+4>>2]=0;if((o[s>>2]|0)>>>0>1){Oe(c,o[e>>2]|0);ii(h,c);si(u,32,2,8,0);ri(h);oi(u);if(!(o[s>>2]|0)){a=o[a>>2]|0;i=a}else{i=1;do{if(i>>>0>1)t=o[(o[a>>2]|0)+(i+-1<<3)>>2]|0;else t=0;l=ni(u,h,t,1)|0;t=o[a>>2]|0;p=t+(i<<3)|0;o[p>>2]=l;o[p+4>>2]=((l|0)<0)<<31>>31;i=i+1|0}while(i>>>0<=(o[s>>2]|0)>>>0);i=t;a=t}t=o[A>>2]|0;if(t-i>>3>>>0>1){r=t-a>>3;s=a;t=1;i=o[s>>2]|0;s=o[s+4>>2]|0;do{p=a+(t<<3)|0;A=p;i=ig(o[A>>2]|0,o[A+4>>2]|0,i|0,s|0)|0;s=B()|0;o[p>>2]=i;o[p+4>>2]=s;t=t+1|0}while(t>>>0<r>>>0)}ai(u);li(h);Re(c)}J=d;return}function et(e){e=e|0;s[e+12>>0]=0;s[e+13>>0]=0;return}function tt(e){e=e|0;o[e+8>>2]=0;o[e+4>>2]=0;return}function it(e){e=e|0;return Zd(e)|0}function st(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0,l=0,A=0,c=0;l=J;J=J+16|0;n=t;a=l;r=i-n|0;if(r>>>0>4294967279)fm(e);if(r>>>0<11)s[e+11>>0]=r;else{c=r+16&-16;A=Zf(c)|0;o[e>>2]=A;o[e+8>>2]=c|-2147483648;o[e+4>>2]=r;e=A}if((t|0)!=(i|0)){n=i-n|0;r=e;while(1){rt(r,t);t=t+1|0;if((t|0)==(i|0))break;else r=r+1|0}e=e+n|0}s[a>>0]=0;rt(e,a);J=l;return}function rt(e,t){e=e|0;t=t|0;s[e>>0]=s[t>>0]|0;return}function ot(e){e=e|0;ff(e);$p(e);return}function nt(e,t){e=e|0;t=t|0;o[e>>2]=4372;o[e+16>>2]=e;return}function at(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=t;t=o[t+4>>2]|0;o[e+4>>2]=t;o[e+8>>2]=t+(i*24|0);return}function lt(e){e=e|0;o[(o[e>>2]|0)+4>>2]=o[e+4>>2];return}function At(e,t){e=e|0;t=t|0;var i=0,s=0;i=t+16|0;s=o[i>>2]|0;do{if(s)if((t|0)==(s|0)){s=ct(e)|0;o[e+16>>2]=s;i=o[i>>2]|0;zg[o[(o[i>>2]|0)+12>>2]&15](i,s);break}else{o[e+16>>2]=s;o[i>>2]=0;break}else o[e+16>>2]=0}while(0);return}function ct(e){e=e|0;return e|0}function ht(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0;r=e+12|0;o[r>>2]=0;o[e+16>>2]=s;do{if(t)if(t>>>0>178956970){r=P(8)|0;um(r,6723);o[r>>2]=5956;C(r|0,3928,123)}else{s=Zf(t*24|0)|0;break}else s=0}while(0);o[e>>2]=s;i=s+(i*24|0)|0;o[e+8>>2]=i;o[e+4>>2]=i;o[r>>2]=s+(t*24|0);return}function ut(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0;l=o[e>>2]|0;A=e+4|0;i=o[A>>2]|0;a=t+4|0;if((i|0)==(l|0)){r=a;n=e;s=o[a>>2]|0;i=l}else{s=o[a>>2]|0;do{i=i+-24|0;At(s+-24|0,i);s=(o[a>>2]|0)+-24|0;o[a>>2]=s}while((i|0)!=(l|0));r=a;n=e;i=o[e>>2]|0}o[n>>2]=s;o[r>>2]=i;l=t+8|0;a=o[A>>2]|0;o[A>>2]=o[l>>2];o[l>>2]=a;l=e+8|0;A=t+12|0;e=o[l>>2]|0;o[l>>2]=o[A>>2];o[A>>2]=e;o[t>>2]=o[r>>2];return}function dt(e){e=e|0;var t=0,i=0,s=0,r=0;i=o[e+4>>2]|0;s=e+8|0;t=o[s>>2]|0;if((t|0)!=(i|0))do{r=t+-24|0;o[s>>2]=r;Ye(r);t=o[s>>2]|0}while((t|0)!=(i|0));t=o[e>>2]|0;if(t|0)be(t,(o[e+12>>2]|0)-t|0);return}function pt(e){e=e|0;return 178956970}function ft(e){e=e|0;$p(e);return}function mt(e){e=e|0;e=Zf(8)|0;o[e>>2]=4372;return e|0}function gt(e,t){e=e|0;t=t|0;o[t>>2]=4372;return}function _t(e){e=e|0;return}function vt(e){e=e|0;be(e,8);return}function bt(e,t){e=e|0;t=t|0;Pt(e+4|0,t);return}function yt(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==7183?e+4|0:0)|0}function wt(e){e=e|0;return 2664}function Bt(e){e=e|0;return}function Pt(e,t){e=e|0;t=t|0;xt(e,t);return}function xt(e,t){e=e|0;t=t|0;var i=0,r=0;e=t+104|0;t=n[e>>0]|0;i=t>>>7;r=t>>>6&1;if((i|0)==1&(r|0)!=0){r=P(8)|0;Ct(r);C(r|0,2632,8)}if((i|0)==(r|0)){r=P(8)|0;Mt(r);C(r|0,2648,8)}else{s[e>>0]=t&63;return}}function Ct(e){e=e|0;pm(e,7076);o[e>>2]=4416;return}function Mt(e){e=e|0;pm(e,7144);o[e>>2]=4436;return}function Et(e){e=e|0;ff(e);$p(e);return}function Ft(e){e=e|0;ff(e);$p(e);return}function It(e){e=e|0;o[e>>2]=6092;return}function Tt(e){e=e|0;var t=0;t=e+12|0;e=(s[t>>0]|0)==0;s[t>>0]=0;return e|0}function Dt(e){e=e|0;return(s[e+13>>0]|0)!=0|0}function St(e,t){e=e|0;t=t|0;e=e+247|0;Ot(e,t);if((n[e>>0]|n[e+1>>0]<<8)<<16>>16==2)return;else{t=P(8)|0;Nt(t);C(t|0,2688,8)}}function Rt(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0,a=0;switch(r|0){case 0:break;case 2:{r=o[e+4>>2]|0;t=ig(ig(t|0,i|0,-1,-1)|0,B()|0,r|0,((r|0)<0)<<31>>31|0)|0;i=B()|0;break}case 1:{r=o[e+8>>2]|0;t=ig(r|0,((r|0)<0)<<31>>31|0,t|0,i|0)|0;i=B()|0;break}default:{i=0;t=0}}n=o[e+4>>2]|0;a=((n|0)<0)<<31>>31;r=e+12|0;if((i|0)<0|((i|0)>(a|0)|(i|0)==(a|0)&t>>>0>=n>>>0))s[r>>0]=1;else{s[r>>0]=0;o[e+8>>2]=t}return}function Ut(e){e=e|0;pm(e,7410);o[e>>2]=4476;return}function Lt(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0,o=0,a=0,l=0,A=0,c=0;a=J;J=J+16|0;o=a;Ve(e);r=t+32|0;if((n[r>>0]|n[r+1>>0]<<8)<<16>>16){s=t+34|0;t=0;do{A=n[s>>0]|n[s+1>>0]<<8|n[s+2>>0]<<16|n[s+3>>0]<<24;c=A+(t*6|0)|0;l=A+(t*6|0)+2|0;A=A+(t*6|0)+4|0;jt(o,(n[c>>0]|n[c+1>>0]<<8)&65535,(n[l>>0]|n[l+1>>0]<<8)&65535,(n[A>>0]|n[A+1>>0]<<8)&65535);Ht(e,o);i=i-((n[l>>0]|n[l+1>>0]<<8)&65535)|0;t=t+1|0}while(t>>>0<((n[r>>0]|n[r+1>>0]<<8)&65535)>>>0)}if((i|0)<0){c=P(8)|0;Nt(c);C(c|0,2688,8)}if(i|0){jt(o,0,i,2);Ht(e,o)}J=a;return}function kt(e,t){e=e|0;t=t|0;var i=0,r=0;i=J;J=J+16|0;r=i+1|0;s[r>>0]=s[i>>0]|0;Jt(e,t,r);J=i;return e|0}function Ot(e,t){e=e|0;t=t|0;var i=0,r=0,o=0,a=0,l=0,A=0,c=0;r=t+2|0;a=n[t>>0]|n[t+1>>0]<<8;s[e>>0]=a;s[e+1>>0]=a>>8;a=e+2|0;r=n[r>>0]|n[r+1>>0]<<8;s[a>>0]=r;s[a+1>>0]=r>>8;s[e+4>>0]=s[t+4>>0]|0;a=t+6|0;s[e+5>>0]=s[t+5>>0]|0;r=t+8|0;i=e+6|0;a=n[a>>0]|n[a+1>>0]<<8;s[i>>0]=a;s[i+1>>0]=a>>8;i=t+12|0;a=e+8|0;r=n[r>>0]|n[r+1>>0]<<8|n[r+2>>0]<<16|n[r+3>>0]<<24;s[a>>0]=r;s[a+1>>0]=r>>8;s[a+2>>0]=r>>16;s[a+3>>0]=r>>24;a=e+12|0;i=n[i>>0]|n[i+1>>0]<<8|n[i+2>>0]<<16|n[i+3>>0]<<24;s[a>>0]=i;s[a+1>>0]=i>>8;s[a+2>>0]=i>>16;s[a+3>>0]=i>>24;a=t+16|0;i=a;i=n[i>>0]|n[i+1>>0]<<8|n[i+2>>0]<<16|n[i+3>>0]<<24;a=a+4|0;a=n[a>>0]|n[a+1>>0]<<8|n[a+2>>0]<<16|n[a+3>>0]<<24;r=e+16|0;l=r;s[l>>0]=i;s[l+1>>0]=i>>8;s[l+2>>0]=i>>16;s[l+3>>0]=i>>24;r=r+4|0;s[r>>0]=a;s[r+1>>0]=a>>8;s[r+2>>0]=a>>16;s[r+3>>0]=a>>24;r=t+32|0;a=t+24|0;l=a;l=n[l>>0]|n[l+1>>0]<<8|n[l+2>>0]<<16|n[l+3>>0]<<24;a=a+4|0;a=n[a>>0]|n[a+1>>0]<<8|n[a+2>>0]<<16|n[a+3>>0]<<24;i=e+24|0;o=i;s[o>>0]=l;s[o+1>>0]=l>>8;s[o+2>>0]=l>>16;s[o+3>>0]=l>>24;i=i+4|0;s[i>>0]=a;s[i+1>>0]=a>>8;s[i+2>>0]=a>>16;s[i+3>>0]=a>>24;i=t+34|0;a=e+32|0;r=n[r>>0]|n[r+1>>0]<<8;s[a>>0]=r;s[a+1>>0]=r>>8;o=e+34|0;e=n[o>>0]|n[o+1>>0]<<8|n[o+2>>0]<<16|n[o+3>>0]<<24;if(!e)e=r;else{Yf(e);e=n[a>>0]|n[a+1>>0]<<8}r=Jf((e&65535)*6|0)|0;s[o>>0]=r;s[o+1>>0]=r>>8;s[o+2>>0]=r>>16;s[o+3>>0]=r>>24;if(e<<16>>16?(e=t+36|0,l=n[i>>0]|n[i+1>>0]<<8,s[r>>0]=l,s[r+1>>0]=l>>8,t=t+38|0,l=r+2|0,e=n[e>>0]|n[e+1>>0]<<8,s[l>>0]=e,s[l+1>>0]=e>>8,l=r+4|0,t=n[t>>0]|n[t+1>>0]<<8,s[l>>0]=t,s[l+1>>0]=t>>8,((n[a>>0]|n[a+1>>0]<<8)&65535)>1):0){e=1;do{t=i;i=i+6|0;l=n[o>>0]|n[o+1>>0]<<8|n[o+2>>0]<<16|n[o+3>>0]<<24;A=t+8|0;r=l+(e*6|0)|0;c=n[i>>0]|n[i+1>>0]<<8;s[r>>0]=c;s[r+1>>0]=c>>8;t=t+10|0;r=l+(e*6|0)+2|0;A=n[A>>0]|n[A+1>>0]<<8;s[r>>0]=A;s[r+1>>0]=A>>8;l=l+(e*6|0)+4|0;t=n[t>>0]|n[t+1>>0]<<8;s[l>>0]=t;s[l+1>>0]=t>>8;e=e+1|0}while(e>>>0<((n[a>>0]|n[a+1>>0]<<8)&65535)>>>0)}return}function Nt(e){e=e|0;pm(e,7354);o[e>>2]=4456;return}function Vt(e){e=e|0;ff(e);$p(e);return}function Qt(e){e=e|0;ff(e);$p(e);return}function Ht(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0;l=J;J=J+32|0;r=l;n=e+4|0;i=o[n>>2]|0;a=e+8|0;do{if((i|0)==(o[a>>2]|0)){i=((i-(o[e>>2]|0)|0)/12|0)+1|0;s=Zt(e)|0;if(s>>>0<i>>>0)Xm(e);else{A=o[e>>2]|0;c=((o[a>>2]|0)-A|0)/12|0;a=c<<1;Wt(r,c>>>0<s>>>1>>>0?a>>>0<i>>>0?i:a:s,((o[n>>2]|0)-A|0)/12|0,e+8|0);a=r+8|0;n=o[a>>2]|0;o[n>>2]=o[t>>2];o[n+4>>2]=o[t+4>>2];o[n+8>>2]=o[t+8>>2];o[a>>2]=(o[a>>2]|0)+12;Xt(e,r);Kt(r);break}}else{Gt(r,e,1);c=r+4|0;A=o[c>>2]|0;o[A>>2]=o[t>>2];o[A+4>>2]=o[t+4>>2];o[A+8>>2]=o[t+8>>2];o[c>>2]=(o[c>>2]|0)+12;zt(r)}}while(0);J=l;return}function jt(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;o[e>>2]=t;o[e+4>>2]=i;o[e+8>>2]=s;return}function Gt(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=t;t=o[t+4>>2]|0;o[e+4>>2]=t;o[e+8>>2]=t+(i*12|0);return}function zt(e){e=e|0;o[(o[e>>2]|0)+4>>2]=o[e+4>>2];return}function Wt(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0;r=e+12|0;o[r>>2]=0;o[e+16>>2]=s;do{if(t)if(t>>>0>357913941){r=P(8)|0;um(r,6723);o[r>>2]=5956;C(r|0,3928,123)}else{s=Zf(t*12|0)|0;break}else s=0}while(0);o[e>>2]=s;i=s+(i*12|0)|0;o[e+8>>2]=i;o[e+4>>2]=i;o[r>>2]=s+(t*12|0);return}function Xt(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0;s=o[e>>2]|0;a=e+4|0;n=t+4|0;r=(o[a>>2]|0)-s|0;i=(o[n>>2]|0)+(((r|0)/-12|0)*12|0)|0;o[n>>2]=i;if((r|0)>0){hg(i|0,s|0,r|0)|0;s=n;i=o[n>>2]|0}else s=n;n=o[e>>2]|0;o[e>>2]=i;o[s>>2]=n;n=t+8|0;r=o[a>>2]|0;o[a>>2]=o[n>>2];o[n>>2]=r;n=e+8|0;a=t+12|0;e=o[n>>2]|0;o[n>>2]=o[a>>2];o[a>>2]=e;o[t>>2]=o[s>>2];return}function Kt(e){e=e|0;var t=0,i=0,s=0;t=o[e+4>>2]|0;i=e+8|0;s=o[i>>2]|0;if((s|0)!=(t|0))o[i>>2]=s+(~(((s+-12-t|0)>>>0)/12|0)*12|0);t=o[e>>2]|0;if(t|0)be(t,(o[e+12>>2]|0)-t|0);return}function Zt(e){e=e|0;return 357913941}function Jt(e,t,i){e=e|0;t=t|0;i=i|0;var s=0;Yt(e);o[e>>2]=o[t>>2];i=t+4|0;o[e+4>>2]=o[i>>2];s=t+8|0;o[e+8>>2]=o[s>>2];o[s>>2]=0;o[i>>2]=0;o[t>>2]=0;return}function Yt(e){e=e|0;var t=0,i=0,s=0,r=0;t=o[e>>2]|0;i=t;if(t|0){s=e+4|0;o[s>>2]=i;r=e+8|0;be(t,(o[r>>2]|0)-i|0);o[r>>2]=0;o[s>>2]=0;o[e>>2]=0}return}function qt(e){e=e|0;pm(e,7660);o[e>>2]=4496;return}function $t(e,t){e=e|0;t=t|0;pm(e,t);o[e>>2]=4516;return}function ei(e){e=e|0;pm(e,7704);o[e>>2]=4536;return}function ti(e,t){e=e|0;t=t|0;var i=0,s=0,r=0;i=e+4|0;r=o[e>>2]|0;s=(o[i>>2]|0)-r>>3;if(s>>>0>=t>>>0){if(s>>>0>t>>>0)o[i>>2]=r+(t<<3)}else ui(e,t-s|0);return}function ii(e,t){e=e|0;t=t|0;o[e>>2]=t;o[e+4>>2]=0;o[e+8>>2]=-1;return}function si(e,t,i,s,r){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;var n=0;o[e+4>>2]=t;o[e+8>>2]=i;o[e+12>>2]=s;o[e+16>>2]=r;o[e+36>>2]=0;o[e+40>>2]=0;o[e+44>>2]=0;Bi(e+48|0);o[e+68>>2]=0;o[e+72>>2]=0;o[e+76>>2]=0;do{if(!r){i=e+20|0;if((t+-1|0)>>>0<31){o[i>>2]=t;r=1<<t;o[e+24>>2]=r;i=r>>>1;o[e+28>>2]=0-i;i=r+-1-i|0;break}else{o[i>>2]=32;o[e+24>>2]=0;o[e+28>>2]=-2147483648;i=2147483647;break}}else{s=e+20|0;o[s>>2]=0;o[e+24>>2]=r;i=r;n=0;while(1){i=i>>>1;t=n+1|0;if(!i)break;else n=t}o[s>>2]=(1<<n|0)==(r|0)?n:t;i=r>>>1;o[e+28>>2]=0-i;i=r+-1-i|0}}while(0);o[e+32>>2]=i;o[e>>2]=0;return}function ri(e){e=e|0;var t=0;t=((Ci(o[e>>2]|0)|0)&255)<<24;t=((Ci(o[e>>2]|0)|0)&255)<<16|t;t=t|((Ci(o[e>>2]|0)|0)&255)<<8;o[e+4>>2]=t|(Ci(o[e>>2]|0)|0)&255;return}function oi(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0,g=0,_=0,v=0;m=J;J=J+64|0;p=m+44|0;f=m;c=e+36|0;h=e+40|0;e:do{if((o[c>>2]|0)==(o[h>>2]|0)){u=e+8|0;t:do{if(!(o[u>>2]|0))d=e+20|0;else{r=e+20|0;n=e+44|0;a=p+4|0;l=e+44|0;A=p+8|0;s=0;while(1){Ti(f,(o[r>>2]|0)+1|0,0,0);t=o[h>>2]|0;if(t>>>0<(o[n>>2]|0)>>>0){Di(p,c,1);Ri(o[a>>2]|0,f);o[a>>2]=(o[a>>2]|0)+44;Si(p)}else{t=((t-(o[c>>2]|0)|0)/44|0)+1|0;i=Oi(c)|0;if(i>>>0<t>>>0)break;g=o[c>>2]|0;v=((o[n>>2]|0)-g|0)/44|0;_=v<<1;Ui(p,v>>>0<i>>>1>>>0?_>>>0<t>>>0?t:_:i,((o[h>>2]|0)-g|0)/44|0,l);Ri(o[A>>2]|0,f);o[A>>2]=(o[A>>2]|0)+44;Li(c,p);ki(p)}xi(f);s=s+1|0;if(s>>>0>=(o[u>>2]|0)>>>0){d=r;break t}}Xm(c)}}while(0);if(o[d>>2]|0){a=e+12|0;l=e+68|0;A=e+72|0;c=e+76|0;h=p+4|0;r=e+76|0;n=p+8|0;s=1;while(1){t=o[a>>2]|0;Ti(f,1<<(s>>>0>t>>>0?t:s),0,0);t=o[A>>2]|0;if(t>>>0<(o[c>>2]|0)>>>0){Di(p,l,1);Ri(o[h>>2]|0,f);o[h>>2]=(o[h>>2]|0)+44;Si(p)}else{t=((t-(o[l>>2]|0)|0)/44|0)+1|0;i=Oi(l)|0;if(i>>>0<t>>>0)break;v=o[l>>2]|0;g=((o[c>>2]|0)-v|0)/44|0;_=g<<1;Ui(p,g>>>0<i>>>1>>>0?_>>>0<t>>>0?t:_:i,((o[A>>2]|0)-v|0)/44|0,r);Ri(o[n>>2]|0,f);o[n>>2]=(o[n>>2]|0)+44;Li(l,p);ki(p)}xi(f);s=s+1|0;if(s>>>0>(o[d>>2]|0)>>>0)break e}Xm(l)}}}while(0);J=m;return}function ni(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;i=(Qi(e,t,(o[e+36>>2]|0)+(s*44|0)|0)|0)+i|0;t=o[e+24>>2]|0;if((i|0)<0)return i+t|0;else return i-(i>>>0<t>>>0?0:t)|0;return 0}function ai(e){e=e|0;Pi(e+68|0);Pi(e+36|0);return}function li(e){e=e|0;return}function Ai(e){e=e|0;ff(e);$p(e);return}function ci(e){e=e|0;ff(e);$p(e);return}function hi(e){e=e|0;ff(e);$p(e);return}function ui(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0;l=J;J=J+32|0;r=l;n=e+8|0;a=e+4|0;i=o[a>>2]|0;do{if((o[n>>2]|0)-i>>3>>>0<t>>>0){i=(i-(o[e>>2]|0)>>3)+t|0;s=bi(e)|0;if(s>>>0<i>>>0)Xm(e);else{A=o[e>>2]|0;c=(o[n>>2]|0)-A|0;n=c>>2;pi(r,c>>3>>>0<s>>>1>>>0?n>>>0<i>>>0?i:n:s,(o[a>>2]|0)-A>>3,e+8|0);fi(r,t);mi(e,r);gi(r);break}}else di(e,t)}while(0);J=l;return}function di(e,t){e=e|0;t=t|0;var i=0,s=0,r=0;r=J;J=J+16|0;s=r;_i(s,e,t);e=s+4|0;t=o[e>>2]|0;i=o[s+8>>2]|0;if((t|0)!=(i|0)){i=i+-8-t|0;dg(t|0,0,i+8&-8|0)|0;o[e>>2]=t+((i>>>3)+1<<3)}vi(s);J=r;return}function pi(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0;r=e+12|0;o[r>>2]=0;o[e+16>>2]=s;do{if(t)if(t>>>0>536870911){r=P(8)|0;um(r,6723);o[r>>2]=5956;C(r|0,3928,123)}else{s=Zf(t<<3)|0;break}else s=0}while(0);o[e>>2]=s;i=s+(i<<3)|0;o[e+8>>2]=i;o[e+4>>2]=i;o[r>>2]=s+(t<<3);return}function fi(e,t){e=e|0;t=t|0;var i=0,s=0;s=J;J=J+16|0;i=s;yi(i,e+8|0,t);e=o[i>>2]|0;t=o[i+4>>2]|0;if((e|0)!=(t|0)){t=t+-8-e|0;dg(e|0,0,t+8&-8|0)|0;o[i>>2]=e+((t>>>3)+1<<3)}wi(i);J=s;return}function mi(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0;s=o[e>>2]|0;a=e+4|0;n=t+4|0;r=(o[a>>2]|0)-s|0;i=(o[n>>2]|0)+(0-(r>>3)<<3)|0;o[n>>2]=i;if((r|0)>0){hg(i|0,s|0,r|0)|0;s=n;i=o[n>>2]|0}else s=n;n=o[e>>2]|0;o[e>>2]=i;o[s>>2]=n;n=t+8|0;r=o[a>>2]|0;o[a>>2]=o[n>>2];o[n>>2]=r;n=e+8|0;a=t+12|0;e=o[n>>2]|0;o[n>>2]=o[a>>2];o[a>>2]=e;o[t>>2]=o[s>>2];return}function gi(e){e=e|0;var t=0,i=0,s=0;t=o[e+4>>2]|0;i=e+8|0;s=o[i>>2]|0;if((s|0)!=(t|0))o[i>>2]=s+(~((s+-8-t|0)>>>3)<<3);t=o[e>>2]|0;if(t|0)be(t,(o[e+12>>2]|0)-t|0);return}function _i(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=t;t=o[t+4>>2]|0;o[e+4>>2]=t;o[e+8>>2]=t+(i<<3);return}function vi(e){e=e|0;o[(o[e>>2]|0)+4>>2]=o[e+4>>2];return}function bi(e){e=e|0;return 536870911}function yi(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=o[t>>2];o[e+4>>2]=(o[t>>2]|0)+(i<<3);o[e+8>>2]=t;return}function wi(e){e=e|0;o[o[e+8>>2]>>2]=o[e>>2];return}function Bi(e){e=e|0;o[e+12>>2]=1;o[e+16>>2]=2;o[e+8>>2]=4096;o[e+4>>2]=4;o[e>>2]=4;return}function Pi(e){e=e|0;var t=0,i=0,s=0;i=o[e>>2]|0;if(i|0){s=e+4|0;t=o[s>>2]|0;if((t|0)==(i|0))t=i;else{do{t=t+-44|0;xi(t)}while((t|0)!=(i|0));t=o[e>>2]|0}o[s>>2]=i;be(t,(o[e+8>>2]|0)-t|0)}return}function xi(e){e=e|0;var t=0;t=o[e+8>>2]|0;if(t|0)ke(t);t=o[e+12>>2]|0;if(t|0)ke(t);t=o[e+16>>2]|0;if(t|0)ke(t);return}function Ci(e){e=e|0;var t=0,i=0;i=e+4|0;t=o[i>>2]|0;if((t|0)>=(o[e+8>>2]|0)){Mi(e);t=o[i>>2]|0}e=o[e+12>>2]|0;o[i>>2]=t+1;return s[e+t>>0]|0}function Mi(e){e=e|0;var t=0;o[e+4>>2]=0;Ge(o[e>>2]|0,o[e+12>>2]|0,1048576);t=Ei(o[e>>2]|0)|0;o[e+8>>2]=t;if(!t){t=P(8)|0;Fi(t);C(t|0,2752,8)}else return}function Ei(e){e=e|0;return o[e+16>>2]|0}function Fi(e){e=e|0;pm(e,7769);o[e>>2]=4556;return}function Ii(e){e=e|0;ff(e);$p(e);return}function Ti(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0,a=0,l=0;o[e>>2]=t;s[e+4>>0]=i&1;a=e+8|0;o[a>>2]=0;l=e+12|0;o[l>>2]=0;n=e+16|0;o[n>>2]=0;if((t+-2|0)>>>0>2046){e=P(8)|0;pm(e,7789);C(e|0,3912,8)}o[e+32>>2]=t+-1;if(t>>>0>16&(i^1)){i=3;while(1)if(1<<i+2>>>0<t>>>0)i=i+1|0;else break;t=1<<i;o[e+36>>2]=t;o[e+40>>2]=15-i;o[n>>2]=je((t<<2)+8|0)|0;t=o[e>>2]|0}else{o[n>>2]=0;o[e+40>>2]=0;o[e+36>>2]=0}o[a>>2]=je(t<<2)|0;n=je(o[e>>2]<<2)|0;o[l>>2]=n;o[e+20>>2]=0;t=o[e>>2]|0;i=e+24|0;o[i>>2]=t;t=(t|0)!=0;if(!r){if(t){t=0;do{o[n+(t<<2)>>2]=1;t=t+1|0}while(t>>>0<(o[e>>2]|0)>>>0)}}else if(t){t=0;do{o[n+(t<<2)>>2]=o[r+(t<<2)>>2];t=t+1|0}while(t>>>0<(o[e>>2]|0)>>>0)}Vi(e);r=((o[e>>2]|0)+6|0)>>>1;o[i>>2]=r;o[e+28>>2]=r;return}function Di(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=t;t=o[t+4>>2]|0;o[e+4>>2]=t;o[e+8>>2]=t+(i*44|0);return}function Si(e){e=e|0;o[(o[e>>2]|0)+4>>2]=o[e+4>>2];return}function Ri(e,t){e=e|0;t=t|0;var i=0;o[e>>2]=o[t>>2];s[e+4>>0]=s[t+4>>0]|0;i=t+8|0;o[e+8>>2]=o[i>>2];o[e+12>>2]=o[t+12>>2];o[e+16>>2]=o[t+16>>2];o[e+20>>2]=o[t+20>>2];o[e+24>>2]=o[t+24>>2];o[e+28>>2]=o[t+28>>2];o[e+32>>2]=o[t+32>>2];o[e+36>>2]=o[t+36>>2];o[e+40>>2]=o[t+40>>2];o[i>>2]=0;o[i+4>>2]=0;o[i+8>>2]=0;return}function Ui(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0;r=e+12|0;o[r>>2]=0;o[e+16>>2]=s;do{if(t)if(t>>>0>97612893){r=P(8)|0;um(r,6723);o[r>>2]=5956;C(r|0,3928,123)}else{s=Zf(t*44|0)|0;break}else s=0}while(0);o[e>>2]=s;i=s+(i*44|0)|0;o[e+8>>2]=i;o[e+4>>2]=i;o[r>>2]=s+(t*44|0);return}function Li(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0;l=o[e>>2]|0;A=e+4|0;i=o[A>>2]|0;a=t+4|0;if((i|0)==(l|0)){r=a;n=e;s=o[a>>2]|0;i=l}else{s=o[a>>2]|0;do{i=i+-44|0;Ni(s+-44|0,i);s=(o[a>>2]|0)+-44|0;o[a>>2]=s}while((i|0)!=(l|0));r=a;n=e;i=o[e>>2]|0}o[n>>2]=s;o[r>>2]=i;l=t+8|0;a=o[A>>2]|0;o[A>>2]=o[l>>2];o[l>>2]=a;l=e+8|0;A=t+12|0;e=o[l>>2]|0;o[l>>2]=o[A>>2];o[A>>2]=e;o[t>>2]=o[r>>2];return}function ki(e){e=e|0;var t=0,i=0,s=0,r=0;i=o[e+4>>2]|0;s=e+8|0;t=o[s>>2]|0;if((t|0)!=(i|0))do{r=t+-44|0;o[s>>2]=r;xi(r);t=o[s>>2]|0}while((t|0)!=(i|0));t=o[e>>2]|0;if(t|0)be(t,(o[e+12>>2]|0)-t|0);return}function Oi(e){e=e|0;return 97612893}function Ni(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,a=0;i=o[t>>2]|0;o[e>>2]=i;s[e+4>>0]=s[t+4>>0]|0;o[e+20>>2]=o[t+20>>2];o[e+24>>2]=o[t+24>>2];o[e+28>>2]=o[t+28>>2];o[e+32>>2]=o[t+32>>2];a=e+36|0;o[a>>2]=o[t+36>>2];o[e+40>>2]=o[t+40>>2];i=i<<2;r=je(i)|0;o[e+8>>2]=r;n=o[e>>2]|0;if(n|0)ug(r|0,o[t+8>>2]|0,n<<2|0)|0;i=je(i)|0;o[e+12>>2]=i;r=o[e>>2]|0;if(r|0)ug(i|0,o[t+12>>2]|0,r<<2|0)|0;i=o[a>>2]|0;if(i){r=je((i<<2)+8|0)|0;o[e+16>>2]=r;i=(o[a>>2]<<2)+8|0;if(i|0)ug(r|0,o[t+16>>2]|0,i|0)|0}else o[e+16>>2]=0;return}function Vi(e){e=e|0;var t=0,i=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0;m=e+24|0;n=e+20|0;t=(o[n>>2]|0)+(o[m>>2]|0)|0;o[n>>2]=t;if(t>>>0>32768){o[n>>2]=0;if(!(o[e>>2]|0))t=0;else{r=o[e+12>>2]|0;i=0;do{d=r+(i<<2)|0;t=((o[d>>2]|0)+1|0)>>>1;o[d>>2]=t;t=(o[n>>2]|0)+t|0;o[n>>2]=t;i=i+1|0}while(i>>>0<(o[e>>2]|0)>>>0)}}d=2147483648/(t>>>0)|0;do{if((s[e+4>>0]|0)==0?(p=e+36|0,(o[p>>2]|0)!=0):0){if(o[e>>2]|0){A=o[e+8>>2]|0;c=o[e+12>>2]|0;h=e+40|0;u=e+16|0;t=0;a=0;l=0;do{i=(v(a,d)|0)>>>16;o[A+(l<<2)>>2]=i;a=(o[c+(l<<2)>>2]|0)+a|0;i=i>>>(o[h>>2]|0);if(t>>>0<i>>>0){r=l+-1|0;n=o[u>>2]|0;do{t=t+1|0;o[n+(t<<2)>>2]=r}while((t|0)!=(i|0));t=i}l=l+1|0}while(l>>>0<(o[e>>2]|0)>>>0);i=o[u>>2]|0;o[i>>2]=0;if(t>>>0>(o[p>>2]|0)>>>0){t=e;break}}else{i=o[e+16>>2]|0;o[i>>2]=0;t=0}do{t=t+1|0;o[i+(t<<2)>>2]=(o[e>>2]|0)+-1}while(t>>>0<=(o[p>>2]|0)>>>0);t=e}else f=7}while(0);if((f|0)==7)if(!(o[e>>2]|0))t=e;else{r=o[e+8>>2]|0;n=o[e+12>>2]|0;t=0;i=0;do{o[r+(t<<2)>>2]=(v(i,d)|0)>>>16;i=(o[n+(t<<2)>>2]|0)+i|0;t=t+1|0}while(t>>>0<(o[e>>2]|0)>>>0);t=e}f=((o[m>>2]|0)*5|0)>>>2;p=(o[t>>2]<<3)+48|0;f=f>>>0>p>>>0?p:f;o[m>>2]=f;o[e+28>>2]=f;return}function Qi(e,t,i){e=e|0;t=t|0;i=i|0;var s=0;i=Hi(t,i)|0;o[e>>2]=i;do{if(i){if(i>>>0>=32){i=o[e+28>>2]|0;break}s=o[e+12>>2]|0;if(i>>>0>s>>>0){s=i-s|0;i=Hi(t,(o[e+68>>2]|0)+((i+-1|0)*44|0)|0)|0;s=i<<s|(ji(t,s)|0)}else s=Hi(t,(o[e+68>>2]|0)+((i+-1|0)*44|0)|0)|0;i=o[e>>2]|0;if((s|0)<(1<<i+-1|0)){i=s+1+(-1<<i)|0;break}else{i=s+1|0;break}}else i=Gi(t,e+48|0)|0}while(0);return i|0}function Hi(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0;d=e+8|0;u=o[d>>2]|0;r=o[t+16>>2]|0;if(r){s=e+4|0;i=o[s>>2]|0;h=u>>>15;o[d>>2]=h;A=(i>>>0)/(h>>>0)|0;l=A>>>(o[t+40>>2]|0);n=o[r+(l<<2)>>2]|0;l=(o[r+(l+1<<2)>>2]|0)+1|0;a=n+1|0;c=o[t+8>>2]|0;if(l>>>0>a>>>0){r=n;n=l;do{a=(n+r|0)>>>1;l=(o[c+(a<<2)>>2]|0)>>>0>A>>>0;r=l?r:a;n=l?a:n;a=r+1|0}while(n>>>0>a>>>0);n=r}r=v(o[c+(n<<2)>>2]|0,h)|0;if((n|0)==(o[t+32>>2]|0))a=u;else a=v(o[c+(a<<2)>>2]|0,h)|0}else{c=u>>>15;o[d>>2]=c;l=o[t>>2]|0;h=o[t+8>>2]|0;s=e+4|0;i=o[s>>2]|0;A=l>>>1;r=0;a=u;n=0;do{p=v(o[h+(A<<2)>>2]|0,c)|0;u=p>>>0>i>>>0;a=u?p:a;r=u?r:p;n=u?n:A;l=u?A:l;A=(n+l|0)>>>1}while((A|0)!=(n|0))}o[s>>2]=i-r;p=a-r|0;o[d>>2]=p;if(p>>>0<16777216)zi(e);d=(o[t+12>>2]|0)+(n<<2)|0;o[d>>2]=(o[d>>2]|0)+1;d=t+28|0;p=(o[d>>2]|0)+-1|0;o[d>>2]=p;if(!p)Vi(t);return n|0}function ji(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0;if(t>>>0>19){i=(Wi(e)|0)&65535;return(ji(e,t+-16|0)|0)<<16|i|0}s=e+4|0;r=o[s>>2]|0;n=e+8|0;i=(o[n>>2]|0)>>>t;o[n>>2]=i;t=(r>>>0)/(i>>>0)|0;o[s>>2]=r-(v(t,i)|0);if(i>>>0<16777216)zi(e);return t|0}function Gi(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0;s=e+8|0;r=o[s>>2]|0;i=v(r>>>13,o[t+8>>2]|0)|0;n=e+4|0;a=o[n>>2]|0;l=a>>>0>=i>>>0;if(l){o[n>>2]=a-i;i=r-i|0;o[s>>2]=i}else{o[s>>2]=i;a=t+12|0;o[a>>2]=(o[a>>2]|0)+1}if(i>>>0<16777216)zi(e);a=t+4|0;e=(o[a>>2]|0)+-1|0;o[a>>2]=e;if(!e)Xi(t);return l&1|0}function zi(e){e=e|0;var t=0,i=0,s=0,r=0;t=e+4|0;i=e+8|0;s=o[t>>2]|0;do{s=s<<8|(Ci(o[e>>2]|0)|0)&255;o[t>>2]=s;r=o[i>>2]<<8;o[i>>2]=r}while(r>>>0<16777216);return}function Wi(e){e=e|0;var t=0,i=0,s=0,r=0;i=e+4|0;r=o[i>>2]|0;t=e+8|0;s=(o[t>>2]|0)>>>16;o[t>>2]=s;t=(r>>>0)/(s>>>0)|0;o[i>>2]=r-(v(t,s)|0);zi(e);return t&65535|0}function Xi(e){e=e|0;var t=0,i=0,s=0,r=0,n=0;r=o[e>>2]|0;i=e+16|0;t=(o[i>>2]|0)+r|0;o[i>>2]=t;if(t>>>0>8192){s=(t+1|0)>>>1;o[i>>2]=s;n=e+12|0;t=((o[n>>2]|0)+1|0)>>>1;o[n>>2]=t;if((t|0)==(s|0)){t=s+1|0;o[i>>2]=t;i=t;t=s}else i=s}else{i=t;t=o[e+12>>2]|0}o[e+8>>2]=(v(t,2147483648/(i>>>0)|0)|0)>>>18;n=r*5|0;n=n>>>0>259?64:n>>>2;o[e>>2]=n;o[e+4>>2]=n;return}function Ki(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0;u=J;J=J+32|0;a=u+16|0;l=u+8|0;A=u;c=e+336|0;s=c;r=e+259|0;if(!((o[s+4>>2]|0)==0?(o[s>>2]|0)==(n[r>>0]|n[r+1>>0]<<8|n[r+2>>0]<<16|n[r+3>>0]<<24|0):0)){s=e+320|0;i=o[s>>2]|0;r=i;if(!((i|0)!=0?(o[e+312>>2]|0)!=0:0)){i=r;h=5}}else{s=e+320|0;i=o[e+320>>2]|0;h=5}if((h|0)==5){h=e+320|0;o[a>>2]=i;o[h>>2]=0;i=e+324|0;o[a+4>>2]=o[i>>2];o[i>>2]=0;Ie(a);r=e+312|0;o[a>>2]=o[r>>2];o[r>>2]=0;d=e+316|0;o[a+4>>2]=o[d>>2];o[d>>2]=0;Te(a);p=Zf(12)|0;ii(p,e+4|0);o[A>>2]=0;o[a>>2]=o[A>>2];Ji(l,p,a);p=o[l>>2]|0;o[l>>2]=o[r>>2];o[r>>2]=p;p=l+4|0;A=o[p>>2]|0;o[p>>2]=o[d>>2];o[d>>2]=A;Te(l);Zi(l,o[r>>2]|0,e+300|0);r=o[l>>2]|0;d=l+4|0;A=o[d>>2]|0;o[l>>2]=0;o[d>>2]=0;o[a>>2]=o[h>>2];o[h>>2]=r;o[a+4>>2]=o[i>>2];o[i>>2]=A;Ie(a);Ie(l);i=e+328|0;A=i;A=ig(o[A>>2]|0,o[A+4>>2]|0,1,0)|0;h=B()|0;o[i>>2]=A;o[i+4>>2]=h;i=c;o[i>>2]=0;o[i+4>>2]=0;i=o[s>>2]|0}Qg[o[o[i>>2]>>2]&63](i,t)|0;h=c;h=ig(o[h>>2]|0,o[h+4>>2]|0,1,0)|0;d=B()|0;p=c;o[p>>2]=h;o[p+4>>2]=d;J=u;return}function Zi(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0,n=0,a=0;a=J;J=J+64|0;s=a+56|0;r=a;n=is(i)|0;if((n|0)==-1){a=P(8)|0;ss(a);C(a|0,2784,8)}i=rs(i)|0;e:do{if(!i)switch(n|0){case 0:{n=Zf(4788)|0;ps(n);ds(e,t,n);break e}case 1:{n=Zf(5116)|0;ms(n);fs(e,t,n);break e}case 2:{n=Zf(5104)|0;_s(n);gs(e,t,n);break e}case 3:{n=Zf(5432)|0;bs(n);vs(e,t,n);break e}default:{o[e>>2]=0;o[e+4>>2]=0;break e}}else{os(s,t);ns(o[s>>2]|0);if((n|2|0)==3)as(o[s>>2]|0);if((n|1|0)==3)ls(o[s>>2]|0);n=o[s>>2]|0;cs(r,i);As(n,r);hs(r);o[e>>2]=o[s>>2];n=s+4|0;o[e+4>>2]=o[n>>2];o[s>>2]=0;o[n>>2]=0;us(s)}}while(0);J=a;return}function Ji(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=4576;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Yi(e,s);J=i;return}function Yi(e,t){e=e|0;t=t|0;return}function qi(e){e=e|0;nm(e);$p(e);return}function $i(e){e=e|0;e=o[e+12>>2]|0;if(e|0){li(e);$p(e)}return}function es(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==7983?e+12|0:0)|0}function ts(e){e=e|0;be(e,16);return}function is(e){e=e|0;var t=0,i=0;t=(o[e+4>>2]|0)-(o[e>>2]|0)|0;e:do{if(((t|0)!=0?(i=((t|0)/12|0)+(((rs(e)|0)!=0)<<31>>31)|0,(i|0)!=0):0)?(t=o[e>>2]|0,!(ys(t,ws()|0)|0)):0){switch(i|0){case 1:{e=0;break e}case 2:{if(Bs((o[e>>2]|0)+12|0,Ps()|0)|0){e=1;break e}if(Bs((o[e>>2]|0)+12|0,xs()|0)|0){e=2;break e}break}case 3:{if(Bs((o[e>>2]|0)+12|0,Ps()|0)|0?(i=(o[e>>2]|0)+24|0,Bs(i,xs()|0)|0):0){e=3;break e}break}default:{}}e=-1}else e=-1}while(0);return e|0}function ss(e){e=e|0;pm(e,8131);o[e>>2]=4604;return}function rs(e){e=e|0;var t=0,i=0;t=o[e+4>>2]|0;if(((t|0)!=(o[e>>2]|0)?(i=t,(o[i+-12>>2]|0)==0):0)?(o[i+-4>>2]|0)==2:0)e=o[i+-8>>2]|0;else e=0;return e|0}function os(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0;i=J;J=J+16|0;s=i+4|0;n=i;r=Zf(24)|0;Ms(r,t);o[n>>2]=0;o[s>>2]=o[n>>2];Es(e,r,s);J=i;return}function ns(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0;A=J;J=J+32|0;s=A+12|0;r=A;t=A+8|0;a=Zf(4792)|0;Hs(a,o[e+4>>2]|0);n=e+8|0;o[t>>2]=0;o[s>>2]=o[t>>2];js(r,a,s);a=e+12|0;t=o[a>>2]|0;l=e+16|0;do{if(t>>>0>=(o[l>>2]|0)>>>0){t=(t-(o[n>>2]|0)>>3)+1|0;i=Zs(n)|0;if(i>>>0<t>>>0)Xm(n);else{c=o[n>>2]|0;h=(o[l>>2]|0)-c|0;l=h>>2;Ws(s,h>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(o[a>>2]|0)-c>>3,e+16|0);l=s+8|0;a=o[l>>2]|0;o[a>>2]=o[r>>2];e=r+4|0;o[a+4>>2]=o[e>>2];o[r>>2]=0;o[e>>2]=0;o[l>>2]=a+8;Xs(n,s);Ks(s);break}}else{Gs(s,n,1);h=s+4|0;c=o[h>>2]|0;o[c>>2]=o[r>>2];l=r+4|0;o[c+4>>2]=o[l>>2];o[r>>2]=0;o[l>>2]=0;o[h>>2]=c+8;zs(s)}}while(0);Us(r);J=A;return}function as(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0;A=J;J=J+32|0;s=A+12|0;r=A;t=A+8|0;a=Zf(336)|0;zr(a,o[e+4>>2]|0);n=e+8|0;o[t>>2]=0;o[s>>2]=o[t>>2];Wr(r,a,s);a=e+12|0;t=o[a>>2]|0;l=e+16|0;do{if(t>>>0>=(o[l>>2]|0)>>>0){t=(t-(o[n>>2]|0)>>3)+1|0;i=Zs(n)|0;if(i>>>0<t>>>0)Xm(n);else{c=o[n>>2]|0;h=(o[l>>2]|0)-c|0;l=h>>2;Ws(s,h>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(o[a>>2]|0)-c>>3,e+16|0);l=s+8|0;a=o[l>>2]|0;o[a>>2]=o[r>>2];e=r+4|0;o[a+4>>2]=o[e>>2];o[r>>2]=0;o[e>>2]=0;o[l>>2]=a+8;Xs(n,s);Ks(s);break}}else{Gs(s,n,1);h=s+4|0;c=o[h>>2]|0;o[c>>2]=o[r>>2];l=r+4|0;o[c+4>>2]=o[l>>2];o[r>>2]=0;o[l>>2]=0;o[h>>2]=c+8;zs(s)}}while(0);Us(r);J=A;return}function ls(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0;A=J;J=J+32|0;s=A+12|0;r=A;t=A+8|0;a=Zf(324)|0;go(a,o[e+4>>2]|0);n=e+8|0;o[t>>2]=0;o[s>>2]=o[t>>2];_o(r,a,s);a=e+12|0;t=o[a>>2]|0;l=e+16|0;do{if(t>>>0>=(o[l>>2]|0)>>>0){t=(t-(o[n>>2]|0)>>3)+1|0;i=Zs(n)|0;if(i>>>0<t>>>0)Xm(n);else{c=o[n>>2]|0;h=(o[l>>2]|0)-c|0;l=h>>2;Ws(s,h>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(o[a>>2]|0)-c>>3,e+16|0);l=s+8|0;a=o[l>>2]|0;o[a>>2]=o[r>>2];e=r+4|0;o[a+4>>2]=o[e>>2];o[r>>2]=0;o[e>>2]=0;o[l>>2]=a+8;Xs(n,s);Ks(s);break}}else{Gs(s,n,1);h=s+4|0;c=o[h>>2]|0;o[c>>2]=o[r>>2];l=r+4|0;o[c+4>>2]=o[l>>2];o[r>>2]=0;o[l>>2]=0;o[h>>2]=c+8;zs(s)}}while(0);Us(r);J=A;return}function As(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0;A=J;J=J+32|0;a=A+12|0;l=A;s=A+8|0;n=Zf(64)|0;So(n,o[e+4>>2]|0,t);r=e+8|0;o[s>>2]=0;o[a>>2]=o[s>>2];Ro(l,n,a);n=e+12|0;t=o[n>>2]|0;s=e+16|0;do{if(t>>>0>=(o[s>>2]|0)>>>0){t=(t-(o[r>>2]|0)>>3)+1|0;i=Zs(r)|0;if(i>>>0<t>>>0)Xm(r);else{c=o[r>>2]|0;h=(o[s>>2]|0)-c|0;s=h>>2;Ws(a,h>>3>>>0<i>>>1>>>0?s>>>0<t>>>0?t:s:i,(o[n>>2]|0)-c>>3,e+16|0);e=a+8|0;n=o[e>>2]|0;o[n>>2]=o[l>>2];s=l+4|0;o[n+4>>2]=o[s>>2];o[l>>2]=0;o[s>>2]=0;o[e>>2]=n+8;Xs(r,a);Ks(a);break}}else{Gs(a,r,1);h=a+4|0;c=o[h>>2]|0;o[c>>2]=o[l>>2];e=l+4|0;o[c+4>>2]=o[e>>2];o[l>>2]=0;o[e>>2]=0;o[h>>2]=c+8;zs(a)}}while(0);Us(l);J=A;return}function cs(e,t){e=e|0;t=t|0;var i=0,r=0;i=J;J=J+48|0;r=i;o[e>>2]=t;s[e+4>>0]=0;Mn(e+8|0,t);Mn(e+20|0,t);Ti(r,256,0,0);En(e+32|0,t,r);xi(r);J=i;return}function hs(e){e=e|0;Tn(e+32|0);jo(e+20|0);jo(e+8|0);return}function us(e){e=e|0;var t=0,i=0;e=o[e+4>>2]|0;if(e|0?(i=e+4|0,t=o[i>>2]|0,o[i>>2]=t+-1,(t|0)==0):0){Gg[o[(o[e>>2]|0)+8>>2]&255](e);am(e)}return}function ds(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0,n=0,a=0;s=J;J=J+16|0;r=s+4|0;a=s;n=Zf(12)|0;Dn(n,t,i);o[a>>2]=0;o[r>>2]=o[a>>2];Sn(e,n,r);J=s;return}function ps(e){e=e|0;Ys(e);zn(e+4784|0);return}function fs(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0,n=0,a=0;s=J;J=J+16|0;r=s+4|0;a=s;n=Zf(12)|0;Wn(n,t,i);o[a>>2]=0;o[r>>2]=o[a>>2];Xn(e,n,r);J=s;return}function ms(e){e=e|0;Ys(e);oa(e+4784|0);return}function gs(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0,n=0,a=0;s=J;J=J+16|0;r=s+4|0;a=s;n=Zf(12)|0;na(n,t,i);o[a>>2]=0;o[r>>2]=o[a>>2];aa(e,n,r);J=s;return}function _s(e){e=e|0;Ys(e);va(e+4784|0);return}function vs(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0,n=0,a=0;s=J;J=J+16|0;r=s+4|0;a=s;n=Zf(12)|0;ba(n,t,i);o[a>>2]=0;o[r>>2]=o[a>>2];ya(e,n,r);J=s;return}function bs(e){e=e|0;Ys(e);Sa(e+4784|0);return}function ys(e,t){e=e|0;t=t|0;return(Bs(e,t)|0)^1|0}function ws(){if((s[21456]|0)==0?Lf(21456)|0:0){jt(21536,6,20,2);Gf(21456)}return 21536}function Bs(e,t){e=e|0;t=t|0;if((o[e>>2]|0)==(o[t>>2]|0)?(o[e+8>>2]|0)==(o[t+8>>2]|0):0)e=(o[e+4>>2]|0)==(o[t+4>>2]|0);else e=0;return e|0}function Ps(){if((s[21464]|0)==0?Lf(21464)|0:0){jt(21548,7,8,2);Gf(21464)}return 21548}function xs(){if((s[21472]|0)==0?Lf(21472)|0:0){jt(21560,8,6,2);Gf(21472)}return 21560}function Cs(e){e=e|0;ff(e);$p(e);return}function Ms(e,t){e=e|0;t=t|0;Fs(e);o[e>>2]=4624;o[e+4>>2]=t;o[e+8>>2]=0;o[e+12>>2]=0;o[e+16>>2]=0;s[e+20>>0]=1;return}function Es(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=4664;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;ks(e,s);J=i;return}function Fs(e){e=e|0;o[e>>2]=4644;return}function Is(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,a=0,l=0,A=0,c=0;c=J;J=J+16|0;a=c;i=o[e+8>>2]|0;l=o[e+12>>2]|0;if((i|0)!=(l|0)){A=a+4|0;do{r=o[i>>2]|0;o[a>>2]=r;n=o[i+4>>2]|0;o[A>>2]=n;if(n|0){n=n+4|0;o[n>>2]=(o[n>>2]|0)+1}t=Qg[o[(o[r>>2]|0)+12>>2]&63](r,t)|0;Us(a);i=i+8|0}while((i|0)!=(l|0))}i=e+20|0;if(s[i>>0]|0){s[i>>0]=0;ri(o[e+4>>2]|0)}J=c;return t|0}function Ts(e){e=e|0;o[e>>2]=4624;Ls(e+8|0);Ss(e);return}function Ds(e){e=e|0;Ts(e);$p(e);return}function Ss(e){e=e|0;return}function Rs(e){e=e|0;Z()}function Us(e){e=e|0;var t=0,i=0;e=o[e+4>>2]|0;if(e|0?(i=e+4|0,t=o[i>>2]|0,o[i>>2]=t+-1,(t|0)==0):0){Gg[o[(o[e>>2]|0)+8>>2]&255](e);am(e)}return}function Ls(e){e=e|0;var t=0,i=0,s=0;i=o[e>>2]|0;if(i|0){s=e+4|0;t=o[s>>2]|0;if((t|0)==(i|0))t=i;else{do{t=t+-8|0;Us(t)}while((t|0)!=(i|0));t=o[e>>2]|0}o[s>>2]=i;be(t,(o[e+8>>2]|0)-t|0)}return}function ks(e,t){e=e|0;t=t|0;return}function Os(e){e=e|0;nm(e);$p(e);return}function Ns(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+8>>2]&255](e);return}function Vs(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==8546?e+12|0:0)|0}function Qs(e){e=e|0;be(e,16);return}function Hs(e,t){e=e|0;t=t|0;Js(e);o[e>>2]=4692;o[e+4>>2]=t;Ys(e+8|0);return}function js(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=4740;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vr(e,s);J=i;return}function Gs(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=t;t=o[t+4>>2]|0;o[e+4>>2]=t;o[e+8>>2]=t+(i<<3);return}function zs(e){e=e|0;o[(o[e>>2]|0)+4>>2]=o[e+4>>2];return}function Ws(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0;r=e+12|0;o[r>>2]=0;o[e+16>>2]=s;do{if(t)if(t>>>0>536870911){r=P(8)|0;um(r,6723);o[r>>2]=5956;C(r|0,3928,123)}else{s=Zf(t<<3)|0;break}else s=0}while(0);o[e>>2]=s;i=s+(i<<3)|0;o[e+8>>2]=i;o[e+4>>2]=i;o[r>>2]=s+(t<<3);return}function Xs(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0;l=o[e>>2]|0;A=e+4|0;i=o[A>>2]|0;a=t+4|0;if((i|0)==(l|0)){r=a;n=e;s=o[a>>2]|0;i=l}else{s=o[a>>2]|0;do{n=i;i=i+-8|0;o[s+-8>>2]=o[i>>2];n=n+-4|0;o[s+-4>>2]=o[n>>2];o[i>>2]=0;o[n>>2]=0;s=(o[a>>2]|0)+-8|0;o[a>>2]=s}while((i|0)!=(l|0));r=a;n=e;i=o[e>>2]|0}o[n>>2]=s;o[r>>2]=i;l=t+8|0;a=o[A>>2]|0;o[A>>2]=o[l>>2];o[l>>2]=a;l=e+8|0;A=t+12|0;e=o[l>>2]|0;o[l>>2]=o[A>>2];o[A>>2]=e;o[t>>2]=o[r>>2];return}function Ks(e){e=e|0;var t=0,i=0,s=0,r=0;i=o[e+4>>2]|0;s=e+8|0;t=o[s>>2]|0;if((t|0)!=(i|0))do{r=t+-8|0;o[s>>2]=r;Us(r);t=o[s>>2]|0}while((t|0)!=(i|0));t=o[e>>2]|0;if(t|0)be(t,(o[e+12>>2]|0)-t|0);return}function Zs(e){e=e|0;return 536870911}function Js(e){e=e|0;o[e>>2]=4716;return}function Ys(e){e=e|0;or(e);nr(e+3980|0);ar(e+4380|0);s[e+4780>>0]=0;s[e+4781>>0]=0;return}function qs(e){e=e|0;o[e>>2]=4692;mr(e+8|0);ir(e);return}function $s(e){e=e|0;qs(e);$p(e);return}function er(e,t){e=e|0;t=t|0;return t|0}function tr(e,t){e=e|0;t=t|0;return _r(e+8|0,o[e+4>>2]|0,t)|0}function ir(e){e=e|0;return}function sr(e){e=e|0;ir(e);$p(e);return}function rr(e,t){e=e|0;t=t|0;return t|0}function or(e){e=e|0;var t=0,i=0;cr(e);hr(e+52|0);hr(e+436|0);Ti(e+852|0,64,0,0);s[e+3976>>0]=0;t=e+20|0;i=t+32|0;do{r[t>>1]=0;t=t+2|0}while((t|0)<(i|0));t=Zf(44)|0;Ti(t,256,0,0);o[e+896>>2]=t;t=Zf(44)|0;Ti(t,256,0,0);o[e+900>>2]=t;t=e+820|0;o[t>>2]=0;o[t+4>>2]=0;o[t+8>>2]=0;o[t+12>>2]=0;o[t+16>>2]=0;o[t+20>>2]=0;o[t+24>>2]=0;o[t+28>>2]=0;t=0;do{i=Zf(44)|0;Ti(i,256,0,0);o[e+904+(t<<2)>>2]=i;i=Zf(44)|0;Ti(i,256,0,0);o[e+1928+(t<<2)>>2]=i;i=Zf(44)|0;Ti(i,256,0,0);o[e+2952+(t<<2)>>2]=i;t=t+1|0}while(t>>>0<256);return}function nr(e){e=e|0;pr(e,16,4,8,0);pr(e+80|0,16,1,8,0);pr(e+160|0,32,2,8,0);pr(e+240|0,32,22,8,0);pr(e+320|0,32,20,8,0);return}function ar(e){e=e|0;si(e,16,4,8,0);si(e+80|0,16,1,8,0);si(e+160|0,32,2,8,0);si(e+240|0,32,22,8,0);si(e+320|0,32,20,8,0);return}function lr(e){e=e|0;fr(e+320|0);fr(e+240|0);fr(e+160|0);fr(e+80|0);fr(e);return}function Ar(e){e=e|0;var t=0,i=0;t=o[e+896>>2]|0;if(t|0){xi(t);$p(t)}t=o[e+900>>2]|0;if(t|0){xi(t);$p(t)}i=0;do{t=o[e+904+(i<<2)>>2]|0;if(t|0){xi(t);$p(t)}t=o[e+1928+(i<<2)>>2]|0;if(t|0){xi(t);$p(t)}t=o[e+2952+(i<<2)>>2]|0;if(t|0){xi(t);$p(t)}i=i+1|0}while((i|0)!=256);xi(e+852|0);return}function cr(e){e=e|0;var t=0;s[e>>0]=0;s[e+1>>0]=0;s[e+2>>0]=0;s[e+3>>0]=0;t=e+4|0;s[t>>0]=0;s[t+1>>0]=0;s[t+2>>0]=0;s[t+3>>0]=0;e=e+12|0;t=e;s[t>>0]=0;s[t+1>>0]=0;s[t+2>>0]=0;s[t+3>>0]=0;e=e+4|0;s[e>>0]=0;s[e+1>>0]=0;s[e+2>>0]=0;s[e+3>>0]=0;return}function hr(e){e=e|0;var t=0;t=e+384|0;do{ur(e);e=e+24|0}while((e|0)!=(t|0));return}function ur(e){e=e|0;dr(e);return}function dr(e){e=e|0;o[e>>2]=0;o[e+4>>2]=0;o[e+8>>2]=0;o[e+12>>2]=0;o[e+16>>2]=0;s[e+20>>0]=1;return}function pr(e,t,i,s,r){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;var n=0;o[e+4>>2]=t;o[e+8>>2]=i;o[e+12>>2]=s;o[e+16>>2]=r;o[e+36>>2]=0;o[e+40>>2]=0;o[e+44>>2]=0;Bi(e+48|0);o[e+68>>2]=0;o[e+72>>2]=0;o[e+76>>2]=0;do{if(!r){i=e+20|0;if((t+-1|0)>>>0<31){o[i>>2]=t;r=1<<t;o[e+24>>2]=r;i=r>>>1;o[e+28>>2]=0-i;i=r+-1-i|0;break}else{o[i>>2]=32;o[e+24>>2]=0;o[e+28>>2]=-2147483648;i=2147483647;break}}else{s=e+20|0;o[s>>2]=0;o[e+24>>2]=r;i=r;n=0;while(1){i=i>>>1;t=n+1|0;if(!i)break;else n=t}o[s>>2]=(1<<n|0)==(r|0)?n:t;i=r>>>1;o[e+28>>2]=0-i;i=r+-1-i|0}}while(0);o[e+32>>2]=i;o[e>>2]=0;return}function fr(e){e=e|0;var t=0,i=0,s=0,r=0,n=0;n=e+36|0;i=o[n>>2]|0;s=e+40|0;t=o[s>>2]|0;if((t|0)!=(i|0))do{t=t+-44|0;xi(t)}while((t|0)!=(i|0));o[s>>2]=i;s=e+68|0;r=o[s>>2]|0;i=e+72|0;t=o[i>>2]|0;if((t|0)!=(r|0))do{t=t+-44|0;xi(t)}while((t|0)!=(r|0));o[i>>2]=r;Pi(s);Pi(n);return}function mr(e){e=e|0;gr(e+4380|0);lr(e+3980|0);Ar(e);return}function gr(e){e=e|0;ai(e+320|0);ai(e+240|0);ai(e+160|0);ai(e+80|0);ai(e);return}function _r(e,t,i){e=e|0;t=t|0;i=i|0;var l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0;f=J;J=J+32|0;p=f;l=e+4781|0;if(!(s[l>>0]|0)){vr(e+4380|0);s[l>>0]=1}l=e+3976|0;if(!(s[l>>0]|0)){s[l>>0]=1;yr(br(t)|0,i,20);wr(p,i);c=e;l=p;A=c+20|0;do{s[c>>0]=s[l>>0]|0;c=c+1|0;l=l+1|0}while((c|0)<(A|0));r[e+12>>1]=0}else{u=Hi(t,e+852|0)|0;if(u){if(u&32|0)Pr((Hi(t,o[e+904+(((Br(e)|0)&255)<<2)>>2]|0)|0)&255,e);d=e+14|0;c=s[d>>0]|0;l=c&7;c=(c&255)>>>3&7;A=n[16+(c<<3)+l>>0]|0;l=n[80+(c<<3)+l>>0]|0;if(!(u&16))h=r[e+20+(A<<1)>>1]|0;else{m=e+20+(A<<1)|0;h=(ni(e+4380|0,t,a[m>>1]|0,A>>>0<3?A:3)|0)&65535;r[m>>1]=h}r[e+12>>1]=h;if(u&8|0){m=e+15|0;s[m>>0]=Hi(t,o[e+1928+(n[m>>0]<<2)>>2]|0)|0}if(u&4|0){d=Hi(t,o[e+896+(((n[d>>0]|0)>>>6&1)<<2)>>2]|0)|0;m=e+16|0;s[m>>0]=xr(d+(s[m>>0]|0)|0)|0}if(u&2|0){m=e+17|0;s[m>>0]=Hi(t,o[e+2952+(n[m>>0]<<2)>>2]|0)|0}if(u&1){m=e+18|0;r[m>>1]=ni(e+4460|0,t,a[m>>1]|0,0)|0}}else{m=s[e+14>>0]|0;l=m&7;m=(m&255)>>>3&7;c=m;A=n[16+(m<<3)+l>>0]|0;l=n[80+(m<<3)+l>>0]|0}h=e+52+(A*24|0)|0;u=e+4540|0;d=(c|0)==1&1;c=ni(u,t,Cr(h)|0,d)|0;o[p>>2]=c;o[e>>2]=(o[e>>2]|0)+c;Mr(h,p);h=e+436+(A*24|0)|0;c=Cr(h)|0;A=Er(u)|0;m=e+4620|0;A=ni(m,t,c,(A>>>0<20?A&-2:20)|d)|0;o[p>>2]=A;c=e+4|0;o[c>>2]=(o[c>>2]|0)+A;Mr(h,p);p=Er(u)|0;p=(Er(m)|0)+p|0;m=e+820+(l<<2)|0;p=ni(e+4700|0,t,o[m>>2]|0,(p>>>0<36?p>>>1&2147483646:18)|d)|0;o[e+8>>2]=p;o[m>>2]=p;Fr(e,i)}J=f;return i+20|0}function vr(e){e=e|0;oi(e);oi(e+80|0);oi(e+160|0);oi(e+240|0);oi(e+320|0);return}function br(e){e=e|0;return o[e>>2]|0}function yr(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0,l=0,A=0,c=0;c=e+4|0;r=o[c>>2]|0;A=(o[e+8>>2]|0)-r|0;A=A>>>0>i>>>0?i:A;l=e+12|0;n=(o[l>>2]|0)+r|0;a=n+A|0;if(A){r=n;n=t;while(1){s[n>>0]=s[r>>0]|0;r=r+1|0;if((r|0)==(a|0))break;else n=n+1|0}r=o[c>>2]|0}o[c>>2]=r+A;i=i-A|0;if(i|0){Mi(e);n=(o[l>>2]|0)+(o[c>>2]|0)|0;a=n+i|0;r=t+A|0;while(1){s[r>>0]=s[n>>0]|0;n=n+1|0;if((n|0)==(a|0))break;else r=r+1|0}o[c>>2]=(o[c>>2]|0)+i}return}function wr(e,t){e=e|0;t=t|0;cr(e);o[e>>2]=Ir(t)|0;o[e+4>>2]=Ir(t+4|0)|0;o[e+8>>2]=Ir(t+8|0)|0;r[e+12>>1]=Tr(t+12|0)|0;Pr(Dr(t+14|0)|0,e);s[e+15>>0]=Dr(t+15|0)|0;s[e+16>>0]=Sr(t+16|0)|0;s[e+17>>0]=Sr(t+17|0)|0;r[e+18>>1]=Tr(t+18|0)|0;return}function Br(e){e=e|0;return s[e+14>>0]|0}function Pr(e,t){e=e|0;t=t|0;s[t+14>>0]=e;return}function xr(e){e=e|0;return e&255|0}function Cr(e){e=e|0;return o[e+8>>2]|0}function Mr(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,a=0,l=0,A=0,c=0;c=e+20|0;do{if(!(s[c>>0]|0)){A=e+8|0;i=o[A>>2]|0;r=o[t>>2]|0;n=e+4|0;a=o[n>>2]|0;if((i|0)>=(r|0)){if((a|0)<(r|0)){o[e>>2]=a;o[n>>2]=o[t>>2]}else o[e>>2]=r;s[c>>0]=1;break}o[e>>2]=a;o[n>>2]=i;n=e+16|0;a=o[n>>2]|0;l=o[t>>2]|0;i=e+12|0;r=o[i>>2]|0;if((a|0)<(l|0)){o[A>>2]=r;o[i>>2]=a;o[n>>2]=o[t>>2];break}if((r|0)<(l|0)){o[A>>2]=r;o[i>>2]=o[t>>2];break}else{o[A>>2]=l;break}}else{n=o[t>>2]|0;l=e+8|0;i=o[l>>2]|0;a=e+12|0;r=o[a>>2]|0;if((n|0)>=(i|0)){i=e+16|0;if((n|0)<(r|0)){o[i>>2]=r;o[a>>2]=o[t>>2]}else o[i>>2]=n;s[c>>0]=0;break}o[e+16>>2]=r;o[a>>2]=i;i=o[t>>2]|0;r=o[e>>2]|0;n=e+4|0;a=o[n>>2]|0;if((i|0)<(r|0)){o[l>>2]=a;o[n>>2]=r;o[e>>2]=o[t>>2];break}if((i|0)<(a|0)){o[l>>2]=a;o[n>>2]=o[t>>2];break}else{o[l>>2]=i;break}}}while(0);return}function Er(e){e=e|0;return o[e>>2]|0}function Fr(e,t){e=e|0;t=t|0;var i=0;Ur(n[e>>0]|n[e+1>>0]<<8|n[e+2>>0]<<16|n[e+3>>0]<<24,t);i=e+4|0;Ur(n[i>>0]|n[i+1>>0]<<8|n[i+2>>0]<<16|n[i+3>>0]<<24,t+4|0);i=e+8|0;Ur(n[i>>0]|n[i+1>>0]<<8|n[i+2>>0]<<16|n[i+3>>0]<<24,t+8|0);i=e+12|0;Lr(n[i>>0]|n[i+1>>0]<<8,t+12|0);kr(Br(e)|0,t+14|0);kr(s[e+15>>0]|0,t+15|0);Or(s[e+16>>0]|0,t+16|0);Or(s[e+17>>0]|0,t+17|0);e=e+18|0;Lr(n[e>>0]|n[e+1>>0]<<8,t+18|0);return}function Ir(e){e=e|0;return Rr(e)|0}function Tr(e){e=e|0;return(s[e+1>>0]<<8|n[e>>0])&65535|0}function Dr(e){e=e|0;return s[e>>0]|0}function Sr(e){e=e|0;return s[e>>0]|0}function Rr(e){e=e|0;return(n[e+1>>0]|0)<<8|(n[e>>0]|0)|(n[e+2>>0]|0)<<16|(n[e+3>>0]|0)<<24|0}function Ur(e,t){e=e|0;t=t|0;Nr(e,t);return}function Lr(e,t){e=e|0;t=t|0;s[t+1>>0]=(e&65535)>>>8;s[t>>0]=e;return}function kr(e,t){e=e|0;t=t|0;s[t>>0]=e;return}function Or(e,t){e=e|0;t=t|0;s[t>>0]=e;return}function Nr(e,t){e=e|0;t=t|0;s[t+3>>0]=e>>>24;s[t+2>>0]=e>>>16;s[t+1>>0]=e>>>8;s[t>>0]=e;return}function Vr(e,t){e=e|0;t=t|0;return}function Qr(e){e=e|0;nm(e);$p(e);return}function Hr(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+4>>2]&255](e);return}function jr(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==9202?e+12|0:0)|0}function Gr(e){e=e|0;be(e,16);return}function zr(e,t){e=e|0;t=t|0;Js(e);o[e>>2]=4768;o[e+4>>2]=t;Xr(e+8|0);return}function Wr(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=4792;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vr(e,s);J=i;return}function Xr(e){e=e|0;Yr(e);qr(e+164|0);$r(e+244|0);s[e+324>>0]=0;s[e+325>>0]=0;return}function Kr(e){e=e|0;o[e>>2]=4768;ro(e+8|0);ir(e);return}function Zr(e){e=e|0;Kr(e);$p(e);return}function Jr(e,t){e=e|0;t=t|0;return no(e+8|0,o[e+4>>2]|0,t)|0}function Yr(e){e=e|0;var t=0,i=0,r=0,n=0,a=0,l=0,A=0;a=J;J=J+16|0;r=a;s[e>>0]=0;Ti(e+4|0,516,0,0);Ti(e+48|0,6,0,0);o[e+92>>2]=0;o[e+96>>2]=0;i=e+100|0;io(i);so(r);n=o[r>>2]|0;r=o[r+4>>2]|0;t=4;while(1){l=i;A=l;s[A>>0]=n;s[A+1>>0]=n>>8;s[A+2>>0]=n>>16;s[A+3>>0]=n>>24;l=l+4|0;s[l>>0]=r;s[l+1>>0]=r>>8;s[l+2>>0]=r>>16;s[l+3>>0]=r>>24;t=t+-1|0;if(!t)break;else i=i+8|0}A=e+132|0;o[A>>2]=0;o[A+4>>2]=0;o[A+8>>2]=0;o[A+12>>2]=0;o[A+16>>2]=0;o[A+20>>2]=0;o[A+24>>2]=0;o[A+28>>2]=0;J=a;return}function qr(e){e=e|0;pr(e,32,9,8,0);return}function $r(e){e=e|0;si(e,32,9,8,0);return}function eo(e){e=e|0;fr(e);return}function to(e){e=e|0;xi(e+48|0);xi(e+4|0);return}function io(e){e=e|0;var t=0;t=e+32|0;do{so(e);e=e+8|0}while((e|0)!=(t|0));return}function so(e){e=e|0;var t=0;t=e;s[t>>0]=0;s[t+1>>0]=0;s[t+2>>0]=0;s[t+3>>0]=0;e=e+4|0;s[e>>0]=0;s[e+1>>0]=0;s[e+2>>0]=0;s[e+3>>0]=0;return}function ro(e){e=e|0;oo(e+244|0);eo(e+164|0);to(e);return}function oo(e){e=e|0;ai(e);return}function no(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,a=0,l=0,A=0,c=0;r=e+325|0;if(!(s[r>>0]|0)){ao(e+244|0);s[r>>0]=1}if(!(s[e>>0]|0)){s[e>>0]=1;yr(br(t)|0,i,8);l=lo(i)|0;A=B()|0;e=e+100|0;t=e;s[t>>0]=l;s[t+1>>0]=l>>8;s[t+2>>0]=l>>16;s[t+3>>0]=l>>24;e=e+4|0;s[e>>0]=A;s[e+1>>0]=A>>8;s[e+2>>0]=A>>16;s[e+3>>0]=A>>24}else{A=e+92|0;e:do{if(!(o[e+132+(o[A>>2]<<2)>>2]|0)){r=Hi(t,e+48|0)|0;switch(r|0){case 1:{t=ni(e+244|0,t,0,0)|0;o[e+132+(o[A>>2]<<2)>>2]=t;t=o[A>>2]|0;c=o[e+132+(t<<2)>>2]|0;l=e+100+(t<<3)|0;a=l;r=a;a=a+4|0;c=ig(n[r>>0]|n[r+1>>0]<<8|n[r+2>>0]<<16|n[r+3>>0]<<24|0,n[a>>0]|n[a+1>>0]<<8|n[a+2>>0]<<16|n[a+3>>0]<<24|0,c|0,((c|0)<0)<<31>>31|0)|0;a=B()|0;r=l;s[r>>0]=c;s[r+1>>0]=c>>8;s[r+2>>0]=c>>16;s[r+3>>0]=c>>24;l=l+4|0;s[l>>0]=a;s[l+1>>0]=a>>8;s[l+2>>0]=a>>16;s[l+3>>0]=a>>24;o[e+148+(t<<2)>>2]=0;break e}case 2:{c=e+96|0;o[c>>2]=(o[c>>2]|0)+1&3;l=e+100+(o[A>>2]<<3)+4|0;l=ni(e+244|0,t,n[l>>0]|n[l+1>>0]<<8|n[l+2>>0]<<16|n[l+3>>0]<<24,8)|0;r=e+100+(o[c>>2]<<3)|0;a=r;s[a>>0]=0;s[a+1>>0]=0;s[a+2>>0]=0;s[a+3>>0]=0;r=r+4|0;s[r>>0]=l;s[r+1>>0]=l>>8;s[r+2>>0]=l>>16;s[r+3>>0]=l>>24;r=Ao(t)|0;c=o[c>>2]|0;t=e+100+(c<<3)|0;l=t;a=l;l=l+4|0;l=n[l>>0]|n[l+1>>0]<<8|n[l+2>>0]<<16|n[l+3>>0]<<24;r=n[a>>0]|n[a+1>>0]<<8|n[a+2>>0]<<16|n[a+3>>0]<<24|r;a=t;s[a>>0]=r;s[a+1>>0]=r>>8;s[a+2>>0]=r>>16;s[a+3>>0]=r>>24;t=t+4|0;s[t>>0]=l;s[t+1>>0]=l>>8;s[t+2>>0]=l>>16;s[t+3>>0]=l>>24;o[A>>2]=c;o[e+132+(c<<2)>>2]=0;o[e+148+(o[A>>2]<<2)>>2]=0;break e}default:{if((r|0)<=2)break e;o[A>>2]=r+2+(o[A>>2]|0)&3;no(e,t,i)|0;break e}}}else{l=Hi(t,e+4|0)|0;if((l|0)==1){r=ni(e+244|0,t,o[e+132+(o[A>>2]<<2)>>2]|0,1)|0;c=o[A>>2]|0;t=e+100+(c<<3)|0;l=t;a=l;l=l+4|0;r=ig(n[a>>0]|n[a+1>>0]<<8|n[a+2>>0]<<16|n[a+3>>0]<<24|0,n[l>>0]|n[l+1>>0]<<8|n[l+2>>0]<<16|n[l+3>>0]<<24|0,r|0,((r|0)<0)<<31>>31|0)|0;l=B()|0;a=t;s[a>>0]=r;s[a+1>>0]=r>>8;s[a+2>>0]=r>>16;s[a+3>>0]=r>>24;t=t+4|0;s[t>>0]=l;s[t+1>>0]=l>>8;s[t+2>>0]=l>>16;s[t+3>>0]=l>>24;o[e+148+(c<<2)>>2]=0;break}if((l|0)>=511){if((l|0)==512){c=e+96|0;o[c>>2]=(o[c>>2]|0)+1&3;l=e+100+(o[A>>2]<<3)+4|0;l=ni(e+244|0,t,n[l>>0]|n[l+1>>0]<<8|n[l+2>>0]<<16|n[l+3>>0]<<24,8)|0;r=e+100+(o[c>>2]<<3)|0;a=r;s[a>>0]=0;s[a+1>>0]=0;s[a+2>>0]=0;s[a+3>>0]=0;r=r+4|0;s[r>>0]=l;s[r+1>>0]=l>>8;s[r+2>>0]=l>>16;s[r+3>>0]=l>>24;r=Ao(t)|0;c=o[c>>2]|0;t=e+100+(c<<3)|0;l=t;a=l;l=l+4|0;l=n[l>>0]|n[l+1>>0]<<8|n[l+2>>0]<<16|n[l+3>>0]<<24;r=n[a>>0]|n[a+1>>0]<<8|n[a+2>>0]<<16|n[a+3>>0]<<24|r;a=t;s[a>>0]=r;s[a+1>>0]=r>>8;s[a+2>>0]=r>>16;s[a+3>>0]=r>>24;t=t+4|0;s[t>>0]=l;s[t+1>>0]=l>>8;s[t+2>>0]=l>>16;s[t+3>>0]=l>>24;o[A>>2]=c;o[e+132+(c<<2)>>2]=0;o[e+148+(o[A>>2]<<2)>>2]=0;break}if((l|0)<=511)break;o[A>>2]=(o[A>>2]|0)+l&3;no(e,t,i)|0;break}do{if(!l){r=ni(e+244|0,t,0,7)|0;a=e+148+(o[A>>2]<<2)|0;o[a>>2]=(o[a>>2]|0)+1;a=o[A>>2]|0;if((o[e+148+(a<<2)>>2]|0)>3){o[e+132+(a<<2)>>2]=r;o[e+148+(o[A>>2]<<2)>>2]=0}}else{if((l|0)<500){r=e+244|0;a=v(o[e+132+(o[A>>2]<<2)>>2]|0,l)|0;if((l|0)<10){r=ni(r,t,a,2)|0;break}else{r=ni(r,t,a,3)|0;break}}if((l|0)==500){r=ni(e+244|0,t,(o[e+132+(o[A>>2]<<2)>>2]|0)*500|0,4)|0;a=e+148+(o[A>>2]<<2)|0;o[a>>2]=(o[a>>2]|0)+1;a=o[A>>2]|0;if((o[e+148+(a<<2)>>2]|0)<=3)break;o[e+132+(a<<2)>>2]=r;o[e+148+(o[A>>2]<<2)>>2]=0;break}r=500-l|0;a=e+244|0;l=o[e+132+(o[A>>2]<<2)>>2]|0;if((r|0)>-10){r=ni(a,t,v(l,r)|0,5)|0;break}r=ni(a,t,v(l,-10)|0,6)|0;a=e+148+(o[A>>2]<<2)|0;o[a>>2]=(o[a>>2]|0)+1;a=o[A>>2]|0;if((o[e+148+(a<<2)>>2]|0)>3){o[e+132+(a<<2)>>2]=r;o[e+148+(o[A>>2]<<2)>>2]=0}}}while(0);c=e+100+(o[A>>2]<<3)|0;a=c;t=a;a=a+4|0;a=ig(n[t>>0]|n[t+1>>0]<<8|n[t+2>>0]<<16|n[t+3>>0]<<24|0,n[a>>0]|n[a+1>>0]<<8|n[a+2>>0]<<16|n[a+3>>0]<<24|0,r|0,((r|0)<0)<<31>>31|0)|0;t=B()|0;l=c;s[l>>0]=a;s[l+1>>0]=a>>8;s[l+2>>0]=a>>16;s[l+3>>0]=a>>24;c=c+4|0;s[c>>0]=t;s[c+1>>0]=t>>8;s[c+2>>0]=t>>16;s[c+3>>0]=t>>24}}while(0);co(e+100+(o[A>>2]<<3)|0,i)}return i+8|0}function ao(e){e=e|0;oi(e);return}function lo(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;s=Rr(e)|0;ho(i,s,Rr(e+4|0)|0);e=o[i>>2]|0;w(o[i+4>>2]|0);J=t;return e|0}function Ao(e){e=e|0;var t=0;t=(Wi(e)|0)&65535;return((Wi(e)|0)&65535)<<16|t|0}function co(e,t){e=e|0;t=t|0;var i=0;i=e;Nr(n[i>>0]|n[i+1>>0]<<8|n[i+2>>0]<<16|n[i+3>>0]<<24,t);e=e+4|0;Nr(n[e>>0]|n[e+1>>0]<<8|n[e+2>>0]<<16|n[e+3>>0]<<24,t+4|0);return}function ho(e,t,i){e=e|0;t=t|0;i=i|0;var r=0;r=e;s[r>>0]=t;s[r+1>>0]=t>>8;s[r+2>>0]=t>>16;s[r+3>>0]=t>>24;t=e+4|0;s[t>>0]=i;s[t+1>>0]=i>>8;s[t+2>>0]=i>>16;s[t+3>>0]=i>>24;return}function uo(e){e=e|0;nm(e);$p(e);return}function po(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+4>>2]&255](e);return}function fo(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==9890?e+12|0:0)|0}function mo(e){e=e|0;be(e,16);return}function go(e,t){e=e|0;t=t|0;Js(e);o[e>>2]=4820;o[e+4>>2]=t;vo(e+8|0);return}function _o(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=4844;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vr(e,s);J=i;return}function vo(e){e=e|0;s[e>>0]=0;Bo(e+1|0);Ti(e+8|0,128,0,0);Ti(e+52|0,256,0,0);Ti(e+96|0,256,0,0);Ti(e+140|0,256,0,0);Ti(e+184|0,256,0,0);Ti(e+228|0,256,0,0);Ti(e+272|0,256,0,0);return}function bo(e){e=e|0;o[e>>2]=4820;Po(e+8|0);ir(e);return}function yo(e){e=e|0;bo(e);$p(e);return}function wo(e,t){e=e|0;t=t|0;return xo(e+8|0,o[e+4>>2]|0,t)|0}function Bo(e){e=e|0;var t=0;s[e>>0]=0;s[e+1>>0]=0;t=e+2|0;s[t>>0]=0;s[t+1>>0]=0;e=e+4|0;s[e>>0]=0;s[e+1>>0]=0;return}function Po(e){e=e|0;xi(e+272|0);xi(e+228|0);xi(e+184|0);xi(e+140|0);xi(e+96|0);xi(e+52|0);xi(e+8|0);return}function xo(e,t,i){e=e|0;t=t|0;i=i|0;var o=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0;p=J;J=J+16|0;u=p;if(!(s[e>>0]|0)){s[e>>0]=1;yr(br(t)|0,i,6);Co(u,i);d=e+1|0;s[d>>0]=s[u>>0]|0;s[d+1>>0]=s[u+1>>0]|0;s[d+2>>0]=s[u+2>>0]|0;s[d+3>>0]=s[u+3>>0]|0;s[d+4>>0]=s[u+4>>0]|0;s[d+5>>0]=s[u+5>>0]|0}else{d=Hi(t,e+8|0)|0;Bo(u);if(!(d&1)){o=e+1|0;o=(n[o>>0]|n[o+1>>0]<<8)&255}else{h=(Hi(t,e+52|0)|0)&255;o=e+1|0;o=(xr(h+((n[o>>0]|n[o+1>>0]<<8)&255)|0)|0)&255}r[u>>1]=o;if(!(d&2)){h=e+1|0;o=o|(n[h>>0]|n[h+1>>0]<<8)&-256}else{o=(Hi(t,e+96|0)|0)&255;h=e+1|0;o=((xr((((n[h>>0]|n[h+1>>0]<<8)&65535)>>>8)+o|0)|0)&255)<<8;o=(o|a[u>>1])&65535}r[u>>1]=o;do{if(d&64){c=e+1|0;l=(o&255)-((n[c>>0]|n[c+1>>0]<<8)&255)|0;if(!(d&4)){o=e+3|0;o=(n[o>>0]|n[o+1>>0]<<8)&255}else{o=(Hi(t,e+140|0)|0)&255;h=e+3|0;h=l+((n[h>>0]|n[h+1>>0]<<8)&255)|0;o=(xr(((h|0)<1?0:(h|0)>254?255:h&255)+o|0)|0)&255}h=u+2|0;r[h>>1]=o;if(!(d&16)){o=e+5|0;o=(n[o>>0]|n[o+1>>0]<<8)&255}else{o=Hi(t,e+228|0)|0;f=e+3|0;A=e+5|0;A=((l+(r[h>>1]&255)-((n[f>>0]|n[f+1>>0]<<8)&255)|0)/2|0)+((n[A>>0]|n[A+1>>0]<<8)&255)|0;o=(xr(((A|0)<1?0:(A|0)>254?255:A&255)+(o&255)|0)|0)&255}A=u+4|0;r[A>>1]=o;o=((a[u>>1]|0)>>>8)-(((n[c>>0]|n[c+1>>0]<<8)&65535)>>>8)|0;if(!(d&8)){l=e+3|0;l=r[h>>1]|(n[l>>0]|n[l+1>>0]<<8)&-256}else{l=(Hi(t,e+184|0)|0)&255;f=e+3|0;f=(((n[f>>0]|n[f+1>>0]<<8)&65535)>>>8)+o|0;l=((xr(((f|0)<1?0:(f|0)>254?255:f&255)+l|0)|0)&255)<<8;l=(l|a[h>>1])&65535}r[h>>1]=l;if(!(d&32)){f=e+5|0;r[A>>1]=r[A>>1]|(n[f>>0]|n[f+1>>0]<<8)&-256;break}else{f=Hi(t,e+272|0)|0;t=e+3|0;d=e+5|0;d=((((a[h>>1]|0)>>>8)+o-(((n[t>>0]|n[t+1>>0]<<8)&65535)>>>8)|0)/2|0)+(((n[d>>0]|n[d+1>>0]<<8)&65535)>>>8)|0;f=((xr(((d|0)<1?0:(d|0)>254?255:d&255)+(f&255)|0)|0)&255)<<8;r[A>>1]=f|a[A>>1];break}}else{r[u+2>>1]=o;r[u+4>>1]=o}}while(0);f=e+1|0;s[f>>0]=s[u>>0]|0;s[f+1>>0]=s[u+1>>0]|0;s[f+2>>0]=s[u+2>>0]|0;s[f+3>>0]=s[u+3>>0]|0;s[f+4>>0]=s[u+4>>0]|0;s[f+5>>0]=s[u+5>>0]|0;Mo(f,i)}J=p;return i+6|0}function Co(e,t){e=e|0;t=t|0;var i=0,s=0;s=Tr(t)|0;i=Tr(t+2|0)|0;Eo(e,s,i,Tr(t+4|0)|0);return}function Mo(e,t){e=e|0;t=t|0;var i=0;Lr(n[e>>0]|n[e+1>>0]<<8,t);i=e+2|0;Lr(n[i>>0]|n[i+1>>0]<<8,t+2|0);e=e+4|0;Lr(n[e>>0]|n[e+1>>0]<<8,t+4|0);return}function Eo(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;s[e>>0]=t;s[e+1>>0]=t>>8;t=e+2|0;s[t>>0]=i;s[t+1>>0]=i>>8;i=e+4|0;s[i>>0]=r;s[i+1>>0]=r>>8;return}function Fo(e){e=e|0;nm(e);$p(e);return}function Io(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+4>>2]&255](e);return}function To(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==10570?e+12|0:0)|0}function Do(e){e=e|0;be(e,16);return}function So(e,t,i){e=e|0;t=t|0;i=i|0;Js(e);o[e>>2]=4872;o[e+4>>2]=t;Uo(e+8|0,i);return}function Ro(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=4896;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vr(e,s);J=i;return}function Uo(e,t){e=e|0;t=t|0;o[e>>2]=o[t>>2];s[e+4>>0]=s[t+4>>0]|0;No(e+8|0,t+8|0);No(e+20|0,t+20|0);Vo(e+32|0,t+32|0);return}function Lo(e){e=e|0;o[e>>2]=4872;hs(e+8|0);ir(e);return}function ko(e){e=e|0;Lo(e);$p(e);return}function Oo(e,t){e=e|0;t=t|0;return yn(e+8|0,o[e+4>>2]|0,t)|0}function No(e,t){e=e|0;t=t|0;var i=0,s=0;o[e>>2]=0;o[e+4>>2]=0;o[e+8>>2]=0;i=t+4|0;s=(o[i>>2]|0)-(o[t>>2]|0)|0;if(s|0){Qo(e,s);Ho(e,o[t>>2]|0,o[i>>2]|0,s)}return}function Vo(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0;i=J;J=J+32|0;s=i+24|0;r=i+16|0;a=i+8|0;n=i;o[e>>2]=0;o[e+4>>2]=0;o[e+8>>2]=0;o[e+12>>2]=0;o[e+16>>2]=0;o[e+20>>2]=0;gn(a,t);_n(n,t);o[r>>2]=o[a>>2];o[r+4>>2]=o[a+4>>2];o[s>>2]=o[n>>2];o[s+4>>2]=o[n+4>>2];Xo(e,r,s,0);J=i;return}function Qo(e,t){e=e|0;t=t|0;var i=0;if((Go(e)|0)>>>0<t>>>0)Xm(e);else{i=Zf(t)|0;o[e+4>>2]=i;o[e>>2]=i;o[e+8>>2]=i+t;return}}function Ho(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0,n=0;n=J;J=J+16|0;r=n;zo(r,e,s);s=r+4|0;e=i-t|0;if((e|0)>0){hg(o[s>>2]|0,t|0,e|0)|0;o[s>>2]=(o[s>>2]|0)+e}Wo(r);J=n;return}function jo(e){e=e|0;var t=0,i=0;t=o[e>>2]|0;i=t;if(t|0){o[e+4>>2]=i;be(t,(o[e+8>>2]|0)-i|0)}return}function Go(e){e=e|0;return 2147483647}function zo(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=t;t=o[t+4>>2]|0;o[e+4>>2]=t;o[e+8>>2]=t+i;return}function Wo(e){e=e|0;o[(o[e>>2]|0)+4>>2]=o[e+4>>2];return}function Xo(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0;m=J;J=J+96|0;f=m+80|0;u=m+64|0;A=m+48|0;c=m+40|0;h=m+8|0;l=m;d=m+32|0;p=m+16|0;a=t;n=o[a>>2]|0;a=o[a+4>>2]|0;r=i;i=o[r>>2]|0;r=o[r+4>>2]|0;s=n;if((r|0)==(a|0))a=0;else a=((r-(o[i>>2]|0)|0)/44|0)+((i-n>>2)*93|0)+((a-(o[n>>2]|0)|0)/-44|0)|0;i=(o[e+8>>2]|0)-(o[e+4>>2]|0)|0;i=((i|0)==0?0:((i>>2)*93|0)+-1|0)-((o[e+20>>2]|0)+(o[e+16>>2]|0))|0;if(a>>>0>i>>>0)Zo(e,a-i|0);Jo(c,e);Jo(l,e);r=l;i=o[r>>2]|0;r=o[r+4>>2]|0;n=h;o[n>>2]=i;o[n+4>>2]=r;n=i;if(a|0){i=((r-(o[i>>2]|0)|0)/44|0)+a|0;if((i|0)>0){l=(i>>>0)/93|0;a=n+(l<<2)|0;o[h>>2]=a;i=(o[a>>2]|0)+((i-(l*93|0)|0)*44|0)|0}else{i=92-i|0;l=n+(((i|0)/-93|0)<<2)|0;o[h>>2]=l;i=(o[l>>2]|0)+((92-((i|0)%93|0)|0)*44|0)|0}o[h+4>>2]=i}o[u>>2]=o[c>>2];o[u+4>>2]=o[c+4>>2];o[f>>2]=o[h>>2];o[f+4>>2]=o[h+4>>2];Yo(A,u,f);qo(f,A);$o(u,A);if(en(f,u)|0){n=p+4|0;a=t+4|0;do{tn(d,f);sn(p,e,d);i=o[p>>2]|0;if((i|0)!=(o[n>>2]|0)){r=o[a>>2]|0;do{Ni(i,r);i=(o[p>>2]|0)+44|0;o[p>>2]=i;r=r+44|0;o[a>>2]=r;if((r-(o[s>>2]|0)|0)==4092){s=s+4|0;o[t>>2]=s;r=o[s>>2]|0;o[a>>2]=r}}while((i|0)!=(o[n>>2]|0))}rn(p);on(f)|0}while(en(f,u)|0)}J=m;return}function Ko(e){e=e|0;var t=0,i=0,s=0;t=o[e+4>>2]|0;i=e+8|0;s=o[i>>2]|0;if((s|0)!=(t|0))o[i>>2]=s+(~((s+-4-t|0)>>>2)<<2);t=o[e>>2]|0;if(t|0)be(t,(o[e+12>>2]|0)-t|0);return}function Zo(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0,g=0,_=0,b=0,y=0,w=0,B=0,P=0,x=0,C=0,M=0,E=0;M=J;J=J+64|0;y=M+52|0;b=M+48|0;w=M+28|0;B=M+24|0;P=M+20|0;f=M;x=e+8|0;i=o[x>>2]|0;C=e+4|0;A=o[C>>2]|0;g=((i|0)==(A|0)&1)+t|0;a=(g>>>0)/93|0;a=a+((g-(a*93|0)|0)!=0&1)|0;g=e+16|0;s=o[g>>2]|0;l=(s>>>0)/93|0;m=a>>>0<l>>>0?a:l;t=a-m|0;n=i;e:do{if(!t){o[g>>2]=(v(m,-93)|0)+s;if(m|0){l=e+12|0;c=e+12|0;h=w+4|0;u=w+8|0;d=w+12|0;t=m;s=A;while(1){a=o[s>>2]|0;n=s+4|0;o[C>>2]=n;_=o[l>>2]|0;s=_;do{if((i|0)==(_|0)){_=o[e>>2]|0;i=_;if(n>>>0<=_>>>0){i=s-i|0;i=(i|0)==0?1:i>>1;ln(w,i,i>>>2,c);o[B>>2]=o[C>>2];o[P>>2]=o[x>>2];o[b>>2]=o[B>>2];o[y>>2]=o[P>>2];un(w,b,y);i=o[e>>2]|0;o[e>>2]=o[w>>2];o[w>>2]=i;i=o[C>>2]|0;o[C>>2]=o[h>>2];o[h>>2]=i;i=o[x>>2]|0;o[x>>2]=o[u>>2];o[u>>2]=i;i=o[l>>2]|0;o[l>>2]=o[d>>2];o[d>>2]=i;hn(w);i=o[x>>2]|0;break}_=n;i=((_-i>>2)+1|0)/-2|0;r=n+(i<<2)|0;s=s-_|0;if(!s)i=r;else{ug(r|0,n|0,s|0)|0;i=(o[C>>2]|0)+(i<<2)|0}_=r+(s>>2<<2)|0;o[x>>2]=_;o[C>>2]=i;i=_}}while(0);o[i>>2]=a;i=(o[x>>2]|0)+4|0;o[x>>2]=i;t=t+-1|0;if(!t)break e;s=o[C>>2]|0}}}else{_=e+12|0;s=o[_>>2]|0;r=s-(o[e>>2]|0)|0;i=n-A>>2;if(t>>>0>((r>>2)-i|0)>>>0){p=r>>1;d=i+t|0;ln(f,p>>>0<d>>>0?d:p,i-m|0,e+12|0);do{o[y>>2]=Zf(4092)|0;An(f,y);t=t+-1|0}while((t|0)!=0);if(!m)i=o[C>>2]|0;else{l=f+8|0;A=f+12|0;c=f+4|0;h=f+16|0;u=w+4|0;d=w+8|0;p=w+12|0;a=m;t=o[l>>2]|0;i=o[C>>2]|0;do{n=o[A>>2]|0;s=n;do{if((t|0)==(n|0)){r=o[c>>2]|0;n=o[f>>2]|0;t=n;if(r>>>0<=n>>>0){t=s-t|0;t=(t|0)==0?1:t>>1;ln(w,t,t>>>2,o[h>>2]|0);o[B>>2]=o[c>>2];o[P>>2]=o[l>>2];o[b>>2]=o[B>>2];o[y>>2]=o[P>>2];un(w,b,y);t=o[f>>2]|0;o[f>>2]=o[w>>2];o[w>>2]=t;t=o[c>>2]|0;o[c>>2]=o[u>>2];o[u>>2]=t;t=o[l>>2]|0;o[l>>2]=o[d>>2];o[d>>2]=t;t=o[A>>2]|0;o[A>>2]=o[p>>2];o[p>>2]=t;hn(w);t=o[l>>2]|0;break}E=r;t=((E-t>>2)+1|0)/-2|0;n=r+(t<<2)|0;s=s-E|0;if(!s)t=n;else{ug(n|0,r|0,s|0)|0;t=(o[c>>2]|0)+(t<<2)|0}E=n+(s>>2<<2)|0;o[l>>2]=E;o[c>>2]=t;t=E}}while(0);o[t>>2]=o[i>>2];t=(o[l>>2]|0)+4|0;o[l>>2]=t;i=(o[C>>2]|0)+4|0;o[C>>2]=i;a=a+-1|0}while((a|0)!=0)}t=o[x>>2]|0;if((t|0)!=(i|0)){do{t=t+-4|0;cn(f,t);i=o[C>>2]|0}while((t|0)!=(i|0));t=o[x>>2]|0}E=o[e>>2]|0;o[e>>2]=o[f>>2];o[f>>2]=E;E=f+4|0;o[C>>2]=o[E>>2];o[E>>2]=i;E=f+8|0;o[x>>2]=o[E>>2];o[E>>2]=t;E=f+12|0;C=o[_>>2]|0;o[_>>2]=o[E>>2];o[E>>2]=C;o[g>>2]=(o[g>>2]|0)+(v(m,-93)|0);hn(f);break}else{t:do{if((s|0)==(n|0))c=18;else{while(1){o[y>>2]=Zf(4092)|0;nn(e,y);t=t+-1|0;if(!t)break;if((o[_>>2]|0)==(o[x>>2]|0)){c=18;break t}}i=m;t=o[g>>2]|0}}while(0);if((c|0)==18){s=~(a>>>0>l>>>0?l:a);i=t;do{o[y>>2]=Zf(4092)|0;an(e,y);i=i+-1|0;r=(((o[x>>2]|0)-(o[C>>2]|0)|0)==4?92:93)+(o[g>>2]|0)|0;o[g>>2]=r}while((i|0)!=0);i=t+-1-s|0;t=r}o[g>>2]=t+(v(i,-93)|0);if(!i)break;l=e+12|0;A=w+4|0;c=w+8|0;h=w+12|0;t=o[x>>2]|0;do{n=o[C>>2]|0;a=o[n>>2]|0;n=n+4|0;o[C>>2]=n;E=o[_>>2]|0;s=E;do{if((t|0)==(E|0)){E=o[e>>2]|0;t=E;if(n>>>0<=E>>>0){t=s-t|0;t=(t|0)==0?1:t>>1;ln(w,t,t>>>2,l);o[B>>2]=o[C>>2];o[P>>2]=o[x>>2];o[b>>2]=o[B>>2];o[y>>2]=o[P>>2];un(w,b,y);t=o[e>>2]|0;o[e>>2]=o[w>>2];o[w>>2]=t;t=o[C>>2]|0;o[C>>2]=o[A>>2];o[A>>2]=t;t=o[x>>2]|0;o[x>>2]=o[c>>2];o[c>>2]=t;t=o[_>>2]|0;o[_>>2]=o[h>>2];o[h>>2]=t;hn(w);t=o[x>>2]|0;break}E=n;t=((E-t>>2)+1|0)/-2|0;r=n+(t<<2)|0;s=s-E|0;if(!s)t=r;else{ug(r|0,n|0,s|0)|0;t=(o[C>>2]|0)+(t<<2)|0}E=r+(s>>2<<2)|0;o[x>>2]=E;o[C>>2]=t;t=E}}while(0);o[t>>2]=a;t=(o[x>>2]|0)+4|0;o[x>>2]=t;i=i+-1|0}while((i|0)!=0)}}}while(0);J=M;return}function Jo(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0;i=(o[t+16>>2]|0)+(o[t+20>>2]|0)|0;n=o[t+4>>2]|0;s=(i>>>0)/93|0;r=n+(s<<2)|0;if((o[t+8>>2]|0)==(n|0))t=0;else t=(o[r>>2]|0)+((i-(s*93|0)|0)*44|0)|0;o[e>>2]=r;o[e+4>>2]=t;return}function Yo(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;r=t;t=o[r+4>>2]|0;s=e;o[s>>2]=o[r>>2];o[s+4>>2]=t;s=i;t=o[s+4>>2]|0;i=e+8|0;o[i>>2]=o[s>>2];o[i+4>>2]=t;return}function qo(e,t){e=e|0;t=t|0;o[e>>2]=o[t>>2];o[e+4>>2]=o[t+4>>2];o[e+8>>2]=o[t+8>>2];o[e+12>>2]=o[t+12>>2];return}function $o(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0;i=J;J=J+32|0;s=i+24|0;r=i+16|0;a=i+8|0;n=i;l=t+8|0;A=o[l>>2]|0;l=o[l+4>>2]|0;t=a;o[t>>2]=A;o[t+4>>2]=l;t=n;o[t>>2]=A;o[t+4>>2]=l;o[r>>2]=o[a>>2];o[r+4>>2]=o[a+4>>2];o[s>>2]=o[n>>2];o[s+4>>2]=o[n+4>>2];Yo(e,r,s);J=i;return}function en(e,t){e=e|0;t=t|0;return(fn(e,t)|0)^1|0}function tn(e,t){e=e|0;t=t|0;var i=0,s=0;i=o[t>>2]|0;s=o[t+4>>2]|0;if((i|0)==(o[t+8>>2]|0))mn(e,s,o[t+12>>2]|0);else mn(e,s,(o[i>>2]|0)+4092|0);return}function sn(e,t,i){e=e|0;t=t|0;i=i|0;var s=0;s=o[i>>2]|0;o[e>>2]=s;o[e+4>>2]=o[i+4>>2];o[e+8>>2]=s;o[e+12>>2]=t;return}function rn(e){e=e|0;var t=0;t=(o[e+12>>2]|0)+20|0;o[t>>2]=(o[t>>2]|0)+(((o[e>>2]|0)-(o[e+8>>2]|0)|0)/44|0);return}function on(e){e=e|0;var t=0,i=0,s=0;t=o[e>>2]|0;i=e+8|0;if((t|0)==(o[i>>2]|0)){s=i;t=o[s+4>>2]|0;i=e;o[i>>2]=o[s>>2];o[i+4>>2]=t}else{s=t+4|0;o[e>>2]=s;o[e+4>>2]=o[s>>2]}return e|0}function nn(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0;f=J;J=J+48|0;r=f+32|0;s=f+28|0;l=f+8|0;A=f+4|0;c=f;p=e+8|0;i=o[p>>2]|0;h=e+12|0;d=o[h>>2]|0;n=d;do{if((i|0)==(d|0)){d=e+4|0;u=o[d>>2]|0;m=o[e>>2]|0;a=m;if(u>>>0<=m>>>0){i=n-a|0;i=(i|0)==0?1:i>>1;ln(l,i,i>>>2,e+12|0);o[A>>2]=o[d>>2];o[c>>2]=o[p>>2];o[s>>2]=o[A>>2];o[r>>2]=o[c>>2];un(l,s,r);i=o[e>>2]|0;o[e>>2]=o[l>>2];o[l>>2]=i;i=l+4|0;m=o[d>>2]|0;o[d>>2]=o[i>>2];o[i>>2]=m;i=l+8|0;m=o[p>>2]|0;o[p>>2]=o[i>>2];o[i>>2]=m;i=l+12|0;m=o[h>>2]|0;o[h>>2]=o[i>>2];o[i>>2]=m;hn(l);i=o[p>>2]|0;break}r=u;s=((r-a>>2)+1|0)/-2|0;e=u+(s<<2)|0;r=i-r|0;if(!r)i=e;else{ug(e|0,u|0,r|0)|0;i=(o[d>>2]|0)+(s<<2)|0}m=e+(r>>2<<2)|0;o[p>>2]=m;o[d>>2]=i;i=m}}while(0);o[i>>2]=o[t>>2];o[p>>2]=(o[p>>2]|0)+4;J=f;return}function an(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0;f=J;J=J+48|0;s=f+32|0;i=f+28|0;a=f+8|0;l=f+4|0;A=f;p=e+4|0;u=o[p>>2]|0;d=o[e>>2]|0;c=d;do{if((u|0)==(d|0)){d=e+8|0;h=o[d>>2]|0;n=e+12|0;m=o[n>>2]|0;r=m;if(h>>>0>=m>>>0){m=r-c|0;m=(m|0)==0?1:m>>1;ln(a,m,(m+3|0)>>>2,e+12|0);o[l>>2]=o[p>>2];o[A>>2]=o[d>>2];o[i>>2]=o[l>>2];o[s>>2]=o[A>>2];un(a,i,s);i=o[e>>2]|0;o[e>>2]=o[a>>2];o[a>>2]=i;i=a+4|0;m=o[p>>2]|0;o[p>>2]=o[i>>2];o[i>>2]=m;i=a+8|0;m=o[d>>2]|0;o[d>>2]=o[i>>2];o[i>>2]=m;i=a+12|0;m=o[n>>2]|0;o[n>>2]=o[i>>2];o[i>>2]=m;hn(a);i=o[p>>2]|0;break}s=h;e=((r-s>>2)+1|0)/2|0;r=h+(e<<2)|0;s=s-u|0;i=r+(0-(s>>2)<<2)|0;if(!s){i=r;s=r}else{ug(i|0,u|0,s|0)|0;s=(o[d>>2]|0)+(e<<2)|0}o[p>>2]=i;o[d>>2]=s}else i=u}while(0);o[i+-4>>2]=o[t>>2];o[p>>2]=(o[p>>2]|0)+-4;J=f;return}function ln(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0;r=e+12|0;o[r>>2]=0;o[e+16>>2]=s;do{if(t)if(t>>>0>1073741823){r=P(8)|0;um(r,6723);o[r>>2]=5956;C(r|0,3928,123)}else{s=Zf(t<<2)|0;break}else s=0}while(0);o[e>>2]=s;i=s+(i<<2)|0;o[e+8>>2]=i;o[e+4>>2]=i;o[r>>2]=s+(t<<2);return}function An(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0;f=J;J=J+48|0;r=f+32|0;s=f+28|0;l=f+8|0;A=f+4|0;c=f;p=e+8|0;i=o[p>>2]|0;h=e+12|0;d=o[h>>2]|0;n=d;do{if((i|0)==(d|0)){d=e+4|0;u=o[d>>2]|0;m=o[e>>2]|0;a=m;if(u>>>0<=m>>>0){i=n-a|0;i=(i|0)==0?1:i>>1;ln(l,i,i>>>2,o[e+16>>2]|0);o[A>>2]=o[d>>2];o[c>>2]=o[p>>2];o[s>>2]=o[A>>2];o[r>>2]=o[c>>2];un(l,s,r);i=o[e>>2]|0;o[e>>2]=o[l>>2];o[l>>2]=i;i=l+4|0;m=o[d>>2]|0;o[d>>2]=o[i>>2];o[i>>2]=m;i=l+8|0;m=o[p>>2]|0;o[p>>2]=o[i>>2];o[i>>2]=m;i=l+12|0;m=o[h>>2]|0;o[h>>2]=o[i>>2];o[i>>2]=m;hn(l);i=o[p>>2]|0;break}r=u;s=((r-a>>2)+1|0)/-2|0;e=u+(s<<2)|0;r=i-r|0;if(!r)i=e;else{ug(e|0,u|0,r|0)|0;i=(o[d>>2]|0)+(s<<2)|0}m=e+(r>>2<<2)|0;o[p>>2]=m;o[d>>2]=i;i=m}}while(0);o[i>>2]=o[t>>2];o[p>>2]=(o[p>>2]|0)+4;J=f;return}function cn(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0;f=J;J=J+48|0;s=f+32|0;i=f+28|0;a=f+8|0;l=f+4|0;A=f;p=e+4|0;u=o[p>>2]|0;d=o[e>>2]|0;c=d;do{if((u|0)==(d|0)){d=e+8|0;h=o[d>>2]|0;n=e+12|0;m=o[n>>2]|0;r=m;if(h>>>0>=m>>>0){m=r-c|0;m=(m|0)==0?1:m>>1;ln(a,m,(m+3|0)>>>2,o[e+16>>2]|0);o[l>>2]=o[p>>2];o[A>>2]=o[d>>2];o[i>>2]=o[l>>2];o[s>>2]=o[A>>2];un(a,i,s);i=o[e>>2]|0;o[e>>2]=o[a>>2];o[a>>2]=i;i=a+4|0;m=o[p>>2]|0;o[p>>2]=o[i>>2];o[i>>2]=m;i=a+8|0;m=o[d>>2]|0;o[d>>2]=o[i>>2];o[i>>2]=m;i=a+12|0;m=o[n>>2]|0;o[n>>2]=o[i>>2];o[i>>2]=m;hn(a);i=o[p>>2]|0;break}s=h;e=((r-s>>2)+1|0)/2|0;r=h+(e<<2)|0;s=s-u|0;i=r+(0-(s>>2)<<2)|0;if(!s){i=r;s=r}else{ug(i|0,u|0,s|0)|0;s=(o[d>>2]|0)+(e<<2)|0}o[p>>2]=i;o[d>>2]=s}else i=u}while(0);o[i+-4>>2]=o[t>>2];o[p>>2]=(o[p>>2]|0)+-4;J=f;return}function hn(e){e=e|0;var t=0,i=0,s=0;t=o[e+4>>2]|0;i=e+8|0;s=o[i>>2]|0;if((s|0)!=(t|0))o[i>>2]=s+(~((s+-4-t|0)>>>2)<<2);t=o[e>>2]|0;if(t|0)be(t,(o[e+12>>2]|0)-t|0);return}function un(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0,n=0,a=0;a=J;J=J+16|0;n=a;r=o[t>>2]|0;dn(n,e+8|0,(o[i>>2]|0)-r>>2);e=o[n>>2]|0;s=n+4|0;if((e|0)!=(o[s>>2]|0)){i=r;do{o[e>>2]=o[i>>2];e=(o[n>>2]|0)+4|0;o[n>>2]=e;i=i+4|0}while((e|0)!=(o[s>>2]|0));o[t>>2]=i}pn(n);J=a;return}function dn(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=o[t>>2];o[e+4>>2]=(o[t>>2]|0)+(i<<2);o[e+8>>2]=t;return}function pn(e){e=e|0;o[o[e+8>>2]>>2]=o[e>>2];return}function fn(e,t){e=e|0;t=t|0;return(o[e+4>>2]|0)==(o[t+4>>2]|0)|0}function mn(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=t;o[e+4>>2]=i;return}function gn(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0;n=o[t+4>>2]|0;i=o[t+16>>2]|0;s=(i>>>0)/93|0;r=n+(s<<2)|0;if((o[t+8>>2]|0)==(n|0))t=0;else t=(o[r>>2]|0)+((i-(s*93|0)|0)*44|0)|0;o[e>>2]=r;o[e+4>>2]=t;return}function _n(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0;i=(o[t+16>>2]|0)+(o[t+20>>2]|0)|0;n=o[t+4>>2]|0;s=(i>>>0)/93|0;r=n+(s<<2)|0;if((o[t+8>>2]|0)==(n|0))t=0;else t=(o[r>>2]|0)+((i-(s*93|0)|0)*44|0)|0;o[e>>2]=r;o[e+4>>2]=t;return}function vn(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0;l=J;J=J+16|0;s=l+8|0;n=l;bn(s,e);Jo(n,e);r=s+4|0;t=o[r>>2]|0;n=n+4|0;if((t|0)!=(o[n>>2]|0))do{xi(t);t=(o[r>>2]|0)+44|0;o[r>>2]=t;i=o[s>>2]|0;if((t-(o[i>>2]|0)|0)==4092){t=i+4|0;o[s>>2]=t;t=o[t>>2]|0;o[r>>2]=t}}while((t|0)!=(o[n>>2]|0));o[e+20>>2]=0;r=e+8|0;s=e+4|0;i=o[s>>2]|0;t=(o[r>>2]|0)-i>>2;if(t>>>0>2)do{be(o[i>>2]|0,4092);i=(o[s>>2]|0)+4|0;o[s>>2]=i;t=(o[r>>2]|0)-i>>2}while(t>>>0>2);switch(t|0){case 1:{t=46;a=11;break}case 2:{t=93;a=11;break}default:{}}if((a|0)==11)o[e+16>>2]=t;J=l;return}function bn(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0;n=o[t+4>>2]|0;i=o[t+16>>2]|0;s=(i>>>0)/93|0;r=n+(s<<2)|0;if((o[t+8>>2]|0)==(n|0))t=0;else t=(o[r>>2]|0)+((i-(s*93|0)|0)*44|0)|0;o[e>>2]=r;o[e+4>>2]=t;return}function yn(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,a=0,l=0,A=0,c=0,h=0,u=0;u=J;J=J+16|0;h=u;A=e+4|0;if(!(s[A>>0]|0)){h=br(t)|0;yr(h,i,o[e>>2]|0);h=o[e>>2]|0;l=i+h|0;if(!h)r=0;else{r=i;a=o[e+8>>2]|0;while(1){s[a>>0]=s[r>>0]|0;r=r+1|0;if((r|0)==(l|0))break;else a=a+1|0}r=o[e>>2]|0}s[A>>0]=1;i=i+r|0}else{a=o[e+20>>2]|0;r=o[e+8>>2]|0;bn(h,e+32|0);e=e+12|0;if((r|0)!=(o[e>>2]|0)){c=h+4|0;A=r;l=a;r=o[c>>2]|0;while(1){a=n[A>>0]|0;a=wn((Hi(t,r)|0)+a|0)|0;s[l>>0]=a;s[i>>0]=a;s[A>>0]=a;A=A+1|0;i=i+1|0;a=o[h>>2]|0;r=(o[c>>2]|0)+44|0;o[c>>2]=r;if((r-(o[a>>2]|0)|0)==4092){r=a+4|0;o[h>>2]=r;r=o[r>>2]|0;o[c>>2]=r}if((A|0)==(o[e>>2]|0))break;else l=l+1|0}}}J=u;return i|0}function wn(e){e=e|0;return e&255|0}function Bn(e){e=e|0;nm(e);$p(e);return}function Pn(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+4>>2]&255](e);return}function xn(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==11262?e+12|0:0)|0}function Cn(e){e=e|0;be(e,16);return}function Mn(e,t){e=e|0;t=t|0;o[e>>2]=0;o[e+4>>2]=0;o[e+8>>2]=0;if(t|0){Qo(e,t);Fn(e,t)}return}function En(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=0;o[e+4>>2]=0;o[e+8>>2]=0;o[e+12>>2]=0;o[e+16>>2]=0;o[e+20>>2]=0;if(t|0)In(e,t,i);return}function Fn(e,t){e=e|0;t=t|0;var i=0,r=0,n=0;n=J;J=J+16|0;r=n;zo(r,e,t);t=r+4|0;e=o[t>>2]|0;i=r+8|0;if((e|0)!=(o[i>>2]|0))do{s[e>>0]=0;e=(o[t>>2]|0)+1|0;o[t>>2]=e}while((e|0)!=(o[i>>2]|0));Wo(r);J=n;return}function In(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0;p=J;J=J+96|0;d=p+80|0;c=p+64|0;a=p+48|0;l=p+40|0;A=p+8|0;r=p;h=p+32|0;u=p+16|0;s=(o[e+8>>2]|0)-(o[e+4>>2]|0)|0;s=((s|0)==0?0:((s>>2)*93|0)+-1|0)-((o[e+20>>2]|0)+(o[e+16>>2]|0))|0;if(s>>>0<t>>>0)Zo(e,t-s|0);Jo(l,e);Jo(r,e);s=o[r>>2]|0;r=o[r+4>>2]|0;n=A;o[n>>2]=s;o[n+4>>2]=r;n=s;if(t|0){s=((r-(o[s>>2]|0)|0)/44|0)+t|0;if((s|0)>0){t=(s>>>0)/93|0;n=n+(t<<2)|0;o[A>>2]=n;s=(o[n>>2]|0)+((s-(t*93|0)|0)*44|0)|0}else{s=92-s|0;t=n+(((s|0)/-93|0)<<2)|0;o[A>>2]=t;s=(o[t>>2]|0)+((92-((s|0)%93|0)|0)*44|0)|0}o[A+4>>2]=s}o[c>>2]=o[l>>2];o[c+4>>2]=o[l+4>>2];o[d>>2]=o[A>>2];o[d+4>>2]=o[A+4>>2];Yo(a,c,d);qo(d,a);$o(c,a);if(en(d,c)|0){r=u+4|0;do{tn(h,d);sn(u,e,h);s=o[u>>2]|0;if((s|0)!=(o[r>>2]|0))do{Ni(s,i);s=(o[u>>2]|0)+44|0;o[u>>2]=s}while((s|0)!=(o[r>>2]|0));rn(u);on(d)|0}while(en(d,c)|0)}J=p;return}function Tn(e){e=e|0;var t=0,i=0;vn(e);t=o[e+4>>2]|0;i=o[e+8>>2]|0;if((t|0)!=(i|0))do{be(o[t>>2]|0,4092);t=t+4|0}while((t|0)!=(i|0));Ko(e);return}function Dn(e,t,i){e=e|0;t=t|0;i=i|0;Fs(e);o[e>>2]=4924;o[e+4>>2]=t;o[e+8>>2]=i;return}function Sn(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=4944;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vn(e,s);J=i;return}function Rn(e,t){e=e|0;t=t|0;return kn(o[e+8>>2]|0,o[e+4>>2]|0,t)|0}function Un(e){e=e|0;var t=0,i=0;o[e>>2]=4924;i=e+8|0;t=o[i>>2]|0;o[i>>2]=0;if(t|0){Nn(t);$p(t)}Ss(e);return}function Ln(e){e=e|0;Un(e);$p(e);return}function kn(e,t,i){e=e|0;t=t|0;i=i|0;return On(e+4784|0,t,_r(e,t,i)|0)|0}function On(e,t,i){e=e|0;t=t|0;i=i|0;if(s[e>>0]|0){ri(t);s[e>>0]=0}return i|0}function Nn(e){e=e|0;mr(e);return}function Vn(e,t){e=e|0;t=t|0;return}function Qn(e){e=e|0;nm(e);$p(e);return}function Hn(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+8>>2]&255](e);return}function jn(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==12004?e+12|0:0)|0}function Gn(e){e=e|0;be(e,16);return}function zn(e){e=e|0;s[e>>0]=1;return}function Wn(e,t,i){e=e|0;t=t|0;i=i|0;Fs(e);o[e>>2]=4972;o[e+4>>2]=t;o[e+8>>2]=i;return}function Xn(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=4992;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vn(e,s);J=i;return}function Kn(e,t){e=e|0;t=t|0;return Yn(o[e+8>>2]|0,o[e+4>>2]|0,t)|0}function Zn(e){e=e|0;var t=0,i=0;o[e>>2]=4972;i=e+8|0;t=o[i>>2]|0;o[i>>2]=0;if(t|0){$n(t);$p(t)}Ss(e);return}function Jn(e){e=e|0;Zn(e);$p(e);return}function Yn(e,t,i){e=e|0;t=t|0;i=i|0;return qn(e+4784|0,t,_r(e,t,i)|0)|0}function qn(e,t,i){e=e|0;t=t|0;i=i|0;return On(e+328|0,t,no(e,t,i)|0)|0}function $n(e){e=e|0;ea(e+4784|0);mr(e);return}function ea(e){e=e|0;ro(e);return}function ta(e){e=e|0;nm(e);$p(e);return}function ia(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+8>>2]&255](e);return}function sa(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==12827?e+12|0:0)|0}function ra(e){e=e|0;be(e,16);return}function oa(e){e=e|0;Xr(e);zn(e+328|0);return}function na(e,t,i){e=e|0;t=t|0;i=i|0;Fs(e);o[e>>2]=5020;o[e+4>>2]=t;o[e+8>>2]=i;return}function aa(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=5040;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vn(e,s);J=i;return}function la(e,t){e=e|0;t=t|0;return ha(o[e+8>>2]|0,o[e+4>>2]|0,t)|0}function Aa(e){e=e|0;var t=0,i=0;o[e>>2]=5020;i=e+8|0;t=o[i>>2]|0;o[i>>2]=0;if(t|0){da(t);$p(t)}Ss(e);return}function ca(e){e=e|0;Aa(e);$p(e);return}function ha(e,t,i){e=e|0;t=t|0;i=i|0;return ua(e+4784|0,t,_r(e,t,i)|0)|0}function ua(e,t,i){e=e|0;t=t|0;i=i|0;return On(e+316|0,t,xo(e,t,i)|0)|0}function da(e){e=e|0;pa(e+4784|0);mr(e);return}function pa(e){e=e|0;Po(e);return}function fa(e){e=e|0;nm(e);$p(e);return}function ma(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+8>>2]&255](e);return}function ga(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==13672?e+12|0:0)|0}function _a(e){e=e|0;be(e,16);return}function va(e){e=e|0;vo(e);zn(e+316|0);return}function ba(e,t,i){e=e|0;t=t|0;i=i|0;Fs(e);o[e>>2]=5068;o[e+4>>2]=t;o[e+8>>2]=i;return}function ya(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=5088;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vn(e,s);J=i;return}function wa(e,t){e=e|0;t=t|0;return xa(o[e+8>>2]|0,o[e+4>>2]|0,t)|0}function Ba(e){e=e|0;var t=0,i=0;o[e>>2]=5068;i=e+8|0;t=o[i>>2]|0;o[i>>2]=0;if(t|0){Ma(t);$p(t)}Ss(e);return}function Pa(e){e=e|0;Ba(e);$p(e);return}function xa(e,t,i){e=e|0;t=t|0;i=i|0;return Ca(e+4784|0,t,_r(e,t,i)|0)|0}function Ca(e,t,i){e=e|0;t=t|0;i=i|0;return ua(e+328|0,t,no(e,t,i)|0)|0}function Ma(e){e=e|0;Ea(e+4784|0);mr(e);return}function Ea(e){e=e|0;pa(e+328|0);ro(e);return}function Fa(e){e=e|0;nm(e);$p(e);return}function Ia(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+8>>2]&255](e);return}function Ta(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==14573?e+12|0:0)|0}function Da(e){e=e|0;be(e,16);return}function Sa(e){e=e|0;Xr(e);va(e+328|0);return}function Ra(e){e=e|0;return e+20|0}function Ua(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=t;o[e+4>>2]=i;o[e+8>>2]=0;return}function La(e,t){e=e|0;t=t|0;o[e>>2]=t;o[e+4>>2]=0;o[e+8>>2]=-1;return}function ka(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0;i=J;J=J+16|0;s=i+4|0;n=i;r=Zf(24)|0;el(r,t);o[n>>2]=0;o[s>>2]=o[n>>2];tl(e,r,s);J=i;return}function Oa(e){e=e|0;var t=0,i=0;e=o[e+4>>2]|0;if(e|0?(i=e+4|0,t=o[i>>2]|0,o[i>>2]=t+-1,(t|0)==0):0){Gg[o[(o[e>>2]|0)+8>>2]&255](e);am(e)}return}function Na(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=5116;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Qa(e,s);J=i;return}function Va(e){e=e|0;var t=0,i=0;e=o[e+4>>2]|0;if(e|0?(i=e+4|0,t=o[i>>2]|0,o[i>>2]=t+-1,(t|0)==0):0){Gg[o[(o[e>>2]|0)+8>>2]&255](e);am(e)}return}function Qa(e,t){e=e|0;t=t|0;return}function Ha(e){e=e|0;nm(e);$p(e);return}function ja(e){e=e|0;e=o[e+12>>2]|0;if(e|0)$p(e);return}function Ga(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==14966?e+12|0:0)|0}function za(e){e=e|0;be(e,16);return}function Wa(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=5144;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Ka(e,s);J=i;return}function Xa(e){e=e|0;var t=0,i=0;e=o[e+4>>2]|0;if(e|0?(i=e+4|0,t=o[i>>2]|0,o[i>>2]=t+-1,(t|0)==0):0){Gg[o[(o[e>>2]|0)+8>>2]&255](e);am(e)}return}function Ka(e,t){e=e|0;t=t|0;return}function Za(e){e=e|0;nm(e);$p(e);return}function Ja(e){e=e|0;e=o[e+12>>2]|0;if(e|0){$a(e);$p(e)}return}function Ya(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==15127?e+12|0:0)|0}function qa(e){e=e|0;be(e,16);return}function $a(e){e=e|0;return}function el(e,t){e=e|0;t=t|0;Fs(e);o[e>>2]=5172;o[e+4>>2]=t;o[e+8>>2]=0;o[e+12>>2]=0;o[e+16>>2]=0;s[e+20>>0]=1;return}function tl(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=5192;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;al(e,s);J=i;return}function il(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,a=0,l=0,A=0,c=0;c=J;J=J+16|0;a=c;i=o[e+8>>2]|0;l=o[e+12>>2]|0;if((i|0)!=(l|0)){A=a+4|0;do{r=o[i>>2]|0;o[a>>2]=r;n=o[i+4>>2]|0;o[A>>2]=n;if(n|0){n=n+4|0;o[n>>2]=(o[n>>2]|0)+1}t=Qg[o[(o[r>>2]|0)+12>>2]&63](r,t)|0;Us(a);i=i+8|0}while((i|0)!=(l|0))}i=e+20|0;if(s[i>>0]|0){s[i>>0]=0;ol(o[e+4>>2]|0)}J=c;return t|0}function sl(e){e=e|0;o[e>>2]=5172;Ls(e+8|0);Ss(e);return}function rl(e){e=e|0;sl(e);$p(e);return}function ol(e){e=e|0;var t=0;t=((nl(o[e>>2]|0)|0)&255)<<24;t=((nl(o[e>>2]|0)|0)&255)<<16|t;t=t|((nl(o[e>>2]|0)|0)&255)<<8;o[e+4>>2]=t|(nl(o[e>>2]|0)|0)&255;return}function nl(e){e=e|0;var t=0,i=0;t=o[e>>2]|0;i=e+8|0;e=o[i>>2]|0;o[i>>2]=e+1;return s[t+e>>0]|0}function al(e,t){e=e|0;t=t|0;return}function ll(e){e=e|0;nm(e);$p(e);return}function Al(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+8>>2]&255](e);return}function cl(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==15450?e+12|0:0)|0}function hl(e){e=e|0;be(e,16);return}function ul(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0;A=J;J=J+32|0;s=A+12|0;r=A;t=A+8|0;a=Zf(180)|0;pl(a,o[e+4>>2]|0);n=e+8|0;o[t>>2]=0;o[s>>2]=o[t>>2];fl(r,a,s);a=e+12|0;t=o[a>>2]|0;l=e+16|0;do{if(t>>>0>=(o[l>>2]|0)>>>0){t=(t-(o[n>>2]|0)>>3)+1|0;i=Zs(n)|0;if(i>>>0<t>>>0)Xm(n);else{c=o[n>>2]|0;h=(o[l>>2]|0)-c|0;l=h>>2;Ws(s,h>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(o[a>>2]|0)-c>>3,e+16|0);l=s+8|0;a=o[l>>2]|0;o[a>>2]=o[r>>2];e=r+4|0;o[a+4>>2]=o[e>>2];o[r>>2]=0;o[e>>2]=0;o[l>>2]=a+8;Xs(n,s);Ks(s);break}}else{Gs(s,n,1);h=s+4|0;c=o[h>>2]|0;o[c>>2]=o[r>>2];l=r+4|0;o[c+4>>2]=o[l>>2];o[r>>2]=0;o[l>>2]=0;o[h>>2]=c+8;zs(s)}}while(0);Us(r);J=A;return}function dl(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0;A=J;J=J+32|0;s=A+12|0;r=A;t=A+8|0;a=Zf(180)|0;Ol(a,o[e+4>>2]|0);n=e+8|0;o[t>>2]=0;o[s>>2]=o[t>>2];Nl(r,a,s);a=e+12|0;t=o[a>>2]|0;l=e+16|0;do{if(t>>>0>=(o[l>>2]|0)>>>0){t=(t-(o[n>>2]|0)>>3)+1|0;i=Zs(n)|0;if(i>>>0<t>>>0)Xm(n);else{c=o[n>>2]|0;h=(o[l>>2]|0)-c|0;l=h>>2;Ws(s,h>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(o[a>>2]|0)-c>>3,e+16|0);l=s+8|0;a=o[l>>2]|0;o[a>>2]=o[r>>2];e=r+4|0;o[a+4>>2]=o[e>>2];o[r>>2]=0;o[e>>2]=0;o[l>>2]=a+8;Xs(n,s);Ks(s);break}}else{Gs(s,n,1);h=s+4|0;c=o[h>>2]|0;o[c>>2]=o[r>>2];l=r+4|0;o[c+4>>2]=o[l>>2];o[r>>2]=0;o[l>>2]=0;o[h>>2]=c+8;zs(s)}}while(0);Us(r);J=A;return}function pl(e,t){e=e|0;t=t|0;Js(e);o[e>>2]=5220;o[e+4>>2]=t;ml(e+8|0);return}function fl(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=5244;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vr(e,s);J=i;return}function ml(e){e=e|0;pr(e,32,1,8,0);si(e+80|0,32,1,8,0);s[e+160>>0]=0;s[e+161>>0]=0;bl(e+164|0);return}function gl(e){e=e|0;o[e>>2]=5220;yl(e+8|0);ir(e);return}function _l(e){e=e|0;gl(e);$p(e);return}function vl(e,t){e=e|0;t=t|0;return wl(e+8|0,o[e+4>>2]|0,t)|0}function bl(e){e=e|0;s[e+4>>0]=0;return}function yl(e){e=e|0;ai(e+80|0);fr(e);return}function wl(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0;a=J;J=J+16|0;r=a;if(!(s[e+161>>0]|0))oi(e+80|0);n=e+164|0;if(Bl(n)|0){t=Pl(e+80|0,t,o[n>>2]|0,0)|0;o[r>>2]=t;Ur(t,i)}else{Cl(xl(t)|0,i,4);o[r>>2]=Ir(i)|0}Ml(n,r);J=a;return i+4|0}function Bl(e){e=e|0;return(s[e+4>>0]|0)!=0|0}function Pl(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;i=(El(e,t,(o[e+36>>2]|0)+(s*44|0)|0)|0)+i|0;t=o[e+24>>2]|0;if((i|0)<0)return i+t|0;else return i-(i>>>0<t>>>0?0:t)|0;return 0}function xl(e){e=e|0;return o[e>>2]|0}function Cl(e,t,i){e=e|0;t=t|0;i=i|0;var r=0;if((i|0)>0){r=0;do{s[t+r>>0]=nl(e)|0;r=r+1|0}while((r|0)!=(i|0))}return}function Ml(e,t){e=e|0;t=t|0;var i=0;i=e+4|0;if(!(s[i>>0]|0))s[i>>0]=1;o[e>>2]=o[t>>2];return}function El(e,t,i){e=e|0;t=t|0;i=i|0;var s=0;i=Fl(t,i)|0;o[e>>2]=i;do{if(i){if(i>>>0>=32){i=o[e+28>>2]|0;break}s=o[e+12>>2]|0;if(i>>>0>s>>>0){s=i-s|0;i=Fl(t,(o[e+68>>2]|0)+((i+-1|0)*44|0)|0)|0;s=i<<s|(Il(t,s)|0)}else s=Fl(t,(o[e+68>>2]|0)+((i+-1|0)*44|0)|0)|0;i=o[e>>2]|0;if((s|0)<(1<<i+-1|0)){i=s+1+(-1<<i)|0;break}else{i=s+1|0;break}}else i=Tl(t,e+48|0)|0}while(0);return i|0}function Fl(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0;d=e+8|0;u=o[d>>2]|0;r=o[t+16>>2]|0;if(r){s=e+4|0;i=o[s>>2]|0;h=u>>>15;o[d>>2]=h;A=(i>>>0)/(h>>>0)|0;l=A>>>(o[t+40>>2]|0);n=o[r+(l<<2)>>2]|0;l=(o[r+(l+1<<2)>>2]|0)+1|0;a=n+1|0;c=o[t+8>>2]|0;if(l>>>0>a>>>0){r=n;n=l;do{a=(n+r|0)>>>1;l=(o[c+(a<<2)>>2]|0)>>>0>A>>>0;r=l?r:a;n=l?a:n;a=r+1|0}while(n>>>0>a>>>0);n=r}r=v(o[c+(n<<2)>>2]|0,h)|0;if((n|0)==(o[t+32>>2]|0))a=u;else a=v(o[c+(a<<2)>>2]|0,h)|0}else{c=u>>>15;o[d>>2]=c;l=o[t>>2]|0;h=o[t+8>>2]|0;s=e+4|0;i=o[s>>2]|0;A=l>>>1;r=0;a=u;n=0;do{p=v(o[h+(A<<2)>>2]|0,c)|0;u=p>>>0>i>>>0;a=u?p:a;r=u?r:p;n=u?n:A;l=u?A:l;A=(n+l|0)>>>1}while((A|0)!=(n|0))}o[s>>2]=i-r;p=a-r|0;o[d>>2]=p;if(p>>>0<16777216)Dl(e);d=(o[t+12>>2]|0)+(n<<2)|0;o[d>>2]=(o[d>>2]|0)+1;d=t+28|0;p=(o[d>>2]|0)+-1|0;o[d>>2]=p;if(!p)Vi(t);return n|0}function Il(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0;if(t>>>0>19){i=(Sl(e)|0)&65535;return(Il(e,t+-16|0)|0)<<16|i|0}s=e+4|0;r=o[s>>2]|0;n=e+8|0;i=(o[n>>2]|0)>>>t;o[n>>2]=i;t=(r>>>0)/(i>>>0)|0;o[s>>2]=r-(v(t,i)|0);if(i>>>0<16777216)Dl(e);return t|0}function Tl(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0,l=0;s=e+8|0;r=o[s>>2]|0;i=v(r>>>13,o[t+8>>2]|0)|0;n=e+4|0;a=o[n>>2]|0;l=a>>>0>=i>>>0;if(l){o[n>>2]=a-i;i=r-i|0;o[s>>2]=i}else{o[s>>2]=i;a=t+12|0;o[a>>2]=(o[a>>2]|0)+1}if(i>>>0<16777216)Dl(e);a=t+4|0;e=(o[a>>2]|0)+-1|0;o[a>>2]=e;if(!e)Xi(t);return l&1|0}function Dl(e){e=e|0;var t=0,i=0,s=0,r=0;t=e+4|0;i=e+8|0;s=o[t>>2]|0;do{s=s<<8|(nl(o[e>>2]|0)|0)&255;o[t>>2]=s;r=o[i>>2]<<8;o[i>>2]=r}while(r>>>0<16777216);return}function Sl(e){e=e|0;var t=0,i=0,s=0,r=0;i=e+4|0;r=o[i>>2]|0;t=e+8|0;s=(o[t>>2]|0)>>>16;o[t>>2]=s;t=(r>>>0)/(s>>>0)|0;o[i>>2]=r-(v(t,s)|0);Dl(e);return t&65535|0}function Rl(e){e=e|0;nm(e);$p(e);return}function Ul(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+4>>2]&255](e);return}function Ll(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==15904?e+12|0:0)|0}function kl(e){e=e|0;be(e,16);return}function Ol(e,t){e=e|0;t=t|0;Js(e);o[e>>2]=5272;o[e+4>>2]=t;Vl(e+8|0);return}function Nl(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=5296;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vr(e,s);J=i;return}function Vl(e){e=e|0;pr(e,32,1,8,0);si(e+80|0,32,1,8,0);s[e+160>>0]=0;s[e+161>>0]=0;Gl(e+164|0);return}function Ql(e){e=e|0;o[e>>2]=5272;zl(e+8|0);ir(e);return}function Hl(e){e=e|0;Ql(e);$p(e);return}function jl(e,t){e=e|0;t=t|0;return Wl(e+8|0,o[e+4>>2]|0,t)|0}function Gl(e){e=e|0;s[e+4>>0]=0;return}function zl(e){e=e|0;ai(e+80|0);fr(e);return}function Wl(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0;a=J;J=J+16|0;r=a;if(!(s[e+161>>0]|0))oi(e+80|0);n=e+164|0;if(Xl(n)|0){t=Pl(e+80|0,t,o[n>>2]|0,0)|0;o[r>>2]=t;Nr(t,i)}else{Cl(xl(t)|0,i,4);o[r>>2]=Rr(i)|0}Kl(n,r);J=a;return i+4|0}function Xl(e){e=e|0;return(s[e+4>>0]|0)!=0|0}function Kl(e,t){e=e|0;t=t|0;var i=0;i=e+4|0;if(!(s[i>>0]|0))s[i>>0]=1;o[e>>2]=o[t>>2];return}function Zl(e){e=e|0;nm(e);$p(e);return}function Jl(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+4>>2]&255](e);return}function Yl(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==16402?e+12|0:0)|0}function ql(e){e=e|0;be(e,16);return}function $l(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0;A=J;J=J+32|0;s=A+12|0;r=A;t=A+8|0;a=Zf(172)|0;tA(a,o[e+4>>2]|0);n=e+8|0;o[t>>2]=0;o[s>>2]=o[t>>2];iA(r,a,s);a=e+12|0;t=o[a>>2]|0;l=e+16|0;do{if(t>>>0>=(o[l>>2]|0)>>>0){t=(t-(o[n>>2]|0)>>3)+1|0;i=Zs(n)|0;if(i>>>0<t>>>0)Xm(n);else{c=o[n>>2]|0;h=(o[l>>2]|0)-c|0;l=h>>2;Ws(s,h>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(o[a>>2]|0)-c>>3,e+16|0);l=s+8|0;a=o[l>>2]|0;o[a>>2]=o[r>>2];e=r+4|0;o[a+4>>2]=o[e>>2];o[r>>2]=0;o[e>>2]=0;o[l>>2]=a+8;Xs(n,s);Ks(s);break}}else{Gs(s,n,1);h=s+4|0;c=o[h>>2]|0;o[c>>2]=o[r>>2];l=r+4|0;o[c+4>>2]=o[l>>2];o[r>>2]=0;o[l>>2]=0;o[h>>2]=c+8;zs(s)}}while(0);Us(r);J=A;return}function eA(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0;A=J;J=J+32|0;s=A+12|0;r=A;t=A+8|0;a=Zf(176)|0;_A(a,o[e+4>>2]|0);n=e+8|0;o[t>>2]=0;o[s>>2]=o[t>>2];vA(r,a,s);a=e+12|0;t=o[a>>2]|0;l=e+16|0;do{if(t>>>0>=(o[l>>2]|0)>>>0){t=(t-(o[n>>2]|0)>>3)+1|0;i=Zs(n)|0;if(i>>>0<t>>>0)Xm(n);else{c=o[n>>2]|0;h=(o[l>>2]|0)-c|0;l=h>>2;Ws(s,h>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(o[a>>2]|0)-c>>3,e+16|0);l=s+8|0;a=o[l>>2]|0;o[a>>2]=o[r>>2];e=r+4|0;o[a+4>>2]=o[e>>2];o[r>>2]=0;o[e>>2]=0;o[l>>2]=a+8;Xs(n,s);Ks(s);break}}else{Gs(s,n,1);h=s+4|0;c=o[h>>2]|0;o[c>>2]=o[r>>2];l=r+4|0;o[c+4>>2]=o[l>>2];o[r>>2]=0;o[l>>2]=0;o[h>>2]=c+8;zs(s)}}while(0);Us(r);J=A;return}function tA(e,t){e=e|0;t=t|0;Js(e);o[e>>2]=5324;o[e+4>>2]=t;sA(e+8|0);return}function iA(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=5348;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vr(e,s);J=i;return}function sA(e){e=e|0;pr(e,8,1,8,0);si(e+80|0,8,1,8,0);s[e+160>>0]=0;s[e+161>>0]=0;aA(e+162|0);return}function rA(e){e=e|0;o[e>>2]=5324;lA(e+8|0);ir(e);return}function oA(e){e=e|0;rA(e);$p(e);return}function nA(e,t){e=e|0;t=t|0;return AA(e+8|0,o[e+4>>2]|0,t)|0}function aA(e){e=e|0;s[e+1>>0]=0;return}function lA(e){e=e|0;ai(e+80|0);fr(e);return}function AA(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,o=0,n=0;n=J;J=J+16|0;r=n;if(!(s[e+161>>0]|0))oi(e+80|0);o=e+162|0;if(cA(o)|0){t=(Pl(e+80|0,t,s[o>>0]|0,0)|0)&255;s[r>>0]=t;hA(t,i)}else{Cl(xl(t)|0,i,1);s[r>>0]=uA(i)|0}dA(o,r);J=n;return i+1|0}function cA(e){e=e|0;return(s[e+1>>0]|0)!=0|0}function hA(e,t){e=e|0;t=t|0;s[t>>0]=e;return}function uA(e){e=e|0;return s[e>>0]|0}function dA(e,t){e=e|0;t=t|0;var i=0;i=e+1|0;if(!(s[i>>0]|0))s[i>>0]=1;s[e>>0]=s[t>>0]|0;return}function pA(e){e=e|0;nm(e);$p(e);return}function fA(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+4>>2]&255](e);return}function mA(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==16900?e+12|0:0)|0}function gA(e){e=e|0;be(e,16);return}function _A(e,t){e=e|0;t=t|0;Js(e);o[e>>2]=5376;o[e+4>>2]=t;bA(e+8|0);return}function vA(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=5400;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vr(e,s);J=i;return}function bA(e){e=e|0;pr(e,16,1,8,0);si(e+80|0,16,1,8,0);s[e+160>>0]=0;s[e+161>>0]=0;PA(e+162|0);return}function yA(e){e=e|0;o[e>>2]=5376;xA(e+8|0);ir(e);return}function wA(e){e=e|0;yA(e);$p(e);return}function BA(e,t){e=e|0;t=t|0;return CA(e+8|0,o[e+4>>2]|0,t)|0}function PA(e){e=e|0;s[e+2>>0]=0;return}function xA(e){e=e|0;ai(e+80|0);fr(e);return}function CA(e,t,i){e=e|0;t=t|0;i=i|0;var o=0,n=0,a=0;a=J;J=J+16|0;o=a;if(!(s[e+161>>0]|0))oi(e+80|0);n=e+162|0;if(MA(n)|0){t=(Pl(e+80|0,t,r[n>>1]|0,0)|0)&65535;r[o>>1]=t;EA(t,i)}else{Cl(xl(t)|0,i,2);r[o>>1]=FA(i)|0}IA(n,o);J=a;return i+2|0}function MA(e){e=e|0;return(s[e+2>>0]|0)!=0|0}function EA(e,t){e=e|0;t=t|0;Lr(e,t);return}function FA(e){e=e|0;return Tr(e)|0}function IA(e,t){e=e|0;t=t|0;var i=0;i=e+2|0;if(!(s[i>>0]|0))s[i>>0]=1;r[e>>1]=r[t>>1]|0;return}function TA(e){e=e|0;nm(e);$p(e);return}function DA(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+4>>2]&255](e);return}function SA(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==17398?e+12|0:0)|0}function RA(e){e=e|0;be(e,16);return}function UA(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0;A=J;J=J+32|0;s=A+12|0;r=A;t=A+8|0;a=Zf(172)|0;kA(a,o[e+4>>2]|0);n=e+8|0;o[t>>2]=0;o[s>>2]=o[t>>2];OA(r,a,s);a=e+12|0;t=o[a>>2]|0;l=e+16|0;do{if(t>>>0>=(o[l>>2]|0)>>>0){t=(t-(o[n>>2]|0)>>3)+1|0;i=Zs(n)|0;if(i>>>0<t>>>0)Xm(n);else{c=o[n>>2]|0;h=(o[l>>2]|0)-c|0;l=h>>2;Ws(s,h>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(o[a>>2]|0)-c>>3,e+16|0);l=s+8|0;a=o[l>>2]|0;o[a>>2]=o[r>>2];e=r+4|0;o[a+4>>2]=o[e>>2];o[r>>2]=0;o[e>>2]=0;o[l>>2]=a+8;Xs(n,s);Ks(s);break}}else{Gs(s,n,1);h=s+4|0;c=o[h>>2]|0;o[c>>2]=o[r>>2];l=r+4|0;o[c+4>>2]=o[l>>2];o[r>>2]=0;o[l>>2]=0;o[h>>2]=c+8;zs(s)}}while(0);Us(r);J=A;return}function LA(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0;A=J;J=J+32|0;s=A+12|0;r=A;t=A+8|0;a=Zf(176)|0;qA(a,o[e+4>>2]|0);n=e+8|0;o[t>>2]=0;o[s>>2]=o[t>>2];$A(r,a,s);a=e+12|0;t=o[a>>2]|0;l=e+16|0;do{if(t>>>0>=(o[l>>2]|0)>>>0){t=(t-(o[n>>2]|0)>>3)+1|0;i=Zs(n)|0;if(i>>>0<t>>>0)Xm(n);else{c=o[n>>2]|0;h=(o[l>>2]|0)-c|0;l=h>>2;Ws(s,h>>3>>>0<i>>>1>>>0?l>>>0<t>>>0?t:l:i,(o[a>>2]|0)-c>>3,e+16|0);l=s+8|0;a=o[l>>2]|0;o[a>>2]=o[r>>2];e=r+4|0;o[a+4>>2]=o[e>>2];o[r>>2]=0;o[e>>2]=0;o[l>>2]=a+8;Xs(n,s);Ks(s);break}}else{Gs(s,n,1);h=s+4|0;c=o[h>>2]|0;o[c>>2]=o[r>>2];l=r+4|0;o[c+4>>2]=o[l>>2];o[r>>2]=0;o[l>>2]=0;o[h>>2]=c+8;zs(s)}}while(0);Us(r);J=A;return}function kA(e,t){e=e|0;t=t|0;Js(e);o[e>>2]=5428;o[e+4>>2]=t;NA(e+8|0);return}function OA(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=5452;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vr(e,s);J=i;return}function NA(e){e=e|0;pr(e,8,1,8,0);si(e+80|0,8,1,8,0);s[e+160>>0]=0;s[e+161>>0]=0;jA(e+162|0);return}function VA(e){e=e|0;o[e>>2]=5428;GA(e+8|0);ir(e);return}function QA(e){e=e|0;VA(e);$p(e);return}function HA(e,t){e=e|0;t=t|0;return zA(e+8|0,o[e+4>>2]|0,t)|0}function jA(e){e=e|0;s[e+1>>0]=0;return}function GA(e){e=e|0;ai(e+80|0);fr(e);return}function zA(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,o=0,a=0;a=J;J=J+16|0;r=a;if(!(s[e+161>>0]|0))oi(e+80|0);o=e+162|0;if(WA(o)|0){t=(Pl(e+80|0,t,n[o>>0]|0,0)|0)&255;s[r>>0]=t;kr(t,i)}else{Cl(xl(t)|0,i,1);s[r>>0]=Dr(i)|0}XA(o,r);J=a;return i+1|0}function WA(e){e=e|0;return(s[e+1>>0]|0)!=0|0}function XA(e,t){e=e|0;t=t|0;var i=0;i=e+1|0;if(!(s[i>>0]|0))s[i>>0]=1;s[e>>0]=s[t>>0]|0;return}function KA(e){e=e|0;nm(e);$p(e);return}function ZA(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+4>>2]&255](e);return}function JA(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==17896?e+12|0:0)|0}function YA(e){e=e|0;be(e,16);return}function qA(e,t){e=e|0;t=t|0;Js(e);o[e>>2]=5480;o[e+4>>2]=t;ec(e+8|0);return}function $A(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;i=J;J=J+16|0;s=i;o[e>>2]=t;r=Zf(16)|0;o[r+4>>2]=0;o[r+8>>2]=0;o[r>>2]=5504;o[r+12>>2]=t;o[e+4>>2]=r;o[s>>2]=t;o[s+4>>2]=t;Vr(e,s);J=i;return}function ec(e){e=e|0;pr(e,16,1,8,0);si(e+80|0,16,1,8,0);s[e+160>>0]=0;s[e+161>>0]=0;rc(e+162|0);return}function tc(e){e=e|0;o[e>>2]=5480;oc(e+8|0);ir(e);return}function ic(e){e=e|0;tc(e);$p(e);return}function sc(e,t){e=e|0;t=t|0;return nc(e+8|0,o[e+4>>2]|0,t)|0}function rc(e){e=e|0;s[e+2>>0]=0;return}function oc(e){e=e|0;ai(e+80|0);fr(e);return}function nc(e,t,i){e=e|0;t=t|0;i=i|0;var o=0,n=0,l=0;l=J;J=J+16|0;o=l;if(!(s[e+161>>0]|0))oi(e+80|0);n=e+162|0;if(ac(n)|0){t=(Pl(e+80|0,t,a[n>>1]|0,0)|0)&65535;r[o>>1]=t;Lr(t,i)}else{Cl(xl(t)|0,i,2);r[o>>1]=Tr(i)|0}lc(n,o);J=l;return i+2|0}function ac(e){e=e|0;return(s[e+2>>0]|0)!=0|0}function lc(e,t){e=e|0;t=t|0;var i=0;i=e+2|0;if(!(s[i>>0]|0))s[i>>0]=1;r[e>>1]=r[t>>1]|0;return}function Ac(e){e=e|0;nm(e);$p(e);return}function cc(e){e=e|0;e=o[e+12>>2]|0;if(e|0)Gg[o[(o[e>>2]|0)+4>>2]&255](e);return}function hc(e,t){e=e|0;t=t|0;return((o[t+4>>2]|0)==18394?e+12|0:0)|0}function uc(e){e=e|0;be(e,16);return}function dc(){return}function pc(e){e=e|0;return wc(e)|0}function fc(){return 0}function mc(){return 0}function gc(e){e=e|0;if(e|0){Bc(e);$p(e)}return}function _c(){return Pc()|0}function vc(){return xc()|0}function bc(){return Cc()|0}function yc(){return 0}function wc(e){e=e|0;return 3360}function Bc(e){e=e|0;var t=0,i=0,s=0,r=0;t=J;J=J+16|0;s=t;o[s>>2]=o[e>>2];o[e>>2]=0;i=e+4|0;o[s+4>>2]=o[i>>2];o[i>>2]=0;de(s);i=e+8|0;o[s>>2]=o[i>>2];o[i>>2]=0;r=e+12|0;o[s+4>>2]=o[r>>2];o[r>>2]=0;Be(s);Be(i);de(e);J=t;return}function Pc(){return 3360}function xc(){return 3368}function Cc(){return 3384}function Mc(){return 18579}function Ec(){return 18582}function Fc(){return 18584}function Ic(){var e=0;e=Zf(16)|0;kc(e);return e|0}function Tc(e){e=e|0;var t=0,i=0,s=0,r=0;t=J;J=J+16|0;i=t;r=_c()|0;s=Sc(i)|0;i=Rc(i)|0;S(r|0,s|0,i|0,Mc()|0,12,e|0);J=t;return}function Dc(e){e=e|0;return Uc(Og[e&3]()|0)|0}function Sc(e){e=e|0;return 1}function Rc(e){e=e|0;return Lc()|0}function Uc(e){e=e|0;return e|0}function Lc(){return 5524}function kc(e){e=e|0;o[e>>2]=0;o[e+4>>2]=0;o[e+8>>2]=0;o[e+12>>2]=0;return}function Oc(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0;i=J;J=J+16|0;s=i;r=i+8|0;a=o[t+4>>2]|0;o[s>>2]=o[t>>2];o[s+4>>2]=a;a=_c()|0;n=Vc(r)|0;r=Qc(r)|0;t=Xc()|0;R(a|0,e|0,n|0,r|0,t|0,4,Hc(s)|0,0);J=i;return}function Nc(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0,n=0;n=jc(t)|0;t=o[e>>2]|0;r=o[e+4>>2]|0;e=n+(r>>1)|0;if(r&1)t=o[(o[e>>2]|0)+t>>2]|0;r=Gc(i)|0;n=zc(s)|0;Wg[t&15](e,r,n);return}function Vc(e){e=e|0;return 4}function Qc(e){e=e|0;return Wc()|0}function Hc(e){e=e|0;var t=0,i=0;t=Zf(8)|0;i=o[e+4>>2]|0;o[t>>2]=o[e>>2];o[t+4>>2]=i;return t|0}function jc(e){e=e|0;return e|0}function Gc(e){e=e|0;return e|0}function zc(e){e=e|0;return e|0}function Wc(){return 144}function Xc(){return 18587}function Kc(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0;i=J;J=J+16|0;s=i;r=i+8|0;a=o[t+4>>2]|0;o[s>>2]=o[t>>2];o[s+4>>2]=a;a=_c()|0;n=Jc(r)|0;r=Yc(r)|0;t=th()|0;R(a|0,e|0,n|0,r|0,t|0,7,qc(s)|0,0);J=i;return}function Zc(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;r=jc(t)|0;t=o[e>>2]|0;s=o[e+4>>2]|0;e=r+(s>>1)|0;if(s&1)t=o[(o[e>>2]|0)+t>>2]|0;r=$c(i)|0;zg[t&15](e,r);return}function Jc(e){e=e|0;return 3}function Yc(e){e=e|0;return eh()|0}function qc(e){e=e|0;var t=0,i=0;t=Zf(8)|0;i=o[e+4>>2]|0;o[t>>2]=o[e>>2];o[t+4>>2]=i;return t|0}function $c(e){e=e|0;return e|0}function eh(){return 5528}function th(){return 18593}function ih(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0;i=J;J=J+16|0;s=i;r=i+8|0;a=o[t+4>>2]|0;o[s>>2]=o[t>>2];o[s+4>>2]=a;a=_c()|0;n=rh(r)|0;r=oh(r)|0;t=Ah()|0;R(a|0,e|0,n|0,r|0,t|0,41,nh(s)|0,0);J=i;return}function sh(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0;s=J;J=J+16|0;i=s;n=jc(t)|0;t=o[e>>2]|0;r=o[e+4>>2]|0;e=n+(r>>1)|0;if(r&1)t=o[(o[e>>2]|0)+t>>2]|0;o[i>>2]=Ng[t&15](e)|0;n=ah(i)|0;J=s;return n|0}function rh(e){e=e|0;return 2}function oh(e){e=e|0;return lh()|0}function nh(e){e=e|0;var t=0,i=0;t=Zf(8)|0;i=o[e+4>>2]|0;o[t>>2]=o[e>>2];o[t+4>>2]=i;return t|0}function ah(e){e=e|0;return o[e>>2]|0}function lh(){return 5540}function Ah(){return 18598}function ch(){return}function hh(e){e=e|0;return _h(e)|0}function uh(){return 0}function dh(){return 0}function ph(e){e=e|0;if(e|0){vh(e);$p(e)}return}function fh(){return bh()|0}function mh(){return yh()|0}function gh(){return wh()|0}function _h(e){e=e|0;return 3400}function vh(e){e=e|0;var t=0,i=0,s=0,r=0;t=J;J=J+16|0;s=t;o[s>>2]=o[e>>2];o[e>>2]=0;i=e+4|0;o[s+4>>2]=o[i>>2];o[i>>2]=0;Va(s);i=e+16|0;o[s>>2]=o[i>>2];o[i>>2]=0;r=e+20|0;o[s+4>>2]=o[r>>2];o[r>>2]=0;Oa(s);o[s>>2]=o[i>>2];o[i>>2]=0;o[s+4>>2]=o[r>>2];o[r>>2]=0;Oa(s);Oa(i);Xa(e+8|0);Va(e);J=t;return}function bh(){return 3400}function yh(){return 3408}function wh(){return 3424}function Bh(){var e=0;e=Zf(24)|0;Ih(e);return e|0}function Ph(e){e=e|0;var t=0,i=0,s=0,r=0;t=J;J=J+16|0;i=t;r=fh()|0;s=Ch(i)|0;i=Mh(i)|0;S(r|0,s|0,i|0,Mc()|0,13,e|0);J=t;return}function xh(e){e=e|0;return Eh(Og[e&3]()|0)|0}function Ch(e){e=e|0;return 1}function Mh(e){e=e|0;return Fh()|0}function Eh(e){e=e|0;return e|0}function Fh(){return 5548}function Ih(e){e=e|0;o[e>>2]=0;o[e+4>>2]=0;o[e+8>>2]=0;o[e+12>>2]=0;o[e+16>>2]=0;o[e+20>>2]=0;return}function Th(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0;i=J;J=J+16|0;s=i;r=i+8|0;a=o[t+4>>2]|0;o[s>>2]=o[t>>2];o[s+4>>2]=a;a=fh()|0;n=Sh(r)|0;r=Rh(r)|0;t=Xc()|0;R(a|0,e|0,n|0,r|0,t|0,5,Uh(s)|0,0);J=i;return}function Dh(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0,n=0;n=Lh(t)|0;t=o[e>>2]|0;r=o[e+4>>2]|0;e=n+(r>>1)|0;if(r&1)t=o[(o[e>>2]|0)+t>>2]|0;r=Gc(i)|0;n=zc(s)|0;Wg[t&15](e,r,n);return}function Sh(e){e=e|0;return 4}function Rh(e){e=e|0;return kh()|0}function Uh(e){e=e|0;var t=0,i=0;t=Zf(8)|0;i=o[e+4>>2]|0;o[t>>2]=o[e>>2];o[t+4>>2]=i;return t|0}function Lh(e){e=e|0;return e|0}function kh(){return 160}function Oh(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0;i=J;J=J+16|0;s=i;r=i+8|0;a=o[t+4>>2]|0;o[s>>2]=o[t>>2];o[s+4>>2]=a;a=fh()|0;n=Vh(r)|0;r=Qh(r)|0;t=th()|0;R(a|0,e|0,n|0,r|0,t|0,8,Hh(s)|0,0);J=i;return}function Nh(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;r=Lh(t)|0;t=o[e>>2]|0;s=o[e+4>>2]|0;e=r+(s>>1)|0;if(s&1)t=o[(o[e>>2]|0)+t>>2]|0;r=zc(i)|0;zg[t&15](e,r);return}function Vh(e){e=e|0;return 3}function Qh(e){e=e|0;return jh()|0}function Hh(e){e=e|0;var t=0,i=0;t=Zf(8)|0;i=o[e+4>>2]|0;o[t>>2]=o[e>>2];o[t+4>>2]=i;return t|0}function jh(){return 5552}function Gh(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0;i=J;J=J+16|0;s=i;r=i+8|0;a=o[t+4>>2]|0;o[s>>2]=o[t>>2];o[s+4>>2]=a;a=fh()|0;n=Wh(r)|0;r=Xh(r)|0;t=th()|0;R(a|0,e|0,n|0,r|0,t|0,9,Kh(s)|0,0);J=i;return}function zh(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;r=Lh(t)|0;t=o[e>>2]|0;s=o[e+4>>2]|0;e=r+(s>>1)|0;if(s&1)t=o[(o[e>>2]|0)+t>>2]|0;r=$c(i)|0;zg[t&15](e,r);return}function Wh(e){e=e|0;return 3}function Xh(e){e=e|0;return Zh()|0}function Kh(e){e=e|0;var t=0,i=0;t=Zf(8)|0;i=o[e+4>>2]|0;o[t>>2]=o[e>>2];o[t+4>>2]=i;return t|0}function Zh(){return 5564}function Jh(){ee();return}function Yh(){qh();return}function qh(){$h(22144);return}function $h(e){e=e|0;var t=0;t=J;J=J+16|0;o[t>>2]=e;eu();J=t;return}function eu(){Q(tu()|0,18653);T(iu()|0,18658,1,1,0);su(18663);ru(18668);ou(18680);nu(18694);au(18700);lu(18715);Au(18719);cu(18732);hu(18737);uu(18751);du(18757);N(pu()|0,18764);N(fu()|0,18776);V(mu()|0,4,18809);V(gu()|0,2,18822);V(_u()|0,4,18837);U(vu()|0,18852);bu(18868);yu(18898);wu(18935);Bu(18974);Pu(19005);xu(19045);Cu(19074);Mu(19112);Eu(19142);yu(19181);wu(19213);Bu(19246);Pu(19279);xu(19313);Cu(19346);Fu(19380);Iu(19411);Tu(19443);return}function tu(){return jd()|0}function iu(){return Hd()|0}function su(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;o[i>>2]=e;e=Vd()|0;k(e|0,o[i>>2]|0,1,-128<<24>>24|0,127<<24>>24|0);J=t;return}function ru(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;o[i>>2]=e;e=Od()|0;k(e|0,o[i>>2]|0,1,-128<<24>>24|0,127<<24>>24|0);J=t;return}function ou(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;o[i>>2]=e;e=Ld()|0;k(e|0,o[i>>2]|0,1,0,255);J=t;return}function nu(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;o[i>>2]=e;e=Rd()|0;k(e|0,o[i>>2]|0,2,-32768<<16>>16|0,32767<<16>>16|0);J=t;return}function au(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;o[i>>2]=e;e=Dd()|0;k(e|0,o[i>>2]|0,2,0,65535);J=t;return}function lu(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;o[i>>2]=e;e=Id()|0;k(e|0,o[i>>2]|0,4,-2147483648,2147483647);J=t;return}function Au(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;o[i>>2]=e;e=Ed()|0;k(e|0,o[i>>2]|0,4,0,-1);J=t;return}function cu(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;o[i>>2]=e;e=Cd()|0;k(e|0,o[i>>2]|0,4,-2147483648,2147483647);J=t;return}function hu(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;o[i>>2]=e;e=Pd()|0;k(e|0,o[i>>2]|0,4,0,-1);J=t;return}function uu(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;o[i>>2]=e;e=wd()|0;L(e|0,o[i>>2]|0,4);J=t;return}function du(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;o[i>>2]=e;e=bd()|0;L(e|0,o[i>>2]|0,8);J=t;return}function pu(){return vd()|0}function fu(){return _d()|0}function mu(){return gd()|0}function gu(){return md()|0}function _u(){return fd()|0}function vu(){return pd()|0}function bu(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;o[i>>2]=e;s=hd()|0;e=ud()|0;O(s|0,e|0,o[i>>2]|0);J=t;return}function yu(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;o[i>>2]=e;s=ld()|0;e=Ad()|0;O(s|0,e|0,o[i>>2]|0);J=t;return}function wu(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;o[i>>2]=e;s=od()|0;e=nd()|0;O(s|0,e|0,o[i>>2]|0);J=t;return}function Bu(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;o[i>>2]=e;s=id()|0;e=sd()|0;O(s|0,e|0,o[i>>2]|0);J=t;return}function Pu(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;o[i>>2]=e;s=$u()|0;e=ed()|0;O(s|0,e|0,o[i>>2]|0);J=t;return}function xu(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;o[i>>2]=e;s=Ju()|0;e=Yu()|0;O(s|0,e|0,o[i>>2]|0);J=t;return}function Cu(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;o[i>>2]=e;s=Xu()|0;e=Ku()|0;O(s|0,e|0,o[i>>2]|0);J=t;return}function Mu(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;o[i>>2]=e;s=Gu()|0;e=zu()|0;O(s|0,e|0,o[i>>2]|0);J=t;return}function Eu(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;o[i>>2]=e;s=Qu()|0;e=Hu()|0;O(s|0,e|0,o[i>>2]|0);J=t;return}function Fu(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;o[i>>2]=e;s=Ou()|0;e=Nu()|0;O(s|0,e|0,o[i>>2]|0);J=t;return}function Iu(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;o[i>>2]=e;s=Uu()|0;e=Lu()|0;O(s|0,e|0,o[i>>2]|0);J=t;return}function Tu(e){e=e|0;var t=0,i=0,s=0;t=J;J=J+16|0;i=t;o[i>>2]=e;s=Du()|0;e=Su()|0;O(s|0,e|0,o[i>>2]|0);J=t;return}function Du(){return Ru()|0}function Su(){return 7}function Ru(){return 3440}function Uu(){return ku()|0}function Lu(){return 7}function ku(){return 3448}function Ou(){return Vu()|0}function Nu(){return 6}function Vu(){return 3456}function Qu(){return ju()|0}function Hu(){return 5}function ju(){return 3464}function Gu(){return Wu()|0}function zu(){return 4}function Wu(){return 3472}function Xu(){return Zu()|0}function Ku(){return 5}function Zu(){return 3480}function Ju(){return qu()|0}function Yu(){return 4}function qu(){return 3488}function $u(){return td()|0}function ed(){return 3}function td(){return 3496}function id(){return rd()|0}function sd(){return 2}function rd(){return 3504}function od(){return ad()|0}function nd(){return 1}function ad(){return 3512}function ld(){return cd()|0}function Ad(){return 0}function cd(){return 3520}function hd(){return dd()|0}function ud(){return 0}function dd(){return 3528}function pd(){return 3536}function fd(){return 3544}function md(){return 3576}function gd(){return 3600}function _d(){return 3624}function vd(){return 3648}function bd(){return yd()|0}function yd(){return 4144}function wd(){return Bd()|0}function Bd(){return 4136}function Pd(){return xd()|0}function xd(){return 4128}function Cd(){return Md()|0}function Md(){return 4120}function Ed(){return Fd()|0}function Fd(){return 4112}function Id(){return Td()|0}function Td(){return 4104}function Dd(){return Sd()|0}function Sd(){return 4096}function Rd(){return Ud()|0}function Ud(){return 4088}function Ld(){return kd()|0}function kd(){return 4072}function Od(){return Nd()|0}function Nd(){return 4080}function Vd(){return Qd()|0}function Qd(){return 4064}function Hd(){return 4056}function jd(){return 4040}function Gd(e){e=e|0;var t=0,i=0,s=0,r=0;t=J;J=J+16|0;i=t+8|0;s=t+4|0;r=t;o[r>>2]=e;o[s>>2]=o[r>>2];o[i>>2]=o[(o[s>>2]|0)+4>>2];e=xp(o[i>>2]|0)|0;J=t;return e|0}function zd(){return 21636}function Wd(e){e=e|0;return(e+-48|0)>>>0<10|0}function Xd(){return 5576}function Kd(e,t){e=e|0;t=t|0;var i=0,r=0;i=s[e>>0]|0;r=s[t>>0]|0;if(i<<24>>24==0?1:i<<24>>24!=r<<24>>24)e=r;else{do{e=e+1|0;t=t+1|0;i=s[e>>0]|0;r=s[t>>0]|0}while(!(i<<24>>24==0?1:i<<24>>24!=r<<24>>24));e=r}return(i&255)-(e&255)|0}function Zd(e){e=e|0;var t=0,i=0,r=0;r=e;e:do{if(!(r&3))i=5;else{t=r;while(1){if(!(s[e>>0]|0)){e=t;break e}e=e+1|0;t=e;if(!(t&3)){i=5;break}}}}while(0);if((i|0)==5){while(1){t=o[e>>2]|0;if(!((t&-2139062144^-2139062144)&t+-16843009))e=e+4|0;else break}if((t&255)<<24>>24)do{e=e+1|0}while((s[e>>0]|0)!=0)}return e-r|0}function Jd(e){e=e|0;return}function Yd(e){e=e|0;return 1}function qd(e){e=e|0;var t=0,i=0;t=e+74|0;i=s[t>>0]|0;s[t>>0]=i+255|i;t=o[e>>2]|0;if(!(t&8)){o[e+8>>2]=0;o[e+4>>2]=0;i=o[e+44>>2]|0;o[e+28>>2]=i;o[e+20>>2]=i;o[e+16>>2]=i+(o[e+48>>2]|0);e=0}else{o[e>>2]=t|32;e=-1}return e|0}function $d(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0,l=0,A=0;r=i+16|0;n=o[r>>2]|0;if(!n)if(!(qd(i)|0)){n=o[r>>2]|0;a=5}else r=0;else a=5;e:do{if((a|0)==5){A=i+20|0;l=o[A>>2]|0;r=l;if((n-l|0)>>>0<t>>>0){r=Hg[o[i+36>>2]&7](i,e,t)|0;break}t:do{if((s[i+75>>0]|0)<0|(t|0)==0){a=0;n=e}else{l=t;while(1){n=l+-1|0;if((s[e+n>>0]|0)==10)break;if(!n){a=0;n=e;break t}else l=n}r=Hg[o[i+36>>2]&7](i,e,l)|0;if(r>>>0<l>>>0)break e;a=l;n=e+l|0;t=t-l|0;r=o[A>>2]|0}}while(0);hg(r|0,n|0,t|0)|0;o[A>>2]=(o[A>>2]|0)+t;r=a+t|0}}while(0);return r|0}function ep(e,t){e=e|0;t=t|0;if(!t)t=0;else t=tp(o[t>>2]|0,o[t+4>>2]|0,e)|0;return((t|0)==0?e:t)|0}function tp(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0;p=(o[e>>2]|0)+1794895138|0;a=ip(o[e+8>>2]|0,p)|0;r=ip(o[e+12>>2]|0,p)|0;n=ip(o[e+16>>2]|0,p)|0;e:do{if((a>>>0<t>>>2>>>0?(d=t-(a<<2)|0,r>>>0<d>>>0&n>>>0<d>>>0):0)?((n|r)&3|0)==0:0){d=r>>>2;u=n>>>2;h=0;while(1){A=a>>>1;c=h+A|0;l=c<<1;n=l+d|0;r=ip(o[e+(n<<2)>>2]|0,p)|0;n=ip(o[e+(n+1<<2)>>2]|0,p)|0;if(!(n>>>0<t>>>0&r>>>0<(t-n|0)>>>0)){r=0;break e}if(s[e+(n+r)>>0]|0){r=0;break e}r=Kd(i,e+n|0)|0;if(!r)break;r=(r|0)<0;if((a|0)==1){r=0;break e}h=r?h:c;a=r?A:a-A|0}r=l+u|0;n=ip(o[e+(r<<2)>>2]|0,p)|0;r=ip(o[e+(r+1<<2)>>2]|0,p)|0;if(r>>>0<t>>>0&n>>>0<(t-r|0)>>>0)r=(s[e+(r+n)>>0]|0)==0?e+r|0:0;else r=0}else r=0}while(0);return r|0}function ip(e,t){e=e|0;t=t|0;var i=0;i=cg(e|0)|0;return((t|0)==0?e:i)|0}function sp(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0;a=t&255;r=(i|0)!=0;e:do{if(r&(e&3|0)!=0){n=t&255;while(1){if((s[e>>0]|0)==n<<24>>24){n=6;break e}e=e+1|0;i=i+-1|0;r=(i|0)!=0;if(!(r&(e&3|0)!=0)){n=5;break}}}else n=5}while(0);if((n|0)==5)if(r)n=6;else e=0;e:do{if((n|0)==6){if((s[e>>0]|0)!=(t&255)<<24>>24){r=v(a,16843009)|0;t:do{if(i>>>0>3)do{a=o[e>>2]^r;if((a&-2139062144^-2139062144)&a+-16843009|0)break t;e=e+4|0;i=i+-4|0}while(i>>>0>3)}while(0)}if(!i)e=0;else{r=t&255;while(1){if((s[e>>0]|0)==r<<24>>24)break e;i=i+-1|0;if(!i){e=0;break}else e=e+1|0}}}}while(0);return e|0}function rp(e,t,i){e=e|0;t=t|0;i=i|0;return ap(e,t,i,1,8)|0}function op(e,t,i,r,a,l){e=e|0;t=+t;i=i|0;r=r|0;a=a|0;l=l|0;var A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0.0,g=0,_=0,b=0,y=0,w=0,P=0,x=0,C=0,M=0,E=0,F=0,I=0,T=0,D=0,S=0;S=J;J=J+560|0;h=S+32|0;y=S+536|0;D=S;T=D;u=S+540|0;o[y>>2]=0;I=u+12|0;vp(t)|0;A=B()|0;if((A|0)<0){t=-t;vp(t)|0;F=1;E=20247;A=B()|0}else{F=(a&2049|0)!=0&1;E=(a&2048|0)==0?(a&1|0)==0?20248:20253:20250}do{if(0==0&(A&2146435072|0)==2146435072){D=(l&32|0)!=0;A=F+3|0;fp(e,32,i,A,a&-65537);Ap(e,E,F);Ap(e,t!=t|0.0!=0.0?D?20274:20278:D?20266:20270,3);fp(e,32,i,A,a^8192)}else{m=+bp(t,y)*2.0;A=m!=0.0;if(A)o[y>>2]=(o[y>>2]|0)+-1;b=l|32;if((b|0)==97){p=l&32;g=(p|0)==0?E:E+9|0;f=F|2;A=12-r|0;do{if(!(r>>>0>11|(A|0)==0)){t=8.0;do{A=A+-1|0;t=t*16.0}while((A|0)!=0);if((s[g>>0]|0)==45){t=-(t+(-m-t));break}else{t=m+t-t;break}}else t=m}while(0);c=o[y>>2]|0;A=(c|0)<0?0-c|0:c;A=pp(A,((A|0)<0)<<31>>31,I)|0;if((A|0)==(I|0)){A=u+11|0;s[A>>0]=48}s[A+-1>>0]=(c>>31&2)+43;d=A+-2|0;s[d>>0]=l+15;c=(r|0)<1;h=(a&8|0)==0;u=D;do{F=~~t;A=u+1|0;s[u>>0]=p|n[640+F>>0];t=(t-+(F|0))*16.0;if((A-T|0)==1?!(h&(c&t==0.0)):0){s[A>>0]=46;u=u+2|0}else u=A}while(t!=0.0);if((r|0)!=0?(-2-T+u|0)<(r|0):0){c=I;h=d;A=r+2+c-h|0}else{c=I;h=d;A=c-T-h+u|0}I=A+f|0;fp(e,32,i,I,a);Ap(e,g,f);fp(e,48,i,I,a^65536);T=u-T|0;Ap(e,D,T);D=c-h|0;fp(e,48,A-(T+D)|0,0,0);Ap(e,d,D);fp(e,32,i,I,a^8192);A=I;break}c=(r|0)<0?6:r;if(A){A=(o[y>>2]|0)+-28|0;o[y>>2]=A;t=m*268435456.0}else{t=m;A=o[y>>2]|0}M=(A|0)<0?h:h+288|0;h=M;do{x=~~t>>>0;o[h>>2]=x;h=h+4|0;t=(t-+(x>>>0))*1.0e9}while(t!=0.0);x=M;if((A|0)>0){p=M;while(1){d=(A|0)<29?A:29;A=h+-4|0;if(A>>>0>=p>>>0){u=0;do{_=lg(o[A>>2]|0,0,d|0)|0;_=ig(_|0,B()|0,u|0,0)|0;w=B()|0;u=ng(_|0,w|0,1e9,0)|0;P=tg(u|0,B()|0,1e9,0)|0;P=sg(_|0,w|0,P|0,B()|0)|0;B()|0;o[A>>2]=P;A=A+-4|0}while(A>>>0>=p>>>0);if(u){P=p+-4|0;o[P>>2]=u;u=P}else u=p}else u=p;e:do{if(h>>>0>u>>>0){A=h;while(1){h=A+-4|0;if(o[h>>2]|0){h=A;break e}if(h>>>0>u>>>0)A=h;else break}}}while(0);A=(o[y>>2]|0)-d|0;o[y>>2]=A;if((A|0)>0)p=u;else break}}else u=M;if((A|0)<0){r=((c+25|0)/9|0)+1|0;_=(b|0)==102;do{g=0-A|0;g=(g|0)<9?g:9;if(u>>>0<h>>>0){d=(1<<g)+-1|0;p=1e9>>>g;f=0;A=u;do{P=o[A>>2]|0;o[A>>2]=(P>>>g)+f;f=v(P&d,p)|0;A=A+4|0}while(A>>>0<h>>>0);u=(o[u>>2]|0)==0?u+4|0:u;if(f){o[h>>2]=f;h=h+4|0}}else u=(o[u>>2]|0)==0?u+4|0:u;A=_?M:u;h=(h-A>>2|0)>(r|0)?A+(r<<2)|0:h;A=(o[y>>2]|0)+g|0;o[y>>2]=A}while((A|0)<0);_=u}else _=u;if(_>>>0<h>>>0){A=(x-_>>2)*9|0;d=o[_>>2]|0;if(d>>>0>=10){u=10;do{u=u*10|0;A=A+1|0}while(d>>>0>=u>>>0)}}else A=0;w=(b|0)==103;P=(c|0)!=0;u=c-((b|0)==102?0:A)+((P&w)<<31>>31)|0;if((u|0)<(((h-x>>2)*9|0)+-9|0)){y=u+9216|0;u=(y|0)/9|0;r=M+4+(u+-1024<<2)|0;u=y-(u*9|0)|0;if((u|0)<8){d=10;while(1){d=d*10|0;if((u|0)<7)u=u+1|0;else break}}else d=10;f=o[r>>2]|0;u=(f>>>0)/(d>>>0)|0;g=f-(v(u,d)|0)|0;p=(r+4|0)==(h|0);if(!(p&(g|0)==0)){m=(u&1|0)==0?9007199254740992.0:9007199254740994.0;y=d>>>1;t=g>>>0<y>>>0?0.5:p&(g|0)==(y|0)?1.0:1.5;if(F){y=(s[E>>0]|0)==45;t=y?-t:t;m=y?-m:m}u=f-g|0;o[r>>2]=u;if(m+t!=m){y=u+d|0;o[r>>2]=y;if(y>>>0>999999999){d=r;A=_;while(1){u=d+-4|0;o[d>>2]=0;if(u>>>0<A>>>0){A=A+-4|0;o[A>>2]=0}y=(o[u>>2]|0)+1|0;o[u>>2]=y;if(y>>>0>999999999)d=u;else{d=A;break}}}else{u=r;d=_}A=(x-d>>2)*9|0;f=o[d>>2]|0;if(f>>>0>=10){p=10;do{p=p*10|0;A=A+1|0}while(f>>>0>=p>>>0)}}else{u=r;d=_}}else{u=r;d=_}y=u+4|0;h=h>>>0>y>>>0?y:h}else d=_;r=0-A|0;e:do{if(h>>>0>d>>>0)while(1){u=h+-4|0;if(o[u>>2]|0){y=h;b=1;break e}if(u>>>0>d>>>0)h=u;else{y=u;b=0;break}}else{y=h;b=0}}while(0);do{if(w){c=c+((P^1)&1)|0;if((c|0)>(A|0)&(A|0)>-5){p=l+-1|0;c=c+-1-A|0}else{p=l+-2|0;c=c+-1|0}if(!(a&8)){if(b?(C=o[y+-4>>2]|0,(C|0)!=0):0)if(!((C>>>0)%10|0)){u=0;h=10;do{h=h*10|0;u=u+1|0}while(!((C>>>0)%(h>>>0)|0|0))}else u=0;else u=9;h=((y-x>>2)*9|0)+-9|0;if((p|32|0)==102){l=h-u|0;l=(l|0)>0?l:0;c=(c|0)<(l|0)?c:l;break}else{l=h+A-u|0;l=(l|0)>0?l:0;c=(c|0)<(l|0)?c:l;break}}}else p=l}while(0);_=(c|0)!=0;f=_?1:a>>>3&1;g=(p|32|0)==102;if(g){w=0;A=(A|0)>0?A:0}else{h=(A|0)<0?r:A;h=pp(h,((h|0)<0)<<31>>31,I)|0;u=I;if((u-h|0)<2)do{h=h+-1|0;s[h>>0]=48}while((u-h|0)<2);s[h+-1>>0]=(A>>31&2)+43;A=h+-2|0;s[A>>0]=p;w=A;A=u-A|0}A=F+1+c+f+A|0;fp(e,32,i,A,a);Ap(e,E,F);fp(e,48,i,A,a^65536);if(g){f=d>>>0>M>>>0?M:d;g=D+9|0;d=g;p=D+8|0;u=f;do{h=pp(o[u>>2]|0,0,g)|0;if((u|0)==(f|0)){if((h|0)==(g|0)){s[p>>0]=48;h=p}}else if(h>>>0>D>>>0){dg(D|0,48,h-T|0)|0;do{h=h+-1|0}while(h>>>0>D>>>0)}Ap(e,h,d-h|0);u=u+4|0}while(u>>>0<=M>>>0);if(!((a&8|0)==0&(_^1)))Ap(e,20282,1);if(u>>>0<y>>>0&(c|0)>0)while(1){h=pp(o[u>>2]|0,0,g)|0;if(h>>>0>D>>>0){dg(D|0,48,h-T|0)|0;do{h=h+-1|0}while(h>>>0>D>>>0)}Ap(e,h,(c|0)<9?c:9);u=u+4|0;h=c+-9|0;if(!(u>>>0<y>>>0&(c|0)>9)){c=h;break}else c=h}fp(e,48,c+9|0,9,0)}else{y=b?y:d+4|0;if(d>>>0<y>>>0&(c|0)>-1){r=D+9|0;_=(a&8|0)==0;b=r;f=0-T|0;g=D+8|0;p=d;do{h=pp(o[p>>2]|0,0,r)|0;if((h|0)==(r|0)){s[g>>0]=48;h=g}do{if((p|0)==(d|0)){u=h+1|0;Ap(e,h,1);if(_&(c|0)<1){h=u;break}Ap(e,20282,1);h=u}else{if(h>>>0<=D>>>0)break;dg(D|0,48,h+f|0)|0;do{h=h+-1|0}while(h>>>0>D>>>0)}}while(0);T=b-h|0;Ap(e,h,(c|0)>(T|0)?T:c);c=c-T|0;p=p+4|0}while(p>>>0<y>>>0&(c|0)>-1)}fp(e,48,c+18|0,18,0);Ap(e,w,I-w|0)}fp(e,32,i,A,a^8192)}}while(0);J=S;return((A|0)<(i|0)?i:A)|0}function np(e,t){e=e|0;t=t|0;var i=0.0,s=0;s=(o[t>>2]|0)+(8-1)&~(8-1);i=+A[s>>3];o[t>>2]=s+8;A[e>>3]=i;return}function ap(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;var a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0,g=0,_=0,v=0;v=J;J=J+224|0;f=v+208|0;m=v+160|0;g=v+80|0;_=v;a=m;l=a+40|0;do{o[a>>2]=0;a=a+4|0}while((a|0)<(l|0));o[f>>2]=o[i>>2];if((lp(0,t,f,g,m,r,n)|0)<0)i=-1;else{if((o[e+76>>2]|0)>-1)p=Yd(e)|0;else p=0;i=o[e>>2]|0;d=i&32;if((s[e+74>>0]|0)<1)o[e>>2]=i&-33;a=e+48|0;if(!(o[a>>2]|0)){l=e+44|0;A=o[l>>2]|0;o[l>>2]=_;c=e+28|0;o[c>>2]=_;h=e+20|0;o[h>>2]=_;o[a>>2]=80;u=e+16|0;o[u>>2]=_+80;i=lp(e,t,f,g,m,r,n)|0;if(A){Hg[o[e+36>>2]&7](e,0,0)|0;i=(o[h>>2]|0)==0?-1:i;o[l>>2]=A;o[a>>2]=0;o[u>>2]=0;o[c>>2]=0;o[h>>2]=0}}else i=lp(e,t,f,g,m,r,n)|0;a=o[e>>2]|0;o[e>>2]=a|d;if(p|0)Jd(e);i=(a&32|0)==0?i:-1}J=v;return i|0}function lp(e,t,i,n,a,l,c){e=e|0;t=t|0;i=i|0;n=n|0;a=a|0;l=l|0;c=c|0;var h=0,u=0,d=0,p=0,f=0,m=0,g=0,_=0,v=0,b=0,y=0,w=0,P=0,x=0,C=0,M=0,E=0,F=0,I=0,T=0,D=0,S=0,R=0,U=0,L=0;U=J;J=J+64|0;D=U+56|0;R=U+40|0;M=U;F=U+48|0;I=U+60|0;o[D>>2]=t;P=(e|0)!=0;x=M+40|0;C=x;M=M+39|0;E=F+4|0;h=0;t=0;d=0;e:while(1){do{do{if((t|0)>-1)if((h|0)>(2147483647-t|0)){o[(zd()|0)>>2]=61;t=-1;break}else{t=h+t|0;break}}while(0);g=o[D>>2]|0;h=s[g>>0]|0;if(!(h<<24>>24)){w=92;break e}u=g;t:while(1){switch(h<<24>>24){case 37:{w=10;break t}case 0:{h=u;break t}default:{}}y=u+1|0;o[D>>2]=y;h=s[y>>0]|0;u=y}t:do{if((w|0)==10){w=0;h=u;do{if((s[u+1>>0]|0)!=37)break t;h=h+1|0;u=u+2|0;o[D>>2]=u}while((s[u>>0]|0)==37)}}while(0);h=h-g|0;if(P)Ap(e,g,h)}while((h|0)!=0);y=(Wd(s[(o[D>>2]|0)+1>>0]|0)|0)==0;u=o[D>>2]|0;if(!y?(s[u+2>>0]|0)==36:0){v=(s[u+1>>0]|0)+-48|0;f=1;h=3}else{v=-1;f=d;h=1}h=u+h|0;o[D>>2]=h;u=s[h>>0]|0;d=(u<<24>>24)+-32|0;if(d>>>0>31|(1<<d&75913|0)==0)p=0;else{p=0;do{p=1<<d|p;h=h+1|0;o[D>>2]=h;u=s[h>>0]|0;d=(u<<24>>24)+-32|0}while(!(d>>>0>31|(1<<d&75913|0)==0))}if(u<<24>>24==42){if((Wd(s[h+1>>0]|0)|0)!=0?(S=o[D>>2]|0,(s[S+2>>0]|0)==36):0){h=S+1|0;o[a+((s[h>>0]|0)+-48<<2)>>2]=10;h=o[n+((s[h>>0]|0)+-48<<3)>>2]|0;d=1;u=S+3|0}else{if(f|0){t=-1;break}if(P){y=(o[i>>2]|0)+(4-1)&~(4-1);h=o[y>>2]|0;o[i>>2]=y+4}else h=0;d=0;u=(o[D>>2]|0)+1|0}o[D>>2]=u;y=(h|0)<0;b=y?0-h|0:h;p=y?p|8192:p;y=d}else{h=cp(D)|0;if((h|0)<0){t=-1;break}b=h;y=f;u=o[D>>2]|0}do{if((s[u>>0]|0)==46){h=u+1|0;if((s[h>>0]|0)!=42){o[D>>2]=h;h=cp(D)|0;u=o[D>>2]|0;break}if(Wd(s[u+2>>0]|0)|0?(T=o[D>>2]|0,(s[T+3>>0]|0)==36):0){h=T+2|0;o[a+((s[h>>0]|0)+-48<<2)>>2]=10;h=o[n+((s[h>>0]|0)+-48<<3)>>2]|0;u=T+4|0;o[D>>2]=u;break}if(y|0){t=-1;break e}if(P){_=(o[i>>2]|0)+(4-1)&~(4-1);h=o[_>>2]|0;o[i>>2]=_+4}else h=0;u=(o[D>>2]|0)+2|0;o[D>>2]=u}else h=-1}while(0);_=0;while(1){if(((s[u>>0]|0)+-65|0)>>>0>57){t=-1;break e}d=u;u=u+1|0;o[D>>2]=u;d=s[(s[d>>0]|0)+-65+(176+(_*58|0))>>0]|0;f=d&255;if((f+-1|0)>>>0>=8)break;else _=f}if(!(d<<24>>24)){t=-1;break}m=(v|0)>-1;do{if(d<<24>>24==19)if(m){t=-1;break e}else w=54;else{if(m){o[a+(v<<2)>>2]=f;m=n+(v<<3)|0;v=o[m+4>>2]|0;w=R;o[w>>2]=o[m>>2];o[w+4>>2]=v;w=54;break}if(!P){t=0;break e}hp(R,f,i,c);u=o[D>>2]|0;w=55}}while(0);if((w|0)==54){w=0;if(P)w=55;else h=0}t:do{if((w|0)==55){w=0;u=s[u+-1>>0]|0;u=(_|0)!=0&(u&15|0)==3?u&-33:u;d=p&-65537;v=(p&8192|0)==0?p:d;i:do{switch(u|0){case 110:switch((_&255)<<24>>24){case 0:{o[o[R>>2]>>2]=t;h=0;break t}case 1:{o[o[R>>2]>>2]=t;h=0;break t}case 2:{h=o[R>>2]|0;o[h>>2]=t;o[h+4>>2]=((t|0)<0)<<31>>31;h=0;break t}case 3:{r[o[R>>2]>>1]=t;h=0;break t}case 4:{s[o[R>>2]>>0]=t;h=0;break t}case 6:{o[o[R>>2]>>2]=t;h=0;break t}case 7:{h=o[R>>2]|0;o[h>>2]=t;o[h+4>>2]=((t|0)<0)<<31>>31;h=0;break t}default:{h=0;break t}}case 112:{u=120;h=h>>>0>8?h:8;d=v|8;w=67;break}case 88:case 120:{d=v;w=67;break}case 111:{m=R;m=dp(o[m>>2]|0,o[m+4>>2]|0,x)|0;d=C-m|0;p=0;f=20230;h=(v&8|0)==0|(h|0)>(d|0)?h:d+1|0;d=v;w=73;break}case 105:case 100:{d=R;u=o[d>>2]|0;d=o[d+4>>2]|0;if((d|0)<0){u=sg(0,0,u|0,d|0)|0;d=B()|0;p=R;o[p>>2]=u;o[p+4>>2]=d;p=1;f=20230;w=72;break i}else{p=(v&2049|0)!=0&1;f=(v&2048|0)==0?(v&1|0)==0?20230:20232:20231;w=72;break i}}case 117:{d=R;p=0;f=20230;u=o[d>>2]|0;d=o[d+4>>2]|0;w=72;break}case 99:{s[M>>0]=o[R>>2];g=M;p=0;f=20230;m=1;u=d;h=C;break}case 115:{_=o[R>>2]|0;_=(_|0)==0?20240:_;v=sp(_,0,h)|0;L=(v|0)==0;g=_;p=0;f=20230;m=L?h:v-_|0;u=d;h=L?_+h|0:v;break}case 67:{o[F>>2]=o[R>>2];o[E>>2]=0;o[R>>2]=F;f=-1;w=79;break}case 83:{if(!h){fp(e,32,b,0,v);h=0;w=89}else{f=h;w=79}break}case 65:case 71:case 70:case 69:case 97:case 103:case 102:case 101:{h=Vg[l&1](e,+A[R>>3],b,h,v,u)|0;break t}default:{p=0;f=20230;m=h;u=v;h=C}}}while(0);i:do{if((w|0)==67){m=R;m=up(o[m>>2]|0,o[m+4>>2]|0,x,u&32)|0;f=R;f=(d&8|0)==0|(o[f>>2]|0)==0&(o[f+4>>2]|0)==0;p=f?0:2;f=f?20230:20230+(u>>>4)|0;w=73}else if((w|0)==72){m=pp(u,d,x)|0;d=v;w=73}else if((w|0)==79){w=0;p=o[R>>2]|0;h=0;while(1){u=o[p>>2]|0;if(!u)break;u=mp(I,u)|0;d=(u|0)<0;if(d|u>>>0>(f-h|0)>>>0){w=83;break}h=u+h|0;if(f>>>0>h>>>0)p=p+4|0;else break}if((w|0)==83){w=0;if(d){t=-1;break e}}fp(e,32,b,h,v);if(!h){h=0;w=89}else{d=o[R>>2]|0;p=0;while(1){u=o[d>>2]|0;if(!u){w=89;break i}u=mp(I,u)|0;p=u+p|0;if((p|0)>(h|0)){w=89;break i}Ap(e,I,u);if(p>>>0>=h>>>0){w=89;break}else d=d+4|0}}}}while(0);if((w|0)==73){w=0;u=R;u=(o[u>>2]|0)!=0|(o[u+4>>2]|0)!=0;L=(h|0)!=0|u;u=C-m+((u^1)&1)|0;g=L?m:x;m=L?(h|0)>(u|0)?h:u:0;u=(h|0)>-1?d&-65537:d;h=C}else if((w|0)==89){w=0;fp(e,32,b,h,v^8192);h=(b|0)>(h|0)?b:h;break}v=h-g|0;_=(m|0)<(v|0)?v:m;L=_+p|0;h=(b|0)<(L|0)?L:b;fp(e,32,h,L,u);Ap(e,f,p);fp(e,48,h,L,u^65536);fp(e,48,_,v,0);Ap(e,g,v);fp(e,32,h,L,u^8192)}}while(0);d=y}e:do{if((w|0)==92)if(!e)if(!d)t=0;else{t=1;while(1){h=o[a+(t<<2)>>2]|0;if(!h)break;hp(n+(t<<3)|0,h,i,c);t=t+1|0;if(t>>>0>=10){t=1;break e}}while(1){if(o[a+(t<<2)>>2]|0){t=-1;break e}t=t+1|0;if(t>>>0>=10){t=1;break}}}}while(0);J=U;return t|0}function Ap(e,t,i){e=e|0;t=t|0;i=i|0;if(!(o[e>>2]&32))$d(t,i,e)|0;return}function cp(e){e=e|0;var t=0,i=0;if(!(Wd(s[o[e>>2]>>0]|0)|0))t=0;else{t=0;do{i=o[e>>2]|0;t=(t*10|0)+-48+(s[i>>0]|0)|0;i=i+1|0;o[e>>2]=i}while((Wd(s[i>>0]|0)|0)!=0)}return t|0}function hp(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0,n=0.0;e:do{if(t>>>0<=20)do{switch(t|0){case 9:{t=(o[i>>2]|0)+(4-1)&~(4-1);s=o[t>>2]|0;o[i>>2]=t+4;o[e>>2]=s;break e}case 10:{s=(o[i>>2]|0)+(4-1)&~(4-1);t=o[s>>2]|0;o[i>>2]=s+4;s=e;o[s>>2]=t;o[s+4>>2]=((t|0)<0)<<31>>31;break e}case 11:{s=(o[i>>2]|0)+(4-1)&~(4-1);t=o[s>>2]|0;o[i>>2]=s+4;s=e;o[s>>2]=t;o[s+4>>2]=0;break e}case 12:{s=(o[i>>2]|0)+(8-1)&~(8-1);t=s;r=o[t>>2]|0;t=o[t+4>>2]|0;o[i>>2]=s+8;s=e;o[s>>2]=r;o[s+4>>2]=t;break e}case 13:{r=(o[i>>2]|0)+(4-1)&~(4-1);s=o[r>>2]|0;o[i>>2]=r+4;s=(s&65535)<<16>>16;r=e;o[r>>2]=s;o[r+4>>2]=((s|0)<0)<<31>>31;break e}case 14:{r=(o[i>>2]|0)+(4-1)&~(4-1);s=o[r>>2]|0;o[i>>2]=r+4;r=e;o[r>>2]=s&65535;o[r+4>>2]=0;break e}case 15:{r=(o[i>>2]|0)+(4-1)&~(4-1);s=o[r>>2]|0;o[i>>2]=r+4;s=(s&255)<<24>>24;r=e;o[r>>2]=s;o[r+4>>2]=((s|0)<0)<<31>>31;break e}case 16:{r=(o[i>>2]|0)+(4-1)&~(4-1);s=o[r>>2]|0;o[i>>2]=r+4;r=e;o[r>>2]=s&255;o[r+4>>2]=0;break e}case 17:{r=(o[i>>2]|0)+(8-1)&~(8-1);n=+A[r>>3];o[i>>2]=r+8;A[e>>3]=n;break e}case 18:{zg[s&15](e,i);break e}default:break e}}while(0)}while(0);return}function up(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;if(!((e|0)==0&(t|0)==0))do{i=i+-1|0;s[i>>0]=n[640+(e&15)>>0]|0|r;e=ag(e|0,t|0,4)|0;t=B()|0}while(!((e|0)==0&(t|0)==0));return i|0}function dp(e,t,i){e=e|0;t=t|0;i=i|0;if(!((e|0)==0&(t|0)==0))do{i=i+-1|0;s[i>>0]=e&7|48;e=ag(e|0,t|0,3)|0;t=B()|0}while(!((e|0)==0&(t|0)==0));return i|0}function pp(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,o=0,n=0;if(t>>>0>0|(t|0)==0&e>>>0>4294967295){do{r=e;e=ng(e|0,t|0,10,0)|0;o=t;t=B()|0;n=tg(e|0,t|0,10,0)|0;n=sg(r|0,o|0,n|0,B()|0)|0;B()|0;i=i+-1|0;s[i>>0]=n&255|48}while(o>>>0>9|(o|0)==9&r>>>0>4294967295);t=e}else t=e;if(t)do{n=t;t=(t>>>0)/10|0;i=i+-1|0;s[i>>0]=n-(t*10|0)|48}while(n>>>0>=10);return i|0}function fp(e,t,i,s,r){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;var o=0,n=0;n=J;J=J+256|0;o=n;if((i|0)>(s|0)&(r&73728|0)==0){r=i-s|0;dg(o|0,t<<24>>24|0,(r>>>0<256?r:256)|0)|0;if(r>>>0>255){t=i-s|0;do{Ap(e,o,256);r=r+-256|0}while(r>>>0>255);r=t&255}Ap(e,o,r)}J=n;return}function mp(e,t){e=e|0;t=t|0;if(!e)e=0;else e=gp(e,t,0)|0;return e|0}function gp(e,t,i){e=e|0;t=t|0;i=i|0;do{if(e){if(t>>>0<128){s[e>>0]=t;e=1;break}if(!(o[o[(_p()|0)+176>>2]>>2]|0))if((t&-128|0)==57216){s[e>>0]=t;e=1;break}else{o[(zd()|0)>>2]=25;e=-1;break}if(t>>>0<2048){s[e>>0]=t>>>6|192;s[e+1>>0]=t&63|128;e=2;break}if(t>>>0<55296|(t&-8192|0)==57344){s[e>>0]=t>>>12|224;s[e+1>>0]=t>>>6&63|128;s[e+2>>0]=t&63|128;e=3;break}if((t+-65536|0)>>>0<1048576){s[e>>0]=t>>>18|240;s[e+1>>0]=t>>>12&63|128;s[e+2>>0]=t>>>6&63|128;s[e+3>>0]=t&63|128;e=4;break}else{o[(zd()|0)>>2]=25;e=-1;break}}else e=1}while(0);return e|0}function _p(){return Xd()|0}function vp(e){e=+e;var t=0;A[c>>3]=e;t=o[c>>2]|0;w(o[c+4>>2]|0);return t|0}function bp(e,t){e=+e;t=t|0;var i=0,s=0,r=0;A[c>>3]=e;i=o[c>>2]|0;s=o[c+4>>2]|0;r=ag(i|0,s|0,52)|0;B()|0;switch(r&2047){case 0:{if(e!=0.0){e=+bp(e*18446744073709551616.0,t);i=(o[t>>2]|0)+-64|0}else i=0;o[t>>2]=i;break}case 2047:break;default:{o[t>>2]=(r&2047)+-1022;o[c>>2]=i;o[c+4>>2]=s&-2146435073|1071644672;e=+A[c>>3]}}return+e}function yp(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,o=0;e:do{if(!i)e=0;else{while(1){r=s[e>>0]|0;o=s[t>>0]|0;if(r<<24>>24!=o<<24>>24)break;i=i+-1|0;if(!i){e=0;break e}else{e=e+1|0;t=t+1|0}}e=(r&255)-(o&255)|0}}while(0);return e|0}function wp(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0,n=0;r=J;J=J+16|0;n=r;o[n>>2]=s;s=Bp(e,t,i,n)|0;J=r;return s|0}function Bp(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0,a=0,l=0,A=0;A=J;J=J+160|0;n=A+144|0;l=A;hg(l|0,3672,144)|0;if((t+-1|0)>>>0>2147483646)if(!t){e=n;t=1;a=4}else{o[(zd()|0)>>2]=61;t=-1}else a=4;if((a|0)==4){a=-2-e|0;a=t>>>0>a>>>0?a:t;o[l+48>>2]=a;n=l+20|0;o[n>>2]=e;o[l+44>>2]=e;t=e+a|0;e=l+16|0;o[e>>2]=t;o[l+28>>2]=t;t=rp(l,i,r)|0;if(a){l=o[n>>2]|0;s[l+(((l|0)==(o[e>>2]|0))<<31>>31)>>0]=0}}J=A;return t|0}function Pp(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;s=e+20|0;r=o[s>>2]|0;e=(o[e+16>>2]|0)-r|0;e=e>>>0>i>>>0?i:e;hg(r|0,t|0,e|0)|0;o[s>>2]=(o[s>>2]|0)+e;return i|0}function xp(e){e=e|0;var t=0,i=0;t=(Zd(e)|0)+1|0;i=Km(t)|0;if(!i)e=0;else e=hg(i|0,e|0,t|0)|0;return e|0}function Cp(e,t){e=e|0;t=t|0;var i=0,r=0;i=0;while(1){if((n[656+i>>0]|0)==(e|0)){r=4;break}i=i+1|0;if((i|0)==87){e=87;r=5;break}}if((r|0)==4)if(!i)i=752;else{e=i;r=5}if((r|0)==5){i=752;do{do{r=i;i=i+1|0}while((s[r>>0]|0)!=0);e=e+-1|0}while((e|0)!=0)}return Mp(i,o[t+20>>2]|0)|0}function Mp(e,t){e=e|0;t=t|0;return ep(e,t)|0}function Ep(e){e=e|0;return Cp(e,o[(Fp()|0)+176>>2]|0)|0}function Fp(){return Xd()|0}function Ip(e,t,i){e=e|0;t=t|0;i=i|0;var r=0;r=Ep(e)|0;e=Zd(r)|0;if(e>>>0>=i>>>0){e=i+-1|0;if(!i)e=68;else{hg(t|0,r|0,e|0)|0;s[t+e>>0]=0;e=68}}else{hg(t|0,r|0,e+1|0)|0;e=0}return e|0}function Tp(){var e=0,t=0,i=0,s=0,r=0,n=0,a=0;s=J;J=J+48|0;n=s+32|0;t=s+24|0;a=s+16|0;r=s;s=s+36|0;e=Dp()|0;if(e|0?(i=o[e>>2]|0,i|0):0){e=i+48|0;if(!(Sp(e)|0)){o[t>>2]=20420;Up(20370,t)}t=Rp(e)|0;if((t|0)==1126902529&(B()|0)==1129074247)e=o[i+44>>2]|0;else e=i+80|0;o[s>>2]=e;i=o[i>>2]|0;e=o[i+4>>2]|0;if(Hg[o[(o[954]|0)+16>>2]&7](3816,i,s)|0){a=o[s>>2]|0;a=Ng[o[(o[a>>2]|0)+8>>2]&15](a)|0;o[r>>2]=20420;o[r+4>>2]=e;o[r+8>>2]=a;Up(20284,r)}else{o[a>>2]=20420;o[a+4>>2]=e;Up(20329,a)}}Up(20408,n)}function Dp(){return 21640}function Sp(e){e=e|0;e=Rp(e)|0;return(e&-256|0)==1126902528&(B()|0)==1129074247|0}function Rp(e){e=e|0;var t=0;t=e;e=o[t>>2]|0;w(o[t+4>>2]|0);return e|0}function Up(e,t){e=e|0;t=t|0;Z()}function Lp(e){e=e|0;return}function kp(e){e=e|0;Lp(e);$p(e);return}function Op(e){e=e|0;return}function Np(e){e=e|0;return}function Vp(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,a=0,l=0,A=0,c=0,h=0;h=J;J=J+64|0;A=h;if(!(Gp(e,t,0)|0))if((t|0)!=0?(c=Kp(t,3840,3824,0)|0,(c|0)!=0):0){o[A>>2]=c;o[A+4>>2]=0;o[A+8>>2]=e;o[A+12>>2]=-1;e=A+16|0;t=A+24|0;n=A+48|0;a=e;l=a+36|0;do{o[a>>2]=0;a=a+4|0}while((a|0)<(l|0));r[e+36>>1]=0;s[e+38>>0]=0;o[n>>2]=1;Xg[o[(o[c>>2]|0)+28>>2]&7](c,A,o[i>>2]|0,1);if((o[t>>2]|0)==1){o[i>>2]=o[e>>2];e=1}else e=0}else e=0;else e=1;J=h;return e|0}function Qp(e,t,i,s,r,n){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;n=n|0;if(Gp(e,o[t+8>>2]|0,n)|0)Xp(0,t,i,s,r);return}function Hp(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;var a=0;do{if(!(Gp(e,o[t+8>>2]|0,n)|0)){if(Gp(e,o[t>>2]|0,n)|0){if((o[t+16>>2]|0)!=(i|0)?(a=t+20|0,(o[a>>2]|0)!=(i|0)):0){o[t+32>>2]=r;o[a>>2]=i;n=t+40|0;o[n>>2]=(o[n>>2]|0)+1;if((o[t+36>>2]|0)==1?(o[t+24>>2]|0)==2:0)s[t+54>>0]=1;o[t+44>>2]=4;break}if((r|0)==1)o[t+32>>2]=1}}else Wp(0,t,i,r)}while(0);return}function jp(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;if(Gp(e,o[t+8>>2]|0,0)|0)zp(0,t,i,s);return}function Gp(e,t,i){e=e|0;t=t|0;i=i|0;if(i)if((e|0)==(t|0))e=1;else e=(Kd(o[e+4>>2]|0,o[t+4>>2]|0)|0)==0;else e=(o[e+4>>2]|0)==(o[t+4>>2]|0);return e|0}function zp(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0;e=t+16|0;n=o[e>>2]|0;do{if(n){if((n|0)!=(i|0)){r=t+36|0;o[r>>2]=(o[r>>2]|0)+1;o[t+24>>2]=2;s[t+54>>0]=1;break}e=t+24|0;if((o[e>>2]|0)==2)o[e>>2]=r}else{o[e>>2]=i;o[t+24>>2]=r;o[t+36>>2]=1}}while(0);return}function Wp(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0;if((o[t+4>>2]|0)==(i|0)?(r=t+28|0,(o[r>>2]|0)!=1):0)o[r>>2]=s;return}function Xp(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;s[t+53>>0]=1;do{if((o[t+4>>2]|0)==(r|0)){s[t+52>>0]=1;e=t+16|0;r=o[e>>2]|0;if(!r){o[e>>2]=i;o[t+24>>2]=n;o[t+36>>2]=1;if(!((n|0)==1?(o[t+48>>2]|0)==1:0))break;s[t+54>>0]=1;break}if((r|0)!=(i|0)){n=t+36|0;o[n>>2]=(o[n>>2]|0)+1;s[t+54>>0]=1;break}r=t+24|0;e=o[r>>2]|0;if((e|0)==2){o[r>>2]=n;e=n}if((e|0)==1?(o[t+48>>2]|0)==1:0)s[t+54>>0]=1}}while(0);return}function Kp(e,t,i,n){e=e|0;t=t|0;i=i|0;n=n|0;var a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0;f=J;J=J+64|0;d=f;u=o[e>>2]|0;p=e+(o[u+-8>>2]|0)|0;u=o[u+-4>>2]|0;o[d>>2]=i;o[d+4>>2]=e;o[d+8>>2]=t;o[d+12>>2]=n;e=d+16|0;t=d+20|0;n=d+24|0;a=d+28|0;l=d+32|0;A=d+40|0;c=e;h=c+36|0;do{o[c>>2]=0;c=c+4|0}while((c|0)<(h|0));r[e+36>>1]=0;s[e+38>>0]=0;e:do{if(Gp(u,i,0)|0){o[d+48>>2]=1;Zg[o[(o[u>>2]|0)+20>>2]&3](u,d,p,p,1,0);e=(o[n>>2]|0)==1?p:0}else{Kg[o[(o[u>>2]|0)+24>>2]&3](u,d,p,1,0);switch(o[d+36>>2]|0){case 0:{e=(o[A>>2]|0)==1&(o[a>>2]|0)==1&(o[l>>2]|0)==1?o[t>>2]|0:0;break e}case 1:break;default:{e=0;break e}}if((o[n>>2]|0)!=1?!((o[A>>2]|0)==0&(o[a>>2]|0)==1&(o[l>>2]|0)==1):0){e=0;break}e=o[e>>2]|0}}while(0);J=f;return e|0}function Zp(e){e=e|0;Lp(e);$p(e);return}function Jp(e,t,i,s,r,n){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;n=n|0;if(Gp(e,o[t+8>>2]|0,n)|0)Xp(0,t,i,s,r);else{e=o[e+8>>2]|0;Zg[o[(o[e>>2]|0)+20>>2]&3](e,t,i,s,r,n)}return}function Yp(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;var a=0,l=0,A=0;e:do{if(!(Gp(e,o[t+8>>2]|0,n)|0)){if(!(Gp(e,o[t>>2]|0,n)|0)){l=o[e+8>>2]|0;Kg[o[(o[l>>2]|0)+24>>2]&3](l,t,i,r,n);break}if((o[t+16>>2]|0)!=(i|0)?(l=t+20|0,(o[l>>2]|0)!=(i|0)):0){o[t+32>>2]=r;r=t+44|0;do{if((o[r>>2]|0)!=4){a=t+52|0;s[a>>0]=0;A=t+53|0;s[A>>0]=0;e=o[e+8>>2]|0;Zg[o[(o[e>>2]|0)+20>>2]&3](e,t,i,i,1,n);if(s[A>>0]|0){A=(s[a>>0]|0)==0;o[r>>2]=3;if(A)break;else break e}else{o[r>>2]=4;break}}}while(0);o[l>>2]=i;A=t+40|0;o[A>>2]=(o[A>>2]|0)+1;if((o[t+36>>2]|0)!=1)break;if((o[t+24>>2]|0)!=2)break;s[t+54>>0]=1;break}if((r|0)==1)o[t+32>>2]=1}else Wp(0,t,i,r)}while(0);return}function qp(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;if(Gp(e,o[t+8>>2]|0,0)|0)zp(0,t,i,s);else{e=o[e+8>>2]|0;Xg[o[(o[e>>2]|0)+28>>2]&7](e,t,i,s)}return}function $p(e){e=e|0;Zm(e);return}function ef(e){e=e|0;return}function tf(){var e=0,t=0;e=Dp()|0;if((e|0?(t=o[e>>2]|0,t|0):0)?Sp(t+48|0)|0:0)sf(o[t+12>>2]|0);sf(rf()|0)}function sf(e){e=e|0;var t=0;t=J;J=J+16|0;jg[e&3]();Up(20559,t)}function rf(){return 2}function of(e){e=e|0;return}function nf(e){e=e|0;$p(e);return}function af(e){e=e|0;return 20599}function lf(e){e=e|0;o[e>>2]=5916;uf(e+4|0);return}function Af(e){e=e|0;lf(e);$p(e);return}function cf(e){e=e|0;return hf(e+4|0)|0}function hf(e){e=e|0;return o[e>>2]|0}function uf(e){e=e|0;var t=0,i=0;if(df(e)|0?(t=pf(o[e>>2]|0)|0,i=t+8|0,e=o[i>>2]|0,o[i>>2]=e+-1,(e|0)<1):0)$p(t);return}function df(e){e=e|0;return 1}function pf(e){e=e|0;return e+-12|0}function ff(e){e=e|0;o[e>>2]=5936;uf(e+4|0);return}function mf(e){e=e|0;ff(e);$p(e);return}function gf(e){e=e|0;return hf(e+4|0)|0}function _f(e){e=e|0;lf(e);$p(e);return}function vf(e){e=e|0;lf(e);$p(e);return}function bf(){var e=0;e=J;J=J+16|0;Up(20848,e)}function yf(e){e=e|0;Lp(e);$p(e);return}function wf(e,t,i){e=e|0;t=t|0;i=i|0;return Gp(e,t,0)|0}function Bf(e){e=e|0;Lp(e);$p(e);return}function Pf(e,t,i){e=e|0;t=t|0;i=i|0;var n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0;d=J;J=J+64|0;h=d;do{if(!(Gp(t,4048,0)|0)){if(xf(e,t,0)|0){t=o[i>>2]|0;if(!t){t=1;break}o[i>>2]=o[t>>2];t=1;break}if((t|0)!=0?(n=Kp(t,3840,3976,0)|0,(n|0)!=0):0){t=o[i>>2]|0;if(t|0)o[i>>2]=o[t>>2];t=o[n+8>>2]|0;l=e+8|0;a=o[l>>2]|0;if((t&7&(a^7)|0)==0?((t&96^96)&a|0)==0:0){a=e+12|0;e=o[a>>2]|0;n=n+12|0;t=o[n>>2]|0;if(!(Gp(e,t,0)|0)){if(Gp(e,4040,0)|0){if(!t){t=1;break}t=(Kp(t,3840,3992,0)|0)==0;break}if(e){t=Kp(e,3840,3976,0)|0;if(t|0){if(!(o[l>>2]&1)){t=0;break}t=Cf(t,o[n>>2]|0)|0;break}t=o[a>>2]|0;if(t){t=Kp(t,3840,4008,0)|0;if(t|0){if(!(o[l>>2]&1)){t=0;break}t=Mf(t,o[n>>2]|0)|0;break}t=o[a>>2]|0;if((((t|0)!=0?(A=Kp(t,3840,3824,0)|0,(A|0)!=0):0)?(c=o[n>>2]|0,(c|0)!=0):0)?(u=Kp(c,3840,3824,0)|0,(u|0)!=0):0){o[h>>2]=u;o[h+4>>2]=0;o[h+8>>2]=A;o[h+12>>2]=-1;t=h+16|0;e=h+24|0;n=h+48|0;a=t;l=a+36|0;do{o[a>>2]=0;a=a+4|0}while((a|0)<(l|0));r[t+36>>1]=0;s[t+38>>0]=0;o[n>>2]=1;Xg[o[(o[u>>2]|0)+28>>2]&7](u,h,o[i>>2]|0,1);do{if((o[e>>2]|0)==1){if(!(o[i>>2]|0)){t=1;break}o[i>>2]=o[t>>2];t=1}else t=0}while(0)}else t=0}else t=0}else t=0}else t=1}else t=0}else t=0}else{o[i>>2]=0;t=1}}while(0);J=d;return t|0}function xf(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;if(!(o[e+8>>2]&24))if((t|0)!=0?(s=Kp(t,3840,3960,0)|0,(s|0)!=0):0){i=(o[s+8>>2]&24|0)!=0;r=5}else i=0;else{i=1;r=5}if((r|0)==5)i=Gp(e,t,i)|0;return i|0}function Cf(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,n=0,a=0;while(1){if(!t){t=0;break}i=Kp(t,3840,3976,0)|0;if(!i){t=0;break}r=o[e+8>>2]|0;if(o[i+8>>2]&~r|0){t=0;break}s=e+12|0;t=o[s>>2]|0;i=i+12|0;if(Gp(t,o[i>>2]|0,0)|0){t=1;break}if((r&1|0)==0|(t|0)==0){t=0;break}e=Kp(t,3840,3976,0)|0;if(!e){a=9;break}t=o[i>>2]|0}if((a|0)==9){t=o[s>>2]|0;if((t|0)!=0?(n=Kp(t,3840,4008,0)|0,(n|0)!=0):0)t=Mf(n,o[i>>2]|0)|0;else t=0}return t|0}function Mf(e,t){e=e|0;t=t|0;var i=0;if((((t|0)!=0?(i=Kp(t,3840,4008,0)|0,(i|0)!=0):0)?(o[i+8>>2]&~o[e+8>>2]|0)==0:0)?Gp(o[e+12>>2]|0,o[i+12>>2]|0,0)|0:0)e=Gp(o[e+16>>2]|0,o[i+16>>2]|0,0)|0;else e=0;return e|0}function Ef(e){e=e|0;Lp(e);$p(e);return}function Ff(e,t,i,r,n,a){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;a=a|0;var l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0,g=0;if(Gp(e,o[t+8>>2]|0,a)|0)Xp(0,t,i,r,n);else{g=t+52|0;A=s[g>>0]|0;m=t+53|0;l=s[m>>0]|0;f=o[e+12>>2]|0;u=e+16+(f<<3)|0;s[g>>0]=0;s[m>>0]=0;Sf(e+16|0,t,i,r,n,a);c=s[g>>0]|0;A=c|A;h=s[m>>0]|0;l=h|l;e:do{if((f|0)>1){d=t+24|0;p=e+8|0;f=t+54|0;e=e+24|0;do{l=l&1;A=A&1;if(s[f>>0]|0)break e;if(!(c<<24>>24)){if(h<<24>>24?(o[p>>2]&1|0)==0:0)break e}else{if((o[d>>2]|0)==1)break e;if(!(o[p>>2]&2))break e}s[g>>0]=0;s[m>>0]=0;Sf(e,t,i,r,n,a);c=s[g>>0]|0;A=c|A;h=s[m>>0]|0;l=h|l;e=e+8|0}while(e>>>0<u>>>0)}}while(0);s[g>>0]=A<<24>>24!=0&1;s[m>>0]=l<<24>>24!=0&1}return}function If(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;var a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0;e:do{if(!(Gp(e,o[t+8>>2]|0,n)|0)){if(!(Gp(e,o[t>>2]|0,n)|0)){f=o[e+12>>2]|0;c=e+16+(f<<3)|0;Rf(e+16|0,t,i,r,n);a=e+24|0;if((f|0)<=1)break;e=o[e+8>>2]|0;if((e&2|0)==0?(A=t+36|0,(o[A>>2]|0)!=1):0){if(!(e&1)){e=t+54|0;while(1){if(s[e>>0]|0)break e;if((o[A>>2]|0)==1)break e;Rf(a,t,i,r,n);a=a+8|0;if(a>>>0>=c>>>0)break e}}e=t+24|0;l=t+54|0;while(1){if(s[l>>0]|0)break e;if((o[A>>2]|0)==1?(o[e>>2]|0)==1:0)break e;Rf(a,t,i,r,n);a=a+8|0;if(a>>>0>=c>>>0)break e}}e=t+54|0;while(1){if(s[e>>0]|0)break e;Rf(a,t,i,r,n);a=a+8|0;if(a>>>0>=c>>>0)break e}}if((o[t+16>>2]|0)!=(i|0)?(f=t+20|0,(o[f>>2]|0)!=(i|0)):0){o[t+32>>2]=r;p=t+44|0;if((o[p>>2]|0)!=4){A=e+16+(o[e+12>>2]<<3)|0;c=t+52|0;r=t+53|0;h=t+54|0;u=e+8|0;d=t+24|0;a=0;l=e+16|0;e=0;t:while(1){if(l>>>0>=A>>>0){l=18;break}s[c>>0]=0;s[r>>0]=0;Sf(l,t,i,i,1,n);if(s[h>>0]|0){l=18;break}do{if(s[r>>0]|0){if(!(s[c>>0]|0))if(!(o[u>>2]&1)){l=19;break t}else{e=1;break}if((o[d>>2]|0)==1){a=1;l=19;break t}if(!(o[u>>2]&2)){a=1;l=19;break t}else{a=1;e=1}}}while(0);l=l+8|0}if((l|0)==18)if(e)l=19;else e=4;if((l|0)==19)e=3;o[p>>2]=e;if(a&1)break}o[f>>2]=i;i=t+40|0;o[i>>2]=(o[i>>2]|0)+1;if((o[t+36>>2]|0)!=1)break;if((o[t+24>>2]|0)!=2)break;s[t+54>>0]=1;break}if((r|0)==1)o[t+32>>2]=1}else Wp(0,t,i,r)}while(0);return}function Tf(e,t,i,r){e=e|0;t=t|0;i=i|0;r=r|0;var n=0,a=0;e:do{if(!(Gp(e,o[t+8>>2]|0,0)|0)){a=o[e+12>>2]|0;n=e+16+(a<<3)|0;Df(e+16|0,t,i,r);if((a|0)>1){a=t+54|0;e=e+24|0;do{Df(e,t,i,r);if(s[a>>0]|0)break e;e=e+8|0}while(e>>>0<n>>>0)}}else zp(0,t,i,r)}while(0);return}function Df(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0,n=0;n=o[e+4>>2]|0;if(i){r=n>>8;if(n&1)r=o[(o[i>>2]|0)+r>>2]|0}else r=0;e=o[e>>2]|0;Xg[o[(o[e>>2]|0)+28>>2]&7](e,t,i+r|0,(n&2|0)==0?2:s);return}function Sf(e,t,i,s,r,n){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;n=n|0;var a=0,l=0;l=o[e+4>>2]|0;a=l>>8;if(l&1)a=o[(o[s>>2]|0)+a>>2]|0;e=o[e>>2]|0;Zg[o[(o[e>>2]|0)+20>>2]&3](e,t,i,s+a|0,(l&2|0)==0?2:r,n);return}function Rf(e,t,i,s,r){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;var n=0,a=0;a=o[e+4>>2]|0;n=a>>8;if(a&1)n=o[(o[i>>2]|0)+n>>2]|0;e=o[e>>2]|0;Kg[o[(o[e>>2]|0)+24>>2]&3](e,t,i+n|0,(a&2|0)==0?2:s,r);return}function Uf(e){e=e|0;o[e>>2]=5896;return}function Lf(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;kf(i,e);e=Of(i)|0;J=t;return e|0}function kf(e,t){e=e|0;t=t|0;jf(e,t);return}function Of(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;Nf(i,o[e+4>>2]|0);if(!((Vf(i)|0)<<24>>24))e=Hf(Qf(e)|0)|0;else e=0;J=t;return e|0}function Nf(e,t){e=e|0;t=t|0;o[e>>2]=t;return}function Vf(e){e=e|0;return s[o[e>>2]>>0]|0}function Qf(e){e=e|0;return e|0}function Hf(e){e=e|0;var t=0,i=0,r=0,n=0;n=J;J=J+16|0;r=n;e=o[e+8>>2]|0;t=s[e>>0]|0;do{if(t<<24>>24!=1)if(!(t&2)){s[e>>0]=2;i=1;break}else Up(20985,r);else i=0}while(0);J=n;return i|0}function jf(e,t){e=e|0;t=t|0;o[e>>2]=t;o[e+4>>2]=t;o[e+8>>2]=t+1;o[e+12>>2]=0;return}function Gf(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;kf(i,e);zf(i);J=t;return}function zf(e){e=e|0;var t=0,i=0;t=J;J=J+16|0;i=t;Nf(i,o[e+4>>2]|0);Wf(i);Xf(Qf(e)|0);J=t;return}function Wf(e){e=e|0;s[o[e>>2]>>0]=1;return}function Xf(e){e=e|0;s[o[e+8>>2]>>0]=1;return}function Kf(){return 0}function Zf(e){e=e|0;var t=0,i=0;i=(e|0)==0?1:e;while(1){t=Km(i)|0;if(t|0){e=6;break}e=Kf()|0;if(!e){e=5;break}jg[e&3]()}if((e|0)==5){i=P(4)|0;Uf(i);C(i|0,3880,121)}else if((e|0)==6)return t|0;return 0}function Jf(e){e=e|0;return Zf(e)|0}function Yf(e){e=e|0;$p(e);return}function qf(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;r=J;J=J+16|0;s=r;o[s>>2]=o[i>>2];e=Hg[o[(o[e>>2]|0)+16>>2]&7](e,t,s)|0;if(e)o[i>>2]=o[s>>2];J=r;return e&1|0}function $f(e){e=e|0;if(!e)e=0;else e=(Kp(e,3840,3976,0)|0)!=0&1;return e|0}function em(e){e=e|0;return 0}function tm(){return(im()|0)>0|0}function im(){return M()|0}function sm(e){e=e|0;return}function rm(e){e=e|0;sm(e);$p(e);return}function om(e){e=e|0;return 21039}function nm(e){e=e|0;return}function am(e){e=e|0;var t=0,i=0;t=e+8|0;if(!((o[t>>2]|0)!=0?(i=o[t>>2]|0,o[t>>2]=i+-1,(i|0)!=0):0))Gg[o[(o[e>>2]|0)+16>>2]&255](e);return}function lm(e){e=e|0;e=em(e)|0;if(!e)return;else Wm(e,21145)}function Am(e){e=e|0;return}function cm(e,t){e=e|0;t=t|0;var i=0,s=0;s=Zd(t)|0;i=Zf(s+13|0)|0;o[i>>2]=s;o[i+4>>2]=s;o[i+8>>2]=0;i=hm(i)|0;hg(i|0,t|0,s+1|0)|0;o[e>>2]=i;return}function hm(e){e=e|0;return e+12|0}function um(e,t){e=e|0;t=t|0;o[e>>2]=5916;cm(e+4|0,t);return}function dm(e,t){e=e|0;t=t|0;o[e>>2]=5936;cm(e+4|0,(s[t+11>>0]|0)<0?o[t>>2]|0:t);return}function pm(e,t){e=e|0;t=t|0;o[e>>2]=5936;cm(e+4|0,t);return}function fm(e){e=e|0;e=P(8)|0;um(e,21163);o[e>>2]=5956;C(e|0,3928,123)}function mm(e){e=e|0;e=P(8)|0;um(e,21163);o[e>>2]=5976;C(e|0,3944,123)}function gm(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0,l=0;n=J;J=J+16|0;r=n;if(i>>>0>4294967279)fm(e);if(i>>>0<11)s[e+11>>0]=i;else{l=i+16&-16;a=Zf(l)|0;o[e>>2]=a;o[e+8>>2]=l|-2147483648;o[e+4>>2]=i;e=a}_m(e,t,i)|0;s[r>>0]=0;rt(e+i|0,r);J=n;return}function _m(e,t,i){e=e|0;t=t|0;i=i|0;if(i|0)hg(e|0,t|0,i|0)|0;return e|0}function vm(e){e=e|0;if((s[e+11>>0]|0)<0)be(o[e>>2]|0,o[e+8>>2]&2147483647);return}function bm(e,t,i,r,n,a,l,A){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;a=a|0;l=l|0;A=A|0;var c=0,h=0,u=0,d=0,p=0;p=J;J=J+16|0;d=p;if((-18-t|0)>>>0<i>>>0)fm(e);if((s[e+11>>0]|0)<0)u=o[e>>2]|0;else u=e;if(t>>>0<2147483623){c=i+t|0;h=t<<1;c=c>>>0<h>>>0?h:c;c=c>>>0<11?11:c+16&-16}else c=-17;h=Zf(c)|0;if(n|0)_m(h,u,n)|0;if(l|0)_m(h+n|0,A,l)|0;r=r-a|0;i=r-n|0;if(i|0)_m(h+n+l|0,u+n+a|0,i)|0;i=t+1|0;if((i|0)!=11)be(u,i);o[e>>2]=h;o[e+8>>2]=c|-2147483648;l=r+l|0;o[e+4>>2]=l;s[d>>0]=0;rt(h+l|0,d);J=p;return}function ym(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0,l=0,A=0,c=0;c=J;J=J+16|0;l=c;A=e+11|0;r=s[A>>0]|0;a=r<<24>>24<0;if(a){n=(o[e+8>>2]&2147483647)+-1|0;r=o[e+4>>2]|0}else{n=10;r=r&255}if((n-r|0)>>>0>=i>>>0){if(i|0){if(a)n=o[e>>2]|0;else n=e;_m(n+r|0,t,i)|0;r=r+i|0;if((s[A>>0]|0)<0)o[e+4>>2]=r;else s[A>>0]=r;s[l>>0]=0;rt(n+r|0,l)}}else bm(e,n,r+i-n|0,r,r,0,i,t);J=c;return e|0}function wm(e,t){e=e|0;t=t|0;return ym(e,t,it(t)|0)|0}function Bm(e,t,i){e=e|0;t=t|0;i=i|0;if(!i)e=0;else e=yp(e,t,i)|0;return e|0}function Pm(e,t,i,r,n){e=e|0;t=t|0;i=i|0;r=r|0;n=n|0;var a=0,l=0;a=s[e+11>>0]|0;l=a<<24>>24<0;if(l)a=o[e+4>>2]|0;else a=a&255;if((n|0)==-1|a>>>0<t>>>0)mm(e);a=a-t|0;i=a>>>0<i>>>0?a:i;if(l)e=o[e>>2]|0;a=i>>>0>n>>>0;e=Bm(e+t|0,r,a?n:i)|0;if(!e)return(i>>>0<n>>>0?-1:a&1)|0;else return e|0;return 0}function xm(e){e=e|0;return}function Cm(e){e=e|0;$p(e);return}function Mm(e){e=e|0;return 21228}function Em(e,t,i){e=e|0;t=t|0;i=i|0;o[e>>2]=i;o[e+4>>2]=t;return}function Fm(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0;r=J;J=J+16|0;s=r;Wg[o[(o[e>>2]|0)+12>>2]&15](s,e,t);if((o[s+4>>2]|0)==(o[i+4>>2]|0))e=(o[s>>2]|0)==(o[i>>2]|0);else e=0;J=r;return e|0}function Im(e,t,i){e=e|0;t=t|0;i=i|0;return((o[t>>2]|0)==(i|0)?(o[t+4>>2]|0)==(e|0):0)|0}function Tm(e,t,i){e=e|0;t=t|0;i=i|0;if((i|0)>256)gm(e,21176,it(21176)|0);else Dm(e,0,i);return}function Dm(e,t,i){e=e|0;t=t|0;i=i|0;Sm(e,i);return}function Sm(e,t){e=e|0;t=t|0;var i=0,r=0,n=0,a=0,l=0;l=J;J=J+1040|0;n=l+1024|0;i=l;a=o[(zd()|0)>>2]|0;r=Rm(Ip(t,i,1024)|0,i)|0;if(!(s[r>>0]|0)){o[n>>2]=t;wp(i,1024,21211,n)|0}else i=r;o[(zd()|0)>>2]=a;gm(e,i,it(i)|0);J=l;return}function Rm(e,t){e=e|0;t=t|0;var i=0,s=0;switch(e|0){case 0:{i=t;break}case-1:{e=o[(zd()|0)>>2]|0;s=3;break}default:s=3}if((s|0)==3)if((e|0)==28)i=22145;else G();return i|0}function Um(e){e=e|0;$p(e);return}function Lm(e){e=e|0;return 21353}function km(e,t,i){e=e|0;t=t|0;i=i|0;if((i|0)>256){Nm()|0;t=6180}else{Vm()|0;t=6176}o[e>>2]=i;o[e+4>>2]=t;return}function Om(e,t,i){e=e|0;t=t|0;i=i|0;if((i|0)>256)gm(e,21319,it(21319)|0);else Dm(e,0,i);return}function Nm(){if((s[21488]|0)==0?Lf(21488)|0:0)Gf(21488);return 6180}function Vm(){if((s[21480]|0)==0?Lf(21480)|0:0)Gf(21480);return 6176}function Qm(e){e=e|0;ff(e);return}function Hm(e){e=e|0;Qm(e);$p(e);return}function jm(e,t){e=e|0;t=t|0;var i=0;i=o[t+4>>2]|0;Wg[o[(o[i>>2]|0)+24>>2]&15](e,i,o[t>>2]|0);return}function Gm(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0;a=J;J=J+16|0;n=a;if(o[t>>2]|0){r=s[i+11>>0]|0;if(r<<24>>24<0)r=o[i+4>>2]|0;else r=r&255;if(r|0)wm(i,21417)|0;jm(n,t);t=s[n+11>>0]|0;r=t<<24>>24<0;ym(i,r?o[n>>2]|0:n,r?o[n+4>>2]|0:t&255)|0;vm(n)}o[e>>2]=o[i>>2];o[e+4>>2]=o[i+4>>2];o[e+8>>2]=o[i+8>>2];r=0;while(1){if((r|0)==3)break;o[i+(r<<2)>>2]=0;r=r+1|0}J=a;return}function zm(e,t,i){e=e|0;t=t|0;i=i|0;var s=0,r=0,n=0;s=J;J=J+32|0;n=s+12|0;r=s;gm(r,i,it(i)|0);Gm(n,t,r);dm(e,n);vm(n);vm(r);o[e>>2]=6192;r=t;t=o[r+4>>2]|0;i=e+8|0;o[i>>2]=o[r>>2];o[i+4>>2]=t;J=s;return}function Wm(e,t){e=e|0;t=t|0;var i=0,s=0,r=0;r=J;J=J+16|0;s=r+8|0;i=P(16)|0;Nm()|0;o[r>>2]=e;o[r+4>>2]=6180;o[s>>2]=o[r>>2];o[s+4>>2]=o[r+4>>2];zm(i,s,t);C(i|0,4272,136)}function Xm(e){e=e|0;e=P(8)|0;um(e,21420);o[e>>2]=5956;C(e|0,3928,123)}function Km(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0,g=0,_=0,v=0,b=0,y=0,w=0;w=J;J=J+16|0;d=w;do{if(e>>>0<245){c=e>>>0<11?16:e+11&-8;e=c>>>3;u=o[5412]|0;i=u>>>e;if(i&3|0){t=(i&1^1)+e|0;e=21688+(t<<1<<2)|0;i=e+8|0;s=o[i>>2]|0;r=s+8|0;n=o[r>>2]|0;if((n|0)==(e|0))o[5412]=u&~(1<<t);else{o[n+12>>2]=e;o[i>>2]=n}y=t<<3;o[s+4>>2]=y|3;y=s+y+4|0;o[y>>2]=o[y>>2]|1;y=r;J=w;return y|0}h=o[5414]|0;if(c>>>0>h>>>0){if(i|0){t=2<<e;t=i<<e&(t|0-t);t=(t&0-t)+-1|0;l=t>>>12&16;t=t>>>l;i=t>>>5&8;t=t>>>i;n=t>>>2&4;t=t>>>n;e=t>>>1&2;t=t>>>e;s=t>>>1&1;s=(i|l|n|e|s)+(t>>>s)|0;t=21688+(s<<1<<2)|0;e=t+8|0;n=o[e>>2]|0;l=n+8|0;i=o[l>>2]|0;if((i|0)==(t|0)){e=u&~(1<<s);o[5412]=e}else{o[i+12>>2]=t;o[e>>2]=i;e=u}y=s<<3;a=y-c|0;o[n+4>>2]=c|3;r=n+c|0;o[r+4>>2]=a|1;o[n+y>>2]=a;if(h|0){s=o[5417]|0;t=h>>>3;i=21688+(t<<1<<2)|0;t=1<<t;if(!(e&t)){o[5412]=e|t;t=i;e=i+8|0}else{e=i+8|0;t=o[e>>2]|0}o[e>>2]=s;o[t+12>>2]=s;o[s+8>>2]=t;o[s+12>>2]=i}o[5414]=a;o[5417]=r;y=l;J=w;return y|0}n=o[5413]|0;if(n){i=(n&0-n)+-1|0;r=i>>>12&16;i=i>>>r;s=i>>>5&8;i=i>>>s;a=i>>>2&4;i=i>>>a;l=i>>>1&2;i=i>>>l;A=i>>>1&1;A=o[21952+((s|r|a|l|A)+(i>>>A)<<2)>>2]|0;i=A;l=A;A=(o[A+4>>2]&-8)-c|0;while(1){e=o[i+16>>2]|0;if(!e){e=o[i+20>>2]|0;if(!e)break}a=(o[e+4>>2]&-8)-c|0;r=a>>>0<A>>>0;i=e;l=r?e:l;A=r?a:A}a=l+c|0;if(a>>>0>l>>>0){r=o[l+24>>2]|0;t=o[l+12>>2]|0;do{if((t|0)==(l|0)){e=l+20|0;t=o[e>>2]|0;if(!t){e=l+16|0;t=o[e>>2]|0;if(!t){i=0;break}}while(1){s=t+20|0;i=o[s>>2]|0;if(!i){s=t+16|0;i=o[s>>2]|0;if(!i)break;else{t=i;e=s}}else{t=i;e=s}}o[e>>2]=0;i=t}else{i=o[l+8>>2]|0;o[i+12>>2]=t;o[t+8>>2]=i;i=t}}while(0);do{if(r|0){t=o[l+28>>2]|0;e=21952+(t<<2)|0;if((l|0)==(o[e>>2]|0)){o[e>>2]=i;if(!i){o[5413]=n&~(1<<t);break}}else{y=r+16|0;o[((o[y>>2]|0)==(l|0)?y:r+20|0)>>2]=i;if(!i)break}o[i+24>>2]=r;t=o[l+16>>2]|0;if(t|0){o[i+16>>2]=t;o[t+24>>2]=i}t=o[l+20>>2]|0;if(t|0){o[i+20>>2]=t;o[t+24>>2]=i}}}while(0);if(A>>>0<16){y=A+c|0;o[l+4>>2]=y|3;y=l+y+4|0;o[y>>2]=o[y>>2]|1}else{o[l+4>>2]=c|3;o[a+4>>2]=A|1;o[a+A>>2]=A;if(h|0){s=o[5417]|0;t=h>>>3;i=21688+(t<<1<<2)|0;t=1<<t;if(!(t&u)){o[5412]=t|u;t=i;e=i+8|0}else{e=i+8|0;t=o[e>>2]|0}o[e>>2]=s;o[t+12>>2]=s;o[s+8>>2]=t;o[s+12>>2]=i}o[5414]=A;o[5417]=a}y=l+8|0;J=w;return y|0}else u=c}else u=c}else u=c}else if(e>>>0<=4294967231){e=e+11|0;c=e&-8;s=o[5413]|0;if(s){r=0-c|0;e=e>>>8;if(e)if(c>>>0>16777215)A=31;else{u=(e+1048320|0)>>>16&8;m=e<<u;l=(m+520192|0)>>>16&4;m=m<<l;A=(m+245760|0)>>>16&2;A=14-(l|u|A)+(m<<A>>>15)|0;A=c>>>(A+7|0)&1|A<<1}else A=0;i=o[21952+(A<<2)>>2]|0;e:do{if(!i){i=0;e=0;m=61}else{e=0;l=c<<((A|0)==31?0:25-(A>>>1)|0);n=0;while(1){a=(o[i+4>>2]&-8)-c|0;if(a>>>0<r>>>0)if(!a){e=i;r=0;m=65;break e}else{e=i;r=a}m=o[i+20>>2]|0;i=o[i+16+(l>>>31<<2)>>2]|0;n=(m|0)==0|(m|0)==(i|0)?n:m;if(!i){i=n;m=61;break}else l=l<<1}}}while(0);if((m|0)==61){if((i|0)==0&(e|0)==0){e=2<<A;e=(e|0-e)&s;if(!e){u=c;break}u=(e&0-e)+-1|0;a=u>>>12&16;u=u>>>a;n=u>>>5&8;u=u>>>n;l=u>>>2&4;u=u>>>l;A=u>>>1&2;u=u>>>A;i=u>>>1&1;e=0;i=o[21952+((n|a|l|A|i)+(u>>>i)<<2)>>2]|0}if(!i){l=e;a=r}else m=65}if((m|0)==65){n=i;while(1){u=(o[n+4>>2]&-8)-c|0;i=u>>>0<r>>>0;r=i?u:r;e=i?n:e;i=o[n+16>>2]|0;if(!i)i=o[n+20>>2]|0;if(!i){l=e;a=r;break}else n=i}}if(((l|0)!=0?a>>>0<((o[5414]|0)-c|0)>>>0:0)?(h=l+c|0,h>>>0>l>>>0):0){n=o[l+24>>2]|0;t=o[l+12>>2]|0;do{if((t|0)==(l|0)){e=l+20|0;t=o[e>>2]|0;if(!t){e=l+16|0;t=o[e>>2]|0;if(!t){t=0;break}}while(1){r=t+20|0;i=o[r>>2]|0;if(!i){r=t+16|0;i=o[r>>2]|0;if(!i)break;else{t=i;e=r}}else{t=i;e=r}}o[e>>2]=0}else{y=o[l+8>>2]|0;o[y+12>>2]=t;o[t+8>>2]=y}}while(0);do{if(n){e=o[l+28>>2]|0;i=21952+(e<<2)|0;if((l|0)==(o[i>>2]|0)){o[i>>2]=t;if(!t){s=s&~(1<<e);o[5413]=s;break}}else{y=n+16|0;o[((o[y>>2]|0)==(l|0)?y:n+20|0)>>2]=t;if(!t)break}o[t+24>>2]=n;e=o[l+16>>2]|0;if(e|0){o[t+16>>2]=e;o[e+24>>2]=t}e=o[l+20>>2]|0;if(e){o[t+20>>2]=e;o[e+24>>2]=t}}}while(0);e:do{if(a>>>0<16){y=a+c|0;o[l+4>>2]=y|3;y=l+y+4|0;o[y>>2]=o[y>>2]|1}else{o[l+4>>2]=c|3;o[h+4>>2]=a|1;o[h+a>>2]=a;t=a>>>3;if(a>>>0<256){i=21688+(t<<1<<2)|0;e=o[5412]|0;t=1<<t;if(!(e&t)){o[5412]=e|t;t=i;e=i+8|0}else{e=i+8|0;t=o[e>>2]|0}o[e>>2]=h;o[t+12>>2]=h;o[h+8>>2]=t;o[h+12>>2]=i;break}t=a>>>8;if(t)if(a>>>0>16777215)i=31;else{b=(t+1048320|0)>>>16&8;y=t<<b;v=(y+520192|0)>>>16&4;y=y<<v;i=(y+245760|0)>>>16&2;i=14-(v|b|i)+(y<<i>>>15)|0;i=a>>>(i+7|0)&1|i<<1}else i=0;t=21952+(i<<2)|0;o[h+28>>2]=i;e=h+16|0;o[e+4>>2]=0;o[e>>2]=0;e=1<<i;if(!(s&e)){o[5413]=s|e;o[t>>2]=h;o[h+24>>2]=t;o[h+12>>2]=h;o[h+8>>2]=h;break}t=o[t>>2]|0;t:do{if((o[t+4>>2]&-8|0)!=(a|0)){s=a<<((i|0)==31?0:25-(i>>>1)|0);while(1){i=t+16+(s>>>31<<2)|0;e=o[i>>2]|0;if(!e)break;if((o[e+4>>2]&-8|0)==(a|0)){t=e;break t}else{s=s<<1;t=e}}o[i>>2]=h;o[h+24>>2]=t;o[h+12>>2]=h;o[h+8>>2]=h;break e}}while(0);b=t+8|0;y=o[b>>2]|0;o[y+12>>2]=h;o[b>>2]=h;o[h+8>>2]=y;o[h+12>>2]=t;o[h+24>>2]=0}}while(0);y=l+8|0;J=w;return y|0}else u=c}else u=c}else u=-1}while(0);i=o[5414]|0;if(i>>>0>=u>>>0){t=i-u|0;e=o[5417]|0;if(t>>>0>15){y=e+u|0;o[5417]=y;o[5414]=t;o[y+4>>2]=t|1;o[e+i>>2]=t;o[e+4>>2]=u|3}else{o[5414]=0;o[5417]=0;o[e+4>>2]=i|3;y=e+i+4|0;o[y>>2]=o[y>>2]|1}y=e+8|0;J=w;return y|0}a=o[5415]|0;if(a>>>0>u>>>0){v=a-u|0;o[5415]=v;y=o[5418]|0;b=y+u|0;o[5418]=b;o[b+4>>2]=v|1;o[y+4>>2]=u|3;y=y+8|0;J=w;return y|0}if(!(o[5530]|0)){o[5532]=4096;o[5531]=4096;o[5533]=-1;o[5534]=-1;o[5535]=0;o[5523]=0;o[5530]=d&-16^1431655768;e=4096}else e=o[5532]|0;l=u+48|0;A=u+47|0;n=e+A|0;r=0-e|0;c=n&r;if(c>>>0<=u>>>0){y=0;J=w;return y|0}e=o[5522]|0;if(e|0?(h=o[5520]|0,d=h+c|0,d>>>0<=h>>>0|d>>>0>e>>>0):0){y=0;J=w;return y|0}e:do{if(!(o[5523]&4)){i=o[5418]|0;t:do{if(i){s=22096;while(1){d=o[s>>2]|0;if(d>>>0<=i>>>0?(d+(o[s+4>>2]|0)|0)>>>0>i>>>0:0)break;e=o[s+8>>2]|0;if(!e){m=128;break t}else s=e}t=n-a&r;if(t>>>0<2147483647){e=Jm(t)|0;if((e|0)==((o[s>>2]|0)+(o[s+4>>2]|0)|0)){if((e|0)!=(-1|0)){a=t;n=e;m=145;break e}}else{s=e;m=136}}else t=0}else m=128}while(0);do{if((m|0)==128){i=Jm(0)|0;if((i|0)!=(-1|0)?(t=i,p=o[5531]|0,f=p+-1|0,t=((f&t|0)==0?0:(f+t&0-p)-t|0)+c|0,p=o[5520]|0,f=t+p|0,t>>>0>u>>>0&t>>>0<2147483647):0){d=o[5522]|0;if(d|0?f>>>0<=p>>>0|f>>>0>d>>>0:0){t=0;break}e=Jm(t)|0;if((e|0)==(i|0)){a=t;n=i;m=145;break e}else{s=e;m=136}}else t=0}}while(0);do{if((m|0)==136){i=0-t|0;if(!(l>>>0>t>>>0&(t>>>0<2147483647&(s|0)!=(-1|0))))if((s|0)==(-1|0)){t=0;break}else{a=t;n=s;m=145;break e}e=o[5532]|0;e=A-t+e&0-e;if(e>>>0>=2147483647){a=t;n=s;m=145;break e}if((Jm(e)|0)==(-1|0)){Jm(i)|0;t=0;break}else{a=e+t|0;n=s;m=145;break e}}}while(0);o[5523]=o[5523]|4;m=143}else{t=0;m=143}}while(0);if(((m|0)==143?c>>>0<2147483647:0)?(v=Jm(c)|0,f=Jm(0)|0,g=f-v|0,_=g>>>0>(u+40|0)>>>0,!((v|0)==(-1|0)|_^1|v>>>0<f>>>0&((v|0)!=(-1|0)&(f|0)!=(-1|0))^1)):0){a=_?g:t;n=v;m=145}if((m|0)==145){t=(o[5520]|0)+a|0;o[5520]=t;if(t>>>0>(o[5521]|0)>>>0)o[5521]=t;A=o[5418]|0;e:do{if(A){t=22096;while(1){e=o[t>>2]|0;i=o[t+4>>2]|0;if((n|0)==(e+i|0)){m=154;break}s=o[t+8>>2]|0;if(!s)break;else t=s}if(((m|0)==154?(b=t+4|0,(o[t+12>>2]&8|0)==0):0)?n>>>0>A>>>0&e>>>0<=A>>>0:0){o[b>>2]=i+a;y=(o[5415]|0)+a|0;v=A+8|0;v=(v&7|0)==0?0:0-v&7;b=A+v|0;v=y-v|0;o[5418]=b;o[5415]=v;o[b+4>>2]=v|1;o[A+y+4>>2]=40;o[5419]=o[5534];break}if(n>>>0<(o[5416]|0)>>>0)o[5416]=n;i=n+a|0;t=22096;while(1){if((o[t>>2]|0)==(i|0)){m=162;break}e=o[t+8>>2]|0;if(!e)break;else t=e}if((m|0)==162?(o[t+12>>2]&8|0)==0:0){o[t>>2]=n;h=t+4|0;o[h>>2]=(o[h>>2]|0)+a;h=n+8|0;h=n+((h&7|0)==0?0:0-h&7)|0;t=i+8|0;t=i+((t&7|0)==0?0:0-t&7)|0;c=h+u|0;l=t-h-u|0;o[h+4>>2]=u|3;t:do{if((A|0)==(t|0)){y=(o[5415]|0)+l|0;o[5415]=y;o[5418]=c;o[c+4>>2]=y|1}else{if((o[5417]|0)==(t|0)){y=(o[5414]|0)+l|0;o[5414]=y;o[5417]=c;o[c+4>>2]=y|1;o[c+y>>2]=y;break}e=o[t+4>>2]|0;if((e&3|0)==1){a=e&-8;s=e>>>3;i:do{if(e>>>0<256){e=o[t+8>>2]|0;i=o[t+12>>2]|0;if((i|0)==(e|0)){o[5412]=o[5412]&~(1<<s);break}else{o[e+12>>2]=i;o[i+8>>2]=e;break}}else{n=o[t+24>>2]|0;e=o[t+12>>2]|0;do{if((e|0)==(t|0)){i=t+16|0;s=i+4|0;e=o[s>>2]|0;if(!e){e=o[i>>2]|0;if(!e){e=0;break}}else i=s;while(1){r=e+20|0;s=o[r>>2]|0;if(!s){r=e+16|0;s=o[r>>2]|0;if(!s)break;else{e=s;i=r}}else{e=s;i=r}}o[i>>2]=0}else{y=o[t+8>>2]|0;o[y+12>>2]=e;o[e+8>>2]=y}}while(0);if(!n)break;i=o[t+28>>2]|0;s=21952+(i<<2)|0;do{if((o[s>>2]|0)!=(t|0)){y=n+16|0;o[((o[y>>2]|0)==(t|0)?y:n+20|0)>>2]=e;if(!e)break i}else{o[s>>2]=e;if(e|0)break;o[5413]=o[5413]&~(1<<i);break i}}while(0);o[e+24>>2]=n;i=t+16|0;s=o[i>>2]|0;if(s|0){o[e+16>>2]=s;o[s+24>>2]=e}i=o[i+4>>2]|0;if(!i)break;o[e+20>>2]=i;o[i+24>>2]=e}}while(0);t=t+a|0;r=a+l|0}else r=l;t=t+4|0;o[t>>2]=o[t>>2]&-2;o[c+4>>2]=r|1;o[c+r>>2]=r;t=r>>>3;if(r>>>0<256){i=21688+(t<<1<<2)|0;e=o[5412]|0;t=1<<t;if(!(e&t)){o[5412]=e|t;t=i;e=i+8|0}else{e=i+8|0;t=o[e>>2]|0}o[e>>2]=c;o[t+12>>2]=c;o[c+8>>2]=t;o[c+12>>2]=i;break}t=r>>>8;do{if(!t)s=0;else{if(r>>>0>16777215){s=31;break}b=(t+1048320|0)>>>16&8;y=t<<b;v=(y+520192|0)>>>16&4;y=y<<v;s=(y+245760|0)>>>16&2;s=14-(v|b|s)+(y<<s>>>15)|0;s=r>>>(s+7|0)&1|s<<1}}while(0);t=21952+(s<<2)|0;o[c+28>>2]=s;e=c+16|0;o[e+4>>2]=0;o[e>>2]=0;e=o[5413]|0;i=1<<s;if(!(e&i)){o[5413]=e|i;o[t>>2]=c;o[c+24>>2]=t;o[c+12>>2]=c;o[c+8>>2]=c;break}t=o[t>>2]|0;i:do{if((o[t+4>>2]&-8|0)!=(r|0)){s=r<<((s|0)==31?0:25-(s>>>1)|0);while(1){i=t+16+(s>>>31<<2)|0;e=o[i>>2]|0;if(!e)break;if((o[e+4>>2]&-8|0)==(r|0)){t=e;break i}else{s=s<<1;t=e}}o[i>>2]=c;o[c+24>>2]=t;o[c+12>>2]=c;o[c+8>>2]=c;break t}}while(0);b=t+8|0;y=o[b>>2]|0;o[y+12>>2]=c;o[b>>2]=c;o[c+8>>2]=y;o[c+12>>2]=t;o[c+24>>2]=0}}while(0);y=h+8|0;J=w;return y|0}t=22096;while(1){e=o[t>>2]|0;if(e>>>0<=A>>>0?(y=e+(o[t+4>>2]|0)|0,y>>>0>A>>>0):0)break;t=o[t+8>>2]|0}r=y+-47|0;e=r+8|0;e=r+((e&7|0)==0?0:0-e&7)|0;r=A+16|0;e=e>>>0<r>>>0?A:e;t=e+8|0;i=a+-40|0;v=n+8|0;v=(v&7|0)==0?0:0-v&7;b=n+v|0;v=i-v|0;o[5418]=b;o[5415]=v;o[b+4>>2]=v|1;o[n+i+4>>2]=40;o[5419]=o[5534];i=e+4|0;o[i>>2]=27;o[t>>2]=o[5524];o[t+4>>2]=o[5525];o[t+8>>2]=o[5526];o[t+12>>2]=o[5527];o[5524]=n;o[5525]=a;o[5527]=0;o[5526]=t;t=e+24|0;do{b=t;t=t+4|0;o[t>>2]=7}while((b+8|0)>>>0<y>>>0);if((e|0)!=(A|0)){n=e-A|0;o[i>>2]=o[i>>2]&-2;o[A+4>>2]=n|1;o[e>>2]=n;t=n>>>3;if(n>>>0<256){i=21688+(t<<1<<2)|0;e=o[5412]|0;t=1<<t;if(!(e&t)){o[5412]=e|t;t=i;e=i+8|0}else{e=i+8|0;t=o[e>>2]|0}o[e>>2]=A;o[t+12>>2]=A;o[A+8>>2]=t;o[A+12>>2]=i;break}t=n>>>8;if(t)if(n>>>0>16777215)s=31;else{b=(t+1048320|0)>>>16&8;y=t<<b;v=(y+520192|0)>>>16&4;y=y<<v;s=(y+245760|0)>>>16&2;s=14-(v|b|s)+(y<<s>>>15)|0;s=n>>>(s+7|0)&1|s<<1}else s=0;i=21952+(s<<2)|0;o[A+28>>2]=s;o[A+20>>2]=0;o[r>>2]=0;t=o[5413]|0;e=1<<s;if(!(t&e)){o[5413]=t|e;o[i>>2]=A;o[A+24>>2]=i;o[A+12>>2]=A;o[A+8>>2]=A;break}t=o[i>>2]|0;t:do{if((o[t+4>>2]&-8|0)!=(n|0)){s=n<<((s|0)==31?0:25-(s>>>1)|0);while(1){i=t+16+(s>>>31<<2)|0;e=o[i>>2]|0;if(!e)break;if((o[e+4>>2]&-8|0)==(n|0)){t=e;break t}else{s=s<<1;t=e}}o[i>>2]=A;o[A+24>>2]=t;o[A+12>>2]=A;o[A+8>>2]=A;break e}}while(0);b=t+8|0;y=o[b>>2]|0;o[y+12>>2]=A;o[b>>2]=A;o[A+8>>2]=y;o[A+12>>2]=t;o[A+24>>2]=0}}else{y=o[5416]|0;if((y|0)==0|n>>>0<y>>>0)o[5416]=n;o[5524]=n;o[5525]=a;o[5527]=0;o[5421]=o[5530];o[5420]=-1;o[5425]=21688;o[5424]=21688;o[5427]=21696;o[5426]=21696;o[5429]=21704;o[5428]=21704;o[5431]=21712;o[5430]=21712;o[5433]=21720;o[5432]=21720;o[5435]=21728;o[5434]=21728;o[5437]=21736;o[5436]=21736;o[5439]=21744;o[5438]=21744;o[5441]=21752;o[5440]=21752;o[5443]=21760;o[5442]=21760;o[5445]=21768;o[5444]=21768;o[5447]=21776;o[5446]=21776;o[5449]=21784;o[5448]=21784;o[5451]=21792;o[5450]=21792;o[5453]=21800;o[5452]=21800;o[5455]=21808;o[5454]=21808;o[5457]=21816;o[5456]=21816;o[5459]=21824;o[5458]=21824;o[5461]=21832;o[5460]=21832;o[5463]=21840;o[5462]=21840;o[5465]=21848;o[5464]=21848;o[5467]=21856;o[5466]=21856;o[5469]=21864;o[5468]=21864;o[5471]=21872;o[5470]=21872;o[5473]=21880;o[5472]=21880;o[5475]=21888;o[5474]=21888;o[5477]=21896;o[5476]=21896;o[5479]=21904;o[5478]=21904;o[5481]=21912;o[5480]=21912;o[5483]=21920;o[5482]=21920;o[5485]=21928;o[5484]=21928;o[5487]=21936;o[5486]=21936;y=a+-40|0;v=n+8|0;v=(v&7|0)==0?0:0-v&7;b=n+v|0;v=y-v|0;o[5418]=b;o[5415]=v;o[b+4>>2]=v|1;o[n+y+4>>2]=40;o[5419]=o[5534]}}while(0);t=o[5415]|0;if(t>>>0>u>>>0){v=t-u|0;o[5415]=v;y=o[5418]|0;b=y+u|0;o[5418]=b;o[b+4>>2]=v|1;o[y+4>>2]=u|3;y=y+8|0;J=w;return y|0}}o[(zd()|0)>>2]=48;y=0;J=w;return y|0}function Zm(e){e=e|0;var t=0,i=0,s=0,r=0,n=0,a=0,l=0,A=0;if(!e)return;i=e+-8|0;r=o[5416]|0;e=o[e+-4>>2]|0;t=e&-8;A=i+t|0;do{if(!(e&1)){s=o[i>>2]|0;if(!(e&3))return;a=i+(0-s)|0;n=s+t|0;if(a>>>0<r>>>0)return;if((o[5417]|0)==(a|0)){e=A+4|0;t=o[e>>2]|0;if((t&3|0)!=3){l=a;t=n;break}o[5414]=n;o[e>>2]=t&-2;o[a+4>>2]=n|1;o[a+n>>2]=n;return}i=s>>>3;if(s>>>0<256){e=o[a+8>>2]|0;t=o[a+12>>2]|0;if((t|0)==(e|0)){o[5412]=o[5412]&~(1<<i);l=a;t=n;break}else{o[e+12>>2]=t;o[t+8>>2]=e;l=a;t=n;break}}r=o[a+24>>2]|0;e=o[a+12>>2]|0;do{if((e|0)==(a|0)){t=a+16|0;i=t+4|0;e=o[i>>2]|0;if(!e){e=o[t>>2]|0;if(!e){e=0;break}}else t=i;while(1){s=e+20|0;i=o[s>>2]|0;if(!i){s=e+16|0;i=o[s>>2]|0;if(!i)break;else{e=i;t=s}}else{e=i;t=s}}o[t>>2]=0}else{l=o[a+8>>2]|0;o[l+12>>2]=e;o[e+8>>2]=l}}while(0);if(r){t=o[a+28>>2]|0;i=21952+(t<<2)|0;if((o[i>>2]|0)==(a|0)){o[i>>2]=e;if(!e){o[5413]=o[5413]&~(1<<t);l=a;t=n;break}}else{l=r+16|0;o[((o[l>>2]|0)==(a|0)?l:r+20|0)>>2]=e;if(!e){l=a;t=n;break}}o[e+24>>2]=r;t=a+16|0;i=o[t>>2]|0;if(i|0){o[e+16>>2]=i;o[i+24>>2]=e}t=o[t+4>>2]|0;if(t){o[e+20>>2]=t;o[t+24>>2]=e;l=a;t=n}else{l=a;t=n}}else{l=a;t=n}}else{l=i;a=i}}while(0);if(a>>>0>=A>>>0)return;e=A+4|0;s=o[e>>2]|0;if(!(s&1))return;if(!(s&2)){if((o[5418]|0)==(A|0)){A=(o[5415]|0)+t|0;o[5415]=A;o[5418]=l;o[l+4>>2]=A|1;if((l|0)!=(o[5417]|0))return;o[5417]=0;o[5414]=0;return}if((o[5417]|0)==(A|0)){A=(o[5414]|0)+t|0;o[5414]=A;o[5417]=a;o[l+4>>2]=A|1;o[a+A>>2]=A;return}r=(s&-8)+t|0;i=s>>>3;do{if(s>>>0<256){t=o[A+8>>2]|0;e=o[A+12>>2]|0;if((e|0)==(t|0)){o[5412]=o[5412]&~(1<<i);break}else{o[t+12>>2]=e;o[e+8>>2]=t;break}}else{n=o[A+24>>2]|0;e=o[A+12>>2]|0;do{if((e|0)==(A|0)){t=A+16|0;i=t+4|0;e=o[i>>2]|0;if(!e){e=o[t>>2]|0;if(!e){i=0;break}}else t=i;while(1){s=e+20|0;i=o[s>>2]|0;if(!i){s=e+16|0;i=o[s>>2]|0;if(!i)break;else{e=i;t=s}}else{e=i;t=s}}o[t>>2]=0;i=e}else{i=o[A+8>>2]|0;o[i+12>>2]=e;o[e+8>>2]=i;i=e}}while(0);if(n|0){e=o[A+28>>2]|0;t=21952+(e<<2)|0;if((o[t>>2]|0)==(A|0)){o[t>>2]=i;if(!i){o[5413]=o[5413]&~(1<<e);break}}else{s=n+16|0;o[((o[s>>2]|0)==(A|0)?s:n+20|0)>>2]=i;if(!i)break}o[i+24>>2]=n;e=A+16|0;t=o[e>>2]|0;if(t|0){o[i+16>>2]=t;o[t+24>>2]=i}e=o[e+4>>2]|0;if(e|0){o[i+20>>2]=e;o[e+24>>2]=i}}}}while(0);o[l+4>>2]=r|1;o[a+r>>2]=r;if((l|0)==(o[5417]|0)){o[5414]=r;return}}else{o[e>>2]=s&-2;o[l+4>>2]=t|1;o[a+t>>2]=t;r=t}e=r>>>3;if(r>>>0<256){i=21688+(e<<1<<2)|0;t=o[5412]|0;e=1<<e;if(!(t&e)){o[5412]=t|e;e=i;t=i+8|0}else{t=i+8|0;e=o[t>>2]|0}o[t>>2]=l;o[e+12>>2]=l;o[l+8>>2]=e;o[l+12>>2]=i;return}e=r>>>8;if(e)if(r>>>0>16777215)s=31;else{a=(e+1048320|0)>>>16&8;A=e<<a;n=(A+520192|0)>>>16&4;A=A<<n;s=(A+245760|0)>>>16&2;s=14-(n|a|s)+(A<<s>>>15)|0;s=r>>>(s+7|0)&1|s<<1}else s=0;e=21952+(s<<2)|0;o[l+28>>2]=s;o[l+20>>2]=0;o[l+16>>2]=0;t=o[5413]|0;i=1<<s;e:do{if(!(t&i)){o[5413]=t|i;o[e>>2]=l;o[l+24>>2]=e;o[l+12>>2]=l;o[l+8>>2]=l}else{e=o[e>>2]|0;t:do{if((o[e+4>>2]&-8|0)!=(r|0)){s=r<<((s|0)==31?0:25-(s>>>1)|0);while(1){i=e+16+(s>>>31<<2)|0;t=o[i>>2]|0;if(!t)break;if((o[t+4>>2]&-8|0)==(r|0)){e=t;break t}else{s=s<<1;e=t}}o[i>>2]=l;o[l+24>>2]=e;o[l+12>>2]=l;o[l+8>>2]=l;break e}}while(0);a=e+8|0;A=o[a>>2]|0;o[A+12>>2]=l;o[a>>2]=l;o[l+8>>2]=A;o[l+12>>2]=e;o[l+24>>2]=0}}while(0);A=(o[5420]|0)+-1|0;o[5420]=A;if(A|0)return;e=22104;while(1){e=o[e>>2]|0;if(!e)break;else e=e+8|0}o[5420]=-1;return}function Jm(e){e=e|0;var t=0,i=0,s=0;s=e+3&-4;e=Ag()|0;t=o[e>>2]|0;i=t+s|0;do{if((s|0)<1|i>>>0>t>>>0){if(i>>>0>(W()|0)>>>0?(K(i|0)|0)==0:0)break;o[e>>2]=i;s=t;return s|0}}while(0);o[(zd()|0)>>2]=48;s=-1;return s|0}function Ym(e){e=e|0;var t=0;t=J;J=J+e|0;J=J+15&-16;return t|0}function qm(e){e=e|0;J=e}function $m(){return J|0}function eg(e,t){e=e|0;t=t|0;var i=0,s=0,r=0,o=0;o=e&65535;r=t&65535;i=v(r,o)|0;s=e>>>16;e=(i>>>16)+(v(r,s)|0)|0;r=t>>>16;t=v(r,o)|0;return(w((e>>>16)+(v(r,s)|0)+(((e&65535)+t|0)>>>16)|0),e+t<<16|i&65535|0)|0}function tg(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;var r=0,o=0;r=e;o=i;i=eg(r,o)|0;e=B()|0;return(w((v(t,o)|0)+(v(s,r)|0)+e|e&0|0),i|0|0)|0}function ig(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;i=e+i>>>0;return(w(t+s+(i>>>0<e>>>0|0)>>>0|0),i|0)|0}function sg(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;s=t-s-(i>>>0>e>>>0|0)>>>0;return(w(s|0),e-i>>>0|0)|0}function rg(e){e=e|0;return(e?31-(b(e^e-1)|0)|0:32)|0}function og(e,t,i,s,r){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;var n=0,a=0,l=0,A=0,c=0,h=0,u=0,d=0,p=0,f=0;h=e;A=t;c=A;a=i;d=s;l=d;if(!c){n=(r|0)!=0;if(!l){if(n){o[r>>2]=(h>>>0)%(a>>>0);o[r+4>>2]=0}d=0;r=(h>>>0)/(a>>>0)>>>0;return(w(d|0),r)|0}else{if(!n){d=0;r=0;return(w(d|0),r)|0}o[r>>2]=e|0;o[r+4>>2]=t&0;d=0;r=0;return(w(d|0),r)|0}}n=(l|0)==0;do{if(a){if(!n){n=(b(l|0)|0)-(b(c|0)|0)|0;if(n>>>0<=31){u=n+1|0;l=31-n|0;t=n-31>>31;a=u;e=h>>>(u>>>0)&t|c<<l;t=c>>>(u>>>0)&t;n=0;l=h<<l;break}if(!r){d=0;r=0;return(w(d|0),r)|0}o[r>>2]=e|0;o[r+4>>2]=A|t&0;d=0;r=0;return(w(d|0),r)|0}n=a-1|0;if(n&a|0){l=(b(a|0)|0)+33-(b(c|0)|0)|0;f=64-l|0;u=32-l|0;A=u>>31;p=l-32|0;t=p>>31;a=l;e=u-1>>31&c>>>(p>>>0)|(c<<u|h>>>(l>>>0))&t;t=t&c>>>(l>>>0);n=h<<f&A;l=(c<<f|h>>>(p>>>0))&A|h<<u&l-33>>31;break}if(r|0){o[r>>2]=n&h;o[r+4>>2]=0}if((a|0)==1){p=A|t&0;f=e|0|0;return(w(p|0),f)|0}else{f=rg(a|0)|0;p=c>>>(f>>>0)|0;f=c<<32-f|h>>>(f>>>0)|0;return(w(p|0),f)|0}}else{if(n){if(r|0){o[r>>2]=(c>>>0)%(a>>>0);o[r+4>>2]=0}p=0;f=(c>>>0)/(a>>>0)>>>0;return(w(p|0),f)|0}if(!h){if(r|0){o[r>>2]=0;o[r+4>>2]=(c>>>0)%(l>>>0)}p=0;f=(c>>>0)/(l>>>0)>>>0;return(w(p|0),f)|0}n=l-1|0;if(!(n&l)){if(r|0){o[r>>2]=e|0;o[r+4>>2]=n&c|t&0}p=0;f=c>>>((rg(l|0)|0)>>>0);return(w(p|0),f)|0}n=(b(l|0)|0)-(b(c|0)|0)|0;if(n>>>0<=30){t=n+1|0;l=31-n|0;a=t;e=c<<l|h>>>(t>>>0);t=c>>>(t>>>0);n=0;l=h<<l;break}if(!r){p=0;f=0;return(w(p|0),f)|0}o[r>>2]=e|0;o[r+4>>2]=A|t&0;p=0;f=0;return(w(p|0),f)|0}}while(0);if(!a){c=l;A=0;l=0}else{u=i|0|0;h=d|s&0;c=ig(u|0,h|0,-1,-1)|0;i=B()|0;A=l;l=0;do{s=A;A=n>>>31|A<<1;n=l|n<<1;s=e<<1|s>>>31|0;d=e>>>31|t<<1|0;sg(c|0,i|0,s|0,d|0)|0;f=B()|0;p=f>>31|((f|0)<0?-1:0)<<1;l=p&1;e=sg(s|0,d|0,p&u|0,(((f|0)<0?-1:0)>>31|((f|0)<0?-1:0)<<1)&h|0)|0;t=B()|0;a=a-1|0}while((a|0)!=0);c=A;A=0}a=0;if(r|0){o[r>>2]=e;o[r+4>>2]=t}p=(n|0)>>>31|(c|a)<<1|(a<<1|n>>>31)&0|A;f=(n<<1|0>>>31)&-2|l;return(w(p|0),f)|0}function ng(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;return og(e,t,i,s,0)|0}function ag(e,t,i){e=e|0;t=t|0;i=i|0;if((i|0)<32){w(t>>>i|0);return e>>>i|(t&(1<<i)-1)<<32-i}w(0);return t>>>i-32|0}function lg(e,t,i){e=e|0;t=t|0;i=i|0;if((i|0)<32){w(t<<i|(e&(1<<i)-1<<32-i)>>>32-i|0);return e<<i}w(e<<i-32|0);return 0}function Ag(){return 22176}function cg(e){e=e|0;return(e&255)<<24|(e>>8&255)<<16|(e>>16&255)<<8|e>>>24|0}function hg(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0;if((i|0)>=512){X(e|0,t|0,i|0)|0;return e|0}a=e|0;n=e+i|0;if((e&3)==(t&3)){while(e&3){if(!i)return a|0;s[e>>0]=s[t>>0]|0;e=e+1|0;t=t+1|0;i=i-1|0}i=n&-4|0;r=i-64|0;while((e|0)<=(r|0)){o[e>>2]=o[t>>2];o[e+4>>2]=o[t+4>>2];o[e+8>>2]=o[t+8>>2];o[e+12>>2]=o[t+12>>2];o[e+16>>2]=o[t+16>>2];o[e+20>>2]=o[t+20>>2];o[e+24>>2]=o[t+24>>2];o[e+28>>2]=o[t+28>>2];o[e+32>>2]=o[t+32>>2];o[e+36>>2]=o[t+36>>2];o[e+40>>2]=o[t+40>>2];o[e+44>>2]=o[t+44>>2];o[e+48>>2]=o[t+48>>2];o[e+52>>2]=o[t+52>>2];o[e+56>>2]=o[t+56>>2];o[e+60>>2]=o[t+60>>2];e=e+64|0;t=t+64|0}while((e|0)<(i|0)){o[e>>2]=o[t>>2];e=e+4|0;t=t+4|0}}else{i=n-4|0;while((e|0)<(i|0)){s[e>>0]=s[t>>0]|0;s[e+1>>0]=s[t+1>>0]|0;s[e+2>>0]=s[t+2>>0]|0;s[e+3>>0]=s[t+3>>0]|0;e=e+4|0;t=t+4|0}}while((e|0)<(n|0)){s[e>>0]=s[t>>0]|0;e=e+1|0;t=t+1|0}return a|0}function ug(e,t,i){e=e|0;t=t|0;i=i|0;var r=0;if((t|0)<(e|0)&(e|0)<(t+i|0)){r=e;t=t+i|0;e=e+i|0;while((i|0)>0){e=e-1|0;t=t-1|0;i=i-1|0;s[e>>0]=s[t>>0]|0}e=r}else hg(e,t,i)|0;return e|0}function dg(e,t,i){e=e|0;t=t|0;i=i|0;var r=0,n=0,a=0,l=0;a=e+i|0;t=t&255;if((i|0)>=67){while(e&3){s[e>>0]=t;e=e+1|0}r=a&-4|0;l=t|t<<8|t<<16|t<<24;n=r-64|0;while((e|0)<=(n|0)){o[e>>2]=l;o[e+4>>2]=l;o[e+8>>2]=l;o[e+12>>2]=l;o[e+16>>2]=l;o[e+20>>2]=l;o[e+24>>2]=l;o[e+28>>2]=l;o[e+32>>2]=l;o[e+36>>2]=l;o[e+40>>2]=l;o[e+44>>2]=l;o[e+48>>2]=l;o[e+52>>2]=l;o[e+56>>2]=l;o[e+60>>2]=l;e=e+64|0}while((e|0)<(r|0)){o[e>>2]=l;e=e+4|0}}while((e|0)<(a|0)){s[e>>0]=t;e=e+1|0}return a-i|0}function pg(e){e=e|0;return Og[e&3]()|0}function fg(e,t){e=e|0;t=t|0;return Ng[e&15](t|0)|0}function mg(e,t,i,s,r,o,n){e=e|0;t=t|0;i=+i;s=s|0;r=r|0;o=o|0;n=n|0;return Vg[e&1](t|0,+i,s|0,r|0,o|0,n|0)|0}function gg(e,t,i){e=e|0;t=t|0;i=i|0;return Qg[e&63](t|0,i|0)|0}function _g(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;return Hg[e&7](t|0,i|0,s|0)|0}function vg(e){e=e|0;jg[e&3]()}function bg(e,t){e=e|0;t=t|0;Gg[e&255](t|0)}function yg(e,t,i){e=e|0;t=t|0;i=i|0;zg[e&15](t|0,i|0)}function wg(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;Wg[e&15](t|0,i|0,s|0)}function Bg(e,t,i,s,r){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;Xg[e&7](t|0,i|0,s|0,r|0)}function Pg(e,t,i,s,r,o){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;o=o|0;Kg[e&3](t|0,i|0,s|0,r|0,o|0)}function xg(e,t,i,s,r,o,n){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;o=o|0;n=n|0;Zg[e&3](t|0,i|0,s|0,r|0,o|0,n|0)}function Cg(){y(0);return 0}function Mg(e){e=e|0;y(1);return 0}function Eg(e,t,i,s,r,o){e=e|0;t=+t;i=i|0;s=s|0;r=r|0;o=o|0;y(2);return 0}function Fg(e,t){e=e|0;t=t|0;y(3);return 0}function Ig(e,t,i){e=e|0;t=t|0;i=i|0;y(4);return 0}function Tg(){y(5)}function Dg(e){e=e|0;y(6)}function Sg(e,t){e=e|0;t=t|0;y(7)}function Rg(e,t,i){e=e|0;t=t|0;i=i|0;y(8)}function Ug(e,t,i,s){e=e|0;t=t|0;i=i|0;s=s|0;y(9)}function Lg(e,t,i,s,r){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;y(10)}function kg(e,t,i,s,r,o){e=e|0;t=t|0;i=i|0;s=s|0;r=r|0;o=o|0;y(11)}var Og=[Cg,Ic,Bh,Cg];var Ng=[Mg,gf,mt,wt,af,cf,om,Mm,Lm,pc,re,hh,Dc,xh,Mg,Mg];var Vg=[Eg,op];var Qg=[Fg,_e,Me,yt,es,Is,Vs,er,tr,rr,jr,Jr,fo,wo,To,Oo,xn,Rn,jn,Kn,sa,la,ga,wa,Ta,Ga,Ya,il,cl,vl,Ll,jl,Yl,nA,mA,BA,SA,HA,JA,sc,hc,sh,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg,Fg];var Hg=[Ig,Pp,Vp,wf,Pf,Fm,Im,Ig];var jg=[Tg,bf,Tp,Tg];var Gg=[Dg,nm,me,ge,ve,xe,Ce,Ee,ff,ot,Bt,ft,_t,vt,Et,Ft,Vt,Qt,Ai,ci,hi,Ii,qi,$i,ts,Cs,Ts,Ds,Ss,Rs,Os,Ns,Qs,qs,$s,ir,sr,Qr,Hr,Gr,Kr,Zr,uo,po,mo,bo,yo,Fo,Io,Do,Lo,ko,Bn,Pn,Cn,Un,Ln,Qn,Hn,Gn,Zn,Jn,ta,ia,ra,Aa,ca,fa,ma,_a,Ba,Pa,Fa,Ia,Da,Ha,ja,za,Za,Ja,qa,sl,rl,ll,Al,hl,gl,_l,Rl,Ul,kl,Ql,Hl,Zl,Jl,ql,rA,oA,pA,fA,gA,yA,wA,TA,DA,RA,VA,QA,KA,ZA,YA,tc,ic,Ac,cc,uc,Lp,kp,Op,Np,Zp,of,nf,lf,Af,mf,_f,vf,yf,Bf,Ef,sm,rm,xm,Cm,Um,Qm,Hm,gc,ph,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg,Dg];var zg=[Sg,gt,bt,se,ne,ae,le,Ae,np,Sg,Sg,Sg,Sg,Sg,Sg,Sg];var Wg=[Rg,Em,Tm,km,Om,ie,oe,Zc,Nh,zh,Rg,Rg,Rg,Rg,Rg,Rg];var Xg=[Ug,jp,qp,Tf,Nc,Dh,Ug,Ug];var Kg=[Lg,Hp,Yp,If];var Zg=[kg,Qp,Jp,Ff];return{__ZSt18uncaught_exceptionv:tm,___cxa_can_catch:qf,___cxa_is_pointer_type:$f,___embind_register_native_and_builtin_types:eu,___errno_location:zd,___getTypeName:Gd,___muldi3:tg,___udivdi3:ng,_bitshift64Lshr:ag,_bitshift64Shl:lg,_emscripten_get_sbrk_ptr:Ag,_free:Zm,_i64Add:ig,_i64Subtract:sg,_llvm_bswap_i32:cg,_malloc:Km,_memcpy:hg,_memmove:ug,_memset:dg,dynCall_i:pg,dynCall_ii:fg,dynCall_iidiiii:mg,dynCall_iii:gg,dynCall_iiii:_g,dynCall_v:vg,dynCall_vi:bg,dynCall_vii:yg,dynCall_viii:wg,dynCall_viiii:Bg,dynCall_viiiii:Pg,dynCall_viiiiii:xg,globalCtors:$,stackAlloc:Ym,stackRestore:qm,stackSave:$m}}({Math:Math,Int8Array:Int8Array,Int16Array:Int16Array,Int32Array:Int32Array,Uint8Array:Uint8Array,Uint16Array:Uint16Array,Float32Array:Float32Array,Float64Array:Float64Array},ut,b),pt=t.__ZSt18uncaught_exceptionv=dt.__ZSt18uncaught_exceptionv;t.___cxa_can_catch=dt.___cxa_can_catch,t.___cxa_is_pointer_type=dt.___cxa_is_pointer_type,t.___embind_register_native_and_builtin_types=dt.___embind_register_native_and_builtin_types,t.___errno_location=dt.___errno_location;var ft=t.___getTypeName=dt.___getTypeName;t.___muldi3=dt.___muldi3,t.___udivdi3=dt.___udivdi3,t._bitshift64Lshr=dt._bitshift64Lshr,t._bitshift64Shl=dt._bitshift64Shl,t._emscripten_get_sbrk_ptr=dt._emscripten_get_sbrk_ptr;var mt=t._free=dt._free;t._i64Add=dt._i64Add,t._i64Subtract=dt._i64Subtract,t._llvm_bswap_i32=dt._llvm_bswap_i32;var gt=t._malloc=dt._malloc;t._memcpy=dt._memcpy,t._memmove=dt._memmove,t._memset=dt._memset;var _t,vt,bt=t.globalCtors=dt.globalCtors;if(t.stackAlloc=dt.stackAlloc,t.stackRestore=dt.stackRestore,t.stackSave=dt.stackSave,t.dynCall_i=dt.dynCall_i,t.dynCall_ii=dt.dynCall_ii,t.dynCall_iidiiii=dt.dynCall_iidiiii,t.dynCall_iii=dt.dynCall_iii,t.dynCall_iiii=dt.dynCall_iiii,t.dynCall_v=dt.dynCall_v,t.dynCall_vi=dt.dynCall_vi,t.dynCall_vii=dt.dynCall_vii,t.dynCall_viii=dt.dynCall_viii,t.dynCall_viiii=dt.dynCall_viiii,t.dynCall_viiiii=dt.dynCall_viiiii,t.dynCall_viiiiii=dt.dynCall_viiiiii,t.asm=dt,W)if(K(W)||(_t=W,W=t.locateFile?t.locateFile(_t,u):u+_t),o||n){var yt=A(W);w.set(yt,8)}else{j++,t.monitorRunDependencies&&t.monitorRunDependencies(j);var wt=function(e){e.byteLength&&(e=new Uint8Array(e)),w.set(e,8),t.memoryInitializerRequest&&delete t.memoryInitializerRequest.response,function(e){if(j--,t.monitorRunDependencies&&t.monitorRunDependencies(j),0==j&&G){var i=G;G=null,i()}}()},Bt=function(){l(W,wt,(function(){throw new Error("could not load memory initializer "+W)}))},Pt=ht(W);if(Pt)wt(Pt.buffer);else if(t.memoryInitializerRequest){var xt=function(){var e=t.memoryInitializerRequest,i=e.response;if(200!==e.status&&0!==e.status){var s=ht(t.memoryInitializerRequestURL);if(!s)return console.warn("a problem seems to have happened with Module.memoryInitializerRequest, status: "+e.status+", retrying "+W),void Bt();i=s.buffer}wt(i)};t.memoryInitializerRequest.response?setTimeout(xt,0):t.memoryInitializerRequest.addEventListener("load",xt)}else Bt()}function Ct(e){this.name="ExitStatus",this.message="Program terminated with exit("+e+")",this.status=e}function Mt(e){function i(){vt||(vt=!0,t.calledRun=!0,m||(O(V),O(Q),t.onRuntimeInitialized&&t.onRuntimeInitialized(),function(){if(t.postRun)for("function"==typeof t.postRun&&(t.postRun=[t.postRun]);t.postRun.length;)e=t.postRun.shift(),H.unshift(e);var e;O(H)}()))}j>0||(!function(){if(t.preRun)for("function"==typeof t.preRun&&(t.preRun=[t.preRun]);t.preRun.length;)e=t.preRun.shift(),N.unshift(e);var e;O(N)}(),j>0||(t.setStatus?(t.setStatus("Running..."),setTimeout((function(){setTimeout((function(){t.setStatus("")}),1),i()}),1)):i()))}if(G=function e(){vt||Mt(),vt||(G=e)},t.run=Mt,t.preInit)for("function"==typeof t.preInit&&(t.preInit=[t.preInit]);t.preInit.length>0;)t.preInit.pop()();return Mt(),t}let tI=null;const iI={0:e=>({position:[e.getInt32(0,!0),e.getInt32(4,!0),e.getInt32(8,!0)],intensity:e.getUint16(12,!0),classification:e.getUint8(15)}),1:e=>({position:[e.getInt32(0,!0),e.getInt32(4,!0),e.getInt32(8,!0)],intensity:e.getUint16(12,!0),classification:e.getUint8(15)}),2:e=>({position:[e.getInt32(0,!0),e.getInt32(4,!0),e.getInt32(8,!0)],intensity:e.getUint16(12,!0),classification:e.getUint8(15),color:[e.getUint16(20,!0),e.getUint16(22,!0),e.getUint16(24,!0)]}),3:e=>({position:[e.getInt32(0,!0),e.getInt32(4,!0),e.getInt32(8,!0)],intensity:e.getUint16(12,!0),classification:e.getUint8(15),color:[e.getUint16(28,!0),e.getUint16(30,!0),e.getUint16(32,!0)]})};function sI(e,t={},i,s){s=void 0===s||0===s?1:s;const r=new t(e.slice(i,i+t.BYTES_PER_ELEMENT*s));if(1===s)return r[0];const o=[];for(let e=0;e<s;e++)o.push(r[e]);return o}function rI(e){let t=131;const i={pointsOffset:sI(e,Uint32Array,96),pointsFormatId:sI(e,Uint8Array,104),pointsStructSize:sI(e,Uint16Array,105),pointsCount:sI(e,Uint32Array,107),scale:sI(e,Float64Array,t,3)};t+=24,i.offset=sI(e,Float64Array,t,3),t+=24;const s=sI(e,Float64Array,t,6);return t+=48,i.maxs=[s[0],s[2],s[4]],i.mins=[s[1],s[3],s[5]],i}class oI{arraybuffer;readOffset=0;header={pointsOffset:0,pointsFormatId:0,pointsStructSize:0,pointsCount:0,scale:[0,0,0],offset:[0,0,0],maxs:[0],mins:[0],totalToRead:0,totalRead:0,versionAsString:"",isCompressed:!0};constructor(e){this.arraybuffer=e}open(){return!0}getHeader(){return this.header=rI(this.arraybuffer),this.header}readData(e,t){const{header:i,arraybuffer:s}=this;if(!i)throw new Error("Cannot start reading data till a header request is issued");let r,{readOffset:o}=this;if(t<=1){e=Math.min(e,i.pointsCount-o),r=i.pointsOffset+o*i.pointsStructSize;const t=r+e*i.pointsStructSize;return o+=e,this.readOffset=o,{buffer:s.slice(r,t),count:e,hasMoreData:o<i.pointsCount}}const n=Math.min(e*t,i.pointsCount-o),a=Math.ceil(n/t);let l=0;const A=new Uint8Array(a*i.pointsStructSize);for(let e=0;e<n;e++){if(e%t==0){r=i.pointsOffset+o*i.pointsStructSize;const e=new Uint8Array(s,r,i.pointsStructSize);A.set(e,l*i.pointsStructSize),l++}o++}return this.readOffset=o,{buffer:A.buffer,count:l,hasMoreData:o<i.pointsCount}}close(){return this.arraybuffer=null,!0}}class nI{arraybuffer;instance=null;header=null;constructor(e){this.arraybuffer=e,tI||(tI=eI())}open(){try{const{arraybuffer:e}=this;this.instance=new tI.LASZip;const t=new Uint8Array(e),i=tI._malloc(e.byteLength);return this.instance.arraybuffer=e,this.instance.buf=i,tI.HEAPU8.set(t,i),this.instance.open(i,e.byteLength),this.instance.readOffset=0,!0}catch(e){throw new Error(`Failed to open file: ${e.message}`)}}getHeader(){if(!this.instance)throw new Error("You need to open the file before trying to read header");try{const e=rI(this.instance.arraybuffer);return e.pointsFormatId&=63,this.header=e,e}catch(e){throw new Error(`Failed to get header: ${e.message}`)}}readData(e,t,i){if(!this.instance)throw new Error("You need to open the file before trying to read stuff");const{header:s,instance:r}=this;if(!s)throw new Error("You need to query header before reading, I maintain state that way, sorry :(");try{const t=Math.min(e*i,s.pointsCount-r.readOffset),o=Math.ceil(t/i);let n=0;const a=new Uint8Array(o*s.pointsStructSize),l=tI._malloc(s.pointsStructSize);for(let e=0;e<t;e++){if(r.getPoint(l),e%i==0){const e=new Uint8Array(tI.HEAPU8.buffer,l,s.pointsStructSize);a.set(e,n*s.pointsStructSize),n++}r.readOffset++}return tI._free(l),{buffer:a.buffer,count:n,hasMoreData:r.readOffset<s.pointsCount}}catch(e){throw new Error(`Failed to read data: ${e.message}`)}}close(){try{return null!==this.instance&&(tI._free(this.instance.buf),this.instance.delete(),this.instance=null),!0}catch(e){throw new Error(`Failed to close file: ${e.message}`)}}}class aI{arrayb;decoder;pointsCount;pointSize;scale;offset;mins;maxs;constructor(e,t,i){this.arrayb=e,this.decoder=iI[i.pointsFormatId],this.pointsCount=t,this.pointSize=i.pointsStructSize,this.scale=i.scale,this.offset=i.offset,this.mins=i.mins,this.maxs=i.maxs}getPoint(e){if(e<0||e>=this.pointsCount)throw new Error("Point index out of range");const t=new DataView(this.arrayb,e*this.pointSize,this.pointSize);return this.decoder(t)}}class lI{arraybuffer;formatId=0;loader;isCompressed=!0;isOpen=!1;version=0;versionAsString="";constructor(e){if(this.arraybuffer=e,this.determineVersion()>13)throw new Error("Only file versions <= 1.3 are supported at this time");if(this.determineFormat(),void 0===iI[this.formatId])throw new Error("The point format ID is not supported");this.loader=this.isCompressed?new nI(this.arraybuffer):new oI(this.arraybuffer)}determineFormat(){const e=sI(this.arraybuffer,Uint8Array,104),t=(128&e)>>7,i=(64&e)>>6;if(1===t&&1===i)throw new Error("Old style compression not supported");this.formatId=63&e,this.isCompressed=1===t||1===i}determineVersion(){const e=new Int8Array(this.arraybuffer,24,2);return this.version=10*e[0]+e[1],this.versionAsString=`${e[0]}.${e[1]}`,this.version}open(){this.loader.open()&&(this.isOpen=!0)}getHeader(){return this.loader.getHeader()}readData(e,t,i){return this.loader.readData(e,t,i)}close(){this.loader.close()&&(this.isOpen=!1)}getUnpacker(){return aI}}function AI(e,t){const i=function(e){const t={};t.las_pointsOffset=e.pointsOffset.toString(10),t.las_pointsFormatId=e.pointsFormatId.toString(10),t.las_pointsStructSize=e.pointsStructSize.toString(10),t.las_pointsCount=e.pointsCount.toString(10),t.las_scale=JSON.stringify(e.scale),t.las_offset=JSON.stringify(e.offset),void 0!==e.maxs&&(t.las_maxs=JSON.stringify(e.maxs));void 0!==e.mins&&(t.las_mins=JSON.stringify(e.mins));t.las_totalToRead=e.totalToRead.toString(10),t.las_pointsFortotalReadmatId=e.totalRead.toString(10),void 0!==e.versionAsString&&(t.las_versionAsString=e.versionAsString);void 0!==e.isCompressed&&(t.las_isCompressed=e.isCompressed.toString());return t}(e);return sP(t,i)}function cI(e,t){return function(e,t={}){let i,s,r,o,n,a=0;const l={loader:"las",loaderData:{},schema:{fields:[],metadata:{}},header:{vertexCount:0,boundingBox:[[0,0,0],[0,0,0]]},attributes:{},topology:"point-list",mode:0};(function(e,t,i={}){const s=new lI(e);try{s.open();const e=s.getHeader(),r=s.getUnpacker(),o=Math.ceil(e.pointsCount/Math.max(1,t));e.totalToRead=o;let n=0;for(;;){const a=s.readData(1e5,0,t);n+=a.count,e.totalRead=n,e.versionAsString=a.versionAsString,e.isCompressed=a.isCompressed;if(i(new r(a.buffer,a.count,e),e),!a.hasMoreData||n>=o)break}}catch(e){throw e}finally{s.close()}})(e,t.las?.skip,((e={},A)=>{if(!n){n=A;const e=A.totalToRead,a=t.las?.fp64?Float64Array:Float32Array;i=new a(3*e),s=A.pointsFormatId>=2?new Uint8Array(4*e):null,r=new Uint16Array(e),o=new Uint8Array(e),l.loaderData=A,l.attributes={POSITION:{value:i,size:3},intensity:{value:r,size:1},classification:{value:o,size:1}},s&&(l.attributes.COLOR_0={value:s,size:4})}const c=e.pointsCount,{scale:[h,u,d],offset:[p,f,m]}=A,g=function(e={},t,i){let s=!1;switch(i){case 8:s=!1;break;case 16:s=!0;break;case"auto":if(e.getPoint(0).color)for(let i=0;i<t;i++){const{color:t}=e.getPoint(i);(t[0]>255||t[1]>255||t[2]>255)&&(s=!0)}break;default:console.warn("las: illegal value for options.las.colorDepth")}return s}(e,c,t.las?.colorDepth);for(let t=0;t<c;t++){const{position:n,color:l,intensity:A,classification:c}=e.getPoint(t);i[3*a]=n[0]*h+p,i[3*a+1]=n[1]*u+f,i[3*a+2]=n[2]*d+m,l&&s&&(g?(s[4*a]=l[0]/256,s[4*a+1]=l[1]/256,s[4*a+2]=l[2]/256):(s[4*a]=l[0],s[4*a+1]=l[1],s[4*a+2]=l[2]),s[4*a+3]=255),r[a]=A,o[a]=c,a++}const _={...l,header:{vertexCount:A.totalRead},progress:A.totalRead/A.totalToRead};t?.onProgress?.(_)})),l.header={vertexCount:n.totalToRead,boundingBox:iP(l?.attributes||{})},l&&(l.schema=AI(l.loaderData,l.attributes));return l}(e,t)}const hI={...$F,parse:async(e,t)=>cI(e,t),parseSync:(e,t)=>cI(e,t)},uI=[{item:"FileSignature",format:"char",size:4},{item:"FileSoureceID",format:"uShort",size:2},{item:"GlobalEncoding",format:"uShort",size:2},{item:"ProjectID1",format:"notUsed",size:4},{item:"ProjectID2",format:"notUsed",size:2},{item:"ProjectID3",format:"notUsed",size:2},{item:"ProjectID4",format:"notUsed",size:8},{item:"VersionMajor",format:"uChar",size:1},{item:"VersionMinor",format:"uChar",size:1},{item:"SystemIdentifier",format:"char",size:32},{item:"GeneratingSoftware",format:"char",size:32},{item:"CreationDay",format:"uShort",size:2},{item:"CreationYear",format:"uShort",size:2},{item:"HeaderSize",format:"uShort",size:2},{item:"OffsetToPointData",format:"uLong",size:4},{item:"NumberOfVariableLengthRecords",format:"uLong",size:4},{item:"PointDataFormatID",format:"uChar",size:1},{item:"PointDataRecordLength",format:"uShort",size:2},{item:"NumberOfPoints",format:"uLong",size:4},{item:"NumberOfPointByReturn",format:"uLong",size:20},{item:"ScaleFactorX",format:"double",size:8},{item:"ScaleFactorY",format:"double",size:8},{item:"ScaleFactorZ",format:"double",size:8},{item:"OffsetX",format:"double",size:8},{item:"OffsetY",format:"double",size:8},{item:"OffsetZ",format:"double",size:8},{item:"MaxX",format:"double",size:8},{item:"MinX",format:"double",size:8},{item:"MaxY",format:"double",size:8},{item:"MinY",format:"double",size:8},{item:"MaxZ",format:"double",size:8},{item:"MinZ",format:"double",size:8}],dI=[{item:"Reserved",format:"uShort",size:2},{item:"UserId",format:"char",size:16},{item:"RecordId",format:"uShort",size:2},{item:"RecordLengthAfterHeader",format:"uShort",size:2},{item:"Description",format:"char",size:32}],pI=e=>{let t=0,i=0,s=0;const r=new DataView(e),o=new Uint8Array(6e3),n=({item:s,format:o,size:n})=>{let a,l;switch(o){case"char":return l=new Uint8Array(e,t,n),t+=n,a=mI(l),[s,a];case"uShort":return a=r.getUint16(t,!0),t+=n,[s,a];case"uLong":return a=r.getUint32(t,!0),"NumberOfVariableLengthRecords"===s&&(i=a),t+=n,[s,a];case"uChar":return a=r.getUint8(t),t+=n,[s,a];case"double":return a=r.getFloat64(t,!0),t+=n,[s,a];default:t+=n}};return(()=>{const e={};uI.forEach((t=>{const i=n({...t});if(void 0!==i){if("FileSignature"===i[0]&&"LASF"!==i[1])throw new Error("Ivalid FileSignature. Is this a LAS/LAZ file");e[i[0]]=i[1]}}));const r=[];let a=i;for(;a--;){const e={};dI.forEach((i=>{const r=n({...i});e[r[0]]=r[1],"UserId"===r[0]&&"LASF_Projection"===r[1]&&(s=t-18+54)})),r.push(e)}const l=(e=>{if(void 0===e)return;const t=s+e.RecordLengthAfterHeader,i=o.slice(s,t),r=fI(i),n=new DataView(r);let a=6,l=Number(n.getUint16(a,!0));const A=[];for(;l--;){const e={};e.key=n.getUint16(a+=2,!0),e.tiffTagLocation=n.getUint16(a+=2,!0),e.count=n.getUint16(a+=2,!0),e.valueOffset=n.getUint16(a+=2,!0),A.push(e)}const c=A.find((e=>3072===e.key));if(c&&c.hasOwnProperty("valueOffset"))return c.valueOffset})(r.find((e=>"LASF_Projection"===e.UserId)));return l&&(e.epsg=l),e})()},fI=e=>{let t=new ArrayBuffer(e.length),i=new Uint8Array(t);for(let t=0;t<e.length;++t)i[t]=e[t];return t},mI=e=>{let t="";return e.forEach((e=>{let i=String.fromCharCode(e);"\0"!==i&&(t+=i)})),t.trim()};class gI extends ph{constructor(e,t={}){super("lasLoader",e,t),this.dataSource=t.dataSource,this.skip=t.skip,this.fp64=t.fp64,this.colorDepth=t.colorDepth,this.center=t.center,this.rotate=t.rotate,this.rotateX=t.rotateX,this.transform=t.transform}get dataSource(){return this._dataSource}set dataSource(e){this._dataSource=e||new qF}get skip(){return this._skip}set skip(e){this._skip=e||1}get fp64(){return this._fp64}set fp64(e){this._fp64=!!e}get colorDepth(){return this._colorDepth}set colorDepth(e){this._colorDepth=e||"auto"}get center(){return this._center}set center(e){this._center=!!e}get transform(){return this._transform}set transform(e){this._transform=e}get rotate(){return this._rotate}set rotate(e){this._rotate=e}get rotateX(){return this._rotateX}set rotateX(e){this._rotateX=e}load(e={}){e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);const t=new Tc(this.viewer.scene,y.apply(e,{maxGeometryBatchSize:5e5,isModel:!0}));if(!(e.src||e.las||e.manifest||e.manifestSrc))return this.error("load() param expected: src or las"),t;const i={las:{skip:this._skip,fp64:this._fp64,colorDepth:this._colorDepth}},s=this.viewer.scene.canvas.spinner,r=()=>{t.scene.once("tick",(()=>{t.destroyed||(t.scene.fire("modelLoaded",t.id),t.fire("loaded",!0,!1))})),s.processes--},o=e=>{s.processes--,this.error(e),t.fire("error",e)};if(e.src)this._loadModel(e.src,e,i,t);else if(e.las)s.processes++,this._parseModel(e.las,e,i,t).then(r,o);else if(e.manifest||e.manifestSrc){const s=e.manifestSrc?function(e){e.indexOf("?")>-1&&(e=e.split("?")[0]);const t=e.split("/");return t.pop(),t.join("/")+"/"}(e.manifestSrc):"",n=n=>{let a=0;const l=new Array(n.length),A=()=>{if(t.destroyed)r();else{if(a>=n.length)return;l[a]=!1,this._dataSource.getLAS(`${s}${n[a]}`,(s=>{const o=y.apply(e,{isManifest:!0,index:a});this._parseModel(s,o,i,t).then((()=>{l[o.index]=!0;let e=!0;l.forEach((t=>{t||(e=!1)})),e&&r()})),a++,this.scheduleTask(A,200)}),o)}};A()},a=e=>{if(t.destroyed)return;const i=e.lasFiles||e.lazFiles;!i||i.length<=0?this.error("load(): Failed to load model manifest - manifest not valid"):n(i)};if(e.manifestSrc)this._dataSource.getManifest(e.manifestSrc,(e=>{a(e)}),(e=>{this.error(e),t.fire("error",e)}));else{const t=e.manifest;a(t)}}return t}_loadModel(e,t,i,s){const r=this.viewer.scene.canvas.spinner;r.processes++,this._dataSource.getLAS(t.src,(e=>{this._parseModel(e,t,i,s).then((()=>{s.scene.once("tick",(()=>{s.destroyed||(s.scene.fire("modelLoaded",s.id),s.fire("loaded",!0,!1))})),r.processes--}),(e=>{r.processes--,this.error(e),s.fire("error",e)}))}),(e=>{r.processes--,this.error(e),s.fire("error",e)}))}_parseModel(e,t,i,s){const r=e=>{const t=e.value;if(this._center){const e=d.vec3(),i=t.length;for(let i=0,s=t.length;i<s;i+=3)e[0]+=t[i+0],e[1]+=t[i+1],e[2]+=t[i+2];e[0]/=i,e[1]/=i,e[2]/=i;for(let i=0,s=t.length;i<s;i+=3)t[i+0]-=e[0],t[i+1]-=e[1],t[i+2]-=e[2]}if(this._rotateX&&t)for(let e=0,i=t.length;e<i;e+=3){const i=t[e+1];t[e+1]=t[e+2],t[e+2]=i}if(this._rotate){const e=d.identityQuaternion(),i=d.mat4();d.eulerToQuaternion(this._rotate,"XYZ",e),d.quaternionToRotationMat4(e,i);const s=d.vec3();for(let e=0,r=t.length;e<r;e+=3)s[0]=t[e+0],s[1]=t[e+1],s[2]=t[e+2],d.transformPoint3(i,s,s),t[e+0]=s[0],t[e+1]=s[1],t[e+2]=s[2]}if(this._transform){const e=d.mat4(this._transform),i=d.vec3();for(let s=0,r=t.length;s<r;s+=3)i[0]=t[s+0],i[1]=t[s+1],i[2]=t[s+2],d.transformPoint3(e,i,i),t[s+0]=i[0],t[s+1]=i[1],t[s+2]=i[2]}return t};function o(e,t){const i=e.value,s=e.size,r=t.value,o=4*r.length,n=new Uint8Array(o);for(let e=0,t=0,o=0,a=r.length;e<a;e++,o+=s,t+=4)n[t+0]=i[o+0],n[t+1]=i[o+1],n[t+2]=i[o+2],n[t+3]=Math.round(r[e]/65536*255);return n}function n(e){const t=e.value,i=4*t.length,s=new Uint8Array(i);for(let e=0,i=0,r=t.length;e<r;e++,i+=4)s[i+0]=0,s[i+1]=0,s[i+2]=0,s[i+3]=Math.round(t[e]/65536*255);return s}return new Promise(((a,l)=>{if(s.destroyed)return void l();const A=t.stats||{};A.sourceFormat="LAS",A.schemaVersion="",A.title="",A.author="",A.created="",A.numMetaObjects=0,A.numPropertySets=0,A.numObjects=0,A.numGeometries=0,A.numTriangles=0,A.numVertices=0;try{const A=pI(e);tP(e,hI,i).then((e=>{const c=e.attributes,h=e.loaderData,u=void 0!==h.pointsFormatId?h.pointsFormatId:-1;if(!c.POSITION)return s.finalize(),void l("No positions found in file");let p,f;switch(u){case 0:p=r(c.POSITION),f=n(c.intensity);break;case 1:if(!c.intensity)return s.finalize(),void l("No positions found in file");p=r(c.POSITION),f=n(c.intensity);break;case 2:case 3:if(!c.intensity)return s.finalize(),void l("No positions found in file");p=r(c.POSITION),f=o(c.COLOR_0,c.intensity)}const m=_I(p,15e5),g=_I(f,2e6),_=[];for(let e=0,i=m.length;e<i;e++){const i=`${t.isManifest?"model"+t.index:""}pointsMesh${e}`;_.push(i),s.createMesh({id:i,primitive:"points",positions:m[e],colorsCompressed:e<g.length?g[e]:null})}const v=t.entityId||d.createUUID();if(s.createEntity({id:v,meshIds:_,isObject:!0}),s.finalize(),t.metaModelJSON){const e=s.id;this.viewer.metaScene.createMetaModel(e,t.metaModelJSON,i)}else if(!1!==t.loadMetadata){const e=d.createUUID(),t={projectId:"",author:"",createdAt:"",schema:"",creatingApplication:"",metaObjects:[{id:e,name:"Model",type:"Model"},{id:v,name:"PointCloud (LAS)",type:"PointCloud",parent:e,attributes:A||{}}],propertySets:[]},r=s.id;this.viewer.metaScene.createMetaModel(r,t,i)}a()}))}catch(e){s.finalize(),l(e)}}))}}function _I(e,t){if(t>=e.length)return[e];let i=[];for(let s=0;s<e.length;s+=t)i.push(e.slice(s,s+t));return i}class vI{constructor(e={}){this.cacheBuster=!1!==e.cacheBuster}_cacheBusterURL(e){if(!this.cacheBuster)return e;const t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}getCityJSON(e,t,i){y.loadJSON(this._cacheBusterURL(e),(e=>{t(e)}),(function(e){i(e)}))}}const bI=d.vec2(),yI=d.vec3(),wI=d.vec3(),BI=d.vec3();class PI extends ph{constructor(e,t={}){super("cityJSONLoader",e,t),this.dataSource=t.dataSource}get dataSource(){return this._dataSource}set dataSource(e){this._dataSource=e||new vI}load(e={}){e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);const t=new Tc(this.viewer.scene,y.apply(e,{isModel:!0,edges:!0}));if(!e.src&&!e.cityJSON)return this.error("load() param expected: src or cityJSON"),t;const i={};if(e.src)this._loadModel(e.src,e,i,t);else{const s=this.viewer.scene.canvas.spinner;s.processes++,this._parseModel(e.cityJSON,e,i,t),s.processes--}return t}_loadModel(e,t,i,s){const r=this.viewer.scene.canvas.spinner;r.processes++,this._dataSource.getCityJSON(t.src,(e=>{this._parseModel(e,t,i,s),r.processes--}),(e=>{r.processes--,this.error(e),s.fire("error",e)}))}_parseModel(e,t,i,s){if(s.destroyed)return;const r=e.transform?this._transformVertices(e.vertices,e.transform,i.rotateX):e.vertices,o=t.stats||{};o.sourceFormat=e.type||"CityJSON",o.schemaVersion=e.version||"",o.title="",o.author="",o.created="",o.numMetaObjects=0,o.numPropertySets=0,o.numObjects=0,o.numGeometries=0,o.numTriangles=0,o.numVertices=0;const n=!1!==t.loadMetadata,a=n?{id:d.createUUID(),name:"Model",type:"Model"}:null,l=n?{id:"",projectId:"",author:"",createdAt:"",schema:e.version||"",creatingApplication:"",metaObjects:[a],propertySets:[]}:null,A={data:e,vertices:r,sceneModel:s,loadMetadata:n,metadata:l,rootMetaObject:a,nextId:0,stats:o};if(this._parseCityJSON(A),s.finalize(),n){const e=s.id;this.viewer.metaScene.createMetaModel(e,A.metadata,i)}s.scene.once("tick",(()=>{s.destroyed||(s.scene.fire("modelLoaded",s.id),s.fire("loaded",!0,!1))}))}_transformVertices(e,t,i){const s=[],r=t.scale||d.vec3([1,1,1]),o=t.translate||d.vec3([0,0,0]);for(let t=0,n=0;t<e.length;t++,n+=3){const n=e[t][0]*r[0]+o[0],a=e[t][1]*r[1]+o[1],l=e[t][2]*r[2]+o[2];i?s.push([n,l,a]):s.push([n,a,l])}return s}_parseCityJSON(e){const t=e.data.CityObjects;for(const i in t)if(t.hasOwnProperty(i)){const s=t[i];this._parseCityObject(e,s,i)}}_parseCityObject(e,t,i){const s=e.sceneModel,r=e.data;if(e.loadMetadata){const s=i,r=t.type,o=r+" : "+i,n=t.parents?t.parents[0]:e.rootMetaObject.id;e.metadata.metaObjects.push({id:s,name:o,type:r,parent:n})}if(e.stats.numMetaObjects++,!(t.geometry&&t.geometry.length>0))return;const o=[];for(let i=0,s=t.geometry.length;i<s;i++){const s=t.geometry[i];let n,a;const l=r.appearance;if(l){const e=l.materials;if(e){const t=s.material;if(t){const s=Object.keys(t);if(s.length>0){const r=t[s[0]];if(void 0!==r.value)n=e[r.value];else{const t=r.values;if(t){a=[];for(let s=0,r=t.length;s<r;s++){const s=e[t[i]];a.push(s)}}}}}}}a?this._parseGeometrySurfacesWithOwnMaterials(e,s,a,o):this._parseGeometrySurfacesWithSharedMaterial(e,s,n,o)}o.length>0&&(s.createEntity({id:i,meshIds:o,isObject:!0}),e.stats.numObjects++)}_parseGeometrySurfacesWithOwnMaterials(e,t,i,s){switch(t.type){case"MultiPoint":case"MultiLineString":break;case"MultiSurface":case"CompositeSurface":const r=t.boundaries;this._parseSurfacesWithOwnMaterials(e,i,r,s);break;case"Solid":const o=t.boundaries;for(let t=0;t<o.length;t++){const r=o[t];this._parseSurfacesWithOwnMaterials(e,i,r,s)}break;case"MultiSolid":case"CompositeSolid":const n=t.boundaries;for(let t=0;t<n.length;t++)for(let r=0;r<n[t].length;r++){const o=n[t][r];this._parseSurfacesWithOwnMaterials(e,i,o,s)}}}_parseSurfacesWithOwnMaterials(e,t,i,s){const r=e.vertices,o=e.sceneModel;for(let n=0;n<i.length;n++){const a=i[n],l=t[n]||{diffuseColor:[.8,.8,.8],transparency:1},A=[],c=[],h=[],u={positions:[],indices:[]};for(let t=0;t<a.length;t++){A.length>0&&c.push(A.length);const i=this._extractLocalIndices(e,a[t],h,u);A.push(...i)}if(3===A.length)u.indices.push(A[0]),u.indices.push(A[1]),u.indices.push(A[2]);else if(A.length>3){const e=[];for(let t=0;t<A.length;t++)e.push({x:r[h[A[t]]][0],y:r[h[A[t]]][1],z:r[h[A[t]]][2]});const t=this._getNormalOfPositions(e,d.vec3());let i=[];for(let s=0;s<e.length;s++)this._to2D(e[s],t,bI),i.unshift(bI[0]),i.unshift(bI[1]);const s=hu(i,c,2);for(let e=0;e<s.length;e+=3)u.indices.unshift(A[s[e]]),u.indices.unshift(A[s[e+1]]),u.indices.unshift(A[s[e+2]])}const p=""+e.nextId++;o.createMesh({id:p,primitive:"triangles",positions:u.positions,indices:u.indices,color:l&&l.diffuseColor?l.diffuseColor:[.8,.8,.8],opacity:l&&void 0!==l.transparency?1-l.transparency:1}),s.push(p),e.stats.numGeometries++,e.stats.numVertices+=u.positions.length/3,e.stats.numTriangles+=u.indices.length/3}}_parseGeometrySurfacesWithSharedMaterial(e,t,i,s){const r=e.sceneModel,o=[],n={positions:[],indices:[]};switch(t.type){case"MultiPoint":case"MultiLineString":break;case"MultiSurface":case"CompositeSurface":const i=t.boundaries;this._parseSurfacesWithSharedMaterial(e,i,o,n);break;case"Solid":const s=t.boundaries;for(let t=0;t<s.length;t++){const i=s[t];this._parseSurfacesWithSharedMaterial(e,i,o,n)}break;case"MultiSolid":case"CompositeSolid":const r=t.boundaries;for(let t=0;t<r.length;t++)for(let i=0;i<r[t].length;i++){const s=r[t][i];this._parseSurfacesWithSharedMaterial(e,s,o,n)}}if(n.positions.length>0&&n.indices.length>0){const t=""+e.nextId++;r.createMesh({id:t,primitive:"triangles",positions:n.positions,indices:n.indices,color:i&&i.diffuseColor?i.diffuseColor:[.8,.8,.8],opacity:1}),s.push(t),e.stats.numGeometries++,e.stats.numVertices+=n.positions.length/3,e.stats.numTriangles+=n.indices.length/3}}_parseSurfacesWithSharedMaterial(e,t,i,s){const r=e.vertices;for(let o=0;o<t.length;o++){let n=[],a=[];for(let r=0;r<t[o].length;r++){n.length>0&&a.push(n.length);const l=this._extractLocalIndices(e,t[o][r],i,s);n.push(...l)}if(3===n.length)s.indices.push(n[0]),s.indices.push(n[1]),s.indices.push(n[2]);else if(n.length>3){let e=[];for(let t=0;t<n.length;t++)e.push({x:r[i[n[t]]][0],y:r[i[n[t]]][1],z:r[i[n[t]]][2]});const t=this._getNormalOfPositions(e,d.vec3());let o=[];for(let i=0;i<e.length;i++)this._to2D(e[i],t,bI),o.unshift(bI[0]),o.unshift(bI[1]);const l=hu(o,a,2);for(let e=0;e<l.length;e+=3)s.indices.unshift(n[l[e]]),s.indices.unshift(n[l[e+1]]),s.indices.unshift(n[l[e+2]])}}}_extractLocalIndices(e,t,i,s){const r=e.vertices,o=[];for(let e=0,n=t.length;e<n;e++){const n=t[e];if(i.includes(n)){const e=i.indexOf(n);o.push(e)}else s.positions.push(r[n][0]),s.positions.push(r[n][1]),s.positions.push(r[n][2]),o.push(i.length),i.push(n)}return o}_getNormalOfPositions(e,t){for(let i=0;i<e.length;i++){let s=i+1;s===e.length&&(s=0),t[0]+=(e[i].y-e[s].y)*(e[i].z+e[s].z),t[1]+=(e[i].z-e[s].z)*(e[i].x+e[s].x),t[2]+=(e[i].x-e[s].x)*(e[i].y+e[s].y)}return d.normalizeVec3(t)}_to2D(e,t,i){const s=yI,r=wI,o=BI;s[0]=e.x,s[1]=e.y,s[2]=e.z,r[0]=t.x,r[1]=t.y,r[2]=t.z,o[0]=1.1,o[1]=1.1,o[2]=1.1;d.lenVec3(d.subVec3(o,r))<.01&&(o[0]+=1,o[1]+=2,o[2]+=3);const n=d.dotVec3(o,r),a=d.mulVec3Scalar(r,n,d.vec3());o[0]-=a[0],o[1]-=a[1],o[2]-=a[2],d.normalizeVec3(o);const l=d.cross3Vec3(r,o,d.vec3()),A=d.dotVec3(s,o),c=d.dotVec3(s,l);i[0]=A,i[1]=c}}class xI{constructor(e={}){this.cacheBuster=!1!==e.cacheBuster}_cacheBusterURL(e){if(!this.cacheBuster)return e;const t=(new Date).getTime();return e.indexOf("?")>-1?e+"&_="+t:e+"?_="+t}getDotBIM(e,t,i){y.loadJSON(this._cacheBusterURL(e),(e=>{t(e)}),(function(e){i(e)}))}}class CI extends ph{constructor(e,t={}){super("DotBIMLoader",e,t),this.dataSource=t.dataSource,this.objectDefaults=t.objectDefaults}set dataSource(e){this._dataSource=e||new xI}get dataSource(){return this._dataSource}set objectDefaults(e){this._objectDefaults=e||CM}get objectDefaults(){return this._objectDefaults}load(e={}){e.id&&this.viewer.scene.components[e.id]&&(this.error("Component with this ID already exists in viewer: "+e.id+" - will autogenerate this ID"),delete e.id);const t=new Tc(this.viewer.scene,y.apply(e,{isModel:!0,backfaces:e.backfaces,dtxEnabled:e.dtxEnabled,rotation:e.rotation,origin:e.origin})),i=t.id;if(!e.src&&!e.dotBIM)return this.error("load() param expected: src or dotBIM"),t;const s=e.objectDefaults||this._objectDefaults||CM;let r,o;if(e.includeTypes){r={};for(let t=0,i=e.includeTypes.length;t<i;t++)r[e.includeTypes[t]]=!0}if(e.excludeTypes){o={},r||(r={});for(let t=0,i=e.excludeTypes.length;t<i;t++)r[e.excludeTypes[t]]=!0}const n=e=>{const t=e.fileData,n=e.sceneModel,a={},l=d.createUUID(),A=d.createUUID(),c=d.createUUID(),h=d.createUUID(),u={metaObjects:[{id:l,name:"Project",type:"Project",parent:null},{id:A,name:"Site",type:"Site",parent:l},{id:c,name:"Building",type:"Building",parent:A},{id:h,name:"BuildingStorey",type:"BuildingStorey",parent:c}],propertySets:[]},p=(e,i)=>{if(a[e])return;const s=t.meshes.find((e=>e.mesh_id===i.mesh_id));n.createGeometry({id:e,primitive:"triangles",positions:s.coordinates,indices:s.indices}),a[e]=!0},f=t.elements;for(let e=0,i=f.length;e<i;e++){const i=f[e],a=i.type;if(o&&o[a])continue;if(r&&!r[a])continue;const l=i.info,A=void 0!==i.guid?`${i.guid}`:void 0!==l&&void 0!==l.id?l.id:e,c=i.mesh_id,d=i.vector,m=i.rotation,g=s?s[a]||s.DEFAULT:null;let _=!0,v=!0;if(void 0===i.face_colors){p(c,i);const e=`${A}-mesh`;let t=i.color?[i.color.r/255,i.color.g/255,i.color.b/255]:[1,1,1],s=i.color?i.color.a/255:1;g&&(!1===g.visible&&(_=!1),!1===g.pickable&&(v=!1),g.colorize&&(t=g.colorize),void 0!==g.opacity&&null!==g.opacity&&(s=g.opacity)),n.createMesh({id:e,geometryId:c,color:t,opacity:s,quaternion:!m||0===m.qz&&0===m.qy&&0===m.qx&&1===m.qw?void 0:[m.qx,m.qy,m.qz,m.qw],position:d?[d.x,d.y,d.z]:void 0}),n.createEntity({id:A,meshIds:[e],visible:_,pickable:v,isObject:!0})}else{let e=i.face_colors,s={},r=0,o=t.meshes.find((e=>e.mesh_id===i.mesh_id));for(let t=0,i=e.length;t<i;t+=4){let i=[e[t],e[t+1],e[t+2],e[t+3]];void 0===s[i]&&(s[i]=[]);let n=o.indices[r],a=o.coordinates[3*n],l=o.coordinates[3*n+1],A=o.coordinates[3*n+2],c=o.indices[r+1],h=o.coordinates[3*c],u=o.coordinates[3*c+1],d=o.coordinates[3*c+2],p=o.indices[r+2],f=o.coordinates[3*p],m=o.coordinates[3*p+1],g=o.coordinates[3*p+2];s[i].push(a,l,A,h,u,d,f,m,g),r+=3}let a=[];for(const[e,t]of Object.entries(s)){n.createGeometry({id:`${c}-${e}`,primitive:"triangles",positions:t,indices:[...Array(t.length/3).keys()]});const i=`${A}-mesh-${e}`,s=e.split(",").map(Number);let r=[s[0]/255,s[1]/255,s[2]/255],o=s[3]/255;g&&(!1===g.visible&&(_=!1),!1===g.pickable&&(v=!1),g.colorize&&(r=g.colorize),void 0!==g.opacity&&null!==g.opacity&&(o=g.opacity)),n.createMesh({id:i,geometryId:`${c}-${e}`,color:r,opacity:o,quaternion:!m||0===m.qz&&0===m.qy&&0===m.qx&&1===m.qw?void 0:[m.qx,m.qy,m.qz,m.qw],position:d?[d.x,d.y,d.z]:void 0}),a.push(i)}n.createEntity({id:A,meshIds:a,visible:_,pickable:v,isObject:!0})}let b=[];for(let e in l)b.push({name:e,value:l[e]});u.propertySets.push({id:A,name:"Properties",properties:b}),u.metaObjects.push({id:A,name:l&&l.Name&&"None"!==l.Name?l.Name:`${i.type} ${A}`,type:i.type,parent:h,propertySetIds:[A]})}n.finalize(),this.viewer.metaScene.createMetaModel(i,u),n.scene.once("tick",(()=>{n.destroyed||(n.scene.fire("modelLoaded",n.id),n.fire("loaded",!0,!1))}))};if(e.src){const i=e.src;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getDotBIM(i,(e=>{n({fileData:e,sceneModel:t,nextId:0,error:function(e){}}),this.viewer.scene.canvas.spinner.processes--}),(e=>{this.viewer.scene.canvas.spinner.processes--,this.error(e)}))}else if(e.dotBIM){const i={fileData:e.dotBIM,sceneModel:t,nextId:0,error:function(e){}};n(i)}return t.once("destroyed",(()=>{this.viewer.metaScene.destroyMetaModel(i)})),t}destroy(){super.destroy()}}const MI=function(e){const t=t=>parseInt(e.substr(t+1,2),16)/255;return[t(0),t(2),t(4)]},EI=function(e,t,i){let s=null;const r=r=>{if(r){s&&s.destroy();try{const[o,n]=hy(r.map((e=>[e[0],e[2]]))),a=[].concat(...o.map((e=>[e[0],r[0][1],e[1]]))),l=[].concat(...n);s=new fs(e,{pickable:!1,geometry:new ve(e,{positions:a,indices:l,normals:d.buildNormals(a,l)}),material:new bs(e,{alpha:void 0!==i?i:.5,backfaces:!0,diffuse:MI(t)})})}catch(e){s=null}}s&&(s.visible=!!r)};return r(null),{updateBase:r,destroy:()=>s&&s.destroy()}},FI=function(e,t){return function(i,s,r){const o=e.scene,n=o.canvas.canvas,a=(e,t)=>(t[0]=e.clientX,t[1]=e.clientY,$b(n.ownerDocument.documentElement,n,t),t),l=e=>{const i=d.vec3(),s=d.vec3();return d.canvasPosToWorldRay(n,o.camera.viewMatrix,o.camera.projMatrix,o.camera.projection,e,i,s),t(i,s)};let A=!1;const c=function(){A=!1},h=function(){c(),n.removeEventListener("mousedown",p),n.removeEventListener("mousemove",f),e.cameraControl.off(m),n.removeEventListener("mouseup",g)},u=d.vec2(),p=function(e){1===e.which&&(a(e,u),A=!0)};n.addEventListener("mousedown",p);const f=function(e){const t=a(e,d.vec2());A&&d.distVec2(u,t)>20&&(c(),i())};n.addEventListener("mousemove",f);const m=e.cameraControl.on("rayMove",(e=>{const t=e.canvasPos;s(t,l(t))})),g=function(e){if(1===e.which&&A){h();const t=a(e,d.vec2());r(t,l(t))}};return n.addEventListener("mouseup",g),h}},II=function(e,t,i,s){const r=-(d.dotVec3(i,t)-e)/d.dotVec3(s,t);{const e=d.vec3();return d.mulVec3Scalar(s,r,e),d.addVec3(i,e,e),e}};class TI extends R{constructor(e,t={}){if(super(e.viewer.scene,t),this.plugin=e,this._container=t.container,!this._container)throw"config missing: container";this._eventSubs={},this.plugin.viewer.scene,this._geometry=t.geometry,t.onMouseOver,t.onMouseLeave,t.onContextMenu,this._alpha="alpha"in t&&void 0!==t.alpha?t.alpha:.5,this.color=t.color,this._visible=!0,this._rebuildMesh()}_rebuildMesh(){const e=this.plugin.viewer.scene,t=this._geometry.planeCoordinates.slice(),i=this._geometry.height<0,s=this._geometry.altitude+(i?this._geometry.height:0),r=this._geometry.height*(i?-1:1),[o,n,a]=hy(t),l=[],A=[],c=e=>{const t=l.length;for(let t of o)l.push([t[0],s+(e?r:0),t[1]]);for(let i of n)A.push(...(e?i:i.slice(0).reverse()).map((e=>e+t)))};c(!1),c(!0);for(let e=0;e<o.length;++e){const t=o[e],i=o[(o.length+e+(a?1:-1))%o.length],n=s,c=s+r,h=l.length;l.push([t[0],n,t[1]],[i[0],n,i[1]],[i[0],c,i[1]],[t[0],c,t[1]]),A.push(...[0,1,2,0,2,3].map((e=>e+h)))}this._zoneMesh&&this._zoneMesh.destroy();const h=e=>Math.min(...l.map((t=>t[e]))),u=e=>Math.max(...l.map((t=>t[e]))),p=h(0),f=h(1),m=h(2),g=u(0),_=u(1),v=u(2);this._center=d.vec3([(p+g)/2,(f+_)/2,(m+v)/2]);const b=[].concat(...l.map((e=>d.subVec3(e,this._center,e))));this._zoneMesh=new fs(e,{origin:this._center,edges:this._edges,geometry:new ve(e,{positions:b,indices:A,normals:d.buildNormals(b,A)}),material:new bs(e,{alpha:this._alpha,backfaces:!0,diffuse:MI(this._color)}),visible:this._visible}),this._zoneMesh.highlighted=this._highlighted,this._zoneMesh.zone=this;{const e=d.vec2(),t=d.vec2();let i=0;for(let s of n){const r=o[s[0]],n=o[s[1]],a=o[s[2]];d.subVec2(n,r,e),d.subVec2(a,r,t),i+=Math.abs(e[0]*t[1]-e[1]*t[0])}this._baseArea=i/2}this._metrics=null}get baseArea(){return this._baseArea}get area(){return this._getMetrics().area}get volume(){return this._getMetrics().volume}_getMetrics(){if(null===this._metrics){let e=0,t=0;const i=this._zoneMesh.geometry,s=[d.vec3(),d.vec3(),d.vec3()],r=d.vec3();for(let o=0;o<i.indices.length;o+=3){for(let e=0;e<3;++e){const t=s[e],r=3*i.indices[o+e];for(let e=0;e<3;++e)t[e]=i.positions[r+e]}e+=d.dotVec3(s[0],d.cross3Vec3(s[1],s[2],r)),d.subVec3(s[1],s[0],s[1]),d.subVec3(s[2],s[0],s[2]),t+=d.lenVec3(d.cross3Vec3(s[1],s[2],r))}this._metrics={area:t/2,volume:e/6}}return this._metrics}sectionedAverage(e){const t=this._geometry.planeCoordinates.slice();let i=[];{const e=this._geometry.height,s=this._geometry.altitude,r=s+Math.max(0,e),o=s+Math.min(0,e),n=e=>{const s=t.map((t=>[t[0],e?r:o,t[1]]));i.push(e?s:s.slice(0).reverse())};n(!0),n(!1);const a=(e,i)=>[t[e][0],i,t[e][1]];for(let e=0;e<t.length;++e){const s=(e+1)%t.length;i.push([a(e,o),a(s,o),a(s,r),a(e,r)])}}for(const t of e){const e=t.dir,r=t.dist,o=[];for(const t of i){const i=1e-5,n=0,a=1,l=2,A=3;let c=0;const h=[];for(let s=0;s<t.length;s++){const o=d.dotVec3(e,t[s])+r,A=o<-i?l:o>i?a:n;c|=A,h.push(A)}switch(c){case n:case a:o.push(t);break;case l:break;case A:const i=[];for(let o=0;o<t.length;o++){var s=(o+1)%t.length;const n=h[o],a=h[s],c=t[o],u=t[s];if(n!==l&&i.push(c),(n|a)===A){const t=d.vec3();d.subVec3(u,c,t);const s=-(r+d.dotVec3(e,c))/d.dotVec3(e,t),o=[0,0,0];d.lerpVec3(s,0,1,c,u,o),i.push(o)}}i.length>=3&&o.push(i)}}i=o}if(0===i.length)return null;{const e=d.vec3([0,0,0]),t=new Set;for(const s of i)for(const i of s){const s=i.map((e=>e.toFixed(3))).join(":");t.has(s)||(t.add(s),d.addVec3(e,i,e))}return d.mulVec3Scalar(e,1/t.size,e),e}}get center(){return this._center}get altitude(){return this._geometry.altitude}set altitude(e){this._geometry.altitude=e,this._rebuildMesh()}get height(){return this._geometry.height}set height(e){this._geometry.height=e,this._rebuildMesh()}get highlighted(){return this._highlighted}set highlighted(e){this._highlighted=e,this._zoneMesh&&(this._zoneMesh.highlighted=e)}set color(e){this._color=e,this._zoneMesh&&(this._zoneMesh.material.diffuse=MI(this._color))}get color(){return this._color}set alpha(e){this._alpha=e,this._zoneMesh&&(this._zoneMesh.material.alpha=this._alpha)}get alpha(){return this._alpha}get edges(){return this._edges}set edges(e){this._edges=e,this._zoneMesh&&(this._zoneMesh.edges=this._edges)}set visible(e){this._visible=!!e,this._zoneMesh.visible=this._visible,this._needUpdate()}get visible(){return this._visible}getJSON(){return{id:this.id,geometry:this._geometry,alpha:this._alpha,color:this._color}}duplicate(){return this.plugin.createZone({id:d.createUUID(),geometry:{planeCoordinates:this._geometry.planeCoordinates.map((e=>e.slice())),altitude:this._geometry.altitude,height:this._geometry.height},alpha:this._alpha,color:this._color})}destroy(){this._zoneMesh.destroy(),super.destroy()}}class DI extends R{constructor(e,t,i){super(e.viewer.scene),this.zonesPlugin=e,this.pointerLens=t.pointerLens,this.createSelect3dPoint=i,this._deactivate=null}get active(){return!!this._deactivate}activate(e,t,i,s){if(this._deactivate)return;if("object"==typeof e&&null!==e){const r=e,o=(e,t)=>{if(e in r)return r[e];if(void 0!==t)return t;throw"config missing: "+e};e=o("altitude"),t=o("height"),i=o("color","#008000"),s=o("alpha",.5)}const r=this.zonesPlugin,o=r.viewer,n=o.scene,a=this,l=this.createSelect3dPoint(o,((t,i)=>II(e,d.vec3([0,1,0]),t,i)));!function o(){const A=EI(n,i,s),c=function(e,t,i,s,r,o){const n=ny(e,t),a=ny(e,t),l=i?function(e){i.visible=!!e,e&&(i.canvasPos=e)}:()=>{};let A=s((()=>{l(null),n.update(null)}),((e,t)=>{l(e),n.update(t)}),(function(e,t){n.update(t),A=s((function(){l(null),a.update(null),r(null)}),(function(e,i){l(e),a.update(i),r(d.distVec3(t,i)>.01&&[t,i])}),(function(e,i){a.update(i),n.destroy(),a.destroy(),l(null),o([t,i])}))}));return{deactivate:function(){A(),n.destroy(),a.destroy(),l(null)}}}(n,i,a.pointerLens,l,(e=>{if(e){const t=e[0],i=e[1],s=e=>Math.min(t[e],i[e]),r=e=>Math.max(t[e],i[e]),o=s(0),n=s(1),a=s(2),l=r(0);r(1);const c=r(2);A.updateBase([[o,n,c],[l,n,c],[l,n,a],[o,n,a]])}else A.updateBase(null)}),(n=>{A.destroy();const l=function(e,t,i,s,r,o,n){const a=i=>Math.min(e[i],t[i]),l=i=>Math.max(e[i],t[i]),A=a(0),c=a(2),h=l(0),u=l(2);return n.createZone({id:d.createUUID(),geometry:{planeCoordinates:[[A,u],[h,u],[h,c],[A,c]],altitude:i,height:s},alpha:o,color:r})}(n[0],n[1],e,t,i,s,r);let c=!0;a._deactivate=()=>{c=!1},a.fire("zoneEnd",l),c&&o()})).deactivate;a._deactivate=()=>{c(),A.destroy()}}()}deactivate(){this._deactivate&&(this._deactivate(),this._deactivate=null)}destroy(){this.deactivate(),super.destroy()}}class SI extends DI{constructor(e,t={}){super(e,t,((e,t)=>FI(e,t)))}}class RI extends DI{constructor(e,t={}){const i=new G(e.viewer);super(e,t,((e,t)=>cy(e,i,t))),this.pointerCircle=i}destroy(){this.pointerCircle.destroy(),super.destroy()}}class UI extends ph{constructor(e,t={}){super("Zones",e),this._pointerLens=t.pointerLens,this._container=t.container||document.body,this._zones=[],this.defaultColor=void 0!==t.defaultColor?t.defaultColor:"#00BBFF",this.zIndex=t.zIndex||1e4,this._onMouseOver=(e,t)=>{this.fire("mouseOver",{plugin:this,zone:t,event:e})},this._onMouseLeave=(e,t)=>{this.fire("mouseLeave",{plugin:this,zone:t,event:e})},this._onContextMenu=(e,t)=>{this.fire("contextMenu",{plugin:this,zone:t,event:e})}}createZone(e={}){this.viewer.scene.components[e.id]&&(this.error("Viewer scene component with this ID already exists: "+e.id),delete e.id);const t=new TI(this,{id:e.id,plugin:this,container:this._container,geometry:e.geometry,alpha:e.alpha,color:e.color,onMouseOver:this._onMouseOver,onMouseLeave:this._onMouseLeave,onContextMenu:this._onContextMenu});return this._zones.push(t),t.on("destroyed",(()=>{const e=this._zones.indexOf(t);e>=0&&this._zones.splice(e,1)})),this.fire("zoneCreated",t),t}get zones(){return this._zones}destroy(){super.destroy()}}const LI=function(e,t,i,s,r,o,n,a,l){const A=o?function(e){o.visible=!!e,e&&(o.canvasPos=e)}:()=>{};let c;const h=[()=>A(null)],u=EI(e,s,r);return h.push((()=>u.destroy())),function o(p){const f=ny(e,s),m=p.length>0&&ay(e,s),g=m&&p[p.length-1].getWorldPos();h.push((()=>{f.destroy(),m&&m.destroy()}));const _=p.length>0&&p[0],v=function(e){const t=_&&_.getCanvasPos();return t&&d.distVec2(t,e)<10&&{canvasPos:t,worldPos:_.getWorldPos()}},b=function(){const e=(e,t,i)=>t[0]<=Math.max(e[0],i[0])&&t[0]>=Math.min(e[0],i[0])&&t[1]<=Math.max(e[1],i[1])&&t[1]>=Math.min(e[1],i[1]),t=(e,t,i)=>{const s=(t[1]-e[1])*(i[0]-t[0])-(t[0]-e[0])*(i[1]-t[1]);return 0===s?0:s>0?1:2};return function(i,s){const r=i[i.length-2],o=i[i.length-1];for(let n=s?1:0;n<i.length-2-1;++n){const s=i[n],a=i[n+1],l=t(r,o,s),A=t(r,o,a),c=t(s,a,r),h=t(s,a,o);if(l!==A&&c!==h||0===l&&e(r,s,o)||0===A&&e(r,a,o)||0===c&&e(s,r,a)||0===h&&e(s,o,a))return!0}return!1}}();c=a((()=>{A(null),f.update(null),m&&m.update(g,null),u.updateBase(p.length>2?p.map((e=>e.getWorldPos())):null)}),((e,t)=>{const i=p.length>2&&v(e);if(_&&_.setHighlighted(!!i),A(i?i.canvasPos:e),f.update(!i&&t),m&&m.update(g,i?i.worldPos:t),p.length>=2){const e=p.map((e=>e.getWorldPos())).concat(i?[]:[t]),s=b(e.map((e=>[e[0],e[2]])),i);u.updateBase(s?null:e)}else u.updateBase(null)}),(function(e,a){const A=p.length>2&&v(e),c=p.map((e=>e.getWorldPos())).concat(A?[]:[a]);u.updateBase(c);const _=c.map((e=>[e[0],e[2]]));p.length>2&&b(_,A)?(h.pop()(),o(p)):A?(f.update(a),h.forEach((e=>e())),l(n.createZone({id:d.createUUID(),geometry:{planeCoordinates:_,altitude:t,height:i},alpha:r,color:s}))):(f.update(a),m&&m.update(g,a),o(p.concat(f)))}))}([]),{closeSurface:function(){throw"TODO"},deactivate:function(){c(),h.forEach((e=>e()))}}};class kI extends R{constructor(e,t={}){super(e.viewer.scene),this.zonesPlugin=e,this.pointerLens=t.pointerLens,this._action=null}get active(){return!!this._action}activate(e,t,i,s){if("object"==typeof e&&null!==e){const r=e,o=(e,t)=>{if(e in r)return r[e];if(void 0!==t)return t;throw"config missing: "+e};e=o("altitude"),t=o("height"),i=o("color","#008000"),s=o("alpha",.5)}if(this._action)return;const r=this.zonesPlugin,o=r.viewer,n=o.scene,a=this,l=FI(o,(function(t,i){return II(e,d.vec3([0,1,0]),t,i)}));!function o(){a._action=LI(n,e,t,i,s,a.pointerLens,r,l,(e=>{let t=!0;a._action={deactivate:()=>{t=!1}},a.fire("zoneEnd",e),t&&o()}))}()}deactivate(){this._action&&(this._action.deactivate(),this._action=null)}destroy(){this.deactivate(),super.destroy()}}class OI extends R{constructor(e,t={}){super(e.viewer.scene),this.zonesPlugin=e,this.pointerLens=t.pointerLens,this.pointerCircle=new G(e.viewer),this._action=null}get active(){return!!this._action}activate(e,t,i,s){if("object"==typeof e&&null!==e){const r=e,o=(e,t)=>{if(e in r)return r[e];if(void 0!==t)return t;throw"config missing: "+e};e=o("altitude"),t=o("height"),i=o("color","#008000"),s=o("alpha",.5)}if(this._action)return;const r=this.zonesPlugin,o=r.viewer,n=o.scene,a=this,l=cy(o,this.pointerCircle,(function(t,i){return II(e,d.vec3([0,1,0]),t,i)}));!function o(){a._action=LI(n,e,t,i,s,a.pointerLens,r,l,(e=>{let t=!0;a._action={deactivate:()=>{t=!1}},a.fire("zoneEnd",e),t&&o()}))}()}deactivate(){this._action&&(this._action.deactivate(),this._action=null)}destroy(){this.deactivate(),super.destroy()}}class NI extends R{constructor(e,t,i,s){const r=e.plugin.viewer,o=r.scene;super(o);const n=e._geometry.altitude,a=e._geometry.planeCoordinates.map((t=>{const i=o.canvas.canvas.ownerDocument.body,s=new sy(o,{},i,{fillColor:e._color});return s.worldPos=d.vec3([t[0],n,t[1]]),s.on("worldPos",(function(){t[0]=s.worldPos[0],t[1]=s.worldPos[2];try{e._rebuildMesh()}catch(t){e._zoneMesh&&(e._zoneMesh.destroy(),e._zoneMesh=null)}})),s})),l=Ay({viewer:r,handleMouseEvents:i,handleTouchEvents:s,pointerLens:t&&t.pointerLens,dots:a,ray2WorldPos:(e,t)=>II(n,d.vec3([0,1,0]),e,t),onEnd:(t,i)=>(e._zoneMesh&&this.fire("edited"),!!e._zoneMesh)}),A=function(){l(),a.forEach((e=>e.destroy()))},c=e.on("destroyed",A);this._deactivate=function(){e.off("destroyed",c),A()}}deactivate(){this._deactivate(),super.destroy()}}class VI extends NI{constructor(e,t){super(e,t,!0,!1)}}class QI extends NI{constructor(e,t){super(e,t,!1,!0)}}class HI extends R{constructor(e,t,i,s){const r=e.plugin.viewer,o=r.scene,n=o.canvas.canvas;super(o);const a=this,l=e._geometry.altitude,A=t&&t.pointerLens,c=A?function(e){A.visible=!!e,e&&(A.canvasPos=e)}:()=>{},h=e=>{const t=d.vec3(),i=d.vec3();return d.canvasPosToWorldRay(n,o.camera.viewMatrix,o.camera.projMatrix,o.camera.projection,e,t,i),s=t,r=i,II(l,d.vec3([0,1,0]),s,r);var s,r},u=(e,t)=>(t[0]=e.clientX,t[1]=e.clientY,$b(n.ownerDocument.documentElement,n,t),t),p=function(e,t){const i=e=>{e.preventDefault(),t(e)};return n.addEventListener(e,i),()=>n.removeEventListener(e,i)};let f=()=>{};const m=function(t,i,s,o){const l=o(t),A=u(l,d.vec2()),m=r.scene.pick({canvasPos:A,includeEntities:[e._zoneMesh.id]});if((m&&m.entity&&m.entity.zone)===e){f(),n.style.cursor="move",r.cameraControl.active=!1;const t=function(){const t=e._geometry.planeCoordinates.map((e=>e.slice())),i=h(A),s=d.vec2([i[0],i[2]]),r=d.vec2();return function(i){const o=h(i);r[0]=o[0],r[1]=o[2],d.subVec2(s,r,r),e._geometry.planeCoordinates.forEach(((e,i)=>{d.subVec2(t[i],r,e)}));try{e._rebuildMesh()}catch(t){e._zoneMesh&&(e._zoneMesh.destroy(),e._zoneMesh=null)}}}(),l=p(i,(function(e){const i=o(e);if(i){const e=u(i,d.vec2());t(e),c(e)}})),m=p(s,(function(e){const i=o(e);if(i){const e=u(i,d.vec2());t(e),c(null),f(),a.fire("translated")}}));f=function(){f=()=>{},n.style.cursor="default",r.cameraControl.active=!0,l(),m()}}},g=[];i&&g.push(p("mousedown",(e=>{1===e.which&&m(e,"mousemove","mouseup",(e=>1===e.which&&e))}))),s&&g.push(p("touchstart",(e=>{if(1===e.touches.length){const t=e.touches[0].identifier;m(e,"touchmove","touchend",(e=>[...e.changedTouches].find((e=>e.identifier===t))))}})));const _=function(){f(),g.forEach((e=>e())),c(null)},v=e.on("destroyed",_);this._deactivate=function(){e.off("destroyed",v),_()}}deactivate(){this._deactivate(),super.destroy()}}class jI extends HI{constructor(e,t){super(e,t,!0,!1)}}class GI extends HI{constructor(e,t){super(e,t,!1,!0)}}export{Ct as AlphaFormat,Uc as AmbientLight,Ey as AngleMeasurementEditMouseControl,Fy as AngleMeasurementEditTouchControl,wy as AngleMeasurementsControl,By as AngleMeasurementsMouseControl,Py as AngleMeasurementsPlugin,Cy as AngleMeasurementsTouchControl,Uy as AnnotationsPlugin,Ly as AxisGizmoPlugin,Qy as BCFViewpointsPlugin,Ks as Bitmap,mt as ByteType,Zc as CameraMemento,Y as CameraPath,re as CameraPathAnimation,PI as CityJSONLoaderPlugin,st as ClampToEdgeWrapping,R as Component,fi as CompressedMediaType,ho as Configs,o as ContextMenu,eh as CubicBezierCurve,K as Curve,YF as CxConverterIFCLoaderPlugin,KA as DefaultLoadingManager,Tt as DepthFormat,Dt as DepthStencilFormat,kc as DirLight,tw as DistanceMeasurementEditControl,iw as DistanceMeasurementEditMouseControl,sw as DistanceMeasurementEditTouchControl,Jy as DistanceMeasurementsControl,Yy as DistanceMeasurementsMouseControl,qy as DistanceMeasurementsPlugin,ew as DistanceMeasurementsTouchControl,sy as Dot3D,xI as DotBIMDefaultDataSource,CI as DotBIMLoaderPlugin,Ws as EdgeMaterial,Gs as EmphasisMaterial,oE as FaceAlignedSectionPlanesPlugin,rw as FastNavPlugin,yt as FloatType,Xs as Fresnel,N as Frustum,O as FrustumPlane,ui as GIFMediaType,ow as GLTFDefaultDataSource,MM as GLTFLoaderPlugin,wt as HalfFloatType,Us as ImagePlane,vt as IntType,di as JPEGMediaType,ec as KTX2TextureTranscoder,gI as LASLoaderPlugin,ry as Label3D,Ls as LambertMaterial,Gc as LightMap,Sc as LineSet,ci as LinearEncoding,ct as LinearFilter,pt as LinearMipMapLinearFilter,ut as LinearMipMapNearestFilter,dt as LinearMipmapLinearFilter,ht as LinearMipmapNearestFilter,ZA as Loader,XA as LoadingManager,z as LocaleService,It as LuminanceAlphaFormat,Ft as LuminanceFormat,e as Map,Xc as Marker,H as MarqueePicker,j as MarqueePickerMouseControl,fs as Mesh,ar as MeshSurfaceArea,$s as MeshVolume,Ns as MetallicMaterial,rt as MirroredRepeatWrapping,Yc as ModelMemento,TM as NavCubePlugin,ot as NearestFilter,At as NearestMipMapLinearFilter,nt as NearestMipMapNearestFilter,lt as NearestMipmapLinearFilter,at as NearestMipmapNearestFilter,Ke as Node,VM as OBJLoaderPlugin,f as ObjectsKdTree3,$c as ObjectsMemento,pi as PNGMediaType,th as Path,sh as PerformanceModel,bs as PhongMaterial,uh as PickResult,ph as Plugin,Oc as PointLight,G as PointerCircle,n as PointerLens,ih as QuadraticBezierCurve,m as Queue,Et as RGBAFormat,kt as RGBAIntegerFormat,ni as RGBA_ASTC_10x10_Format,si as RGBA_ASTC_10x5_Format,ri as RGBA_ASTC_10x6_Format,oi as RGBA_ASTC_10x8_Format,ai as RGBA_ASTC_12x10_Format,li as RGBA_ASTC_12x12_Format,Zt as RGBA_ASTC_4x4_Format,Jt as RGBA_ASTC_5x4_Format,Yt as RGBA_ASTC_5x5_Format,qt as RGBA_ASTC_6x5_Format,$t as RGBA_ASTC_6x6_Format,ei as RGBA_ASTC_8x5_Format,ti as RGBA_ASTC_8x6_Format,ii as RGBA_ASTC_8x8_Format,Ai as RGBA_BPTC_Format,Kt as RGBA_ETC2_EAC_Format,zt as RGBA_PVRTC_2BPPV1_Format,Gt as RGBA_PVRTC_4BPPV1_Format,Nt as RGBA_S3TC_DXT1_Format,Vt as RGBA_S3TC_DXT3_Format,Qt as RGBA_S3TC_DXT5_Format,Mt as RGBFormat,Wt as RGB_ETC1_Format,Xt as RGB_ETC2_Format,jt as RGB_PVRTC_2BPPV1_Format,Ht as RGB_PVRTC_4BPPV1_Format,Ot as RGB_S3TC_DXT1_Format,Ut as RGFormat,Lt as RGIntegerFormat,ve as ReadableGeometry,St as RedFormat,Rt as RedIntegerFormat,jc as ReflectionMap,it as RepeatWrapping,nE as STLDefaultDataSource,fE as STLLoaderPlugin,Tc as SceneModel,ur as SceneModelMesh,wc as SceneModelTransform,ch as SectionPlane,WM as SectionPlanesPlugin,gt as ShortType,Hs as SpecularMaterial,Z as SplineCurve,Kc as SpriteMarker,YM as StoreyViewsPlugin,Is as Texture,hh as TextureTranscoder,QM as TransformControl,_E as TreeViewPlugin,ft as UnsignedByteType,xt as UnsignedInt248Type,bt as UnsignedIntType,Bt as UnsignedShort4444Type,Pt as UnsignedShort5551Type,_t as UnsignedShortType,we as VBOGeometry,wE as ViewCullPlugin,fy as Viewer,VF as WebIFCLoaderPlugin,oy as Wire3D,qA as WorkerPool,BE as XKTDefaultDataSource,BF as XKTLoaderPlugin,OF as XML3DLoaderPlugin,NI as ZoneEditControl,VI as ZoneEditMouseControl,QI as ZoneEditTouchControl,HI as ZoneTranslateControl,jI as ZoneTranslateMouseControl,GI as ZoneTranslateTouchControl,SI as ZonesMouseControl,UI as ZonesPlugin,kI as ZonesPolysurfaceMouseControl,OI as ZonesPolysurfaceTouchControl,RI as ZonesTouchControl,ly as activateDraggableDot,Ay as activateDraggableDots,uy as addMousePressListener,dy as addTouchPressListener,Ce as buildBoxGeometry,Me as buildBoxLinesGeometry,Ee as buildBoxLinesGeometryFromAABB,Fe as buildCylinderGeometry,Ie as buildGridGeometry,Oe as buildLineGeometry,Te as buildPlaneGeometry,Le as buildPolylineGeometry,ke as buildPolylineGeometryFromCurve,De as buildSphereGeometry,Se as buildTorusGeometry,Ue as buildVectorTextGeometry,my as createCombinedTexture,Ye as createRTCViewMat,gy as createSkyboxMesh,_y as createSphereMapMesh,Q as frustumIntersectsAABB3,ic as getKTX2TextureTranscoder,tt as getPlaneRTCPos,Zs as isTriangleMeshSolid,Pe as load3DSGeometry,xe as loadOBJGeometry,ny as marker3D,d as math,lr as meshSurfaceArea,er as meshVolume,dh as os,et as rtcToWorldPos,hi as sRGBEncoding,V as setFrustum,py as startPolygonCreate,g as stats,cy as touchPointSelector,$b as transformToNode,hy as triangulateEarClipping,y as utils,ay as wire3D,qe as worldToRTCPos,$e as worldToRTCPositions};
