class t{constructor(t,e){this.items=t||[],this._lastUniqueId=(e||0)+1}addItem(){let t;if(2===arguments.length){const e=arguments[0];if(t=arguments[1],this.items[e])throw"ID clash: '"+e+"'";return this.items[e]=t,e}for(t=arguments[0]||{};;){const e=this._lastUniqueId++;if(!this.items[e])return this.items[e]=t,e}}removeItem(t){const e=this.items[t];return delete this.items[t],e}}const e=new t;class i{constructor(t){this.id=t,this.parentItem=null,this.groups=[],this.menuElement=null,this.shown=!1,this.mouseOver=0}}class s{constructor(){this.items=[]}}class r{constructor(t,e,i,s,r){this.id=t,this.getTitle=e,this.doAction=i,this.getEnabled=s,this.getShown=r,this.itemElement=null,this.subMenu=null,this.enabled=!0}}class o{constructor(t={}){this._id=e.addItem(),this._context=null,this._enabled=!1,this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={},this._shown=!1,this._nextId=0,this._eventSubs={},!1!==t.hideOnMouseDown&&(document.addEventListener("mousedown",(t=>{t.target.classList.contains("xeokit-context-menu-item")||this.hide()})),document.addEventListener("touchstart",this._canvasTouchStartHandler=t=>{t.target.classList.contains("xeokit-context-menu-item")||this.hide()})),t.items&&(this.items=t.items),this.context=t.context,this.enabled=!1!==t.enabled,this.hide()}on(t,e){let i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)}fire(t,e){const i=this._eventSubs[t];if(i)for(let t=0,s=i.length;t<s;t++)i[t](e)}set items(t){this._clear(),this._itemsCfg=t||[],this._parseItems(t),this._createUI()}get items(){return this._itemsCfg}set enabled(t){(t=!!t)!==this._enabled&&(this._enabled=t,this._enabled||this.hide())}get enabled(){return this._enabled}set context(t){this._context=t}get context(){return this._context}show(t,e){this._context?this._enabled&&(this._shown||(this._hideAllMenus(),this._updateItemsTitles(),this._updateItemsEnabledStatus(),this._showMenu(this._rootMenu.id,t,e),this._shown=!0,this.fire("shown",{}))):console.error("ContextMenu cannot be shown without a context - set context first")}get shown(){return this._shown}hide(){this._enabled&&this._shown&&(this._hideAllMenus(),this._shown=!1,this.fire("hidden",{}))}destroy(){this._context=null,this._clear(),null!==this._id&&(e.removeItem(this._id),this._id=null)}_clear(){for(let t=0,e=this._menuList.length;t<e;t++){const e=this._menuList[t].menuElement;e.parentElement.removeChild(e)}this._itemsCfg=[],this._rootMenu=null,this._menuList=[],this._menuMap={},this._itemList=[],this._itemMap={}}_parseItems(t){const e=t=>{const o=this._getNextId(),a=new i(o);for(let i=0,o=t.length;i<o;i++){const o=t[i],n=new s;a.groups.push(n);for(let t=0,i=o.length;t<i;t++){const i=o[t],s=i.items,l=s&&s.length>0,h=this._getNextId(),c=i.getTitle||(()=>i.title||""),u=i.doAction||i.callback||(()=>{}),d=i.getEnabled||(()=>!0),p=i.getShown||(()=>!0),_=new r(h,c,u,d,p);if(_.parentMenu=a,n.items.push(_),l){const t=e(s);_.subMenu=t,t.parentItem=_}this._itemList.push(_),this._itemMap[_.id]=_}}return this._menuList.push(a),this._menuMap[a.id]=a,a};this._rootMenu=e(t)}_getNextId(){return"ContextMenu_"+this._id+this._nextId++}_createUI(){const t=e=>{this._createMenuUI(e);const i=e.groups;for(let e=0,s=i.length;e<s;e++){const s=i[e].items;for(let e=0,i=s.length;e<i;e++){const i=s[e].subMenu;i&&t(i)}}};t(this._rootMenu)}_createMenuUI(t){const e=t.groups,i=[];if(i.push('<div class="xeokit-context-menu '+t.id+'" style="z-index:300000; position: absolute;">'),i.push("<ul>"),e)for(let t=0,s=e.length;t<s;t++){const r=t,o=s,a=e[t].items;if(a)for(let t=0,e=a.length;t<e;t++){const s=a[t],n=s.subMenu,l=s.title||"";n?i.push('<li id="'+s.id+'" class="xeokit-context-menu-item" style="'+(r===o-1||t<e-1?"border-bottom: 0":"border-bottom: 1px solid black")+'">'+l+" [MORE]</li>"):i.push('<li id="'+s.id+'" class="xeokit-context-menu-item" style="'+(r===o-1||t<e-1?"border-bottom: 0":"border-bottom: 1px solid black")+'">'+l+"</li>")}}i.push("</ul>"),i.push("</div>");const s=i.join("");document.body.insertAdjacentHTML("beforeend",s);const r=document.querySelector("."+t.id);t.menuElement=r,r.style["border-radius"]="4px",r.style.display="none",r.style["z-index"]=3e5,r.style.background="white",r.style.border="1px solid black",r.style["box-shadow"]="0 4px 5px 0 gray",r.oncontextmenu=t=>{t.preventDefault()};const o=this;let a=null;if(e)for(let t=0,i=e.length;t<i;t++){const i=e[t].items;if(i)for(let t=0,e=i.length;t<e;t++){const e=i[t],s=e.subMenu;e.itemElement=document.getElementById(e.id),e.itemElement?(e.itemElement.addEventListener("mouseenter",(t=>{if(t.preventDefault(),!1===e.enabled)return;const i=e.subMenu;if(!i)return void(a&&(o._hideMenu(a.id),a=null));a&&a.id!==i.id&&(o._hideMenu(a.id),a=null);const s=e.itemElement,r=i.menuElement,n=s.getBoundingClientRect();r.getBoundingClientRect();n.right+200>window.innerWidth?o._showMenu(i.id,n.left-200,n.top-1):o._showMenu(i.id,n.right-5,n.top-1),a=i})),s||(e.itemElement.addEventListener("click",(t=>{t.preventDefault(),o.hide(),o._context&&!1!==e.enabled&&e.doAction&&e.doAction(o._context)})),e.itemElement.addEventListener("mouseenter",(t=>{t.preventDefault(),!1!==e.enabled&&e.doHover&&e.doHover(o._context)})))):console.error("ContextMenu item element not found: "+e.id)}}}_updateItemsTitles(){if(this._context)for(let t=0,e=this._itemList.length;t<e;t++){const e=this._itemList[t],i=e.itemElement;if(!i)continue;const s=e.getShown;if(!s||!s(this._context))continue;const r=e.getTitle(this._context);e.subMenu,i.innerText=r}}_updateItemsEnabledStatus(){if(this._context)for(let t=0,e=this._itemList.length;t<e;t++){const e=this._itemList[t],i=e.itemElement;if(!i)continue;const s=e.getEnabled;if(!s)continue;const r=e.getShown;if(!r)continue;const o=r(this._context);if(e.shown=o,!o){i.style.visibility="hidden",i.style.height="0",i.style.padding="0";continue}i.style.visibility="visible",i.style.height="auto",i.style.padding=null;const a=s(this._context);e.enabled=a,a?i.classList.remove("disabled"):i.classList.add("disabled")}}_showMenu(t,e,i){const s=this._menuMap[t];if(!s)return void console.error("Menu not found: "+t);if(s.shown)return;const r=s.menuElement;r&&(this._showMenuElement(r,e,i),s.shown=!0)}_hideMenu(t){const e=this._menuMap[t];if(!e)return void console.error("Menu not found: "+t);if(!e.shown)return;const i=e.menuElement;i&&(this._hideMenuElement(i),e.shown=!1)}_hideAllMenus(){for(let t=0,e=this._menuList.length;t<e;t++){const e=this._menuList[t];this._hideMenu(e.id)}}_showMenuElement(t,e,i){t.style.display="block";const s=t.offsetHeight,r=t.offsetWidth;i+s>window.innerHeight&&(i=window.innerHeight-s),e+r>window.innerWidth&&(e=window.innerWidth-r),t.style.left=e+"px",t.style.top=i+"px"}_hideMenuElement(t){t.style.display="none"}}class a{constructor(t,e,i){this.id=i&&i.id?i.id:t,this.viewer=e,this._eventSubs={},e.addPlugin(this)}on(t,e){let i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)}fire(t,e){const i=this._eventSubs[t];if(i)for(let t=0,s=i.length;t<s;t++)i[t](e)}log(t){console.log(`[xeokit plugin ${this.id}]: ${t}`)}warn(t){console.warn(`[xeokit plugin ${this.id}]: ${t}`)}error(t){console.error(`[xeokit plugin ${this.id}]: ${t}`)}send(t,e){}destroy(){this.viewer.removePlugin(this)}}let n=!0,l=n?Float64Array:Float32Array;const h=new l(16),c=new l(16),u=new l(4),d={setDoublePrecisionEnabled(t){n=t,l=n?Float64Array:Float32Array},getDoublePrecisionEnabled:()=>n,MIN_DOUBLE:-Number.MAX_SAFE_INTEGER,MAX_DOUBLE:Number.MAX_SAFE_INTEGER,DEGTORAD:.0174532925,RADTODEG:57.295779513,unglobalizeObjectId(t,e){const i=e.indexOf("#");return i===t.length&&e.startsWith(t)?e.substring(i+1):e},globalizeObjectId:(t,e)=>t+"#"+e,vec2:t=>new l(t||2),vec3:t=>new l(t||3),vec4:t=>new l(t||4),mat3:t=>new l(t||9),mat3ToMat4:(t,e=new l(16))=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e),mat4:t=>new l(t||16),mat4ToMat3(t,e){},doublesToFloats(t,e,i){const s=new l(2);for(let r=0,o=t.length;r<o;r++)d.splitDouble(t[r],s),e[r]=s[0],i[r]=s[1]},splitDouble(t,e){const i=l.from([t])[0],s=t-i;e[0]=i,e[1]=s},createUUID:(()=>{const t=[];for(let e=0;e<256;e++)t[e]=(e<16?"0":"")+e.toString(16);return()=>{const e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return`${t[255&e]+t[e>>8&255]+t[e>>16&255]+t[e>>24&255]}-${t[255&i]}${t[i>>8&255]}-${t[i>>16&15|64]}${t[i>>24&255]}-${t[63&s|128]}${t[s>>8&255]}-${t[s>>16&255]}${t[s>>24&255]}${t[255&r]}${t[r>>8&255]}${t[r>>16&255]}${t[r>>24&255]}`}})(),clamp:(t,e,i)=>Math.max(e,Math.min(i,t)),fmod(t,e){if(t<e)return console.error("math.fmod : Attempting to find modulus within negative range - would be infinite loop - ignoring"),t;for(;e<=t;)t-=e;return t},compareVec3:(t,e)=>t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2],negateVec3:(t,e)=>(e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e),negateVec4:(t,e)=>(e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e),addVec4:(t,e,i)=>(i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i),addVec4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i[3]=t[3]+e,i),addVec3:(t,e,i)=>(i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i),addVec3Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i),subVec4:(t,e,i)=>(i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i),subVec3:(t,e,i)=>(i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i),subVec2:(t,e,i)=>(i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i),geometricMeanVec2(...t){const e=new l(t[0]);for(let i=1;i<t.length;i++)e[0]+=t[i][0],e[1]+=t[i][1];return e[0]/=t.length,e[1]/=t.length,e},subVec4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]-e,i[1]=t[1]-e,i[2]=t[2]-e,i[3]=t[3]-e,i),subScalarVec4:(t,e,i)=>(i||(i=t),i[0]=e-t[0],i[1]=e-t[1],i[2]=e-t[2],i[3]=e-t[3],i),mulVec4:(t,e,i)=>(i||(i=t),i[0]=t[0]*e[0],i[1]=t[1]*e[1],i[2]=t[2]*e[2],i[3]=t[3]*e[3],i),mulVec4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i),mulVec3Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i),mulVec2Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i),divVec3:(t,e,i)=>(i||(i=t),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i[2]=t[2]/e[2],i),divVec4:(t,e,i)=>(i||(i=t),i[0]=t[0]/e[0],i[1]=t[1]/e[1],i[2]=t[2]/e[2],i[3]=t[3]/e[3],i),divScalarVec3:(t,e,i)=>(i||(i=e),i[0]=t/e[0],i[1]=t/e[1],i[2]=t/e[2],i),divVec3Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]/e,i[1]=t[1]/e,i[2]=t[2]/e,i),divVec4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]/e,i[1]=t[1]/e,i[2]=t[2]/e,i[3]=t[3]/e,i),divScalarVec4:(t,e,i)=>(i||(i=e),i[0]=t/e[0],i[1]=t/e[1],i[2]=t/e[2],i[3]=t/e[3],i),dotVec4:(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3],cross3Vec4(t,e){const i=t[0],s=t[1],r=t[2],o=e[0],a=e[1],n=e[2];return[s*n-r*a,r*o-i*n,i*a-s*o,0]},cross3Vec3(t,e,i){i||(i=t);const s=t[0],r=t[1],o=t[2],a=e[0],n=e[1],l=e[2];return i[0]=r*l-o*n,i[1]=o*a-s*l,i[2]=s*n-r*a,i},sqLenVec4:t=>d.dotVec4(t,t),lenVec4:t=>Math.sqrt(d.sqLenVec4(t)),dotVec3:(t,e)=>t[0]*e[0]+t[1]*e[1]+t[2]*e[2],dotVec2:(t,e)=>t[0]*e[0]+t[1]*e[1],sqLenVec3:t=>d.dotVec3(t,t),sqLenVec2:t=>d.dotVec2(t,t),lenVec3:t=>Math.sqrt(d.sqLenVec3(t)),distVec3:(()=>{const t=new l(3);return(e,i)=>d.lenVec3(d.subVec3(e,i,t))})(),lenVec2:t=>Math.sqrt(d.sqLenVec2(t)),distVec2:(()=>{const t=new l(2);return(e,i)=>d.lenVec2(d.subVec2(e,i,t))})(),rcpVec3:(t,e)=>d.divScalarVec3(1,t,e),normalizeVec4(t,e){const i=1/d.lenVec4(t);return d.mulVec4Scalar(t,i,e)},normalizeVec3(t,e){const i=1/d.lenVec3(t);return d.mulVec3Scalar(t,i,e)},normalizeVec2(t,e){const i=1/d.lenVec2(t);return d.mulVec2Scalar(t,i,e)},angleVec3(t,e){let i=d.dotVec3(t,e)/Math.sqrt(d.sqLenVec3(t)*d.sqLenVec3(e));return i=i<-1?-1:i>1?1:i,Math.acos(i)},vec3FromMat4Scale:(()=>{const t=new l(3);return(e,i)=>(t[0]=e[0],t[1]=e[1],t[2]=e[2],i[0]=d.lenVec3(t),t[0]=e[4],t[1]=e[5],t[2]=e[6],i[1]=d.lenVec3(t),t[0]=e[8],t[1]=e[9],t[2]=e[10],i[2]=d.lenVec3(t),i)})(),vecToArray:(()=>{function t(t){return Math.round(1e5*t)/1e5}return e=>{for(let i=0,s=(e=Array.prototype.slice.call(e)).length;i<s;i++)e[i]=t(e[i]);return e}})(),xyzArrayToObject:t=>({x:t[0],y:t[1],z:t[2]}),xyzObjectToArray:(t,e)=>((e=e||d.vec3())[0]=t.x,e[1]=t.y,e[2]=t.z,e),dupMat4:t=>t.slice(0,16),mat4To3:t=>[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]],m4s:t=>[t,t,t,t,t,t,t,t,t,t,t,t,t,t,t,t],setMat4ToZeroes:()=>d.m4s(0),setMat4ToOnes:()=>d.m4s(1),diagonalMat4v:t=>new l([t[0],0,0,0,0,t[1],0,0,0,0,t[2],0,0,0,0,t[3]]),diagonalMat4c:(t,e,i,s)=>d.diagonalMat4v([t,e,i,s]),diagonalMat4s:t=>d.diagonalMat4c(t,t,t,t),identityMat4:(t=new l(16))=>(t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t),identityMat3:(t=new l(9))=>(t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t),isIdentityMat4:t=>1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15],negateMat4:(t,e)=>(e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=-t[7],e[8]=-t[8],e[9]=-t[9],e[10]=-t[10],e[11]=-t[11],e[12]=-t[12],e[13]=-t[13],e[14]=-t[14],e[15]=-t[15],e),addMat4:(t,e,i)=>(i||(i=t),i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i[4]=t[4]+e[4],i[5]=t[5]+e[5],i[6]=t[6]+e[6],i[7]=t[7]+e[7],i[8]=t[8]+e[8],i[9]=t[9]+e[9],i[10]=t[10]+e[10],i[11]=t[11]+e[11],i[12]=t[12]+e[12],i[13]=t[13]+e[13],i[14]=t[14]+e[14],i[15]=t[15]+e[15],i),addMat4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]+e,i[1]=t[1]+e,i[2]=t[2]+e,i[3]=t[3]+e,i[4]=t[4]+e,i[5]=t[5]+e,i[6]=t[6]+e,i[7]=t[7]+e,i[8]=t[8]+e,i[9]=t[9]+e,i[10]=t[10]+e,i[11]=t[11]+e,i[12]=t[12]+e,i[13]=t[13]+e,i[14]=t[14]+e,i[15]=t[15]+e,i),addScalarMat4:(t,e,i)=>d.addMat4Scalar(e,t,i),subMat4:(t,e,i)=>(i||(i=t),i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i[3]=t[3]-e[3],i[4]=t[4]-e[4],i[5]=t[5]-e[5],i[6]=t[6]-e[6],i[7]=t[7]-e[7],i[8]=t[8]-e[8],i[9]=t[9]-e[9],i[10]=t[10]-e[10],i[11]=t[11]-e[11],i[12]=t[12]-e[12],i[13]=t[13]-e[13],i[14]=t[14]-e[14],i[15]=t[15]-e[15],i),subMat4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]-e,i[1]=t[1]-e,i[2]=t[2]-e,i[3]=t[3]-e,i[4]=t[4]-e,i[5]=t[5]-e,i[6]=t[6]-e,i[7]=t[7]-e,i[8]=t[8]-e,i[9]=t[9]-e,i[10]=t[10]-e,i[11]=t[11]-e,i[12]=t[12]-e,i[13]=t[13]-e,i[14]=t[14]-e,i[15]=t[15]-e,i),subScalarMat4:(t,e,i)=>(i||(i=e),i[0]=t-e[0],i[1]=t-e[1],i[2]=t-e[2],i[3]=t-e[3],i[4]=t-e[4],i[5]=t-e[5],i[6]=t-e[6],i[7]=t-e[7],i[8]=t-e[8],i[9]=t-e[9],i[10]=t-e[10],i[11]=t-e[11],i[12]=t-e[12],i[13]=t-e[13],i[14]=t-e[14],i[15]=t-e[15],i),mulMat4(t,e,i){i||(i=t);const s=t[0],r=t[1],o=t[2],a=t[3],n=t[4],l=t[5],h=t[6],c=t[7],u=t[8],d=t[9],p=t[10],_=t[11],f=t[12],g=t[13],m=t[14],v=t[15],b=e[0],P=e[1],y=e[2],M=e[3],x=e[4],w=e[5],E=e[6],A=e[7],C=e[8],S=e[9],D=e[10],L=e[11],B=e[12],R=e[13],T=e[14],F=e[15];return i[0]=b*s+P*n+y*u+M*f,i[1]=b*r+P*l+y*d+M*g,i[2]=b*o+P*h+y*p+M*m,i[3]=b*a+P*c+y*_+M*v,i[4]=x*s+w*n+E*u+A*f,i[5]=x*r+w*l+E*d+A*g,i[6]=x*o+w*h+E*p+A*m,i[7]=x*a+w*c+E*_+A*v,i[8]=C*s+S*n+D*u+L*f,i[9]=C*r+S*l+D*d+L*g,i[10]=C*o+S*h+D*p+L*m,i[11]=C*a+S*c+D*_+L*v,i[12]=B*s+R*n+T*u+F*f,i[13]=B*r+R*l+T*d+F*g,i[14]=B*o+R*h+T*p+F*m,i[15]=B*a+R*c+T*_+F*v,i},mulMat3(t,e,i){i||(i=new l(9));const s=t[0],r=t[3],o=t[6],a=t[1],n=t[4],h=t[7],c=t[2],u=t[5],d=t[8],p=e[0],_=e[3],f=e[6],g=e[1],m=e[4],v=e[7],b=e[2],P=e[5],y=e[8];return i[0]=s*p+r*g+o*b,i[3]=s*_+r*m+o*P,i[6]=s*f+r*v+o*y,i[1]=a*p+n*g+h*b,i[4]=a*_+n*m+h*P,i[7]=a*f+n*v+h*y,i[2]=c*p+u*g+d*b,i[5]=c*_+u*m+d*P,i[8]=c*f+u*v+d*y,i},mulMat4Scalar:(t,e,i)=>(i||(i=t),i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i[3]=t[3]*e,i[4]=t[4]*e,i[5]=t[5]*e,i[6]=t[6]*e,i[7]=t[7]*e,i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11]*e,i[12]=t[12]*e,i[13]=t[13]*e,i[14]=t[14]*e,i[15]=t[15]*e,i),mulMat4v4(t,e,i=d.vec4()){const s=e[0],r=e[1],o=e[2],a=e[3];return i[0]=t[0]*s+t[4]*r+t[8]*o+t[12]*a,i[1]=t[1]*s+t[5]*r+t[9]*o+t[13]*a,i[2]=t[2]*s+t[6]*r+t[10]*o+t[14]*a,i[3]=t[3]*s+t[7]*r+t[11]*o+t[15]*a,i},transposeMat4(t,e){const i=t[4],s=t[14],r=t[8],o=t[13],a=t[12],n=t[9];if(!e||t===e){const e=t[1],l=t[2],h=t[3],c=t[6],u=t[7],d=t[11];return t[1]=i,t[2]=r,t[3]=a,t[4]=e,t[6]=n,t[7]=o,t[8]=l,t[9]=c,t[11]=s,t[12]=h,t[13]=u,t[14]=d,t}return e[0]=t[0],e[1]=i,e[2]=r,e[3]=a,e[4]=t[1],e[5]=t[5],e[6]=n,e[7]=o,e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=s,e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},transposeMat3(t,e){if(e===t){const i=t[1],s=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=s,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},determinantMat4(t){const e=t[0],i=t[1],s=t[2],r=t[3],o=t[4],a=t[5],n=t[6],l=t[7],h=t[8],c=t[9],u=t[10],d=t[11],p=t[12],_=t[13],f=t[14],g=t[15];return p*c*n*r-h*_*n*r-p*a*u*r+o*_*u*r+h*a*f*r-o*c*f*r-p*c*s*l+h*_*s*l+p*i*u*l-e*_*u*l-h*i*f*l+e*c*f*l+p*a*s*d-o*_*s*d-p*i*n*d+e*_*n*d+o*i*f*d-e*a*f*d-h*a*s*g+o*c*s*g+h*i*n*g-e*c*n*g-o*i*u*g+e*a*u*g},inverseMat4(t,e){e||(e=t);const i=t[0],s=t[1],r=t[2],o=t[3],a=t[4],n=t[5],l=t[6],h=t[7],c=t[8],u=t[9],d=t[10],p=t[11],_=t[12],f=t[13],g=t[14],m=t[15],v=i*n-s*a,b=i*l-r*a,P=i*h-o*a,y=s*l-r*n,M=s*h-o*n,x=r*h-o*l,w=c*f-u*_,E=c*g-d*_,A=c*m-p*_,C=u*g-d*f,S=u*m-p*f,D=d*m-p*g,L=1/(v*D-b*S+P*C+y*A-M*E+x*w);return e[0]=(n*D-l*S+h*C)*L,e[1]=(-s*D+r*S-o*C)*L,e[2]=(f*x-g*M+m*y)*L,e[3]=(-u*x+d*M-p*y)*L,e[4]=(-a*D+l*A-h*E)*L,e[5]=(i*D-r*A+o*E)*L,e[6]=(-_*x+g*P-m*b)*L,e[7]=(c*x-d*P+p*b)*L,e[8]=(a*S-n*A+h*w)*L,e[9]=(-i*S+s*A-o*w)*L,e[10]=(_*M-f*P+m*v)*L,e[11]=(-c*M+u*P-p*v)*L,e[12]=(-a*C+n*E-l*w)*L,e[13]=(i*C-s*E+r*w)*L,e[14]=(-_*y+f*b-g*v)*L,e[15]=(c*y-u*b+d*v)*L,e},traceMat4:t=>t[0]+t[5]+t[10]+t[15],translationMat4v(t,e){const i=e||d.identityMat4();return i[12]=t[0],i[13]=t[1],i[14]=t[2],i},translationMat3v(t,e){const i=e||d.identityMat3();return i[6]=t[0],i[7]=t[1],i},translationMat4c:(()=>{const t=new l(3);return(e,i,s,r)=>(t[0]=e,t[1]=i,t[2]=s,d.translationMat4v(t,r))})(),translationMat4s:(t,e)=>d.translationMat4c(t,t,t,e),translateMat4v:(t,e)=>d.translateMat4c(t[0],t[1],t[2],e),translateMat4c(t,e,i,s){const r=s[3];s[0]+=r*t,s[1]+=r*e,s[2]+=r*i;const o=s[7];s[4]+=o*t,s[5]+=o*e,s[6]+=o*i;const a=s[11];s[8]+=a*t,s[9]+=a*e,s[10]+=a*i;const n=s[15];return s[12]+=n*t,s[13]+=n*e,s[14]+=n*i,s},setMat4Translation:(t,e,i)=>(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=t[15],i),rotationMat4v(t,e,i){const s=d.normalizeVec4([e[0],e[1],e[2],0],[]),r=Math.sin(t),o=Math.cos(t),a=1-o,n=s[0],l=s[1],h=s[2];let c,u,p,_,f,g;return c=n*l,u=l*h,p=h*n,_=n*r,f=l*r,g=h*r,(i=i||d.mat4())[0]=a*n*n+o,i[1]=a*c+g,i[2]=a*p-f,i[3]=0,i[4]=a*c-g,i[5]=a*l*l+o,i[6]=a*u+_,i[7]=0,i[8]=a*p+f,i[9]=a*u-_,i[10]=a*h*h+o,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i},rotationMat4c:(t,e,i,s,r)=>d.rotationMat4v(t,[e,i,s],r),scalingMat4v:(t,e=d.identityMat4())=>(e[0]=t[0],e[5]=t[1],e[10]=t[2],e),scalingMat3v:(t,e=d.identityMat3())=>(e[0]=t[0],e[4]=t[1],e),scalingMat4c:(()=>{const t=new l(3);return(e,i,s,r)=>(t[0]=e,t[1]=i,t[2]=s,d.scalingMat4v(t,r))})(),scaleMat4c:(t,e,i,s)=>(s[0]*=t,s[4]*=e,s[8]*=i,s[1]*=t,s[5]*=e,s[9]*=i,s[2]*=t,s[6]*=e,s[10]*=i,s[3]*=t,s[7]*=e,s[11]*=i,s),scaleMat4v(t,e){const i=t[0],s=t[1],r=t[2];return e[0]*=i,e[4]*=s,e[8]*=r,e[1]*=i,e[5]*=s,e[9]*=r,e[2]*=i,e[6]*=s,e[10]*=r,e[3]*=i,e[7]*=s,e[11]*=r,e},scalingMat4s:t=>d.scalingMat4c(t,t,t),rotationTranslationMat4(t,e,i=d.mat4()){const s=t[0],r=t[1],o=t[2],a=t[3],n=s+s,l=r+r,h=o+o,c=s*n,u=s*l,p=s*h,_=r*l,f=r*h,g=o*h,m=a*n,v=a*l,b=a*h;return i[0]=1-(_+g),i[1]=u+b,i[2]=p-v,i[3]=0,i[4]=u-b,i[5]=1-(c+g),i[6]=f+m,i[7]=0,i[8]=p+v,i[9]=f-m,i[10]=1-(c+_),i[11]=0,i[12]=e[0],i[13]=e[1],i[14]=e[2],i[15]=1,i},mat4ToEuler(t,e,i=d.vec4()){const s=d.clamp,r=t[0],o=t[4],a=t[8],n=t[1],l=t[5],h=t[9],c=t[2],u=t[6],p=t[10];return"XYZ"===e?(i[1]=Math.asin(s(a,-1,1)),Math.abs(a)<.99999?(i[0]=Math.atan2(-h,p),i[2]=Math.atan2(-o,r)):(i[0]=Math.atan2(u,l),i[2]=0)):"YXZ"===e?(i[0]=Math.asin(-s(h,-1,1)),Math.abs(h)<.99999?(i[1]=Math.atan2(a,p),i[2]=Math.atan2(n,l)):(i[1]=Math.atan2(-c,r),i[2]=0)):"ZXY"===e?(i[0]=Math.asin(s(u,-1,1)),Math.abs(u)<.99999?(i[1]=Math.atan2(-c,p),i[2]=Math.atan2(-o,l)):(i[1]=0,i[2]=Math.atan2(n,r))):"ZYX"===e?(i[1]=Math.asin(-s(c,-1,1)),Math.abs(c)<.99999?(i[0]=Math.atan2(u,p),i[2]=Math.atan2(n,r)):(i[0]=0,i[2]=Math.atan2(-o,l))):"YZX"===e?(i[2]=Math.asin(s(n,-1,1)),Math.abs(n)<.99999?(i[0]=Math.atan2(-h,l),i[1]=Math.atan2(-c,r)):(i[0]=0,i[1]=Math.atan2(a,p))):"XZY"===e&&(i[2]=Math.asin(-s(o,-1,1)),Math.abs(o)<.99999?(i[0]=Math.atan2(u,l),i[1]=Math.atan2(a,r)):(i[0]=Math.atan2(-h,p),i[1]=0)),i},composeMat4:(t,e,i,s=d.mat4())=>(d.quaternionToRotationMat4(e,s),d.scaleMat4v(i,s),d.translateMat4v(t,s),s),decomposeMat4:(()=>{const t=new l(3),e=new l(16);return function(i,s,r,o){t[0]=i[0],t[1]=i[1],t[2]=i[2];let a=d.lenVec3(t);t[0]=i[4],t[1]=i[5],t[2]=i[6];const n=d.lenVec3(t);t[8]=i[8],t[9]=i[9],t[10]=i[10];const l=d.lenVec3(t);d.determinantMat4(i)<0&&(a=-a),s[0]=i[12],s[1]=i[13],s[2]=i[14],e.set(i);const h=1/a,c=1/n,u=1/l;return e[0]*=h,e[1]*=h,e[2]*=h,e[4]*=c,e[5]*=c,e[6]*=c,e[8]*=u,e[9]*=u,e[10]*=u,d.mat4ToQuaternion(e,r),o[0]=a,o[1]=n,o[2]=l,this}})(),getColMat4(t,e){const i=4*e;return[t[i],t[i+1],t[i+2],t[i+3]]},setRowMat4(t,e,i){t[e]=i[0],t[e+4]=i[1],t[e+8]=i[2],t[e+12]=i[3]},lookAtMat4v(t,e,i,s){s||(s=d.mat4());const r=t[0],o=t[1],a=t[2],n=i[0],l=i[1],h=i[2],c=e[0],u=e[1],p=e[2];if(r===c&&o===u&&a===p)return d.identityMat4();let _,f,g,m,v,b,P,y,M,x;return _=r-c,f=o-u,g=a-p,x=1/Math.sqrt(_*_+f*f+g*g),_*=x,f*=x,g*=x,m=l*g-h*f,v=h*_-n*g,b=n*f-l*_,x=Math.sqrt(m*m+v*v+b*b),x?(x=1/x,m*=x,v*=x,b*=x):(m=0,v=0,b=0),P=f*b-g*v,y=g*m-_*b,M=_*v-f*m,x=Math.sqrt(P*P+y*y+M*M),x?(x=1/x,P*=x,y*=x,M*=x):(P=0,y=0,M=0),s[0]=m,s[1]=P,s[2]=_,s[3]=0,s[4]=v,s[5]=y,s[6]=f,s[7]=0,s[8]=b,s[9]=M,s[10]=g,s[11]=0,s[12]=-(m*r+v*o+b*a),s[13]=-(P*r+y*o+M*a),s[14]=-(_*r+f*o+g*a),s[15]=1,s},lookAtMat4c:(t,e,i,s,r,o,a,n,l)=>d.lookAtMat4v([t,e,i],[s,r,o],[a,n,l],[]),orthoMat4c(t,e,i,s,r,o,a){a||(a=d.mat4());const n=e-t,l=s-i,h=o-r;return a[0]=2/n,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/l,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/h,a[11]=0,a[12]=-(t+e)/n,a[13]=-(s+i)/l,a[14]=-(o+r)/h,a[15]=1,a},frustumMat4v(t,e,i){i||(i=d.mat4());const s=[t[0],t[1],t[2],0],r=[e[0],e[1],e[2],0];d.addVec4(r,s,h),d.subVec4(r,s,c);const o=2*s[2],a=c[0],n=c[1],l=c[2];return i[0]=o/a,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=o/n,i[6]=0,i[7]=0,i[8]=h[0]/a,i[9]=h[1]/n,i[10]=-h[2]/l,i[11]=-1,i[12]=0,i[13]=0,i[14]=-o*r[2]/l,i[15]=0,i},frustumMat4(t,e,i,s,r,o,a){a||(a=d.mat4());const n=e-t,l=s-i,h=o-r;return a[0]=2*r/n,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*r/l,a[6]=0,a[7]=0,a[8]=(e+t)/n,a[9]=(s+i)/l,a[10]=-(o+r)/h,a[11]=-1,a[12]=0,a[13]=0,a[14]=-o*r*2/h,a[15]=0,a},perspectiveMat4(t,e,i,s,r){const o=[],a=[];return o[2]=i,a[2]=s,a[1]=o[2]*Math.tan(t/2),o[1]=-a[1],a[0]=a[1]*e,o[0]=-a[0],d.frustumMat4v(o,a,r)},compareMat4:(t,e)=>t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15],transformPoint3(t,e,i=d.vec3()){const s=e[0],r=e[1],o=e[2];return i[0]=t[0]*s+t[4]*r+t[8]*o+t[12],i[1]=t[1]*s+t[5]*r+t[9]*o+t[13],i[2]=t[2]*s+t[6]*r+t[10]*o+t[14],i},transformPoint4:(t,e,i=d.vec4())=>(i[0]=t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12]*e[3],i[1]=t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13]*e[3],i[2]=t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14]*e[3],i[3]=t[3]*e[0]+t[7]*e[1]+t[11]*e[2]+t[15]*e[3],i),transformPoints3(t,e,i){const s=i||[],r=e.length;let o,a,n,l;const h=t[0],c=t[1],u=t[2],d=t[3],p=t[4],_=t[5],f=t[6],g=t[7],m=t[8],v=t[9],b=t[10],P=t[11],y=t[12],M=t[13],x=t[14],w=t[15];let E;for(let t=0;t<r;++t)l=e[t],o=l[0],a=l[1],n=l[2],E=s[t]||(s[t]=[0,0,0]),E[0]=h*o+p*a+m*n+y,E[1]=c*o+_*a+v*n+M,E[2]=u*o+f*a+b*n+x,E[3]=d*o+g*a+P*n+w;return s.length=r,s},transformPositions3(t,e,i=e){let s;const r=e.length;let o,a,n;const l=t[0],h=t[1],c=t[2];t[3];const u=t[4],d=t[5],p=t[6];t[7];const _=t[8],f=t[9],g=t[10];t[11];const m=t[12],v=t[13],b=t[14];for(t[15],s=0;s<r;s+=3)o=e[s+0],a=e[s+1],n=e[s+2],i[s+0]=l*o+u*a+_*n+m,i[s+1]=h*o+d*a+f*n+v,i[s+2]=c*o+p*a+g*n+b;return i},transformPositions4(t,e,i=e){let s;const r=e.length;let o,a,n;const l=t[0],h=t[1],c=t[2],u=t[3],d=t[4],p=t[5],_=t[6],f=t[7],g=t[8],m=t[9],v=t[10],b=t[11],P=t[12],y=t[13],M=t[14],x=t[15];for(s=0;s<r;s+=4)o=e[s+0],a=e[s+1],n=e[s+2],i[s+0]=l*o+d*a+g*n+P,i[s+1]=h*o+p*a+m*n+y,i[s+2]=c*o+_*a+v*n+M,i[s+3]=u*o+f*a+b*n+x;return i},transformVec3(t,e,i){const s=e[0],r=e[1],o=e[2];return(i=i||this.vec3())[0]=t[0]*s+t[4]*r+t[8]*o,i[1]=t[1]*s+t[5]*r+t[9]*o,i[2]=t[2]*s+t[6]*r+t[10]*o,i},transformVec4(t,e,i){const s=e[0],r=e[1],o=e[2],a=e[3];return(i=i||d.vec4())[0]=t[0]*s+t[4]*r+t[8]*o+t[12]*a,i[1]=t[1]*s+t[5]*r+t[9]*o+t[13]*a,i[2]=t[2]*s+t[6]*r+t[10]*o+t[14]*a,i[3]=t[3]*s+t[7]*r+t[11]*o+t[15]*a,i},rotateVec3X(t,e,i,s){const r=[],o=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],o[0]=r[0],o[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),o[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),s[0]=o[0]+e[0],s[1]=o[1]+e[1],s[2]=o[2]+e[2],s},rotateVec3Y(t,e,i,s){const r=[],o=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],o[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),o[1]=r[1],o[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),s[0]=o[0]+e[0],s[1]=o[1]+e[1],s[2]=o[2]+e[2],s},rotateVec3Z(t,e,i,s){const r=[],o=[];return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],o[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),o[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),o[2]=r[2],s[0]=o[0]+e[0],s[1]=o[1]+e[1],s[2]=o[2]+e[2],s},projectVec4(t,e){const i=1/t[3];return(e=e||d.vec2())[0]=t[0]*i,e[1]=t[1]*i,e},unprojectVec3:(()=>{const t=new l(16),e=new l(16),i=new l(16);return function(s,r,o,a){return this.transformVec3(this.mulMat4(this.inverseMat4(r,t),this.inverseMat4(o,e),i),s,a)}})(),lerpVec3(t,e,i,s,r,o){const a=o||d.vec3(),n=(t-e)/(i-e);return a[0]=s[0]+n*(r[0]-s[0]),a[1]=s[1]+n*(r[1]-s[1]),a[2]=s[2]+n*(r[2]-s[2]),a},lerpMat4(t,e,i,s,r,o){const a=o||d.mat4(),n=(t-e)/(i-e);return a[0]=s[0]+n*(r[0]-s[0]),a[1]=s[1]+n*(r[1]-s[1]),a[2]=s[2]+n*(r[2]-s[2]),a[3]=s[3]+n*(r[3]-s[3]),a[4]=s[4]+n*(r[4]-s[4]),a[5]=s[5]+n*(r[5]-s[5]),a[6]=s[6]+n*(r[6]-s[6]),a[7]=s[7]+n*(r[7]-s[7]),a[8]=s[8]+n*(r[8]-s[8]),a[9]=s[9]+n*(r[9]-s[9]),a[10]=s[10]+n*(r[10]-s[10]),a[11]=s[11]+n*(r[11]-s[11]),a[12]=s[12]+n*(r[12]-s[12]),a[13]=s[13]+n*(r[13]-s[13]),a[14]=s[14]+n*(r[14]-s[14]),a[15]=s[15]+n*(r[15]-s[15]),a},flatten(t){const e=[];let i,s,r,o,a;for(i=0,s=t.length;i<s;i++)for(a=t[i],r=0,o=a.length;r<o;r++)e.push(a[r]);return e},identityQuaternion:(t=d.vec4())=>(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t),eulerToQuaternion(t,e,i=d.vec4()){const s=t[0]*d.DEGTORAD/2,r=t[1]*d.DEGTORAD/2,o=t[2]*d.DEGTORAD/2,a=Math.cos(s),n=Math.cos(r),l=Math.cos(o),h=Math.sin(s),c=Math.sin(r),u=Math.sin(o);return"XYZ"===e?(i[0]=h*n*l+a*c*u,i[1]=a*c*l-h*n*u,i[2]=a*n*u+h*c*l,i[3]=a*n*l-h*c*u):"YXZ"===e?(i[0]=h*n*l+a*c*u,i[1]=a*c*l-h*n*u,i[2]=a*n*u-h*c*l,i[3]=a*n*l+h*c*u):"ZXY"===e?(i[0]=h*n*l-a*c*u,i[1]=a*c*l+h*n*u,i[2]=a*n*u+h*c*l,i[3]=a*n*l-h*c*u):"ZYX"===e?(i[0]=h*n*l-a*c*u,i[1]=a*c*l+h*n*u,i[2]=a*n*u-h*c*l,i[3]=a*n*l+h*c*u):"YZX"===e?(i[0]=h*n*l+a*c*u,i[1]=a*c*l+h*n*u,i[2]=a*n*u-h*c*l,i[3]=a*n*l-h*c*u):"XZY"===e&&(i[0]=h*n*l-a*c*u,i[1]=a*c*l-h*n*u,i[2]=a*n*u+h*c*l,i[3]=a*n*l+h*c*u),i},mat4ToQuaternion(t,e=d.vec4()){const i=t[0],s=t[4],r=t[8],o=t[1],a=t[5],n=t[9],l=t[2],h=t[6],c=t[10];let u;const p=i+a+c;return p>0?(u=.5/Math.sqrt(p+1),e[3]=.25/u,e[0]=(h-n)*u,e[1]=(r-l)*u,e[2]=(o-s)*u):i>a&&i>c?(u=2*Math.sqrt(1+i-a-c),e[3]=(h-n)/u,e[0]=.25*u,e[1]=(s+o)/u,e[2]=(r+l)/u):a>c?(u=2*Math.sqrt(1+a-i-c),e[3]=(r-l)/u,e[0]=(s+o)/u,e[1]=.25*u,e[2]=(n+h)/u):(u=2*Math.sqrt(1+c-i-a),e[3]=(o-s)/u,e[0]=(r+l)/u,e[1]=(n+h)/u,e[2]=.25*u),e},vec3PairToQuaternion(t,e,i=d.vec4()){const s=Math.sqrt(d.dotVec3(t,t)*d.dotVec3(e,e));let r=s+d.dotVec3(t,e);return r<1e-8*s?(r=0,Math.abs(t[0])>Math.abs(t[2])?(i[0]=-t[1],i[1]=t[0],i[2]=0):(i[0]=0,i[1]=-t[2],i[2]=t[1])):d.cross3Vec3(t,e,i),i[3]=r,d.normalizeQuaternion(i)},angleAxisToQuaternion(t,e=d.vec4()){const i=t[3]/2,s=Math.sin(i);return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=Math.cos(i),e},quaternionToEuler:(()=>{const t=new l(16);return(e,i,s)=>(s=s||d.vec3(),d.quaternionToRotationMat4(e,t),d.mat4ToEuler(t,i,s),s)})(),mulQuaternions(t,e,i=d.vec4()){const s=t[0],r=t[1],o=t[2],a=t[3],n=e[0],l=e[1],h=e[2],c=e[3];return i[0]=a*n+s*c+r*h-o*l,i[1]=a*l+r*c+o*n-s*h,i[2]=a*h+o*c+s*l-r*n,i[3]=a*c-s*n-r*l-o*h,i},vec3ApplyQuaternion(t,e,i=d.vec3()){const s=e[0],r=e[1],o=e[2],a=t[0],n=t[1],l=t[2],h=t[3],c=h*s+n*o-l*r,u=h*r+l*s-a*o,p=h*o+a*r-n*s,_=-a*s-n*r-l*o;return i[0]=c*h+_*-a+u*-l-p*-n,i[1]=u*h+_*-n+p*-a-c*-l,i[2]=p*h+_*-l+c*-n-u*-a,i},quaternionToMat4(t,e){e=d.identityMat4(e);const i=t[0],s=t[1],r=t[2],o=t[3],a=2*i,n=2*s,l=2*r,h=a*o,c=n*o,u=l*o,p=a*i,_=n*i,f=l*i,g=n*s,m=l*s,v=l*r;return e[0]=1-(g+v),e[1]=_+u,e[2]=f-c,e[4]=_-u,e[5]=1-(p+v),e[6]=m+h,e[8]=f+c,e[9]=m-h,e[10]=1-(p+g),e},quaternionToRotationMat4(t,e){const i=t[0],s=t[1],r=t[2],o=t[3],a=i+i,n=s+s,l=r+r,h=i*a,c=i*n,u=i*l,d=s*n,p=s*l,_=r*l,f=o*a,g=o*n,m=o*l;return e[0]=1-(d+_),e[4]=c-m,e[8]=u+g,e[1]=c+m,e[5]=1-(h+_),e[9]=p-f,e[2]=u-g,e[6]=p+f,e[10]=1-(h+d),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},normalizeQuaternion(t,e=t){const i=d.lenVec4([t[0],t[1],t[2],t[3]]);return e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i,e[3]=t[3]/i,e},conjugateQuaternion:(t,e=t)=>(e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e),inverseQuaternion:(t,e)=>d.normalizeQuaternion(d.conjugateQuaternion(t,e)),quaternionToAngleAxis(t,e=d.vec4()){const i=(t=d.normalizeQuaternion(t,u))[3],s=2*Math.acos(i),r=Math.sqrt(1-i*i);return r<.001?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=t[0]/r,e[1]=t[1]/r,e[2]=t[2]/r),e[3]=s,e},AABB3:t=>new l(t||6),AABB2:t=>new l(t||4),OBB3:t=>new l(t||32),OBB2:t=>new l(t||16),Sphere3:(t,e,i,s)=>new l([t,e,i,s]),transformOBB3(t,e,i=e){let s;const r=e.length;let o,a,n;const l=t[0],h=t[1],c=t[2],u=t[3],d=t[4],p=t[5],_=t[6],f=t[7],g=t[8],m=t[9],v=t[10],b=t[11],P=t[12],y=t[13],M=t[14],x=t[15];for(s=0;s<r;s+=4)o=e[s+0],a=e[s+1],n=e[s+2],i[s+0]=l*o+d*a+g*n+P,i[s+1]=h*o+p*a+m*n+y,i[s+2]=c*o+_*a+v*n+M,i[s+3]=u*o+f*a+b*n+x;return i},containsAABB3:function(t,e){return t[0]<=e[0]&&e[3]<=t[3]&&t[1]<=e[1]&&e[4]<=t[4]&&t[2]<=e[2]&&e[5]<=t[5]},getAABB3Diag:(()=>{const t=new l(3),e=new l(3),i=new l(3);return s=>(t[0]=s[0],t[1]=s[1],t[2]=s[2],e[0]=s[3],e[1]=s[4],e[2]=s[5],d.subVec3(e,t,i),Math.abs(d.lenVec3(i)))})(),getAABB3DiagPoint:(()=>{const t=new l(3),e=new l(3),i=new l(3);return(s,r)=>{t[0]=s[0],t[1]=s[1],t[2]=s[2],e[0]=s[3],e[1]=s[4],e[2]=s[5];const o=d.subVec3(e,t,i),a=r[0]-s[0],n=s[3]-r[0],l=r[1]-s[1],h=s[4]-r[1],c=r[2]-s[2],u=s[5]-r[2];return o[0]+=a>n?a:n,o[1]+=l>h?l:h,o[2]+=c>u?c:u,Math.abs(d.lenVec3(o))}})(),getAABB3Area:t=>(t[3]-t[0])*(t[4]-t[1])*(t[5]-t[2]),getAABB3Center(t,e){const i=e||d.vec3();return i[0]=(t[0]+t[3])/2,i[1]=(t[1]+t[4])/2,i[2]=(t[2]+t[5])/2,i},getAABB2Center(t,e){const i=e||d.vec2();return i[0]=(t[2]+t[0])/2,i[1]=(t[3]+t[1])/2,i},collapseAABB3:(t=d.AABB3())=>(t[0]=d.MAX_DOUBLE,t[1]=d.MAX_DOUBLE,t[2]=d.MAX_DOUBLE,t[3]=d.MIN_DOUBLE,t[4]=d.MIN_DOUBLE,t[5]=d.MIN_DOUBLE,t),AABB3ToOBB3:(t,e=d.OBB3())=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=1,e[4]=t[3],e[5]=t[1],e[6]=t[2],e[7]=1,e[8]=t[3],e[9]=t[4],e[10]=t[2],e[11]=1,e[12]=t[0],e[13]=t[4],e[14]=t[2],e[15]=1,e[16]=t[0],e[17]=t[1],e[18]=t[5],e[19]=1,e[20]=t[3],e[21]=t[1],e[22]=t[5],e[23]=1,e[24]=t[3],e[25]=t[4],e[26]=t[5],e[27]=1,e[28]=t[0],e[29]=t[4],e[30]=t[5],e[31]=1,e),positions3ToAABB3:(()=>{const t=new l(3);return(e,i,s)=>{i=i||d.AABB3();let r,o,a,n=d.MAX_DOUBLE,l=d.MAX_DOUBLE,h=d.MAX_DOUBLE,c=d.MIN_DOUBLE,u=d.MIN_DOUBLE,p=d.MIN_DOUBLE;for(let i=0,_=e.length;i<_;i+=3)s?(t[0]=e[i+0],t[1]=e[i+1],t[2]=e[i+2],d.decompressPosition(t,s,t),r=t[0],o=t[1],a=t[2]):(r=e[i+0],o=e[i+1],a=e[i+2]),r<n&&(n=r),o<l&&(l=o),a<h&&(h=a),r>c&&(c=r),o>u&&(u=o),a>p&&(p=a);return i[0]=n,i[1]=l,i[2]=h,i[3]=c,i[4]=u,i[5]=p,i}})(),OBB3ToAABB3(t,e=d.AABB3()){let i,s,r,o=d.MAX_DOUBLE,a=d.MAX_DOUBLE,n=d.MAX_DOUBLE,l=d.MIN_DOUBLE,h=d.MIN_DOUBLE,c=d.MIN_DOUBLE;for(let e=0,u=t.length;e<u;e+=4)i=t[e+0],s=t[e+1],r=t[e+2],i<o&&(o=i),s<a&&(a=s),r<n&&(n=r),i>l&&(l=i),s>h&&(h=s),r>c&&(c=r);return e[0]=o,e[1]=a,e[2]=n,e[3]=l,e[4]=h,e[5]=c,e},points3ToAABB3(t,e=d.AABB3()){let i,s,r,o=d.MAX_DOUBLE,a=d.MAX_DOUBLE,n=d.MAX_DOUBLE,l=d.MIN_DOUBLE,h=d.MIN_DOUBLE,c=d.MIN_DOUBLE;for(let e=0,u=t.length;e<u;e++)i=t[e][0],s=t[e][1],r=t[e][2],i<o&&(o=i),s<a&&(a=s),r<n&&(n=r),i>l&&(l=i),s>h&&(h=s),r>c&&(c=r);return e[0]=o,e[1]=a,e[2]=n,e[3]=l,e[4]=h,e[5]=c,e},points3ToSphere3:(()=>{const t=new l(3);return(e,i)=>{i=i||d.vec4();let s,r=0,o=0,a=0;const n=e.length;for(s=0;s<n;s++)r+=e[s][0],o+=e[s][1],a+=e[s][2];i[0]=r/n,i[1]=o/n,i[2]=a/n;let l,h=0;for(s=0;s<n;s++)l=Math.abs(d.lenVec3(d.subVec3(e[s],i,t))),l>h&&(h=l);return i[3]=h,i}})(),positions3ToSphere3:(()=>{const t=new l(3),e=new l(3);return(i,s)=>{s=s||d.vec4();let r,o=0,a=0,n=0;const l=i.length;let h=0;for(r=0;r<l;r+=3)o+=i[r],a+=i[r+1],n+=i[r+2];const c=l/3;let u;for(s[0]=o/c,s[1]=a/c,s[2]=n/c,r=0;r<l;r+=3)t[0]=i[r],t[1]=i[r+1],t[2]=i[r+2],u=Math.abs(d.lenVec3(d.subVec3(t,s,e))),u>h&&(h=u);return s[3]=h,s}})(),OBB3ToSphere3:(()=>{const t=new l(3),e=new l(3);return(i,s)=>{s=s||d.vec4();let r,o=0,a=0,n=0;const l=i.length,h=l/4;for(r=0;r<l;r+=4)o+=i[r+0],a+=i[r+1],n+=i[r+2];s[0]=o/h,s[1]=a/h,s[2]=n/h;let c,u=0;for(r=0;r<l;r+=4)t[0]=i[r+0],t[1]=i[r+1],t[2]=i[r+2],c=Math.abs(d.lenVec3(d.subVec3(t,s,e))),c>u&&(u=c);return s[3]=u,s}})(),getSphere3Center:(t,e=d.vec3())=>(e[0]=t[0],e[1]=t[1],e[2]=t[2],e),getPositionsCenter(t,e=d.vec3()){let i=0,s=0,r=0;for(var o=0,a=t.length;o<a;o+=3)i+=t[o+0],s+=t[o+1],r+=t[o+2];const n=t.length/3;return e[0]=i/n,e[1]=s/n,e[2]=r/n,e},expandAABB3:(t,e)=>(t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]>e[2]&&(t[2]=e[2]),t[3]<e[3]&&(t[3]=e[3]),t[4]<e[4]&&(t[4]=e[4]),t[5]<e[5]&&(t[5]=e[5]),t),expandAABB3Point3:(t,e)=>(t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]>e[2]&&(t[2]=e[2]),t[3]<e[0]&&(t[3]=e[0]),t[4]<e[1]&&(t[4]=e[1]),t[5]<e[2]&&(t[5]=e[2]),t),expandAABB3Points3(t,e){for(var i,s,r,o=0,a=e.length;o<a;o+=3)i=e[o],s=e[o+1],r=e[o+2],t[0]>i&&(t[0]=i),t[1]>s&&(t[1]=s),t[2]>r&&(t[2]=r),t[3]<i&&(t[3]=i),t[4]<s&&(t[4]=s),t[5]<r&&(t[5]=r);return t},collapseAABB2:(t=d.AABB2())=>(t[0]=d.MAX_DOUBLE,t[1]=d.MAX_DOUBLE,t[2]=d.MIN_DOUBLE,t[3]=d.MIN_DOUBLE,t),point3AABB3Intersect:(t,e)=>t[0]>e[0]||t[3]<e[0]||t[1]>e[1]||t[4]<e[1]||t[2]>e[2]||t[5]<e[2],planeAABB3Intersect(t,e,i){let s,r;t[0]>0?(s=t[0]*i[0],r=t[0]*i[3]):(s=t[0]*i[3],r=t[0]*i[0]),t[1]>0?(s+=t[1]*i[1],r+=t[1]*i[4]):(s+=t[1]*i[4],r+=t[1]*i[1]),t[2]>0?(s+=t[2]*i[2],r+=t[2]*i[5]):(s+=t[2]*i[5],r+=t[2]*i[2]);if(s<=-e&&r<=-e)return-1;return s>=-e&&r>=-e?1:0},OBB3ToAABB2(t,e=d.AABB2()){let i,s,r,o,a=d.MAX_DOUBLE,n=d.MAX_DOUBLE,l=d.MIN_DOUBLE,h=d.MIN_DOUBLE;for(let e=0,c=t.length;e<c;e+=4)i=t[e+0],s=t[e+1],r=t[e+3]||1,o=1/r,i*=o,s*=o,i<a&&(a=i),s<n&&(n=s),i>l&&(l=i),s>h&&(h=s);return e[0]=a,e[1]=n,e[2]=l,e[3]=h,e},expandAABB2:(t,e)=>(t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[2]&&(t[2]=e[2]),t[3]<e[3]&&(t[3]=e[3]),t),expandAABB2Point2:(t,e)=>(t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[0]&&(t[2]=e[0]),t[3]<e[1]&&(t[3]=e[1]),t),AABB2ToCanvas(t,e,i,s=t){const r=.5*(t[0]+1),o=.5*(t[1]+1),a=.5*(t[2]+1),n=.5*(t[3]+1);return s[0]=Math.floor(r*e),s[1]=i-Math.floor(n*i),s[2]=Math.floor(a*e),s[3]=i-Math.floor(o*i),s},tangentQuadraticBezier:(t,e,i,s)=>2*(1-t)*(i-e)+2*t*(s-i),tangentQuadraticBezier3:(t,e,i,s,r)=>-3*e*(1-t)*(1-t)+3*i*(1-t)*(1-t)-6*t*i*(1-t)+6*t*s*(1-t)-3*t*t*s+3*t*t*r,tangentSpline:t=>6*t*t-6*t+(3*t*t-4*t+1)+(-6*t*t+6*t)+(3*t*t-2*t),catmullRomInterpolate(t,e,i,s,r){const o=.5*(i-t),a=.5*(s-e),n=r*r;return(2*e-2*i+o+a)*(r*n)+(-3*e+3*i-2*o-a)*n+o*r+e},b2p0(t,e){const i=1-t;return i*i*e},b2p1:(t,e)=>2*(1-t)*t*e,b2p2:(t,e)=>t*t*e,b2(t,e,i,s){return this.b2p0(t,e)+this.b2p1(t,i)+this.b2p2(t,s)},b3p0(t,e){const i=1-t;return i*i*i*e},b3p1(t,e){const i=1-t;return 3*i*i*t*e},b3p2:(t,e)=>3*(1-t)*t*t*e,b3p3:(t,e)=>t*t*t*e,b3(t,e,i,s,r){return this.b3p0(t,e)+this.b3p1(t,i)+this.b3p2(t,s)+this.b3p3(t,r)},triangleNormal(t,e,i,s=d.vec3()){const r=e[0]-t[0],o=e[1]-t[1],a=e[2]-t[2],n=i[0]-t[0],l=i[1]-t[1],h=i[2]-t[2],c=o*h-a*l,u=a*n-r*h,p=r*l-o*n,_=Math.sqrt(c*c+u*u+p*p);return 0===_?(s[0]=0,s[1]=0,s[2]=0):(s[0]=c/_,s[1]=u/_,s[2]=p/_),s},rayTriangleIntersect:(()=>{const t=new l(3),e=new l(3),i=new l(3),s=new l(3),r=new l(3);return(o,a,n,l,h,c)=>{c=c||d.vec3();const u=d.subVec3(l,n,t),p=d.subVec3(h,n,e),_=d.cross3Vec3(a,p,i),f=d.dotVec3(u,_);if(f<1e-6)return null;const g=d.subVec3(o,n,s),m=d.dotVec3(g,_);if(m<0||m>f)return null;const v=d.cross3Vec3(g,u,r),b=d.dotVec3(a,v);if(b<0||m+b>f)return null;const P=d.dotVec3(p,v)/f;return c[0]=o[0]+P*a[0],c[1]=o[1]+P*a[1],c[2]=o[2]+P*a[2],c}})(),rayPlaneIntersect:(()=>{const t=new l(3),e=new l(3),i=new l(3),s=new l(3);return(r,o,a,n,l,h)=>{h=h||d.vec3(),o=d.normalizeVec3(o,t);const c=d.subVec3(n,a,e),u=d.subVec3(l,a,i),p=d.cross3Vec3(c,u,s);d.normalizeVec3(p,p);const _=-d.dotVec3(a,p),f=-(d.dotVec3(r,p)+_)/d.dotVec3(o,p);return h[0]=r[0]+f*o[0],h[1]=r[1]+f*o[1],h[2]=r[2]+f*o[2],h}})(),cartesianToBarycentric:(()=>{const t=new l(3),e=new l(3),i=new l(3);return(s,r,o,a,n)=>{const l=d.subVec3(a,r,t),h=d.subVec3(o,r,e),c=d.subVec3(s,r,i),u=d.dotVec3(l,l),p=d.dotVec3(l,h),_=d.dotVec3(l,c),f=d.dotVec3(h,h),g=d.dotVec3(h,c),m=u*f-p*p;if(0===m)return null;const v=1/m,b=(f*_-p*g)*v,P=(u*g-p*_)*v;return n[0]=1-b-P,n[1]=P,n[2]=b,n}})(),barycentricInsideTriangle(t){const e=t[1],i=t[2];return i>=0&&e>=0&&i+e<1},barycentricToCartesian(t,e,i,s,r=d.vec3()){const o=t[0],a=t[1],n=t[2];return r[0]=e[0]*o+i[0]*a+s[0]*n,r[1]=e[1]*o+i[1]*a+s[1]*n,r[2]=e[2]*o+i[2]*a+s[2]*n,r},mergeVertices(t,e,i,s){const r={},o=[],a=[],n=e?[]:null,l=i?[]:null,h=[];let c,u,d,p;const _=1e4;let f,g,m=0;for(f=0,g=t.length;f<g;f+=3)c=t[f],u=t[f+1],d=t[f+2],p=`${Math.round(c*_)}_${Math.round(u*_)}_${Math.round(d*_)}`,void 0===r[p]&&(r[p]=a.length/3,a.push(c),a.push(u),a.push(d),e&&(n.push(e[f]),n.push(e[f+1]),n.push(e[f+2])),i&&(l.push(i[m]),l.push(i[m+1]))),o[f/3]=r[p],m+=2;for(f=0,g=s.length;f<g;f++)h[f]=o[s[f]];const v={positions:a,indices:h};return n&&(v.normals=n),l&&(v.uv=l),v},buildNormals:(()=>{const t=new l(3),e=new l(3),i=new l(3),s=new l(3),r=new l(3),o=new l(3);return(a,n,l)=>{let h,c;const u=new Array(a.length/3);let p,_,f,g,m,v,b;for(h=0,c=n.length;h<c;h+=3){p=n[h],_=n[h+1],f=n[h+2],t[0]=a[3*p],t[1]=a[3*p+1],t[2]=a[3*p+2],e[0]=a[3*_],e[1]=a[3*_+1],e[2]=a[3*_+2],i[0]=a[3*f],i[1]=a[3*f+1],i[2]=a[3*f+2],d.subVec3(e,t,s),d.subVec3(i,t,r);const l=d.vec3();d.normalizeVec3(d.cross3Vec3(s,r,o),l),u[p]||(u[p]=[]),u[_]||(u[_]=[]),u[f]||(u[f]=[]),u[p].push(l),u[_].push(l),u[f].push(l)}for(l=l&&l.length===a.length?l:new Float32Array(a.length),h=0,c=u.length;h<c;h++){g=u[h].length,m=0,v=0,b=0;for(let t=0;t<g;t++)m+=u[h][t][0],v+=u[h][t][1],b+=u[h][t][2];l[3*h]=m/g,l[3*h+1]=v/g,l[3*h+2]=b/g}return l}})(),buildTangents:(()=>{const t=new l(3),e=new l(3),i=new l(3),s=new l(3),r=new l(3),o=new l(3),a=new l(3);return(n,l,h)=>{const c=new Float32Array(n.length);for(let u=0;u<l.length;u+=3){let p=l[u];const _=n.subarray(3*p,3*p+3),f=h.subarray(2*p,2*p+2);p=l[u+1];const g=n.subarray(3*p,3*p+3),m=h.subarray(2*p,2*p+2);p=l[u+2];const v=n.subarray(3*p,3*p+3),b=h.subarray(2*p,2*p+2),P=d.subVec3(g,_,t),y=d.subVec3(v,_,e),M=d.subVec2(m,f,i),x=d.subVec2(b,f,s),w=1/(M[0]*x[1]-M[1]*x[0]),E=d.mulVec3Scalar(d.subVec3(d.mulVec3Scalar(P,x[1],r),d.mulVec3Scalar(y,M[1],o),a),w,o);let A;for(let t=0;t<3;t++)A=3*l[u+t],c[A]+=E[0],c[A+1]+=E[1],c[A+2]+=E[2]}return c}})(),buildPickTriangles(t,e,i){const s=e.length,r=i?new Uint16Array(9*s):new Float32Array(9*s),o=new Uint8Array(12*s);let a,n,l,h,c,u,d=0,p=0,_=0;for(let i=0;i<s;i+=3)u=d>>24&255,c=d>>16&255,h=d>>8&255,l=255&d,n=e[i],a=3*n,r[p++]=t[a],r[p++]=t[a+1],r[p++]=t[a+2],o[_++]=l,o[_++]=h,o[_++]=c,o[_++]=u,n=e[i+1],a=3*n,r[p++]=t[a],r[p++]=t[a+1],r[p++]=t[a+2],o[_++]=l,o[_++]=h,o[_++]=c,o[_++]=u,n=e[i+2],a=3*n,r[p++]=t[a],r[p++]=t[a+1],r[p++]=t[a+2],o[_++]=l,o[_++]=h,o[_++]=c,o[_++]=u,d++;return{positions:r,colors:o}},faceToVertexNormals(t,e,i={}){const s=i.smoothNormalsAngleThreshold||20,r={},o=[],a={};let n,l,h,c,u;const p=1e4;let _,f,g,m,v,b;for(f=0,m=t.length;f<m;f+=3){_=f/3,l=t[f],h=t[f+1],c=t[f+2],u=`${Math.round(l*p)}_${Math.round(h*p)}_${Math.round(c*p)}`,void 0===r[u]?r[u]=[_]:r[u].push(_);const i=d.normalizeVec3([e[f],e[f+1],e[f+2]]);o[_]=i,n=d.vec4([i[0],i[1],i[2],1]),a[_]=n}for(u in r)if(r.hasOwnProperty(u)){const t=r[u],e=t.length;for(f=0;f<e;f++){const i=t[f];for(n=a[i],g=0;g<e;g++){if(f===g)continue;const e=t[g];v=o[i],b=o[e];Math.abs(d.angleVec3(v,b)/d.DEGTORAD)<s&&(n[0]+=b[0],n[1]+=b[1],n[2]+=b[2],n[3]+=1)}}}for(f=0,m=e.length;f<m;f+=3)n=a[f/3],e[f+0]=n[0]/n[3],e[f+1]=n[1]/n[3],e[f+2]=n[2]/n[3]},transformRay:(()=>{const t=new l(4),e=new l(4);return(i,s,r,o,a)=>{t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=1,d.transformVec4(i,t,e),o[0]=e[0],o[1]=e[1],o[2]=e[2],t[0]=r[0],t[1]=r[1],t[2]=r[2],d.transformVec3(i,t,e),d.normalizeVec3(e),a[0]=e[0],a[1]=e[1],a[2]=e[2]}})(),canvasPosToWorldRay:(()=>{const t=new l(16),e=new l(16),i=new l(4),s=new l(4),r=new l(4),o=new l(4);return(a,n,l,h,c,u)=>{const p=d.mulMat4(l,n,t),_=d.inverseMat4(p,e),f=a.width,g=a.height,m=(h[0]-f/2)/(f/2),v=-(h[1]-g/2)/(g/2);i[0]=m,i[1]=v,i[2]=-1,i[3]=1,d.transformVec4(_,i,s),d.mulVec4Scalar(s,1/s[3]),r[0]=m,r[1]=v,r[2]=1,r[3]=1,d.transformVec4(_,r,o),d.mulVec4Scalar(o,1/o[3]),c[0]=o[0],c[1]=o[1],c[2]=o[2],d.subVec3(o,s,u),d.normalizeVec3(u)}})(),canvasPosToLocalRay:(()=>{const t=new l(3),e=new l(3);return(i,s,r,o,a,n,l)=>{d.canvasPosToWorldRay(i,s,r,a,t,e),d.worldRayToLocalRay(o,t,e,n,l)}})(),worldRayToLocalRay:(()=>{const t=new l(16),e=new l(4),i=new l(4);return(s,r,o,a,n)=>{const l=d.inverseMat4(s,t);e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=1,d.transformVec4(l,e,i),a[0]=i[0],a[1]=i[1],a[2]=i[2],d.transformVec3(l,o,n)}})(),buildKDTree:(()=>{const t=new Float32Array;function e(i,s,r,o){const a=new l(6),n={triangles:null,left:null,right:null,leaf:!1,splitDim:0,aabb:a};let h,c;for(a[0]=a[1]=a[2]=Number.POSITIVE_INFINITY,a[3]=a[4]=a[5]=Number.NEGATIVE_INFINITY,h=0,c=i.length;h<c;++h){var u=3*i[h];for(let t=0;t<3;++t){const e=3*s[u+t];r[e]<a[0]&&(a[0]=r[e]),r[e]>a[3]&&(a[3]=r[e]),r[e+1]<a[1]&&(a[1]=r[e+1]),r[e+1]>a[4]&&(a[4]=r[e+1]),r[e+2]<a[2]&&(a[2]=r[e+2]),r[e+2]>a[5]&&(a[5]=r[e+2])}}if(i.length<20||o>10)return n.triangles=i,n.leaf=!0,n;t[0]=a[3]-a[0],t[1]=a[4]-a[1],t[2]=a[5]-a[2];let d=0;t[1]>t[d]&&(d=1),t[2]>t[d]&&(d=2),n.splitDim=d;const p=(a[d]+a[d+3])/2,_=new Array(i.length);let f=0;const g=new Array(i.length);let m=0;for(h=0,c=i.length;h<c;++h){const t=s[u=3*i[h]],e=3*s[u+1],o=3*s[u+2];r[3*t+d]<=p||r[e+d]<=p||r[o+d]<=p?_[f++]=i[h]:g[m++]=i[h]}return _.length=f,g.length=m,n.left=e(_,s,r,o+1),n.right=e(g,s,r,o+1),n}return(t,i)=>{const s=t.length/3,r=new Array(s);for(let t=0;t<s;++t)r[t]=t;return e(r,t,i,0)}})(),decompressPosition(t,e,i){(i=i||t)[0]=t[0]*e[0]+e[12],i[1]=t[1]*e[5]+e[13],i[2]=t[2]*e[10]+e[14]},decompressPositions(t,e,i=new Float32Array(t.length)){for(let s=0,r=t.length;s<r;s+=3)i[s+0]=t[s+0]*e[0]+e[12],i[s+1]=t[s+1]*e[5]+e[13],i[s+2]=t[s+2]*e[10]+e[14];return i},decompressUV(t,e,i){i[0]=t[0]*e[0]+e[6],i[1]=t[1]*e[4]+e[7]},decompressUVs(t,e,i=new Float32Array(t.length)){for(let s=0,r=t.length;s<r;s+=3)i[s+0]=t[s+0]*e[0]+e[6],i[s+1]=t[s+1]*e[4]+e[7];return i},octDecodeVec2(t,e){let i=t[0],s=t[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const o=Math.sqrt(i*i+s*s+r*r);return e[0]=i/o,e[1]=s/o,e[2]=r/o,e},octDecodeVec2s(t,e){for(let i=0,s=0,r=t.length;i<r;i+=2){let r=t[i+0],o=t[i+1];r=(2*r+1)/255,o=(2*o+1)/255;const a=1-Math.abs(r)-Math.abs(o);a<0&&(r=(1-Math.abs(o))*(r>=0?1:-1),o=(1-Math.abs(r))*(o>=0?1:-1));const n=Math.sqrt(r*r+o*o+a*a);e[s+0]=r/n,e[s+1]=o/n,e[s+2]=a/n,s+=3}return e}};d.buildEdgeIndices=function(){const t=[],e=[],i=[],s=[],r=[];let o=0;const a=new Uint16Array(3),n=new Uint16Array(3),l=new Uint16Array(3),h=d.vec3(),c=d.vec3(),u=d.vec3(),p=d.vec3(),_=d.vec3(),f=d.vec3(),g=d.vec3();return function(m,v,b,P){!function(r,o){const a={};let n,l,h,c;const u=Math.pow(10,4);let d,p,_=0;for(d=0,p=r.length;d<p;d+=3)n=r[d],l=r[d+1],h=r[d+2],c=Math.round(n*u)+"_"+Math.round(l*u)+"_"+Math.round(h*u),void 0===a[c]&&(a[c]=_/3,t[_++]=n,t[_++]=l,t[_++]=h),e[d/3]=a[c];for(d=0,p=o.length;d<p;d++)s[d]=e[o[d]],i[s[d]]=o[d]}(m,v),function(e,i){o=0;for(let m=0,v=e;m<v;m+=3){const e=3*s[m],v=3*s[m+1],b=3*s[m+2];i?(a[0]=t[e],a[1]=t[e+1],a[2]=t[e+2],n[0]=t[v],n[1]=t[v+1],n[2]=t[v+2],l[0]=t[b],l[1]=t[b+1],l[2]=t[b+2],d.decompressPosition(a,i,h),d.decompressPosition(n,i,c),d.decompressPosition(l,i,u)):(h[0]=t[e],h[1]=t[e+1],h[2]=t[e+2],c[0]=t[v],c[1]=t[v+1],c[2]=t[v+2],u[0]=t[b],u[1]=t[b+1],u[2]=t[b+2]),d.subVec3(u,c,p),d.subVec3(h,c,_),d.cross3Vec3(p,_,f),d.normalizeVec3(f,g);const P=r[o]||(r[o]={normal:d.vec3()});P.normal[0]=g[0],P.normal[1]=g[1],P.normal[2]=g[2],o++}}(v.length,b);const y=[],M=Math.cos(d.DEGTORAD*P),x={};let w,E,A,C,S,D,L,B,R,T,F,N=!1;for(let t=0,e=v.length;t<e;t+=3){const e=t/3;for(let i=0;i<3;i++)w=s[t+i],E=s[t+(i+1)%3],A=Math.min(w,E),C=Math.max(w,E),S=A+","+C,void 0===x[S]?x[S]={index1:A,index2:C,face1:e,face2:void 0}:x[S].face2=e}for(S in x)D=x[S],void 0!==D.face2&&(L=r[D.face1].normal,B=r[D.face2].normal,R=d.dotVec3(L,B),R>M)||(T=i[D.index1],F=i[D.index2],(!N&&T>65535||F>65535)&&(N=!0),y.push(T),y.push(F));return N?new Uint32Array(y):new Uint16Array(y)}}();class p{constructor(){this._head=[],this._headLength=0,this._tail=[],this._index=0,this._length=0}get length(){return this._length}shift(){if(this._index>=this._headLength){const t=this._head;if(t.length=0,this._head=this._tail,this._tail=t,this._index=0,this._headLength=this._head.length,!this._headLength)return}const t=this._head[this._index];return this._index<0?delete this._head[this._index++]:this._head[this._index++]=void 0,this._length--,t}push(t){return this._length++,this._tail.push(t),this}unshift(t){return this._head[--this._index]=t,this._length++,this}}const _={build:{version:"0.8"},client:{browser:navigator&&navigator.userAgent?navigator.userAgent:"n/a"},components:{scenes:0,models:0,meshes:0,objects:0},memory:{meshes:0,positions:0,colors:0,normals:0,uvs:0,indices:0,textures:0,transforms:0,materials:0,programs:0},frame:{frameCount:0,fps:0,useProgram:0,bindTexture:0,bindArray:0,drawElements:0,drawArrays:0,tasksRun:0,tasksScheduled:0}};var f=[["0",10],["A",26],["a",26],["_",1],["$",1]].map((function(t){for(var e=[],i=t[0].charCodeAt(0),s=i+t[1],r=i;r<s;++r)e.push(r);return String.fromCharCode.apply(null,e)})).join("");function g(t,e){return(e&&4!==e?[0,6]:[0,6,12,18]).map((function(e){return f.substr(parseInt(t/(1<<e))%64,1)})).reverse().join("")}const m={xmlToJson:function t(e,i){if(e.nodeType===e.TEXT_NODE){var s=e.nodeValue;if(null===s.match(/^\s+$/))return s}else if(e.nodeType===e.ELEMENT_NODE||e.nodeType===e.DOCUMENT_NODE){var r={type:e.nodeName,children:[]};if(e.nodeType===e.ELEMENT_NODE)for(var o=0;o<e.attributes.length;o++){var a=e.attributes[o];r[i[a.nodeName]||a.nodeName]=a.nodeValue}for(var n=0;n<e.childNodes.length;n++){(o=t(e.childNodes[n],i))&&r.children.push(o)}return r}},clone:function(t){return JSON.parse(JSON.stringify(t))},compressGuid:function(t){var e=[0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30].map((function(e){return parseInt(t.substr(e,2),16)}));return g(e[0],2)+[1,4,7,10,13].map((function(t){return g((e[t]<<16)+(e[t+1]<<8)+e[t+2])})).join("")},findNodeOfType:function(t,e){var i=[],s=function(t){t.type===e&&i.push(t),(t.children||[]).forEach((function(t){s(t)}))};return s(t),i},timeout:function(t){return new Promise((function(e,i){setTimeout(e,t)}))},httpRequest:function(t){return new Promise((function(e,i){var s=new XMLHttpRequest;s.open(t.method||"GET",t.url,!0),s.onload=function(r){console.log(t.url,s.readyState,s.status),4===s.readyState&&(200===s.status?e(s.responseXML):i(s.statusText))},s.send(null)}))},loadJSON:function(t,e,i){var s=t=>{};e=e||s,i=i||s;var r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.open("GET",t,!0),r.addEventListener("load",(function(t){var s=t.target.response;if(200===this.status){var r;try{r=JSON.parse(s)}catch(t){i(`utils.loadJSON(): Failed to parse JSON response - ${t}`)}e(r)}else if(0===this.status){console.warn("loadFile: HTTP Status 0 received.");try{e(JSON.parse(s))}catch(t){i(`utils.loadJSON(): Failed to parse JSON response - ${t}`)}}else i(t)}),!1),r.addEventListener("error",(function(t){i(t)}),!1),r.send(null)},loadArraybuffer:function(t,e,i){var s=t=>{};e=e||s,i=i||s;const r=t.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const t=!!r[2];var o=r[3];o=window.decodeURIComponent(o),t&&(o=window.atob(o));try{const t=new ArrayBuffer(o.length),i=new Uint8Array(t);for(var a=0;a<o.length;a++)i[a]=o.charCodeAt(a);window.setTimeout((function(){e(t)}),0)}catch(t){window.setTimeout((function(){i(t)}),0)}}else{const s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?e(s.response):i("loadArrayBuffer error : "+s.response))},s.send(null)}},queryString:function(){for(var t={},e=window.location.search.substring(1).split("&"),i=0;i<e.length;i++){var s=e[i].split("=");if(void 0===t[s[0]])t[s[0]]=decodeURIComponent(s[1]);else if("string"==typeof t[s[0]]){var r=[t[s[0]],decodeURIComponent(s[1])];t[s[0]]=r}else t[s[0]].push(decodeURIComponent(s[1]))}return t}(),isArray:function(t){return t&&!t.propertyIsEnumerable("length")&&"object"==typeof t&&"number"==typeof t.length},isString:function(t){return"string"==typeof t||t instanceof String},isNumeric:function(t){return!isNaN(parseFloat(t))&&isFinite(t)},isID:function(t){return m.isString(t)||m.isNumeric(t)},isSameComponent:function(t,e){return!(!t||!e)&&(m.isNumeric(t)||m.isString(t)?`${t}`:t.id)===(m.isNumeric(e)||m.isString(e)?`${e}`:e.id)},isFunction:function(t){return"function"==typeof t},isObject:function(t){const e={}.constructor;return!!t&&t.constructor===e},copy:function(t){return m.apply(t,{})},apply:function(t,e){for(const i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},apply2:function(t,e){for(const i in t)t.hasOwnProperty(i)&&void 0!==t[i]&&null!==t[i]&&(e[i]=t[i]);return e},applyIf:function(t,e){for(const i in t)t.hasOwnProperty(i)&&(void 0!==e[i]&&null!==e[i]||(e[i]=t[i]));return e},isEmptyObject:function(t){for(const e in t)if(t.hasOwnProperty(e))return!1;return!0},inQuotes:function(t){return m.isNumeric(t)?`${t}`:`'${t}'`},concat:function(t,e){const i=new t.constructor(t.length+e.length);return i.set(t),i.set(e,t.length),i},flattenParentChildHierarchy:function(t){var e=[];return function t(i){i.id=i.uuid,delete i.oid,e.push(i);var s=i.children;if(s)for(var r=0,o=s.length;r<o;r++){s[r].parent=i.id,t(s[r])}i.children=[]}(t),e}},v={},b=new t,P=new p,y={sceneId:null,time:null,startTime:null,prevTime:null,deltaTime:null},M=[];let x,w=0,E=0;const A=new function(){this.version="1.0.0",this.scenes={},this._superTypes={},this._addScene=function(t){if(t.id){if(A.scenes[t.id])return void console.error(`[ERROR] Scene ${m.inQuotes(t.id)} already exists`)}else t.id=b.addItem({});A.scenes[t.id]=t;const e=t.ticksPerOcclusionTest,i=t.ticksPerRender;v[t.id]={ticksPerOcclusionTest:e,ticksPerRender:i,renderCountdown:i},_.components.scenes++,t.once("destroyed",(()=>{b.removeItem(t.id),delete A.scenes[t.id],delete v[t.id],_.components.scenes--}))},this.clear=function(){let t;for(const e in A.scenes)A.scenes.hasOwnProperty(e)&&(t=A.scenes[e],"default.scene"===e?t.clear():(t.destroy(),delete A.scenes[t.id]))},this.scheduleTask=function(t,e){P.push(t),P.push(e)},this.runTasks=function(t=-1){let e,i,s=(new Date).getTime(),r=0;for(;P.length>0&&(t<0||s<t);)e=P.shift(),i=P.shift(),i?e.call(i):e(),s=(new Date).getTime(),r++;return r},this.getNumTasks=function(){return P.length}},C=function(){let t=Date.now();if(w>0){x=t-w;var e=1e3/x;E+=e,M.push(e),M.length>=30&&(E-=M.shift()),_.frame.fps=Math.round(E/M.length)}!function(t){const e=A.runTasks(t+10),i=A.getNumTasks();_.frame.tasksRun=e,_.frame.tasksScheduled=i,_.frame.tasksBudget=10}(t),function(t){for(var e in y.time=t,A.scenes)if(A.scenes.hasOwnProperty(e)){var i=A.scenes[e];y.sceneId=e,y.startTime=i.startTime,y.deltaTime=null!=y.prevTime?y.time-y.prevTime:0,i.fire("tick",y,!0)}y.prevTime=t}(t),function(){const t=A.scenes,e=!1;let i,s,r,o,a;for(a in t)t.hasOwnProperty(a)&&(i=t[a],s=v[a],s||(s=v[a]={}),r=i.ticksPerOcclusionTest,s.ticksPerOcclusionTest!==r&&(s.ticksPerOcclusionTest=r,s.renderCountdown=r),--i.occlusionTestCountdown<=0&&(i.doOcclusionTest(),i.occlusionTestCountdown=r),o=i.ticksPerRender,s.ticksPerRender!==o&&(s.ticksPerRender=o,s.renderCountdown=o),0==--s.renderCountdown&&(i.render(e),s.renderCountdown=o))}(),w=t,void 0!==window.requestPostAnimationFrame?window.requestPostAnimationFrame(C):requestAnimationFrame(C)};void 0!==window.requestPostAnimationFrame?window.requestPostAnimationFrame(C):requestAnimationFrame(C);class S{get type(){return"Component"}get isComponent(){return!0}constructor(t=null,e={}){if(this.scene=null,"Scene"===this.type)this.scene=this,this.viewer=e.viewer;else{if("Scene"===t.type)this.scene=t;else{if(!(t instanceof S))throw"Invalid param: owner must be a Component";this.scene=t.scene}this._owner=t,this._renderer=this.scene._renderer}this._dontClear=!!e.dontClear,this._renderer=this.scene._renderer,this.meta=e.meta||{},this.id=e.id,this.destroyed=!1,this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._eventSubsNum=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this!==this.scene&&this.scene._addComponent(this),this._updateScheduled=!1,t&&t._own(this)}glRedraw(){this._renderer&&(this._renderer.imageDirty(),this.castsShadow&&this._renderer.shadowsDirty())}glResort(){this._renderer&&this._renderer.needStateSort()}get owner(){return this._owner}isType(t){return this.type===t}fire(t,e,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={},this._eventSubsNum={}),!0!==i&&(this._events[t]=e||!0);const s=this._eventSubs[t];let r;if(s)for(const i in s)s.hasOwnProperty(i)&&(r=s[i],this._eventCallDepth++,this._eventCallDepth<300?r.callback.call(r.scope,e):this.error("fire: potential stack overflow from recursive event '"+t+"' - dropping this event"),this._eventCallDepth--)}on(e,i,s){this._events||(this._events={}),this._subIdMap||(this._subIdMap=new t),this._subIdEvents||(this._subIdEvents={}),this._eventSubs||(this._eventSubs={}),this._eventSubsNum||(this._eventSubsNum={});let r=this._eventSubs[e];r?this._eventSubsNum[e]++:(r={},this._eventSubs[e]=r,this._eventSubsNum[e]=1);const o=this._subIdMap.addItem();r[o]={callback:i,scope:s||this},this._subIdEvents[o]=e;const a=this._events[e];return void 0!==a&&i.call(s||this,a),o}off(t){if(null==t)return;if(!this._subIdEvents)return;const e=this._subIdEvents[t];if(e){delete this._subIdEvents[t];const i=this._eventSubs[e];i&&(delete i[t],this._eventSubsNum[e]--),this._subIdMap.removeItem(t)}}once(t,e,i){const s=this,r=this.on(t,(function(t){s.off(r),e.call(i||this,t)}),i)}hasSubs(t){return this._eventSubsNum&&this._eventSubsNum[t]>0}log(t){t="[LOG]"+this._message(t),window.console.log(t),this.scene.fire("log",t)}_message(t){return" ["+this.type+" "+m.inQuotes(this.id)+"]: "+t}warn(t){t="[WARN]"+this._message(t),window.console.warn(t),this.scene.fire("warn",t)}error(t){t="[ERROR]"+this._message(t),window.console.error(t),this.scene.fire("error",t)}_attach(t){const e=t.name;if(!e)return void this.error("Component 'name' expected");let i=t.component;const s=t.sceneDefault,r=t.sceneSingleton,o=t.type,a=t.on,n=!1!==t.recompiles;if(i&&(m.isNumeric(i)||m.isString(i))){const t=i;if(i=this.scene.components[t],!i)return void this.error("Component not found: "+m.inQuotes(t))}if(!i)if(!0===r){const t=this.scene.types[o];for(const e in t)if(t.hasOwnProperty){i=t[e];break}if(!i)return this.error("Scene has no default component for '"+e+"'"),null}else if(!0===s&&(i=this.scene[e],!i))return this.error("Scene has no default component for '"+e+"'"),null;if(i){if(i.scene.id!==this.scene.id)return void this.error("Not in same scene: "+i.type+" "+m.inQuotes(i.id));if(o&&!i.isType(o))return void this.error("Expected a "+o+" type or subtype: "+i.type+" "+m.inQuotes(i.id))}this._attachments||(this._attachments={});const l=this._attached[e];let h,c,u;if(l){if(i&&l.id===i.id)return;const t=this._attachments[l.id];for(h=t.subs,c=0,u=h.length;c<u;c++)l.off(h[c]);delete this._attached[e],delete this._attachments[l.id];const s=t.params.onDetached;s&&(m.isFunction(s)?s(l):s.scope?s.callback.call(s.scope,l):s.callback(l)),t.managingLifecycle&&l.destroy()}if(i){const s={params:t,component:i,subs:[],managingLifecycle:false};s.subs.push(i.once("destroyed",(function(){s.params.component=null,this._attach(s.params)}),this)),n&&s.subs.push(i.on("dirty",(function(){this.fire("dirty",this)}),this)),this._attached[e]=i,this._attachments[i.id]=s;const r=t.onAttached;if(r&&(m.isFunction(r)?r(i):r.scope?r.callback.call(r.scope,i):r.callback(i)),a){let t,e,r,o;for(t in a)if(a.hasOwnProperty(t)){if(e=a[t],m.isFunction(e)?(r=e,o=null):(r=e.callback,o=e.scope),!r)continue;s.subs.push(i.on(t,r,o))}}}return n&&this.fire("dirty",this),this.fire(e,i),i}_checkComponent(t,e){if(!e.isComponent){if(!m.isID(e))return void this.error("Expected a Component or ID");{const t=e;if(!(e=this.scene.components[t]))return void this.error("Component not found: "+t)}}if(t===e.type){if(e.scene.id===this.scene.id)return e;this.error("Not in same scene: "+e.type)}else this.error("Expected a "+t+" Component")}_checkComponent2(t,e){if(!e.isComponent){if(!m.isID(e))return void this.error("Expected a Component or ID");{const t=e;if(!(e=this.scene.components[t]))return void this.error("Component not found: "+t)}}if(e.scene.id===this.scene.id){for(var i=0,s=t.length;i<s;i++)if(t[i]===e.type)return e;return this.error("Expected component types: "+t),null}this.error("Not in same scene: "+e.type)}_own(t){this._ownedComponents||(this._ownedComponents={}),this._ownedComponents[t.id]||(this._ownedComponents[t.id]=t),t.once("destroyed",(()=>{delete this._ownedComponents[t.id]}),this)}_needUpdate(t){this._updateScheduled||(this._updateScheduled=!0,0===t?this._doUpdate():A.scheduleTask(this._doUpdate,this))}_doUpdate(){this._updateScheduled&&(this._updateScheduled=!1,this._update&&this._update())}_update(){}clear(){if(this._ownedComponents)for(var t in this._ownedComponents)if(this._ownedComponents.hasOwnProperty(t)){this._ownedComponents[t].destroy(),delete this._ownedComponents[t]}}destroy(){if(this.destroyed)return;let t,e,i,s,r,o;if(this.fire("destroyed",this.destroyed=!0),this._attachments)for(t in this._attachments)if(this._attachments.hasOwnProperty(t)){for(e=this._attachments[t],i=e.component,s=e.subs,r=0,o=s.length;r<o;r++)i.off(s[r]);e.managingLifecycle&&i.destroy()}if(this._ownedComponents)for(t in this._ownedComponents)this._ownedComponents.hasOwnProperty(t)&&(i=this._ownedComponents[t],i.destroy(),delete this._ownedComponents[t]);this.scene._removeComponent(this),this._attached={},this._attachments=null,this._subIdMap=null,this._subIdEvents=null,this._eventSubs=null,this._events=null,this._eventCallDepth=0,this._ownedComponents=null,this._updateScheduled=!1}}const D=1,L=4,B=8,R=16,T=32,F=256,N=512,I=1024,k=2048,O=new Float32Array([0,0,0]),V=new Uint16Array([0,0,0]);class z{constructor(t,e,i,s,r,o){this._isObject=e,this.scene=t.scene,this.model=t,this.meshes=s,this._numTriangles=0;for(var a=0,n=this.meshes.length;a<n;a++){const t=this.meshes[a];t.parent=this,this._numTriangles+=t.numTriangles}this.id=i,this.originalSystemId=d.unglobalizeObjectId(t.id,i),this._flags=r,this._aabb=o,this._offsetAABB=d.AABB3(o),this._offset=d.vec3(),this._colorizeUpdated=!1,this._opacityUpdated=!1,this._isObject&&t.scene._registerObject(this)}get isEntity(){return!0}get isModel(){return!1}get isObject(){return this._isObject}get aabb(){return this._offsetAABB}get numTriangles(){return this._numTriangles}get visible(){return this._getFlag(D)}set visible(t){if(!!(this._flags&D)!==t){this._flags=t?this._flags|D:this._flags&~D;for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setVisible(this._flags);this._isObject&&this.model.scene._objectVisibilityUpdated(this),this.model.glRedraw()}}get highlighted(){return this._getFlag(N)}set highlighted(t){if(!!(this._flags&N)!==t){this._flags=t?this._flags|N:this._flags&~N;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setHighlighted(this._flags);this._isObject&&this.model.scene._objectHighlightedUpdated(this),this.model.glRedraw()}}get xrayed(){return this._getFlag(F)}set xrayed(t){if(!!(this._flags&F)!==t){this._flags=t?this._flags|F:this._flags&~F;for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setXRayed(this._flags);this._isObject&&this.model.scene._objectXRayedUpdated(this),this.model.glRedraw()}}get selected(){return this._getFlag(I)}set selected(t){if(!!(this._flags&I)!==t){this._flags=t?this._flags|I:this._flags&~I;for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setSelected(this._flags);this._isObject&&this.model.scene._objectSelectedUpdated(this),this.model.glRedraw()}}get edges(){return this._getFlag(k)}set edges(t){if(!!(this._flags&k)!==t){this._flags=t?this._flags|k:this._flags&~k;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setEdges(this._flags);this.model.glRedraw()}}get culled(){return this._getFlag(L)}set culled(t){if(!!(this._flags&L)!==t){this._flags=t?this._flags|L:this._flags&~L;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setCulled(this._flags);this.model.glRedraw()}}get clippable(){return this._getFlag(R)}set clippable(t){if(!!(this._flags&R)!==t){this._flags=t?this._flags|R:this._flags&~R;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setClippable(this._flags);this.model.glRedraw()}}get collidable(){return this._getFlag(T)}set collidable(t){if(!!(this._flags&T)!==t){this._flags=t?this._flags|T:this._flags&~T;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setCollidable(this._flags)}}get pickable(){return this._getFlag(B)}set pickable(t){if(!!(this._flags&B)!==t){this._flags=t?this._flags|B:this._flags&~B;for(var e=0,i=this.meshes.length;e<i;e++)this.meshes[e]._setPickable(this._flags)}}get colorize(){if(0===this.meshes.length)return null;const t=this.meshes[0]._colorize;return O[0]=t[0]/255,O[1]=t[1]/255,O[2]=t[2]/255,O}set colorize(t){if(t){V[0]=Math.floor(255*t[0]),V[1]=Math.floor(255*t[1]),V[2]=Math.floor(255*t[2]);for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setColorize(V)}else for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setColorize(null);if(this._isObject){const e=!!t;this.scene._objectColorizeUpdated(this,e),this._colorizeUpdated=e}this.model.glRedraw()}get opacity(){return this.meshes.length>0?this.meshes[0]._colorize[3]/255:1}set opacity(t){if(0===this.meshes.length)return;const e=null!=t,i=this.meshes[0]._colorize[3];let s=255;if(e){if(t<0?t=0:t>1&&(t=1),s=Math.floor(255*t),i===s)return}else if(s=255,i===s)return;for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setOpacity(s,this._flags);this._isObject&&(this.scene._objectOpacityUpdated(this,e),this._opacityUpdated=e),this.model.glRedraw()}get offset(){return this._offset}set offset(t){t?(this._offset[0]=t[0],this._offset[1]=t[1],this._offset[2]=t[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._setOffset(this._offset);this._offsetAABB[0]=this._aabb[0]+this._offset[0],this._offsetAABB[1]=this._aabb[1]+this._offset[1],this._offsetAABB[2]=this._aabb[2]+this._offset[2],this._offsetAABB[3]=this._aabb[3]+this._offset[0],this._offsetAABB[4]=this._aabb[4]+this._offset[1],this._offsetAABB[5]=this._aabb[5]+this._offset[2],this.scene._aabbDirty=!0,this.scene._objectOffsetUpdated(this,t),this.model._aabbDirty=!0,this.model.glRedraw()}get castsShadow(){return!1}set castsShadow(t){}get receivesShadow(){return!1}set receivesShadow(t){}get saoEnabled(){return this.model.saoEnabled}_getFlag(t){return!!(this._flags&t)}_finalize(){const t=this.model.scene;this._isObject&&(this.visible&&t._objectVisibilityUpdated(this),this.highlighted&&t._objectHighlightedUpdated(this),this.xrayed&&t._objectXRayedUpdated(this),this.selected&&t._objectSelectedUpdated(this));for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._finalize(this._flags)}_finalize2(){for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._finalize2()}_destroy(){const t=this.model.scene;this._isObject&&(t._deregisterObject(this),this.visible&&t._objectVisibilityUpdated(this,!1),this.xrayed&&t._objectXRayedUpdated(this),this.selected&&t._objectSelectedUpdated(this),this.highlighted&&t._objectHighlightedUpdated(this),this._opacityUpdated&&this.scene._objectColorizeUpdated(this,!1),this._opacityUpdated&&this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1));for(let t=0,e=this.meshes.length;t<e;t++)this.meshes[t]._destroy();t._aabbDirty=!0}}const U=d.vec3(),G=function(){const t=new Float32Array(16),e=new Float64Array(4),i=new Float64Array(4);return function(s,r,o=t){return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=1,d.transformVec4(s,e,i),d.setMat4Translation(s,i,o),o}}();function j(t,e,i){const s=Float32Array.from([t[0]])[0],r=t[0]-s,o=Float32Array.from([t[1]])[0],a=t[1]-o,n=Float32Array.from([t[2]])[0],l=t[2]-n;e[0]=s,e[1]=o,e[2]=n,i[0]=r,i[1]=a,i[2]=l}function X(t,e,i,s=1e6){const r=d.getPositionsCenter(t,U),o=Math.round(r[0]/s)*s,a=Math.round(r[1]/s)*s,n=Math.round(r[2]/s)*s;i[0]=o,i[1]=a,i[2]=n;const l=0!==i[0]||0!==i[1]||0!==i[2];if(l)for(let i=0,s=t.length;i<s;i+=3)e[i+0]=t[i+0]-o,e[i+1]=t[i+1]-a,e[i+2]=t[i+2]-n;return l}function W(t,e,i,s){const r=d.dotVec3(e,i)+t,o=d.normalizeVec3(e,U);return d.mulVec3Scalar(o,-r,s),s}const H=d.vec4(),Y=d.vec4();class K extends S{constructor(t,e){super(t,e),this._entity=null,this._visible=null,this._worldPos=d.vec3(),this._origin=d.vec3(),this._rtcPos=d.vec3(),this._viewPos=d.vec3(),this._canvasPos=d.vec2(),this._occludable=!1,this._onCameraViewMatrix=this.scene.camera.on("matrix",(()=>{this._viewPosDirty=!0,this._needUpdate()})),this._onCameraProjMatrix=this.scene.camera.on("projMatrix",(()=>{this._canvasPosDirty=!0,this._needUpdate()})),this._onEntityDestroyed=null,this._onEntityModelDestroyed=null,this._renderer.addMarker(this),this.entity=e.entity,this.worldPos=e.worldPos,this.occludable=e.occludable}_update(){if(this._viewPosDirty&&(d.transformPoint3(this.scene.camera.viewMatrix,this._worldPos,this._viewPos),this._viewPosDirty=!1,this._canvasPosDirty=!0,this.fire("viewPos",this._viewPos)),this._canvasPosDirty){H.set(this._viewPos),H[3]=1,d.transformPoint4(this.scene.camera.projMatrix,H,Y);const t=this.scene.canvas.boundary;this._canvasPos[0]=Math.floor((1+Y[0]/Y[3])*t[2]/2),this._canvasPos[1]=Math.floor((1-Y[1]/Y[3])*t[3]/2),this._canvasPosDirty=!1,this.fire("canvasPos",this._canvasPos)}}_setVisible(t){this._visible,this._visible=t,this.fire("visible",this._visible)}set entity(t){if(this._entity){if(this._entity===t)return;null!==this._onEntityDestroyed&&(this._entity.off(this._onEntityDestroyed),this._onEntityDestroyed=null),null!==this._onEntityModelDestroyed&&(this._entity.model.off(this._onEntityModelDestroyed),this._onEntityModelDestroyed=null)}this._entity=t,this._entity&&(this._entity instanceof z?this._onEntityModelDestroyed=this._entity.model.on("destroyed",(()=>{this._entity=null,this._onEntityModelDestroyed=null})):this._onEntityDestroyed=this._entity.on("destroyed",(()=>{this._entity=null,this._onEntityDestroyed=null}))),this.fire("entity",this._entity,!0)}get entity(){return this._entity}set occludable(t){(t=!!t)!==this._occludable&&(this._occludable=t)}get occludable(){return this._occludable}set worldPos(t){this._worldPos.set(t||[0,0,0]),j(this._worldPos,this._origin,this._rtcPos),this._occludable&&this._renderer.markerWorldPosUpdated(this),this._viewPosDirty=!0,this.fire("worldPos",this._worldPos)}get worldPos(){return this._worldPos}get origin(){return this._origin}get rtcPos(){return this._rtcPos}get viewPos(){return this._update(),this._viewPos}get canvasPos(){return this._update(),this._canvasPos}get visible(){return!!this._visible}destroy(){this.fire("destroyed",!0),this.scene.camera.off(this._onCameraViewMatrix),this.scene.camera.off(this._onCameraProjMatrix),this._entity&&(null!==this._onEntityDestroyed&&this._entity.off(this._onEntityDestroyed),null!==this._onEntityModelDestroyed&&this._entity.model.off(this._onEntityModelDestroyed)),this._renderer.removeMarker(this),super.destroy()}}class q{constructor(t,e={}){this._wire=document.createElement("div"),this._wire.className+=this._wire.className?" viewer-ruler-wire":"viewer-ruler-wire";var i=this._wire,s=i.style;this._thickness=e.thickness||1,s.border="solid "+this._thickness+"px "+(e.color||"black"),s.position="absolute",s["z-index"]=void 0===e.zIndex?"2000001":e.zIndex,s.width="0px",s.height="0px",s.visibility="visible",s.top="0px",s.left="0px",s["pointer-events"]="none",s["-webkit-transform-origin"]="0 0",s["-moz-transform-origin"]="0 0",s["-ms-transform-origin"]="0 0",s["-o-transform-origin"]="0 0",s["transform-origin"]="0 0",s["-webkit-transform"]="rotate(0deg)",s["-moz-transform"]="rotate(0deg)",s["-ms-transform"]="rotate(0deg)",s["-o-transform"]="rotate(0deg)",s.transform="rotate(0deg)",s.opacity=1,t.appendChild(i),this._x1=0,this._y1=0,this._x2=0,this._y2=0,this._update()}get _visible(){return"visible"===this._wire.style.visibility}_update(){var t=Math.abs(Math.sqrt((this._x1-this._x2)*(this._x1-this._x2)+(this._y1-this._y2)*(this._y1-this._y2))),e=180*Math.atan2(this._y2-this._y1,this._x2-this._x1)/Math.PI,i=this._wire.style;i.width=Math.round(t)+"px",i.left=Math.round(this._x1)+"px",i.top=Math.round(this._y1)+"px",i["-webkit-transform"]="rotate("+e+"deg)",i["-moz-transform"]="rotate("+e+"deg)",i["-ms-transform"]="rotate("+e+"deg)",i["-o-transform"]="rotate("+e+"deg)",i.transform="rotate("+e+"deg)",i["pointer-events"]="none"}setStartAndEnd(t,e,i,s){this._x1=t,this._y1=e,this._x2=i,this._y2=s,this._update()}setColor(t){this._wire.style.border="solid "+this._thickness+"px "+(t||"black")}setOpacity(t){this._wire.style.opacity=t}setVisible(t){t=!!t,this._visible!==t&&(this._wire.style.visibility=t?"visible":"hidden")}destroy(t){this._wire.parentElement.removeChild(this._wire)}}class Z{constructor(t,e={}){this._x=0,this._y=0,this._visible=!0,this._dot=document.createElement("div"),this._dot.className+=this._dot.className?" viewer-ruler-dot":"viewer-ruler-dot";var i=this._dot,s=i.style;s["border-radius"]="25px",s.border="solid 2px white",s.background="lightgreen",s.position="absolute",s["z-index"]=void 0===e.zIndex?"40000005":e.zIndex,s.width="8px",s.height="8px",s.visibility="visible",s.top="0px",s.left="0px",s["box-shadow"]="0 2px 5px 0 #182A3D;",s["pointer-events"]="none",s.opacity=1,t.appendChild(i),this.setPos(e.x||0,e.y||0),this.setFillColor(e.fillColor),this.setBorderColor(e.borderColor),this.setClickable(!1)}setPos(t,e){this._x=t,this._y=e;var i=this._dot.style;i.left=Math.round(t)-5+"px",i.top=Math.round(e)-5+"px"}setFillColor(t){this._dot.style.background=t||"lightgreen"}setBorderColor(t){this._dot.style.border="solid 2px"+(t||"black")}setOpacity(t){this._dot.style.opacity=t}setVisible(t){this._visible!==t&&(this._visible=!!t,this._dot.style.visibility=this._visible?"visible":"hidden")}setClickable(t){this._dot.style["pointer-events"]=t?"all":"none"}destroy(){this.setVisible(!1),this._dot.parentElement.removeChild(this._dot)}}class Q{constructor(t,e={}){this._prefix=e.prefix||"",this._x=0,this._y=0,this._visible=!0,this._label=document.createElement("div"),this._label.className+=this._label.className?" viewer-ruler-label":"viewer-ruler-label";var i=this._label,s=i.style;s["border-radius"]="5px",s.color="white",s.padding="4px",s.border="solid 0px white",s.background="lightgreen",s.position="absolute",s["z-index"]=void 0===e.zIndex?"5000005":e.zIndex,s.width="auto",s.height="auto",s.visibility="visible",s.top="0px",s.left="0px",s["pointer-events"]="none",s.opacity=1,i.innerText="",t.appendChild(i),this.setPos(e.x||0,e.y||0),this.setFillColor(e.fillColor),this.setBorderColor(e.borderColor),this.setText(e.text)}setPos(t,e){this._x=t,this._y=e;var i=this._label.style;i.left=Math.round(t)-20+"px",i.top=Math.round(e)-12+"px"}setPosOnWire(t,e,i,s){var r=t+.5*(i-t),o=e+.5*(s-e),a=this._label.style;a.left=Math.round(r)-20+"px",a.top=Math.round(o)-12+"px"}setPosBetweenWires(t,e,i,s,r,o){var a=(t+i+r)/3,n=(e+s+o)/3,l=this._label.style;l.left=Math.round(a)-20+"px",l.top=Math.round(n)-12+"px"}setText(t){this._label.innerHTML=this._prefix+(t||"")}setFillColor(t){this._label.style.background=t||"lightgreen"}setBorderColor(t){this._label.style.border="solid 2px"+(t||"black")}setOpacity(t){this._label.style.opacity=t}setVisible(t){this._visible!==t&&(this._visible=!!t,this._label.style.visibility=this._visible?"visible":"hidden")}destroy(){this._label.parentElement.removeChild(this._label)}}var $=d.vec3(),J=d.vec3();class tt extends S{constructor(t,e={}){if(super(t.viewer.scene,e),this.plugin=t,this._container=e.container,!this._container)throw"config missing: container";this._color=e.color||t.defaultColor;var i=this.plugin.viewer.scene;this._originMarker=new K(i,e.origin),this._cornerMarker=new K(i,e.corner),this._targetMarker=new K(i,e.target),this._originWorld=d.vec3(),this._cornerWorld=d.vec3(),this._targetWorld=d.vec3(),this._wp=new Float64Array(12),this._vp=new Float64Array(12),this._pp=new Float64Array(12),this._cp=new Int16Array(6),this._originDot=new Z(this._container,{fillColor:this._color,zIndex:t.zIndex+1}),this._cornerDot=new Z(this._container,{fillColor:this._color,zIndex:t.zIndex+1}),this._targetDot=new Z(this._container,{fillColor:this._color,zIndex:t.zIndex+1}),this._originWire=new q(this._container,{color:this._color||"blue",thickness:1,zIndex:t.zIndex}),this._targetWire=new q(this._container,{color:this._color||"red",thickness:1,zIndex:t.zIndex}),this._angleLabel=new Q(this._container,{fillColor:this._color||"#00BBFF",prefix:"",text:"",zIndex:t.zIndex+2}),this._wpDirty=!1,this._vpDirty=!1,this._cpDirty=!1,this._visible=!1,this._originVisible=!1,this._cornerVisible=!1,this._targetVisible=!1,this._originWireVisible=!1,this._targetWireVisible=!1,this._angleVisible=!1,this._originMarker.on("worldPos",(t=>{this._originWorld.set(t||[0,0,0]),this._wpDirty=!0,this._needUpdate(0)})),this._cornerMarker.on("worldPos",(t=>{this._cornerWorld.set(t||[0,0,0]),this._wpDirty=!0,this._needUpdate(0)})),this._targetMarker.on("worldPos",(t=>{this._targetWorld.set(t||[0,0,0]),this._wpDirty=!0,this._needUpdate(0)})),this._onViewMatrix=i.camera.on("viewMatrix",(()=>{this._vpDirty=!0,this._needUpdate(0)})),this._onProjMatrix=i.camera.on("projMatrix",(()=>{this._cpDirty=!0,this._needUpdate()})),this._onCanvasBoundary=i.canvas.on("boundary",(()=>{this._cpDirty=!0,this._needUpdate(0)})),this.approximate=e.approximate,this.visible=e.visible,this.originVisible=e.originVisible,this.cornerVisible=e.cornerVisible,this.targetVisible=e.targetVisible,this.originWireVisible=e.originWireVisible,this.targetWireVisible=e.targetWireVisible,this.angleVisible=e.angleVisible}_update(){if(!this._visible)return;const t=this.plugin.viewer.scene;if(this._wpDirty&&(this._wp[0]=this._originWorld[0],this._wp[1]=this._originWorld[1],this._wp[2]=this._originWorld[2],this._wp[3]=1,this._wp[4]=this._cornerWorld[0],this._wp[5]=this._cornerWorld[1],this._wp[6]=this._cornerWorld[2],this._wp[7]=1,this._wp[8]=this._targetWorld[0],this._wp[9]=this._targetWorld[1],this._wp[10]=this._targetWorld[2],this._wp[11]=1,this._wpDirty=!1,this._vpDirty=!0),this._vpDirty&&(d.transformPositions4(t.camera.viewMatrix,this._wp,this._vp),this._vp[3]=1,this._vp[7]=1,this._vp[11]=1,this._vpDirty=!1,this._cpDirty=!0),this._cpDirty){const p=-.3,_=this._originMarker.viewPos[2],f=this._cornerMarker.viewPos[2],g=this._targetMarker.viewPos[2];if(_>p||f>p||g>p)return this._originDot.setVisible(!1),this._cornerDot.setVisible(!1),this._targetDot.setVisible(!1),this._originWire.setVisible(!1),this._targetWire.setVisible(!1),void this._angleLabel.setVisible(!1);d.transformPositions4(t.camera.project.matrix,this._vp,this._pp);var e=this._pp,i=this._cp,s=t.canvas.canvas.getBoundingClientRect();const m=this._container.getBoundingClientRect();for(var r=s.top-m.top,o=s.left-m.left,a=t.canvas.boundary,n=a[2],l=a[3],h=0,c=0,u=e.length;c<u;c+=4)i[h]=o+Math.floor((1+e[c+0]/e[c+3])*n/2),i[h+1]=r+Math.floor((1-e[c+1]/e[c+3])*l/2),h+=2;if(this._originDot.setPos(i[0],i[1]),this._cornerDot.setPos(i[2],i[3]),this._targetDot.setPos(i[4],i[5]),this._originWire.setStartAndEnd(i[0],i[1],i[2],i[3]),this._targetWire.setStartAndEnd(i[2],i[3],i[4],i[5]),this._angleLabel.setPosBetweenWires(i[0],i[1],i[2],i[3],i[4],i[5]),d.subVec3(this._originWorld,this._cornerWorld,$),d.subVec3(this._targetWorld,this._cornerWorld,J),!(0===$[0]&&0===$[1]&&0===$[2]||0===J[0]&&0===J[1]&&0===J[2])){const t=this._approximate?" ~ ":" = ";d.normalizeVec3($),d.normalizeVec3(J);const e=Math.abs(d.angleVec3($,J));this._angle=e/d.DEGTORAD,this._angleLabel.setText(t+this._angle.toFixed(2)+"")}else this._angleLabel.setText("");this._originDot.setVisible(this._visible&&this._originVisible),this._cornerDot.setVisible(this._visible&&this._cornerVisible),this._targetDot.setVisible(this._visible&&this._targetVisible),this._originWire.setVisible(this._visible&&this._originWireVisible),this._targetWire.setVisible(this._visible&&this._targetWireVisible),this._angleLabel.setVisible(this._visible&&this._angleVisible),this._cpDirty=!1}}set approximate(t){t=!1!==t,this._approximate!==t&&(this._approximate=t,this._cpDirty=!0,this._needUpdate(0))}get approximate(){return this._approximate}get origin(){return this._originMarker}get corner(){return this._cornerMarker}get target(){return this._targetMarker}get angle(){return this._update(),this._angle}get color(){return this._color}set color(t){this._originDot.setFillColor(t),this._cornerDot.setFillColor(t),this._targetDot.setFillColor(t),this._originWire.setColor(t||"blue"),this._targetWire.setColor(t||"red"),this._angleLabel.setFillColor(t||"#00BBFF"),this._color=t}set visible(t){t=!1!==t,this._visible=t,this._originDot.setVisible(this._visible&&this._originVisible),this._cornerDot.setVisible(this._visible&&this._cornerVisible),this._targetDot.setVisible(this._visible&&this._targetVisible),this._originWire.setVisible(this._visible&&this._originWireVisible),this._targetWire.setVisible(this._visible&&this._targetWireVisible),this._angleLabel.setVisible(this._visible&&this._angleVisible)}get visible(){return this._visible}set originVisible(t){t=!1!==t,this._originVisible=t,this._originDot.setVisible(this._visible&&this._originVisible)}get originVisible(){return this._originVisible}set cornerVisible(t){t=!1!==t,this._cornerVisible=t,this._cornerDot.setVisible(this._visible&&this._cornerVisible)}get cornerVisible(){return this._cornerVisible}set targetVisible(t){t=!1!==t,this._targetVisible=t,this._targetDot.setVisible(this._visible&&this._targetVisible)}get targetVisible(){return this._targetVisible}set originWireVisible(t){t=!1!==t,this._originWireVisible=t,this._originWire.setVisible(this._visible&&this._originWireVisible)}get originWireVisible(){return this._originWireVisible}set targetWireVisible(t){t=!1!==t,this._targetWireVisible=t,this._targetWire.setVisible(this._visible&&this._targetWireVisible)}get targetWireVisible(){return this._targetWireVisible}set angleVisible(t){t=!1!==t,this._angleVisible=t,this._angleLabel.setVisible(this._visible&&this._angleVisible)}get angleVisible(){return this._angleVisible}destroy(){const t=this.plugin.viewer.scene;this._onViewMatrix&&t.camera.off(this._onViewMatrix),this._onProjMatrix&&t.camera.off(this._onProjMatrix),this._onCanvasBoundary&&t.canvas.off(this._onCanvasBoundary),this._originDot.destroy(),this._cornerDot.destroy(),this._targetDot.destroy(),this._originWire.destroy(),this._targetWire.destroy(),this._angleLabel.destroy(),super.destroy()}}class et extends S{constructor(t){super(t.viewer.scene),this.plugin=t,this._active=!1,this._state=0,this._currentAngleMeasurement=null,this._onhoverSurface=null,this._onPickedSurface=null,this._onHoverNothing=null,this._onPickedNothing=null}get active(){return this._active}activate(){if(this._active)return;this.startDot=new Z(this.plugin._container,{fillColor:this.plugin.defaultColor,zIndex:this.plugin.zIndex+1});const t=this.plugin.viewer.cameraControl;let e=!1,i=null,s=d.vec3();const r=d.vec2(),o=this.plugin.viewer.scene.pickSurfacePrecisionEnabled;let a,n;this._onhoverSurface=t.on("hoverSurface",(t=>{if(e=!0,i=t.entity,s.set(t.worldPos),r.set(t.canvasPos),0===this._state)return this.startDot&&(this.startDot.setVisible(!0),this.startDot.setPos(t.canvasPos[0],t.canvasPos[1])),void(this.plugin.viewer.scene.canvas.canvas.style.cursor="pointer");if(this._currentAngleMeasurement)switch(this._state){case 2:this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.cornerVisible=!0,this._currentAngleMeasurement.angleVisible=!1,this._currentAngleMeasurement.corner.entity=t.entity,this._currentAngleMeasurement.corner.worldPos=t.worldPos,this.plugin.viewer.scene.canvas.canvas.style.cursor="pointer";break;case 3:this._currentAngleMeasurement.targetWireVisible=!0,this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.angleVisible=!0,this._currentAngleMeasurement.target.entity=t.entity,this._currentAngleMeasurement.target.worldPos=t.worldPos,this.plugin.viewer.scene.canvas.canvas.style.cursor="pointer"}}));this._onInputMouseDown=this.plugin.viewer.scene.input.on("mousedown",(t=>{a=t[0],n=t[1]})),this._onInputMouseUp=this.plugin.viewer.scene.input.on("mouseup",(t=>{if(!(t[0]>a+5||t[0]<a-5||t[1]>n+5||t[1]<n-5))switch(this.startDot&&(this.startDot.destroy(),this.startDot=null),this._state){case 0:if(e){if(o){const t=this.plugin.viewer.scene.pick({canvasPos:r,pickSurface:!0,pickSurfacePrecision:!0});t&&t.worldPos&&s.set(t.worldPos)}this._currentAngleMeasurement=this.plugin.createMeasurement({id:d.createUUID(),origin:{entity:i,worldPos:s},corner:{entity:i,worldPos:s},target:{entity:i,worldPos:s},approximate:!0}),this._currentAngleMeasurement.originVisible=!0,this._currentAngleMeasurement.originWireVisible=!0,this._currentAngleMeasurement.cornerVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.angleVisible=!1,this._state=2,this.fire("measurementStart",this._currentAngleMeasurement)}break;case 2:if(e){if(o){const t=this.plugin.viewer.scene.pick({canvasPos:r,pickSurface:!0,pickSurfacePrecision:!0});t&&t.worldPos&&(this._currentAngleMeasurement.corner.worldPos=t.worldPos)}this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.angleVisible=!0,this._state=3}else this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null,this._state=0,this.fire("measurementCancel",this._currentAngleMeasurement));break;case 3:if(e){if(o){const t=this.plugin.viewer.scene.pick({canvasPos:r,pickSurface:!0,pickSurfacePrecision:!0});t&&t.worldPos&&(this._currentAngleMeasurement.target.worldPos=t.worldPos,this._currentAngleMeasurement.approximate=!1)}this._currentAngleMeasurement.targetVisible=!0,this._currentAngleMeasurement.angleVisible=!0,this.fire("measurementEnd",this._currentAngleMeasurement),this._currentAngleMeasurement=null,this._state=0}else this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null,this._state=0,this.fire("measurementCancel",this._currentAngleMeasurement))}})),this._onHoverNothing=t.on("hoverOff",(t=>{if(this.startDot&&this.startDot.setVisible(!1),e=!1,this._currentAngleMeasurement){switch(this._state){case 0:case 1:this._currentAngleMeasurement.originVisible=!1;break;case 2:this._currentAngleMeasurement.cornerVisible=!1,this._currentAngleMeasurement.originWireVisible=!1,this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1;break;case 3:this._currentAngleMeasurement.targetVisible=!1,this._currentAngleMeasurement.targetWireVisible=!1,this._currentAngleMeasurement.angleVisible=!1}this.plugin.viewer.scene.canvas.canvas.style.cursor="default"}})),this._active=!0}deactivate(){if(!this._active)return;this.startDot&&(this.startDot.destroy(),this.startDot=null),this.reset();const t=this.plugin.viewer.cameraControl,e=this.plugin.viewer.scene.input;e.off(this._onInputMouseDown),e.off(this._onInputMouseUp),t.off(this._onhoverSurface),t.off(this._onPickedSurface),t.off(this._onHoverNothing),t.off(this._onPickedNothing),this._currentAngleMeasurement=null,this._active=!1}reset(){this._active&&(this._currentAngleMeasurement&&(this._currentAngleMeasurement.destroy(),this._currentAngleMeasurement=null),this._state=0)}destroy(){this.deactivate(),super.destroy()}}class it extends a{constructor(t,e={}){super("AngleMeasurements",t),this._container=e.container||document.body,this._control=new et(this),this._measurements={},this.defaultColor=e.defaultColor,this.zIndex=e.zIndex}send(t,e){}get control(){return this._control}get measurements(){return this._measurements}createMeasurement(t={}){this.viewer.scene.components[t.id]&&(this.error("Viewer scene component with this ID already exists: "+t.id),delete t.id);const e=t.origin,i=t.corner,s=t.target,r=new tt(this,{id:t.id,plugin:this,container:this._container,origin:{entity:e.entity,worldPos:e.worldPos},corner:{entity:i.entity,worldPos:i.worldPos},target:{entity:s.entity,worldPos:s.worldPos},visible:t.visible,originVisible:!0,originWireVisible:!0,cornerVisible:!0,targetWireVisible:!0,targetVisible:!0});return this._measurements[r.id]=r,r.on("destroyed",(()=>{delete this._measurements[r.id]})),this.fire("measurementCreated",r),r}destroyMeasurement(t){const e=this._measurements[t];e?(e.destroy(),this.fire("measurementDestroyed",e)):this.log("AngleMeasurement not found: "+t)}clear(){const t=Object.keys(this._measurements);for(var e=0,i=t.length;e<i;e++)this.destroyMeasurement(t[e])}destroy(){this.clear(),super.destroy()}}class st extends K{constructor(t,e){if(super(t,e),this.plugin=e.plugin,this._container=e.container,!this._container)throw"config missing: container";if(!e.markerElement&&!e.markerHTML)throw"config missing: need either markerElement or markerHTML";if(!e.labelElement&&!e.labelHTML)throw"config missing: need either labelElement or labelHTML";this._htmlDirty=!1,e.markerElement?(this._marker=e.markerElement,this._marker.addEventListener("click",this._onMouseClickedExternalMarker=()=>{this.plugin.fire("markerClicked",this)}),this._marker.addEventListener("mouseenter",this._onMouseEnterExternalMarker=()=>{this.plugin.fire("markerMouseEnter",this)}),this._marker.addEventListener("mouseleave",this._onMouseLeaveExternalMarker=()=>{this.plugin.fire("markerMouseLeave",this)}),this._markerExternal=!0):(this._markerHTML=e.markerHTML,this._htmlDirty=!0,this._markerExternal=!1),e.labelElement?(this._label=e.labelElement,this._labelExternal=!0):(this._labelHTML=e.labelHTML,this._htmlDirty=!0,this._labelExternal=!1),this._markerShown=!!e.markerShown,this._labelShown=!!e.labelShown,this._values=e.values||{},this._layoutDirty=!0,this._visibilityDirty=!0,this._buildHTML(),this._onTick=this.scene.on("tick",(()=>{this._htmlDirty&&(this._buildHTML(),this._htmlDirty=!1,this._layoutDirty=!0,this._visibilityDirty=!0),(this._layoutDirty||this._visibilityDirty)&&(this._markerShown||this._labelShown)&&(this._updatePosition(),this._layoutDirty=!1),this._visibilityDirty&&(this._marker.style.visibility=this.visible&&this._markerShown?"visible":"hidden",this._label.style.visibility=this.visible&&this._markerShown&&this._labelShown?"visible":"hidden",this._visibilityDirty=!1)})),this.on("canvasPos",(()=>{this._layoutDirty=!0})),this.on("visible",(()=>{this._visibilityDirty=!0})),this.setMarkerShown(!1!==e.markerShown),this.setLabelShown(e.labelShown),this.eye=e.eye?e.eye.slice():null,this.look=e.look?e.look.slice():null,this.up=e.up?e.up.slice():null,this.projection=e.projection}_buildHTML(){if(!this._markerExternal){this._marker&&(this._container.removeChild(this._marker),this._marker=null);let t=this._markerHTML||"<p></p>";m.isArray(t)&&(t=t.join("")),t=this._renderTemplate(t);const e=document.createRange().createContextualFragment(t);this._marker=e.firstChild,this._container.appendChild(this._marker),this._marker.style.visibility=this._markerShown?"visible":"hidden",this._marker.addEventListener("click",(()=>{this.plugin.fire("markerClicked",this)})),this._marker.addEventListener("mouseenter",(()=>{this.plugin.fire("markerMouseEnter",this)})),this._marker.addEventListener("mouseleave",(()=>{this.plugin.fire("markerMouseLeave",this)}))}if(!this._labelExternal){this._label&&(this._container.removeChild(this._label),this._label=null);let t=this._labelHTML||"<p></p>";m.isArray(t)&&(t=t.join("")),t=this._renderTemplate(t);const e=document.createRange().createContextualFragment(t);this._label=e.firstChild,this._container.appendChild(this._label),this._label.style.visibility=this._markerShown&&this._labelShown?"visible":"hidden"}}_updatePosition(){const t=this.scene.canvas.boundary,e=t[0],i=t[1],s=this.canvasPos;this._marker.style.left=Math.floor(e+s[0])-12+"px",this._marker.style.top=Math.floor(i+s[1])-12+"px",this._marker.style["z-index"]=90005+Math.floor(this._viewPos[2])+1;this._label.style.left=20+Math.floor(e+s[0]+20)+"px",this._label.style.top=Math.floor(i+s[1]+-17)+"px",this._label.style["z-index"]=90005+Math.floor(this._viewPos[2])+1}_renderTemplate(t){for(var e in this._values)if(this._values.hasOwnProperty(e)){const i=this._values[e];t=t.replace(new RegExp("{{"+e+"}}","g"),i)}return t}setMarkerShown(t){t=!!t,this._markerShown!==t&&(this._markerShown=t,this._visibilityDirty=!0)}getMarkerShown(){return this._markerShown}setLabelShown(t){t=!!t,this._labelShown!==t&&(this._labelShown=t,this._visibilityDirty=!0)}getLabelShown(){return this._labelShown}setField(t,e){this._values[t]=e||"",this._htmlDirty=!0}getField(t){return this._values[t]}setValues(t){for(var e in t)if(t.hasOwnProperty(e)){const i=t[e];this.setField(e,i)}}getValues(){return this._values}destroy(){this._marker&&(this._markerExternal?(this._marker.removeEventListener("click",this._onMouseClickedExternalMarker),this._marker.removeEventListener("mouseenter",this._onMouseEnterExternalMarker),this._marker.removeEventListener("mouseleave",this._onMouseLeaveExternalMarker),this._marker=null):this._marker.parentNode.removeChild(this._marker)),this._label&&(this._labelExternal||this._label.parentNode.removeChild(this._label),this._label=null),this.scene.off(this._onTick),super.destroy()}}const rt=d.vec3(),ot=d.vec3(),at=d.vec3();class nt extends a{constructor(t,e){super("Annotations",t),this._labelHTML=e.labelHTML||"<div></div>",this._markerHTML=e.markerHTML||"<div></div>",this._container=e.container||document.body,this._values=e.values||{},this.annotations={},this.surfaceOffset=e.surfaceOffset}send(t,e){if("clearAnnotations"===t)this.clear()}set surfaceOffset(t){null==t&&(t=.3),this._surfaceOffset=t}get surfaceOffset(){return this._surfaceOffset}createAnnotation(t){var e,i;if(this.viewer.scene.components[t.id]&&(this.error("Viewer component with this ID already exists: "+t.id),delete t.id),t.pickResult=t.pickResult||t.pickRecord,t.pickResult){const s=t.pickResult;if(s.worldPos&&s.worldNormal){const t=d.normalizeVec3(s.worldNormal,rt),r=d.mulVec3Scalar(t,this._surfaceOffset,ot);e=d.addVec3(s.worldPos,r,at),i=s.entity}else this.error("Param 'pickResult' does not have both worldPos and worldNormal")}else e=t.worldPos,i=t.entity;var s=null;t.markerElementId&&((s=document.getElementById(t.markerElementId))||this.error("Can't find DOM element for 'markerElementId' value '"+t.markerElementId+"' - defaulting to internally-generated empty DIV"));var r=null;t.labelElementId&&((r=document.getElementById(t.labelElementId))||this.error("Can't find DOM element for 'labelElementId' value '"+t.labelElementId+"' - defaulting to internally-generated empty DIV"));const o=new st(this.viewer.scene,{id:t.id,plugin:this,entity:i,worldPos:e,container:this._container,markerElement:s,labelElement:r,markerHTML:t.markerHTML||this._markerHTML,labelHTML:t.labelHTML||this._labelHTML,occludable:t.occludable,values:m.apply(t.values,m.apply(this._values,{})),markerShown:t.markerShown,labelShown:t.labelShown,eye:t.eye,look:t.look,up:t.up,projection:t.projection,visible:!1!==t.visible});return this.annotations[o.id]=o,o.on("destroyed",(()=>{delete this.annotations[o.id],this.fire("annotationDestroyed",o.id)})),this.fire("annotationCreated",o.id),o}destroyAnnotation(t){var e=this.annotations[t];e?e.destroy():this.log("Annotation not found: "+t)}clear(){const t=Object.keys(this.annotations);for(var e=0,i=t.length;e<i;e++)this.destroyAnnotation(t[e])}destroy(){this.clear(),super.destroy()}}class lt extends S{get type(){return"Spinner"}constructor(t,e={}){super(t,e),this._canvas=e.canvas,this._element=null,this._isCustom=!1,e.elementId&&(this._element=document.getElementById(e.elementId),this._element?this._adjustPosition():this.error("Can't find given Spinner HTML element: '"+e.elementId+"' - will automatically create default element")),this._element||this._createDefaultSpinner(),this.processes=0}_createDefaultSpinner(){this._injectDefaultCSS();const t=document.createElement("div"),e=t.style;e["z-index"]="9000",e.position="absolute",t.innerHTML='<div class="sk-fading-circle">                <div class="sk-circle1 sk-circle"></div>                <div class="sk-circle2 sk-circle"></div>                <div class="sk-circle3 sk-circle"></div>                <div class="sk-circle4 sk-circle"></div>                <div class="sk-circle5 sk-circle"></div>                <div class="sk-circle6 sk-circle"></div>                <div class="sk-circle7 sk-circle"></div>                <div class="sk-circle8 sk-circle"></div>                <div class="sk-circle9 sk-circle"></div>                <div class="sk-circle10 sk-circle"></div>                <div class="sk-circle11 sk-circle"></div>                <div class="sk-circle12 sk-circle"></div>                </div>',this._canvas.parentElement.appendChild(t),this._element=t,this._isCustom=!1,this._adjustPosition()}_injectDefaultCSS(){const t="xeokit-spinner-css";if(document.getElementById(t))return;const e=document.createElement("style");e.innerHTML=".sk-fading-circle {        background: transparent;        margin: 20px auto;        width: 50px;        height:50px;        position: relative;        }        .sk-fading-circle .sk-circle {        width: 120%;        height: 120%;        position: absolute;        left: 0;        top: 0;        }        .sk-fading-circle .sk-circle:before {        content: '';        display: block;        margin: 0 auto;        width: 15%;        height: 15%;        background-color: #ff8800;        border-radius: 100%;        -webkit-animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        animation: sk-circleFadeDelay 1.2s infinite ease-in-out both;        }        .sk-fading-circle .sk-circle2 {        -webkit-transform: rotate(30deg);        -ms-transform: rotate(30deg);        transform: rotate(30deg);    }    .sk-fading-circle .sk-circle3 {        -webkit-transform: rotate(60deg);        -ms-transform: rotate(60deg);        transform: rotate(60deg);    }    .sk-fading-circle .sk-circle4 {        -webkit-transform: rotate(90deg);        -ms-transform: rotate(90deg);        transform: rotate(90deg);    }    .sk-fading-circle .sk-circle5 {        -webkit-transform: rotate(120deg);        -ms-transform: rotate(120deg);        transform: rotate(120deg);    }    .sk-fading-circle .sk-circle6 {        -webkit-transform: rotate(150deg);        -ms-transform: rotate(150deg);        transform: rotate(150deg);    }    .sk-fading-circle .sk-circle7 {        -webkit-transform: rotate(180deg);        -ms-transform: rotate(180deg);        transform: rotate(180deg);    }    .sk-fading-circle .sk-circle8 {        -webkit-transform: rotate(210deg);        -ms-transform: rotate(210deg);        transform: rotate(210deg);    }    .sk-fading-circle .sk-circle9 {        -webkit-transform: rotate(240deg);        -ms-transform: rotate(240deg);        transform: rotate(240deg);    }    .sk-fading-circle .sk-circle10 {        -webkit-transform: rotate(270deg);        -ms-transform: rotate(270deg);        transform: rotate(270deg);    }    .sk-fading-circle .sk-circle11 {        -webkit-transform: rotate(300deg);        -ms-transform: rotate(300deg);        transform: rotate(300deg);    }    .sk-fading-circle .sk-circle12 {        -webkit-transform: rotate(330deg);        -ms-transform: rotate(330deg);        transform: rotate(330deg);    }    .sk-fading-circle .sk-circle2:before {        -webkit-animation-delay: -1.1s;        animation-delay: -1.1s;    }    .sk-fading-circle .sk-circle3:before {        -webkit-animation-delay: -1s;        animation-delay: -1s;    }    .sk-fading-circle .sk-circle4:before {        -webkit-animation-delay: -0.9s;        animation-delay: -0.9s;    }    .sk-fading-circle .sk-circle5:before {        -webkit-animation-delay: -0.8s;        animation-delay: -0.8s;    }    .sk-fading-circle .sk-circle6:before {        -webkit-animation-delay: -0.7s;        animation-delay: -0.7s;    }    .sk-fading-circle .sk-circle7:before {        -webkit-animation-delay: -0.6s;        animation-delay: -0.6s;    }    .sk-fading-circle .sk-circle8:before {        -webkit-animation-delay: -0.5s;        animation-delay: -0.5s;    }    .sk-fading-circle .sk-circle9:before {        -webkit-animation-delay: -0.4s;        animation-delay: -0.4s;    }    .sk-fading-circle .sk-circle10:before {        -webkit-animation-delay: -0.3s;        animation-delay: -0.3s;    }    .sk-fading-circle .sk-circle11:before {        -webkit-animation-delay: -0.2s;        animation-delay: -0.2s;    }    .sk-fading-circle .sk-circle12:before {        -webkit-animation-delay: -0.1s;        animation-delay: -0.1s;    }    @-webkit-keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }    @keyframes sk-circleFadeDelay {        0%, 39%, 100% { opacity: 0; }        40% { opacity: 1; }    }",e.id=t,document.body.appendChild(e)}_adjustPosition(){if(this._isCustom)return;const t=this._canvas,e=this._element,i=e.style;i.left=t.offsetLeft+.5*t.clientWidth-.5*e.clientWidth+"px",i.top=t.offsetTop+.5*t.clientHeight-.5*e.clientHeight+"px"}set processes(t){if(t=t||0,this._processes===t)return;if(t<0)return;const e=this._processes;this._processes=t;const i=this._element;i&&(i.style.visibility=this._processes>0?"visible":"hidden"),this.fire("processes",this._processes),0===this._processes&&this._processes!==e&&this.fire("zeroProcesses",this._processes)}get processes(){return this._processes}_destroy(){this._element&&!this._isCustom&&(this._element.parentNode.removeChild(this._element),this._element=null);const t=document.getElementById("xeokit-spinner-css");t&&t.parentNode.removeChild(t)}}const ht={WEBGL:!1,SUPPORTED_EXTENSIONS:{}},ct=document.createElement("canvas");if(ct){const t=ct.getContext("webgl",{antialias:!0})||ct.getContext("experimental-webgl",{antialias:!0});ht.WEBGL=!!t,ht.WEBGL&&(ht.ANTIALIAS=t.getContextAttributes().antialias,t.getShaderPrecisionFormat?t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0?ht.FS_MAX_FLOAT_PRECISION="highp":t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?ht.FS_MAX_FLOAT_PRECISION="mediump":ht.FS_MAX_FLOAT_PRECISION="lowp":ht.FS_MAX_FLOAT_PRECISION="mediump",ht.DEPTH_BUFFER_BITS=t.getParameter(t.DEPTH_BITS),ht.MAX_TEXTURE_SIZE=t.getParameter(t.MAX_TEXTURE_SIZE),ht.MAX_CUBE_MAP_SIZE=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),ht.MAX_RENDERBUFFER_SIZE=t.getParameter(t.MAX_RENDERBUFFER_SIZE),ht.MAX_TEXTURE_UNITS=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),ht.MAX_TEXTURE_IMAGE_UNITS=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),ht.MAX_VERTEX_ATTRIBS=t.getParameter(t.MAX_VERTEX_ATTRIBS),ht.MAX_VERTEX_UNIFORM_VECTORS=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),ht.MAX_FRAGMENT_UNIFORM_VECTORS=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),ht.MAX_VARYING_VECTORS=t.getParameter(t.MAX_VARYING_VECTORS),t.getSupportedExtensions().forEach((function(t){ht.SUPPORTED_EXTENSIONS[t]=!0})),ht.depthTexturesSupported=ht.SUPPORTED_EXTENSIONS.WEBGL_depth_texture)}const ut=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];class dt extends S{constructor(t,e={}){super(t,e),this._backgroundColor=d.vec3([e.backgroundColor?e.backgroundColor[0]:1,e.backgroundColor?e.backgroundColor[1]:1,e.backgroundColor?e.backgroundColor[2]:1]),this._backgroundColorFromAmbientLight=!!e.backgroundColorFromAmbientLight,this.canvas=e.canvas,this.gl=null,this.webgl2=!1,this.transparent=!!e.transparent,this.contextAttr=e.contextAttr||{},this.contextAttr.alpha=this.transparent,this.contextAttr.preserveDrawingBuffer=!!this.contextAttr.preserveDrawingBuffer,this.contextAttr.stencil=!1,this.contextAttr.premultipliedAlpha=!!this.contextAttr.premultipliedAlpha,this.contextAttr.antialias=!1!==this.contextAttr.antialias,this.resolutionScale=e.resolutionScale,this.canvas.width=Math.round(this.canvas.clientWidth*this._resolutionScale),this.canvas.height=Math.round(this.canvas.clientHeight*this._resolutionScale),this.boundary=[this.canvas.offsetLeft,this.canvas.offsetTop,this.canvas.clientWidth,this.canvas.clientHeight],this._initWebGL(e);const i=this;this.canvas.addEventListener("webglcontextlost",this._webglcontextlostListener=function(t){console.time("webglcontextrestored"),i.scene._webglContextLost(),i.fire("webglcontextlost"),t.preventDefault()},!1),this.canvas.addEventListener("webglcontextrestored",this._webglcontextrestoredListener=function(t){i._initWebGL(),i.gl&&(i.scene._webglContextRestored(i.gl),i.fire("webglcontextrestored",i.gl),t.preventDefault()),console.timeEnd("webglcontextrestored")},!1);let s=null,r=null,o=null,a=null,n=null,l=null,h=null,c=null;this._tick=this.scene.on("tick",(()=>{const t=this.canvas,e=this._resolutionScale!==s,i=window.innerWidth!==r||window.innerHeight!==o,u=t.clientWidth!==a||t.clientHeight!==n,d=t.offsetLeft!==l||t.offsetTop!==h,p=t.parentElement;if(e||i||u||d||p!==c){if(this._spinner._adjustPosition(),e||u||d){const i=t.clientWidth,s=t.clientHeight;if(e||u){let e,i=0;for(const t in A.scenes)A.scenes.hasOwnProperty(t)&&(e=A.scenes[t],i+=Math.round(e.canvas.canvas.clientWidth*this._resolutionScale*(e.canvas.canvas.clientHeight*this._resolutionScale)));_.memory.pixels=i,t.width=Math.round(t.clientWidth*this._resolutionScale),t.height=Math.round(t.clientHeight*this._resolutionScale)}const r=this.boundary;r[0]=t.offsetLeft,r[1]=t.offsetTop,r[2]=i,r[3]=s,e||this.fire("boundary",r),a=i,n=s}e&&(s=this._resolutionScale),i&&(r=window.innerWidth,o=window.innerHeight),d&&(l=t.offsetLeft,h=t.offsetTop),c=p}})),this._spinner=new lt(this.scene,{canvas:this.canvas,elementId:e.spinnerElementId})}get type(){return"Canvas"}get backgroundColorFromAmbientLight(){return this._backgroundColorFromAmbientLight}set backgroundColorFromAmbientLight(t){this._backgroundColorFromAmbientLight=!1!==t,this.glRedraw()}get backgroundColor(){return this._backgroundColor}set backgroundColor(t){t?(this._backgroundColor[0]=t[0],this._backgroundColor[1]=t[1],this._backgroundColor[2]=t[2]):(this._backgroundColor[0]=1,this._backgroundColor[1]=1,this._backgroundColor[2]=1),this.glRedraw()}get resolutionScale(){return this._resolutionScale}set resolutionScale(t){if((t=t||1)===this._resolutionScale)return;this._resolutionScale=t;const e=this.canvas;e.width=Math.round(e.clientWidth*this._resolutionScale),e.height=Math.round(e.clientHeight*this._resolutionScale),this.glRedraw()}get spinner(){return this._spinner}_createCanvas(){const t="xeokit-canvas-"+d.createUUID(),e=document.getElementsByTagName("body")[0],i=document.createElement("div"),s=i.style;s.height="100%",s.width="100%",s.padding="0",s.margin="0",s.background="rgba(0,0,0,0);",s.float="left",s.left="0",s.top="0",s.position="absolute",s.opacity="1.0",s["z-index"]="-10000",i.innerHTML+='<canvas id="'+t+'" style="width: 100%; height: 100%; float: left; margin: 0; padding: 0;"></canvas>',e.appendChild(i),this.canvas=document.getElementById(t)}_getElementXY(t){let e=0,i=0;for(;t;)e+=t.offsetLeft-t.scrollLeft,i+=t.offsetTop-t.scrollTop,t=t.offsetParent;return{x:e,y:i}}_initWebGL(){if(!this.gl)for(let t=0;!this.gl&&t<ut.length;t++)try{this.gl=this.canvas.getContext(ut[t],this.contextAttr)}catch(t){}if(this.gl||(this.error("Failed to get a WebGL context"),this.fire("webglContextFailed",!0,!0)),this.gl)if(this.webgl2)this.gl.hint(this.gl.FRAGMENT_SHADER_DERIVATIVE_HINT,this.gl.FASTEST);else{if(ht.SUPPORTED_EXTENSIONS.OES_standard_derivatives){const t=this.gl.getExtension("OES_standard_derivatives");this.gl.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,this.gl.FASTEST)}ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&this.gl.getExtension("EXT_frag_depth"),ht.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&this.gl.getExtension("WEBGL_depth_texture")}}getSnapshot(t){throw"Canvas#getSnapshot() has been replaced by Viewer#getSnapshot() - use that method instead."}readPixels(t,e,i,s){return this.scene._renderer.readPixels(t,e,i,s)}loseWebGLContext(){this.canvas.loseContext&&this.canvas.loseContext()}destroy(){this.scene.off(this._tick),this._spinner._destroy(),this.canvas.removeEventListener("webglcontextlost",this._webglcontextlostListener),this.canvas.removeEventListener("webglcontextrestored",this._webglcontextrestoredListener),this.gl=null,super.destroy()}}class pt{constructor(t){this._scene=t,this._matPool=[],this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.reset()}reset(){this._matPoolNextFreeIndex=0,this._rtcViewMats={},this._rtcPickViewMats={},this.gl=this._scene.canvas.gl,this.lastProgramId=null,this.pbrEnabled=!1,this.withSAO=!1,this.backfaces=!1,this.frontface=!0,this.textureUnit=0,this.drawElements=0,this.drawArrays=0,this.useProgram=0,this.bindTexture=0,this.bindArray=0,this.pass=0,this.shadowViewMatrix=null,this.shadowProjMatrix=null,this.pickViewMatrix=null,this.pickProjMatrix=null,this.pickZNear=.01,this.pickZFar=5e3,this.pickInvisible=!1,this.lineWidth=1}getRTCViewMatrix(t,e){let i=this._rtcViewMats[t];return i||(i=this._getNewMat(),G(this._scene.camera.viewMatrix,e,i),this._rtcViewMats[t]=i),i}getRTCPickViewMatrix(t,e){let i=this._rtcPickViewMats[t];if(!i){i=this._getNewMat();const s=this.pickViewMatrix||this._scene.camera.viewMatrix;G(s,e,i),this._rtcPickViewMats[t]=i}return i}_getNewMat(){let t=this._matPool[this._matPoolNextFreeIndex];return t||(t=d.mat4(),this._matPool[this._matPoolNextFreeIndex]=t),this._matPoolNextFreeIndex++,t}}class _t{constructor(){this.entity=null,this.primitive=null,this.primIndex=-1,this.pickSurfacePrecision=!1,this._canvasPos=new Int16Array([0,0]),this._origin=new Float64Array([0,0,0]),this._direction=new Float64Array([0,0,0]),this._indices=new Int32Array(3),this._localPos=new Float64Array([0,0,0]),this._worldPos=new Float64Array([0,0,0]),this._viewPos=new Float64Array([0,0,0]),this._bary=new Float64Array([0,0,0]),this._worldNormal=new Float64Array([0,0,0]),this._uv=new Float64Array([0,0]),this.reset()}get canvasPos(){return this._gotCanvasPos?this._canvasPos:null}set canvasPos(t){t?(this._canvasPos[0]=t[0],this._canvasPos[1]=t[1],this._gotCanvasPos=!0):this._gotCanvasPos=!1}get origin(){return this._gotOrigin?this._origin:null}set origin(t){t?(this._origin[0]=t[0],this._origin[1]=t[1],this._origin[2]=t[2],this._gotOrigin=!0):this._gotOrigin=!1}get direction(){return this._gotDirection?this._direction:null}set direction(t){t?(this._direction[0]=t[0],this._direction[1]=t[1],this._direction[2]=t[2],this._gotDirection=!0):this._gotDirection=!1}get indices(){return this.entity&&this._gotIndices?this._indices:null}set indices(t){t?(this._indices[0]=t[0],this._indices[1]=t[1],this._indices[2]=t[2],this._gotIndices=!0):this._gotIndices=!1}get localPos(){return this.entity&&this._gotLocalPos?this._localPos:null}set localPos(t){t?(this._localPos[0]=t[0],this._localPos[1]=t[1],this._localPos[2]=t[2],this._gotLocalPos=!0):this._gotLocalPos=!1}get worldPos(){return this.entity&&this._gotWorldPos?this._worldPos:null}set worldPos(t){t?(this._worldPos[0]=t[0],this._worldPos[1]=t[1],this._worldPos[2]=t[2],this._gotWorldPos=!0):this._gotWorldPos=!1}get viewPos(){return this.entity&&this._gotViewPos?this._viewPos:null}set viewPos(t){t?(this._viewPos[0]=t[0],this._viewPos[1]=t[1],this._viewPos[2]=t[2],this._gotViewPos=!0):this._gotViewPos=!1}get bary(){return this.entity&&this._gotBary?this._bary:null}set bary(t){t?(this._bary[0]=t[0],this._bary[1]=t[1],this._bary[2]=t[2],this._gotBary=!0):this._gotBary=!1}get worldNormal(){return this.entity&&this._gotWorldNormal?this._worldNormal:null}set worldNormal(t){t?(this._worldNormal[0]=t[0],this._worldNormal[1]=t[1],this._worldNormal[2]=t[2],this._gotWorldNormal=!0):this._gotWorldNormal=!1}get uv(){return this.entity&&this._gotUV?this._uv:null}set uv(t){t?(this._uv[0]=t[0],this._uv[1]=t[1],this._gotUV=!0):this._gotUV=!1}reset(){this.entity=null,this.primIndex=-1,this.primitive=null,this.pickSurfacePrecision=!1,this._gotCanvasPos=!1,this._gotOrigin=!1,this._gotDirection=!1,this._gotIndices=!1,this._gotLocalPos=!1,this._gotWorldPos=!1,this._gotViewPos=!1,this._gotBary=!1,this._gotWorldNormal=!1,this._gotUV=!1}}class ft{constructor(t,e,i){if(this.allocated=!1,this.compiled=!1,this.handle=t.createShader(e),this.handle){if(this.allocated=!0,t.shaderSource(this.handle,i),t.compileShader(this.handle),this.compiled=t.getShaderParameter(this.handle,t.COMPILE_STATUS),!this.compiled&&!t.isContextLost()){const e=i.split("\n"),s=[];for(let t=0;t<e.length;t++)s.push(t+1+": "+e[t]+"\n");this.errors=[],this.errors.push(""),this.errors.push(t.getShaderInfoLog(this.handle)),this.errors=this.errors.concat(s.join(""))}}else this.errors=["Failed to allocate"]}destroy(){}}class gt{constructor(t,e){this.bindTexture=function(i,s){return!!i.bind(s)&&(t.uniform1i(e,s),!0)}}}class mt{constructor(t,e){this._gl=t,this.location=e}bindArrayBuffer(t){t&&(t.bind(),this._gl.enableVertexAttribArray(this.location),this._gl.vertexAttribPointer(this.location,t.itemSize,t.itemType,t.normalized,t.stride,t.offset))}}const vt=new t({});function bt(t){const e=[];let i,s;for(let r=0,o=t.length;r<o;r++)i=t[r],s=i.indexOf("/"),s>0&&"/"===i.charAt(s+1)&&(i=i.substring(0,s)),e.push(i);return e.join("\n")}function Pt(t){console.error(t.join("\n"))}class yt{constructor(t,e){this.id=vt.addItem({}),this.source=e,this.init(t)}init(t){if(this.gl=t,this.allocated=!1,this.compiled=!1,this.linked=!1,this.validated=!1,this.errors=null,this.uniforms={},this.samplers={},this.attributes={},this._vertexShader=new ft(t,t.VERTEX_SHADER,bt(this.source.vertex)),this._fragmentShader=new ft(t,t.FRAGMENT_SHADER,bt(this.source.fragment)),!this._vertexShader.allocated)return this.errors=["Vertex shader failed to allocate"].concat(this._vertexShader.errors),void Pt(this.errors);if(!this._fragmentShader.allocated)return this.errors=["Fragment shader failed to allocate"].concat(this._fragmentShader.errors),void Pt(this.errors);if(this.allocated=!0,!this._vertexShader.compiled)return this.errors=["Vertex shader failed to compile"].concat(this._vertexShader.errors),void Pt(this.errors);if(!this._fragmentShader.compiled)return this.errors=["Fragment shader failed to compile"].concat(this._fragmentShader.errors),void Pt(this.errors);let e,i,s,r,o;if(this.compiled=!0,this.handle=t.createProgram(),!this.handle)return void(this.errors=["Failed to allocate program"]);if(t.attachShader(this.handle,this._vertexShader.handle),t.attachShader(this.handle,this._fragmentShader.handle),t.linkProgram(this.handle),this.linked=t.getProgramParameter(this.handle,t.LINK_STATUS),this.validated=!0,!this.linked||!this.validated)return this.errors=[],this.errors.push(""),this.errors.push(t.getProgramInfoLog(this.handle)),this.errors.push("\nVertex shader:\n"),this.errors=this.errors.concat(this.source.vertex),this.errors.push("\nFragment shader:\n"),this.errors=this.errors.concat(this.source.fragment),void Pt(this.errors);const a=t.getProgramParameter(this.handle,t.ACTIVE_UNIFORMS);for(i=0;i<a;++i)s=t.getActiveUniform(this.handle,i),s&&(r=s.name,"\0"===r[r.length-1]&&(r=r.substr(0,r.length-1)),o=t.getUniformLocation(this.handle,r),s.type===t.SAMPLER_2D||s.type===t.SAMPLER_CUBE||35682===s.type?this.samplers[r]=new gt(t,o):this.uniforms[r]=o);const n=t.getProgramParameter(this.handle,t.ACTIVE_ATTRIBUTES);for(i=0;i<n;i++)e=t.getActiveAttrib(this.handle,i),e&&(o=t.getAttribLocation(this.handle,e.name),this.attributes[e.name]=new mt(t,o));this.allocated=!0}bind(){this.allocated&&this.gl.useProgram(this.handle)}getLocation(t){if(this.allocated)return this.uniforms[t]}getAttribute(t){if(this.allocated)return this.attributes[t]}bindTexture(t,e,i){if(!this.allocated)return!1;const s=this.samplers[t];return!!s&&s.bindTexture(e,i)}destroy(){this.allocated&&(vt.removeItem(this.id),this.gl.deleteProgram(this.handle),this.gl.deleteShader(this._vertexShader.handle),this.gl.deleteShader(this._fragmentShader.handle),this.handle=null,this.attributes=null,this.uniforms=null,this.samplers=null,this.allocated=!1)}}class Mt{constructor(t,e,i,s,r,o,a,n,l){switch(this._gl=t,this.type=e,this.allocated=!1,i.constructor){case Uint8Array:this.itemType=t.UNSIGNED_BYTE,this.itemByteSize=1;break;case Int8Array:this.itemType=t.BYTE,this.itemByteSize=1;break;case Uint16Array:this.itemType=t.UNSIGNED_SHORT,this.itemByteSize=2;break;case Int16Array:this.itemType=t.SHORT,this.itemByteSize=2;break;case Uint32Array:this.itemType=t.UNSIGNED_INT,this.itemByteSize=4;break;case Int32Array:this.itemType=t.INT,this.itemByteSize=4;break;default:this.itemType=t.FLOAT,this.itemByteSize=4}this.usage=o,this.length=0,this.dataLength=s,this.numItems=0,this.itemSize=r,this.normalized=!!a,this.stride=n||0,this.offset=l||0,this._allocate(i)}_allocate(t){if(this.allocated=!1,this._handle=this._gl.createBuffer(),!this._handle)throw"Failed to allocate WebGL ArrayBuffer";this._handle&&(this._gl.bindBuffer(this.type,this._handle),this._gl.bufferData(this.type,t.length>this.dataLength?t.slice(0,this.dataLength):t,this.usage),this._gl.bindBuffer(this.type,null),this.length=t.length,this.numItems=this.length/this.itemSize,this.allocated=!0)}setData(t,e){this.allocated&&(t.length+(e||0)>this.length?(this.destroy(),this._allocate(t)):(this._gl.bindBuffer(this.type,this._handle),e||0===e?this._gl.bufferSubData(this.type,e*this.itemByteSize,t):this._gl.bufferData(this.type,t,this.usage),this._gl.bindBuffer(this.type,null)))}bind(){this.allocated&&this._gl.bindBuffer(this.type,this._handle)}unbind(){this.allocated&&this._gl.bindBuffer(this.type,null)}destroy(){this.allocated&&(this._gl.deleteBuffer(this._handle),this._handle=null,this.allocated=!1)}}class xt{constructor(t,e){this.scene=t,this.aabb=d.AABB3(),this.origin=d.vec3(e),this.originHash=this.origin.join(),this.numMarkers=0,this.markers={},this.markerList=[],this.markerIndices={},this.positions=[],this.indices=[],this.positionsBuf=null,this.lenPositionsBuf=0,this.indicesBuf=null,this.sectionPlanesActive=[],this.culledBySectionPlanes=!1,this.occlusionTestList=[],this.lenOcclusionTestList=0,this.pixels=[],this.aabbDirty=!1,this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!1}addMarker(t){this.markers[t.id]=t,this.markerListDirty=!0,this.numMarkers++}markerWorldPosUpdated(t){if(!this.markers[t.id])return;const e=this.markerIndices[t.id];this.positions[3*e+0]=t.worldPos[0],this.positions[3*e+1]=t.worldPos[1],this.positions[3*e+2]=t.worldPos[2],this.positionsDirty=!0}removeMarker(t){delete this.markers[t.id],this.markerListDirty=!0,this.numMarkers--}update(){this.markerListDirty&&(this._buildMarkerList(),this.markerListDirty=!1,this.positionsDirty=!0,this.occlusionTestListDirty=!0),this.positionsDirty&&(this._buildPositions(),this.positionsDirty=!1,this.aabbDirty=!0,this.vbosDirty=!0),this.aabbDirty&&(this._buildAABB(),this.aabbDirty=!1),this.vbosDirty&&(this._buildVBOs(),this.vbosDirty=!1),this.occlusionTestListDirty&&this._buildOcclusionTestList(),this._updateActiveSectionPlanes()}_buildMarkerList(){for(var t in this.numMarkers=0,this.markers)this.markers.hasOwnProperty(t)&&(this.markerList[this.numMarkers]=this.markers[t],this.markerIndices[t]=this.numMarkers,this.numMarkers++);this.markerList.length=this.numMarkers}_buildPositions(){let t=0;for(let e=0;e<this.numMarkers;e++)if(this.markerList[e]){const i=this.markerList[e].worldPos;this.positions[t++]=i[0],this.positions[t++]=i[1],this.positions[t++]=i[2],this.indices[e]=e}this.positions.length=3*this.numMarkers,this.indices.length=this.numMarkers}_buildAABB(){const t=this.aabb;d.collapseAABB3(t),d.expandAABB3Points3(t,this.positions);const e=this.origin;t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[0],t[4]+=e[1],t[5]+=e[2]}_buildVBOs(){if(this.positionsBuf){if(this.lenPositionsBuf===this.positions.length)return void this.positionsBuf.setData(this.positions);this.positionsBuf.destroy(),this.positionsBuf=null,this.indicesBuf.destroy(),this.indicesBuf=null}const t=this.scene.canvas.gl,e=3*this.numMarkers,i=this.numMarkers;this.positionsBuf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this.positions),e,3,t.STATIC_DRAW),this.indicesBuf=new Mt(t,t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.indices),i,1,t.STATIC_DRAW),this.lenPositionsBuf=this.positions.length}_buildOcclusionTestList(){const t=this.scene.canvas,e=this.scene.camera.perspective.near,i=t.boundary,s=i[2],r=i[3];let o=0;this.lenOcclusionTestList=0;for(let t=0;t<this.numMarkers;t++){const i=this.markerList[t];if(i.viewPos[2]>-e){i._setVisible(!1);continue}const a=i.canvasPos,n=a[0],l=a[1];n+10<0||l+10<0||n-10>s||l-10>r?i._setVisible(!1):!i.entity||i.entity.visible?i.occludable?(this.occlusionTestList[this.lenOcclusionTestList++]=i,this.pixels[o++]=n,this.pixels[o++]=l):i._setVisible(!0):i._setVisible(!1)}}_updateActiveSectionPlanes(){const t=this.scene._sectionPlanesState.sectionPlanes,e=t.length;if(e>0)for(let i=0;i<e;i++){const e=t[i];if(e.active){const t=d.planeAABB3Intersect(e.dir,e.dist,this.aabb);if(-1===t)return void(this.culledBySectionPlanes=!0);const s=0===t;this.sectionPlanesActive[i]=s}else this.sectionPlanesActive[i]=!1}this.culledBySectionPlanes=!1}destroy(){this.markers={},this.markerList.length=0,this.positionsBuf&&this.positionsBuf.destroy(),this.indicesBuf&&this.indicesBuf.destroy()}}const wt=d.vec3([1,0,0]),Et=d.vec3();class At{constructor(t,e){this._scene=t,this._renderBufferManager=e,this._occlusionLayers={},this._occlusionLayersList=[],this._occlusionLayersListDirty=!1,this._shaderSource=null,this._program=null,this._shaderSourceHash=null,this._shaderSourceDirty=!0,this._programDirty=!1,this._markersToOcclusionLayersMap={},this._onCameraViewMatrix=t.camera.on("viewMatrix",(()=>{this._occlusionTestListDirty=!0})),this._onCameraProjMatrix=t.camera.on("projMatrix",(()=>{this._occlusionTestListDirty=!0})),this._onCanvasBoundary=t.canvas.on("boundary",(()=>{this._occlusionTestListDirty=!0}))}addMarker(t){const e=t.origin.join();let i=this._occlusionLayers[e];i||(i=new xt(this._scene,t.origin),this._occlusionLayers[i.originHash]=i,this._occlusionLayersListDirty=!0),i.addMarker(t),this._markersToOcclusionLayersMap[t.id]=i,this._occlusionTestListDirty=!0}markerWorldPosUpdated(t){const e=this._markersToOcclusionLayersMap[t.id];if(!e)return void t.error("Marker has not been added to OcclusionTester");const i=t.origin.join();if(i!==e.originHash){1===e.numMarkers?(e.destroy(),delete this._occlusionLayers[e.originHash],this._occlusionLayersListDirty=!0):e.removeMarker(t);let s=this._occlusionLayers[i];s||(s=new xt(this._scene,t.origin),this._occlusionLayers[i]=e,this._occlusionLayersListDirty=!0),s.addMarker(t),this._markersToOcclusionLayersMap[t.id]=s}else e.markerWorldPosUpdated(t)}removeMarker(t){const e=t.origin.join();let i=this._occlusionLayers[e];i&&(1===i.numMarkers?(i.destroy(),delete this._occlusionLayers[i.originHash],this._occlusionLayersListDirty=!0):i.removeMarker(t),delete this._markersToOcclusionLayersMap[t.id])}get needOcclusionTest(){return this._occlusionTestListDirty}bindRenderBuf(){const t=[this._scene.canvas.canvas.id,this._scene._sectionPlanesState.getHash()].join(";");if(t!==this._shaderSourceHash&&(this._shaderSourceHash=t,this._shaderSourceDirty=!0),this._shaderSourceDirty&&(this._buildShaderSource(),this._shaderSourceDirty=!1,this._programDirty=!0),this._programDirty&&(this._buildProgram(),this._programDirty=!1,this._occlusionTestListDirty=!0),this._occlusionLayersListDirty&&(this._buildOcclusionLayersList(),this._occlusionLayersListDirty=!1),this._occlusionTestListDirty){for(let t=0,e=this._occlusionLayersList.length;t<e;t++){this._occlusionLayersList[t].occlusionTestListDirty=!0}this._occlusionTestListDirty=!1}this._readPixelBuf=this._renderBufferManager.getRenderBuffer("occlusionReadPix"),this._readPixelBuf.bind(),this._readPixelBuf.clear()}_buildOcclusionLayersList(){let t=0;for(let e in this._occlusionLayers)this._occlusionLayers.hasOwnProperty(e)&&(this._occlusionLayersList[t++]=this._occlusionLayers[e]);this._occlusionLayersList.length=t}_buildShaderSource(){this._shaderSource={vertex:this._buildVertexShaderSource(),fragment:this._buildFragmentShaderSource()}}_buildVertexShaderSource(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// OcclusionTester vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("attribute vec3 position;"),i.push("uniform mat4 modelMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&i.push("varying vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("vec4 worldPosition = vec4(position, 1.0); "),i.push("   vec4 viewPosition = viewMatrix * worldPosition;"),e&&i.push("   vWorldPosition = worldPosition;"),i.push("   vec4 clipPos = projMatrix * viewPosition;"),i.push("   gl_PointSize = 20.0;"),t.logarithmicDepthBufferEnabled?ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")):i.push("clipPos.z += -0.001;"),i.push("   gl_Position = clipPos;"),i.push("}"),i}_buildFragmentShaderSource(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// OcclusionTester fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("void main(void) {"),i){s.push("  float dist = 0.0;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0); "),s.push("}"),s}_buildProgram(){this._program&&this._program.destroy();const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}drawMarkers(){const t=this._scene,e=t.canvas.gl,i=this._program,s=t._sectionPlanesState,r=t.camera,o=t.camera.project;if(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&t.logarithmicDepthBufferEnabled&&e.getExtension("EXT_frag_depth"),i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,r._project._state.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}for(let t=0,i=this._occlusionLayersList.length;t<i;t++){const i=this._occlusionLayersList[t];if(i.update(),i.culledBySectionPlanes)continue;const o=i.origin;e.uniformMatrix4fv(this._uViewMatrix,!1,G(r.viewMatrix,o));const a=s.sectionPlanes.length;if(a>0){const t=s.sectionPlanes;for(let s=0;s<a;s++){const r=this._uSectionPlanes[s];if(r){const a=i.sectionPlanesActive[s];if(e.uniform1i(r.active,a?1:0),a){const i=t[s];e.uniform3fv(r.pos,W(i.dist,i.dir,o,Et)),e.uniform3fv(r.dir,i.dir)}}}}this._aPosition.bindArrayBuffer(i.positionsBuf);const n=i.indicesBuf;n.bind(),e.drawElements(e.POINTS,n.numItems,n.itemType,0)}}doOcclusionTest(){{const t=this._scene.canvas.resolutionScale,e=255*wt[0],i=255*wt[1],s=255*wt[2];for(let r=0,o=this._occlusionLayersList.length;r<o;r++){const o=this._occlusionLayersList[r];for(let r=0;r<o.lenOcclusionTestList;r++){const a=o.occlusionTestList[r],n=2*r,l=this._readPixelBuf.read(Math.round(o.pixels[n]*t),Math.round(o.pixels[n+1]*t)),h=l[0]===e&&l[1]===i&&l[2]===s;a._setVisible(h)}}}}unbindRenderBuf(){this._readPixelBuf.unbind()}destroy(){if(!this.destroyed){for(let t=0,e=this._occlusionLayersList.length;t<e;t++){this._occlusionLayersList[t].destroy()}this._program&&this._program.destroy(),this._scene.camera.off(this._onCameraViewMatrix),this._scene.camera.off(this._onCameraProjMatrix),this._scene.canvas.off(this._onCanvasBoundary),this.destroyed=!0}}}const Ct=d.vec2();class St{constructor(t){this._scene=t,this._numSamples=null,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uRandomSeed=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null}render(t){if(this._build(),this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let t=!0;this._scene.camera.on("projMatrix",(function(){t=!0}));const e=d.mat4();return()=>(t&&d.inverseMat4(s.camera.projMatrix,e),e)})());const e=this._scene.canvas.gl,i=this._program,s=this._scene,r=s.sao,o=e.drawingBufferWidth,a=e.drawingBufferHeight,n=s.camera.project._state,l=n.near,h=n.far,c=n.matrix,u=this._getInverseProjectMat(),p=Math.random(),_="perspective"===s.camera.projection;Ct[0]=o,Ct[1]=a,e.getExtension("OES_standard_derivatives"),e.viewport(0,0,o,a),e.clearColor(0,0,0,1),e.disable(e.DEPTH_TEST),e.disable(e.BLEND),e.frontFace(e.CCW),e.clear(e.COLOR_BUFFER_BIT),i.bind(),e.uniform1f(this._uCameraNear,l),e.uniform1f(this._uCameraFar,h),e.uniformMatrix4fv(this._uCameraProjectionMatrix,!1,c),e.uniformMatrix4fv(this._uCameraInverseProjectionMatrix,!1,u),e.uniform1i(this._uPerspective,_),e.uniform1f(this._uScale,r.scale*(h/5)),e.uniform1f(this._uIntensity,r.intensity),e.uniform1f(this._uBias,r.bias),e.uniform1f(this._uKernelRadius,r.kernelRadius),e.uniform1f(this._uMinResolution,r.minResolution),e.uniform2fv(this._uViewport,Ct),e.uniform1f(this._uRandomSeed,p);const f=ht.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?t.getDepthTexture():t.getTexture();i.bindTexture(this._uDepthTexture,f,0),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),e.drawElements(e.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}_build(){let t=!1;const e=this._scene.sao;if(e.numSamples!==this._numSamples&&(this._numSamples=Math.floor(e.numSamples),t=!0),!t)return;const i=this._scene.canvas.gl;if(this._program&&(this._program.destroy(),this._program=null),this._program=new yt(i,{vertex:["precision highp float;\n                    precision highp int;\n                    \n                    attribute vec3 aPosition;\n                    attribute vec2 aUV;            \n                    \n                    varying vec2 vUV;\n                    \n                    void main () {\n                        gl_Position = vec4(aPosition, 1.0);\n                        vUV = aUV;\n                    }"],fragment:[`#extension GL_OES_standard_derivatives : require              \n                precision highp float;\n                precision highp int;           \n                \n                #define NORMAL_TEXTURE 0\n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n                #define NUM_SAMPLES ${this._numSamples}\n                #define NUM_RINGS 4              \n            \n                varying vec2        vUV;\n            \n                uniform sampler2D   uDepthTexture;\n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;\n                uniform mat4        uProjectMatrix;\n                uniform mat4        uInverseProjectMatrix;\n                \n                uniform bool        uPerspective;\n\n                uniform float       uScale;\n                uniform float       uIntensity;\n                uniform float       uBias;\n                uniform float       uKernelRadius;\n                uniform float       uMinResolution;\n                uniform vec2        uViewport;\n                uniform float       uRandomSeed;\n\n                float pow2( const in float x ) { return x*x; }\n                \n                highp float rand( const in vec2 uv ) {\n                    const highp float a = 12.9898, b = 78.233, c = 43758.5453;\n                    highp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n                    return fract(sin(sn) * c);\n                }\n\n                vec3 packNormalToRGB( const in vec3 normal ) {\n                    return normalize( normal ) * 0.5 + 0.5;\n                }\n\n                vec3 unpackRGBToNormal( const in vec3 rgb ) {\n                    return 2.0 * rgb.xyz - 1.0;\n                }\n\n                const float packUpscale = 256. / 255.;\n                const float unpackDownScale = 255. / 256.; \n\n                const vec3 packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4 unPackFactors = unpackDownScale / vec4( packFactors, 1. );   \n\n                const float shiftRights = 1. / 256.;\n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float unpackRGBAToFloat( const in vec4 v ) {                   \n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unPackFactors );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n                    return ( near * far ) / ( ( far - near ) * invClipZ - far );\n                }\n\n                float orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n                    return linearClipZ * ( near - far ) - near;\n                }\n                \n                float getDepth( const in vec2 screenPosition ) {`+(ht.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?"return texture2D(uDepthTexture, screenPosition).r;":"return unpackRGBAToFloat(texture2D( uDepthTexture, screenPosition));")+"}\n\n                float getViewZ( const in float depth ) {\n                     if (uPerspective) {\n                         return perspectiveDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     } else {\n                        return orthographicDepthToViewZ( depth, uCameraNear, uCameraFar );\n                     }\n                }\n\n                vec3 getViewPos( const in vec2 screenPos, const in float depth, const in float viewZ ) {\n                \tfloat clipW = uProjectMatrix[2][3] * viewZ + uProjectMatrix[3][3];\n                \tvec4 clipPosition = vec4( ( vec3( screenPos, depth ) - 0.5 ) * 2.0, 1.0 );\n                \tclipPosition *= clipW; \n                \treturn ( uInverseProjectMatrix * clipPosition ).xyz;\n                }\n\n                vec3 getViewNormal( const in vec3 viewPosition, const in vec2 screenPos ) {               \n                    return normalize( cross( dFdx( viewPosition ), dFdy( viewPosition ) ) );\n                }\n\n                float scaleDividedByCameraFar;\n                float minResolutionMultipliedByCameraFar;\n\n                float getOcclusion( const in vec3 centerViewPosition, const in vec3 centerViewNormal, const in vec3 sampleViewPosition ) {\n                \tvec3 viewDelta = sampleViewPosition - centerViewPosition;\n                \tfloat viewDistance = length( viewDelta );\n                \tfloat scaledScreenDistance = scaleDividedByCameraFar * viewDistance;\n                \treturn max(0.0, (dot(centerViewNormal, viewDelta) - minResolutionMultipliedByCameraFar) / scaledScreenDistance - uBias) / (1.0 + pow2( scaledScreenDistance ) );\n                }\n\n                const float ANGLE_STEP = PI2 * float( NUM_RINGS ) / float( NUM_SAMPLES );\n                const float INV_NUM_SAMPLES = 1.0 / float( NUM_SAMPLES );\n\n                float getAmbientOcclusion( const in vec3 centerViewPosition ) {\n            \n                \tscaleDividedByCameraFar = uScale / uCameraFar;\n                \tminResolutionMultipliedByCameraFar = uMinResolution * uCameraFar;\n                \tvec3 centerViewNormal = getViewNormal( centerViewPosition, vUV );\n\n                \tfloat angle = rand( vUV + uRandomSeed ) * PI2;\n                \tvec2 radius = vec2( uKernelRadius * INV_NUM_SAMPLES ) / uViewport;\n                \tvec2 radiusStep = radius;\n\n                \tfloat occlusionSum = 0.0;\n                \tfloat weightSum = 0.0;\n\n                \tfor( int i = 0; i < NUM_SAMPLES; i ++ ) {\n                \t\tvec2 sampleUv = vUV + vec2( cos( angle ), sin( angle ) ) * radius;\n                \t\tradius += radiusStep;\n                \t\tangle += ANGLE_STEP;\n\n                \t\tfloat sampleDepth = getDepth( sampleUv );\n                \t\tif( sampleDepth >= ( 1.0 - EPSILON ) ) {\n                \t\t\tcontinue;\n                \t\t}\n\n                \t\tfloat sampleViewZ = getViewZ( sampleDepth );\n                \t\tvec3 sampleViewPosition = getViewPos( sampleUv, sampleDepth, sampleViewZ );\n                \t\tocclusionSum += getOcclusion( centerViewPosition, centerViewNormal, sampleViewPosition );\n                \t\tweightSum += 1.0;\n                \t}\n\n                \tif( weightSum == 0.0 ) discard;\n\n                \treturn occlusionSum * ( uIntensity / weightSum );\n                }\n\n                void main() {\n                \n                \tfloat centerDepth = getDepth( vUV );\n                \t\n                \tif( centerDepth >= ( 1.0 - EPSILON ) ) {\n                \t\tdiscard;\n                \t}\n\n                \tfloat centerViewZ = getViewZ( centerDepth );\n                \tvec3 viewPosition = getViewPos( vUV, centerDepth, centerViewZ );\n\n                \tfloat ambientOcclusion = getAmbientOcclusion( viewPosition );\n                \n                \tgl_FragColor = packFloatToRGBA(  1.0- ambientOcclusion );\n                }"]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);const s=new Float32Array([1,1,0,1,0,0,1,0]),r=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),o=new Uint8Array([0,1,2,0,2,3]);this._positionsBuf=new Mt(i,i.ARRAY_BUFFER,r,r.length,3,i.STATIC_DRAW),this._uvBuf=new Mt(i,i.ARRAY_BUFFER,s,s.length,2,i.STATIC_DRAW),this._indicesBuf=new Mt(i,i.ELEMENT_ARRAY_BUFFER,o,o.length,1,i.STATIC_DRAW),this._program.bind(),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uCameraProjectionMatrix=this._program.getLocation("uProjectMatrix"),this._uCameraInverseProjectionMatrix=this._program.getLocation("uInverseProjectMatrix"),this._uPerspective=this._program.getLocation("uPerspective"),this._uScale=this._program.getLocation("uScale"),this._uIntensity=this._program.getLocation("uIntensity"),this._uBias=this._program.getLocation("uBias"),this._uKernelRadius=this._program.getLocation("uKernelRadius"),this._uMinResolution=this._program.getLocation("uMinResolution"),this._uViewport=this._program.getLocation("uViewport"),this._uRandomSeed=this._program.getLocation("uRandomSeed"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV"),this._dirty=!1}destroy(){this._program&&(this._program.destroy(),this._program=null)}}const Dt=new Float32Array(Nt(17,[0,1])),Lt=new Float32Array(Nt(17,[1,0])),Bt=new Float32Array(function(t,e){const i=[];for(let s=0;s<=t;s++)i.push(Ft(s,e));return i}(17,4)),Rt=new Float32Array(2);class Tt{constructor(t){this._scene=t,this._program=null,this._programError=!1,this._aPosition=null,this._aUV=null,this._uDepthTexture="uDepthTexture",this._uOcclusionTexture="uOcclusionTexture",this._uViewport=null,this._uCameraNear=null,this._uCameraFar=null,this._uCameraProjectionMatrix=null,this._uCameraInverseProjectionMatrix=null,this._uScale=null,this._uIntensity=null,this._uBias=null,this._uKernelRadius=null,this._uMinResolution=null,this._uvBuf=null,this._positionsBuf=null,this._indicesBuf=null,this.init()}init(){const t=this._scene.canvas.gl;if(this._program=new yt(t,{vertex:["precision highp float;\n                precision highp int;\n                    \n                attribute vec3 aPosition;\n                attribute vec2 aUV;\n                uniform vec2 uViewport;\n                varying vec2 vUV;\n                varying vec2 vInvSize;\n                void main () {\n                    vUV = aUV;\n                    vInvSize = 1.0 / uViewport;\n                    gl_Position = vec4(aPosition, 1.0);\n                }"],fragment:["precision highp float;\n                precision highp int;\n                    \n                #define PI 3.14159265359\n                #define PI2 6.28318530718\n                #define EPSILON 1e-6\n\n                #define KERNEL_RADIUS 16\n\n                varying vec2        vUV;\n                varying vec2        vInvSize;\n            \n                uniform sampler2D   uDepthTexture;\n                uniform sampler2D   uOcclusionTexture;              \n               \n                uniform float       uCameraNear;\n                uniform float       uCameraFar;               \n                uniform float       uDepthCutoff;\n\n                uniform vec2        uSampleOffsets[ KERNEL_RADIUS + 1 ];\n                uniform float       uSampleWeights[ KERNEL_RADIUS + 1 ];\n\n                const float         unpackDownscale = 255. / 256.; \n\n                const vec3          packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\n                const vec4          unpackFactors = unpackDownscale / vec4( packFactors, 1. );   \n\n                const float packUpscale = 256. / 255.;\n       \n                const float shiftRights = 1. / 256.;\n                \n                float unpackRGBAToFloat( const in vec4 v ) {\n                    return dot( floor( v * 255.0 + 0.5 ) / 255.0, unpackFactors );\n                }               \n\n                vec4 packFloatToRGBA( const in float v ) {\n                    vec4 r = vec4( fract( v * packFactors ), v );\n                    r.yzw -= r.xyz * shiftRights; \n                    return r * packUpscale;\n                }\n\n                float viewZToOrthographicDepth( const in float viewZ) {\n                    return ( viewZ + uCameraNear ) / ( uCameraNear - uCameraFar );\n                }\n              \n                float orthographicDepthToViewZ( const in float linearClipZ) {\n                    return linearClipZ * ( uCameraNear - uCameraFar ) - uCameraNear;\n                }\n\n                float viewZToPerspectiveDepth( const in float viewZ) {\n                    return (( uCameraNear + viewZ ) * uCameraFar ) / (( uCameraFar - uCameraNear ) * viewZ );\n                }\n                \n                float perspectiveDepthToViewZ( const in float invClipZ) {\n                    return ( uCameraNear * uCameraFar ) / ( ( uCameraFar - uCameraNear ) * invClipZ - uCameraFar );\n                }\n\n                float getDepth( const in vec2 screenPosition ) {"+(ht.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?"return texture2D(uDepthTexture, screenPosition).r;":"return unpackRGBAToFloat(texture2D( uDepthTexture, screenPosition));")+"}\n\n                float getViewZ( const in float depth ) {\n                     return perspectiveDepthToViewZ( depth );\n                }\n\n                void main() {\n                \n                    float depth = getDepth( vUV );\n                    if( depth >= ( 1.0 - EPSILON ) ) {\n                        discard;\n                    }\n\n                    float centerViewZ = -getViewZ( depth );\n                    bool rBreak = false;\n                    bool lBreak = false;\n\n                    float weightSum = uSampleWeights[0];\n                    float occlusionSum = unpackRGBAToFloat(texture2D( uOcclusionTexture, vUV )) * weightSum;\n\n                    for( int i = 1; i <= KERNEL_RADIUS; i ++ ) {\n\n                        float sampleWeight = uSampleWeights[i];\n                        vec2 sampleUVOffset = uSampleOffsets[i] * vInvSize;\n\n                        vec2 sampleUV = vUV + sampleUVOffset;\n                        float viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            rBreak = true;\n                        }\n\n                        if( ! rBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture2D( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n\n                        sampleUV = vUV - sampleUVOffset;\n                        viewZ = -getViewZ( getDepth( sampleUV ) );\n\n                        if( abs( viewZ - centerViewZ ) > uDepthCutoff ) {\n                            lBreak = true;\n                        }\n\n                        if( ! lBreak ) {\n                            occlusionSum += unpackRGBAToFloat(texture2D( uOcclusionTexture, sampleUV )) * sampleWeight;\n                            weightSum += sampleWeight;\n                        }\n                    }\n\n                    gl_FragColor = packFloatToRGBA(occlusionSum / weightSum);\n                }"]}),this._program.errors)return console.error(this._program.errors.join("\n")),void(this._programError=!0);const e=new Float32Array([1,1,0,1,0,0,1,0]),i=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]),s=new Uint8Array([0,1,2,0,2,3]);this._positionsBuf=new Mt(t,t.ARRAY_BUFFER,i,i.length,3,t.STATIC_DRAW),this._uvBuf=new Mt(t,t.ARRAY_BUFFER,e,e.length,2,t.STATIC_DRAW),this._indicesBuf=new Mt(t,t.ELEMENT_ARRAY_BUFFER,s,s.length,1,t.STATIC_DRAW),this._program.bind(),this._uViewport=this._program.getLocation("uViewport"),this._uCameraNear=this._program.getLocation("uCameraNear"),this._uCameraFar=this._program.getLocation("uCameraFar"),this._uDepthCutoff=this._program.getLocation("uDepthCutoff"),this._uSampleOffsets=t.getUniformLocation(this._program.handle,"uSampleOffsets"),this._uSampleWeights=t.getUniformLocation(this._program.handle,"uSampleWeights"),this._aPosition=this._program.getAttribute("aPosition"),this._aUV=this._program.getAttribute("aUV")}render(t,e,i){if(this._programError)return;this._getInverseProjectMat||(this._getInverseProjectMat=(()=>{let t=!0;this._scene.camera.on("projMatrix",(function(){t=!0}));const e=d.mat4();return()=>(t&&d.inverseMat4(o.camera.projMatrix,e),e)})());const s=this._scene.canvas.gl,r=this._program,o=this._scene,a=s.drawingBufferWidth,n=s.drawingBufferHeight,l=o.camera.project._state,h=l.near,c=l.far;s.viewport(0,0,a,n),s.clearColor(0,0,0,1),s.enable(s.DEPTH_TEST),s.disable(s.BLEND),s.frontFace(s.CCW),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),r.bind(),Rt[0]=a,Rt[1]=n,s.uniform2fv(this._uViewport,Rt),s.uniform1f(this._uCameraNear,h),s.uniform1f(this._uCameraFar,c),s.uniform1f(this._uDepthCutoff,.01),0===i?s.uniform2fv(this._uSampleOffsets,Lt):s.uniform2fv(this._uSampleOffsets,Dt),s.uniform1fv(this._uSampleWeights,Bt);const u=ht.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?t.getDepthTexture():t.getTexture(),p=e.getTexture();r.bindTexture(this._uDepthTexture,u,0),r.bindTexture(this._uOcclusionTexture,p,1),this._aUV.bindArrayBuffer(this._uvBuf),this._aPosition.bindArrayBuffer(this._positionsBuf),this._indicesBuf.bind(),s.drawElements(s.TRIANGLES,this._indicesBuf.numItems,this._indicesBuf.itemType,0)}destroy(){this._program.destroy()}}function Ft(t,e){return Math.exp(-t*t/(e*e*2))/(Math.sqrt(2*Math.PI)*e)}function Nt(t,e){const i=[];for(let s=0;s<=t;s++)i.push(e[0]*s),i.push(e[1]*s);return i}const It=function(){const t=document.createElement("canvas"),e=String.fromCharCode;if(!t.getContext)return{saveAsBMP:function(){},saveAsPNG:function(){},saveAsJPEG:function(){}};const i=!!t.getContext("2d").getImageData,s=!!t.toDataURL,r=!!window.btoa,o=function(t){let i="";const s=t.width,r=t.height;i+="BM";let o=s*r*4+54;i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),o=Math.floor(o/256),i+=e(o%256),i+=e(0,0,0,0,54,0,0,0),i+=e(40,0,0,0);let a=s;i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256),a=Math.floor(a/256),i+=e(a%256);let n=r;i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),n=Math.floor(n/256),i+=e(n%256),i+=e(1,0,32,0),i+=e(0,0,0,0);let l=s*r*4;i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),l=Math.floor(l/256),i+=e(l%256),i+=e(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const h=t.data;let c,u,d,p,_="",f=r;do{for(d=s*(f-1)*4,p="",c=0;c<s;c++)u=4*c,p+=e(h[d+u+2],h[d+u+1],h[d+u],h[d+u+3]);_+=p}while(--f);return function(t){let i,s,r="";if("string"==typeof t)r=t;else for(s=t,i=0;i<s.length;i++)r+=e(s[i]);return btoa(r)}(i+_)},a=function(t){window.open(t)||(document.location.href=t)},n=function(t,e){return"data:"+e+";base64,"+t},l=function(t){const e=document.createElement("img");return e.src=t,e},h=function(t,e,i,s){if(e&&i){const r=document.createElement("canvas");r.width=e,r.height=i,r.style.width=e+"px",r.style.height=i+"px";const o=r.getContext("2d");return s?(o.save(),o.scale(1,-1),o.imageSmoothingEnabled=!0,o.drawImage(t,0,0,t.width,t.height,0,0,e,-i),o.restore()):(o.imageSmoothingEnabled=!0,o.drawImage(t,0,0,t.width,t.height,0,0,e,i)),r}return t};return{saveAsPNG:function(t,e,i,r,o){if(!s)return!1;const n=h(t,i,r,o).toDataURL("image/png");return e?l(n):(a(n),!0)},saveAsJPEG:function(t,e,i,r,o){if(!s)return!1;const n="image/jpeg",c=h(t,i,r,o).toDataURL(n);return 5==c.indexOf(n)&&(e?l(c):(a(c),!0))},saveAsBMP:function(t,e,c,u,d){if(!(s&&i&&r))return!1;const p="image/bmp",_=function(t){const e=parseInt(t.width),i=parseInt(t.height);return t.getContext("2d").getImageData(0,0,e,i)}(h(t,c,u,d)),f=o(_);return e?l(n(f,p)):(a(n(f,p)),!0)}}}();class kt{constructor(t,e,i){i=i||{},this.gl=e,this.allocated=!1,this.canvas=t,this.buffer=null,this.bound=!1,this.size=i.size,this._hasDepthTexture=!!i.depthTexture}setSize(t){this.size=t}webglContextRestored(t){this.gl=t,this.buffer=null,this.allocated=!1,this.bound=!1}bind(){if(this._touch(),this.bound)return;const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,this.buffer.framebuf),this.bound=!0}_touch(){let t,e;const i=this.gl;if(this.size?(t=this.size[0],e=this.size[1]):(t=i.drawingBufferWidth,e=i.drawingBufferHeight),this.buffer){if(this.buffer.width===t&&this.buffer.height===e)return;i.deleteTexture(this.buffer.texture),i.deleteFramebuffer(this.buffer.framebuf),i.deleteRenderbuffer(this.buffer.renderbuf)}const s=i.createTexture();let r;i.bindTexture(i.TEXTURE_2D,s),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,null),this._hasDepthTexture&&(r=i.createTexture(),i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.DEPTH_COMPONENT,t,e,0,i.DEPTH_COMPONENT,i.UNSIGNED_INT,null));const o=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,o),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,t,e);const a=i.createFramebuffer();if(i.bindFramebuffer(i.FRAMEBUFFER,a),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,s,0),this._hasDepthTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,r,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,o),i.bindTexture(i.TEXTURE_2D,null),i.bindRenderbuffer(i.RENDERBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,null),i.bindFramebuffer(i.FRAMEBUFFER,a),!i.isFramebuffer(a))throw"Invalid framebuffer";i.bindFramebuffer(i.FRAMEBUFFER,null);const n=i.checkFramebufferStatus(i.FRAMEBUFFER);switch(n){case i.FRAMEBUFFER_COMPLETE:break;case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT";case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS";case i.FRAMEBUFFER_UNSUPPORTED:throw"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED";default:throw"Incomplete framebuffer: "+n}this.buffer={framebuf:a,renderbuf:o,texture:s,depthTexture:r,width:t,height:e},this.bound=!1}clear(){if(!this.bound)throw"Render buffer not bound";const t=this.gl;t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}read(t,e){const i=t,s=this.gl.drawingBufferHeight-e,r=new Uint8Array(4),o=this.gl;return o.readPixels(i,s,1,1,o.RGBA,o.UNSIGNED_BYTE,r),r}readImage(t){const e=this.gl,i=this._getImageDataCache(),s=i.pixelData,r=i.canvas,o=i.imageData,a=i.context;e.readPixels(0,0,this.buffer.width,this.buffer.height,e.RGBA,e.UNSIGNED_BYTE,s),o.data.set(s),a.putImageData(o,0,0);const n=t.width||r.width,l=t.height||r.height,h=t.format||"jpeg",c=!0;let u;switch(h){case"jpeg":u=It.saveAsJPEG(r,!0,n,l,c);break;case"png":u=It.saveAsPNG(r,!0,n,l,c);break;case"bmp":u=It.saveAsBMP(r,!0,n,l,c);break;default:console.error("Unsupported image format: '"+h+"' - supported types are 'jpeg', 'bmp' and 'png' - defaulting to 'jpeg'"),u=It.saveAsJPEG(r,!0,n,l,c)}return u.src}_getImageDataCache(){const t=this.buffer.width,e=this.buffer.height;let i=this._imageDataCache;if(i&&(i.width===t&&i.height===e||(this._imageDataCache=null,i=null)),!i){const s=document.createElement("canvas");s.width=t,s.height=e;const r=s.getContext("2d"),o=r.createImageData(t,e);i={pixelData:new Uint8Array(t*e*4),canvas:s,context:r,imageData:o,width:t,height:e},this._imageDataCache=i}return i}unbind(){const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,null),this.bound=!1}getTexture(){const t=this;return this._texture||(this._texture={renderBuffer:this,bind:function(e){return!(!t.buffer||!t.buffer.texture)&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.texture),!0)},unbind:function(e){t.buffer&&t.buffer.texture&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}})}hasDepthTexture(){return this._hasDepthTexture}getDepthTexture(){if(!this._hasDepthTexture)return null;const t=this;return this._depthTexture||(this._dethTexture={renderBuffer:this,bind:function(e){return!(!t.buffer||!t.buffer.depthTexture)&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,t.buffer.depthTexture),!0)},unbind:function(e){t.buffer&&t.buffer.depthTexture&&(t.gl.activeTexture(t.gl["TEXTURE"+e]),t.gl.bindTexture(t.gl.TEXTURE_2D,null))}})}destroy(){if(this.allocated){const t=this.gl;t.deleteTexture(this.buffer.texture),t.deleteTexture(this.buffer.depthTexture),t.deleteFramebuffer(this.buffer.framebuf),t.deleteRenderbuffer(this.buffer.renderbuf),this.allocated=!1,this.buffer=null,this.bound=!1}this._imageDataCache=null,this._texture=null,this._depthTexture=null}}class Ot{constructor(t){this.scene=t,this._renderBuffersBasic={},this._renderBuffersScaled={}}getRenderBuffer(t,e){const i=1===this.scene.canvas.resolutionScale?this._renderBuffersBasic:this._renderBuffersScaled;let s=i[t];return s||(s=new kt(this.scene.canvas.canvas,this.scene.canvas.gl,e),i[t]=s),s}destroy(){for(let t in this._renderBuffersBasic)this._renderBuffersBasic[t].destroy();for(let t in this._renderBuffersScaled)this._renderBuffersScaled[t].destroy()}}const Vt=function(e,i){i=i||{};const s=new pt(e),r=e.canvas.canvas,o=e.canvas.gl,a=!!i.transparent,n=i.alphaDepthMask,l=new t({});let h={},c={},u=!0,p=!0,f=!0,g=!0,m=!0,v=!0,b=!0;const P=new Ot(e);let y=!1;const M=new St(e),x=new Tt(e);function w(){u&&(!function(){for(let t in h)if(h.hasOwnProperty(t)){const e=h[t],i=e.drawableMap,s=e.drawableListPreCull;let r=0;for(let t in i)i.hasOwnProperty(t)&&(s[r++]=i[t]);s.length=r}}(),u=!1,p=!0),p&&(!function(){for(let t in h)if(h.hasOwnProperty(t)){const e=h[t];e.isStateSortable&&e.drawableListPreCull.sort(e.stateSortCompare)}}(),p=!1,f=!0),f&&function(){for(let t in h)if(h.hasOwnProperty(t)){const e=h[t],i=e.drawableListPreCull,s=e.drawableList;let r=0;for(let t=0,e=i.length;t<e;t++){const e=i[t];e.rebuildRenderFlags(),e.renderFlags.culled||(s[r++]=e)}s.length=r}}()}function E(t){if(!t.castsShadow)return;const e=t.getShadowRenderBuf();if(e){e.bind(),s.reset(),s.backfaces=!0,s.frontface=!0,s.shadowViewMatrix=t.getShadowViewMatrix(),s.shadowProjMatrix=t.getShadowProjMatrix(),o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,1),o.enable(o.DEPTH_TEST),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(let t in h)if(h.hasOwnProperty(t)){const e=h[t].drawableList;for(let t=0,i=e.length;t<i;t++){const i=e[t];!1!==i.visible&&i.castsShadow&&i.drawShadow&&(i.renderFlags.colorOpaque&&i.drawShadow(s))}}e.unbind()}}this._occlusionTester=null,this.setTransparentEnabled=function(t){g=t,f=!0},this.setEdgesEnabled=function(t){m=t,f=!0},this.setSAOEnabled=function(t){v=t,f=!0},this.setPBREnabled=function(t){b=t,f=!0},this.needStateSort=function(){p=!0},this.shadowsDirty=function(){},this.imageDirty=function(){f=!0},this.webglContextLost=function(){},this.webglContextRestored=function(t){M.init(),x.init(),f=!0},this.addDrawable=function(t,e){const i=e.type;if(!i)return void console.error("Renderer#addDrawable() : drawable with ID "+t+" has no 'type' - ignoring");let s=h[i];s||(s={type:e.type,count:0,isStateSortable:e.isStateSortable,stateSortCompare:e.stateSortCompare,drawableMap:{},drawableListPreCull:[],drawableList:[]},h[i]=s),s.count++,s.drawableMap[t]=e,c[t]=e,u=!0},this.removeDrawable=function(t){const e=c[t];if(!e)return void console.error("Renderer#removeDrawable() : drawable not found with ID "+t+" - ignoring");const i=e.type,s=h[i];--s.count<=0?delete h[i]:delete s.drawableMap[t],delete c[t],u=!0},this.getPickID=function(t){return l.addItem(t)},this.putPickID=function(t){l.removeItem(t)},this.clear=function(t){if(o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),a)o.clearColor(1,1,1,1);else{const t=e.canvas.backgroundColorFromAmbientLight?this.lights.getAmbientColorAndIntensity():e.canvas.backgroundColor;o.clearColor(t[0],t[1],t[2],1)}o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT)},this.needsRender=function(){return f||u||p},this.render=function(t){(t=t||{}).force&&(f=!0),w(),f&&(!function(t){ht.SUPPORTED_EXTENSIONS.OES_element_index_uint&&o.getExtension("OES_element_index_uint");e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.getExtension("EXT_frag_depth");ht.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&o.getExtension("WEBGL_depth_texture");const i=e.sao;v&&i.possible&&function(t){const i=e.sao,r=P.getRenderBuffer("saoDepth",{depthTexture:ht.SUPPORTED_EXTENSIONS.WEBGL_depth_texture});r.bind(),r.clear(),function(t){s.reset(),s.pass=t.pass,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.frontFace(o.CCW),o.enable(o.CULL_FACE),o.depthMask(!0),!1!==t.clear&&o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(let t in h)if(h.hasOwnProperty(t)){const e=h[t].drawableList;for(let t=0,i=e.length;t<i;t++){const i=e[t];!0!==i.culled&&!1!==i.visible&&i.drawDepth&&(i.renderFlags.colorOpaque&&i.drawDepth(s))}}}(t),r.unbind();const a=P.getRenderBuffer("saoOcclusion");if(a.bind(),a.clear(),M.render(r),a.unbind(),i.blur){const t=P.getRenderBuffer("saoOcclusion2");t.bind(),t.clear(),x.render(r,a,0),t.unbind(),a.bind(),a.clear(),x.render(r,t,1),a.unbind()}}(t);(function(){let t=e._lightsState.lights;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.castsShadow&&E(i)}})(),A(t)}(t),_.frame.frameCount++,f=!1)};const A=function(){const t=[],i=[],r=[],l=[],c=[],u=[],d=[],p=[],f=[],y=[],M=[],x=[],w=[],E=[],A=[],C=[];return function(S){const D=e._lightsState.getAmbientColorAndIntensity();if(s.reset(),s.pass=S.pass,s.withSAO=!1,s.pbrEnabled=b&&!!e.pbrEnabled,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),a)o.clearColor(0,0,0,0);else{const t=e.canvas.backgroundColorFromAmbientLight?D:e.canvas.backgroundColor;o.clearColor(t[0],t[1],t[2],1)}o.enable(o.DEPTH_TEST),o.frontFace(o.CCW),o.enable(o.CULL_FACE),o.depthMask(!0),o.lineWidth(1),s.lineWidth=1;const L=e.sao.possible;if(v&&L){const t=P.getRenderBuffer("saoOcclusion");s.occlusionTexture=t?t.getTexture():null}else s.occlusionTexture=null;let B,R,T;const F=Date.now();!1!==S.clear&&o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);let N=0,I=0,k=0,O=0,V=0,z=0,U=0,G=0,j=0,X=0,W=0,H=0,Y=0,K=0,q=0,Z=0;for(let e in h)if(h.hasOwnProperty(e)){const o=h[e].drawableList;for(B=0,R=o.length;B<R;B++){if(T=o[B],!0===T.culled||!1===T.visible)continue;const e=T.renderFlags;e.colorOpaque&&(v&&L&&T.saoEnabled?t[N++]=T:T.drawColorOpaque(s)),g&&e.colorTransparent&&(r[k++]=T),e.xrayedSilhouetteTransparent&&(d[U++]=T),e.xrayedSilhouetteOpaque&&(c[V++]=T),e.highlightedSilhouetteTransparent&&(M[W++]=T),e.highlightedSilhouetteOpaque&&(f[j++]=T),e.selectedSilhouetteTransparent&&(A[q++]=T),e.selectedSilhouetteOpaque&&(w[Y++]=T),m&&(e.edgesOpaque&&(i[I++]=T),e.edgesTransparent&&(l[O++]=T)),e.selectedEdgesTransparent&&(C[Z++]=T),e.selectedEdgesOpaque&&(E[K++]=T),e.xrayedEdgesTransparent&&(p[G++]=T),e.xrayedEdgesOpaque&&(u[z++]=T),e.highlightedEdgesTransparent&&(x[H++]=T),e.highlightedEdgesOpaque&&(y[X++]=T)}}if(N>0)for(s.withSAO=!0,B=0;B<N;B++)t[B].drawColorOpaque(s);if(I>0)for(B=0;B<I;B++)i[B].drawEdgesColorOpaque(s);if(V>0)for(B=0;B<V;B++)c[B].drawSilhouetteXRayed(s);if(z>0)for(B=0;B<z;B++)u[B].drawEdgesXRayed(s);if(U>0||G>0||k>0||O>0){if(o.enable(o.CULL_FACE),o.enable(o.BLEND),a?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):(o.blendEquation(o.FUNC_ADD),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA)),s.backfaces=!1,n||o.depthMask(!1),G>0)for(B=0;B<G;B++)p[B].drawEdgesXRayed(s);if(U>0)for(B=0;B<U;B++)d[B].drawSilhouetteXRayed(s);if((k>0||O>0)&&o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),O>0)for(B=0;B<O;B++)T=l[B],T.drawEdgesColorTransparent(s);if(k>0)for(B=0;B<k;B++)T=r[B],T.drawColorTransparent(s);o.disable(o.BLEND),n||o.depthMask(!0)}if(j>0||X>0){if(s.lastProgramId=null,o.clear(o.DEPTH_BUFFER_BIT),X>0)for(B=0;B<X;B++)y[B].drawEdgesHighlighted(s);if(j>0)for(B=0;B<j;B++)f[B].drawSilhouetteHighlighted(s)}if(W>0||H>0||j>0){if(s.lastProgramId=null,o.clear(o.DEPTH_BUFFER_BIT),o.enable(o.CULL_FACE),o.enable(o.BLEND),a?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),H>0)for(B=0;B<H;B++)x[B].drawEdgesHighlighted(s);if(W>0)for(B=0;B<W;B++)M[B].drawSilhouetteHighlighted(s);o.disable(o.BLEND)}if(Y>0||K>0){if(s.lastProgramId=null,o.clear(o.DEPTH_BUFFER_BIT),K>0)for(B=0;B<K;B++)E[B].drawEdgesSelected(s);if(Y>0)for(B=0;B<Y;B++)w[B].drawSilhouetteSelected(s)}if(q>0||Z>0){if(s.lastProgramId=null,o.clear(o.DEPTH_BUFFER_BIT),o.enable(o.CULL_FACE),o.enable(o.BLEND),a?(o.blendEquation(o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA)):o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),Z>0)for(B=0;B<Z;B++)C[B].drawEdgesSelected(s);if(q>0)for(B=0;B<q;B++)A[B].drawSilhouetteSelected(s);o.disable(o.BLEND)}const Q=Date.now(),$=_.frame;$.renderTime=(Q-F)/1e3,$.drawElements=s.drawElements,$.drawArrays=s.drawArrays,$.useProgram=s.useProgram,$.bindTexture=s.bindTexture,$.bindArray=s.bindArray;const J=ht.MAX_TEXTURE_UNITS;for(let t=0;t<J;t++)o.activeTexture(o.TEXTURE0+t);o.bindTexture(o.TEXTURE_CUBE_MAP,null),o.bindTexture(o.TEXTURE_2D,null);const tt=ht.MAX_VERTEX_ATTRIBS;for(let t=0;t<tt;t++)o.disableVertexAttribArray(t)}}();this.pick=function(){const t=d.vec3(),i=d.mat4(),a=d.mat4(),n=d.vec3(),c=d.vec3([0,1,0]),u=new _t,p=d.vec2(),_=d.vec3(),f=d.vec3(),g=d.vec3(),m=d.vec3(),v=d.vec3();return function(b,y=u){let M;y.reset(),w(),ht.SUPPORTED_EXTENSIONS.OES_element_index_uint&&o.getExtension("OES_element_index_uint"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.getExtension("EXT_frag_depth"),ht.SUPPORTED_EXTENSIONS.WEBGL_depth_texture&&o.getExtension("WEBGL_depth_texture");let x=null,E=null;if(y.pickSurface=b.pickSurface,b.canvasPos)_[0]=b.canvasPos[0],_[1]=b.canvasPos[1],x=e.camera.viewMatrix,E=e.camera.projMatrix,y.canvasPos=b.canvasPos;else{const s=d.frustumMat4(-1,1,-1,1,.01,e.camera.project.far,i);b.matrix?(x=b.matrix,E=s):(f.set(b.origin||[0,0,0]),g.set(b.direction||[0,0,1]),M=d.addVec3(f,g,t),n[0]=Math.random(),n[1]=Math.random(),n[2]=Math.random(),d.normalizeVec3(n),d.cross3Vec3(g,n,c),x=d.lookAtMat4v(f,M,c,a),E=s,y.origin=f,y.direction=g),_[0]=.5*r.clientWidth,_[1]=.5*r.clientHeight}const A=P.getRenderBuffer("pick");A.bind();const S=function(t,i,r,a,n){s.reset(),s.backfaces=!0,s.frontface=!0,s.pickViewMatrix=r,s.pickProjMatrix=a,s.pickInvisible=!!n.pickInvisible,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);const c=n.includeEntityIds,u=n.excludeEntityIds;for(let t in h)if(h.hasOwnProperty(t)){const e=h[t].drawableList;for(let t=0,i=e.length;t<i;t++){const i=e[t];!i.drawPickMesh||!0===i.culled||!0!==n.pickInvisible&&!1===i.visible||!1===i.pickable||(c&&!c[i.id]||u&&u[i.id]||i.drawPickMesh(s))}}const d=e.canvas.resolutionScale,p=t.read(Math.round(i[0]*d),Math.round(i[1]*d));let _=p[0]+256*p[1]+256*p[2]*256+256*p[3]*256*256;if(_<0)return;return l.items[_]}(A,_,x,E,b);if(!S)return A.unbind(),null;const D=S.delegatePickedEntity?S.delegatePickedEntity():S;return D?(b.pickSurface&&(b.pickSurfacePrecision&&e.pickSurfacePrecisionEnabled?(b.canvasPos&&d.canvasPosToWorldRay(e.canvas.canvas,x,E,_,f,g),S.precisionRayPickSurface(f,g,m,v)&&(y.worldPos=m,!1!==b.pickSurfaceNormal&&(y.worldNormal=v),y.pickSurfacePrecision=!0)):S.canPickTriangle&&S.canPickTriangle()?(!function(t,i,r,a,n,l){if(!i.drawPickTriangles)return;s.reset(),s.backfaces=!0,s.frontface=!0,s.pickViewMatrix=a,s.pickProjMatrix=n,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),i.drawPickTriangles(s);const h=e.canvas.resolutionScale,c=t.read(Math.round(r[0]*h),Math.round(r[1]*h));let u=c[0]+256*c[1]+256*c[2]*256+256*c[3]*256*256;u*=3,l.primIndex=u}(A,S,_,x,E,y),S.pickTriangleSurface(x,E,y),y.pickSurfacePrecision=!1):S.canPickWorldPos&&S.canPickWorldPos()&&(p[0]=e.camera.project.near,p[1]=e.camera.project.far,C(A,S,_,x,E,p,y),!1!==b.pickSurfaceNormal&&function(t,i,r,a,n,l){s.reset(),s.backfaces=!0,s.frontface=!0,s.pickViewMatrix=a,s.pickProjMatrix=n,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),i.drawPickNormals(s);const h=e.canvas.resolutionScale,c=t.read(Math.round(r[0]*h),Math.round(r[1]*h)),u=[c[0]/256-.5,c[1]/256-.5,c[2]/256-.5];d.normalizeVec3(u),l.worldNormal=u}(A,S,_,x,E,y),y.pickSurfacePrecision=!1)),A.unbind(),y.entity=D,y):(A.unbind(),null)}}();const C=function(){const t=d.vec4(),i=d.vec4(),a=d.vec4(),n=d.vec4(),l=d.vec4(),h=d.mat4(),c=d.mat4(),u=d.mat4();return function(p,_,f,g,m,v,b){s.reset(),s.backfaces=!0,s.frontface=!0,s.pickViewMatrix=g,s.pickProjMatrix=m,s.pickZNear=v[0],s.pickZFar=v[1],o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT),_.drawPickDepths(s);const P=e.canvas.resolutionScale,y=function(t){const e=[t[0]/256,t[1]/256,t[2]/256,t[3]/256],i=[1/16777216,1/65536,1/256,1];return d.dotVec4(e,i)}(p.read(Math.round(f[0]*P),Math.round(f[1]*P))),M=(f[0]-r.clientWidth/2)/(r.clientWidth/2),x=-(f[1]-r.clientHeight/2)/(r.clientHeight/2),w=_.origin;let E;if(w){const t=G(g,w,h);E=d.mulMat4(m,t,c)}else E=d.mulMat4(m,g,c);const A=d.inverseMat4(E,u);t[0]=M,t[1]=x,t[2]=-1,t[3]=1;let C=d.transformVec4(A,t);C=d.mulVec4Scalar(C,1/C[3]),i[0]=M,i[1]=x,i[2]=1,i[3]=1;let S=d.transformVec4(A,i);S=d.mulVec4Scalar(S,1/S[3]);const D=d.subVec3(S,C,a),L=d.addVec3(C,d.mulVec4Scalar(D,y,n),l);w&&d.addVec3(L,w),b.worldPos=L}}();this.addMarker=function(t){this._occlusionTester=this._occlusionTester||new At(e,P),this._occlusionTester.addMarker(t),e.occlusionTestCountdown=0},this.markerWorldPosUpdated=function(t){this._occlusionTester.markerWorldPosUpdated(t)},this.removeMarker=function(t){this._occlusionTester.removeMarker(t)},this.doOcclusionTest=function(){if(this._occlusionTester&&this._occlusionTester.needOcclusionTest){w(),this._occlusionTester.bindRenderBuf(),s.reset(),s.backfaces=!0,s.frontface=!0,o.viewport(0,0,o.drawingBufferWidth,o.drawingBufferHeight),o.clearColor(0,0,0,0),o.enable(o.DEPTH_TEST),o.disable(o.CULL_FACE),o.disable(o.BLEND),o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);for(let t in h)if(h.hasOwnProperty(t)){const e=h[t].drawableList;for(let t=0,i=e.length;t<i;t++){const i=e[t];i.drawOcclusion&&!0!==i.culled&&!1!==i.visible&&!1!==i.pickable&&i.drawOcclusion(s)}}this._occlusionTester.drawMarkers(s),this._occlusionTester.doOcclusionTest(),this._occlusionTester.unbindRenderBuf()}},this.readPixels=function(t,e,i,s){const r=P.getRenderBuffer("snapshot");let o,a,n,l;for(r.bind(),r.clear(),this.render({force:!0,opaqueOnly:s}),a=0;a<i;a++)n=2*a,l=4*a,o=r.read(t[n],t[n+1]),e[l]=o[0],e[l+1]=o[1],e[l+2]=o[2],e[l+3]=o[3];r.unbind(),f=!0},this.beginSnapshot=function(){const t=P.getRenderBuffer("snapshot");t.bind(),t.clear(),y=!0},this.renderSnapshot=function(){if(!y)return;P.getRenderBuffer("snapshot").clear(),this.render({force:!0,opaqueOnly:!1}),f=!0},this.readSnapshot=function(t){return P.getRenderBuffer("snapshot").readImage(t)},this.endSnapshot=function(){if(!y)return;P.getRenderBuffer("snapshot").unbind(),y=!1},this.destroy=function(){h={},c={},P.destroy(),M.destroy(),x.destroy(),this._occlusionTester&&this._occlusionTester.destroy()}};class zt extends S{constructor(t,e={}){super(t,e),this.KEY_BACKSPACE=8,this.KEY_TAB=9,this.KEY_ENTER=13,this.KEY_SHIFT=16,this.KEY_CTRL=17,this.KEY_ALT=18,this.KEY_PAUSE_BREAK=19,this.KEY_CAPS_LOCK=20,this.KEY_ESCAPE=27,this.KEY_PAGE_UP=33,this.KEY_PAGE_DOWN=34,this.KEY_END=35,this.KEY_HOME=36,this.KEY_LEFT_ARROW=37,this.KEY_UP_ARROW=38,this.KEY_RIGHT_ARROW=39,this.KEY_DOWN_ARROW=40,this.KEY_INSERT=45,this.KEY_DELETE=46,this.KEY_NUM_0=48,this.KEY_NUM_1=49,this.KEY_NUM_2=50,this.KEY_NUM_3=51,this.KEY_NUM_4=52,this.KEY_NUM_5=53,this.KEY_NUM_6=54,this.KEY_NUM_7=55,this.KEY_NUM_8=56,this.KEY_NUM_9=57,this.KEY_A=65,this.KEY_B=66,this.KEY_C=67,this.KEY_D=68,this.KEY_E=69,this.KEY_F=70,this.KEY_G=71,this.KEY_H=72,this.KEY_I=73,this.KEY_J=74,this.KEY_K=75,this.KEY_L=76,this.KEY_M=77,this.KEY_N=78,this.KEY_O=79,this.KEY_P=80,this.KEY_Q=81,this.KEY_R=82,this.KEY_S=83,this.KEY_T=84,this.KEY_U=85,this.KEY_V=86,this.KEY_W=87,this.KEY_X=88,this.KEY_Y=89,this.KEY_Z=90,this.KEY_LEFT_WINDOW=91,this.KEY_RIGHT_WINDOW=92,this.KEY_SELECT_KEY=93,this.KEY_NUMPAD_0=96,this.KEY_NUMPAD_1=97,this.KEY_NUMPAD_2=98,this.KEY_NUMPAD_3=99,this.KEY_NUMPAD_4=100,this.KEY_NUMPAD_5=101,this.KEY_NUMPAD_6=102,this.KEY_NUMPAD_7=103,this.KEY_NUMPAD_8=104,this.KEY_NUMPAD_9=105,this.KEY_MULTIPLY=106,this.KEY_ADD=107,this.KEY_SUBTRACT=109,this.KEY_DECIMAL_POINT=110,this.KEY_DIVIDE=111,this.KEY_F1=112,this.KEY_F2=113,this.KEY_F3=114,this.KEY_F4=115,this.KEY_F5=116,this.KEY_F6=117,this.KEY_F7=118,this.KEY_F8=119,this.KEY_F9=120,this.KEY_F10=121,this.KEY_F11=122,this.KEY_F12=123,this.KEY_NUM_LOCK=144,this.KEY_SCROLL_LOCK=145,this.KEY_SEMI_COLON=186,this.KEY_EQUAL_SIGN=187,this.KEY_COMMA=188,this.KEY_DASH=189,this.KEY_PERIOD=190,this.KEY_FORWARD_SLASH=191,this.KEY_GRAVE_ACCENT=192,this.KEY_OPEN_BRACKET=219,this.KEY_BACK_SLASH=220,this.KEY_CLOSE_BRACKET=221,this.KEY_SINGLE_QUOTE=222,this.KEY_SPACE=32,this.element=e.element,this.altDown=!1,this.ctrlDown=!1,this.mouseDownLeft=!1,this.mouseDownMiddle=!1,this.mouseDownRight=!1,this.keyDown=[],this.enabled=!0,this.keyboardEnabled=!0,this.mouseover=!1,this.mouseCanvasPos=d.vec2(),this._keyboardEventsElement=e.keyboardEventsElement||document,this._bindEvents()}_bindEvents(){if(!this._eventsBound){this._keyboardEventsElement.addEventListener("keydown",this._keyDownListener=t=>{this.enabled&&this.keyboardEnabled&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.keyCode===this.KEY_CTRL?this.ctrlDown=!0:t.keyCode===this.KEY_ALT?this.altDown=!0:t.keyCode===this.KEY_SHIFT&&(this.shiftDown=!0),this.keyDown[t.keyCode]=!0,this.fire("keydown",t.keyCode,!0))},!1),this._keyboardEventsElement.addEventListener("keyup",this._keyUpListener=t=>{this.enabled&&this.keyboardEnabled&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&(t.keyCode===this.KEY_CTRL?this.ctrlDown=!1:t.keyCode===this.KEY_ALT?this.altDown=!1:t.keyCode===this.KEY_SHIFT&&(this.shiftDown=!1),this.keyDown[t.keyCode]=!1,this.fire("keyup",t.keyCode,!0))}),this.element.addEventListener("mouseenter",this._mouseEnterListener=t=>{this.enabled&&(this.mouseover=!0,this._getMouseCanvasPos(t),this.fire("mouseenter",this.mouseCanvasPos,!0))}),this.element.addEventListener("mouseleave",this._mouseLeaveListener=t=>{this.enabled&&(this.mouseover=!1,this._getMouseCanvasPos(t),this.fire("mouseleave",this.mouseCanvasPos,!0))}),this.element.addEventListener("mousedown",this._mouseDownListener=t=>{if(this.enabled){switch(t.which){case 1:this.mouseDownLeft=!0;break;case 2:this.mouseDownMiddle=!0;break;case 3:this.mouseDownRight=!0}this._getMouseCanvasPos(t),this.element.focus(),this.fire("mousedown",this.mouseCanvasPos,!0),this.mouseover&&t.preventDefault()}}),document.addEventListener("mouseup",this._mouseUpListener=t=>{if(this.enabled){switch(t.which){case 1:this.mouseDownLeft=!1;break;case 2:this.mouseDownMiddle=!1;break;case 3:this.mouseDownRight=!1}this.fire("mouseup",this.mouseCanvasPos,!0)}},!0),document.addEventListener("click",this._clickListener=t=>{if(this.enabled){switch(t.which){case 1:case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1}this._getMouseCanvasPos(t),this.fire("click",this.mouseCanvasPos,!0),this.mouseover&&t.preventDefault()}}),document.addEventListener("dblclick",this._dblClickListener=t=>{if(this.enabled){switch(t.which){case 1:case 3:this.mouseDownLeft=!1,this.mouseDownRight=!1;break;case 2:this.mouseDownMiddle=!1}this._getMouseCanvasPos(t),this.fire("dblclick",this.mouseCanvasPos,!0),this.mouseover&&t.preventDefault()}}),this.element.addEventListener("mousemove",this._mouseMoveListener=t=>{this.enabled&&(this._getMouseCanvasPos(t),this.fire("mousemove",this.mouseCanvasPos,!0),this.mouseover&&t.preventDefault())}),this.element.addEventListener("wheel",this._mouseWheelListener=(t,e)=>{if(!this.enabled)return;const i=Math.max(-1,Math.min(1,40*-t.deltaY));this.fire("mousewheel",i,!0)},{passive:!0});{let t,e;const i=2;this.on("mousedown",(i=>{t=i[0],e=i[1]})),this.on("mouseup",(s=>{t>=s[0]-i&&t<=s[0]+i&&e>=s[1]-i&&e<=s[1]+i&&this.fire("mouseclicked",s,!0)}))}this._eventsBound=!0}}_unbindEvents(){this._eventsBound&&(this._keyboardEventsElement.removeEventListener("keydown",this._keyDownListener),this._keyboardEventsElement.removeEventListener("keyup",this._keyUpListener),this.element.removeEventListener("mouseenter",this._mouseEnterListener),this.element.removeEventListener("mouseleave",this._mouseLeaveListener),this.element.removeEventListener("mousedown",this._mouseDownListener),document.removeEventListener("mouseup",this._mouseDownListener),document.removeEventListener("click",this._clickListener),document.removeEventListener("dblclick",this._dblClickListener),this.element.removeEventListener("mousemove",this._mouseMoveListener),this.element.removeEventListener("wheel",this._mouseWheelListener),window.OrientationChangeEvent&&window.removeEventListener("orientationchange",this._orientationchangedListener),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",this._deviceMotionListener),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",this._deviceOrientListener),this._eventsBound=!1)}_getMouseCanvasPos(t){if(t){let e=t.target,i=0,s=0;for(;e.offsetParent;)i+=e.offsetLeft,s+=e.offsetTop,e=e.offsetParent;this.mouseCanvasPos[0]=t.pageX-i,this.mouseCanvasPos[1]=t.pageY-s}else t=window.event,this.mouseCanvasPos[0]=t.x,this.mouseCanvasPos[1]=t.y}setEnabled(t){this.enabled!==t&&this.fire("enabled",this.enabled=t)}getEnabled(){return this.enabled}setKeyboardEnabled(t){this.keyboardEnabled=t}getKeyboardEnabled(){return this.keyboardEnabled}destroy(){super.destroy(),this._unbindEvents()}}const Ut=new t({});class Gt{constructor(t){this.id=Ut.addItem({});for(const e in t)t.hasOwnProperty(e)&&(this[e]=t[e])}destroy(){Ut.removeItem(this.id)}}class jt extends S{get type(){return"Viewport"}constructor(t,e={}){super(t,e),this._state=new Gt({boundary:[0,0,100,100]}),this.boundary=e.boundary,this.autoBoundary=e.autoBoundary}set boundary(t){if(!this._autoBoundary){if(!t){const e=this.scene.canvas.boundary;t=[0,0,e[2],e[3]]}this._state.boundary=t,this.glRedraw(),this.fire("boundary",this._state.boundary)}}get boundary(){return this._state.boundary}set autoBoundary(t){(t=!!t)!==this._autoBoundary&&(this._autoBoundary=t,this._autoBoundary?this._onCanvasSize=this.scene.canvas.on("boundary",(function(t){const e=t[2],i=t[3];this._state.boundary=[0,0,e,i],this.glRedraw(),this.fire("boundary",this._state.boundary)}),this):this._onCanvasSize&&(this.scene.canvas.off(this._onCanvasSize),this._onCanvasSize=null),this.fire("autoBoundary",this._autoBoundary))}get autoBoundary(){return this._autoBoundary}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}class Xt extends S{get type(){return"Perspective"}constructor(t,e={}){super(t,e),this.camera=t,this._state=new Gt({matrix:d.mat4(),inverseMatrix:d.mat4(),transposedMatrix:d.mat4(),near:.1,far:2e3}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this._fov=60,this._canvasResized=this.scene.canvas.on("boundary",this._needUpdate,this),this.fov=e.fov,this.fovAxis=e.fovAxis,this.near=e.near,this.far=e.far}_update(){const t=this.scene.viewport.boundary,e=t[2]/t[3],i=this._fovAxis;let s=this._fov;("x"===i||"min"===i&&e<1||"max"===i&&e>1)&&(s/=e),s=Math.min(s,120),d.perspectiveMat4(s*(Math.PI/180),e,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set fov(t){(t=null!=t?t:60)!==this._fov&&(this._fov=t,this._needUpdate(0),this.fire("fov",this._fov))}get fov(){return this._fov}set fovAxis(t){t=t||"min",this._fovAxis!==t&&("x"!==t&&"y"!==t&&"min"!==t&&(this.error("Unsupported value for 'fovAxis': "+t+" - defaulting to 'min'"),t="min"),this._fovAxis=t,this._needUpdate(0),this.fire("fovAxis",this._fovAxis))}get fovAxis(){return this._fovAxis}set near(t){const e=null!=t?t:.1;this._state.near!==e&&(this._state.near=e,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(t){const e=null!=t?t:2e3;this._state.far!==e&&(this._state.far=e,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(d.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(d.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(t,e,i,s,r){const o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-n)/n,i[2]=e,i[3]=1,d.mulMat4v4(this.inverseMatrix,i,s),d.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,d.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._canvasResized)}}class Wt extends S{get type(){return"Ortho"}constructor(t,e={}){super(t,e),this.camera=t,this._state=new Gt({matrix:d.mat4(),inverseMatrix:d.mat4(),transposedMatrix:d.mat4(),near:.1,far:2e3}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.scale=e.scale,this.near=e.near,this.far=e.far,this._onCanvasBoundary=this.scene.canvas.on("boundary",this._needUpdate,this)}_update(){const t=this.scene,e=.5*this._scale,i=t.viewport.boundary,s=i[2],r=i[3],o=s/r;let a,n,l,h;s>r?(a=-e,n=e,l=e/o,h=-e/o):(a=-e*o,n=e*o,l=e,h=-e),d.orthoMat4c(a,n,h,l,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set scale(t){null==t&&(t=1),t<=0&&(t=.01),this._scale=t,this._needUpdate(0),this.fire("scale",this._scale)}get scale(){return this._scale}set near(t){const e=null!=t?t:.1;this._state.near!==e&&(this._state.near=e,this._needUpdate(0),this.fire("near",this._state.near))}get near(){return this._state.near}set far(t){const e=null!=t?t:2e3;this._state.far!==e&&(this._state.far=e,this._needUpdate(0),this.fire("far",this._state.far))}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(d.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(d.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(t,e,i,s,r){const o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-n)/n,i[2]=e,i[3]=1,d.mulMat4v4(this.inverseMatrix,i,s),d.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,d.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),this.scene.canvas.off(this._onCanvasBoundary)}}class Ht extends S{get type(){return"Frustum"}constructor(t,e={}){super(t,e),this.camera=t,this._state=new Gt({matrix:d.mat4(),inverseMatrix:d.mat4(),transposedMatrix:d.mat4(),near:.1,far:1e4}),this._left=-1,this._right=1,this._bottom=-1,this._top=1,this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this.top=e.top,this.near=e.near,this.far=e.far}_update(){d.frustumMat4(this._left,this._right,this._bottom,this._top,this._state.near,this._state.far,this._state.matrix),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("matrix",this._state.matrix)}set left(t){this._left=null!=t?t:-1,this._needUpdate(0),this.fire("left",this._left)}get left(){return this._left}set right(t){this._right=null!=t?t:1,this._needUpdate(0),this.fire("right",this._right)}get right(){return this._right}set top(t){this._top=null!=t?t:1,this._needUpdate(0),this.fire("top",this._top)}get top(){return this._top}set bottom(t){this._bottom=null!=t?t:-1,this._needUpdate(0),this.fire("bottom",this._bottom)}get bottom(){return this._bottom}set near(t){this._state.near=null!=t?t:.1,this._needUpdate(0),this.fire("near",this._state.near)}get near(){return this._state.near}set far(t){this._state.far=null!=t?t:1e4,this._needUpdate(0),this.fire("far",this._state.far)}get far(){return this._state.far}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(d.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(d.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(t,e,i,s,r){const o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-n)/n,i[2]=e,i[3]=1,d.mulMat4v4(this.inverseMatrix,i,s),d.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,d.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy(),super.destroy()}}class Yt extends S{get type(){return"CustomProjection"}constructor(t,e={}){super(t,e),this.camera=t,this._state=new Gt({matrix:d.mat4(),inverseMatrix:d.mat4(),transposedMatrix:d.mat4()}),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!1,this.matrix=e.matrix}set matrix(t){this._state.matrix.set(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._inverseMatrixDirty=!0,this._transposedMatrixDirty=!0,this.glRedraw(),this.fire("far",this._state.matrix)}get matrix(){return this._state.matrix}get inverseMatrix(){return this._updateScheduled&&this._doUpdate(),this._inverseMatrixDirty&&(d.inverseMat4(this._state.matrix,this._state.inverseMatrix),this._inverseMatrixDirty=!1),this._state.inverseMatrix}get transposedMatrix(){return this._updateScheduled&&this._doUpdate(),this._transposedMatrixDirty&&(d.transposeMat4(this._state.matrix,this._state.transposedMatrix),this._transposedMatrixDirty=!1),this._state.transposedMatrix}unproject(t,e,i,s,r){const o=this.scene.canvas.canvas,a=o.offsetWidth/2,n=o.offsetHeight/2;return i[0]=(t[0]-a)/a,i[1]=(t[1]-n)/n,i[2]=e,i[3]=1,d.mulMat4v4(this.inverseMatrix,i,s),d.mulVec3Scalar(s,1/s[3]),s[3]=1,s[1]*=-1,d.mulMat4v4(this.camera.inverseViewMatrix,s,r),r}destroy(){super.destroy(),this._state.destroy()}}const Kt=d.vec3(),qt=d.vec3(),Zt=d.vec3(),Qt=d.vec3(),$t=d.vec3(),Jt=d.vec3(),te=d.mat4(),ee=d.mat4(),ie=d.vec3(),se=d.vec3(),re=d.vec3(),oe=d.vec3();class ae extends S{get type(){return"Camera"}constructor(t,e={}){super(t,e),this._state=new Gt({deviceMatrix:d.mat4(),hasDeviceMatrix:!1,matrix:d.mat4(),normalMatrix:d.mat4(),inverseMatrix:d.mat4()}),this._perspective=new Xt(this),this._ortho=new Wt(this),this._frustum=new Ht(this),this._customProjection=new Yt(this),this._project=this._perspective,this._eye=d.vec3([0,0,10]),this._look=d.vec3([0,0,0]),this._up=d.vec3([0,1,0]),this._worldUp=d.vec3([0,1,0]),this._worldRight=d.vec3([1,0,0]),this._worldForward=d.vec3([0,0,-1]),this.deviceMatrix=e.deviceMatrix,this.eye=e.eye,this.look=e.look,this.up=e.up,this.worldAxis=e.worldAxis,this.gimbalLock=e.gimbalLock,this.constrainPitch=e.constrainPitch,this.projection=e.projection,this._perspective.on("matrix",(()=>{"perspective"===this._projectionType&&this.fire("projMatrix",this._perspective.matrix)})),this._ortho.on("matrix",(()=>{"ortho"===this._projectionType&&this.fire("projMatrix",this._ortho.matrix)})),this._frustum.on("matrix",(()=>{"frustum"===this._projectionType&&this.fire("projMatrix",this._frustum.matrix)})),this._customProjection.on("matrix",(()=>{"customProjection"===this._projectionType&&this.fire("projMatrix",this._customProjection.matrix)}))}_update(){const t=this._state;let e;"ortho"===this.projection?(d.subVec3(this._eye,this._look,ie),d.normalizeVec3(ie,se),d.mulVec3Scalar(se,1e3,re),d.addVec3(this._look,re,oe),e=oe):e=this._eye,t.hasDeviceMatrix?(d.lookAtMat4v(e,this._look,this._up,ee),d.mulMat4(t.deviceMatrix,ee,t.matrix)):d.lookAtMat4v(e,this._look,this._up,t.matrix),d.inverseMat4(this._state.matrix,this._state.inverseMatrix),d.transposeMat4(this._state.inverseMatrix,this._state.normalMatrix),this.glRedraw(),this.fire("matrix",this._state.matrix),this.fire("viewMatrix",this._state.matrix)}orbitYaw(t){let e=d.subVec3(this._eye,this._look,Kt);d.rotationMat4v(.0174532925*t,this._gimbalLock?this._worldUp:this._up,te),e=d.transformPoint3(te,e,qt),this.eye=d.addVec3(this._look,e,Zt),this.up=d.transformPoint3(te,this._up,Qt)}orbitPitch(t){if(this._constrainPitch&&(t=d.dotVec3(this._up,this._worldUp)/d.DEGTORAD)<1)return;let e=d.subVec3(this._eye,this._look,Kt);const i=d.cross3Vec3(d.normalizeVec3(e,qt),d.normalizeVec3(this._up,Zt));d.rotationMat4v(.0174532925*t,i,te),e=d.transformPoint3(te,e,Qt),this.up=d.transformPoint3(te,this._up,$t),this.eye=d.addVec3(e,this._look,Jt)}yaw(t){let e=d.subVec3(this._look,this._eye,Kt);d.rotationMat4v(.0174532925*t,this._gimbalLock?this._worldUp:this._up,te),e=d.transformPoint3(te,e,qt),this.look=d.addVec3(e,this._eye,Zt),this._gimbalLock&&(this.up=d.transformPoint3(te,this._up,Qt))}pitch(t){if(this._constrainPitch&&(t=d.dotVec3(this._up,this._worldUp)/d.DEGTORAD)<1)return;let e=d.subVec3(this._look,this._eye,Kt);const i=d.cross3Vec3(d.normalizeVec3(e,qt),d.normalizeVec3(this._up,Zt));d.rotationMat4v(.0174532925*t,i,te),this.up=d.transformPoint3(te,this._up,Jt),e=d.transformPoint3(te,e,Qt),this.look=d.addVec3(e,this._eye,$t)}pan(t){const e=d.subVec3(this._eye,this._look,Kt),i=[0,0,0];let s;if(0!==t[0]){const r=d.cross3Vec3(d.normalizeVec3(e,[]),d.normalizeVec3(this._up,qt));s=d.mulVec3Scalar(r,t[0]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]}0!==t[1]&&(s=d.mulVec3Scalar(d.normalizeVec3(this._up,Zt),t[1]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),0!==t[2]&&(s=d.mulVec3Scalar(d.normalizeVec3(e,Qt),t[2]),i[0]+=s[0],i[1]+=s[1],i[2]+=s[2]),this.eye=d.addVec3(this._eye,i,$t),this.look=d.addVec3(this._look,i,Jt)}zoom(t){const e=d.subVec3(this._eye,this._look,Kt),i=Math.abs(d.lenVec3(e,qt)),s=Math.abs(i+t);if(s<.5)return;const r=d.normalizeVec3(e,Zt);this.eye=d.addVec3(this._look,d.mulVec3Scalar(r,s),Qt)}set eye(t){this._eye.set(t||[0,0,10]),this._needUpdate(0),this.fire("eye",this._eye)}get eye(){return this._eye}set look(t){this._look.set(t||[0,0,0]),this._needUpdate(0),this.fire("look",this._look)}get look(){return this._look}set up(t){this._up.set(t||[0,1,0]),this._needUpdate(0),this.fire("up",this._up)}get up(){return this._up}set deviceMatrix(t){this._state.deviceMatrix.set(t||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._state.hasDeviceMatrix=!!t,this._needUpdate(0),this.fire("deviceMatrix",this._state.deviceMatrix)}get deviceMatrix(){return this._state.deviceMatrix}set worldAxis(t){t=t||[1,0,0,0,1,0,0,0,1],this._worldAxis?this._worldAxis.set(t):this._worldAxis=d.vec3(t),this._worldRight[0]=this._worldAxis[0],this._worldRight[1]=this._worldAxis[1],this._worldRight[2]=this._worldAxis[2],this._worldUp[0]=this._worldAxis[3],this._worldUp[1]=this._worldAxis[4],this._worldUp[2]=this._worldAxis[5],this._worldForward[0]=this._worldAxis[6],this._worldForward[1]=this._worldAxis[7],this._worldForward[2]=this._worldAxis[8],this.fire("worldAxis",this._worldAxis)}get worldAxis(){return this._worldAxis}get worldUp(){return this._worldUp}get xUp(){return this._worldUp[0]>this._worldUp[1]&&this._worldUp[0]>this._worldUp[2]}get yUp(){return this._worldUp[1]>this._worldUp[0]&&this._worldUp[1]>this._worldUp[2]}get zUp(){return this._worldUp[2]>this._worldUp[0]&&this._worldUp[2]>this._worldUp[1]}get worldRight(){return this._worldRight}get worldForward(){return this._worldForward}set gimbalLock(t){this._gimbalLock=!1!==t,this.fire("gimbalLock",this._gimbalLock)}get gimbalLock(){return this._gimbalLock}set constrainPitch(t){this._constrainPitch=!!t,this.fire("constrainPitch",this._constrainPitch)}get eyeLookDist(){return d.lenVec3(d.subVec3(this._look,this._eye,Kt))}get matrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get viewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.matrix}get normalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get viewNormalMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.normalMatrix}get inverseViewMatrix(){return this._updateScheduled&&this._doUpdate(),this._state.inverseMatrix}get projMatrix(){return this[this.projection].matrix}get perspective(){return this._perspective}get ortho(){return this._ortho}get frustum(){return this._frustum}get customProjection(){return this._customProjection}set projection(t){t=t||"perspective",this._projectionType!==t&&("perspective"===t?this._project=this._perspective:"ortho"===t?this._project=this._ortho:"frustum"===t?this._project=this._frustum:"customProjection"===t?this._project=this._customProjection:(this.error("Unsupported value for 'projection': "+t+" defaulting to 'perspective'"),this._project=this._perspective,t="perspective"),this._project._update(),this._projectionType=t,this.glRedraw(),this._update(),this.fire("dirty"),this.fire("projection",this._projectionType),this.fire("projMatrix",this._project.matrix))}get projection(){return this._projectionType}get project(){return this._project}destroy(){super.destroy(),this._state.destroy()}}class ne extends S{get type(){return"Light"}get isLight(){return!0}constructor(t,e={}){super(t,e)}}class le extends ne{get type(){return"DirLight"}constructor(t,e={}){super(t,e),this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;const i=this.scene.camera,s=this.scene.canvas;this._onCameraViewMatrix=i.on("viewMatrix",(()=>{this._shadowViewMatrixDirty=!0})),this._onCameraProjMatrix=i.on("projMatrix",(()=>{this._shadowProjMatrixDirty=!0})),this._onCanvasBoundary=s.on("boundary",(()=>{this._shadowProjMatrixDirty=!0})),this._state=new Gt({type:"dir",dir:d.vec3([1,1,1]),color:d.vec3([.7,.7,.8]),intensity:1,space:e.space||"view",castsShadow:!1,getShadowViewMatrix:()=>{if(this._shadowViewMatrixDirty){this._shadowViewMatrix||(this._shadowViewMatrix=d.identityMat4());const t=this.scene.camera,e=this._state.dir,i=t.look,s=[i[0]-e[0],i[1]-e[1],i[2]-e[2]],r=[0,1,0];d.lookAtMat4v(s,i,r,this._shadowViewMatrix),this._shadowViewMatrixDirty=!1}return this._shadowViewMatrix},getShadowProjMatrix:()=>(this._shadowProjMatrixDirty&&(this._shadowProjMatrix||(this._shadowProjMatrix=d.identityMat4()),d.orthoMat4c(-40,40,-40,40,-40,80,this._shadowProjMatrix),this._shadowProjMatrixDirty=!1),this._shadowProjMatrix),getShadowRenderBuf:()=>(this._shadowRenderBuf||(this._shadowRenderBuf=new kt(this.scene.canvas.canvas,this.scene.canvas.gl,{size:[1024,1024]})),this._shadowRenderBuf)}),this.dir=e.dir,this.color=e.color,this.intensity=e.intensity,this.castsShadow=e.castsShadow,this.scene._lightCreated(this)}set dir(t){this._state.dir.set(t||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get dir(){return this._state.dir}set color(t){this._state.color.set(t||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(t){t=void 0!==t?t:1,this._state.intensity=t,this.glRedraw()}get intensity(){return this._state.intensity}set castsShadow(t){t=!!t,this._state.castsShadow!==t&&(this._state.castsShadow=t,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){const t=this.scene.camera,e=this.scene.canvas;t.off(this._onCameraViewMatrix),t.off(this._onCameraProjMatrix),e.off(this._onCanvasBoundary),super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}class he extends ne{get type(){return"AmbientLight"}constructor(t,e={}){super(t,e),this._state={type:"ambient",color:d.vec3([.7,.7,.7]),intensity:1},this.color=e.color,this.intensity=e.intensity,this.scene._lightCreated(this)}set color(t){this._state.color.set(t||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(t){this._state.intensity=void 0!==t?t:1,this.glRedraw()}get intensity(){return this._state.intensity}destroy(){super.destroy(),this.scene._lightDestroyed(this)}}class ce extends S{get type(){return"Geometry"}get isGeometry(){return!0}constructor(t,e={}){super(t,e),_.memory.meshes++}destroy(){super.destroy(),_.memory.meshes--}}var ue=function(){const t=[],e=[],i=[],s=[],r=[];let o=0;const a=new Uint16Array(3),n=new Uint16Array(3),l=new Uint16Array(3),h=d.vec3(),c=d.vec3(),u=d.vec3(),p=d.vec3(),_=d.vec3(),f=d.vec3(),g=d.vec3();return function(m,v,b,P){!function(r,o){const a={};let n,l,h,c;const u=Math.pow(10,4);let d,p,_=0;for(d=0,p=r.length;d<p;d+=3)n=r[d],l=r[d+1],h=r[d+2],c=Math.round(n*u)+"_"+Math.round(l*u)+"_"+Math.round(h*u),void 0===a[c]&&(a[c]=_/3,t[_++]=n,t[_++]=l,t[_++]=h),e[d/3]=a[c];for(d=0,p=o.length;d<p;d++)s[d]=e[o[d]],i[s[d]]=o[d]}(m,v),function(e,i){o=0;for(let m=0,v=e;m<v;m+=3){const e=3*s[m],v=3*s[m+1],b=3*s[m+2];i?(a[0]=t[e],a[1]=t[e+1],a[2]=t[e+2],n[0]=t[v],n[1]=t[v+1],n[2]=t[v+2],l[0]=t[b],l[1]=t[b+1],l[2]=t[b+2],d.decompressPosition(a,i,h),d.decompressPosition(n,i,c),d.decompressPosition(l,i,u)):(h[0]=t[e],h[1]=t[e+1],h[2]=t[e+2],c[0]=t[v],c[1]=t[v+1],c[2]=t[v+2],u[0]=t[b],u[1]=t[b+1],u[2]=t[b+2]),d.subVec3(u,c,p),d.subVec3(h,c,_),d.cross3Vec3(p,_,f),d.normalizeVec3(f,g);const P=r[o]||(r[o]={normal:d.vec3()});P.normal[0]=g[0],P.normal[1]=g[1],P.normal[2]=g[2],o++}}(v.length,b);const y=[],M=Math.cos(d.DEGTORAD*P),x={};let w,E,A,C,S,D,L,B,R,T,F,N=!1;for(let t=0,e=v.length;t<e;t+=3){const e=t/3;for(let i=0;i<3;i++)w=s[t+i],E=s[t+(i+1)%3],A=Math.min(w,E),C=Math.max(w,E),S=A+","+C,void 0===x[S]?x[S]={index1:A,index2:C,face1:e,face2:void 0}:x[S].face2=e}for(S in x)D=x[S],void 0!==D.face2&&(L=r[D.face1].normal,B=r[D.face2].normal,R=d.dotVec3(L,B),R>M)||(T=i[D.index1],F=i[D.index2],(!N&&T>65535||F>65535)&&(N=!0),y.push(T),y.push(F));return N?new Uint32Array(y):new Uint16Array(y)}}();const de=function(){const t=d.mat4(),e=d.mat4();return function(i,s){s=s||d.mat4();const r=i[0],o=i[1],a=i[2],n=i[3]-r,l=i[4]-o,h=i[5]-a,c=65535;return d.identityMat4(t),d.translationMat4v(i,t),d.identityMat4(e),d.scalingMat4v([n/c,l/c,h/c],e),d.mulMat4(t,e,s),s}}();var pe=function(){const t=d.mat4(),e=d.mat4();return function(i,s,r){const o=new Uint16Array(i.length);var a=new Float32Array([r[0]!==s[0]?65535/(r[0]-s[0]):0,r[1]!==s[1]?65535/(r[1]-s[1]):0,r[2]!==s[2]?65535/(r[2]-s[2]):0]);let n;for(n=0;n<i.length;n+=3)o[n+0]=Math.floor((i[n+0]-s[0])*a[0]),o[n+1]=Math.floor((i[n+1]-s[1])*a[1]),o[n+2]=Math.floor((i[n+2]-s[2])*a[2]);d.identityMat4(t),d.translationMat4v(s,t),d.identityMat4(e),d.scalingMat4v([(r[0]-s[0])/65535,(r[1]-s[1])/65535,(r[2]-s[2])/65535],e);return{quantized:o,decodeMatrix:d.mulMat4(t,e,d.identityMat4())}}}();var _e=function(){const t=d.mat3(),e=d.mat3();return function(i,s,r){const o=new Uint16Array(i.length),a=new Float32Array([65535/(r[0]-s[0]),65535/(r[1]-s[1])]);let n;for(n=0;n<i.length;n+=2)o[n+0]=Math.floor((i[n+0]-s[0])*a[0]),o[n+1]=Math.floor((i[n+1]-s[1])*a[1]);d.identityMat3(t),d.translationMat3v(s,t),d.identityMat3(e),d.scalingMat3v([(r[0]-s[0])/65535,(r[1]-s[1])/65535],e);return{quantized:o,decodeMatrix:d.mulMat3(t,e,d.identityMat3())}}}();function fe(t,e,i,s){let r=t[e]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2])),o=t[e+1]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2]));if(t[e+2]<0){let t=(1-Math.abs(o))*(r>=0?1:-1),e=(1-Math.abs(r))*(o>=0?1:-1);r=t,o=e}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*o+(o<0?-1:0))])}function ge(t){let e=t[0],i=t[1];e/=e<0?127:128,i/=i<0?127:128;const s=1-Math.abs(e)-Math.abs(i);s<0&&(e=(1-Math.abs(i))*(e>=0?1:-1),i=(1-Math.abs(e))*(i>=0?1:-1));const r=Math.sqrt(e*e+i*i+s*s);return[e/r,i/r,s/r]}function me(t,e,i){return t[e]*i[0]+t[e+1]*i[1]+t[e+2]*i[2]}const ve={getPositionsBounds:function(t){const e=new Float32Array(3),i=new Float32Array(3);let s,r;for(s=0;s<3;s++)e[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<t.length;s+=3)for(r=0;r<3;r++)e[r]=Math.min(e[r],t[s+r]),i[r]=Math.max(i[r],t[s+r]);return{min:e,max:i}},createPositionsDecodeMatrix:de,compressPositions:pe,compressPosition:function(t,e,i){const s=new Float32Array([e[3]!==e[0]?65535/(e[3]-e[0]):0,e[4]!==e[1]?65535/(e[4]-e[1]):0,e[5]!==e[2]?65535/(e[5]-e[2]):0]);i[0]=Math.floor((t[0]-e[0])*s[0]),i[1]=Math.floor((t[1]-e[1])*s[1]),i[2]=Math.floor((t[2]-e[2])*s[2])},decompressPositions:function(t,e,i=new Float32Array(t.length)){for(let s=0,r=t.length;s<r;s+=3)i[s+0]=t[s+0]*e[0]+e[12],i[s+1]=t[s+1]*e[5]+e[13],i[s+2]=t[s+2]*e[10]+e[14];return i},decompressPosition:function(t,e,i){return i[0]=t[0]*e[0]+e[12],i[1]=t[1]*e[5]+e[13],i[2]=t[2]*e[10]+e[14],i},decompressAABB:function(t,e,i=t){return i[0]=t[0]*e[0]+e[12],i[1]=t[1]*e[5]+e[13],i[2]=t[2]*e[10]+e[14],i[3]=t[3]*e[0]+e[12],i[4]=t[4]*e[5]+e[13],i[5]=t[5]*e[10]+e[14],i},getUVBounds:function(t){const e=new Float32Array(2),i=new Float32Array(2);let s,r;for(s=0;s<2;s++)e[s]=Number.MAX_VALUE,i[s]=-Number.MAX_VALUE;for(s=0;s<t.length;s+=2)for(r=0;r<2;r++)e[r]=Math.min(e[r],t[s+r]),i[r]=Math.max(i[r],t[s+r]);return{min:e,max:i}},compressUVs:_e,decompressUVs:function(t,e,i=new Float32Array(t.length)){for(let s=0,r=t.length;s<r;s+=3)i[s+0]=t[s+0]*e[0]+e[6],i[s+1]=t[s+1]*e[4]+e[7];return i},decompressUV:function(t,e,i){i[0]=t[0]*e[0]+e[6],i[1]=t[1]*e[4]+e[7]},compressNormals:function(t){const e=new Int8Array(t.length);let i,s,r,o,a;for(let n=0;n<t.length;n+=3)r=i=fe(t,n,"floor","floor"),s=ge(i),o=a=me(t,n,s),i=fe(t,n,"ceil","floor"),s=ge(i),o=me(t,n,s),o>a&&(r=i,a=o),i=fe(t,n,"floor","ceil"),s=ge(i),o=me(t,n,s),o>a&&(r=i,a=o),i=fe(t,n,"ceil","ceil"),s=ge(i),o=me(t,n,s),o>a&&(r=i,a=o),e[n]=r[0],e[n+1]=r[1];return e},decompressNormals:function(t,e){for(let i=0,s=0,r=t.length;i<r;i+=2){let r=t[i+0],o=t[i+1];r=(2*r+1)/255,o=(2*o+1)/255;const a=1-Math.abs(r)-Math.abs(o);a<0&&(r=(1-Math.abs(o))*(r>=0?1:-1),o=(1-Math.abs(r))*(o>=0?1:-1));const n=Math.sqrt(r*r+o*o+a*a);e[s+0]=r/n,e[s+1]=o/n,e[s+2]=a/n,s+=3}return e},decompressNormal:function(t,e){let i=t[0],s=t[1];i=(2*i+1)/255,s=(2*s+1)/255;const r=1-Math.abs(i)-Math.abs(s);r<0&&(i=(1-Math.abs(s))*(i>=0?1:-1),s=(1-Math.abs(i))*(s>=0?1:-1));const o=Math.sqrt(i*i+s*s+r*r);return e[0]=i/o,e[1]=s/o,e[2]=r/o,e}},be=_.memory,Pe=ht.SUPPORTED_EXTENSIONS.OES_element_index_uint,ye=Pe?Uint32Array:Uint16Array,Me=d.AABB3();class xe extends ce{get type(){return"ReadableGeometry"}get isReadableGeometry(){return!0}constructor(t,e={}){super(t,e),this._state=new Gt({compressGeometry:!!e.compressGeometry,primitive:null,primitiveName:null,positions:null,normals:null,colors:null,uv:null,indices:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=e.edgeThreshold||10,this._edgeIndicesBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._aabbDirty=!0,this._boundingSphere=!0,this._aabb=null,this._aabbDirty=!0,this._obb=null,this._obbDirty=!0;const i=this._state,s=this.scene.canvas.gl;switch(e.primitive=e.primitive||"triangles",e.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=e.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=e.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=e.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=e.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=e.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=e.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=e.primitive;break;default:this.error("Unsupported value for 'primitive': '"+e.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=e.primitive}if(e.positions)if(this._state.compressGeometry){const t=ve.getPositionsBounds(e.positions),s=ve.compressPositions(e.positions,t.min,t.max);i.positions=s.quantized,i.positionsDecodeMatrix=s.decodeMatrix}else i.positions=e.positions.constructor===Float32Array?e.positions:new Float32Array(e.positions);if(e.colors&&(i.colors=e.colors.constructor===Float32Array?e.colors:new Float32Array(e.colors)),e.uv)if(this._state.compressGeometry){const t=ve.getUVBounds(e.uv),s=ve.compressUVs(e.uv,t.min,t.max);i.uv=s.quantized,i.uvDecodeMatrix=s.decodeMatrix}else i.uv=e.uv.constructor===Float32Array?e.uv:new Float32Array(e.uv);if(e.normals&&(this._state.compressGeometry?i.normals=ve.compressNormals(e.normals):i.normals=e.normals.constructor===Float32Array?e.normals:new Float32Array(e.normals)),e.indices){if(!Pe&&e.indices.constructor===Uint32Array)return void this.error("This WebGL implementation does not support Uint32Array");i.indices=e.indices.constructor===Uint32Array||e.indices.constructor===Uint16Array?e.indices:new ye(e.indices),"triangles"===this._state.primitiveName&&(this._numTriangles=e.indices.length/3)}this._buildHash(),be.meshes++,this._buildVBOs()}_buildVBOs(){const t=this._state,e=this.scene.canvas.gl;if(t.indices&&(t.indicesBuf=new Mt(e,e.ELEMENT_ARRAY_BUFFER,t.indices,t.indices.length,1,e.STATIC_DRAW),be.indices+=t.indicesBuf.numItems),t.positions&&(t.positionsBuf=new Mt(e,e.ARRAY_BUFFER,t.positions,t.positions.length,3,e.STATIC_DRAW),be.positions+=t.positionsBuf.numItems),t.normals){let i=t.compressGeometry;t.normalsBuf=new Mt(e,e.ARRAY_BUFFER,t.normals,t.normals.length,3,e.STATIC_DRAW,i),be.normals+=t.normalsBuf.numItems}t.colors&&(t.colorsBuf=new Mt(e,e.ARRAY_BUFFER,t.colors,t.colors.length,4,e.STATIC_DRAW),be.colors+=t.colorsBuf.numItems),t.uv&&(t.uvBuf=new Mt(e,e.ARRAY_BUFFER,t.uv,t.uv.length,2,e.STATIC_DRAW),be.uvs+=t.uvBuf.numItems)}_buildHash(){const t=this._state,e=["/g"];e.push("/"+t.primitive+";"),t.positions&&e.push("p"),t.colors&&e.push("c"),(t.normals||t.autoVertexNormals)&&e.push("n"),t.uv&&e.push("u"),t.compressGeometry&&e.push("cp"),e.push(";"),t.hash=e.join("")}_getEdgeIndices(){return this._edgeIndicesBuf||this._buildEdgeIndices(),this._edgeIndicesBuf}_getPickTrianglePositions(){return this._pickTrianglePositionsBuf||this._buildPickTriangleVBOs(),this._pickTrianglePositionsBuf}_getPickTriangleColors(){return this._pickTriangleColorsBuf||this._buildPickTriangleVBOs(),this._pickTriangleColorsBuf}_buildEdgeIndices(){const t=this._state;if(!t.positions||!t.indices)return;const e=this.scene.canvas.gl,i=ue(t.positions,t.indices,t.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new Mt(e,e.ELEMENT_ARRAY_BUFFER,i,i.length,1,e.STATIC_DRAW),be.indices+=this._edgeIndicesBuf.numItems}_buildPickTriangleVBOs(){const t=this._state;if(!t.positions||!t.indices)return;const e=this.scene.canvas.gl,i=d.buildPickTriangles(t.positions,t.indices,t.compressGeometry),s=i.positions,r=i.colors;this._pickTrianglePositionsBuf=new Mt(e,e.ARRAY_BUFFER,s,s.length,3,e.STATIC_DRAW),this._pickTriangleColorsBuf=new Mt(e,e.ARRAY_BUFFER,r,r.length,4,e.STATIC_DRAW,!0),be.positions+=this._pickTrianglePositionsBuf.numItems,be.colors+=this._pickTriangleColorsBuf.numItems}_buildPickVertexVBOs(){}_webglContextLost(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextLost()}_webglContextRestored(){this._sceneVertexBufs&&this._sceneVertexBufs.webglContextRestored(),this._buildVBOs(),this._edgeIndicesBuf=null,this._pickVertexPositionsBuf=null,this._pickTrianglePositionsBuf=null,this._pickTriangleColorsBuf=null,this._pickVertexPositionsBuf=null,this._pickVertexColorsBuf=null}get primitive(){return this._state.primitiveName}get compressGeometry(){return this._state.compressGeometry}get positions(){return this._state.positions?this._state.compressGeometry?(this._decompressedPositions||(this._decompressedPositions=new Float32Array(this._state.positions.length),ve.decompressPositions(this._state.positions,this._state.positionsDecodeMatrix,this._decompressedPositions)),this._decompressedPositions):this._state.positions:null}set positions(t){const e=this._state,i=e.positions;if(i)if(i.length===t.length){if(this._state.compressGeometry){const i=ve.getPositionsBounds(t),s=ve.compressPositions(t,i.min,i.max);t=s.quantized,e.positionsDecodeMatrix=s.decodeMatrix}i.set(t),e.positionsBuf&&e.positionsBuf.setData(i),this._setAABBDirty(),this.glRedraw()}else this.error("can't update geometry positions - new positions are wrong length");else this.error("can't update geometry positions - geometry has no positions")}get normals(){if(this._state.normals){if(!this._state.compressGeometry)return this._state.normals;if(!this._decompressedNormals){const t=this._state.normals.length,e=t+t/2;this._decompressedNormals=new Float32Array(e),ve.decompressNormals(this._state.normals,this._decompressedNormals)}return this._decompressedNormals}}set normals(t){if(this._state.compressGeometry)return void this.error("can't update geometry normals - quantized geometry is immutable");const e=this._state,i=e.normals;i?i.length===t.length?(i.set(t),e.normalsBuf&&e.normalsBuf.setData(i),this.glRedraw()):this.error("can't update geometry normals - new normals are wrong length"):this.error("can't update geometry normals - geometry has no normals")}get uv(){return this._state.uv?this._state.compressGeometry?(this._decompressedUV||(this._decompressedUV=new Float32Array(this._state.uv.length),ve.decompressUVs(this._state.uv,this._state.uvDecodeMatrix,this._decompressedUV)),this._decompressedUV):this._state.uv:null}set uv(t){if(this._state.compressGeometry)return void this.error("can't update geometry UVs - quantized geometry is immutable");const e=this._state,i=e.uv;i?i.length===t.length?(i.set(t),e.uvBuf&&e.uvBuf.setData(i),this.glRedraw()):this.error("can't update geometry UVs - new UVs are wrong length"):this.error("can't update geometry UVs - geometry has no UVs")}get colors(){return this._state.colors}set colors(t){if(this._state.compressGeometry)return void this.error("can't update geometry colors - quantized geometry is immutable");const e=this._state,i=e.colors;i?i.length===t.length?(i.set(t),e.colorsBuf&&e.colorsBuf.setData(i),this.glRedraw()):this.error("can't update geometry colors - new colors are wrong length"):this.error("can't update geometry colors - geometry has no colors")}get indices(){return this._state.indices}get aabb(){return this._aabbDirty&&(this._aabb||(this._aabb=d.AABB3()),d.positions3ToAABB3(this._state.positions,this._aabb,this._state.positionsDecodeMatrix),this._aabbDirty=!1),this._aabb}get obb(){return this._obbDirty&&(this._obb||(this._obb=d.OBB3()),d.positions3ToAABB3(this._state.positions,Me,this._state.positionsDecodeMatrix),d.AABB3ToOBB3(Me,this._obb),this._obbDirty=!1),this._obb}get numTriangles(){return this._numTriangles}_setAABBDirty(){this._aabbDirty||(this._aabbDirty=!0,this._aabbDirty=!0,this._obbDirty=!0)}_getState(){return this._state}destroy(){super.destroy();const t=this._state;t.indicesBuf&&t.indicesBuf.destroy(),t.positionsBuf&&t.positionsBuf.destroy(),t.normalsBuf&&t.normalsBuf.destroy(),t.uvBuf&&t.uvBuf.destroy(),t.colorsBuf&&t.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),this._pickTrianglePositionsBuf&&this._pickTrianglePositionsBuf.destroy(),this._pickTriangleColorsBuf&&this._pickTriangleColorsBuf.destroy(),this._pickVertexPositionsBuf&&this._pickVertexPositionsBuf.destroy(),this._pickVertexColorsBuf&&this._pickVertexColorsBuf.destroy(),t.destroy(),be.meshes--}}function we(t={}){let e=t.xSize||1;e<0&&(console.error("negative xSize not allowed - will invert"),e*=-1);let i=t.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);let s=t.zSize||1;s<0&&(console.error("negative zSize not allowed - will invert"),s*=-1);const r=t.center,o=r?r[0]:0,a=r?r[1]:0,n=r?r[2]:0,l=-e+o,h=-i+a,c=-s+n,u=e+o,d=i+a,p=s+n;return m.apply(t,{positions:[u,d,p,l,d,p,l,h,p,u,h,p,u,d,p,u,h,p,u,h,c,u,d,c,u,d,p,u,d,c,l,d,c,l,d,p,l,d,p,l,d,c,l,h,c,l,h,p,l,h,c,u,h,c,u,h,p,l,h,p,u,h,c,l,h,c,l,d,c,u,d,c],normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],uv:[1,0,0,0,0,1,1,1,0,0,0,1,1,1,1,0,1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]})}class Ee extends S{get type(){return"Material"}constructor(t,e={}){super(t,e),_.memory.materials++}destroy(){super.destroy(),_.memory.materials--}}const Ae={opaque:0,mask:1,blend:2},Ce=["opaque","mask","blend"];class Se extends Ee{get type(){return"PhongMaterial"}constructor(t,e={}){super(t,e),this._state=new Gt({type:"PhongMaterial",ambient:d.vec3([1,1,1]),diffuse:d.vec3([1,1,1]),specular:d.vec3([1,1,1]),emissive:d.vec3([0,0,0]),alpha:null,shininess:null,reflectivity:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.ambient=e.ambient,this.diffuse=e.diffuse,this.specular=e.specular,this.emissive=e.emissive,this.alpha=e.alpha,this.shininess=e.shininess,this.reflectivity=e.reflectivity,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,e.ambientMap&&(this._ambientMap=this._checkComponent("Texture",e.ambientMap)),e.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",e.diffuseMap)),e.specularMap&&(this._specularMap=this._checkComponent("Texture",e.specularMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",e.emissiveMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("Texture",e.alphaMap)),e.reflectivityMap&&(this._reflectivityMap=this._checkComponent("Texture",e.reflectivityMap)),e.normalMap&&(this._normalMap=this._checkComponent("Texture",e.normalMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",e.occlusionMap)),e.diffuseFresnel&&(this._diffuseFresnel=this._checkComponent("Fresnel",e.diffuseFresnel)),e.specularFresnel&&(this._specularFresnel=this._checkComponent("Fresnel",e.specularFresnel)),e.emissiveFresnel&&(this._emissiveFresnel=this._checkComponent("Fresnel",e.emissiveFresnel)),e.alphaFresnel&&(this._alphaFresnel=this._checkComponent("Fresnel",e.alphaFresnel)),e.reflectivityFresnel&&(this._reflectivityFresnel=this._checkComponent("Fresnel",e.reflectivityFresnel)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this._makeHash()}_makeHash(){const t=this._state,e=["/p"];this._normalMap&&(e.push("/nm"),this._normalMap.hasMatrix&&e.push("/mat")),this._ambientMap&&(e.push("/am"),this._ambientMap.hasMatrix&&e.push("/mat"),e.push("/"+this._ambientMap.encoding)),this._diffuseMap&&(e.push("/dm"),this._diffuseMap.hasMatrix&&e.push("/mat"),e.push("/"+this._diffuseMap.encoding)),this._specularMap&&(e.push("/sm"),this._specularMap.hasMatrix&&e.push("/mat")),this._emissiveMap&&(e.push("/em"),this._emissiveMap.hasMatrix&&e.push("/mat"),e.push("/"+this._emissiveMap.encoding)),this._alphaMap&&(e.push("/opm"),this._alphaMap.hasMatrix&&e.push("/mat")),this._reflectivityMap&&(e.push("/rm"),this._reflectivityMap.hasMatrix&&e.push("/mat")),this._occlusionMap&&(e.push("/ocm"),this._occlusionMap.hasMatrix&&e.push("/mat")),this._diffuseFresnel&&e.push("/df"),this._specularFresnel&&e.push("/sf"),this._emissiveFresnel&&e.push("/ef"),this._alphaFresnel&&e.push("/of"),this._reflectivityFresnel&&e.push("/rf"),e.push(";"),t.hash=e.join("")}set ambient(t){let e=this._state.ambient;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.ambient=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()}get ambient(){return this._state.ambient}set diffuse(t){let e=this._state.diffuse;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.diffuse=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get diffuse(){return this._state.diffuse}set specular(t){let e=this._state.specular;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.specular=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get specular(){return this._state.specular}set emissive(t){let e=this._state.emissive;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.emissive=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=0,e[1]=0,e[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}set alpha(t){t=null!=t?t:1,this._state.alpha!==t&&(this._state.alpha=t,this.glRedraw())}get alpha(){return this._state.alpha}set shininess(t){this._state.shininess=void 0!==t?t:80,this.glRedraw()}get shininess(){return this._state.shininess}set lineWidth(t){this._state.lineWidth=t||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(t){this._state.pointSize=t||1,this.glRedraw()}get pointSize(){return this._state.pointSize}set reflectivity(t){this._state.reflectivity=void 0!==t?t:1,this.glRedraw()}get reflectivity(){return this._state.reflectivity}get normalMap(){return this._normalMap}get ambientMap(){return this._ambientMap}get diffuseMap(){return this._diffuseMap}get specularMap(){return this._specularMap}get emissiveMap(){return this._emissiveMap}get alphaMap(){return this._alphaMap}get reflectivityMap(){return this._reflectivityMap}get occlusionMap(){return this._occlusionMap}get diffuseFresnel(){return this._diffuseFresnel}get specularFresnel(){return this._specularFresnel}get emissiveFresnel(){return this._emissiveFresnel}get alphaFresnel(){return this._alphaFresnel}get reflectivityFresnel(){return this._reflectivityFresnel}set alphaMode(t){let e=Ae[t=t||"opaque"];void 0===e&&(this.error("Unsupported value for 'alphaMode': "+t+" - defaulting to 'opaque'"),e="opaque"),this._state.alphaMode!==e&&(this._state.alphaMode=e,this.glRedraw())}get alphaMode(){return Ce[this._state.alphaMode]}set alphaCutoff(t){null==t&&(t=.5),this._state.alphaCutoff!==t&&(this._state.alphaCutoff=t)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}destroy(){super.destroy(),this._state.destroy()}}const De={default:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultWhiteBG:{fill:!0,fillColor:[1,1,1],fillAlpha:.6,edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.2,.2,.2],edgeAlpha:.5,edgeWidth:1},defaultDarkBG:{fill:!0,fillColor:[.4,.4,.4],fillAlpha:.2,edges:!0,edgeColor:[.5,.5,.5],edgeAlpha:.5,edgeWidth:1},phosphorous:{fill:!0,fillColor:[0,0,0],fillAlpha:.4,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:2},sunset:{fill:!0,fillColor:[.9,.9,.6],fillAlpha:.2,edges:!0,edgeColor:[.9,.9,.9],edgeAlpha:.5,edgeWidth:1},vectorscope:{fill:!0,fillColor:[0,0,0],fillAlpha:.7,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:2},battlezone:{fill:!0,fillColor:[0,0,0],fillAlpha:1,edges:!0,edgeColor:[.2,1,.2],edgeAlpha:1,edgeWidth:3},sepia:{fill:!0,fillColor:[.970588207244873,.7965892553329468,.6660899519920349],fillAlpha:.4,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},yellowHighlight:{fill:!0,fillColor:[1,1,0],fillAlpha:.5,edges:!0,edgeColor:[.529411792755127,.4577854573726654,.4100345969200134],edgeAlpha:1,edgeWidth:1},greenSelected:{fill:!0,fillColor:[0,1,0],fillAlpha:.5,edges:!0,edgeColor:[.4577854573726654,.529411792755127,.4100345969200134],edgeAlpha:1,edgeWidth:1},gamegrid:{fill:!0,fillColor:[.2,.2,.7],fillAlpha:.9,edges:!0,edgeColor:[.4,.4,1.6],edgeAlpha:.8,edgeWidth:3}};class Le extends Ee{get type(){return"EmphasisMaterial"}get presets(){return De}constructor(t,e={}){super(t,e),this._state=new Gt({type:"EmphasisMaterial",fill:null,fillColor:null,fillAlpha:null,edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null,backfaces:!0}),this._preset="default",e.preset?(this.preset=e.preset,void 0!==e.fill&&(this.fill=e.fill),e.fillColor&&(this.fillColor=e.fillColor),void 0!==e.fillAlpha&&(this.fillAlpha=e.fillAlpha),void 0!==e.edges&&(this.edges=e.edges),e.edgeColor&&(this.edgeColor=e.edgeColor),void 0!==e.edgeAlpha&&(this.edgeAlpha=e.edgeAlpha),void 0!==e.edgeWidth&&(this.edgeWidth=e.edgeWidth),void 0!==e.backfaces&&(this.backfaces=e.backfaces)):(this.fill=e.fill,this.fillColor=e.fillColor,this.fillAlpha=e.fillAlpha,this.edges=e.edges,this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this.backfaces=e.backfaces)}set fill(t){t=!1!==t,this._state.fill!==t&&(this._state.fill=t,this.glRedraw())}get fill(){return this._state.fill}set fillColor(t){let e=this._state.fillColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.fillColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.4,e[1]=.4,e[2]=.4),this.glRedraw()}get fillColor(){return this._state.fillColor}set fillAlpha(t){t=null!=t?t:.2,this._state.fillAlpha!==t&&(this._state.fillAlpha=t,this.glRedraw())}get fillAlpha(){return this._state.fillAlpha}set edges(t){t=!1!==t,this._state.edges!==t&&(this._state.edges=t,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(t){let e=this._state.edgeColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.edgeColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(t){t=null!=t?t:.5,this._state.edgeAlpha!==t&&(this._state.edgeAlpha=t,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(t){this._state.edgeWidth=t||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set backfaces(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())}get backfaces(){return this._state.backfaces}set preset(t){if(t=t||"default",this._preset===t)return;const e=De[t];e?(this.fill=e.fill,this.fillColor=e.fillColor,this.fillAlpha=e.fillAlpha,this.edges=e.edges,this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(De).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const Be={default:{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1},defaultWhiteBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultLightBG:{edgeColor:[.2,.2,.2],edgeAlpha:1,edgeWidth:1},defaultDarkBG:{edgeColor:[.5,.5,.5],edgeAlpha:1,edgeWidth:1}};class Re extends Ee{get type(){return"EdgeMaterial"}get presets(){return Be}constructor(t,e={}){super(t,e),this._state=new Gt({type:"EdgeMaterial",edges:null,edgeColor:null,edgeAlpha:null,edgeWidth:null}),this._preset="default",e.preset?(this.preset=e.preset,e.edgeColor&&(this.edgeColor=e.edgeColor),void 0!==e.edgeAlpha&&(this.edgeAlpha=e.edgeAlpha),void 0!==e.edgeWidth&&(this.edgeWidth=e.edgeWidth)):(this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth),this.edges=!1!==e.edges}set edges(t){t=!1!==t,this._state.edges!==t&&(this._state.edges=t,this.glRedraw())}get edges(){return this._state.edges}set edgeColor(t){let e=this._state.edgeColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.edgeColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set edgeAlpha(t){t=null!=t?t:1,this._state.edgeAlpha!==t&&(this._state.edgeAlpha=t,this.glRedraw())}get edgeAlpha(){return this._state.edgeAlpha}set edgeWidth(t){this._state.edgeWidth=t||1,this.glRedraw()}get edgeWidth(){return this._state.edgeWidth}set preset(t){if(t=t||"default",this._preset===t)return;const e=Be[t];e?(this.edgeColor=e.edgeColor,this.edgeAlpha=e.edgeAlpha,this.edgeWidth=e.edgeWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(Be).join(", "))}get preset(){return this._preset}destroy(){super.destroy(),this._state.destroy()}}const Te={meters:{abbrev:"m"},metres:{abbrev:"m"},centimeters:{abbrev:"cm"},centimetres:{abbrev:"cm"},millimeters:{abbrev:"mm"},millimetres:{abbrev:"mm"},yards:{abbrev:"yd"},feet:{abbrev:"ft"},inches:{abbrev:"in"}};class Fe extends S{constructor(t,e={}){super(t,e),this._units="meters",this._scale=1,this._origin=d.vec3([0,0,0]),this.units=e.units,this.scale=e.scale,this.origin=e.origin}get unitsInfo(){return Te}set units(t){t||(t="meters");Te[t]||(this.error("Unsupported value for 'units': "+t+" defaulting to 'meters'"),t="meters"),this._units=t,this.fire("units",this._units)}get units(){return this._units}set scale(t){(t=t||1)<=0?this.error("scale value should be larger than zero"):(this._scale=t,this.fire("scale",this._scale))}get scale(){return this._scale}set origin(t){if(!t)return this._origin[0]=0,this._origin[1]=0,void(this._origin[2]=0);this._origin[0]=t[0],this._origin[1]=t[1],this._origin[2]=t[2],this.fire("origin",this._origin)}get origin(){return this._origin}worldToRealPos(t,e=d.vec3(3)){e[0]=this._origin[0]+this._scale*t[0],e[1]=this._origin[1]+this._scale*t[1],e[2]=this._origin[2]+this._scale*t[2]}realToWorldPos(t,e=d.vec3(3)){return e[0]=(t[0]-this._origin[0])/this._scale,e[1]=(t[1]-this._origin[1])/this._scale,e[2]=(t[2]-this._origin[2])/this._scale,e}}class Ne extends S{constructor(t,e={}){super(t,e);const i=navigator.userAgent.match(/(opera|chrome|safari|firefox|msie|mobile)\/?\s*(\.?\d+(\.\d+)*)/i),s=i&&"safari"===i[1].toLowerCase();this._supported=!s&&ht.SUPPORTED_EXTENSIONS.OES_standard_derivatives,this.enabled=e.enabled,this.kernelRadius=e.kernelRadius,this.intensity=e.intensity,this.bias=e.bias,this.scale=e.scale,this.minResolution=e.minResolution,this.numSamples=e.numSamples,this.blur=e.blur,this.blendCutoff=e.blendCutoff,this.blendFactor=e.blendFactor}get supported(){return this._supported}set enabled(t){t=!!t,this._enabled!==t&&(this._enabled=t,this.glRedraw())}get enabled(){return this._enabled}get possible(){if(!this._supported)return!1;if(!this._enabled)return!1;const t=this.scene.camera.projection;return"customProjection"!==t&&"frustum"!==t}get active(){return this._active}set kernelRadius(t){null==t&&(t=100),this._kernelRadius!==t&&(this._kernelRadius=t,this.glRedraw())}get kernelRadius(){return this._kernelRadius}set intensity(t){null==t&&(t=.15),this._intensity!==t&&(this._intensity=t,this.glRedraw())}get intensity(){return this._intensity}set bias(t){null==t&&(t=.5),this._bias!==t&&(this._bias=t,this.glRedraw())}get bias(){return this._bias}set scale(t){null==t&&(t=1),this._scale!==t&&(this._scale=t,this.glRedraw())}get scale(){return this._scale}set minResolution(t){null==t&&(t=0),this._minResolution!==t&&(this._minResolution=t,this.glRedraw())}get minResolution(){return this._minResolution}set numSamples(t){null==t&&(t=10),this._numSamples!==t&&(this._numSamples=t,this.glRedraw())}get numSamples(){return this._numSamples}set blur(t){t=!1!==t,this._blur!==t&&(this._blur=t,this.glRedraw())}get blur(){return this._blur}set blendCutoff(t){null==t&&(t=.3),this._blendCutoff!==t&&(this._blendCutoff=t,this.glRedraw())}get blendCutoff(){return this._blendCutoff}set blendFactor(t){null==t&&(t=1),this._blendFactor!==t&&(this._blendFactor=t,this.glRedraw())}get blendFactor(){return this._blendFactor}destroy(){super.destroy()}}const Ie={default:{pointSize:4,roundPoints:!0,perspectivePoints:!0},square:{pointSize:4,roundPoints:!1,perspectivePoints:!0},round:{pointSize:4,roundPoints:!0,perspectivePoints:!0}};class ke extends Ee{get type(){return"PointsMaterial"}get presets(){return Ie}constructor(t,e={}){super(t,e),this._state=new Gt({type:"PointsMaterial",pointSize:null,roundPoints:null,perspectivePoints:null,minPerspectivePointSize:null,maxPerspectivePointSize:null,filterIntensity:null,minIntensity:null,maxIntensity:null}),e.preset?(this.preset=e.preset,void 0!==e.pointSize&&(this.pointSize=e.pointSize),void 0!==e.roundPoints&&(this.roundPoints=e.roundPoints),void 0!==e.perspectivePoints&&(this.perspectivePoints=e.perspectivePoints),void 0!==e.minPerspectivePointSize&&(this.minPerspectivePointSize=e.minPerspectivePointSize),void 0!==e.maxPerspectivePointSize&&(this.maxPerspectivePointSize=e.minPerspectivePointSize)):(this._preset="default",this.pointSize=e.pointSize,this.roundPoints=e.roundPoints,this.perspectivePoints=e.perspectivePoints,this.minPerspectivePointSize=e.minPerspectivePointSize,this.maxPerspectivePointSize=e.maxPerspectivePointSize),this.filterIntensity=e.filterIntensity,this.minIntensity=e.minIntensity,this.maxIntensity=e.maxIntensity}set pointSize(t){this._state.pointSize=t||2,this.glRedraw()}get pointSize(){return this._state.pointSize}set roundPoints(t){t=!1!==t,this._state.roundPoints!==t&&(this._state.roundPoints=t,this.scene._needRecompile=!0,this.glRedraw())}get roundPoints(){return this._state.roundPoints}set perspectivePoints(t){t=!1!==t,this._state.perspectivePoints!==t&&(this._state.perspectivePoints=t,this.scene._needRecompile=!0,this.glRedraw())}get perspectivePoints(){return this._state.perspectivePoints}set minPerspectivePointSize(t){this._state.minPerspectivePointSize=t||1,this.scene._needRecompile=!0,this.glRedraw()}get minPerspectivePointSize(){return this._state.minPerspectivePointSize}set maxPerspectivePointSize(t){this._state.maxPerspectivePointSize=t||6,this.scene._needRecompile=!0,this.glRedraw()}get maxPerspectivePointSize(){return this._state.maxPerspectivePointSize}set filterIntensity(t){t=!1!==t,this._state.filterIntensity!==t&&(this._state.filterIntensity=t,this.scene._needRecompile=!0,this.glRedraw())}get filterIntensity(){return this._state.filterIntensity}set minIntensity(t){this._state.minIntensity=null!=t?t:0,this.glRedraw()}get minIntensity(){return this._state.minIntensity}set maxIntensity(t){this._state.maxIntensity=null!=t?t:1,this.glRedraw()}get maxIntensity(){return this._state.maxIntensity}set preset(t){if(t=t||"default",this._preset===t)return;const e=Ie[t];e?(this.pointSize=e.pointSize,this.roundPoints=e.roundPoints,this.perspectivePoints=e.perspectivePoints,this.minPerspectivePointSize=e.minPerspectivePointSize,this.maxPerspectivePointSize=e.maxPerspectivePointSize,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(Ie).join(", "))}get preset(){return this._preset}get hash(){return[this.pointSize,this.roundPoints,this.perspectivePoints,this.minPerspectivePointSize,this.maxPerspectivePointSize,this.filterIntensity].join(";")}destroy(){super.destroy(),this._state.destroy()}}const Oe={default:{lineWidth:1},thick:{lineWidth:2},thicker:{lineWidth:4}};class Ve extends Ee{get type(){return"LinesMaterial"}get presets(){return Oe}constructor(t,e={}){super(t,e),this._state=new Gt({type:"LinesMaterial",lineWidth:null}),e.preset?(this.preset=e.preset,void 0!==e.lineWidth&&(this.lineWidth=e.lineWidth)):(this._preset="default",this.lineWidth=e.lineWidth)}set lineWidth(t){this._state.lineWidth=t||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set preset(t){if(t=t||"default",this._preset===t)return;const e=Oe[t];e?(this.lineWidth=e.lineWidth,this._preset=t):this.error("unsupported preset: '"+t+"' - supported values are "+Object.keys(Oe).join(", "))}get preset(){return this._preset}get hash(){return[""+this.lineWidth].join(";")}destroy(){super.destroy(),this._state.destroy()}}function ze(t,e){const i={};let s,r;for(let o=0,a=e.length;o<a;o++)s=e[o],r=t.component[s],r?r.isEntity?i[s]=!0:t.warn("pick(): Component is not an Entity: "+s):t.warn("pick(): Component not found: "+s);return i}class Ue extends S{get type(){return"Scene"}constructor(t,e={}){super(null,e);const i=e.canvasElement||document.getElementById(e.canvasId);if(!(i instanceof HTMLCanvasElement))throw"Mandatory config expected: valid canvasId or canvasElement";const s=!!e.transparent,r=!!e.alphaDepthMask;this._aabbDirty=!0,this.viewer=t,this.occlusionTestCountdown=0,this.loading=0,this.startTime=(new Date).getTime(),this.models={},this.objects={},this._numObjects=0,this.visibleObjects={},this._numVisibleObjects=0,this.xrayedObjects={},this._numXRayedObjects=0,this.highlightedObjects={},this._numHighlightedObjects=0,this.selectedObjects={},this._numSelectedObjects=0,this.colorizedObjects={},this._numColorizedObjects=0,this.opacityObjects={},this._numOpacityObjects=0,this.offsetObjects={},this._numOffsetObjects=0,this._modelIds=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this._opacityObjectIds=null,this._offsetObjectIds=null,this._collidables={},this._compilables={},this._needRecompile=!1,this.types={},this.components={},this.sectionPlanes={},this.lights={},this.lightMaps={},this.reflectionMaps={},this.realWorldOffset=e.realWorldOffset||new Float64Array([0,0,0]),this.canvas=new dt(this,{dontClear:!0,canvas:i,spinnerElementId:e.spinnerElementId,transparent:s,webgl2:!1!==e.webgl2,contextAttr:e.contextAttr||{},backgroundColor:e.backgroundColor,backgroundColorFromAmbientLight:e.backgroundColorFromAmbientLight,premultipliedAlpha:e.premultipliedAlpha}),this.canvas.on("boundary",(()=>{this.glRedraw()})),this.canvas.on("webglContextFailed",(()=>{alert("xeokit failed to find WebGL!")})),this._renderer=new Vt(this,{transparent:s,alphaDepthMask:r}),this._sectionPlanesState=new function(){this.sectionPlanes=[],this.clippingCaps=!1;let t=null;this.getHash=function(){if(t)return t;const e=this.sectionPlanes;if(0===e.length)return this.hash=";";const i=[];for(let t=0,s=e.length;t<s;t++)e[t],i.push("cp");return i.push(";"),t=i.join(""),t},this.addSectionPlane=function(e){this.sectionPlanes.push(e),t=null},this.removeSectionPlane=function(e){for(let i=0,s=this.sectionPlanes.length;i<s;i++)if(this.sectionPlanes[i].id===e.id)return this.sectionPlanes.splice(i,1),void(t=null)}},this._lightsState=new function(){const t=d.vec4([0,0,0,0]),e=d.vec4();this.lights=[],this.reflectionMaps=[],this.lightMaps=[];let i=null,s=null;this.getHash=function(){if(i)return i;const t=[],e=this.lights;let s;for(let i=0,r=e.length;i<r;i++)s=e[i],t.push("/"),t.push(s.type),t.push("world"===s.space?"w":"v"),s.castsShadow&&t.push("sh");return this.lightMaps.length>0&&t.push("/lm"),this.reflectionMaps.length>0&&t.push("/rm"),t.push(";"),i=t.join(""),i},this.addLight=function(t){this.lights.push(t),s=null,i=null},this.removeLight=function(t){for(let e=0,r=this.lights.length;e<r;e++){if(this.lights[e].id===t.id)return this.lights.splice(e,1),s&&s.id===t.id&&(s=null),void(i=null)}},this.addReflectionMap=function(t){this.reflectionMaps.push(t),i=null},this.removeReflectionMap=function(t){for(let e=0,s=this.reflectionMaps.length;e<s;e++)if(this.reflectionMaps[e].id===t.id)return this.reflectionMaps.splice(e,1),void(i=null)},this.addLightMap=function(t){this.lightMaps.push(t),i=null},this.removeLightMap=function(t){for(let e=0,s=this.lightMaps.length;e<s;e++)if(this.lightMaps[e].id===t.id)return this.lightMaps.splice(e,1),void(i=null)},this.getAmbientColorAndIntensity=function(){if(!s)for(let t=0,e=this.lights.length;t<e;t++){const e=this.lights[t];if("ambient"===e.type){s=e;break}}if(s){const t=s.color,i=s.intensity;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=i,e}return t}},this.input=new zt(this,{dontClear:!0,element:this.canvas.canvas,keyboardEventsElement:e.keyboardEventsElement}),this.metrics=new Fe(this,{units:e.units,scale:e.scale,origin:e.origin}),this.sao=new Ne(this,{enabled:e.saoEnabled}),this.ticksPerRender=e.ticksPerRender,this.ticksPerOcclusionTest=e.ticksPerOcclusionTest,this.passes=e.passes,this.clearEachPass=e.clearEachPass,this.gammaInput=e.gammaInput,this.gammaOutput=e.gammaOutput,this.gammaFactor=e.gammaFactor,this._entityOffsetsEnabled=!!e.entityOffsetsEnabled,this._pickSurfacePrecisionEnabled=!!e.pickSurfacePrecisionEnabled,this._logarithmicDepthBufferEnabled=!!e.logarithmicDepthBufferEnabled,this._pbrEnabled=!!e.pbrEnabled,A._addScene(this),this._initDefaults(),this._viewport=new jt(this,{id:"default.viewport",autoBoundary:!0,dontClear:!0}),this._camera=new ae(this,{id:"default.camera",dontClear:!0}),new he(this,{color:[1,1,1],intensity:.7}),new le(this,{dir:[.8,-.5,-.5],color:[.67,.67,1],intensity:.7,space:"world"}),new le(this,{dir:[-.8,-1,.5],color:[1,1,.9],intensity:.9,space:"world"}),this._camera.on("dirty",(()=>{this._renderer.imageDirty()}))}_initDefaults(){this.geometry,this.material,this.xrayMaterial,this.edgeMaterial,this.selectedMaterial,this.highlightMaterial}_addComponent(t){if(t.id&&this.components[t.id]&&(this.error("Component "+m.inQuotes(t.id)+" already exists in Scene - ignoring ID, will randomly-generate instead"),t.id=null),!t.id)for(void 0===window.nextID&&(window.nextID=0),t.id="__"+window.nextID++;this.components[t.id];)t.id=d.createUUID();this.components[t.id]=t;const e=t.type;let i=this.types[t.type];i||(i=this.types[e]={}),i[t.id]=t,t.compile&&(this._compilables[t.id]=t),t.isDrawable&&(this._renderer.addDrawable(t.id,t),this._collidables[t.id]=t)}_removeComponent(t){var e=t.id,i=t.type;delete this.components[e];const s=this.types[i];s&&(delete s[e],m.isEmptyObject(s)&&delete this.types[i]),t.compile&&delete this._compilables[t.id],t.isDrawable&&(this._renderer.removeDrawable(t.id),delete this._collidables[t.id])}_sectionPlaneCreated(t){this.sectionPlanes[t.id]=t,this.scene._sectionPlanesState.addSectionPlane(t._state),this.scene.fire("sectionPlaneCreated",t,!0),this._needRecompile=!0}_lightCreated(t){this.lights[t.id]=t,this.scene._lightsState.addLight(t._state),this._needRecompile=!0}_lightMapCreated(t){this.lightMaps[t.id]=t,this.scene._lightsState.addLightMap(t._state),this._needRecompile=!0}_reflectionMapCreated(t){this.reflectionMaps[t.id]=t,this.scene._lightsState.addReflectionMap(t._state),this._needRecompile=!0}_sectionPlaneDestroyed(t){delete this.sectionPlanes[t.id],this.scene._sectionPlanesState.removeSectionPlane(t._state),this.scene.fire("sectionPlaneDestroyed",t,!0),this._needRecompile=!0}_lightDestroyed(t){delete this.lights[t.id],this.scene._lightsState.removeLight(t._state),this._needRecompile=!0}_lightMapDestroyed(t){delete this.lightMaps[t.id],this.scene._lightsState.removeLightMap(t._state),this._needRecompile=!0}_reflectionMapDestroyed(t){delete this.reflectionMaps[t.id],this.scene._lightsState.removeReflectionMap(t._state),this._needRecompile=!0}_registerModel(t){this.models[t.id]=t,this._modelIds=null}_deregisterModel(t){const e=t.id;delete this.models[e],this._modelIds=null,this.fire("modelUnloaded",e)}_registerObject(t){this.objects[t.id]=t,this._numObjects++,this._objectIds=null}_deregisterObject(t){delete this.objects[t.id],this._numObjects--,this._objectIds=null}_objectVisibilityUpdated(t,e=!0){t.visible?(this.visibleObjects[t.id]=t,this._numVisibleObjects++):(delete this.visibleObjects[t.id],this._numVisibleObjects--),this._visibleObjectIds=null,e&&this.fire("objectVisibility",t,!0)}_objectXRayedUpdated(t){t.xrayed?(this.xrayedObjects[t.id]=t,this._numXRayedObjects++):(delete this.xrayedObjects[t.id],this._numXRayedObjects--),this._xrayedObjectIds=null}_objectHighlightedUpdated(t){t.highlighted?(this.highlightedObjects[t.id]=t,this._numHighlightedObjects++):(delete this.highlightedObjects[t.id],this._numHighlightedObjects--),this._highlightedObjectIds=null}_objectSelectedUpdated(t){t.selected?(this.selectedObjects[t.id]=t,this._numSelectedObjects++):(delete this.selectedObjects[t.id],this._numSelectedObjects--),this._selectedObjectIds=null}_objectColorizeUpdated(t,e){e?(this.colorizedObjects[t.id]=t,this._numColorizedObjects++):(delete this.colorizedObjects[t.id],this._numColorizedObjects--),this._colorizedObjectIds=null}_objectOpacityUpdated(t,e){e?(this.opacityObjects[t.id]=t,this._numOpacityObjects++):(delete this.opacityObjects[t.id],this._numOpacityObjects--),this._opacityObjectIds=null}_objectOffsetUpdated(t,e){!e||0===e[0]&&0===e[1]&&0===e[2]?(this.offsetObjects[t.id]=t,this._numOffsetObjects++):(delete this.offsetObjects[t.id],this._numOffsetObjects--),this._offsetObjectIds=null}_webglContextLost(){this.canvas.spinner.processes++;for(const t in this.components)if(this.components.hasOwnProperty(t)){const e=this.components[t];e._webglContextLost&&e._webglContextLost()}this._renderer.webglContextLost()}_webglContextRestored(){const t=this.canvas.gl;for(const e in this.components)if(this.components.hasOwnProperty(e)){const i=this.components[e];i._webglContextRestored&&i._webglContextRestored(t)}this._renderer.webglContextRestored(t),this.canvas.spinner.processes--}get entityOffsetsEnabled(){return this._entityOffsetsEnabled}get pickSurfacePrecisionEnabled(){return this._pickSurfacePrecisionEnabled}get logarithmicDepthBufferEnabled(){return this._logarithmicDepthBufferEnabled}set pbrEnabled(t){this._pbrEnabled=!!t,this.glRedraw()}get pbrEnabled(){return this._pbrEnabled}doOcclusionTest(){this._needRecompile&&(this._recompile(),this._needRecompile=!1),this._renderer.doOcclusionTest()}render(t){t&&A.runTasks();const e={sceneId:null,pass:0};if(this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),!t&&!this._renderer.needsRender())return;e.sceneId=this.id;const i=this._passes,s=this._clearEachPass;let r,o;for(r=0;r<i;r++)e.pass=r,this.fire("rendering",e,!0),o=s||0===r,this._renderer.render({pass:r,clear:o,force:t}),this.fire("rendered",e,!0);this._saveAmbientColor()}_recompile(){for(const t in this._compilables)this._compilables.hasOwnProperty(t)&&this._compilables[t].compile();this._renderer.shadowsDirty(),this.fire("compile",this,!0)}_saveAmbientColor(){const t=this.canvas;if(t.transparent||t.backgroundImage||t.backgroundColor)this._lastAmbientColor=null;else{const e=this._lightsState.getAmbientColorAndIntensity();this._lastAmbientColor&&this._lastAmbientColor[0]===e[0]&&this._lastAmbientColor[1]===e[1]&&this._lastAmbientColor[2]===e[2]&&this._lastAmbientColor[3]===e[3]||(t.backgroundColor=e,this._lastAmbientColor||(this._lastAmbientColor=d.vec4([0,0,0,1])),this._lastAmbientColor.set(e))}}get modelIds(){return this._modelIds||(this._modelIds=Object.keys(this.models)),this._modelIds}get numObjects(){return this._numObjects}get objectIds(){return this._objectIds||(this._objectIds=Object.keys(this.objects)),this._objectIds}get numVisibleObjects(){return this._numVisibleObjects}get visibleObjectIds(){return this._visibleObjectIds||(this._visibleObjectIds=Object.keys(this.visibleObjects)),this._visibleObjectIds}get numXRayedObjects(){return this._numXRayedObjects}get xrayedObjectIds(){return this._xrayedObjectIds||(this._xrayedObjectIds=Object.keys(this.xrayedObjects)),this._xrayedObjectIds}get numHighlightedObjects(){return this._numHighlightedObjects}get highlightedObjectIds(){return this._highlightedObjectIds||(this._highlightedObjectIds=Object.keys(this.highlightedObjects)),this._highlightedObjectIds}get numSelectedObjects(){return this._numSelectedObjects}get selectedObjectIds(){return this._selectedObjectIds||(this._selectedObjectIds=Object.keys(this.selectedObjects)),this._selectedObjectIds}get numColorizedObjects(){return this._numColorizedObjects}get colorizedObjectIds(){return this._colorizedObjectIds||(this._colorizedObjectIds=Object.keys(this.colorizedObjects)),this._colorizedObjectIds}get opacityObjectIds(){return this._opacityObjectIds||(this._opacityObjectIds=Object.keys(this.opacityObjects)),this._opacityObjectIds}get offsetObjectIds(){return this._offsetObjectIds||(this._offsetObjectIds=Object.keys(this.offsetObjects)),this._offsetObjectIds}set ticksPerRender(t){null==t?t=1:(!m.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'ticksPerRender': '"+t+"' - should be an integer greater than zero."),t=1),t!==this._ticksPerRender&&(this._ticksPerRender=t)}get ticksPerRender(){return this._ticksPerRender}set ticksPerOcclusionTest(t){null==t?t=20:(!m.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'ticksPerOcclusionTest': '"+t+"' - should be an integer greater than zero."),t=20),t!==this._ticksPerOcclusionTest&&(this._ticksPerOcclusionTest=t)}get ticksPerOcclusionTest(){return this._ticksPerOcclusionTest}set passes(t){null==t?t=1:(!m.isNumeric(t)||t<=0)&&(this.error("Unsupported value for 'passes': '"+t+"' - should be an integer greater than zero."),t=1),t!==this._passes&&(this._passes=t,this.glRedraw())}get passes(){return this._passes}set clearEachPass(t){(t=!!t)!==this._clearEachPass&&(this._clearEachPass=t,this.glRedraw())}get clearEachPass(){return this._clearEachPass}set gammaInput(t){(t=!1!==t)!==this._renderer.gammaInput&&(this._renderer.gammaInput=t,this._needRecompile=!0,this.glRedraw())}get gammaInput(){return this._renderer.gammaInput}set gammaOutput(t){(t=!!t)!==this._renderer.gammaOutput&&(this._renderer.gammaOutput=t,this._needRecompile=!0,this.glRedraw())}get gammaOutput(){return this._renderer.gammaOutput}set gammaFactor(t){(t=null==t?2.2:t)!==this._renderer.gammaFactor&&(this._renderer.gammaFactor=t,this.glRedraw())}get gammaFactor(){return this._renderer.gammaFactor}get geometry(){return this.components["default.geometry"]||we(xe)}get material(){return this.components["default.material"]||new Se(this,{id:"default.material",emissive:[.4,.4,.4],dontClear:!0})}get xrayMaterial(){return this.components["default.xrayMaterial"]||new Le(this,{id:"default.xrayMaterial",preset:"sepia",dontClear:!0})}get highlightMaterial(){return this.components["default.highlightMaterial"]||new Le(this,{id:"default.highlightMaterial",preset:"yellowHighlight",dontClear:!0})}get selectedMaterial(){return this.components["default.selectedMaterial"]||new Le(this,{id:"default.selectedMaterial",preset:"greenSelected",dontClear:!0})}get edgeMaterial(){return this.components["default.edgeMaterial"]||new Re(this,{id:"default.edgeMaterial",preset:"default",edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1,dontClear:!0})}get pointsMaterial(){return this.components["default.pointsMaterial"]||new ke(this,{id:"default.pointsMaterial",preset:"default",dontClear:!0})}get linesMaterial(){return this.components["default.linesMaterial"]||new Ve(this,{id:"default.linesMaterial",preset:"default",dontClear:!0})}get viewport(){return this._viewport}get camera(){return this._camera}get center(){if(this._aabbDirty||!this._center){this._center&&this._center||(this._center=d.vec3());const t=this.aabb;this._center[0]=(t[0]+t[3])/2,this._center[1]=(t[1]+t[4])/2,this._center[2]=(t[2]+t[5])/2}return this._center}get aabb(){if(this._aabbDirty){this._aabb||(this._aabb=d.AABB3());let t,e=d.MAX_DOUBLE,i=d.MAX_DOUBLE,s=d.MAX_DOUBLE,r=d.MIN_DOUBLE,o=d.MIN_DOUBLE,a=d.MIN_DOUBLE;const n=this._collidables;let l,h=!1;for(const c in n)if(n.hasOwnProperty(c)){if(l=n[c],!1===l.collidable)continue;t=l.aabb,t[0]<e&&(e=t[0]),t[1]<i&&(i=t[1]),t[2]<s&&(s=t[2]),t[3]>r&&(r=t[3]),t[4]>o&&(o=t[4]),t[5]>a&&(a=t[5]),h=!0}h||(e=-100,i=-100,s=-100,r=100,o=100,a=100),this._aabb[0]=e,this._aabb[1]=i,this._aabb[2]=s,this._aabb[3]=r,this._aabb[4]=o,this._aabb[5]=a,this._aabbDirty=!1}return this._aabb}_setAABBDirty(){this._aabbDirty=!0,this.fire("boundary")}pick(t,e){if(0===this.canvas.boundary[2]||0===this.canvas.boundary[3])return this.error("Picking not allowed while canvas has zero width or height"),null;(t=t||{}).pickSurface=t.pickSurface||t.rayPick,t.canvasPos||t.matrix||t.origin&&t.direction||this.warn("picking without canvasPos, matrix, or ray origin and direction");const i=t.includeEntities||t.include;i&&(t.includeEntityIds=ze(this,i));const s=t.excludeEntities||t.exclude;return s&&(t.excludeEntityIds=ze(this,s)),this._needRecompile&&(this._recompile(),this._renderer.imageDirty(),this._needRecompile=!1),(e=this._renderer.pick(t,e))?(e.entity&&e.entity.fire&&e.entity.fire("picked",e),e):void 0}clear(){var t;for(const e in this.components)this.components.hasOwnProperty(e)&&((t=this.components[e])._dontClear||t.destroy())}clearLights(){const t=Object.keys(this.lights);for(let e=0,i=t.length;e<i;e++)this.lights[t[e]].destroy()}clearSectionPlanes(){const t=Object.keys(this.sectionPlanes);for(let e=0,i=t.length;e<i;e++)this.sectionPlanes[t[e]].destroy()}getAABB(t){if(void 0===t)return this.aabb;if(m.isString(t)){const e=this.objects[t];if(e&&e.aabb)return e.aabb;t=[t]}if(0===t.length)return this.aabb;let e,i=d.MAX_DOUBLE,s=d.MAX_DOUBLE,r=d.MAX_DOUBLE,o=d.MIN_DOUBLE,a=d.MIN_DOUBLE,n=d.MIN_DOUBLE;if(this.withObjects(t,(t=>{if(t.collidable){const l=t.aabb;l[0]<i&&(i=l[0]),l[1]<s&&(s=l[1]),l[2]<r&&(r=l[2]),l[3]>o&&(o=l[3]),l[4]>a&&(a=l[4]),l[5]>n&&(n=l[5]),e=!0}})),e){const t=d.AABB3();return t[0]=i,t[1]=s,t[2]=r,t[3]=o,t[4]=a,t[5]=n,t}return this.aabb}setObjectsVisible(t,e){return this.withObjects(t,(t=>{const i=t.visible!==e;return t.visible=e,i}))}setObjectsCollidable(t,e){return this.withObjects(t,(t=>{const i=t.collidable!==e;return t.collidable=e,i}))}setObjectsCulled(t,e){return this.withObjects(t,this.objects,(t=>{const i=t.culled!==e;return t.culled=e,i}))}setObjectsSelected(t,e){return this.withObjects(t,(t=>{const i=t.selected!==e;return t.selected=e,i}))}setObjectsHighlighted(t,e){return this.withObjects(t,(t=>{const i=t.highlighted!==e;return t.highlighted=e,i}))}setObjectsXRayed(t,e){return this.withObjects(t,(t=>{const i=t.xrayed!==e;return t.xrayed=e,i}))}setObjectsEdges(t,e){return this.withObjects(t,(t=>{const i=t.edges!==e;return t.edges=e,i}))}setObjectsColorized(t,e){return this.withObjects(t,(t=>{t.colorize=e}))}setObjectsOpacity(t,e){return this.withObjects(t,(t=>{const i=t.opacity!==e;return t.opacity=e,i}))}setObjectsPickable(t,e){return this.withObjects(t,(t=>{const i=t.pickable!==e;return t.pickable=e,i}))}setObjectsOffset(t,e){this.withObjects(t,(t=>{t.offset=e}))}withObjects(t,e){m.isString(t)&&(t=[t]);let i=!1;for(let s=0,r=t.length;s<r;s++){const r=t[s];let o=this.objects[r];if(o)i=e(o)||i;else{const t=this.modelIds;for(let s=0,a=t.length;s<a;s++){const a=t[s],n=d.globalizeObjectId(a,r);o=this.objects[n],o&&(i=e(o)||i)}}}return i}destroy(){super.destroy();for(const t in this.components)this.components.hasOwnProperty(t)&&this.components[t].destroy();this.canvas.gl=null,this.components=null,this.models=null,this.objects=null,this.visibleObjects=null,this.xrayedObjects=null,this.highlightedObjects=null,this.selectedObjects=null,this.colorizedObjects=null,this.opacityObjects=null,this.sectionPlanes=null,this.lights=null,this.lightMaps=null,this.reflectionMaps=null,this._objectIds=null,this._visibleObjectIds=null,this._xrayedObjectIds=null,this._highlightedObjectIds=null,this._selectedObjectIds=null,this._colorizedObjectIds=null,this.types=null,this.components=null,this.canvas=null,this._renderer=null,this.input=null,this._viewport=null,this._camera=null}}const Ge=function(t){"LambertMaterial"===t._material._state.type?(this.vertex=function(t){const e=t.scene,i=t.scene._sectionPlanesState,s=t.scene._lightsState,r=t._geometry._state,o=t._state.billboard,a=t._state.stationary,n=i.sectionPlanes.length>0,l=!!r.compressGeometry,h=[];h.push("// Lambertian drawing vertex shader"),e.logarithmicDepthBufferEnabled&&h.push("#extension GL_EXT_frag_depth : enable");h.push("attribute vec3 position;"),h.push("uniform mat4 modelMatrix;"),h.push("uniform mat4 viewMatrix;"),h.push("uniform mat4 projMatrix;"),h.push("uniform vec4 colorize;"),h.push("uniform vec3 offset;"),l&&h.push("uniform mat4 positionsDecodeMatrix;");e.logarithmicDepthBufferEnabled&&(h.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&h.push("varying float vFragDepth;"),h.push("bool isPerspectiveMatrix(mat4 m) {"),h.push("    return (m[2][3] == - 1.0);"),h.push("}"),h.push("varying float isPerspective;"));n&&h.push("varying vec4 vWorldPosition;");if(h.push("uniform vec4 lightAmbient;"),h.push("uniform vec4 materialColor;"),h.push("uniform vec3 materialEmissive;"),r.normalsBuf){h.push("attribute vec3 normal;"),h.push("uniform mat4 modelNormalMatrix;"),h.push("uniform mat4 viewNormalMatrix;");for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];"ambient"!==e.type&&(h.push("uniform vec4 lightColor"+t+";"),"dir"===e.type&&h.push("uniform vec3 lightDir"+t+";"),"point"===e.type&&h.push("uniform vec3 lightPos"+t+";"),"spot"===e.type&&(h.push("uniform vec3 lightPos"+t+";"),h.push("uniform vec3 lightDir"+t+";")))}l&&(h.push("vec3 octDecode(vec2 oct) {"),h.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),h.push("    if (v.z < 0.0) {"),h.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),h.push("    }"),h.push("    return normalize(v);"),h.push("}"))}h.push("varying vec4 vColor;"),"points"===r.primitiveName&&h.push("uniform float pointSize;");"spherical"!==o&&"cylindrical"!==o||(h.push("void billboard(inout mat4 mat) {"),h.push("   mat[0][0] = 1.0;"),h.push("   mat[0][1] = 0.0;"),h.push("   mat[0][2] = 0.0;"),"spherical"===o&&(h.push("   mat[1][0] = 0.0;"),h.push("   mat[1][1] = 1.0;"),h.push("   mat[1][2] = 0.0;")),h.push("   mat[2][0] = 0.0;"),h.push("   mat[2][1] = 0.0;"),h.push("   mat[2][2] =1.0;"),h.push("}"));h.push("void main(void) {"),h.push("vec4 localPosition = vec4(position, 1.0); "),h.push("vec4 worldPosition;"),l&&h.push("localPosition = positionsDecodeMatrix * localPosition;");r.normalsBuf&&(l?h.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):h.push("vec4 localNormal = vec4(normal, 0.0); "),h.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),h.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));h.push("mat4 viewMatrix2 = viewMatrix;"),h.push("mat4 modelMatrix2 = modelMatrix;"),a&&h.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===o||"cylindrical"===o?(h.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),h.push("billboard(modelMatrix2);"),h.push("billboard(viewMatrix2);"),h.push("billboard(modelViewMatrix);"),r.normalsBuf&&(h.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),h.push("billboard(modelNormalMatrix2);"),h.push("billboard(viewNormalMatrix2);"),h.push("billboard(modelViewNormalMatrix);")),h.push("worldPosition = modelMatrix2 * localPosition;"),h.push("worldPosition.xyz = worldPosition.xyz + offset;"),h.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(h.push("worldPosition = modelMatrix2 * localPosition;"),h.push("worldPosition.xyz = worldPosition.xyz + offset;"),h.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));r.normalsBuf&&h.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(h.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),h.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),h.push("float lambertian = 1.0;"),r.normalsBuf)for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?h.push("viewLightDir = normalize(lightDir"+t+");"):h.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?h.push("viewLightDir = -normalize(lightPos"+t+" - viewPosition.xyz);"):h.push("viewLightDir = -normalize((viewMatrix2 * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?h.push("viewLightDir = normalize(lightDir"+t+");"):h.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+t+", 0.0)).xyz);")}h.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),h.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}}h.push("vColor = vec4((lightAmbient.rgb * lightAmbient.a * materialColor.rgb) + materialEmissive.rgb + (reflectedColor * materialColor.rgb), materialColor.a) * colorize;"),n&&h.push("vWorldPosition = worldPosition;");"points"===r.primitiveName&&h.push("gl_PointSize = pointSize;");h.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?h.push("vFragDepth = 1.0 + clipPos.w;"):(h.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),h.push("clipPos.z *= clipPos.w;")),h.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return h.push("gl_Position = clipPos;"),h.push("}"),h}(t),this.fragment=function(t){const e=t.scene,i=e._sectionPlanesState;t._material._state;const s=t._geometry._state,r=i.sectionPlanes.length>0,o=e.gammaOutput,a=[];a.push("// Lambertian drawing fragment shader"),e.logarithmicDepthBufferEnabled&&a.push("#extension GL_EXT_frag_depth : enable");a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("varying float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;"));if(r){a.push("varying vec4 vWorldPosition;"),a.push("uniform bool clippable;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)a.push("uniform bool sectionPlaneActive"+t+";"),a.push("uniform vec3 sectionPlanePos"+t+";"),a.push("uniform vec3 sectionPlaneDir"+t+";")}a.push("varying vec4 vColor;"),o&&(a.push("uniform float gammaFactor;"),a.push("    vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("    return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}"));if(a.push("void main(void) {"),r){a.push("if (clippable) {"),a.push("  float dist = 0.0;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)a.push("if (sectionPlaneActive"+t+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { discard; }"),a.push("}")}"points"===s.primitiveName&&(a.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),a.push("float r = dot(cxy, cxy);"),a.push("if (r > 1.0) {"),a.push("   discard;"),a.push("}"));e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");o?a.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):a.push("gl_FragColor = vColor;");return a.push("}"),a}(t)):(this.vertex=function(t){const e=t.scene,i=t._material,s=t._state,r=e._sectionPlanesState,o=t._geometry._state,a=e._lightsState;let n;const l=s.billboard,h=s.background,c=s.stationary,u=function(t){if(!t._geometry._state.uvBuf)return!1;const e=t._material;return!!(e._ambientMap||e._occlusionMap||e._baseColorMap||e._diffuseMap||e._alphaMap||e._specularMap||e._glossinessMap||e._specularGlossinessMap||e._emissiveMap||e._metallicMap||e._roughnessMap||e._metallicRoughnessMap||e._reflectivityMap||e._normalMap)}(t),d=We(t),p=r.sectionPlanes.length>0,_=Xe(t),f=!!o.compressGeometry,g=[];g.push("// Drawing vertex shader"),d&&i._normalMap&&g.push("#extension GL_OES_standard_derivatives : enable");e.logarithmicDepthBufferEnabled&&g.push("#extension GL_EXT_frag_depth : enable");g.push("attribute  vec3 position;"),f&&g.push("uniform mat4 positionsDecodeMatrix;");g.push("uniform  mat4 modelMatrix;"),g.push("uniform  mat4 viewMatrix;"),g.push("uniform  mat4 projMatrix;"),g.push("varying  vec3 vViewPosition;"),g.push("uniform  vec3 offset;"),p&&g.push("varying vec4 vWorldPosition;");e.logarithmicDepthBufferEnabled&&(g.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&g.push("varying float vFragDepth;"),g.push("bool isPerspectiveMatrix(mat4 m) {"),g.push("    return (m[2][3] == - 1.0);"),g.push("}"),g.push("varying float isPerspective;"));a.lightMaps.length>0&&g.push("varying    vec3 vWorldNormal;");if(d){g.push("attribute  vec3 normal;"),g.push("uniform    mat4 modelNormalMatrix;"),g.push("uniform    mat4 viewNormalMatrix;"),g.push("varying    vec3 vViewNormal;");for(let t=0,e=a.lights.length;t<e;t++)n=a.lights[t],"ambient"!==n.type&&("dir"===n.type&&g.push("uniform vec3 lightDir"+t+";"),"point"===n.type&&g.push("uniform vec3 lightPos"+t+";"),"spot"===n.type&&(g.push("uniform vec3 lightPos"+t+";"),g.push("uniform vec3 lightDir"+t+";")),"dir"===n.type&&"view"===n.space||g.push("varying vec4 vViewLightReverseDirAndDist"+t+";"));f&&(g.push("vec3 octDecode(vec2 oct) {"),g.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),g.push("    if (v.z < 0.0) {"),g.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),g.push("    }"),g.push("    return normalize(v);"),g.push("}"))}u&&(g.push("attribute vec2 uv;"),g.push("varying vec2 vUV;"),f&&g.push("uniform mat3 uvDecodeMatrix;"));o.colors&&(g.push("attribute vec4 color;"),g.push("varying vec4 vColor;"));"points"===o.primitiveName&&g.push("uniform float pointSize;");"spherical"!==l&&"cylindrical"!==l||(g.push("void billboard(inout mat4 mat) {"),g.push("   mat[0][0] = 1.0;"),g.push("   mat[0][1] = 0.0;"),g.push("   mat[0][2] = 0.0;"),"spherical"===l&&(g.push("   mat[1][0] = 0.0;"),g.push("   mat[1][1] = 1.0;"),g.push("   mat[1][2] = 0.0;")),g.push("   mat[2][0] = 0.0;"),g.push("   mat[2][1] = 0.0;"),g.push("   mat[2][2] =1.0;"),g.push("}"));if(_){g.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);");for(let t=0,e=a.lights.length;t<e;t++)a.lights[t].castsShadow&&(g.push("uniform mat4 shadowViewMatrix"+t+";"),g.push("uniform mat4 shadowProjMatrix"+t+";"),g.push("varying vec4 vShadowPosFromLight"+t+";"))}g.push("void main(void) {"),g.push("vec4 localPosition = vec4(position, 1.0); "),g.push("vec4 worldPosition;"),f&&g.push("localPosition = positionsDecodeMatrix * localPosition;");d&&(f?g.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):g.push("vec4 localNormal = vec4(normal, 0.0); "),g.push("mat4 modelNormalMatrix2    = modelNormalMatrix;"),g.push("mat4 viewNormalMatrix2     = viewNormalMatrix;"));g.push("mat4 viewMatrix2           = viewMatrix;"),g.push("mat4 modelMatrix2          = modelMatrix;"),c?g.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;"):h&&g.push("viewMatrix2[3] = vec4(0.0, 0.0, 0.0 ,1.0);");"spherical"===l||"cylindrical"===l?(g.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),g.push("billboard(modelMatrix2);"),g.push("billboard(viewMatrix2);"),g.push("billboard(modelViewMatrix);"),d&&(g.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),g.push("billboard(modelNormalMatrix2);"),g.push("billboard(viewNormalMatrix2);"),g.push("billboard(modelViewNormalMatrix);")),g.push("worldPosition = modelMatrix2 * localPosition;"),g.push("worldPosition.xyz = worldPosition.xyz + offset;"),g.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(g.push("worldPosition = modelMatrix2 * localPosition;"),g.push("worldPosition.xyz = worldPosition.xyz + offset;"),g.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));if(d){g.push("vec3 worldNormal = (modelNormalMatrix2 * localNormal).xyz; "),a.lightMaps.length>0&&g.push("vWorldNormal = worldNormal;"),g.push("vViewNormal = normalize((viewNormalMatrix2 * vec4(worldNormal, 1.0)).xyz);"),g.push("vec3 tmpVec3;"),g.push("float lightDist;");for(let t=0,e=a.lights.length;t<e;t++)n=a.lights[t],"ambient"!==n.type&&("dir"===n.type&&"world"===n.space&&(g.push("tmpVec3 = vec3(viewMatrix2 * vec4(lightDir"+t+", 0.0) ).xyz;"),g.push("vViewLightReverseDirAndDist"+t+" = vec4(-tmpVec3, 0.0);")),"point"===n.type&&("world"===n.space?(g.push("tmpVec3 = (viewMatrix2 * vec4(lightPos"+t+", 1.0)).xyz - viewPosition.xyz;"),g.push("lightDist = abs(length(tmpVec3));")):(g.push("tmpVec3 = lightPos"+t+".xyz - viewPosition.xyz;"),g.push("lightDist = abs(length(tmpVec3));")),g.push("vViewLightReverseDirAndDist"+t+" = vec4(tmpVec3, lightDist);")))}u&&(f?g.push("vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;"):g.push("vUV = uv;"));o.colors&&g.push("vColor = color;");"points"===o.primitiveName&&g.push("gl_PointSize = pointSize;");p&&g.push("vWorldPosition = worldPosition;");g.push("   vViewPosition = viewPosition.xyz;"),g.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?g.push("vFragDepth = 1.0 + clipPos.w;"):(g.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),g.push("clipPos.z *= clipPos.w;")),g.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));h&&g.push("clipPos.z = clipPos.w;");if(g.push("gl_Position = clipPos;"),_){g.push("const mat4 texUnitConverter = mat4(0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0);"),g.push("vec4 tempx; ");for(let t=0,e=a.lights.length;t<e;t++)a.lights[t].castsShadow&&g.push("vShadowPosFromLight"+t+" = texUnitConverter * shadowProjMatrix"+t+" * (shadowViewMatrix"+t+" * worldPosition); ")}return g.push("}"),g}(t),this.fragment=function(t){const e=t.scene;e.canvas.gl;const i=t._material,s=t._geometry._state,r=t.scene._sectionPlanesState,o=t.scene._lightsState,a=t._material._state,n=r.sectionPlanes.length>0,l=We(t),h=s.uvBuf,c="PhongMaterial"===a.type,u="MetallicMaterial"===a.type,d="SpecularMaterial"===a.type,p=Xe(t);e.gammaInput;const _=e.gammaOutput,f=[];f.push("// Drawing fragment shader"),e.logarithmicDepthBufferEnabled&&f.push("#extension GL_EXT_frag_depth : enable");l&&i._normalMap&&f.push("#extension GL_OES_standard_derivatives : enable");f.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),f.push("precision highp float;"),f.push("precision highp int;"),f.push("#else"),f.push("precision mediump float;"),f.push("precision mediump int;"),f.push("#endif"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(f.push("varying float isPerspective;"),f.push("uniform float logDepthBufFC;"),f.push("varying float vFragDepth;"));p&&(f.push("float unpackDepth (vec4 color) {"),f.push("  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0 * 256.0), 1.0/(256.0*256.0*256.0));"),f.push("  return dot(color, bitShift);"),f.push("}"));f.push("uniform float gammaFactor;"),f.push("vec4 linearToLinear( in vec4 value ) {"),f.push("  return value;"),f.push("}"),f.push("vec4 sRGBToLinear( in vec4 value ) {"),f.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),f.push("}"),f.push("vec4 gammaToLinear( in vec4 value) {"),f.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),f.push("}"),_&&(f.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),f.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),f.push("}"));if(n){f.push("varying vec4 vWorldPosition;"),f.push("uniform bool clippable;");for(var g=0;g<r.sectionPlanes.length;g++)f.push("uniform bool sectionPlaneActive"+g+";"),f.push("uniform vec3 sectionPlanePos"+g+";"),f.push("uniform vec3 sectionPlaneDir"+g+";")}l&&(o.lightMaps.length>0&&(f.push("uniform samplerCube lightMap;"),f.push("uniform mat4 viewNormalMatrix;")),o.reflectionMaps.length>0&&f.push("uniform samplerCube reflectionMap;"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&f.push("uniform mat4 viewMatrix;"),f.push("#define PI 3.14159265359"),f.push("#define RECIPROCAL_PI 0.31830988618"),f.push("#define RECIPROCAL_PI2 0.15915494"),f.push("#define EPSILON 1e-6"),f.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),f.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),f.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),f.push("}"),f.push("struct IncidentLight {"),f.push("   vec3 color;"),f.push("   vec3 direction;"),f.push("};"),f.push("struct ReflectedLight {"),f.push("   vec3 diffuse;"),f.push("   vec3 specular;"),f.push("};"),f.push("struct Geometry {"),f.push("   vec3 position;"),f.push("   vec3 viewNormal;"),f.push("   vec3 worldNormal;"),f.push("   vec3 viewEyeDir;"),f.push("};"),f.push("struct Material {"),f.push("   vec3    diffuseColor;"),f.push("   float   specularRoughness;"),f.push("   vec3    specularColor;"),f.push("   float   shine;"),f.push("};"),c&&((o.lightMaps.length>0||o.reflectionMaps.length>0)&&(f.push("void computePhongLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(f.push("   vec3 irradiance = "+je[o.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),f.push("   irradiance *= PI;"),f.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(f.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),f.push("   vec3 radiance               = textureCube(reflectionMap, reflectVec).rgb * 0.2;"),f.push("   radiance *= PI;"),f.push("   reflectedLight.specular     += radiance;")),f.push("}")),f.push("void computePhongLighting(const in IncidentLight directLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),f.push("   float dotNL     = saturate(dot(geometry.viewNormal, directLight.direction));"),f.push("   vec3 irradiance = dotNL * directLight.color * PI;"),f.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.specular += directLight.color * material.specularColor * pow(max(dot(reflect(-directLight.direction, -geometry.viewNormal), geometry.viewEyeDir), 0.0), material.shine);"),f.push("}")),(u||d)&&(f.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),f.push("   float r = ggxRoughness + 0.0001;"),f.push("   return (2.0 / (r * r) - 2.0);"),f.push("}"),f.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),f.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),f.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),f.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),f.push("}"),o.reflectionMaps.length>0&&(f.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),f.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),f.push("   vec3 envMapColor = "+je[o.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),f.push("  return envMapColor;"),f.push("}")),f.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),f.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),f.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),f.push("}"),f.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),f.push("   float a2 = ( alpha * alpha );"),f.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),f.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),f.push("   return 1.0 / ( gl * gv );"),f.push("}"),f.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),f.push("   float a2 = ( alpha * alpha );"),f.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),f.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),f.push("   return 0.5 / max( gv + gl, EPSILON );"),f.push("}"),f.push("float D_GGX(const in float alpha, const in float dotNH) {"),f.push("   float a2 = ( alpha * alpha );"),f.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),f.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),f.push("}"),f.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),f.push("   float alpha = ( roughness * roughness );"),f.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),f.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),f.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),f.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),f.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),f.push("   vec3  F = F_Schlick( specularColor, dotLH );"),f.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),f.push("   float D = D_GGX( alpha, dotNH );"),f.push("   return F * (G * D);"),f.push("}"),f.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),f.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),f.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),f.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),f.push("   vec4 r = roughness * c0 + c1;"),f.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),f.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),f.push("   return specularColor * AB.x + AB.y;"),f.push("}"),(o.lightMaps.length>0||o.reflectionMaps.length>0)&&(f.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),o.lightMaps.length>0&&(f.push("   vec3 irradiance = sRGBToLinear(textureCube(lightMap, geometry.worldNormal)).rgb;"),f.push("   irradiance *= PI;"),f.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),o.reflectionMaps.length>0&&(f.push("   vec3 reflectVec             = reflect(-geometry.viewEyeDir, geometry.viewNormal);"),f.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),f.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),f.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),f.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),f.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),f.push("}")),f.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),f.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),f.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),f.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),f.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),f.push("}")));f.push("varying vec3 vViewPosition;"),s.colors&&f.push("varying vec4 vColor;");h&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._occlusionMap||i._alphaMap)&&f.push("varying vec2 vUV;");l&&(o.lightMaps.length>0&&f.push("varying vec3 vWorldNormal;"),f.push("varying vec3 vViewNormal;"));a.ambient&&f.push("uniform vec3 materialAmbient;");a.baseColor&&f.push("uniform vec3 materialBaseColor;");void 0!==a.alpha&&null!==a.alpha&&f.push("uniform vec4 materialAlphaModeCutoff;");a.emissive&&f.push("uniform vec3 materialEmissive;");a.diffuse&&f.push("uniform vec3 materialDiffuse;");void 0!==a.glossiness&&null!==a.glossiness&&f.push("uniform float materialGlossiness;");void 0!==a.shininess&&null!==a.shininess&&f.push("uniform float materialShininess;");a.specular&&f.push("uniform vec3 materialSpecular;");void 0!==a.metallic&&null!==a.metallic&&f.push("uniform float materialMetallic;");void 0!==a.roughness&&null!==a.roughness&&f.push("uniform float materialRoughness;");void 0!==a.specularF0&&null!==a.specularF0&&f.push("uniform float materialSpecularF0;");h&&i._ambientMap&&(f.push("uniform sampler2D ambientMap;"),i._ambientMap._state.matrix&&f.push("uniform mat4 ambientMapMatrix;"));h&&i._baseColorMap&&(f.push("uniform sampler2D baseColorMap;"),i._baseColorMap._state.matrix&&f.push("uniform mat4 baseColorMapMatrix;"));h&&i._diffuseMap&&(f.push("uniform sampler2D diffuseMap;"),i._diffuseMap._state.matrix&&f.push("uniform mat4 diffuseMapMatrix;"));h&&i._emissiveMap&&(f.push("uniform sampler2D emissiveMap;"),i._emissiveMap._state.matrix&&f.push("uniform mat4 emissiveMapMatrix;"));l&&h&&i._metallicMap&&(f.push("uniform sampler2D metallicMap;"),i._metallicMap._state.matrix&&f.push("uniform mat4 metallicMapMatrix;"));l&&h&&i._roughnessMap&&(f.push("uniform sampler2D roughnessMap;"),i._roughnessMap._state.matrix&&f.push("uniform mat4 roughnessMapMatrix;"));l&&h&&i._metallicRoughnessMap&&(f.push("uniform sampler2D metallicRoughnessMap;"),i._metallicRoughnessMap._state.matrix&&f.push("uniform mat4 metallicRoughnessMapMatrix;"));l&&i._normalMap&&(f.push("uniform sampler2D normalMap;"),i._normalMap._state.matrix&&f.push("uniform mat4 normalMapMatrix;"),f.push("vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {"),f.push("      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );"),f.push("      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );"),f.push("      vec2 st0 = dFdx( uv.st );"),f.push("      vec2 st1 = dFdy( uv.st );"),f.push("      vec3 S = normalize( q0 * st1.t - q1 * st0.t );"),f.push("      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );"),f.push("      vec3 N = normalize( surf_norm );"),f.push("      vec3 mapN = texture2D( normalMap, uv ).xyz * 2.0 - 1.0;"),f.push("      mat3 tsn = mat3( S, T, N );"),f.push("      return normalize( tsn * mapN );"),f.push("}"));h&&i._occlusionMap&&(f.push("uniform sampler2D occlusionMap;"),i._occlusionMap._state.matrix&&f.push("uniform mat4 occlusionMapMatrix;"));h&&i._alphaMap&&(f.push("uniform sampler2D alphaMap;"),i._alphaMap._state.matrix&&f.push("uniform mat4 alphaMapMatrix;"));l&&h&&i._specularMap&&(f.push("uniform sampler2D specularMap;"),i._specularMap._state.matrix&&f.push("uniform mat4 specularMapMatrix;"));l&&h&&i._glossinessMap&&(f.push("uniform sampler2D glossinessMap;"),i._glossinessMap._state.matrix&&f.push("uniform mat4 glossinessMapMatrix;"));l&&h&&i._specularGlossinessMap&&(f.push("uniform sampler2D materialSpecularGlossinessMap;"),i._specularGlossinessMap._state.matrix&&f.push("uniform mat4 materialSpecularGlossinessMapMatrix;"));l&&(i._diffuseFresnel||i._specularFresnel||i._alphaFresnel||i._emissiveFresnel||i._reflectivityFresnel)&&(f.push("float fresnel(vec3 eyeDir, vec3 normal, float edgeBias, float centerBias, float power) {"),f.push("    float fr = abs(dot(eyeDir, normal));"),f.push("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),f.push("    return pow(finalFr, power);"),f.push("}"),i._diffuseFresnel&&(f.push("uniform float  diffuseFresnelCenterBias;"),f.push("uniform float  diffuseFresnelEdgeBias;"),f.push("uniform float  diffuseFresnelPower;"),f.push("uniform vec3   diffuseFresnelCenterColor;"),f.push("uniform vec3   diffuseFresnelEdgeColor;")),i._specularFresnel&&(f.push("uniform float  specularFresnelCenterBias;"),f.push("uniform float  specularFresnelEdgeBias;"),f.push("uniform float  specularFresnelPower;"),f.push("uniform vec3   specularFresnelCenterColor;"),f.push("uniform vec3   specularFresnelEdgeColor;")),i._alphaFresnel&&(f.push("uniform float  alphaFresnelCenterBias;"),f.push("uniform float  alphaFresnelEdgeBias;"),f.push("uniform float  alphaFresnelPower;"),f.push("uniform vec3   alphaFresnelCenterColor;"),f.push("uniform vec3   alphaFresnelEdgeColor;")),i._reflectivityFresnel&&(f.push("uniform float  materialSpecularF0FresnelCenterBias;"),f.push("uniform float  materialSpecularF0FresnelEdgeBias;"),f.push("uniform float  materialSpecularF0FresnelPower;"),f.push("uniform vec3   materialSpecularF0FresnelCenterColor;"),f.push("uniform vec3   materialSpecularF0FresnelEdgeColor;")),i._emissiveFresnel&&(f.push("uniform float  emissiveFresnelCenterBias;"),f.push("uniform float  emissiveFresnelEdgeBias;"),f.push("uniform float  emissiveFresnelPower;"),f.push("uniform vec3   emissiveFresnelCenterColor;"),f.push("uniform vec3   emissiveFresnelEdgeColor;")));if(f.push("uniform vec4   lightAmbient;"),l)for(let t=0,e=o.lights.length;t<e;t++){const e=o.lights[t];"ambient"!==e.type&&(f.push("uniform vec4 lightColor"+t+";"),"point"===e.type&&f.push("uniform vec3 lightAttenuation"+t+";"),"dir"===e.type&&"view"===e.space&&f.push("uniform vec3 lightDir"+t+";"),"point"===e.type&&"view"===e.space?f.push("uniform vec3 lightPos"+t+";"):f.push("varying vec4 vViewLightReverseDirAndDist"+t+";"))}if(p)for(let t=0,e=o.lights.length;t<e;t++)o.lights[t].castsShadow&&(f.push("varying vec4 vShadowPosFromLight"+t+";"),f.push("uniform sampler2D shadowMap"+t+";"));if(f.push("uniform vec4 colorize;"),f.push("void main(void) {"),n){f.push("if (clippable) {"),f.push("  float dist = 0.0;");for(g=0;g<r.sectionPlanes.length;g++)f.push("if (sectionPlaneActive"+g+") {"),f.push("   dist += clamp(dot(-sectionPlaneDir"+g+".xyz, vWorldPosition.xyz - sectionPlanePos"+g+".xyz), 0.0, 1000.0);"),f.push("}");f.push("  if (dist > 0.0) { discard; }"),f.push("}")}"points"===s.primitiveName&&(f.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),f.push("float r = dot(cxy, cxy);"),f.push("if (r > 1.0) {"),f.push("   discard;"),f.push("}"));f.push("float occlusion = 1.0;"),a.ambient?f.push("vec3 ambientColor = materialAmbient;"):f.push("vec3 ambientColor = vec3(1.0, 1.0, 1.0);");a.diffuse?f.push("vec3 diffuseColor = materialDiffuse;"):a.baseColor?f.push("vec3 diffuseColor = materialBaseColor;"):f.push("vec3 diffuseColor = vec3(1.0, 1.0, 1.0);");s.colors&&f.push("diffuseColor *= vColor.rgb;");a.emissive?f.push("vec3 emissiveColor = materialEmissive;"):f.push("vec3  emissiveColor = vec3(0.0, 0.0, 0.0);");a.specular?f.push("vec3 specular = materialSpecular;"):f.push("vec3 specular = vec3(1.0, 1.0, 1.0);");void 0!==a.alpha?f.push("float alpha = materialAlphaModeCutoff[0];"):f.push("float alpha = 1.0;");s.colors&&f.push("alpha *= vColor.a;");void 0!==a.glossiness?f.push("float glossiness = materialGlossiness;"):f.push("float glossiness = 1.0;");void 0!==a.metallic?f.push("float metallic = materialMetallic;"):f.push("float metallic = 1.0;");void 0!==a.roughness?f.push("float roughness = materialRoughness;"):f.push("float roughness = 1.0;");void 0!==a.specularF0?f.push("float specularF0 = materialSpecularF0;"):f.push("float specularF0 = 1.0;");h&&(l&&i._normalMap||i._ambientMap||i._baseColorMap||i._diffuseMap||i._occlusionMap||i._emissiveMap||i._metallicMap||i._roughnessMap||i._metallicRoughnessMap||i._specularMap||i._glossinessMap||i._specularGlossinessMap||i._alphaMap)&&(f.push("vec4 texturePos = vec4(vUV.s, vUV.t, 1.0, 1.0);"),f.push("vec2 textureCoord;"));h&&i._ambientMap&&(i._ambientMap._state.matrix?f.push("textureCoord = (ambientMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 ambientTexel = texture2D(ambientMap, textureCoord).rgb;"),f.push("ambientTexel = "+je[i._ambientMap._state.encoding]+"(ambientTexel);"),f.push("ambientColor *= ambientTexel.rgb;"));h&&i._diffuseMap&&(i._diffuseMap._state.matrix?f.push("textureCoord = (diffuseMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 diffuseTexel = texture2D(diffuseMap, textureCoord);"),f.push("diffuseTexel = "+je[i._diffuseMap._state.encoding]+"(diffuseTexel);"),f.push("diffuseColor *= diffuseTexel.rgb;"),f.push("alpha *= diffuseTexel.a;"));h&&i._baseColorMap&&(i._baseColorMap._state.matrix?f.push("textureCoord = (baseColorMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 baseColorTexel = texture2D(baseColorMap, textureCoord);"),f.push("baseColorTexel = "+je[i._baseColorMap._state.encoding]+"(baseColorTexel);"),f.push("diffuseColor *= baseColorTexel.rgb;"),f.push("alpha *= baseColorTexel.a;"));h&&i._emissiveMap&&(i._emissiveMap._state.matrix?f.push("textureCoord = (emissiveMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 emissiveTexel = texture2D(emissiveMap, textureCoord);"),f.push("emissiveTexel = "+je[i._emissiveMap._state.encoding]+"(emissiveTexel);"),f.push("emissiveColor = emissiveTexel.rgb;"));h&&i._alphaMap&&(i._alphaMap._state.matrix?f.push("textureCoord = (alphaMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("alpha *= texture2D(alphaMap, textureCoord).r;"));h&&i._occlusionMap&&(i._occlusionMap._state.matrix?f.push("textureCoord = (occlusionMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("occlusion *= texture2D(occlusionMap, textureCoord).r;"));if(l&&(o.lights.length>0||o.lightMaps.length>0||o.reflectionMaps.length>0)){h&&i._normalMap?(i._normalMap._state.matrix?f.push("textureCoord = (normalMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec3 viewNormal = perturbNormal2Arb( vViewPosition, normalize(vViewNormal), textureCoord );")):f.push("vec3 viewNormal = normalize(vViewNormal);"),h&&i._specularMap&&(i._specularMap._state.matrix?f.push("textureCoord = (specularMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("specular *= texture2D(specularMap, textureCoord).rgb;")),h&&i._glossinessMap&&(i._glossinessMap._state.matrix?f.push("textureCoord = (glossinessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("glossiness *= texture2D(glossinessMap, textureCoord).r;")),h&&i._specularGlossinessMap&&(i._specularGlossinessMap._state.matrix?f.push("textureCoord = (materialSpecularGlossinessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec4 specGlossRGB = texture2D(materialSpecularGlossinessMap, textureCoord).rgba;"),f.push("specular *= specGlossRGB.rgb;"),f.push("glossiness *= specGlossRGB.a;")),h&&i._metallicMap&&(i._metallicMap._state.matrix?f.push("textureCoord = (metallicMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("metallic *= texture2D(metallicMap, textureCoord).r;")),h&&i._roughnessMap&&(i._roughnessMap._state.matrix?f.push("textureCoord = (roughnessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("roughness *= texture2D(roughnessMap, textureCoord).r;")),h&&i._metallicRoughnessMap&&(i._metallicRoughnessMap._state.matrix?f.push("textureCoord = (metallicRoughnessMapMatrix * texturePos).xy;"):f.push("textureCoord = texturePos.xy;"),f.push("vec3 metalRoughRGB = texture2D(metallicRoughnessMap, textureCoord).rgb;"),f.push("metallic *= metalRoughRGB.b;"),f.push("roughness *= metalRoughRGB.g;")),f.push("vec3 viewEyeDir = normalize(-vViewPosition);"),i._diffuseFresnel&&(f.push("float diffuseFresnel = fresnel(viewEyeDir, viewNormal, diffuseFresnelEdgeBias, diffuseFresnelCenterBias, diffuseFresnelPower);"),f.push("diffuseColor *= mix(diffuseFresnelEdgeColor, diffuseFresnelCenterColor, diffuseFresnel);")),i._specularFresnel&&(f.push("float specularFresnel = fresnel(viewEyeDir, viewNormal, specularFresnelEdgeBias, specularFresnelCenterBias, specularFresnelPower);"),f.push("specular *= mix(specularFresnelEdgeColor, specularFresnelCenterColor, specularFresnel);")),i._alphaFresnel&&(f.push("float alphaFresnel = fresnel(viewEyeDir, viewNormal, alphaFresnelEdgeBias, alphaFresnelCenterBias, alphaFresnelPower);"),f.push("alpha *= mix(alphaFresnelEdgeColor.r, alphaFresnelCenterColor.r, alphaFresnel);")),i._emissiveFresnel&&(f.push("float emissiveFresnel = fresnel(viewEyeDir, viewNormal, emissiveFresnelEdgeBias, emissiveFresnelCenterBias, emissiveFresnelPower);"),f.push("emissiveColor *= mix(emissiveFresnelEdgeColor, emissiveFresnelCenterColor, emissiveFresnel);")),f.push("if (materialAlphaModeCutoff[1] == 1.0 && alpha < materialAlphaModeCutoff[2]) {"),f.push("   discard;"),f.push("}"),f.push("IncidentLight  light;"),f.push("Material       material;"),f.push("Geometry       geometry;"),f.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),f.push("vec3           viewLightDir;"),c&&(f.push("material.diffuseColor      = diffuseColor;"),f.push("material.specularColor     = specular;"),f.push("material.shine             = materialShininess;")),d&&(f.push("float oneMinusSpecularStrength = 1.0 - max(max(specular.r, specular.g ),specular.b);"),f.push("material.diffuseColor      = diffuseColor * oneMinusSpecularStrength;"),f.push("material.specularRoughness = clamp( 1.0 - glossiness, 0.04, 1.0 );"),f.push("material.specularColor     = specular;")),u&&(f.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),f.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),f.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),f.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);")),f.push("geometry.position      = vViewPosition;"),o.lightMaps.length>0&&f.push("geometry.worldNormal   = normalize(vWorldNormal);"),f.push("geometry.viewNormal    = viewNormal;"),f.push("geometry.viewEyeDir    = viewEyeDir;"),c&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&f.push("computePhongLightMapping(geometry, material, reflectedLight);"),(d||u)&&(o.lightMaps.length>0||o.reflectionMaps.length>0)&&f.push("computePBRLightMapping(geometry, material, reflectedLight);"),f.push("float shadow = 1.0;"),f.push("float shadowAcneRemover = 0.007;"),f.push("vec3 fragmentDepth;"),f.push("float texelSize = 1.0 / 1024.0;"),f.push("float amountInLight = 0.0;"),f.push("vec3 shadowCoord;"),f.push("vec4 rgbaDepth;"),f.push("float depth;");for(let t=0,e=o.lights.length;t<e;t++){const e=o.lights[t];"ambient"!==e.type&&("dir"===e.type&&"view"===e.space?f.push("viewLightDir = -normalize(lightDir"+t+");"):"point"===e.type&&"view"===e.space?f.push("viewLightDir = normalize(lightPos"+t+" - vViewPosition);"):f.push("viewLightDir = normalize(vViewLightReverseDirAndDist"+t+".xyz);"),p&&e.castsShadow?(f.push("shadow = 0.0;"),f.push("fragmentDepth = vShadowPosFromLight"+t+".xyz;"),f.push("fragmentDepth.z -= shadowAcneRemover;"),f.push("for (int x = -3; x <= 3; x++) {"),f.push("  for (int y = -3; y <= 3; y++) {"),f.push("      float texelDepth = unpackDepth(texture2D(shadowMap"+t+", fragmentDepth.xy + vec2(x, y) * texelSize));"),f.push("      if (fragmentDepth.z < texelDepth) {"),f.push("          shadow += 1.0;"),f.push("      }"),f.push("  }"),f.push("}"),f.push("shadow = shadow / 9.0;"),f.push("light.color =  lightColor"+t+".rgb * (lightColor"+t+".a * shadow);")):f.push("light.color =  lightColor"+t+".rgb * (lightColor"+t+".a );"),f.push("light.direction = viewLightDir;"),c&&f.push("computePhongLighting(light, geometry, material, reflectedLight);"),(d||u)&&f.push("computePBRLighting(light, geometry, material, reflectedLight);"))}c?f.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * diffuseColor) + ((occlusion * (( reflectedLight.diffuse + reflectedLight.specular)))) + emissiveColor;"):f.push("vec3 outgoingLight = (occlusion * (reflectedLight.diffuse)) + (occlusion * reflectedLight.specular) + emissiveColor;")}else f.push("ambientColor *= (lightAmbient.rgb * lightAmbient.a);"),f.push("vec3 outgoingLight = emissiveColor + ambientColor;");f.push("gl_FragColor = vec4(outgoingLight, alpha) * colorize;"),_&&f.push("gl_FragColor = linearToGamma(gl_FragColor, gammaFactor);");e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&f.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return f.push("}"),f}(t))},je={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};function Xe(t){if(!t.receivesShadow)return!1;const e=t.scene._lightsState.lights;if(!e||0===e.length)return!1;for(let t=0,i=e.length;t<i;t++)if(e[t].castsShadow)return!0;return!1}function We(t){const e=t._geometry._state.primitiveName;return!(!t._geometry._state.autoVertexNormals&&!t._geometry._state.normalsBuf||"triangles"!==e&&"triangle-strip"!==e&&"triangle-fan"!==e)}const He=d.vec3(),Ye=new t({}),Ke=function(t,e){this.id=Ye.addItem({}),this._hash=t,this._scene=e.scene,this._useCount=0,this._shaderSource=new Ge(e),this._allocate(e)},qe={};Ke.get=function(t){const e=t.scene,i=[e.canvas.canvas.id,(e.gammaInput?"gi;":";")+(e.gammaOutput?"go":""),e._lightsState.getHash(),e._sectionPlanesState.getHash(),t._geometry._state.hash,t._material._state.hash,t._state.drawHash].join(";");let s=qe[i];if(!s){if(s=new Ke(i,t),s.errors)return console.log(s.errors.join("\n")),null;qe[i]=s,_.memory.programs++}return s._useCount++,s},Ke.prototype.put=function(){0==--this._useCount&&(Ye.removeItem(this.id),this._program&&this._program.destroy(),delete qe[this._hash],_.memory.programs--)},Ke.prototype.webglContextRestored=function(){this._program=null},Ke.prototype.drawMesh=function(t,e){this._program||this._allocate(e);const i=ht.MAX_TEXTURE_UNITS,s=e.scene,r=e._material,o=s.canvas.gl,a=this._program,n=e._state,l=e._material._state,h=e._geometry._state,c=s.camera,u=e.origin,d=n.background;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,d&&o.depthFunc(o.LEQUAL),this._bindProgram(t)),o.uniformMatrix4fv(this._uViewMatrix,!1,u?t.getRTCViewMatrix(n.originHash,u):c.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,c.viewNormalMatrix),n.clippable){const t=s._sectionPlanesState.sectionPlanes.length;if(t>0){const i=s._sectionPlanesState.sectionPlanes,r=e.renderFlags;for(let e=0;e<t;e++){const t=this._uSectionPlanes[e];if(t){const s=r.sectionPlanesActivePerLayer[e];if(o.uniform1i(t.active,s?1:0),s){const s=i[e];o.uniform3fv(t.pos,u?W(s.dist,s.dir,u,He):s.pos),o.uniform3fv(t.dir,s.dir)}}}}}if(l.id!==this._lastMaterialId){t.textureUnit=this._baseTextureUnit;const e=l.backfaces;t.backfaces!==e&&(e?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),t.backfaces=e);const s=l.frontface;switch(t.frontface!==s&&(s?o.frontFace(o.CCW):o.frontFace(o.CW),t.frontface=s),t.lineWidth!==l.lineWidth&&(o.lineWidth(l.lineWidth),t.lineWidth=l.lineWidth),this._uPointSize&&o.uniform1f(this._uPointSize,l.pointSize),l.type){case"LambertMaterial":this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialColor&&o.uniform4f(this._uMaterialColor,l.color[0],l.color[1],l.color[2],l.alpha),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive);break;case"PhongMaterial":this._uMaterialShininess&&o.uniform1f(this._uMaterialShininess,l.shininess),this._uMaterialAmbient&&o.uniform3fv(this._uMaterialAmbient,l.ambient),this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0),r._ambientMap&&r._ambientMap._state.texture&&this._uMaterialAmbientMap&&(a.bindTexture(this._uMaterialAmbientMap,r._ambientMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uMaterialAmbientMapMatrix&&o.uniformMatrix4fv(this._uMaterialAmbientMapMatrix,!1,r._ambientMap._state.matrix)),r._diffuseMap&&r._diffuseMap._state.texture&&this._uDiffuseMap&&(a.bindTexture(this._uDiffuseMap,r._diffuseMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,r._diffuseMap._state.matrix)),r._specularMap&&r._specularMap._state.texture&&this._uSpecularMap&&(a.bindTexture(this._uSpecularMap,r._specularMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,r._specularMap._state.matrix)),r._emissiveMap&&r._emissiveMap._state.texture&&this._uEmissiveMap&&(a.bindTexture(this._uEmissiveMap,r._emissiveMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,r._emissiveMap._state.matrix)),r._alphaMap&&r._alphaMap._state.texture&&this._uAlphaMap&&(a.bindTexture(this._uAlphaMap,r._alphaMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,r._alphaMap._state.matrix)),r._reflectivityMap&&r._reflectivityMap._state.texture&&this._uReflectivityMap&&(a.bindTexture(this._uReflectivityMap,r._reflectivityMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,this._uReflectivityMapMatrix&&o.uniformMatrix4fv(this._uReflectivityMapMatrix,!1,r._reflectivityMap._state.matrix)),r._normalMap&&r._normalMap._state.texture&&this._uNormalMap&&(a.bindTexture(this._uNormalMap,r._normalMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,r._normalMap._state.matrix)),r._occlusionMap&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(a.bindTexture(this._uOcclusionMap,r._occlusionMap._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,r._occlusionMap._state.matrix)),r._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias&&o.uniform1f(this._uDiffuseFresnelEdgeBias,r._diffuseFresnel.edgeBias),this._uDiffuseFresnelCenterBias&&o.uniform1f(this._uDiffuseFresnelCenterBias,r._diffuseFresnel.centerBias),this._uDiffuseFresnelEdgeColor&&o.uniform3fv(this._uDiffuseFresnelEdgeColor,r._diffuseFresnel.edgeColor),this._uDiffuseFresnelCenterColor&&o.uniform3fv(this._uDiffuseFresnelCenterColor,r._diffuseFresnel.centerColor),this._uDiffuseFresnelPower&&o.uniform1f(this._uDiffuseFresnelPower,r._diffuseFresnel.power)),r._specularFresnel&&(this._uSpecularFresnelEdgeBias&&o.uniform1f(this._uSpecularFresnelEdgeBias,r._specularFresnel.edgeBias),this._uSpecularFresnelCenterBias&&o.uniform1f(this._uSpecularFresnelCenterBias,r._specularFresnel.centerBias),this._uSpecularFresnelEdgeColor&&o.uniform3fv(this._uSpecularFresnelEdgeColor,r._specularFresnel.edgeColor),this._uSpecularFresnelCenterColor&&o.uniform3fv(this._uSpecularFresnelCenterColor,r._specularFresnel.centerColor),this._uSpecularFresnelPower&&o.uniform1f(this._uSpecularFresnelPower,r._specularFresnel.power)),r._alphaFresnel&&(this._uAlphaFresnelEdgeBias&&o.uniform1f(this._uAlphaFresnelEdgeBias,r._alphaFresnel.edgeBias),this._uAlphaFresnelCenterBias&&o.uniform1f(this._uAlphaFresnelCenterBias,r._alphaFresnel.centerBias),this._uAlphaFresnelEdgeColor&&o.uniform3fv(this._uAlphaFresnelEdgeColor,r._alphaFresnel.edgeColor),this._uAlphaFresnelCenterColor&&o.uniform3fv(this._uAlphaFresnelCenterColor,r._alphaFresnel.centerColor),this._uAlphaFresnelPower&&o.uniform1f(this._uAlphaFresnelPower,r._alphaFresnel.power)),r._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias&&o.uniform1f(this._uReflectivityFresnelEdgeBias,r._reflectivityFresnel.edgeBias),this._uReflectivityFresnelCenterBias&&o.uniform1f(this._uReflectivityFresnelCenterBias,r._reflectivityFresnel.centerBias),this._uReflectivityFresnelEdgeColor&&o.uniform3fv(this._uReflectivityFresnelEdgeColor,r._reflectivityFresnel.edgeColor),this._uReflectivityFresnelCenterColor&&o.uniform3fv(this._uReflectivityFresnelCenterColor,r._reflectivityFresnel.centerColor),this._uReflectivityFresnelPower&&o.uniform1f(this._uReflectivityFresnelPower,r._reflectivityFresnel.power)),r._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias&&o.uniform1f(this._uEmissiveFresnelEdgeBias,r._emissiveFresnel.edgeBias),this._uEmissiveFresnelCenterBias&&o.uniform1f(this._uEmissiveFresnelCenterBias,r._emissiveFresnel.centerBias),this._uEmissiveFresnelEdgeColor&&o.uniform3fv(this._uEmissiveFresnelEdgeColor,r._emissiveFresnel.edgeColor),this._uEmissiveFresnelCenterColor&&o.uniform3fv(this._uEmissiveFresnelCenterColor,r._emissiveFresnel.centerColor),this._uEmissiveFresnelPower&&o.uniform1f(this._uEmissiveFresnelPower,r._emissiveFresnel.power));break;case"MetallicMaterial":this._uBaseColor&&o.uniform3fv(this._uBaseColor,l.baseColor),this._uMaterialMetallic&&o.uniform1f(this._uMaterialMetallic,l.metallic),this._uMaterialRoughness&&o.uniform1f(this._uMaterialRoughness,l.roughness),this._uMaterialSpecularF0&&o.uniform1f(this._uMaterialSpecularF0,l.specularF0),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);const e=r._baseColorMap;e&&e._state.texture&&this._uBaseColorMap&&(a.bindTexture(this._uBaseColorMap,e._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uBaseColorMapMatrix&&o.uniformMatrix4fv(this._uBaseColorMapMatrix,!1,e._state.matrix));const s=r._metallicMap;s&&s._state.texture&&this._uMetallicMap&&(a.bindTexture(this._uMetallicMap,s._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uMetallicMapMatrix&&o.uniformMatrix4fv(this._uMetallicMapMatrix,!1,s._state.matrix));const n=r._roughnessMap;n&&n._state.texture&&this._uRoughnessMap&&(a.bindTexture(this._uRoughnessMap,n._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uRoughnessMapMatrix&&o.uniformMatrix4fv(this._uRoughnessMapMatrix,!1,n._state.matrix));const h=r._metallicRoughnessMap;h&&h._state.texture&&this._uMetallicRoughnessMap&&(a.bindTexture(this._uMetallicRoughnessMap,h._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uMetallicRoughnessMapMatrix&&o.uniformMatrix4fv(this._uMetallicRoughnessMapMatrix,!1,h._state.matrix)),(p=r._emissiveMap)&&p._state.texture&&this._uEmissiveMap&&(a.bindTexture(this._uEmissiveMap,p._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,p._state.matrix)),(_=r._occlusionMap)&&r._occlusionMap._state.texture&&this._uOcclusionMap&&(a.bindTexture(this._uOcclusionMap,_._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,_._state.matrix)),(f=r._alphaMap)&&f._state.texture&&this._uAlphaMap&&(a.bindTexture(this._uAlphaMap,f._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,f._state.matrix)),(g=r._normalMap)&&g._state.texture&&this._uNormalMap&&(a.bindTexture(this._uNormalMap,g._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,g._state.matrix));break;case"SpecularMaterial":this._uMaterialDiffuse&&o.uniform3fv(this._uMaterialDiffuse,l.diffuse),this._uMaterialSpecular&&o.uniform3fv(this._uMaterialSpecular,l.specular),this._uMaterialGlossiness&&o.uniform1f(this._uMaterialGlossiness,l.glossiness),this._uMaterialReflectivity&&o.uniform1f(this._uMaterialReflectivity,l.reflectivity),this._uMaterialEmissive&&o.uniform3fv(this._uMaterialEmissive,l.emissive),this._uAlphaModeCutoff&&o.uniform4f(this._uAlphaModeCutoff,1*l.alpha,1===l.alphaMode?1:0,l.alphaCutoff,0);const c=r._diffuseMap;c&&c._state.texture&&this._uDiffuseMap&&(a.bindTexture(this._uDiffuseMap,c._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uDiffuseMapMatrix&&o.uniformMatrix4fv(this._uDiffuseMapMatrix,!1,c._state.matrix));const u=r._specularMap;u&&u._state.texture&&this._uSpecularMap&&(a.bindTexture(this._uSpecularMap,u._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uSpecularMapMatrix&&o.uniformMatrix4fv(this._uSpecularMapMatrix,!1,u._state.matrix));const d=r._glossinessMap;d&&d._state.texture&&this._uGlossinessMap&&(a.bindTexture(this._uGlossinessMap,d._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uGlossinessMapMatrix&&o.uniformMatrix4fv(this._uGlossinessMapMatrix,!1,d._state.matrix));const m=r._specularGlossinessMap;var p,_,f,g;m&&m._state.texture&&this._uSpecularGlossinessMap&&(a.bindTexture(this._uSpecularGlossinessMap,m._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uSpecularGlossinessMapMatrix&&o.uniformMatrix4fv(this._uSpecularGlossinessMapMatrix,!1,m._state.matrix)),(p=r._emissiveMap)&&p._state.texture&&this._uEmissiveMap&&(a.bindTexture(this._uEmissiveMap,p._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uEmissiveMapMatrix&&o.uniformMatrix4fv(this._uEmissiveMapMatrix,!1,p._state.matrix)),(_=r._occlusionMap)&&_._state.texture&&this._uOcclusionMap&&(a.bindTexture(this._uOcclusionMap,_._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uOcclusionMapMatrix&&o.uniformMatrix4fv(this._uOcclusionMapMatrix,!1,_._state.matrix)),(f=r._alphaMap)&&f._state.texture&&this._uAlphaMap&&(a.bindTexture(this._uAlphaMap,f._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uAlphaMapMatrix&&o.uniformMatrix4fv(this._uAlphaMapMatrix,!1,f._state.matrix)),(g=r._normalMap)&&g._state.texture&&this._uNormalMap&&(a.bindTexture(this._uNormalMap,g._state.texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%i,t.bindTexture++,this._uNormalMapMatrix&&o.uniformMatrix4fv(this._uNormalMapMatrix,!1,g._state.matrix))}this._lastMaterialId=l.id}if(o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,e.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,n.clippable),this._uColorize){const t=n.colorize,e=this._lastColorize;e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]||(o.uniform4fv(this._uColorize,t),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3])}o.uniform3fv(this._uOffset,n.offset),h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,h.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf),t.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(h.normalsBuf),t.bindArray++),this._aUV&&(this._aUV.bindArrayBuffer(h.uvBuf),t.bindArray++),this._aColor&&(this._aColor.bindArrayBuffer(h.colorsBuf),t.bindArray++),this._aFlags&&(this._aFlags.bindArrayBuffer(h.flagsBuf),t.bindArray++),h.indicesBuf&&(h.indicesBuf.bind(),t.bindArray++),this._lastGeometryId=h.id),h.indicesBuf?(o.drawElements(h.primitive,h.indicesBuf.numItems,h.indicesBuf.itemType,0),t.drawElements++):h.positions&&(o.drawArrays(o.TRIANGLES,0,h.positions.numItems),t.drawArrays++),d&&o.depthFunc(o.LESS)},Ke.prototype._allocate=function(t){const e=t.scene,i=e.canvas.gl,s=t._material,r=e._lightsState,o=e._sectionPlanesState,a=t._material._state;if(this._program=new yt(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const n=this._program;this._uPositionsDecodeMatrix=n.getLocation("positionsDecodeMatrix"),this._uUVDecodeMatrix=n.getLocation("uvDecodeMatrix"),this._uModelMatrix=n.getLocation("modelMatrix"),this._uModelNormalMatrix=n.getLocation("modelNormalMatrix"),this._uViewMatrix=n.getLocation("viewMatrix"),this._uViewNormalMatrix=n.getLocation("viewNormalMatrix"),this._uProjMatrix=n.getLocation("projMatrix"),this._uGammaFactor=n.getLocation("gammaFactor"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[],this._uShadowViewMatrix=[],this._uShadowProjMatrix=[],e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=n.getLocation("logDepthBufFC"));const l=r.lights;let h;for(var c=0,u=l.length;c<u;c++){switch(h=l[c],h.type){case"ambient":this._uLightAmbient[c]=n.getLocation("lightAmbient");break;case"dir":this._uLightColor[c]=n.getLocation("lightColor"+c),this._uLightPos[c]=null,this._uLightDir[c]=n.getLocation("lightDir"+c);break;case"point":this._uLightColor[c]=n.getLocation("lightColor"+c),this._uLightPos[c]=n.getLocation("lightPos"+c),this._uLightDir[c]=null,this._uLightAttenuation[c]=n.getLocation("lightAttenuation"+c);break;case"spot":this._uLightColor[c]=n.getLocation("lightColor"+c),this._uLightPos[c]=n.getLocation("lightPos"+c),this._uLightDir[c]=n.getLocation("lightDir"+c),this._uLightAttenuation[c]=n.getLocation("lightAttenuation"+c)}h.castsShadow&&(this._uShadowViewMatrix[c]=n.getLocation("shadowViewMatrix"+c),this._uShadowProjMatrix[c]=n.getLocation("shadowProjMatrix"+c))}r.lightMaps.length>0&&(this._uLightMap="lightMap"),r.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),this._uSectionPlanes=[];for(c=0,u=o.sectionPlanes.length;c<u;c++)this._uSectionPlanes.push({active:n.getLocation("sectionPlaneActive"+c),pos:n.getLocation("sectionPlanePos"+c),dir:n.getLocation("sectionPlaneDir"+c)});switch(this._uPointSize=n.getLocation("pointSize"),a.type){case"LambertMaterial":this._uMaterialColor=n.getLocation("materialColor"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff");break;case"PhongMaterial":this._uMaterialAmbient=n.getLocation("materialAmbient"),this._uMaterialDiffuse=n.getLocation("materialDiffuse"),this._uMaterialSpecular=n.getLocation("materialSpecular"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),this._uMaterialShininess=n.getLocation("materialShininess"),s._ambientMap&&(this._uMaterialAmbientMap="ambientMap",this._uMaterialAmbientMapMatrix=n.getLocation("ambientMapMatrix")),s._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=n.getLocation("diffuseMapMatrix")),s._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=n.getLocation("specularMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),s._reflectivityMap&&(this._uReflectivityMap="reflectivityMap",this._uReflectivityMapMatrix=n.getLocation("reflectivityMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),s._diffuseFresnel&&(this._uDiffuseFresnelEdgeBias=n.getLocation("diffuseFresnelEdgeBias"),this._uDiffuseFresnelCenterBias=n.getLocation("diffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeColor=n.getLocation("diffuseFresnelEdgeColor"),this._uDiffuseFresnelCenterColor=n.getLocation("diffuseFresnelCenterColor"),this._uDiffuseFresnelPower=n.getLocation("diffuseFresnelPower")),s._specularFresnel&&(this._uSpecularFresnelEdgeBias=n.getLocation("specularFresnelEdgeBias"),this._uSpecularFresnelCenterBias=n.getLocation("specularFresnelCenterBias"),this._uSpecularFresnelEdgeColor=n.getLocation("specularFresnelEdgeColor"),this._uSpecularFresnelCenterColor=n.getLocation("specularFresnelCenterColor"),this._uSpecularFresnelPower=n.getLocation("specularFresnelPower")),s._alphaFresnel&&(this._uAlphaFresnelEdgeBias=n.getLocation("alphaFresnelEdgeBias"),this._uAlphaFresnelCenterBias=n.getLocation("alphaFresnelCenterBias"),this._uAlphaFresnelEdgeColor=n.getLocation("alphaFresnelEdgeColor"),this._uAlphaFresnelCenterColor=n.getLocation("alphaFresnelCenterColor"),this._uAlphaFresnelPower=n.getLocation("alphaFresnelPower")),s._reflectivityFresnel&&(this._uReflectivityFresnelEdgeBias=n.getLocation("reflectivityFresnelEdgeBias"),this._uReflectivityFresnelCenterBias=n.getLocation("reflectivityFresnelCenterBias"),this._uReflectivityFresnelEdgeColor=n.getLocation("reflectivityFresnelEdgeColor"),this._uReflectivityFresnelCenterColor=n.getLocation("reflectivityFresnelCenterColor"),this._uReflectivityFresnelPower=n.getLocation("reflectivityFresnelPower")),s._emissiveFresnel&&(this._uEmissiveFresnelEdgeBias=n.getLocation("emissiveFresnelEdgeBias"),this._uEmissiveFresnelCenterBias=n.getLocation("emissiveFresnelCenterBias"),this._uEmissiveFresnelEdgeColor=n.getLocation("emissiveFresnelEdgeColor"),this._uEmissiveFresnelCenterColor=n.getLocation("emissiveFresnelCenterColor"),this._uEmissiveFresnelPower=n.getLocation("emissiveFresnelPower"));break;case"MetallicMaterial":this._uBaseColor=n.getLocation("materialBaseColor"),this._uMaterialMetallic=n.getLocation("materialMetallic"),this._uMaterialRoughness=n.getLocation("materialRoughness"),this._uMaterialSpecularF0=n.getLocation("materialSpecularF0"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),s._baseColorMap&&(this._uBaseColorMap="baseColorMap",this._uBaseColorMapMatrix=n.getLocation("baseColorMapMatrix")),s._metallicMap&&(this._uMetallicMap="metallicMap",this._uMetallicMapMatrix=n.getLocation("metallicMapMatrix")),s._roughnessMap&&(this._uRoughnessMap="roughnessMap",this._uRoughnessMapMatrix=n.getLocation("roughnessMapMatrix")),s._metallicRoughnessMap&&(this._uMetallicRoughnessMap="metallicRoughnessMap",this._uMetallicRoughnessMapMatrix=n.getLocation("metallicRoughnessMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix"));break;case"SpecularMaterial":this._uMaterialDiffuse=n.getLocation("materialDiffuse"),this._uMaterialSpecular=n.getLocation("materialSpecular"),this._uMaterialGlossiness=n.getLocation("materialGlossiness"),this._uMaterialReflectivity=n.getLocation("reflectivityFresnel"),this._uMaterialEmissive=n.getLocation("materialEmissive"),this._uAlphaModeCutoff=n.getLocation("materialAlphaModeCutoff"),s._diffuseMap&&(this._uDiffuseMap="diffuseMap",this._uDiffuseMapMatrix=n.getLocation("diffuseMapMatrix")),s._specularMap&&(this._uSpecularMap="specularMap",this._uSpecularMapMatrix=n.getLocation("specularMapMatrix")),s._glossinessMap&&(this._uGlossinessMap="glossinessMap",this._uGlossinessMapMatrix=n.getLocation("glossinessMapMatrix")),s._specularGlossinessMap&&(this._uSpecularGlossinessMap="materialSpecularGlossinessMap",this._uSpecularGlossinessMapMatrix=n.getLocation("materialSpecularGlossinessMapMatrix")),s._emissiveMap&&(this._uEmissiveMap="emissiveMap",this._uEmissiveMapMatrix=n.getLocation("emissiveMapMatrix")),s._occlusionMap&&(this._uOcclusionMap="occlusionMap",this._uOcclusionMapMatrix=n.getLocation("occlusionMapMatrix")),s._alphaMap&&(this._uAlphaMap="alphaMap",this._uAlphaMapMatrix=n.getLocation("alphaMapMatrix")),s._normalMap&&(this._uNormalMap="normalMap",this._uNormalMapMatrix=n.getLocation("normalMapMatrix"))}this._aPosition=n.getAttribute("position"),this._aNormal=n.getAttribute("normal"),this._aUV=n.getAttribute("uv"),this._aColor=n.getAttribute("color"),this._aFlags=n.getAttribute("flags"),this._uClippable=n.getLocation("clippable"),this._uColorize=n.getLocation("colorize"),this._uOffset=n.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize=new Float32Array(4),this._baseTextureUnit=0},Ke.prototype._bindProgram=function(t){const e=ht.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,r=i._lightsState,o=i.camera.project;let a;const n=this._program;if(n.bind(),t.useProgram++,t.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastColorize[0]=-1,this._lastColorize[1]=-1,this._lastColorize[2]=-1,this._lastColorize[3]=-1,s.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),i.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}for(var l=0,h=r.lights.length;l<h;l++)if(a=r.lights[l],this._uLightAmbient[l])s.uniform4f(this._uLightAmbient[l],a.color[0],a.color[1],a.color[2],a.intensity);else if(this._uLightColor[l]&&s.uniform4f(this._uLightColor[l],a.color[0],a.color[1],a.color[2],a.intensity),this._uLightPos[l]&&(s.uniform3fv(this._uLightPos[l],a.pos),this._uLightAttenuation[l]&&s.uniform1f(this._uLightAttenuation[l],a.attenuation)),this._uLightDir[l]&&s.uniform3fv(this._uLightDir[l],a.dir),a.castsShadow){this._uShadowViewMatrix[l]&&s.uniformMatrix4fv(this._uShadowViewMatrix[l],!1,a.getShadowViewMatrix()),this._uShadowProjMatrix[l]&&s.uniformMatrix4fv(this._uShadowProjMatrix[l],!1,a.getShadowProjMatrix());const i=a.getShadowRenderBuf();i&&(n.bindTexture("shadowMap"+l,i.getTexture(),t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++)}r.lightMaps.length>0&&r.lightMaps[0].texture&&this._uLightMap&&(n.bindTexture(this._uLightMap,r.lightMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),r.reflectionMaps.length>0&&r.reflectionMaps[0].texture&&this._uReflectionMap&&(n.bindTexture(this._uReflectionMap,r.reflectionMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor),this._baseTextureUnit=t.textureUnit};class Ze{constructor(t){this.vertex=function(t){const e=t.scene,i=e._lightsState,s=function(t){const e=t._geometry._state.primitiveName;if((t._geometry._state.autoVertexNormals||t._geometry._state.normalsBuf)&&("triangles"===e||"triangle-strip"===e||"triangle-fan"===e))return!0;return!1}(t),r=e._sectionPlanesState.sectionPlanes.length>0,o=!!t._geometry._state.compressGeometry,a=t._state.billboard,n=t._state.stationary,l=[];l.push("// EmphasisFillShaderSource vertex shader"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&l.push("#extension GL_EXT_frag_depth : enable");l.push("attribute vec3 position;"),l.push("uniform mat4 modelMatrix;"),l.push("uniform mat4 viewMatrix;"),l.push("uniform mat4 projMatrix;"),l.push("uniform vec4 colorize;"),l.push("uniform vec3 offset;"),o&&l.push("uniform mat4 positionsDecodeMatrix;");e.logarithmicDepthBufferEnabled&&(l.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&l.push("varying float vFragDepth;"),l.push("bool isPerspectiveMatrix(mat4 m) {"),l.push("    return (m[2][3] == - 1.0);"),l.push("}"),l.push("varying float isPerspective;"));r&&l.push("varying vec4 vWorldPosition;");if(l.push("uniform vec4   lightAmbient;"),l.push("uniform vec4   fillColor;"),s){l.push("attribute vec3 normal;"),l.push("uniform mat4 modelNormalMatrix;"),l.push("uniform mat4 viewNormalMatrix;");for(let t=0,e=i.lights.length;t<e;t++){const e=i.lights[t];"ambient"!==e.type&&(l.push("uniform vec4 lightColor"+t+";"),"dir"===e.type&&l.push("uniform vec3 lightDir"+t+";"),"point"===e.type&&l.push("uniform vec3 lightPos"+t+";"),"spot"===e.type&&l.push("uniform vec3 lightPos"+t+";"))}o&&(l.push("vec3 octDecode(vec2 oct) {"),l.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),l.push("    if (v.z < 0.0) {"),l.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),l.push("    }"),l.push("    return normalize(v);"),l.push("}"))}l.push("varying vec4 vColor;"),("spherical"===a||"cylindrical"===a)&&(l.push("void billboard(inout mat4 mat) {"),l.push("   mat[0][0] = 1.0;"),l.push("   mat[0][1] = 0.0;"),l.push("   mat[0][2] = 0.0;"),"spherical"===a&&(l.push("   mat[1][0] = 0.0;"),l.push("   mat[1][1] = 1.0;"),l.push("   mat[1][2] = 0.0;")),l.push("   mat[2][0] = 0.0;"),l.push("   mat[2][1] = 0.0;"),l.push("   mat[2][2] =1.0;"),l.push("}"));l.push("void main(void) {"),l.push("vec4 localPosition = vec4(position, 1.0); "),l.push("vec4 worldPosition;"),o&&l.push("localPosition = positionsDecodeMatrix * localPosition;");s&&(o?l.push("vec4 localNormal = vec4(octDecode(normal.xy), 0.0); "):l.push("vec4 localNormal = vec4(normal, 0.0); "),l.push("mat4 modelNormalMatrix2 = modelNormalMatrix;"),l.push("mat4 viewNormalMatrix2 = viewNormalMatrix;"));l.push("mat4 viewMatrix2 = viewMatrix;"),l.push("mat4 modelMatrix2 = modelMatrix;"),n&&l.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===a||"cylindrical"===a?(l.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),l.push("billboard(modelMatrix2);"),l.push("billboard(viewMatrix2);"),l.push("billboard(modelViewMatrix);"),s&&(l.push("mat4 modelViewNormalMatrix =  viewNormalMatrix2 * modelNormalMatrix2;"),l.push("billboard(modelNormalMatrix2);"),l.push("billboard(viewNormalMatrix2);"),l.push("billboard(modelViewNormalMatrix);")),l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(l.push("worldPosition = modelMatrix2 * localPosition;"),l.push("worldPosition.xyz = worldPosition.xyz + offset;"),l.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));s&&l.push("vec3 viewNormal = normalize((viewNormalMatrix2 * modelNormalMatrix2 * localNormal).xyz);");if(l.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),l.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),l.push("float lambertian = 1.0;"),s)for(let t=0,e=i.lights.length;t<e;t++){const e=i.lights[t];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?l.push("viewLightDir = normalize(lightDir"+t+");"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightDir"+t+", 0.0)).xyz);");else{if("point"!==e.type)continue;"view"===e.space?l.push("viewLightDir = normalize(lightPos"+t+" - viewPosition.xyz);"):l.push("viewLightDir = normalize((viewMatrix2 * vec4(lightPos"+t+", 0.0)).xyz);")}l.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),l.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}}l.push("vColor = vec4(reflectedColor * fillColor.rgb, fillColor.a);"),r&&l.push("vWorldPosition = worldPosition;");"points"===t._geometry._state.primitiveName&&l.push("gl_PointSize = pointSize;");l.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?l.push("vFragDepth = 1.0 + clipPos.w;"):(l.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),l.push("clipPos.z *= clipPos.w;")),l.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return l.push("gl_Position = clipPos;"),l.push("}"),l}(t),this.fragment=function(t){const e=t.scene,i=t.scene._sectionPlanesState,s=t.scene.gammaOutput,r=i.sectionPlanes.length>0,o=[];o.push("// Lambertian drawing fragment shader"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable");o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("varying float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;"));s&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(r){o.push("varying vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)o.push("uniform bool sectionPlaneActive"+t+";"),o.push("uniform vec3 sectionPlanePos"+t+";"),o.push("uniform vec3 sectionPlaneDir"+t+";")}if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),r){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)o.push("if (sectionPlaneActive"+t+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}"points"===t._geometry._state.primitiveName&&(o.push("vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("float r = dot(cxy, cxy);"),o.push("if (r > 1.0) {"),o.push("   discard;"),o.push("}"));e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");s?o.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):o.push("gl_FragColor = vColor;");return o.push("}"),o}(t)}}const Qe=new t({}),$e=d.vec3(),Je=function(t,e){this.id=Qe.addItem({}),this._hash=t,this._scene=e.scene,this._useCount=0,this._shaderSource=new Ze(e),this._allocate(e)},ti={};Je.get=function(t){const e=[t.scene.id,t.scene.gammaOutput?"go":"",t.scene._sectionPlanesState.getHash(),t._geometry._state.normalsBuf?"n":"",t._geometry._state.compressGeometry?"cp":"",t._state.hash].join(";");let i=ti[e];return i||(i=new Je(e,t),ti[e]=i,_.memory.programs++),i._useCount++,i},Je.prototype.put=function(){0==--this._useCount&&(Qe.removeItem(this.id),this._program&&this._program.destroy(),delete ti[this._hash],_.memory.programs--)},Je.prototype.webglContextRestored=function(){this._program=null},Je.prototype.drawMesh=function(t,e,i){this._program||this._allocate(e);const s=this._scene,r=s.camera,o=s.canvas.gl,a=0===i?e._xrayMaterial._state:1===i?e._highlightMaterial._state:e._selectedMaterial._state,n=e._state,l=e._geometry._state,h=e.origin;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),o.uniformMatrix4fv(this._uViewMatrix,!1,h?t.getRTCViewMatrix(n.originHash,h):r.viewMatrix),o.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.viewNormalMatrix),n.clippable){const t=s._sectionPlanesState.sectionPlanes.length;if(t>0){const i=s._sectionPlanesState.sectionPlanes,r=e.renderFlags;for(let e=0;e<t;e++){const t=this._uSectionPlanes[e];if(t){const s=r.sectionPlanesActivePerLayer[e];if(o.uniform1i(t.active,s?1:0),s){const s=i[e];o.uniform3fv(t.pos,h?W(s.dist,s.dir,h,$e):s.pos),o.uniform3fv(t.dir,s.dir)}}}}}if(a.id!==this._lastMaterialId){const e=a.fillColor,i=a.backfaces;t.backfaces!==i&&(i?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),t.backfaces=i),o.uniform4f(this._uFillColor,e[0],e[1],e[2],a.fillAlpha),this._lastMaterialId=a.id}o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uModelNormalMatrix&&o.uniformMatrix4fv(this._uModelNormalMatrix,o.FALSE,e.worldNormalMatrix),this._uClippable&&o.uniform1i(this._uClippable,n.clippable),o.uniform3fv(this._uOffset,n.offset),l.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,l.positionsDecodeMatrix),this._uUVDecodeMatrix&&o.uniformMatrix3fv(this._uUVDecodeMatrix,!1,l.uvDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(l.positionsBuf),t.bindArray++),this._aNormal&&(this._aNormal.bindArrayBuffer(l.normalsBuf),t.bindArray++),l.indicesBuf?(l.indicesBuf.bind(),t.bindArray++):l.positionsBuf,this._lastGeometryId=l.id),l.indicesBuf?(o.drawElements(l.primitive,l.indicesBuf.numItems,l.indicesBuf.itemType,0),t.drawElements++):l.positionsBuf&&(o.drawArrays(o.TRIANGLES,0,l.positionsBuf.numItems),t.drawArrays++)},Je.prototype._allocate=function(t){const e=t.scene,i=e._lightsState,s=e._sectionPlanesState,r=e.canvas.gl;if(this._program=new yt(r,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const o=this._program;this._uPositionsDecodeMatrix=o.getLocation("positionsDecodeMatrix"),this._uModelMatrix=o.getLocation("modelMatrix"),this._uModelNormalMatrix=o.getLocation("modelNormalMatrix"),this._uViewMatrix=o.getLocation("viewMatrix"),this._uViewNormalMatrix=o.getLocation("viewNormalMatrix"),this._uProjMatrix=o.getLocation("projMatrix"),this._uLightAmbient=[],this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];for(let t=0,e=i.lights.length;t<e;t++){switch(i.lights[t].type){case"ambient":this._uLightAmbient[t]=o.getLocation("lightAmbient");break;case"dir":this._uLightColor[t]=o.getLocation("lightColor"+t),this._uLightPos[t]=null,this._uLightDir[t]=o.getLocation("lightDir"+t);break;case"point":this._uLightColor[t]=o.getLocation("lightColor"+t),this._uLightPos[t]=o.getLocation("lightPos"+t),this._uLightDir[t]=null,this._uLightAttenuation[t]=o.getLocation("lightAttenuation"+t)}}this._uSectionPlanes=[];for(let t=0,e=s.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:o.getLocation("sectionPlaneActive"+t),pos:o.getLocation("sectionPlanePos"+t),dir:o.getLocation("sectionPlaneDir"+t)});this._uFillColor=o.getLocation("fillColor"),this._aPosition=o.getAttribute("position"),this._aNormal=o.getAttribute("normal"),this._uClippable=o.getLocation("clippable"),this._uGammaFactor=o.getLocation("gammaFactor"),this._uOffset=o.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=o.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},Je.prototype._bindProgram=function(t){const e=this._scene,i=e.canvas.gl,s=e._lightsState,r=e.camera,o=r.project;if(this._program.bind(),t.useProgram++,t.textureUnit=0,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,this._lastIndicesBufId=null,i.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.normalMatrix),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),e.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];this._uLightAmbient[t]?i.uniform4f(this._uLightAmbient[t],e.color[0],e.color[1],e.color[2],e.intensity):(this._uLightColor[t]&&i.uniform4f(this._uLightColor[t],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[t]&&(i.uniform3fv(this._uLightPos[t],e.pos),this._uLightAttenuation[t]&&i.uniform1f(this._uLightAttenuation[t],e.attenuation)),this._uLightDir[t]&&i.uniform3fv(this._uLightDir[t],e.dir))}this._uGammaFactor&&i.uniform1f(this._uGammaFactor,e.gammaFactor)};class ei{constructor(t){this.vertex=function(t){const e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,s=!!t._geometry._state.compressGeometry,r=t._state.billboard,o=t._state.stationary,a=[];a.push("// Edges drawing vertex shader"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec4 edgeColor;"),a.push("uniform vec3 offset;"),s&&a.push("uniform mat4 positionsDecodeMatrix;");e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("varying float isPerspective;"));i&&a.push("varying vec4 vWorldPosition;");a.push("varying vec4 vColor;"),("spherical"===r||"cylindrical"===r)&&(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===r&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),s&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),o&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));a.push("vColor = edgeColor;"),i&&a.push("vWorldPosition = worldPosition;");a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;")),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return a.push("gl_Position = clipPos;"),a.push("}"),a}(t),this.fragment=function(t){const e=t.scene,i=t.scene._sectionPlanesState,s=t.scene.gammaOutput,r=i.sectionPlanes.length>0,o=[];o.push("// Edges drawing fragment shader"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable");o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("varying float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;"));s&&(o.push("uniform float gammaFactor;"),o.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),o.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),o.push("}"));if(r){o.push("varying vec4 vWorldPosition;"),o.push("uniform bool clippable;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)o.push("uniform bool sectionPlaneActive"+t+";"),o.push("uniform vec3 sectionPlanePos"+t+";"),o.push("uniform vec3 sectionPlaneDir"+t+";")}if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),r){o.push("if (clippable) {"),o.push("  float dist = 0.0;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)o.push("if (sectionPlaneActive"+t+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");s?o.push("gl_FragColor = linearToGamma(vColor, gammaFactor);"):o.push("gl_FragColor = vColor;");return o.push("}"),o}(t)}}const ii=new t({}),si=d.vec3(),ri=function(t,e){this.id=ii.addItem({}),this._hash=t,this._scene=e.scene,this._useCount=0,this._shaderSource=new ei(e),this._allocate(e)},oi={};ri.get=function(t){const e=[t.scene.id,t.scene.gammaOutput?"go":"",t.scene._sectionPlanesState.getHash(),t._geometry._state.compressGeometry?"cp":"",t._state.hash].join(";");let i=oi[e];return i||(i=new ri(e,t),oi[e]=i,_.memory.programs++),i._useCount++,i},ri.prototype.put=function(){0==--this._useCount&&(ii.removeItem(this.id),this._program&&this._program.destroy(),delete oi[this._hash],_.memory.programs--)},ri.prototype.webglContextRestored=function(){this._program=null},ri.prototype.drawMesh=function(t,e,i){this._program||this._allocate(e);const s=this._scene,r=s.camera,o=s.canvas.gl;let a;const n=e._state,l=e._geometry,h=l._state,c=e.origin;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),o.uniformMatrix4fv(this._uViewMatrix,!1,c?t.getRTCViewMatrix(n.originHash,c):r.viewMatrix),n.clippable){const t=s._sectionPlanesState.sectionPlanes.length;if(t>0){const i=s._sectionPlanesState.sectionPlanes,r=e.renderFlags;for(let e=0;e<t;e++){const t=this._uSectionPlanes[e];if(t){const s=r.sectionPlanesActivePerLayer[e];if(o.uniform1i(t.active,s?1:0),s){const s=i[e];o.uniform3fv(t.pos,c?W(s.dist,s.dir,c,si):s.pos),o.uniform3fv(t.dir,s.dir)}}}}}switch(i){case 0:a=e._xrayMaterial._state;break;case 1:a=e._highlightMaterial._state;break;case 2:a=e._selectedMaterial._state;break;default:a=e._edgeMaterial._state}if(a.id!==this._lastMaterialId){const e=a.backfaces;if(t.backfaces!==e&&(e?o.disable(o.CULL_FACE):o.enable(o.CULL_FACE),t.backfaces=e),t.lineWidth!==a.edgeWidth&&(o.lineWidth(a.edgeWidth),t.lineWidth=a.edgeWidth),this._uEdgeColor){const t=a.edgeColor,e=a.edgeAlpha;o.uniform4f(this._uEdgeColor,t[0],t[1],t[2],e)}this._lastMaterialId=a.id}let u;o.uniformMatrix4fv(this._uModelMatrix,o.FALSE,e.worldMatrix),this._uClippable&&o.uniform1i(this._uClippable,n.clippable),o.uniform3fv(this._uOffset,n.offset),h.primitive===o.TRIANGLES?u=l._getEdgeIndices():h.primitive===o.LINES&&(u=h.indicesBuf),u&&(h.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,h.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(h.positionsBuf,h.compressGeometry?o.UNSIGNED_SHORT:o.FLOAT),t.bindArray++),u.bind(),t.bindArray++,this._lastGeometryId=h.id),o.drawElements(o.LINES,u.numItems,u.itemType,0),t.drawElements++)},ri.prototype._allocate=function(t){const e=t.scene,i=e.canvas.gl,s=e._sectionPlanesState;if(this._program=new yt(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const r=this._program;this._uPositionsDecodeMatrix=r.getLocation("positionsDecodeMatrix"),this._uModelMatrix=r.getLocation("modelMatrix"),this._uViewMatrix=r.getLocation("viewMatrix"),this._uProjMatrix=r.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=s.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:r.getLocation("sectionPlaneActive"+t),pos:r.getLocation("sectionPlanePos"+t),dir:r.getLocation("sectionPlaneDir"+t)});this._uEdgeColor=r.getLocation("edgeColor"),this._aPosition=r.getAttribute("position"),this._uClippable=r.getLocation("clippable"),this._uGammaFactor=r.getLocation("gammaFactor"),this._uOffset=r.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=r.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},ri.prototype._bindProgram=function(t){const e=this._program,i=this._scene,s=i.canvas.gl,r=i.camera.project;if(e.bind(),t.useProgram++,this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),i.logarithmicDepthBufferEnabled){const t=2/(Math.log(r.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)};class ai{constructor(t){this.vertex=function(t){const e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,s=!!t._geometry._state.compressGeometry,r=t._state.billboard,o=t._state.stationary,a=[];a.push("// Mesh picking vertex shader"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("varying vec4 vViewPosition;"),a.push("uniform vec3 offset;"),s&&a.push("uniform mat4 positionsDecodeMatrix;");i&&a.push("varying vec4 vWorldPosition;");e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("varying float isPerspective;"));"spherical"!==r&&"cylindrical"!==r||(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===r&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),s&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),o&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"!==r&&"cylindrical"!==r||(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"));a.push("   vec4 worldPosition = modelMatrix2 * localPosition;"),a.push("   worldPosition.xyz = worldPosition.xyz + offset;"),a.push("   vec4 viewPosition = viewMatrix2 * worldPosition;"),i&&a.push("   vWorldPosition = worldPosition;");a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;")),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return a.push("gl_Position = clipPos;"),a.push("}"),a}(t),this.fragment=function(t){const e=t.scene,i=e._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];r.push("// Mesh picking fragment shader"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable");r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;"));if(r.push("uniform vec4 pickColor;"),s){r.push("uniform bool clippable;"),r.push("varying vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";")}if(r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<i.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("   gl_FragColor = pickColor; "),r.push("}"),r}(t)}}const ni=d.vec3(),li=function(t,e){this._hash=t,this._shaderSource=new ai(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},hi={};li.get=function(t){const e=[t.scene.canvas.canvas.id,t.scene._sectionPlanesState.getHash(),t._geometry._state.hash,t._state.hash].join(";");let i=hi[e];if(!i){if(i=new li(e,t),i.errors)return console.log(i.errors.join("\n")),null;hi[e]=i,_.memory.programs++}return i._useCount++,i},li.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete hi[this._hash],_.memory.programs--)},li.prototype.webglContextRestored=function(){this._program=null},li.prototype.drawMesh=function(t,e){this._program||this._allocate(e);const i=this._scene,s=i.canvas.gl,r=e._state,o=e._material._state,a=e._geometry._state,n=e.origin;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),s.uniformMatrix4fv(this._uViewMatrix,!1,n?t.getRTCPickViewMatrix(r.originHash,n):t.pickViewMatrix),r.clippable){const t=i._sectionPlanesState.sectionPlanes.length;if(t>0){const r=i._sectionPlanesState.sectionPlanes,o=e.renderFlags;for(let e=0;e<t;e++){const t=this._uSectionPlanes[e];if(t){const i=o.sectionPlanesActivePerLayer[e];if(s.uniform1i(t.active,i?1:0),i){const i=r[e];s.uniform3fv(t.pos,n?W(i.dist,i.dir,n,ni):i.pos),s.uniform3fv(t.dir,i.dir)}}}}}if(o.id!==this._lastMaterialId){const e=o.backfaces;t.backfaces!==e&&(e?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),t.backfaces=e);const i=o.frontface;t.frontface!==i&&(i?s.frontFace(s.CCW):s.frontFace(s.CW),t.frontface=i),this._lastMaterialId=o.id}s.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),s.uniformMatrix4fv(this._uModelMatrix,!1,e.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,e._state.clippable),s.uniform3fv(this._uOffset,e._state.offset),a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),t.bindArray++),a.indicesBuf&&(a.indicesBuf.bind(),t.bindArray++),this._lastGeometryId=a.id);var l=e._state.pickID;const h=l>>24&255,c=l>>16&255,u=l>>8&255,d=255&l;s.uniform4f(this._uPickColor,d/255,u/255,c/255,h/255),a.indicesBuf?(s.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),t.drawElements++):a.positions&&s.drawArrays(s.TRIANGLES,0,a.positions.numItems)},li.prototype._allocate=function(t){const e=t.scene,i=e.canvas.gl;if(this._program=new yt(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uPickColor=s.getLocation("pickColor"),this._uOffset=s.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastGeometryId=null},li.prototype._bindProgram=function(t){const e=this._scene,i=e.canvas.gl,s=e.camera.project;if(this._program.bind(),t.useProgram++,e.logarithmicDepthBufferEnabled){const t=2/(Math.log(s.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}this._lastMaterialId=null,this._lastGeometryId=null};class ci{constructor(t){this.vertex=function(t){const e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,s=!!t._geometry._state.compressGeometry;t._state.billboard,t._state.stationary;const r=[];r.push("// Surface picking vertex shader"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable");r.push("attribute vec3 position;"),r.push("attribute vec4 color;"),r.push("uniform mat4 modelMatrix;"),r.push("uniform mat4 viewMatrix;"),r.push("uniform mat4 projMatrix;"),r.push("uniform vec3 offset;"),i&&(r.push("uniform bool clippable;"),r.push("varying vec4 vWorldPosition;"));e.logarithmicDepthBufferEnabled&&(r.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("varying float vFragDepth;"),r.push("bool isPerspectiveMatrix(mat4 m) {"),r.push("    return (m[2][3] == - 1.0);"),r.push("}"),r.push("varying float isPerspective;"));r.push("varying vec4 vColor;"),s&&r.push("uniform mat4 positionsDecodeMatrix;");r.push("void main(void) {"),r.push("vec4 localPosition = vec4(position, 1.0); "),s&&r.push("localPosition = positionsDecodeMatrix * localPosition;");r.push("   vec4 worldPosition = modelMatrix * localPosition; "),r.push("   worldPosition.xyz = worldPosition.xyz + offset;"),r.push("   vec4 viewPosition = viewMatrix * worldPosition;"),i&&r.push("   vWorldPosition = worldPosition;");r.push("   vColor = color;"),r.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?r.push("vFragDepth = 1.0 + clipPos.w;"):(r.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),r.push("clipPos.z *= clipPos.w;")),r.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return r.push("gl_Position = clipPos;"),r.push("}"),r}(t),this.fragment=function(t){const e=t.scene,i=e._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];r.push("// Surface picking fragment shader"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable");r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),r.push("varying vec4 vColor;"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;"));if(s){r.push("uniform bool clippable;"),r.push("varying vec4 vWorldPosition;");for(let t=0;t<i.sectionPlanes.length;t++)r.push("uniform bool sectionPlaneActive"+t+";"),r.push("uniform vec3 sectionPlanePos"+t+";"),r.push("uniform vec3 sectionPlaneDir"+t+";")}if(r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(let t=0;t<i.sectionPlanes.length;t++)r.push("if (sectionPlaneActive"+t+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("   gl_FragColor = vColor;"),r.push("}"),r}(t)}}const ui=d.vec3(),di=function(t,e){this._hash=t,this._scene=e.scene,this._useCount=0,this._shaderSource=new ci(e),this._allocate(e)},pi={};di.get=function(t){const e=[t.scene.canvas.canvas.id,t.scene._sectionPlanesState.getHash(),t._geometry._state.compressGeometry?"cp":"",t._state.hash].join(";");let i=pi[e];if(!i){if(i=new di(e,t),i.errors)return console.log(i.errors.join("\n")),null;pi[e]=i,_.memory.programs++}return i._useCount++,i},di.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete pi[this._hash],_.memory.programs--)},di.prototype.webglContextRestored=function(){this._program=null},di.prototype.drawMesh=function(t,e){this._program||this._allocate(e);const i=this._scene,s=i.canvas.gl,r=e._state,o=e._material._state,a=e._geometry,n=e._geometry._state,l=e.origin,h=o.backfaces,c=o.frontface,u=i.camera.project,d=a._getPickTrianglePositions(),p=a._getPickTriangleColors();if(this._program.bind(),t.useProgram++,i.logarithmicDepthBufferEnabled){const t=2/(Math.log(u.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}if(s.uniformMatrix4fv(this._uViewMatrix,!1,l?t.getRTCPickViewMatrix(r.originHash,l):t.pickViewMatrix),r.clippable){const t=i._sectionPlanesState.sectionPlanes.length;if(t>0){const r=i._sectionPlanesState.sectionPlanes,o=e.renderFlags;for(let e=0;e<t;e++){const t=this._uSectionPlanes[e];if(t){const i=o.sectionPlanesActivePerLayer[e];if(s.uniform1i(t.active,i?1:0),i){const i=r[e];s.uniform3fv(t.pos,l?W(i.dist,i.dir,l,ui):i.pos),s.uniform3fv(t.dir,i.dir)}}}}}s.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),i.logarithmicDepthBufferEnabled&&s.uniform1f(this._uZFar,i.camera.project.far),t.backfaces!==h&&(h?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),t.backfaces=h),t.frontface!==c&&(c?s.frontFace(s.CCW):s.frontFace(s.CW),t.frontface=c),s.uniformMatrix4fv(this._uModelMatrix,!1,e.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,e._state.clippable),s.uniform3fv(this._uOffset,e._state.offset),this._uPositionsDecodeMatrix?(s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,n.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(d,n.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT)):this._aPosition.bindArrayBuffer(d),p.bind(),s.enableVertexAttribArray(this._aColor.location),s.vertexAttribPointer(this._aColor.location,p.itemSize,p.itemType,!0,0,0),s.drawArrays(n.primitive,0,d.numItems/3)},di.prototype._allocate=function(t){const e=t.scene,i=e.canvas.gl;if(this._program=new yt(i,this._shaderSource),this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))};class _i{constructor(t){this.vertex=function(t){const e=t.scene,i=e._sectionPlanesState.sectionPlanes.length>0,s=!!t._geometry._state.compressGeometry,r=t._state.billboard,o=t._state.stationary,a=[];a.push("// Mesh occlusion vertex shader"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable");a.push("attribute vec3 position;"),a.push("uniform mat4 modelMatrix;"),a.push("uniform mat4 viewMatrix;"),a.push("uniform mat4 projMatrix;"),a.push("uniform vec3 offset;"),s&&a.push("uniform mat4 positionsDecodeMatrix;");i&&a.push("varying vec4 vWorldPosition;");e.logarithmicDepthBufferEnabled&&(a.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("varying float vFragDepth;"),a.push("bool isPerspectiveMatrix(mat4 m) {"),a.push("    return (m[2][3] == - 1.0);"),a.push("}"),a.push("varying float isPerspective;"));"spherical"!==r&&"cylindrical"!==r||(a.push("void billboard(inout mat4 mat) {"),a.push("   mat[0][0] = 1.0;"),a.push("   mat[0][1] = 0.0;"),a.push("   mat[0][2] = 0.0;"),"spherical"===r&&(a.push("   mat[1][0] = 0.0;"),a.push("   mat[1][1] = 1.0;"),a.push("   mat[1][2] = 0.0;")),a.push("   mat[2][0] = 0.0;"),a.push("   mat[2][1] = 0.0;"),a.push("   mat[2][2] =1.0;"),a.push("}"));a.push("void main(void) {"),a.push("vec4 localPosition = vec4(position, 1.0); "),a.push("vec4 worldPosition;"),s&&a.push("localPosition = positionsDecodeMatrix * localPosition;");a.push("mat4 viewMatrix2 = viewMatrix;"),a.push("mat4 modelMatrix2 = modelMatrix;"),o&&a.push("viewMatrix2[3][0] = viewMatrix2[3][1] = viewMatrix2[3][2] = 0.0;");"spherical"===r||"cylindrical"===r?(a.push("mat4 modelViewMatrix = viewMatrix2 * modelMatrix2;"),a.push("billboard(modelMatrix2);"),a.push("billboard(viewMatrix2);"),a.push("billboard(modelViewMatrix);"),a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition = modelViewMatrix * localPosition;")):(a.push("worldPosition = modelMatrix2 * localPosition;"),a.push("worldPosition.xyz = worldPosition.xyz + offset;"),a.push("vec4 viewPosition  = viewMatrix2 * worldPosition; "));i&&a.push("   vWorldPosition = worldPosition;");a.push("vec4 clipPos = projMatrix * viewPosition;"),e.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?a.push("vFragDepth = 1.0 + clipPos.w;"):(a.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),a.push("clipPos.z *= clipPos.w;")),a.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"));return a.push("gl_Position = clipPos;"),a.push("}"),a}(t),this.fragment=function(t){const e=t.scene,i=e._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];r.push("// Mesh occlusion fragment shader"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable");r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;"));if(s){r.push("uniform bool clippable;"),r.push("varying vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";")}if(r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<i.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}r.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),e.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;");return r.push("}"),r}(t)}}const fi=d.vec3(),gi=function(t,e){this._hash=t,this._shaderSource=new _i(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},mi={};gi.get=function(t){const e=[t.scene.canvas.canvas.id,t.scene._sectionPlanesState.getHash(),t._geometry._state.hash,t._state.occlusionHash].join(";");let i=mi[e];if(!i){if(i=new gi(e,t),i.errors)return console.log(i.errors.join("\n")),null;mi[e]=i,_.memory.programs++}return i._useCount++,i},gi.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete mi[this._hash],_.memory.programs--)},gi.prototype.webglContextRestored=function(){this._program=null},gi.prototype.drawMesh=function(t,e){this._program||this._allocate(e);const i=this._scene,s=i.canvas.gl,r=e._material._state,o=e._state,a=e._geometry._state,n=e.origin;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),r.id!==this._lastMaterialId){const e=r.backfaces;t.backfaces!==e&&(e?s.disable(s.CULL_FACE):s.enable(s.CULL_FACE),t.backfaces=e);const i=r.frontface;t.frontface!==i&&(i?s.frontFace(s.CCW):s.frontFace(s.CW),t.frontface=i),this._lastMaterialId=r.id}const l=i.camera;if(s.uniformMatrix4fv(this._uViewMatrix,!1,n?t.getRTCViewMatrix(o.originHash,n):l.viewMatrix),o.clippable){const t=i._sectionPlanesState.sectionPlanes.length;if(t>0){const r=i._sectionPlanesState.sectionPlanes,o=e.renderFlags;for(let e=0;e<t;e++){const t=this._uSectionPlanes[e];if(t){const i=o.sectionPlanesActivePerLayer[e];if(s.uniform1i(t.active,i?1:0),i){const i=r[e];s.uniform3fv(t.pos,n?W(i.dist,i.dir,n,fi):i.pos),s.uniform3fv(t.dir,i.dir)}}}}}s.uniformMatrix4fv(this._uProjMatrix,!1,l._project._state.matrix),s.uniformMatrix4fv(this._uModelMatrix,s.FALSE,e.worldMatrix),this._uClippable&&s.uniform1i(this._uClippable,e._state.clippable),s.uniform3fv(this._uOffset,e._state.offset),a.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,a.positionsDecodeMatrix),this._aPosition&&(this._aPosition.bindArrayBuffer(a.positionsBuf,a.compressGeometry?s.UNSIGNED_SHORT:s.FLOAT),t.bindArray++),a.indicesBuf&&(a.indicesBuf.bind(),t.bindArray++),this._lastGeometryId=a.id),a.indicesBuf?(s.drawElements(a.primitive,a.indicesBuf.numItems,a.indicesBuf.itemType,0),t.drawElements++):a.positions&&s.drawArrays(s.TRIANGLES,0,a.positions.numItems)},gi.prototype._allocate=function(t){const e=t.scene,i=e.canvas.gl;if(this._program=new yt(i,this._shaderSource),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),e.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC")),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},gi.prototype._bindProgram=function(t){const e=this._scene,i=e.camera.project,s=e.canvas.gl;if(this._program.bind(),t.useProgram++,s.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),e.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null};class vi{constructor(t){this.vertex=function(t){const e=t.scene._sectionPlanesState.sectionPlanes.length>0,i=!!t._geometry._state.compressGeometry,s=[];s.push("// Mesh shadow vertex shader"),s.push("attribute vec3 position;"),s.push("uniform mat4 modelMatrix;"),s.push("uniform mat4 shadowViewMatrix;"),s.push("uniform mat4 shadowProjMatrix;"),s.push("uniform vec3 offset;"),i&&s.push("uniform mat4 positionsDecodeMatrix;");e&&s.push("varying vec4 vWorldPosition;");s.push("void main(void) {"),s.push("vec4 localPosition = vec4(position, 1.0); "),s.push("vec4 worldPosition;"),i&&s.push("localPosition = positionsDecodeMatrix * localPosition;");s.push("worldPosition = modelMatrix * localPosition;"),s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = shadowViewMatrix * worldPosition; "),e&&s.push("vWorldPosition = worldPosition;");return s.push("   gl_Position = shadowProjMatrix * viewPosition;"),s.push("}"),s}(t),this.fragment=function(t){const e=t.scene;e.canvas.gl;const i=e._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];if(r.push("// Mesh shadow fragment shader"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),s){r.push("uniform bool clippable;"),r.push("varying vec4 vWorldPosition;");for(var o=0;o<i.sectionPlanes.length;o++)r.push("uniform bool sectionPlaneActive"+o+";"),r.push("uniform vec3 sectionPlanePos"+o+";"),r.push("uniform vec3 sectionPlaneDir"+o+";")}if(r.push("vec4 encodeFloat( const in float depth ) {"),r.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),r.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),r.push("  vec4 comp = fract(depth * bitShift);"),r.push("  comp -= comp.xxyz * bitMask;"),r.push("  return comp;"),r.push("}"),r.push("void main(void) {"),s){r.push("if (clippable) {"),r.push("  float dist = 0.0;");for(o=0;o<i.sectionPlanes.length;o++)r.push("if (sectionPlaneActive"+o+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+o+".xyz, vWorldPosition.xyz - sectionPlanePos"+o+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { discard; }"),r.push("}")}return r.push("gl_FragColor = encodeFloat(gl_FragCoord.z);"),r.push("}"),r}(t)}}const bi=function(t,e){this._hash=t,this._shaderSource=new vi(e),this._scene=e.scene,this._useCount=0,this._allocate(e)},Pi={};bi.get=function(t){const e=t.scene,i=[e.canvas.canvas.id,e._sectionPlanesState.getHash(),t._geometry._state.hash,t._state.hash].join(";");let s=Pi[i];if(!s){if(s=new bi(i,t),s.errors)return console.log(s.errors.join("\n")),null;Pi[i]=s,_.memory.programs++}return s._useCount++,s},bi.prototype.put=function(){0==--this._useCount&&(this._program&&this._program.destroy(),delete Pi[this._hash],_.memory.programs--)},bi.prototype.webglContextRestored=function(){this._program=null},bi.prototype.drawMesh=function(t,e){this._program||this._allocate(e);const i=this._scene.canvas.gl,s=e._material._state,r=e._geometry._state;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),s.id!==this._lastMaterialId){const e=s.backfaces;t.backfaces!==e&&(e?i.disable(i.CULL_FACE):i.enable(i.CULL_FACE),t.backfaces=e);const r=s.frontface;t.frontface!==r&&(r?i.frontFace(i.CCW):i.frontFace(i.CW),t.frontface=r),t.lineWidth!==s.lineWidth&&(i.lineWidth(s.lineWidth),t.lineWidth=s.lineWidth),this._uPointSize&&i.uniform1i(this._uPointSize,s.pointSize),this._lastMaterialId=s.id}if(i.uniformMatrix4fv(this._uModelMatrix,i.FALSE,e.worldMatrix),r.combineGeometry){const s=e.vertexBufs;s.id!==this._lastVertexBufsId&&(s.positionsBuf&&this._aPosition&&(this._aPosition.bindArrayBuffer(s.positionsBuf,s.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),t.bindArray++),this._lastVertexBufsId=s.id)}this._uClippable&&i.uniform1i(this._uClippable,e._state.clippable),i.uniform3fv(this._uOffset,e._state.offset),r.id!==this._lastGeometryId&&(this._uPositionsDecodeMatrix&&i.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,r.positionsDecodeMatrix),r.combineGeometry?r.indicesBufCombined&&(r.indicesBufCombined.bind(),t.bindArray++):(this._aPosition&&(this._aPosition.bindArrayBuffer(r.positionsBuf,r.compressGeometry?i.UNSIGNED_SHORT:i.FLOAT),t.bindArray++),r.indicesBuf&&(r.indicesBuf.bind(),t.bindArray++)),this._lastGeometryId=r.id),r.combineGeometry?r.indicesBufCombined&&(i.drawElements(r.primitive,r.indicesBufCombined.numItems,r.indicesBufCombined.itemType,0),t.drawElements++):r.indicesBuf?(i.drawElements(r.primitive,r.indicesBuf.numItems,r.indicesBuf.itemType,0),t.drawElements++):r.positions&&(i.drawArrays(i.TRIANGLES,0,r.positions.numItems),t.drawArrays++)},bi.prototype._allocate=function(t){const e=t.scene,i=e.canvas.gl;if(this._program=new yt(i,this._shaderSource),this._scene=e,this._useCount=0,this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uModelMatrix=s.getLocation("modelMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),this._uSectionPlanes={};for(let t=0,i=e._sectionPlanesState.sectionPlanes.length;t<i;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._uClippable=s.getLocation("clippable"),this._uOffset=s.getLocation("offset"),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null},bi.prototype._bindProgram=function(t){this._program||this._allocate(mesh);const e=this._scene,i=e.canvas.gl,s=e._sectionPlanesState;if(this._program.bind(),t.useProgram++,i.uniformMatrix4fv(this._uShadowViewMatrix,!1,t.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,t.shadowProjMatrix),this._lastMaterialId=null,this._lastVertexBufsId=null,this._lastGeometryId=null,s.sectionPlanes.length>0){let t,e,r,o,a;for(let n=0,l=this._uSectionPlanes.length;n<l;n++)t=this._uSectionPlanes[n],e=t.active,r=s.sectionPlanes[n],e&&i.uniform1i(e,r.active),o=t.pos,o&&i.uniform3fv(t.pos,r.pos),a=t.dir,a&&i.uniform3fv(t.dir,r.dir)}};class yi{constructor(){this.visibleLayers=[],this.sectionPlanesActivePerLayer=[],this.reset()}reset(){this.culled=!1,this.sectioned=!1,this.numLayers=0,this.numVisibleLayers=0,this.colorOpaque=!1,this.colorTransparent=!1,this.edgesOpaque=!1,this.edgesTransparent=!1,this.xrayedSilhouetteOpaque=!1,this.xrayedEdgesOpaque=!1,this.xrayedSilhouetteTransparent=!1,this.xrayedEdgesTransparent=!1,this.highlightedSilhouetteOpaque=!1,this.highlightedEdgesOpaque=!1,this.highlightedSilhouetteTransparent=!1,this.highlightedEdgesTransparent=!1,this.selectedSilhouetteOpaque=!1,this.selectedEdgesOpaque=!1,this.selectedSilhouetteTransparent=!1,this.selectedEdgesTransparent=!1}}const Mi=d.OBB3(),xi=d.vec4(),wi=d.vec4(),Ei=d.vec4(),Ai=d.vec3([1,0,0]),Ci=d.vec3([0,1,0]),Si=d.vec3([0,0,1]),Di=d.vec3(3),Li=d.vec3(3),Bi=d.identityMat4();class Ri extends S{constructor(t,e={}){super(t,e),this.originalSystemId=e.originalSystemId||this.id,this.renderFlags=new yi,this._state=new Gt({visible:!0,culled:!1,pickable:null,clippable:null,collidable:null,occluder:!1!==e.occluder,castsShadow:null,receivesShadow:null,xrayed:!1,highlighted:!1,selected:!1,edges:!1,stationary:!!e.stationary,background:!!e.background,billboard:this._checkBillboard(e.billboard),layer:null,colorize:null,pickID:this.scene._renderer.getPickID(this),drawHash:"",pickHash:"",offset:d.vec3(),origin:null,originHash:null}),this._drawRenderer=null,this._shadowRenderer=null,this._emphasisFillRenderer=null,this._emphasisEdgesRenderer=null,this._pickMeshRenderer=null,this._pickTriangleRenderer=null,this._occlusionRenderer=null,this._geometry=e.geometry?this._checkComponent2(["ReadableGeometry","VBOGeometry"],e.geometry):this.scene.geometry,this._material=e.material?this._checkComponent2(["PhongMaterial","MetallicMaterial","SpecularMaterial","LambertMaterial"],e.material):this.scene.material,this._xrayMaterial=e.xrayMaterial?this._checkComponent("EmphasisMaterial",e.xrayMaterial):this.scene.xrayMaterial,this._highlightMaterial=e.highlightMaterial?this._checkComponent("EmphasisMaterial",e.highlightMaterial):this.scene.highlightMaterial,this._selectedMaterial=e.selectedMaterial?this._checkComponent("EmphasisMaterial",e.selectedMaterial):this.scene.selectedMaterial,this._edgeMaterial=e.edgeMaterial?this._checkComponent("EdgeMaterial",e.edgeMaterial):this.scene.edgeMaterial,this._parentNode=null,this._aabb=null,this._aabbDirty=!0,this._numTriangles=this._geometry?this._geometry.numTriangles:0,this.scene._aabbDirty=!0,this._scale=d.vec3(),this._quaternion=d.identityQuaternion(),this._rotation=d.vec3(),this._position=d.vec3(),this._worldMatrix=d.identityMat4(),this._worldNormalMatrix=d.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0;const i=e.origin||e.rtcCenter;if(i&&(this._state.origin=d.vec3(i),this._state.originHash=i.join()),e.matrix?this.matrix=e.matrix:(this.scale=e.scale,this.position=e.position,e.quaternion||(this.rotation=e.rotation)),this._isObject=e.isObject,this._isObject&&this.scene._registerObject(this),this._isModel=e.isModel,this._isModel&&this.scene._registerModel(this),this.visible=e.visible,this.culled=e.culled,this.pickable=e.pickable,this.clippable=e.clippable,this.collidable=e.collidable,this.castsShadow=e.castsShadow,this.receivesShadow=e.receivesShadow,this.xrayed=e.xrayed,this.highlighted=e.highlighted,this.selected=e.selected,this.edges=e.edges,this.layer=e.layer,this.colorize=e.colorize,this.opacity=e.opacity,this.offset=e.offset,e.parentId){const t=this.scene.components[e.parentId];t?t.isNode?t.addChild(this):this.error("Parent is not a Node: '"+e.parentId+"'"):this.error("Parent not found: '"+e.parentId+"'"),this._parentNode=t}else e.parent&&(e.parent.isNode||this.error("Parent is not a Node"),e.parent.addChild(this),this._parentNode=e.parent);this.compile()}get type(){return"Mesh"}get isMesh(){return!0}get parent(){return this._parentNode}get geometry(){return this._geometry}get material(){return this._material}get position(){return this._position}set position(t){this._position.set(t||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set rotation(t){this._rotation.set(t||[0,0,0]),d.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set quaternion(t){this._quaternion.set(t||[0,0,0,1]),d.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set scale(t){this._scale.set(t||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this.__localMatrix||(this.__localMatrix=d.identityMat4()),d.composeMat4(this._position,this._quaternion,this._scale,this.__localMatrix),this._localMatrixDirty=!1),this.__localMatrix}set matrix(t){this.__localMatrix||(this.__localMatrix=d.identityMat4()),this.__localMatrix.set(t||Bi),d.decomposeMat4(this.__localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrixDirty&&this._buildWorldNormalMatrix(),this._worldNormalMatrix}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}get origin(){return this._state.origin}set origin(t){t?(this._state.origin||(this._state.origin=d.vec3()),this._state.origin.set(t),this._state.originHash=t.join(),this._setAABBDirty(),this.scene._aabbDirty=!0):this._state.origin&&(this._state.origin=null,this._state.originHash=null,this._setAABBDirty(),this.scene._aabbDirty=!0)}get rtcCenter(){return this.origin}set rtcCenter(t){this.origin=t}get numTriangles(){return this._numTriangles}get visible(){return this._state.visible}set visible(t){t=!1!==t,this._state.visible=t,this._isObject&&this.scene._objectVisibilityUpdated(this),this.glRedraw()}get xrayed(){return this._state.xrayed}set xrayed(t){t=!!t,this._state.xrayed!==t&&(this._state.xrayed=t,this._isObject&&this.scene._objectXRayedUpdated(this),this.glRedraw())}get highlighted(){return this._state.highlighted}set highlighted(t){(t=!!t)!==this._state.highlighted&&(this._state.highlighted=t,this._isObject&&this.scene._objectHighlightedUpdated(this),this.glRedraw())}get selected(){return this._state.selected}set selected(t){(t=!!t)!==this._state.selected&&(this._state.selected=t,this._isObject&&this.scene._objectSelectedUpdated(this),this.glRedraw())}get edges(){return this._state.edges}set edges(t){(t=!!t)!==this._state.edges&&(this._state.edges=t,this.glRedraw())}get culled(){return this._state.culled}set culled(t){this._state.culled=!!t,this.glRedraw()}get clippable(){return this._state.clippable}set clippable(t){t=!1!==t,this._state.clippable!==t&&(this._state.clippable=t,this.glRedraw())}get collidable(){return this._state.collidable}set collidable(t){(t=!1!==t)!==this._state.collidable&&(this._state.collidable=t,this._setAABBDirty(),this.scene._aabbDirty=!0)}get pickable(){return this._state.pickable}set pickable(t){t=!1!==t,this._state.pickable!==t&&(this._state.pickable=t)}get castsShadow(){return this._state.castsShadow}set castsShadow(t){(t=!1!==t)!==this._state.castsShadow&&(this._state.castsShadow=t,this.glRedraw())}get receivesShadow(){return this._state.receivesShadow}set receivesShadow(t){(t=!1!==t)!==this._state.receivesShadow&&(this._state.receivesShadow=t,this._state.hash=t?"/mod/rs;":"/mod;",this.fire("dirty",this))}get saoEnabled(){return!1}get colorize(){return this._state.colorize}set colorize(t){let e=this._state.colorize;e||(e=this._state.colorize=new Float32Array(4),e[3]=1),t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1);const i=!!t;this.scene._objectColorizeUpdated(this,i),this.glRedraw()}get opacity(){return this._state.colorize[3]}set opacity(t){let e=this._state.colorize;e||(e=this._state.colorize=new Float32Array(4),e[0]=1,e[1]=1,e[2]=1);const i=null!=t;e[3]=i?t:1,this.scene._objectOpacityUpdated(this,i),this.glRedraw()}get transparent(){return 2===this._material.alphaMode||this._state.colorize[3]<1}get layer(){return this._state.layer}set layer(t){t=t||0,(t=Math.round(t))!==this._state.layer&&(this._state.layer=t,this._renderer.needStateSort())}get stationary(){return this._state.stationary}get billboard(){return this._state.billboard}get offset(){return this._state.offset}set offset(t){this._state.offset.set(t||[0,0,0]),this._setAABBDirty(),this.glRedraw()}get isDrawable(){return!0}get isStateSortable(){return!0}get xrayMaterial(){return this._xrayMaterial}get highlightMaterial(){return this._highlightMaterial}get selectedMaterial(){return this._selectedMaterial}get edgeMaterial(){return this._edgeMaterial}_checkBillboard(t){return"spherical"!==(t=t||"none")&&"cylindrical"!==t&&"none"!==t&&(this.error("Unsupported value for 'billboard': "+t+" - accepted values are 'spherical', 'cylindrical' and 'none' - defaulting to 'none'."),t="none"),t}compile(){const t=this._makeDrawHash();this._state.drawHash!==t&&(this._state.drawHash=t,this._putDrawRenderers(),this._drawRenderer=Ke.get(this),this._emphasisFillRenderer=Je.get(this),this._emphasisEdgesRenderer=ri.get(this));const e=this._makePickHash();if(this._state.pickHash!==e&&(this._state.pickHash=e,this._putPickRenderers(),this._pickMeshRenderer=li.get(this)),this._state.occluder){const t=this._makeOcclusionHash();this._state.occlusionHash!==t&&(this._state.occlusionHash=t,this._putOcclusionRenderer(),this._occlusionRenderer=gi.get(this))}}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0,this._worldNormalMatrixDirty=!0}_buildWorldMatrix(){const t=this.matrix;if(this._parentNode)d.mulMat4(this._parentNode.worldMatrix,t,this._worldMatrix);else for(let e=0,i=t.length;e<i;e++)this._worldMatrix[e]=t[e];this._worldMatrixDirty=!1}_buildWorldNormalMatrix(){this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldNormalMatrix||(this._worldNormalMatrix=d.mat4()),d.transposeMat4(this._worldMatrix,this._worldNormalMatrix),d.inverseMat4(this._worldNormalMatrix),this._worldNormalMatrixDirty=!1}_setAABBDirty(){if(this.collidable)for(let t=this;t;t=t._parentNode)t._aabbDirty=!0}_updateAABB(){this.scene._aabbDirty=!0,this._aabb||(this._aabb=d.AABB3()),this._buildAABB(this.worldMatrix,this._aabb),this._aabbDirty=!1}_webglContextRestored(){this._drawRenderer&&this._drawRenderer.webglContextRestored(),this._shadowRenderer&&this._shadowRenderer.webglContextRestored(),this._emphasisFillRenderer&&this._emphasisFillRenderer.webglContextRestored(),this._emphasisEdgesRenderer&&this._emphasisEdgesRenderer.webglContextRestored(),this._pickMeshRenderer&&this._pickMeshRenderer.webglContextRestored(),this._pickTriangleRenderer&&this._pickMeshRenderer.webglContextRestored(),this._occlusionRenderer&&this._occlusionRenderer.webglContextRestored()}_makeDrawHash(){const t=this.scene,e=[t.canvas.canvas.id,(t.gammaInput?"gi;":";")+(t.gammaOutput?"go":""),t._lightsState.getHash(),t._sectionPlanesState.getHash()],i=this._state;return i.stationary&&e.push("/s"),"none"===i.billboard?e.push("/n"):"spherical"===i.billboard?e.push("/s"):"cylindrical"===i.billboard&&e.push("/c"),i.receivesShadow&&e.push("/rs"),e.push(";"),e.join("")}_makePickHash(){const t=this.scene,e=[t.canvas.canvas.id,t._sectionPlanesState.getHash()],i=this._state;return i.stationary&&e.push("/s"),"none"===i.billboard?e.push("/n"):"spherical"===i.billboard?e.push("/s"):"cylindrical"===i.billboard&&e.push("/c"),e.push(";"),e.join("")}_makeOcclusionHash(){const t=this.scene,e=[t.canvas.canvas.id,t._sectionPlanesState.getHash()],i=this._state;return i.stationary&&e.push("/s"),"none"===i.billboard?e.push("/n"):"spherical"===i.billboard?e.push("/s"):"cylindrical"===i.billboard&&e.push("/c"),e.push(";"),e.join("")}_buildAABB(t,e){d.transformOBB3(t,this._geometry.obb,Mi),d.OBB3ToAABB3(Mi,e);const i=this._state.offset;if(e[0]+=i[0],e[1]+=i[1],e[2]+=i[2],e[3]+=i[0],e[4]+=i[1],e[5]+=i[2],this._state.origin){const t=this._state.origin;e[0]+=t[0],e[1]+=t[1],e[2]+=t[2],e[3]+=t[0],e[4]+=t[1],e[5]+=t[2]}}rotate(t,e){return xi[0]=t[0],xi[1]=t[1],xi[2]=t[2],xi[3]=e*d.DEGTORAD,d.angleAxisToQuaternion(xi,wi),d.mulQuaternions(this.quaternion,wi,Ei),this.quaternion=Ei,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(t,e){return xi[0]=t[0],xi[1]=t[1],xi[2]=t[2],xi[3]=e*d.DEGTORAD,d.angleAxisToQuaternion(xi,wi),d.mulQuaternions(wi,this.quaternion,wi),this}rotateX(t){return this.rotate(Ai,t)}rotateY(t){return this.rotate(Ci,t)}rotateZ(t){return this.rotate(Si,t)}translate(t,e){return d.vec3ApplyQuaternion(this.quaternion,t,Di),d.mulVec3Scalar(Di,e,Li),d.addVec3(this.position,Li,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(t){return this.translate(Ai,t)}translateY(t){return this.translate(Ci,t)}translateZ(t){return this.translate(Si,t)}_putDrawRenderers(){this._drawRenderer&&(this._drawRenderer.put(),this._drawRenderer=null),this._shadowRenderer&&(this._shadowRenderer.put(),this._shadowRenderer=null),this._emphasisFillRenderer&&(this._emphasisFillRenderer.put(),this._emphasisFillRenderer=null),this._emphasisEdgesRenderer&&(this._emphasisEdgesRenderer.put(),this._emphasisEdgesRenderer=null)}_putPickRenderers(){this._pickMeshRenderer&&(this._pickMeshRenderer.put(),this._pickMeshRenderer=null),this._pickTriangleRenderer&&(this._pickTriangleRenderer.put(),this._pickTriangleRenderer=null)}_putOcclusionRenderer(){this._occlusionRenderer&&(this._occlusionRenderer.put(),this._occlusionRenderer=null)}stateSortCompare(t,e){return t._state.layer-e._state.layer||t._drawRenderer.id-e._drawRenderer.id||t._material._state.id-e._material._state.id||t._geometry._state.id-e._geometry._state.id}rebuildRenderFlags(){this.renderFlags.reset(),this._getActiveSectionPlanes()?(this.renderFlags.numLayers=1,this.renderFlags.numVisibleLayers=1,this.renderFlags.visibleLayers[0]=0,this._updateRenderFlags()):this.renderFlags.culled=!0}_updateRenderFlags(){const t=this.renderFlags,e=this._state;if(e.xrayed){const e=this._xrayMaterial._state;e.fill&&(e.fillAlpha<1?t.xrayedSilhouetteTransparent=!0:t.xrayedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.xrayedEdgesTransparent=!0:t.xrayedEdgesOpaque=!0)}else{if(this._material._state.alpha<1||e.colorize[3]<1?t.colorTransparent=!0:t.colorOpaque=!0,e.edges){this._edgeMaterial._state.alpha<1?t.edgesTransparent=!0:t.edgesOpaque=!0}if(e.selected){const e=this._selectedMaterial._state;e.fill&&(e.fillAlpha<1?t.selectedSilhouetteTransparent=!0:t.selectedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.selectedEdgesTransparent=!0:t.selectedEdgesOpaque=!0)}else if(e.highlighted){const e=this._highlightMaterial._state;e.fill&&(e.fillAlpha<1?t.highlightedSilhouetteTransparent=!0:t.highlightedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.highlightedEdgesTransparent=!0:t.highlightedEdgesOpaque=!0)}}}_getActiveSectionPlanes(){if(this._state.clippable){const t=this.scene._sectionPlanesState.sectionPlanes,e=t.length;if(e>0)for(let i=0;i<e;i++){const e=t[i],s=this.renderFlags;if(e.active)if(this._state.origin){const t=d.planeAABB3Intersect(e.dir,e.dist,this.aabb);if(-1===t)return!1;const r=0===t;s.sectionPlanesActivePerLayer[i]=r}else s.sectionPlanesActivePerLayer[i]=!0;else s.sectionPlanesActivePerLayer[i]=!1}}return!0}drawColorOpaque(t){(this._drawRenderer||(this._drawRenderer=Ke.get(this)))&&this._drawRenderer.drawMesh(t,this)}drawColorTransparent(t){(this._drawRenderer||(this._drawRenderer=Ke.get(this)))&&this._drawRenderer.drawMesh(t,this)}drawSilhouetteXRayed(t){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Je.get(this)))&&this._emphasisFillRenderer.drawMesh(t,this,0)}drawSilhouetteHighlighted(t){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Je.get(this)))&&this._emphasisFillRenderer.drawMesh(t,this,1)}drawSilhouetteSelected(t){(this._emphasisFillRenderer||(this._emphasisFillRenderer=Je.get(this)))&&this._emphasisFillRenderer.drawMesh(t,this,2)}drawEdgesColorOpaque(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=ri.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,3)}drawEdgesColorTransparent(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=ri.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,3)}drawEdgesXRayed(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=ri.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,0)}drawEdgesHighlighted(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=ri.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,1)}drawEdgesSelected(t){(this._emphasisEdgesRenderer||(this._emphasisEdgesRenderer=ri.get(this)))&&this._emphasisEdgesRenderer.drawMesh(t,this,2)}drawOcclusion(t){(this._state.occluder&&this._occlusionRenderer||(this._occlusionRenderer=gi.get(this)))&&this._occlusionRenderer.drawMesh(t,this)}drawShadow(t){(this._shadowRenderer||(this._shadowRenderer=bi.get(this)))&&this._shadowRenderer.drawMesh(t,this)}drawPickMesh(t){(this._pickMeshRenderer||(this._pickMeshRenderer=li.get(this)))&&this._pickMeshRenderer.drawMesh(t,this)}canPickTriangle(){return this._geometry.isReadableGeometry}drawPickTriangles(t){(this._pickTriangleRenderer||(this._pickTriangleRenderer=di.get(this)))&&this._pickTriangleRenderer.drawMesh(t,this)}pickTriangleSurface(t,e,i){Ti(this,t,e,i)}drawPickVertices(t){}delegatePickedEntity(){return this}destroy(){super.destroy(),this._putDrawRenderers(),this._putPickRenderers(),this._putOcclusionRenderer(),this.scene._renderer.putPickID(this._state.pickID),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this.glRedraw()}}const Ti=function(){const t=d.vec3(),e=d.vec3(),i=d.vec3(),s=d.vec3(),r=d.vec3(),o=d.vec3(),a=d.vec4(),n=d.vec3(),l=d.vec3(),h=d.vec3(),c=d.vec3(),u=d.vec3(),p=d.vec3(),_=d.vec3(),f=d.vec3(),g=d.vec3(),m=d.vec4(),v=d.vec4(),b=d.vec4(),P=d.vec3(),y=d.vec3(),M=d.vec3(),x=d.vec3(),w=d.vec3(),E=d.vec3(),A=d.vec3(),C=d.vec3(),S=d.vec3(),D=d.vec3(),L=d.vec3();return function(B,R,T,F){var N=F.primIndex;if(null!=N&&N>-1){const V=B.geometry._state,z=B.scene,U=z.camera,G=z.canvas;if("triangles"===V.primitiveName){F.primitive="triangle";const z=N,j=V.indices,X=V.positions;let W,H,Y,K;if(j){var I=j[z+0],k=j[z+1],O=j[z+2];o[0]=I,o[1]=k,o[2]=O,F.indices=o,W=3*I,H=3*k,Y=3*O}else W=3*z,H=W+3,Y=H+3;if(i[0]=X[W+0],i[1]=X[W+1],i[2]=X[W+2],s[0]=X[H+0],s[1]=X[H+1],s[2]=X[H+2],r[0]=X[Y+0],r[1]=X[Y+1],r[2]=X[Y+2],V.compressGeometry){const t=V.positionsDecodeMatrix;t&&(ve.decompressPosition(i,t,i),ve.decompressPosition(s,t,s),ve.decompressPosition(r,t,r))}F.canvasPos?(K=F.canvasPos,d.canvasPosToLocalRay(G.canvas,R,T,B.worldMatrix,K,t,e)):F.origin&&F.direction&&d.worldRayToLocalRay(B.worldMatrix,F.origin,F.direction,t,e),d.normalizeVec3(e),d.rayPlaneIntersect(t,e,i,s,r,a),F.localPos=a,F.position=a,m[0]=a[0],m[1]=a[1],m[2]=a[2],m[3]=1,d.transformVec4(B.worldMatrix,m,v),n[0]=v[0],n[1]=v[1],n[2]=v[2],F.worldPos=n,d.transformVec4(U.matrix,v,b),l[0]=b[0],l[1]=b[1],l[2]=b[2],F.viewPos=l,d.cartesianToBarycentric(a,i,s,r,h),F.bary=h;const q=V.normals;if(q){if(V.compressGeometry){const t=3*I,e=3*k,i=3*O;ve.decompressNormal(q.subarray(t,t+2),c),ve.decompressNormal(q.subarray(e,e+2),u),ve.decompressNormal(q.subarray(i,i+2),p)}else c[0]=q[W],c[1]=q[W+1],c[2]=q[W+2],u[0]=q[H],u[1]=q[H+1],u[2]=q[H+2],p[0]=q[Y],p[1]=q[Y+1],p[2]=q[Y+2];const t=d.addVec3(d.addVec3(d.mulVec3Scalar(c,h[0],P),d.mulVec3Scalar(u,h[1],y),M),d.mulVec3Scalar(p,h[2],x),w);F.worldNormal=d.normalizeVec3(d.transformVec3(B.worldNormalMatrix,t,E))}const Z=V.uv;if(Z){if(_[0]=Z[2*I],_[1]=Z[2*I+1],f[0]=Z[2*k],f[1]=Z[2*k+1],g[0]=Z[2*O],g[1]=Z[2*O+1],V.compressGeometry){const t=V.uvDecodeMatrix;t&&(ve.decompressUV(_,t,_),ve.decompressUV(f,t,f),ve.decompressUV(g,t,g))}F.uv=d.addVec3(d.addVec3(d.mulVec2Scalar(_,h[0],A),d.mulVec2Scalar(f,h[1],C),S),d.mulVec2Scalar(g,h[2],D),L)}}}}}();function Fi(t={}){let e=t.radiusTop||1;e<0&&(console.error("negative radiusTop not allowed - will invert"),e*=-1);let i=t.radiusBottom||1;i<0&&(console.error("negative radiusBottom not allowed - will invert"),i*=-1);let s=t.height||1;s<0&&(console.error("negative height not allowed - will invert"),s*=-1);let r=t.radialSegments||32;r<0&&(console.error("negative radialSegments not allowed - will invert"),r*=-1),r<3&&(r=3);let o=t.heightSegments||1;o<0&&(console.error("negative heightSegments not allowed - will invert"),o*=-1),o<1&&(o=1);const a=!!t.openEnded;let n=t.center;const l=n?n[0]:0,h=n?n[1]:0,c=n?n[2]:0,u=s/2,d=s/o,p=2*Math.PI/r,_=1/r,f=(e-i)/o,g=[],v=[],b=[],P=[];let y,M,x,w,E,A,C,S,D,L,B;const R=(90-180*Math.atan(s/(i-e))/Math.PI)/90;for(y=0;y<=o;y++)for(E=e-y*f,A=u-y*d,M=0;M<=r;M++)x=Math.sin(M*p),w=Math.cos(M*p),v.push(E*x),v.push(R),v.push(E*w),b.push(M*_),b.push(1*y/o),g.push(E*x+l),g.push(A+h),g.push(E*w+c);for(y=0;y<o;y++)for(M=0;M<=r;M++)C=y*(r+1)+M,S=C+r,P.push(C),P.push(S),P.push(S+1),P.push(C),P.push(S+1),P.push(C+1);if(!a&&e>0){for(D=g.length/3,v.push(0),v.push(1),v.push(0),b.push(.5),b.push(.5),g.push(0+l),g.push(u+h),g.push(0+c),M=0;M<=r;M++)x=Math.sin(M*p),w=Math.cos(M*p),L=.5*Math.sin(M*p)+.5,B=.5*Math.cos(M*p)+.5,v.push(e*x),v.push(1),v.push(e*w),b.push(L),b.push(B),g.push(e*x+l),g.push(u+h),g.push(e*w+c);for(M=0;M<r;M++)n=D,C=D+1+M,P.push(C),P.push(C+1),P.push(n)}if(!a&&i>0){for(D=g.length/3,v.push(0),v.push(-1),v.push(0),b.push(.5),b.push(.5),g.push(0+l),g.push(0-u+h),g.push(0+c),M=0;M<=r;M++)x=Math.sin(M*p),w=Math.cos(M*p),L=.5*Math.sin(M*p)+.5,B=.5*Math.cos(M*p)+.5,v.push(i*x),v.push(-1),v.push(i*w),b.push(L),b.push(B),g.push(i*x+l),g.push(0-u+h),g.push(i*w+c);for(M=0;M<r;M++)n=D,C=D+1+M,P.push(n),P.push(C+1),P.push(C)}return m.apply(t,{positions:g,normals:v,uv:b,indices:P})}function Ni(t={}){const e=t.lod||1,i=t.center?t.center[0]:0,s=t.center?t.center[1]:0,r=t.center?t.center[2]:0;let o=t.radius||1;o<0&&(console.error("negative radius not allowed - will invert"),o*=-1);let a=t.heightSegments||18;a<0&&(console.error("negative heightSegments not allowed - will invert"),a*=-1),a=Math.floor(e*a),a<18&&(a=18);let n=t.widthSegments||18;n<0&&(console.error("negative widthSegments not allowed - will invert"),n*=-1),n=Math.floor(e*n),n<18&&(n=18);const l=[],h=[],c=[],u=[];let d,p,_,f,g,v,b,P,y,M,x,w,E,A,C;for(d=0;d<=a;d++)for(_=d*Math.PI/a,f=Math.sin(_),g=Math.cos(_),p=0;p<=n;p++)v=2*p*Math.PI/n,b=Math.sin(v),P=Math.cos(v),y=P*f,M=g,x=b*f,w=1-p/n,E=d/a,h.push(y),h.push(M),h.push(x),c.push(w),c.push(E),l.push(i+o*y),l.push(s+o*M),l.push(r+o*x);for(d=0;d<a;d++)for(p=0;p<n;p++)A=d*(n+1)+p,C=A+n+1,u.push(A+1),u.push(C+1),u.push(C),u.push(A+1),u.push(C),u.push(A);return m.apply(t,{positions:l,normals:h,uv:c,indices:u})}const Ii={" ":{width:16,points:[]},"!":{width:10,points:[[5,21],[5,7],[-1,-1],[5,2],[4,1],[5,0],[6,1],[5,2]]},'"':{width:16,points:[[4,21],[4,14],[-1,-1],[12,21],[12,14]]},"#":{width:21,points:[[11,25],[4,-7],[-1,-1],[17,25],[10,-7],[-1,-1],[4,12],[18,12],[-1,-1],[3,6],[17,6]]},$:{width:20,points:[[8,25],[8,-4],[-1,-1],[12,25],[12,-4],[-1,-1],[17,18],[15,20],[12,21],[8,21],[5,20],[3,18],[3,16],[4,14],[5,13],[7,12],[13,10],[15,9],[16,8],[17,6],[17,3],[15,1],[12,0],[8,0],[5,1],[3,3]]},"%":{width:24,points:[[21,21],[3,0],[-1,-1],[8,21],[10,19],[10,17],[9,15],[7,14],[5,14],[3,16],[3,18],[4,20],[6,21],[8,21],[10,20],[13,19],[16,19],[19,20],[21,21],[-1,-1],[17,7],[15,6],[14,4],[14,2],[16,0],[18,0],[20,1],[21,3],[21,5],[19,7],[17,7]]},"&":{width:26,points:[[23,12],[23,13],[22,14],[21,14],[20,13],[19,11],[17,6],[15,3],[13,1],[11,0],[7,0],[5,1],[4,2],[3,4],[3,6],[4,8],[5,9],[12,13],[13,14],[14,16],[14,18],[13,20],[11,21],[9,20],[8,18],[8,16],[9,13],[11,10],[16,3],[18,1],[20,0],[22,0],[23,1],[23,2]]},"'":{width:10,points:[[5,19],[4,20],[5,21],[6,20],[6,18],[5,16],[4,15]]},"(":{width:14,points:[[11,25],[9,23],[7,20],[5,16],[4,11],[4,7],[5,2],[7,-2],[9,-5],[11,-7]]},")":{width:14,points:[[3,25],[5,23],[7,20],[9,16],[10,11],[10,7],[9,2],[7,-2],[5,-5],[3,-7]]},"*":{width:16,points:[[8,21],[8,9],[-1,-1],[3,18],[13,12],[-1,-1],[13,18],[3,12]]},"+":{width:26,points:[[13,18],[13,0],[-1,-1],[4,9],[22,9]]},",":{width:10,points:[[6,1],[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},"-":{width:26,points:[[4,9],[22,9]]},".":{width:10,points:[[5,2],[4,1],[5,0],[6,1],[5,2]]},"/":{width:22,points:[[20,25],[2,-7]]},0:{width:20,points:[[9,21],[6,20],[4,17],[3,12],[3,9],[4,4],[6,1],[9,0],[11,0],[14,1],[16,4],[17,9],[17,12],[16,17],[14,20],[11,21],[9,21]]},1:{width:20,points:[[6,17],[8,18],[11,21],[11,0]]},2:{width:20,points:[[4,16],[4,17],[5,19],[6,20],[8,21],[12,21],[14,20],[15,19],[16,17],[16,15],[15,13],[13,10],[3,0],[17,0]]},3:{width:20,points:[[5,21],[16,21],[10,13],[13,13],[15,12],[16,11],[17,8],[17,6],[16,3],[14,1],[11,0],[8,0],[5,1],[4,2],[3,4]]},4:{width:20,points:[[13,21],[3,7],[18,7],[-1,-1],[13,21],[13,0]]},5:{width:20,points:[[15,21],[5,21],[4,12],[5,13],[8,14],[11,14],[14,13],[16,11],[17,8],[17,6],[16,3],[14,1],[11,0],[8,0],[5,1],[4,2],[3,4]]},6:{width:20,points:[[16,18],[15,20],[12,21],[10,21],[7,20],[5,17],[4,12],[4,7],[5,3],[7,1],[10,0],[11,0],[14,1],[16,3],[17,6],[17,7],[16,10],[14,12],[11,13],[10,13],[7,12],[5,10],[4,7]]},7:{width:20,points:[[17,21],[7,0],[-1,-1],[3,21],[17,21]]},8:{width:20,points:[[8,21],[5,20],[4,18],[4,16],[5,14],[7,13],[11,12],[14,11],[16,9],[17,7],[17,4],[16,2],[15,1],[12,0],[8,0],[5,1],[4,2],[3,4],[3,7],[4,9],[6,11],[9,12],[13,13],[15,14],[16,16],[16,18],[15,20],[12,21],[8,21]]},9:{width:20,points:[[16,14],[15,11],[13,9],[10,8],[9,8],[6,9],[4,11],[3,14],[3,15],[4,18],[6,20],[9,21],[10,21],[13,20],[15,18],[16,14],[16,9],[15,4],[13,1],[10,0],[8,0],[5,1],[4,3]]},":":{width:10,points:[[5,14],[4,13],[5,12],[6,13],[5,14],[-1,-1],[5,2],[4,1],[5,0],[6,1],[5,2]]},";":{width:10,points:[[5,14],[4,13],[5,12],[6,13],[5,14],[-1,-1],[6,1],[5,0],[4,1],[5,2],[6,1],[6,-1],[5,-3],[4,-4]]},"<":{width:24,points:[[20,18],[4,9],[20,0]]},"=":{width:26,points:[[4,12],[22,12],[-1,-1],[4,6],[22,6]]},">":{width:24,points:[[4,18],[20,9],[4,0]]},"?":{width:18,points:[[3,16],[3,17],[4,19],[5,20],[7,21],[11,21],[13,20],[14,19],[15,17],[15,15],[14,13],[13,12],[9,10],[9,7],[-1,-1],[9,2],[8,1],[9,0],[10,1],[9,2]]},"@":{width:27,points:[[18,13],[17,15],[15,16],[12,16],[10,15],[9,14],[8,11],[8,8],[9,6],[11,5],[14,5],[16,6],[17,8],[-1,-1],[12,16],[10,14],[9,11],[9,8],[10,6],[11,5],[-1,-1],[18,16],[17,8],[17,6],[19,5],[21,5],[23,7],[24,10],[24,12],[23,15],[22,17],[20,19],[18,20],[15,21],[12,21],[9,20],[7,19],[5,17],[4,15],[3,12],[3,9],[4,6],[5,4],[7,2],[9,1],[12,0],[15,0],[18,1],[20,2],[21,3],[-1,-1],[19,16],[18,8],[18,6],[19,5]]},A:{width:18,points:[[9,21],[1,0],[-1,-1],[9,21],[17,0],[-1,-1],[4,7],[14,7]]},B:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,15],[17,13],[16,12],[13,11],[-1,-1],[4,11],[13,11],[16,10],[17,9],[18,7],[18,4],[17,2],[16,1],[13,0],[4,0]]},C:{width:21,points:[[18,16],[17,18],[15,20],[13,21],[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5]]},D:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[11,21],[14,20],[16,18],[17,16],[18,13],[18,8],[17,5],[16,3],[14,1],[11,0],[4,0]]},E:{width:19,points:[[4,21],[4,0],[-1,-1],[4,21],[17,21],[-1,-1],[4,11],[12,11],[-1,-1],[4,0],[17,0]]},F:{width:18,points:[[4,21],[4,0],[-1,-1],[4,21],[17,21],[-1,-1],[4,11],[12,11]]},G:{width:21,points:[[18,16],[17,18],[15,20],[13,21],[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[18,8],[-1,-1],[13,8],[18,8]]},H:{width:22,points:[[4,21],[4,0],[-1,-1],[18,21],[18,0],[-1,-1],[4,11],[18,11]]},I:{width:8,points:[[4,21],[4,0]]},J:{width:16,points:[[12,21],[12,5],[11,2],[10,1],[8,0],[6,0],[4,1],[3,2],[2,5],[2,7]]},K:{width:21,points:[[4,21],[4,0],[-1,-1],[18,21],[4,7],[-1,-1],[9,12],[18,0]]},L:{width:17,points:[[4,21],[4,0],[-1,-1],[4,0],[16,0]]},M:{width:24,points:[[4,21],[4,0],[-1,-1],[4,21],[12,0],[-1,-1],[20,21],[12,0],[-1,-1],[20,21],[20,0]]},N:{width:22,points:[[4,21],[4,0],[-1,-1],[4,21],[18,0],[-1,-1],[18,21],[18,0]]},O:{width:22,points:[[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[19,8],[19,13],[18,16],[17,18],[15,20],[13,21],[9,21]]},P:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,14],[17,12],[16,11],[13,10],[4,10]]},Q:{width:22,points:[[9,21],[7,20],[5,18],[4,16],[3,13],[3,8],[4,5],[5,3],[7,1],[9,0],[13,0],[15,1],[17,3],[18,5],[19,8],[19,13],[18,16],[17,18],[15,20],[13,21],[9,21],[-1,-1],[12,4],[18,-2]]},R:{width:21,points:[[4,21],[4,0],[-1,-1],[4,21],[13,21],[16,20],[17,19],[18,17],[18,15],[17,13],[16,12],[13,11],[4,11],[-1,-1],[11,11],[18,0]]},S:{width:20,points:[[17,18],[15,20],[12,21],[8,21],[5,20],[3,18],[3,16],[4,14],[5,13],[7,12],[13,10],[15,9],[16,8],[17,6],[17,3],[15,1],[12,0],[8,0],[5,1],[3,3]]},T:{width:16,points:[[8,21],[8,0],[-1,-1],[1,21],[15,21]]},U:{width:22,points:[[4,21],[4,6],[5,3],[7,1],[10,0],[12,0],[15,1],[17,3],[18,6],[18,21]]},V:{width:18,points:[[1,21],[9,0],[-1,-1],[17,21],[9,0]]},W:{width:24,points:[[2,21],[7,0],[-1,-1],[12,21],[7,0],[-1,-1],[12,21],[17,0],[-1,-1],[22,21],[17,0]]},X:{width:20,points:[[3,21],[17,0],[-1,-1],[17,21],[3,0]]},Y:{width:18,points:[[1,21],[9,11],[9,0],[-1,-1],[17,21],[9,11]]},Z:{width:20,points:[[17,21],[3,0],[-1,-1],[3,21],[17,21],[-1,-1],[3,0],[17,0]]},"[":{width:14,points:[[4,25],[4,-7],[-1,-1],[5,25],[5,-7],[-1,-1],[4,25],[11,25],[-1,-1],[4,-7],[11,-7]]},"\\":{width:14,points:[[0,21],[14,-3]]},"]":{width:14,points:[[9,25],[9,-7],[-1,-1],[10,25],[10,-7],[-1,-1],[3,25],[10,25],[-1,-1],[3,-7],[10,-7]]},"^":{width:16,points:[[6,15],[8,18],[10,15],[-1,-1],[3,12],[8,17],[13,12],[-1,-1],[8,17],[8,0]]},_:{width:16,points:[[0,-2],[16,-2]]},"`":{width:10,points:[[6,21],[5,20],[4,18],[4,16],[5,15],[6,16],[5,17]]},a:{width:19,points:[[15,14],[15,0],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},b:{width:19,points:[[4,21],[4,0],[-1,-1],[4,11],[6,13],[8,14],[11,14],[13,13],[15,11],[16,8],[16,6],[15,3],[13,1],[11,0],[8,0],[6,1],[4,3]]},c:{width:18,points:[[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},d:{width:19,points:[[15,21],[15,0],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},e:{width:18,points:[[3,8],[15,8],[15,10],[14,12],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},f:{width:12,points:[[10,21],[8,21],[6,20],[5,17],[5,0],[-1,-1],[2,14],[9,14]]},g:{width:19,points:[[15,14],[15,-2],[14,-5],[13,-6],[11,-7],[8,-7],[6,-6],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},h:{width:19,points:[[4,21],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0]]},i:{width:8,points:[[3,21],[4,20],[5,21],[4,22],[3,21],[-1,-1],[4,14],[4,0]]},j:{width:10,points:[[5,21],[6,20],[7,21],[6,22],[5,21],[-1,-1],[6,14],[6,-3],[5,-6],[3,-7],[1,-7]]},k:{width:17,points:[[4,21],[4,0],[-1,-1],[14,14],[4,4],[-1,-1],[8,8],[15,0]]},l:{width:8,points:[[4,21],[4,0]]},m:{width:30,points:[[4,14],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0],[-1,-1],[15,10],[18,13],[20,14],[23,14],[25,13],[26,10],[26,0]]},n:{width:19,points:[[4,14],[4,0],[-1,-1],[4,10],[7,13],[9,14],[12,14],[14,13],[15,10],[15,0]]},o:{width:19,points:[[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3],[16,6],[16,8],[15,11],[13,13],[11,14],[8,14]]},p:{width:19,points:[[4,14],[4,-7],[-1,-1],[4,11],[6,13],[8,14],[11,14],[13,13],[15,11],[16,8],[16,6],[15,3],[13,1],[11,0],[8,0],[6,1],[4,3]]},q:{width:19,points:[[15,14],[15,-7],[-1,-1],[15,11],[13,13],[11,14],[8,14],[6,13],[4,11],[3,8],[3,6],[4,3],[6,1],[8,0],[11,0],[13,1],[15,3]]},r:{width:13,points:[[4,14],[4,0],[-1,-1],[4,8],[5,11],[7,13],[9,14],[12,14]]},s:{width:17,points:[[14,11],[13,13],[10,14],[7,14],[4,13],[3,11],[4,9],[6,8],[11,7],[13,6],[14,4],[14,3],[13,1],[10,0],[7,0],[4,1],[3,3]]},t:{width:12,points:[[5,21],[5,4],[6,1],[8,0],[10,0],[-1,-1],[2,14],[9,14]]},u:{width:19,points:[[4,14],[4,4],[5,1],[7,0],[10,0],[12,1],[15,4],[-1,-1],[15,14],[15,0]]},v:{width:16,points:[[2,14],[8,0],[-1,-1],[14,14],[8,0]]},w:{width:22,points:[[3,14],[7,0],[-1,-1],[11,14],[7,0],[-1,-1],[11,14],[15,0],[-1,-1],[19,14],[15,0]]},x:{width:17,points:[[3,14],[14,0],[-1,-1],[14,14],[3,0]]},y:{width:16,points:[[2,14],[8,0],[-1,-1],[14,14],[8,0],[6,-4],[4,-6],[2,-7],[1,-7]]},z:{width:17,points:[[14,14],[3,0],[-1,-1],[3,14],[14,14],[-1,-1],[3,0],[14,0]]},"{":{width:14,points:[[9,25],[7,24],[6,23],[5,21],[5,19],[6,17],[7,16],[8,14],[8,12],[6,10],[-1,-1],[7,24],[6,22],[6,20],[7,18],[8,17],[9,15],[9,13],[8,11],[4,9],[8,7],[9,5],[9,3],[8,1],[7,0],[6,-2],[6,-4],[7,-6],[-1,-1],[6,8],[8,6],[8,4],[7,2],[6,1],[5,-1],[5,-3],[6,-5],[7,-6],[9,-7]]},"|":{width:8,points:[[4,25],[4,-7]]},"}":{width:14,points:[[5,25],[7,24],[8,23],[9,21],[9,19],[8,17],[7,16],[6,14],[6,12],[8,10],[-1,-1],[7,24],[8,22],[8,20],[7,18],[6,17],[5,15],[5,13],[6,11],[10,9],[6,7],[5,5],[5,3],[6,1],[7,0],[8,-2],[8,-4],[7,-6],[-1,-1],[8,8],[6,6],[6,4],[7,2],[8,1],[9,-1],[9,-3],[8,-5],[7,-6],[5,-7]]},"~":{width:24,points:[[3,6],[3,8],[4,11],[6,12],[8,12],[10,11],[14,8],[16,7],[18,7],[20,8],[21,10],[-1,-1],[3,8],[4,10],[6,11],[8,11],[10,10],[14,7],[16,6],[18,6],[20,7],[21,10],[21,12]]}};function ki(t={}){var e=t.origin||[0,0,0],i=e[0],s=e[1],r=e[2],o=t.size||1,a=[],n=[],l=t.text;m.isNumeric(l)&&(l=""+l);for(var h,c,u,d,p,_,f,g,v,b=(l||"").split("\n"),P=0,y=0,M=.04,x=0;x<b.length;x++){h=0,u=(c=b[x]).length;for(var w=0;w<u;w++)if(d=Ii[c.charAt(w)]){p=1,_=-1,f=-1,g=d.points.length;for(var E=0;E<g;E++)-1!==(v=d.points[E])[0]||-1!==v[1]?(a.push(h+v[0]*o*M+i),a.push(y+v[1]*o*M+s),a.push(0+r),-1===_?_=P:(-1===f||(_=f),f=P),P++,p?p=!1:(n.push(_),n.push(f))):p=1;h+=d.width*M*o}y-=35*M*o}return m.apply(t,{primitive:"lines",positions:a,indices:n})}class Oi extends a{constructor(t,e){super("AxisGizmo",t,e=e||{});const i=t.scene.camera;e.canvasId||e.canvasElement||this.error("Config expected: either 'canvasId' or 'canvasElement'");try{this._axisGizmoScene=new Ue(t,{canvasId:e.canvasId,canvasElement:e.canvasElement,transparent:!0})}catch(t){return void this.error(t)}const s=this._axisGizmoScene;s.clearLights(),new he(s,{color:[.45,.45,.5],intensity:.9}),new le(s,{dir:[-.5,.5,-.6],color:[.8,.8,.7],intensity:1,space:"view"}),new le(s,{dir:[.5,-.5,-.6],color:[.8,.8,.8],intensity:1,space:"view"});const r=s.camera;i.on("matrix",(function(){const t=i.eye,e=i.look,s=i.up,o=d.mulVec3Scalar(d.normalizeVec3(d.subVec3(t,e,[])),22);r.look=[0,0,0],r.eye=o,r.up=s}));const o=new xe(s,Fi({radiusTop:.01,radiusBottom:.6,height:1.7,radialSegments:20,heightSegments:1,openEnded:!1})),a=new xe(s,Fi({radiusTop:.2,radiusBottom:.2,height:4.5,radialSegments:20,heightSegments:1,openEnded:!1})),n=new Se(s,{diffuse:[1,.3,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),l=new Se(s,{emissive:[1,.3,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),h=new Se(s,{diffuse:[.3,1,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),c=new Se(s,{emissive:[.3,1,.3],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),u=new Se(s,{diffuse:[.3,.3,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),p=new Se(s,{emissive:[.3,.3,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),_=new Se(s,{diffuse:[.5,.5,.5],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2});this._meshes=[new Ri(s,{geometry:new xe(s,Ni({radius:9,heightSegments:60,widthSegments:60})),material:new Se(s,{diffuse:[0,0,0],emissive:[.1,.1,.1],ambient:[.1,.1,.2],specular:[0,0,0],alpha:.4,alphaMode:"blend",frontface:"cw"}),pickable:!1,collidable:!1,visible:!1!==e.visible}),new Ri(s,{geometry:new xe(s,Ni({radius:1})),material:_,pickable:!1,collidable:!1,visible:!1!==e.visible}),new Ri(s,{geometry:o,material:n,pickable:!1,collidable:!1,visible:!1!==e.visible,position:[5,0,0],rotation:[0,0,-90]}),new Ri(s,{geometry:a,material:n,pickable:!1,collidable:!1,visible:!1!==e.visible,position:[2,0,0],rotation:[0,0,90]}),new Ri(s,{geometry:new xe(s,ki({text:"X",size:1.5})),material:l,pickable:!1,collidable:!1,visible:!1!==e.visible,position:[7,0,0],billboard:"spherical"}),new Ri(s,{geometry:o,material:h,pickable:!1,collidable:!1,visible:!1!==e.visible,position:[0,5,0]}),new Ri(s,{geometry:a,material:h,pickable:!1,collidable:!1,visible:!1!==e.visible,position:[0,2,0]}),new Ri(s,{geometry:new xe(s,ki({text:"Y",size:1.5})),material:c,pickable:!1,collidable:!1,visible:!1!==e.visible,position:[0,7,0],billboard:"spherical"}),new Ri(s,{geometry:o,material:u,pickable:!1,collidable:!1,visible:!1!==e.visible,position:[0,0,5],rotation:[90,0,0]}),new Ri(s,{geometry:a,material:u,pickable:!1,collidable:!1,visible:!1!==e.visible,position:[0,0,2],rotation:[90,0,0]}),new Ri(s,{geometry:new xe(s,ki({text:"Z",size:1.5})),material:p,pickable:!1,collidable:!1,visible:!1!==e.visible,position:[0,0,7],billboard:"spherical"})]}setVisible(t){for(let e=0;e<this._meshes.length;e++)this._meshes[e].visible=t}destroy(){this._axisGizmoCanvas=null,this._axisGizmoScene.destroy(),this._axisGizmoScene=null,super.destroy()}}class Vi extends S{get type(){return"SectionPlane"}constructor(t,e={}){super(t,e),this._state=new Gt({active:!0,pos:d.vec3(),dir:d.vec3(),dist:0}),this.active=e.active,this.pos=e.pos,this.dir=e.dir,this.scene._sectionPlaneCreated(this)}set active(t){this._state.active=!1!==t,this.glRedraw(),this.fire("active",this._state.active)}get active(){return this._state.active}set pos(t){this._state.pos.set(t||[0,0,0]),this._state.dist=-d.dotVec3(this._state.pos,this._state.dir),this.fire("pos",this._state.pos)}get pos(){return this._state.pos}set dir(t){this._state.dir.set(t||[0,0,-1]),this._state.dist=-d.dotVec3(this._state.pos,this._state.dir),this.glRedraw(),this.fire("dir",this._state.dir)}get dir(){return this._state.dir}get dist(){return this._state.dist}flipDir(){const t=this._state.dir;t[0]*=-1,t[1]*=-1,t[2]*=-1,this._state.dist=-d.dotVec3(this._state.pos,this._state.dir),this.fire("dir",this._state.dir),this.glRedraw()}destroy(){this._state.destroy(),this.scene._sectionPlaneDestroyed(this),super.destroy()}}const zi=d.vec3();class Ui extends a{constructor(t,e={}){super("BCFViewpoints",t,e),this.originatingSystem=e.originatingSystem||"xeokit.io",this.authoringTool=e.authoringTool||"xeokit.io"}getViewpoint(t={}){const e=this.viewer.scene,i=e.camera,s=e.realWorldOffset,r=!0===t.reverseClippingPlanes;let o={},a=d.normalizeVec3(d.subVec3(i.look,i.eye,d.vec3())),n=i.eye,l=i.up;i.yUp&&(a=Xi(a),n=Xi(n),l=Xi(l));const h=Gi(d.addVec3(n,s));"ortho"===i.projection?o.orthogonal_camera={camera_view_point:h,camera_direction:Gi(a),camera_up_vector:Gi(l),view_to_world_scale:i.ortho.scale}:o.perspective_camera={camera_view_point:h,camera_direction:Gi(a),camera_up_vector:Gi(l),field_of_view:i.perspective.fov};const c=e.sectionPlanes;for(let t in c)if(c.hasOwnProperty(t)){let e,a=c[t],n=a.pos;e=r?d.negateVec3(a.dir,d.vec3()):a.dir,i.yUp&&(n=Xi(n),e=Xi(e)),d.addVec3(n,s),n=Gi(n),e=Gi(e),o.clipping_planes||(o.clipping_planes=[]),o.clipping_planes.push({location:n,direction:e})}o.components={visibility:{view_setup_hints:{spaces_visible:!!t.spacesVisible,space_boundaries_visible:!!t.spaceBoundariesVisible,openings_visible:!!t.openingsVisible}}};const u=new Set(e.opacityObjectIds),p=new Set(e.xrayedObjectIds),_=new Set(e.colorizedObjectIds),f=Object.values(e.objects).filter((t=>u.has(t.id)||_.has(t.id)||p.has(t.id))).reduce(((t,i)=>{let s,r=function(t){let e="";return e+=Math.round(255*t[0]).toString(16).padStart(2,"0"),e+=Math.round(255*t[1]).toString(16).padStart(2,"0"),e+=Math.round(255*t[2]).toString(16).padStart(2,"0"),e}(i.colorize);i.xrayed?(s=0===e.xrayMaterial.fillAlpha&&0!==e.xrayMaterial.edgeAlpha?.1:e.xrayMaterial.fillAlpha,s=Math.round(255*s).toString(16).padStart(2,"0"),r=s+r):u.has(i.id)&&(s=Math.round(255*i.opacity).toString(16).padStart(2,"0"),r=s+r),t[r]||(t[r]=[]);const o=i.id,a=i.originalSystemId,n={ifc_guid:a,originating_system:this.originatingSystem};return a!==o&&(n.authoring_tool_id=o),t[r].push(n),t}),{}),g=Object.entries(f).map((([t,e])=>({color:t,components:e})));o.components.coloring=g;const m=e.objectIds,v=e.visibleObjects,b=e.visibleObjectIds,P=m.filter((t=>!v[t])),y=e.selectedObjectIds;return t.defaultInvisible||b.length<P.length?(o.components.visibility.exceptions=this._createBCFComponents(b),o.components.visibility.default_visibility=!1):(o.components.visibility.exceptions=this._createBCFComponents(P),o.components.visibility.default_visibility=!0),o.components.selection=this._createBCFComponents(y),!1!==t.snapshot&&(o.snapshot={snapshot_type:"png",snapshot_data:this.viewer.getSnapshot({format:"png"})}),o}_createBCFComponents(t){const e=this.viewer.scene,i=[];for(let s=0,r=t.length;s<r;s++){const r=t[s],o=e.objects[r];if(o){const t={ifc_guid:o.originalSystemId,originating_system:this.originatingSystem};o.originalSystemId!==r&&(t.authoring_tool_id=r),i.push(t)}}return i}setViewpoint(t,e={}){if(!t)return;const i=this.viewer,s=i.scene,r=s.camera,o=!1!==e.rayCast,a=!1!==e.immediate,n=!1!==e.reset,l=s.realWorldOffset,h=!0===e.reverseClippingPlanes;if(s.clearSectionPlanes(),t.clipping_planes&&t.clipping_planes.forEach((function(t){let e=ji(t.location,zi),i=ji(t.direction,zi);h&&d.negateVec3(i),d.subVec3(e,l),r.yUp&&(e=Wi(e),i=Wi(i)),new Vi(s,{pos:e,dir:i})})),n&&(s.setObjectsXRayed(s.xrayedObjectIds,!1),s.setObjectsHighlighted(s.highlightedObjectIds,!1),s.setObjectsSelected(s.selectedObjectIds,!1)),t.components){if(t.components.visibility){t.components.visibility.default_visibility?(s.setObjectsVisible(s.objectIds,!0),t.components.visibility.exceptions&&t.components.visibility.exceptions.forEach((t=>this._withBCFComponent(e,t,(t=>t.visible=!1))))):(s.setObjectsVisible(s.objectIds,!1),t.components.visibility.exceptions&&t.components.visibility.exceptions.forEach((t=>this._withBCFComponent(e,t,(t=>t.visible=!0)))));const r=t.components.visibility.view_setup_hints;r&&(!1===r.spaces_visible&&s.setObjectsVisible(i.metaScene.getObjectIDsByType("IfcSpace"),!1),!1===r.openings_visible&&s.setObjectsVisible(i.metaScene.getObjectIDsByType("IfcOpening"),!1),r.space_boundaries_visible)}t.components.selection&&(s.setObjectsSelected(s.selectedObjectIds,!1),t.components.selection.forEach((t=>this._withBCFComponent(e,t,(t=>t.selected=!0))))),t.components.coloring&&t.components.coloring.forEach((t=>{let i=t.color,s=0,r=!1;8===i.length&&(s=parseInt(i.substring(0,2),16)/256,s<=1&&s>=.95&&(s=1),i=i.substring(2),r=!0);const o=[parseInt(i.substring(0,2),16)/256,parseInt(i.substring(2,4),16)/256,parseInt(i.substring(4,6),16)/256];t.components.map((t=>this._withBCFComponent(e,t,(t=>{t.colorize=o,r&&(t.opacity=s)}))))}))}if(t.perspective_camera||t.orthogonal_camera){let n,h,c,u;if(t.perspective_camera?(n=ji(t.perspective_camera.camera_view_point,zi),h=ji(t.perspective_camera.camera_direction,zi),c=ji(t.perspective_camera.camera_up_vector,zi),r.perspective.fov=t.perspective_camera.field_of_view,u="perspective"):(n=ji(t.orthogonal_camera.camera_view_point,zi),h=ji(t.orthogonal_camera.camera_direction,zi),c=ji(t.orthogonal_camera.camera_up_vector,zi),r.ortho.scale=t.orthogonal_camera.view_to_world_scale,u="ortho"),d.subVec3(n,l),r.yUp&&(n=Wi(n),h=Wi(h),c=Wi(c)),o){const t=s.pick({pickSurface:!0,origin:n,direction:h});h=t?t.worldPos:d.addVec3(n,h,zi)}else h=d.addVec3(n,h,zi);a?(r.eye=n,r.look=h,r.up=c,r.projection=u):i.cameraFlight.flyTo({eye:n,look:h,up:c,duration:e.duration,projection:u})}}_withBCFComponent(t,e,i){const s=this.viewer,r=s.scene;if(e.authoring_tool_id&&e.originating_system===this.originatingSystem){const o=e.authoring_tool_id,a=r.objects[o];if(a)return void i(a);if(t.updateCompositeObjects){if(s.metaScene.metaObjects[o])return void r.withObjects(s.metaScene.getObjectIDsInSubtree(o),i)}}if(e.ifc_guid){const o=e.ifc_guid,a=r.objects[o];if(a)return void i(a);if(t.updateCompositeObjects){if(s.metaScene.metaObjects[o])return void r.withObjects(s.metaScene.getObjectIDsInSubtree(o),i)}Object.keys(r.models).forEach((e=>{const a=d.globalizeObjectId(e,o),n=r.objects[a];if(n)i(n);else if(t.updateCompositeObjects){if(s.metaScene.metaObjects[a])return void r.withObjects(s.metaScene.getObjectIDsInSubtree(a),i)}}))}}destroy(){super.destroy()}}function Gi(t){return{x:t[0],y:t[1],z:t[2]}}function ji(t,e){return(e=new Float64Array(3))[0]=t.x,e[1]=t.y,e[2]=t.z,e}function Xi(t){return new Float64Array([t[0],-t[2],t[1]])}function Wi(t){return new Float64Array([t[0],t[2],-t[1]])}var Hi=d.vec3();const Yi=(t,e,i,s)=>{var r=t-i,o=e-s;return Math.sqrt(r*r+o*o)};class Ki extends S{constructor(t,e={}){if(super(t.viewer.scene,e),this.plugin=t,this._container=e.container,!this._container)throw"config missing: container";this._eventSubs={};var i=this.plugin.viewer.scene;this._originMarker=new K(i,e.origin),this._targetMarker=new K(i,e.target),this._originWorld=d.vec3(),this._targetWorld=d.vec3(),this._wp=new Float64Array(24),this._vp=new Float64Array(24),this._pp=new Float64Array(24),this._cp=new Int16Array(8),this._xAxisLabelCulled=!1,this._yAxisLabelCulled=!1,this._zAxisLabelCulled=!1,this._color=e.color||this.plugin.defaultColor,this._originDot=new Z(this._container,{fillColor:this._color,zIndex:void 0!==t.zIndex?t.zIndex+1:void 0}),this._targetDot=new Z(this._container,{fillColor:this._color,zIndex:void 0!==t.zIndex?t.zIndex+1:void 0}),this._lengthWire=new q(this._container,{color:this._color,thickness:2,zIndex:t.zIndex}),this._xAxisWire=new q(this._container,{color:"red",thickness:1,zIndex:t.zIndex}),this._yAxisWire=new q(this._container,{color:"green",thickness:1,zIndex:t.zIndex}),this._zAxisWire=new q(this._container,{color:"blue",thickness:1,zIndex:t.zIndex}),this._lengthLabel=new Q(this._container,{fillColor:this._color,prefix:"",text:"",zIndex:void 0!==t.zIndex?t.zIndex+2:void 0}),this._xAxisLabel=new Q(this._container,{fillColor:"red",prefix:"X",text:"",zIndex:void 0!==t.zIndex?t.zIndex+2:void 0}),this._yAxisLabel=new Q(this._container,{fillColor:"green",prefix:"Y",text:"",zIndex:void 0!==t.zIndex?t.zIndex+2:void 0}),this._zAxisLabel=new Q(this._container,{fillColor:"blue",prefix:"Z",text:"",zIndex:void 0!==t.zIndex?t.zIndex+2:void 0}),this._wpDirty=!1,this._vpDirty=!1,this._cpDirty=!1,this._visible=!1,this._originVisible=!1,this._targetVisible=!1,this._wireVisible=!1,this._axisVisible=!1,this._originMarker.on("worldPos",(t=>{this._originWorld.set(t||[0,0,0]),this._wpDirty=!0,this._needUpdate(0)})),this._targetMarker.on("worldPos",(t=>{this._targetWorld.set(t||[0,0,0]),this._wpDirty=!0,this._needUpdate(0)})),this._onViewMatrix=i.camera.on("viewMatrix",(()=>{this._vpDirty=!0,this._needUpdate(0)})),this._onProjMatrix=i.camera.on("projMatrix",(()=>{this._cpDirty=!0,this._needUpdate()})),this._onCanvasBoundary=i.canvas.on("boundary",(()=>{this._cpDirty=!0,this._needUpdate(0)})),this._onMetricsUnits=i.metrics.on("units",(()=>{this._cpDirty=!0,this._needUpdate()})),this._onMetricsScale=i.metrics.on("scale",(()=>{this._cpDirty=!0,this._needUpdate()})),this._onMetricsOrigin=i.metrics.on("origin",(()=>{this._cpDirty=!0,this._needUpdate()})),this.approximate=e.approximate,this.visible=e.visible,this.originVisible=e.originVisible,this.targetVisible=e.targetVisible,this.wireVisible=e.wireVisible,this.axisVisible=e.axisVisible}_update(){if(!this._visible)return;const t=this.plugin.viewer.scene;this._wpDirty&&(this._wp[0]=this._originWorld[0],this._wp[1]=this._originWorld[1],this._wp[2]=this._originWorld[2],this._wp[3]=1,this._wp[4]=this._targetWorld[0],this._wp[5]=this._originWorld[1],this._wp[6]=this._originWorld[2],this._wp[7]=1,this._wp[8]=this._targetWorld[0],this._wp[9]=this._targetWorld[1],this._wp[10]=this._originWorld[2],this._wp[11]=1,this._wp[12]=this._targetWorld[0],this._wp[13]=this._targetWorld[1],this._wp[14]=this._targetWorld[2],this._wp[15]=1,this._wpDirty=!1,this._vpDirty=!0),this._vpDirty&&(d.transformPositions4(t.camera.viewMatrix,this._wp,this._vp),this._vp[3]=1,this._vp[7]=1,this._vp[11]=1,this._vp[15]=1,this._vpDirty=!1,this._cpDirty=!0);const e=this._originMarker.viewPos[2],i=this._targetMarker.viewPos[2];if(e>-.3||i>-.3)return this._xAxisLabel.setVisible(!1),this._yAxisLabel.setVisible(!1),this._zAxisLabel.setVisible(!1),this._lengthLabel.setVisible(!1),this._xAxisWire.setVisible(!1),this._yAxisWire.setVisible(!1),this._zAxisWire.setVisible(!1),this._lengthWire.setVisible(!1),this._originDot.setVisible(!1),void this._targetDot.setVisible(!1);if(this._cpDirty){d.transformPositions4(t.camera.project.matrix,this._vp,this._pp);var s=this._pp,r=this._cp,o=t.canvas.canvas.getBoundingClientRect();const e=this._container.getBoundingClientRect();var a=o.top-e.top,n=o.left-e.left,l=t.canvas.boundary,h=l[2],c=l[3],u=0;const i=this.plugin.viewer.scene.metrics,f=i.scale,g=i.units,m=i.unitsInfo[g].abbrev;for(var p=0,_=s.length;p<_;p+=4)r[u]=n+Math.floor((1+s[p+0]/s[p+3])*h/2),r[u+1]=a+Math.floor((1-s[p+1]/s[p+3])*c/2),u+=2;this._originDot.setPos(r[0],r[1]),this._targetDot.setPos(r[6],r[7]),this._lengthWire.setStartAndEnd(r[0],r[1],r[6],r[7]),this._xAxisWire.setStartAndEnd(r[0],r[1],r[2],r[3]),this._yAxisWire.setStartAndEnd(r[2],r[3],r[4],r[5]),this._zAxisWire.setStartAndEnd(r[4],r[5],r[6],r[7]),this._lengthLabel.setPosOnWire(r[0],r[1],r[6],r[7]),this._xAxisLabel.setPosOnWire(r[0],r[1],r[2],r[3]),this._yAxisLabel.setPosOnWire(r[2],r[3],r[4],r[5]),this._zAxisLabel.setPosOnWire(r[4],r[5],r[6],r[7]);const v=this._approximate?" ~ ":" = ";this._length=Math.abs(d.lenVec3(d.subVec3(this._targetWorld,this._originWorld,Hi))),this._lengthLabel.setText(v+(this._length*f).toFixed(2)+m);const b=Math.abs(Yi(r[0],r[1],r[2],r[3])),P=Math.abs(Yi(r[2],r[3],r[4],r[5])),y=Math.abs(Yi(r[4],r[5],r[6],r[7])),M=this.plugin.labelMinAxisLength;this._xAxisLabelCulled=b<M,this._yAxisLabelCulled=P<M,this._zAxisLabelCulled=y<M,this._xAxisLabelCulled?this._xAxisLabel.setVisible(!1):(this._xAxisLabel.setText(v+Math.abs((this._targetWorld[0]-this._originWorld[0])*f).toFixed(2)+m),this._xAxisLabel.setVisible(this.axisVisible)),this._yAxisLabelCulled?this._yAxisLabel.setVisible(!1):(this._yAxisLabel.setText(v+Math.abs((this._targetWorld[1]-this._originWorld[1])*f).toFixed(2)+m),this._yAxisLabel.setVisible(this.axisVisible)),this._zAxisLabelCulled?this._zAxisLabel.setVisible(!1):(this._zAxisLabel.setText(v+Math.abs((this._targetWorld[2]-this._originWorld[2])*f).toFixed(2)+m),this._zAxisLabel.setVisible(this.axisVisible)),this._originDot.setVisible(this._visible&&this._originVisible),this._targetDot.setVisible(this._visible&&this._targetVisible),this._xAxisWire.setVisible(this.axisVisible),this._yAxisWire.setVisible(this.axisVisible),this._zAxisWire.setVisible(this.axisVisible),this._lengthWire.setVisible(this.wireVisible),this._lengthLabel.setVisible(this.wireVisible),this._cpDirty=!1}}set approximate(t){t=!1!==t,this._approximate!==t&&(this._approximate=t,this._cpDirty=!0,this._needUpdate(0))}get approximate(){return this._approximate}get origin(){return this._originMarker}get target(){return this._targetMarker}get length(){this._update();const t=this.plugin.viewer.scene.metrics.scale;return this._length*t}get color(){return this._color}set color(t){this._color=t,this._originDot.setFillColor(t),this._targetDot.setFillColor(t),this._lengthWire.setColor(t),this._lengthLabel.setFillColor(t)}set visible(t){t=void 0!==t?Boolean(t):this.plugin.defaultVisible,this._visible=t,this._originDot.setVisible(this._visible&&this._originVisible),this._targetDot.setVisible(this._visible&&this._targetVisible),this._lengthWire.setVisible(this._visible&&this._wireVisible),this._lengthLabel.setVisible(this._visible&&this._wireVisible);var e=this._visible&&this._axisVisible;this._xAxisWire.setVisible(e),this._yAxisWire.setVisible(e),this._zAxisWire.setVisible(e),this._xAxisLabel.setVisible(e&&!this._xAxisLabelCulled),this._yAxisLabel.setVisible(e&&!this._yAxisLabelCulled),this._zAxisLabel.setVisible(e&&!this._zAxisLabelCulled)}get visible(){return this._visible}set originVisible(t){t=void 0!==t?Boolean(t):this.plugin.defaultOriginVisible,this._originVisible=t,this._originDot.setVisible(this._visible&&this._originVisible)}get originVisible(){return this._originVisible}set targetVisible(t){t=void 0!==t?Boolean(t):this.plugin.defaultTargetVisible,this._targetVisible=t,this._targetDot.setVisible(this._visible&&this._targetVisible)}get targetVisible(){return this._targetVisible}set axisVisible(t){t=void 0!==t?Boolean(t):this.plugin.defaultAxisVisible,this._axisVisible=t;var e=this._visible&&this._axisVisible;this._xAxisWire.setVisible(e),this._yAxisWire.setVisible(e),this._zAxisWire.setVisible(e),this._xAxisLabel.setVisible(e&&!this._xAxisLabelCulled),this._yAxisLabel.setVisible(e&&!this._yAxisLabelCulled),this._zAxisLabel.setVisible(e&&!this._zAxisLabelCulled)}get axisVisible(){return this._axisVisible}set wireVisible(t){t=void 0!==t?Boolean(t):this.plugin.defaultWireVisible,this._wireVisible=t;var e=this._visible&&this._wireVisible;this._lengthLabel.setVisible(e),this._lengthWire.setVisible(e)}get wireVisible(){return this._wireVisible}destroy(){const t=this.plugin.viewer.scene,e=t.metrics;this._onViewMatrix&&t.camera.off(this._onViewMatrix),this._onProjMatrix&&t.camera.off(this._onProjMatrix),this._onCanvasBoundary&&t.canvas.off(this._onCanvasBoundary),this._onMetricsUnits&&e.off(this._onMetricsUnits),this._onMetricsScale&&e.off(this._onMetricsScale),this._onMetricsOrigin&&e.off(this._onMetricsOrigin),this._originDot.destroy(),this._targetDot.destroy(),this._xAxisWire.destroy(),this._yAxisWire.destroy(),this._zAxisWire.destroy(),this._lengthLabel.destroy(),this._xAxisLabel.destroy(),this._yAxisLabel.destroy(),this._zAxisLabel.destroy(),this._lengthWire.destroy(),super.destroy()}}class qi extends S{constructor(t){super(t.viewer.scene),this.plugin=t,this._active=!1,this._currentDistMeasurement=null,this._currentDistMeasurementInitState={wireVisible:null,axisVisible:null,targetVisible:null},this._onHoverSurface=null,this._onHoverOff=null,this._onPickedNothing=null,this._onInputMouseDown=null,this._onInputMouseUp=null}get active(){return this._active}activate(){if(this._active)return;const t=this.plugin.viewer.cameraControl;let e=null;const i=d.vec3(),s=d.vec2(),r=this.plugin.viewer.scene.pickSurfacePrecisionEnabled;let o,a;this.startDot=new Z(this.plugin._container,{fillColor:this.plugin.defaultColor,zIndex:this.plugin.zIndex+1}),this._onHoverSurface=t.on("hoverSurface",(t=>{e=t.entity,i.set(t.worldPos),s.set(t.canvasPos),this.plugin.viewer.scene.canvas.canvas.style.cursor="pointer",this._currentDistMeasurement?(this._currentDistMeasurement.wireVisible=this._currentDistMeasurementInitState.wireVisible,this._currentDistMeasurement.axisVisible=this._currentDistMeasurementInitState.axisVisible,this._currentDistMeasurement.targetVisible=this._currentDistMeasurementInitState.targetVisible,this._currentDistMeasurement.target.entity=e,this._currentDistMeasurement.target.worldPos=i):this.startDot&&(this.startDot.setVisible(!0),this.startDot.setPos(t.canvasPos[0],t.canvasPos[1]))}));this._onInputMouseDown=this.plugin.viewer.scene.input.on("mousedown",(t=>{o=t[0],a=t[1]})),this._onInputMouseUp=this.plugin.viewer.scene.input.on("mouseup",(t=>{if(!(t[0]>o+5||t[0]<o-5||t[1]>a+5||t[1]<a-5))if(this.startDot&&(this.startDot.destroy(),this.startDot=null),this._currentDistMeasurement)if(e){if(r){const t=this.plugin.viewer.scene.pick({canvasPos:s,pickSurface:!0,pickSurfacePrecision:!0});t&&t.worldPos&&(this._currentDistMeasurement.target.worldPos=t.worldPos),this._currentDistMeasurement.approximate=!1}this.fire("measurementEnd",this._currentDistMeasurement),this._currentDistMeasurement=null}else this._currentDistMeasurement.destroy(),this.fire("measurementCancel",this._currentDistMeasurement),this._currentDistMeasurement=null;else if(e){if(r){const t=this.plugin.viewer.scene.pick({canvasPos:s,pickSurface:!0,pickSurfacePrecision:!0});t&&t.worldPos&&i.set(t.worldPos)}this._currentDistMeasurement=this.plugin.createMeasurement({id:d.createUUID(),origin:{entity:e,worldPos:i},target:{entity:e,worldPos:i},approximate:!0}),this._currentDistMeasurementInitState.axisVisible=this._currentDistMeasurement.axisVisible,this._currentDistMeasurementInitState.wireVisible=this._currentDistMeasurement.wireVisible,this._currentDistMeasurementInitState.targetVisible=this._currentDistMeasurement.targetVisible,this.fire("measurementStart",this._currentDistMeasurement)}})),this._onHoverOff=t.on("hoverOff",(t=>{this.startDot&&this.startDot.setVisible(!1),e=null,this._currentDistMeasurement&&(this._currentDistMeasurement.wireVisible=!1,this._currentDistMeasurement.targetVisible=!1,this._currentDistMeasurement.axisVisible=!1),this.plugin.viewer.scene.canvas.canvas.style.cursor="default"})),this._onPickedNothing=t.on("pickedNothing",(t=>{this._currentDistMeasurement&&(this._currentDistMeasurement.destroy(),this._currentDistMeasurement=null)})),this._active=!0}deactivate(){if(!this._active)return;this.startDot&&(this.startDot.destroy(),this.startDot=null),this.reset();const t=this.plugin.viewer.scene.input;t.off(this._onInputMouseDown),t.off(this._onInputMouseUp);const e=this.plugin.viewer.cameraControl;e.off(this._onHoverSurface),e.off(this._onHoverOff),e.off(this._onPickedNothing),this._currentDistMeasurement=null,this._active=!1}reset(){this._active&&this._currentDistMeasurement&&(this._currentDistMeasurement.destroy(),this._currentDistMeasurement=null)}destroy(){this.deactivate(),super.destroy()}}class Zi extends a{constructor(t,e={}){super("DistanceMeasurements",t),this._container=e.container||document.body,this._control=new qi(this),this._measurements={},this.labelMinAxisLength=e.labelMinAxisLength,this.defaultVisible=!1!==e.defaultVisible,this.defaultOriginVisible=!1!==e.defaultOriginVisible,this.defaultTargetVisible=!1!==e.defaultTargetVisible,this.defaultWireVisible=!1!==e.defaultWireVisible,this.defaultAxisVisible=!1!==e.defaultAxisVisible,this.defaultColor=void 0!==e.defaultColor?e.defaultColor:"#00BBFF",this.zIndex=e.zIndex}send(t,e){}get control(){return this._control}get measurements(){return this._measurements}set labelMinAxisLength(t){t<1&&(this.error("labelMinAxisLength must be >= 1; defaulting to 25"),t=25),this._labelMinAxisLength=t||25}get labelMinAxisLength(){return this._labelMinAxisLength}createMeasurement(t={}){this.viewer.scene.components[t.id]&&(this.error("Viewer scene component with this ID already exists: "+t.id),delete t.id);const e=t.origin,i=t.target,s=new Ki(this,{id:t.id,plugin:this,container:this._container,origin:{entity:e.entity,worldPos:e.worldPos},target:{entity:i.entity,worldPos:i.worldPos},visible:t.visible,wireVisible:t.wireVisible,originVisible:t.originVisible,targetVisible:t.targetVisible,color:t.color});return this._measurements[s.id]=s,s.on("destroyed",(()=>{delete this._measurements[s.id]})),this.fire("measurementCreated",s),s}destroyMeasurement(t){const e=this._measurements[t];e?(e.destroy(),this.fire("measurementDestroyed",e)):this.log("DistanceMeasurement not found: "+t)}clear(){const t=Object.keys(this._measurements);for(var e=0,i=t.length;e<i;e++)this.destroyMeasurement(t[e])}destroy(){this.clear(),super.destroy()}}class Qi{constructor(){}getMetaModel(t,e,i){m.loadJSON(t,(t=>{e(t)}),(function(t){i(t)}))}getGLTF(t,e,i){m.loadJSON(t,(t=>{e(t)}),(function(t){i(t)}))}getArrayBuffer(t,e,i,s){!function(t,e,i,s){var r=()=>{};i=i||r,s=s||r;const o=/^data:(.*?)(;base64)?,(.*)$/,a=e.match(o);if(a){const t=!!a[2];var n=a[3];n=window.decodeURIComponent(n),t&&(n=window.atob(n));try{const t=new ArrayBuffer(n.length),e=new Uint8Array(t);for(var l=0;l<n.length;l++)e[l]=n.charCodeAt(l);window.setTimeout((function(){i(t)}),0)}catch(t){window.setTimeout((function(){s(t)}),0)}}else{const r=function(t){var e=t.lastIndexOf("/");return 0!==e?t.substring(0,e+1):""}(t),o=r+e,a=new XMLHttpRequest;a.open("GET",o,!0),a.responseType="arraybuffer",a.onreadystatechange=function(){4===a.readyState&&(200===a.status?i(a.response):s("loadArrayBuffer error : "+a.response))},a.send(null)}}(t,e,(t=>{i(t)}),(function(t){s(t)}))}}class $i{constructor(t,e,i,s,r=null,o=0){this.model=t,this.object=null,this.parent=null,this.id=e,this.pickId=this.model.scene._renderer.getPickID(this),this.aabb=d.AABB3(),this._layer=r,this._portionId=o,this._color=[i[0],i[1],i[2],s],this._colorize=[i[0],i[1],i[2],s],this._colorizing=!1,this._transparent=s<255,this.numTriangles=0,this.origin=null}_finalize(t){this._layer.initFlags(this._portionId,t,this._transparent)}_finalize2(){this._layer.flushInitFlags&&this._layer.flushInitFlags()}_setVisible(t){this._layer.setVisible(this._portionId,t,this._transparent)}_setColor(t){this._color[0]=t[0],this._color[1]=t[1],this._color[2]=t[2],this._colorizing||this._layer.setColor(this._portionId,this._color,!1)}_setColorize(t){t?(this._colorize[0]=t[0],this._colorize[1]=t[1],this._colorize[2]=t[2],this._layer.setColor(this._portionId,this._colorize,false),this._colorizing=!0):(this._layer.setColor(this._portionId,this._color,false),this._colorizing=!1)}_setOpacity(t,e){const i=t<255,s=this._transparent!==i;this._color[3]=t,this._colorize[3]=t,this._transparent=i,this._colorizing?this._layer.setColor(this._portionId,this._colorize):this._layer.setColor(this._portionId,this._color),s&&this._layer.setTransparent(this._portionId,e,i)}_setOffset(t){this._layer.setOffset(this._portionId,t)}_setHighlighted(t){this._layer.setHighlighted(this._portionId,t,this._transparent)}_setXRayed(t){this._layer.setXRayed(this._portionId,t,this._transparent)}_setSelected(t){this._layer.setSelected(this._portionId,t,this._transparent)}_setEdges(t){this._layer.setEdges(this._portionId,t,this._transparent)}_setClippable(t){this._layer.setClippable(this._portionId,t,this._transparent)}_setCollidable(t){this._layer.setCollidable(this._portionId,t)}_setPickable(t){this._layer.setPickable(this._portionId,t,this._transparent)}_setCulled(t){this._layer.setCulled(this._portionId,t,this._transparent)}canPickTriangle(){return!1}drawPickTriangles(t,e){}pickTriangleSurface(t){}precisionRayPickSurface(t,e,i,s){return!!this._layer.precisionRayPickSurface&&this._layer.precisionRayPickSurface(this._portionId,t,e,i,s)}canPickWorldPos(){return!0}drawPickDepths(t){this.model.drawPickDepths(t)}drawPickNormals(t){this.model.drawPickNormals(t)}delegatePickedEntity(){return this.parent}_destroy(){this.model.scene._renderer.putPickID(this.pickId)}}const Ji=new class{constructor(){this._uint8Arrays={},this._float32Arrays={}}_clear(){this._uint8Arrays={},this._float32Arrays={}}getUInt8Array(t){let e=this._uint8Arrays[t];return e||(e=new Uint8Array(t),this._uint8Arrays[t]=e),e}getFloat32Array(t){let e=this._float32Arrays[t];return e||(e=new Float32Array(t),this._float32Arrays[t]=e),e}};let ts=0;const es=0,is=1,ss=2,rs=3,os=4,as=5,ns=6,ls=7,hs=8,cs=9,us=10,ds=11,ps=d.vec4(),_s=d.vec3();class fs{constructor(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const t=this._scene;return[t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(t,e,i){const s=this._scene,r=s.camera,o=e.model,a=s.canvas.gl,n=e._state,l=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?G(r.viewMatrix,l):r.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,o.worldNormalMatrix);const h=s._sectionPlanesState.sectionPlanes.length;if(h>0){const t=s._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,r=o.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e];if(s){const o=r.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,o?1:0),o){const i=t[e];if(l){const t=W(i.dist,i.dir,l,_s);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0),t.drawElements++}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let t=0,e=r.length;t<e;t++)switch(o=r[t],o.type){case"dir":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=null,this._uLightDir[t]=s.getLocation("lightDir"+t);break;case"point":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=null,this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t);break;case"spot":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=s.getLocation("lightDir"+t),this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t)}this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene,i=e.canvas.gl,s=this._program,r=e._lightsState.lights,o=e.camera.project;s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,e._lightsState.getAmbientColorAndIntensity());for(let t=0,e=r.length;t<e;t++){const e=r[t];this._uLightColor[t]&&i.uniform4f(this._uLightColor[t],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[t]&&(i.uniform3fv(this._uLightPos[t],e.pos),this._uLightAttenuation[t]&&i.uniform1f(this._uLightAttenuation[t],e.attenuation)),this._uLightDir[t]&&i.uniform3fv(this._uLightDir[t],e.dir)}if(this._withSAO){const s=e.sao;if(s.possible){const e=i.drawingBufferWidth,r=i.drawingBufferHeight;ps[0]=e,ps[1]=r,ps[2]=s.blendCutoff,ps[3]=s.blendFactor,i.uniform4fv(this._uSAOParams,ps),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,0)}}if(e.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState,i=t._lightsState,s=e.sectionPlanes.length>0;let r;const o=[];o.push("// Triangles batching draw vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("uniform int renderPass;"),o.push("attribute vec3 position;"),o.push("attribute vec3 normal;"),o.push("attribute vec4 color;"),o.push("attribute vec4 flags;"),o.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&o.push("attribute vec3 offset;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("varying float isPerspective;")),o.push("uniform vec4 lightAmbient;");for(let t=0,e=i.lights.length;t<e;t++)r=i.lights[t],"ambient"!==r.type&&(o.push("uniform vec4 lightColor"+t+";"),"dir"===r.type&&o.push("uniform vec3 lightDir"+t+";"),"point"===r.type&&o.push("uniform vec3 lightPos"+t+";"),"spot"===r.type&&(o.push("uniform vec3 lightPos"+t+";"),o.push("uniform vec3 lightDir"+t+";")));o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),s&&(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;")),o.push("varying vec4 vColor;"),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),o.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),o.push("float lambertian = 1.0;");for(let t=0,e=i.lights.length;t<e;t++)if(r=i.lights[t],"ambient"!==r.type){if("dir"===r.type)"view"===r.space?o.push("viewLightDir = normalize(lightDir"+t+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===r.type)"view"===r.space?o.push("viewLightDir = -normalize(lightPos"+t+" - viewPosition.xyz);"):o.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==r.type)continue;"view"===r.space?o.push("viewLightDir = normalize(lightDir"+t+");"):o.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);")}o.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),o.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}return o.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),o.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;")),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;")),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Triangles batching draw fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),s.push("   gl_FragColor            = vec4(vColor.rgb * ambient, 1.0);")):s.push("   gl_FragColor            = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const gs=d.vec4(),ms=d.vec3();class vs{constructor(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const t=this._scene;return[t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(t,e,i){const s=this._scene,r=s.camera,o=e.model,a=s.canvas.gl,n=e._state,l=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?G(r.viewMatrix,l):r.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix);const h=s._sectionPlanesState.sectionPlanes.length;if(h>0){const t=s._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,r=o.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e],o=r.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,o?1:0),o){const i=t[e];if(l){const t=W(i.dist,i.dir,l,ms);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let t=0,e=r.length;t<e;t++)switch(o=r[t],o.type){case"dir":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=null,this._uLightDir[t]=s.getLocation("lightDir"+t);break;case"point":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=null,this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t);break;case"spot":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=s.getLocation("lightDir"+t),this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t)}this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene,i=e.canvas.gl,s=this._program,r=e._lightsState.lights,o=e.camera.project;s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,o.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,e._lightsState.getAmbientColorAndIntensity());for(let t=0,e=r.length;t<e;t++){const e=r[t];this._uLightColor[t]&&i.uniform4f(this._uLightColor[t],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[t]&&(i.uniform3fv(this._uLightPos[t],e.pos),this._uLightAttenuation[t]&&i.uniform1f(this._uLightAttenuation[t],e.attenuation)),this._uLightDir[t]&&i.uniform3fv(this._uLightDir[t],e.dir)}if(this._withSAO){const s=e.sao;if(s.possible){const e=i.drawingBufferWidth,r=i.drawingBufferHeight;gs[0]=e,gs[1]=r,gs[2]=s.blendCutoff,gs[3]=s.blendFactor,i.uniform4fv(this._uSAOParams,gs),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,0)}}if(e.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching flat-shading draw vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._lightsState,i=t._sectionPlanesState,s=i.sectionPlanes.length>0,r=[];if(r.push("// Triangles batching flat-shading draw fragment shader"),r.push("#extension GL_OES_standard_derivatives : enable"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("#extension GL_EXT_frag_depth : enable"),r.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),r.push("precision highp float;"),r.push("precision highp int;"),r.push("#else"),r.push("precision mediump float;"),r.push("precision mediump int;"),r.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(r.push("varying float isPerspective;"),r.push("uniform float logDepthBufFC;"),r.push("varying float vFragDepth;")),this._withSAO&&(r.push("uniform sampler2D uOcclusionTexture;"),r.push("uniform vec4      uSAOParams;"),r.push("const float       packUpscale = 256. / 255.;"),r.push("const float       unpackDownScale = 255. / 256.;"),r.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),r.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),r.push("float unpackRGBToFloat( const in vec4 v ) {"),r.push("    return dot( v, unPackFactors );"),r.push("}")),s){r.push("varying vec4 vWorldPosition;"),r.push("varying vec4 vFlags2;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)r.push("uniform bool sectionPlaneActive"+t+";"),r.push("uniform vec3 sectionPlanePos"+t+";"),r.push("uniform vec3 sectionPlaneDir"+t+";")}r.push("uniform mat4 viewMatrix;"),r.push("uniform vec4 lightAmbient;");for(let t=0,i=e.lights.length;t<i;t++){const i=e.lights[t];"ambient"!==i.type&&(r.push("uniform vec4 lightColor"+t+";"),"dir"===i.type&&r.push("uniform vec3 lightDir"+t+";"),"point"===i.type&&r.push("uniform vec3 lightPos"+t+";"),"spot"===i.type&&(r.push("uniform vec3 lightPos"+t+";"),r.push("uniform vec3 lightDir"+t+";")))}if(r.push("varying vec4 vViewPosition;"),r.push("varying vec4 vColor;"),r.push("void main(void) {"),s){r.push("  bool clippable = (float(vFlags2.x) > 0.0);"),r.push("  if (clippable) {"),r.push("  float dist = 0.0;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)r.push("if (sectionPlaneActive"+t+") {"),r.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),r.push("}");r.push("  if (dist > 0.0) { "),r.push("      discard;"),r.push("  }"),r.push("}")}r.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),r.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),r.push("float lambertian = 1.0;"),r.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),r.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),r.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );");for(let t=0,i=e.lights.length;t<i;t++){const i=e.lights[t];if("ambient"!==i.type){if("dir"===i.type)"view"===i.space?r.push("viewLightDir = normalize(lightDir"+t+");"):r.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===i.type)"view"===i.space?r.push("viewLightDir = -normalize(lightPos"+t+" - viewPosition.xyz);"):r.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==i.type)continue;"view"===i.space?r.push("viewLightDir = normalize(lightDir"+t+");"):r.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);")}r.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),r.push("reflectedColor += lambertian * (lightColor"+t+".rgb * lightColor"+t+".a);")}}return r.push("vec4 fragColor =  vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),this._withSAO?(r.push("   float viewportWidth     = uSAOParams[0];"),r.push("   float viewportHeight    = uSAOParams[1];"),r.push("   float blendCutoff       = uSAOParams[2];"),r.push("   float blendFactor       = uSAOParams[3];"),r.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),r.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),r.push("   gl_FragColor            = vec4(fragColor.rgb * ambient, 1.0);")):r.push("   gl_FragColor            = fragColor;"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&r.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),r.push("}"),r}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const bs=new Float32Array([1,1,1]),Ps=d.vec3();class ys{constructor(t,e){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===as){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===rs){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===os){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,bs);const h=l?G(o.viewMatrix,l):o.viewMatrix;a.uniformMatrix4fv(this._uViewMatrix,!1,h),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Ps);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 color;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Triangles batching silhouette fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("varying float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("uniform vec4 color;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("gl_FragColor = color;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ms=d.vec3(),xs=new Float32Array([0,0,0,1]);class ws{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin;if(!this._program&&(this._allocate(e),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===us){const t=r.xrayMaterial._state,e=t.edgeColor,i=t.edgeAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===hs){const t=r.highlightMaterial._state,e=t.edgeColor,i=t.edgeAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===cs){const t=r.selectedMaterial._state,e=t.edgeColor,i=t.edgeAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,xs);a.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,o=s.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Ms);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.edgeIndicesBuf.bind(),a.drawElements(a.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uColor=i.getLocation("color"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=this._program,s=t.camera.project;if(i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(s.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry edges drawing vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Es=d.vec3();class As{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,o=s.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Es);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.edgeIndicesBuf.bind(),a.drawElements(a.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=this._program,s=t.camera.project;if(i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(s.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry edges drawing vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Cs=d.vec3();class Ss{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=t.pickViewMatrix||o.viewMatrix,c=l?G(h,l):h;if(a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,c),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Cs);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aPickColor&&this._aPickColor.bindArrayBuffer(n.pickColorsBuf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aPickColor=i.getAttribute("pickColor"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene.canvas.gl;this._program.bind(),e.uniform1i(this._uPickInvisible,t.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry picking vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 pickColor;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vPickColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry picking fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   gl_FragColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ds=d.vec3();class Ls{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin;this._program||this._allocate(),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible);const h=t.pickViewMatrix||o.viewMatrix,c=l?G(h,l):h;if(a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,c),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniform1f(this._uPickZNear,t.pickZNear),a.uniform1f(this._uPickZFar,t.pickZFar),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(t.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,e)}const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Ds);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching pick depth vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Triangles batching pick depth fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    gl_FragColor = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Bs=d.vec3();class Rs{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=t.pickViewMatrix||o.viewMatrix,c=l?G(h,l):h;if(a.uniformMatrix4fv(this._uViewMatrix,!1,c),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Bs);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(n.normalsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching pick normals vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vec3 worldNormal =  octDecode(normal.xy); "),i.push("      vWorldNormal = worldNormal;"),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Triangles batching pick normals fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec3 vWorldNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ts=d.vec3();class Fs{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,a=e._state,n=r.camera,l=e._state.origin;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uViewMatrix,!1,l?G(n.viewMatrix,l):n.viewMatrix),o.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,a=s.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e];if(s){const r=a.sectionPlanesActivePerLayer[i+e];if(o.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Ts);o.uniform3fv(s.pos,t)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aColor&&this._aColor.bindArrayBuffer(a.colorsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),a.indicesBuf.bind(),o.drawElements(o.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Triangles batching occlusion fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("      if (sectionPlaneActive"+t+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ns=d.vec3();class Is{constructor(t){this._scene=t,this._allocate(),this._hash=this._getHash()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,o=s.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Ns);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching depth vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Triangles batching depth fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("precision highp float;"),s.push("precision highp int;"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("const float   packUpScale = 256. / 255.;"),s.push("const float   unpackDownscale = 255. / 256.;"),s.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),s.push("const float   shiftRight8 = 1.0 / 256.;"),s.push("vec4 packDepthToRGBA( const in float v ) {"),s.push("    vec4 r = vec4( fract( v * packFactors ), v );"),s.push("    r.yzw -= r.xyz * shiftRight8;"),s.push("    return r * packUpScale;"),s.push("}"),s.push("varying vec2 vHighPrecisionZW;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),ht.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?s.push("    gl_FragColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "):s.push("    gl_FragColor = packDepthToRGBA(fragCoordZ); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null,_.memory.programs--}}const ks=d.vec3();class Os{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(e)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?G(o.viewMatrix,l):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const h=r._sectionPlanesState.sectionPlanes.length;if(h>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,o=s.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,ks);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uWorldNormalMatrix=i.getLocation("worldNormalMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uViewNormalMatrix=i.getLocation("viewNormalMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aNormal=i.getAttribute("normal"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2&&(this._aFlags2=i.getAttribute("flags2")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry normals vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition   = viewMatrix * worldPosition; "),i.push("      vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("      vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),e&&(i.push("      vWorldPosition  = worldPosition;"),i.push("      vFlags2         = flags2;")),i.push("      vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry normals fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Vs=d.vec3();class zs{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e){const i=this._scene,s=i.canvas.gl,r=e._state;this._program||this._allocate(),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),s.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),i.logarithmicDepthBufferEnabled&&s.uniform1f(this._uZFar,i.camera.project.far),this._aPosition.bindArrayBuffer(r.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(r.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(r.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(r.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(r.offsetsBuf),r.indicesBuf.bind();const o=i._sectionPlanesState.sectionPlanes.length;if(o>0){const t=i._sectionPlanesState.sectionPlanes,r=e.layerIndex*o,a=model.renderFlags,n=e._state.origin;for(let e=0;e<o;e++){const i=this._uSectionPlanes[e];if(i){const o=a.sectionPlanesActivePerLayer[r+e];if(s.uniform1i(i.active,o?1:0),o){const r=t[e];if(n){const t=W(r.dist,r.dir,n,Vs);s.uniform3fv(i.pos,t)}else s.uniform3fv(i.pos,r.pos);s.uniform3fv(i.dir,r.dir)}}}}s.drawElements(s.TRIANGLES,r.indicesBuf.numItems,r.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),t.logarithmicDepthBufferEnabled&&(this._uZFar=s.getLocation("zFar")),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2")}_bindProgram(t){const e=this._scene.canvas.gl;this._program.bind(),e.uniformMatrix4fv(this._uShadowViewMatrix,!1,t.shadowViewMatrix),e.uniformMatrix4fv(this._uShadowProjMatrix,!1,t.shadowProjMatrix),this._lastLightId=null}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Batched geometry shadow vertex shader"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("  bool visible        = (float(flags.x) > 0.0);"),i.push("  bool transparent    = ((float(color.a) / 255.0) < 1.0);"),i.push("  if (!visible || transparent) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = shadowViewMatrix * worldPosition; "),e&&(i.push("      vWorldPosition = worldPosition;"),i.push("      vFlags2 = flags2;")),i.push("      vViewPosition = viewPosition;"),i.push("      gl_Position = shadowProjMatrix * viewPosition;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene._sectionPlanesState,e=t.sectionPlanes.length>0,i=[];if(i.push("// Batched geometry shadow fragment shader"),i.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),i.push("precision highp float;"),i.push("precision highp int;"),i.push("#else"),i.push("precision mediump float;"),i.push("precision mediump int;"),i.push("#endif"),e){i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;");for(let e=0;e<t.sectionPlanes.length;e++)i.push("uniform bool sectionPlaneActive"+e+";"),i.push("uniform vec3 sectionPlanePos"+e+";"),i.push("uniform vec3 sectionPlaneDir"+e+";")}if(i.push("varying vec4 vViewPosition;"),i.push("vec4 encodeFloat( const in float v ) {"),i.push("  const vec4 bitShift = vec4(256 * 256 * 256, 256 * 256, 256, 1.0);"),i.push("  const vec4 bitMask = vec4(0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);"),i.push("  vec4 comp = fract(v * bitShift);"),i.push("  comp -= comp.xxyz * bitMask;"),i.push("  return comp;"),i.push("}"),i.push("void main(void) {"),e){i.push("  bool clippable = (float(vFlags2.x) > 0.0);"),i.push("  if (clippable) {"),i.push("      float dist = 0.0;");for(var s=0;s<t.sectionPlanes.length;s++)i.push("      if (sectionPlaneActive"+s+") {"),i.push("          dist += clamp(dot(-sectionPlaneDir"+s+".xyz, vWorldPosition.xyz - sectionPlanePos"+s+".xyz), 0.0, 1000.0);"),i.push("      }");i.push("      if (dist > 0.0) { discard; }"),i.push("  }")}return i.push("    gl_FragColor = encodeFloat( gl_FragCoord.z); "),i.push("}"),i}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Us=d.vec4(),Gs=d.vec3(),js={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};class Xs{constructor(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const t=this._scene;return[t.gammaOutput,t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(t,e,i){const s=this._scene,r=s.camera,o=e.model,a=s.canvas.gl,n=e._state,l=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?G(r.viewMatrix,l):r.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,r.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,o.worldNormalMatrix);const h=s._sectionPlanesState.sectionPlanes.length;if(h>0){const t=s._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,r=o.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e];if(s){const o=r.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,o?1:0),o){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Gs);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal&&this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aMetallicRoughness&&this._aMetallicRoughness.bindArrayBuffer(n.metallicRoughnessBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0),t.drawElements++}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let t=0,e=r.length;t<e;t++)switch(o=r[t],o.type){case"dir":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=null,this._uLightDir[t]=s.getLocation("lightDir"+t);break;case"point":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=null,this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t);break;case"spot":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=s.getLocation("lightDir"+t),this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aMetallicRoughness=s.getAttribute("metallicRoughness"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._withSAO&&(this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=ht.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,r=this._program,o=i._lightsState,a=o.lights,n=i.camera.project;r.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,n.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,i._lightsState.getAmbientColorAndIntensity());for(let t=0,e=a.length;t<e;t++){const e=a[t];this._uLightColor[t]&&s.uniform4f(this._uLightColor[t],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[t]&&(s.uniform3fv(this._uLightPos[t],e.pos),this._uLightAttenuation[t]&&s.uniform1f(this._uLightAttenuation[t],e.attenuation)),this._uLightDir[t]&&s.uniform3fv(this._uLightDir[t],e.dir)}if(o.reflectionMaps.length>0&&o.reflectionMaps[0].texture&&this._uReflectionMap&&(r.bindTexture(this._uReflectionMap,o.reflectionMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),o.lightMaps.length>0&&o.lightMaps[0].texture&&this._uLightMap&&(r.bindTexture(this._uLightMap,o.lightMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),this._withSAO){const r=i.sao;if(r.possible){const i=s.drawingBufferWidth,o=s.drawingBufferHeight;Us[0]=i,Us[1]=o,Us[2]=r.blendCutoff,Us[3]=r.blendFactor,s.uniform4fv(this._uSAOParams,Us),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++}}if(i.logarithmicDepthBufferEnabled){const t=2/(Math.log(n.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState,i=t._lightsState,s=e.sectionPlanes.length>0,r=e.clippingCaps,o=[];return o.push("// Triangles batching quality draw vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("uniform int renderPass;"),o.push("attribute vec3 position;"),o.push("attribute vec3 normal;"),o.push("attribute vec4 color;"),o.push("attribute vec2 metallicRoughness;"),o.push("attribute vec4 flags;"),o.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&o.push("attribute vec3 offset;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("varying float isPerspective;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("varying vec4 vViewPosition;"),o.push("varying vec3 vViewNormal;"),o.push("varying vec4 vColor;"),o.push("varying vec2 vMetallicRoughness;"),i.lightMaps.length>0&&o.push("varying vec3 vWorldNormal;"),s&&(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),r&&o.push("varying vec4 vClipPosition;")),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&o.push("worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 worldNormal =  worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),o.push("vec3 viewNormal = normalize((viewNormalMatrix * worldNormal).xyz);"),o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;"))),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;"),r&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const t=this._scene,e=t.gammaOutput,i=t._sectionPlanesState,s=t._lightsState,r=i.sectionPlanes.length>0,o=i.clippingCaps,a=[];a.push("// Triangles batching quality draw fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("varying float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;")),a.push("varying vec4 vViewPosition;"),a.push("varying vec3 vViewNormal;"),a.push("varying vec4 vColor;"),a.push("varying vec2 vMetallicRoughness;"),s.lightMaps.length>0&&a.push("varying vec3 vWorldNormal;"),a.push("uniform mat4 viewMatrix;"),s.reflectionMaps.length>0&&a.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&a.push("uniform samplerCube lightMap;"),a.push("uniform vec4 lightAmbient;");for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];"ambient"!==e.type&&(a.push("uniform vec4 lightColor"+t+";"),"dir"===e.type&&a.push("uniform vec3 lightDir"+t+";"),"point"===e.type&&a.push("uniform vec3 lightPos"+t+";"),"spot"===e.type&&(a.push("uniform vec3 lightPos"+t+";"),a.push("uniform vec3 lightDir"+t+";")))}if(this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBAToDepth( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),a.push("uniform float gammaFactor;"),a.push("vec4 linearToLinear( in vec4 value ) {"),a.push("  return value;"),a.push("}"),a.push("vec4 sRGBToLinear( in vec4 value ) {"),a.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),a.push("}"),a.push("vec4 gammaToLinear( in vec4 value) {"),a.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),a.push("}"),e&&(a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}")),r){a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),o&&a.push("varying vec4 vClipPosition;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)a.push("uniform bool sectionPlaneActive"+t+";"),a.push("uniform vec3 sectionPlanePos"+t+";"),a.push("uniform vec3 sectionPlaneDir"+t+";")}if(a.push("#define PI 3.14159265359"),a.push("#define RECIPROCAL_PI 0.31830988618"),a.push("#define RECIPROCAL_PI2 0.15915494"),a.push("#define EPSILON 1e-6"),a.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),a.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),a.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),a.push("}"),a.push("struct IncidentLight {"),a.push("   vec3 color;"),a.push("   vec3 direction;"),a.push("};"),a.push("struct ReflectedLight {"),a.push("   vec3 diffuse;"),a.push("   vec3 specular;"),a.push("};"),a.push("struct Geometry {"),a.push("   vec3 position;"),a.push("   vec3 viewNormal;"),a.push("   vec3 worldNormal;"),a.push("   vec3 viewEyeDir;"),a.push("};"),a.push("struct Material {"),a.push("   vec3    diffuseColor;"),a.push("   float   specularRoughness;"),a.push("   vec3    specularColor;"),a.push("   float   shine;"),a.push("};"),a.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),a.push("   float r = ggxRoughness + 0.0001;"),a.push("   return (2.0 / (r * r) - 2.0);"),a.push("}"),a.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),a.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),a.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),a.push("}"),s.reflectionMaps.length>0&&(a.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),a.push("   vec3 envMapColor = "+js[s.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),a.push("  return envMapColor;"),a.push("}")),a.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),a.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),a.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),a.push("}"),a.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   return 1.0 / ( gl * gv );"),a.push("}"),a.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   return 0.5 / max( gv + gl, EPSILON );"),a.push("}"),a.push("float D_GGX(const in float alpha, const in float dotNH) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),a.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float alpha = ( roughness * roughness );"),a.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),a.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),a.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),a.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),a.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),a.push("   vec3  F = F_Schlick( specularColor, dotLH );"),a.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),a.push("   float D = D_GGX( alpha, dotNH );"),a.push("   return F * (G * D);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),a.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),a.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),a.push("   vec4 r = roughness * c0 + c1;"),a.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),a.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),a.push("   return specularColor * AB.x + AB.y;"),a.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(a.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(a.push("   vec3 irradiance = "+js[s.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),a.push("   irradiance *= PI;"),a.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.diffuse +=  irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(a.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),a.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),a.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),a.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),a.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),a.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),a.push("}")),a.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),a.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),a.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),a.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),a.push("}"),a.push("void main(void) {"),r){a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)a.push("if (sectionPlaneActive"+t+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),a.push("}");o?(a.push("  if (dist > (0.002 * vClipPosition.w)) {"),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      gl_FragColor=vec4(1.0, 0.0, 0.0, 1.0);"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("  gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("  return;"),a.push("}")):(a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }")),a.push("}")}a.push("IncidentLight  light;"),a.push("Material       material;"),a.push("Geometry       geometry;"),a.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),a.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),a.push("float alpha = float(vColor.a) / 255.0;"),a.push("vec3  diffuseColor = rgb;"),a.push("float specularF0 = 1.0;"),a.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),a.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),a.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),a.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),a.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),a.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);"),a.push("geometry.position      = vViewPosition.xyz;"),a.push("geometry.viewNormal    = -normalize(vViewNormal);"),a.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&a.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&a.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?a.push("light.direction =  normalize(lightDir"+t+");"):a.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?a.push("light.direction =  normalize(lightPos"+t+" - vViewPosition.xyz);"):a.push("light.direction =  normalize((viewMatrix * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?a.push("light.direction =  normalize(lightDir"+t+");"):a.push("light.direction =  normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);")}a.push("light.color =  lightColor"+t+".rgb * lightColor"+t+".a;"),a.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return a.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular);"),a.push("vec4 fragColor;"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),a.push("   fragColor               = vec4(outgoingLight.rgb * ambient, alpha);")):a.push("   fragColor            = vec4(outgoingLight.rgb, alpha);"),e&&a.push("fragColor = linearToGamma(fragColor, gammaFactor);"),a.push("gl_FragColor = fragColor;"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ws=d.vec3();class Hs{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const h=t.pickViewMatrix||o.viewMatrix,c=l?G(h,l):h;if(a.uniformMatrix4fv(this._uViewMatrix,!1,c),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Ws);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles batching pick flat normals vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("varying vec4 vWorldPosition;"),e&&i.push("varying vec4 vFlags2;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("  } else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("      vWorldPosition = worldPosition;"),e&&i.push("      vFlags2 = flags2;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("  }"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Triangles batching pick flat normals fragment shader"),s.push("#extension GL_OES_standard_derivatives : enable"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),s.push("varying vec4 vWorldPosition;"),i){s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push("  gl_FragColor = vec4((worldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Ys{constructor(t){this._scene=t}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorQualityRenderer&&!this._colorQualityRenderer.getValid()&&(this._colorQualityRenderer.destroy(),this._colorQualityRenderer=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!1===this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new fs(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new fs(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new vs(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new vs(this._scene,!0)),this._flatColorRendererWithSAO}get colorQualityRenderer(){return this._colorQualityRenderer||(this._colorQualityRenderer=new Xs(this._scene,!1)),this._colorQualityRenderer}get colorQualityRendererWithSAO(){return this._colorQualityRendererWithSAO||(this._colorQualityRendererWithSAO=new Xs(this._scene,!0)),this._colorQualityRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new ys(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new Is(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new Os(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new ws(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new As(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Ss(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Rs(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Hs(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Ls(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Fs(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new zs(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorQualityRenderer&&this._colorQualityRenderer.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}const Ks={};const qs=ht.SUPPORTED_EXTENSIONS.OES_element_index_uint;class Zs{constructor(t=5e6){qs?t>5e6&&(t=5e6):t>65530&&(t=65530),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.metallicRoughness=[],this.normals=[],this.pickColors=[],this.flags=[],this.flags2=[],this.offsets=[],this.indices=[],this.edgeIndices=[]}}const Qs=d.mat4(),$s=d.mat4();function Js(t,e,i){const s=t.length,r=new Uint16Array(s),o=e[0],a=e[1],n=e[2],l=e[3]-o,h=e[4]-a,c=e[5]-n,u=65525,p=u/l,_=u/h,f=u/c,g=t=>t>=0?t:0;for(let e=0;e<s;e+=3)r[e+0]=Math.floor(g(t[e+0]-o)*p),r[e+1]=Math.floor(g(t[e+1]-a)*_),r[e+2]=Math.floor(g(t[e+2]-n)*f);return d.identityMat4(Qs),d.translationMat4v(e,Qs),d.identityMat4($s),d.scalingMat4v([l/u,h/u,c/u],$s),d.mulMat4(Qs,$s,i),r}function tr(t,e,i){let s=t[0]/(Math.abs(t[0])+Math.abs(t[1])+Math.abs(t[2])),r=t[1]/(Math.abs(t[0])+Math.abs(t[1])+Math.abs(t[2]));if(t[2]<0){let t=s,e=r;t=(1-Math.abs(r))*(s>=0?1:-1),e=(1-Math.abs(s))*(r>=0?1:-1),s=t,r=e}return new Int8Array([Math[e](127.5*s+(s<0?-1:0)),Math[i](127.5*r+(r<0?-1:0))])}function er(t,e,i,s){let r=t[e]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2])),o=t[e+1]/(Math.abs(t[e])+Math.abs(t[e+1])+Math.abs(t[e+2]));if(t[e+2]<0){let t=(1-Math.abs(o))*(r>=0?1:-1),e=(1-Math.abs(r))*(o>=0?1:-1);r=t,o=e}return new Int8Array([Math[i](127.5*r+(r<0?-1:0)),Math[s](127.5*o+(o<0?-1:0))])}function ir(t){let e=t[0],i=t[1];e/=e<0?127:128,i/=i<0?127:128;const s=1-Math.abs(e)-Math.abs(i);s<0&&(e=(1-Math.abs(i))*(e>=0?1:-1),i=(1-Math.abs(e))*(i>=0?1:-1));const r=Math.sqrt(e*e+i*i+s*s);return[e/r,i/r,s/r]}function sr(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}const rr=d.mat4(),or=d.mat4(),ar=d.vec4([0,0,0,1]),nr=d.vec4([0,0,0,1]),lr=d.vec4([0,0,0,1]),hr=d.OBB3(),cr=d.vec3(),ur=d.vec3(),dr=d.vec3(),pr=d.vec3(),_r=d.vec3(),fr=d.vec3(),gr=d.vec3();class mr{constructor(t,e){this.sortId="TrianglesBatchingLayer"+(e.solid?"-solid":"-surface")+(e.autoNormals?"-autonormals":"-normals"),this.layerIndex=e.layerIndex,this._batchingRenderers=function(t){const e=t.id;let i=Ks[e];return i||(i=new Ys(t),Ks[e]=i,i._compile(),t.on("compile",(()=>{i._compile()})),t.on("destroyed",(()=>{delete Ks[e],i._destroy()}))),i}(t.scene),this.model=t,this._buffer=new Zs(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Gt({positionsBuf:null,offsetsBuf:null,normalsBuf:null,colorsBuf:null,metallicRoughnessBuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,edgeIndicesBuf:null,positionsDecodeMatrix:d.mat4()}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=d.collapseAABB3(),this._portions=[],this._numVerts=0,this._finalized=!1,e.positionsDecodeMatrix?(this._state.positionsDecodeMatrix.set(e.positionsDecodeMatrix),this._preCompressed=!0):this._preCompressed=!1,e.origin&&(this._state.origin=d.vec3(e.origin)),this.aabb=d.collapseAABB3(),this.solid=!!e.solid}canCreatePortion(t,e){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+t<3*this._buffer.maxVerts&&this._buffer.indices.length+e<this._buffer.maxIndices}createPortion(t){if(this._finalized)throw"Already finalized";const e=t.positions,i=t.normals,s=t.indices,r=t.edgeIndices,o=t.color,a=t.metallic,n=t.roughness,l=t.colors,h=t.opacity,c=t.meshMatrix,u=t.worldMatrix,p=t.worldAABB,_=t.pickColor,f=this.model.scene,g=this._buffer,m=g.positions.length/3,v=e.length/3,b=e.length;if(this._preCompressed){for(let t=0,i=e.length;t<i;t++)g.positions.push(e[t]);const t=ve.getPositionsBounds(e),i=ve.decompressPosition(t.min,this._state.positionsDecodeMatrix,[]),s=ve.decompressPosition(t.max,this._state.positionsDecodeMatrix,[]);p[0]=i[0],p[1]=i[1],p[2]=i[2],p[3]=s[0],p[4]=s[1],p[5]=s[2],u&&(d.AABB3ToOBB3(p,hr),d.transformOBB3(u,hr),d.OBB3ToAABB3(hr,p))}else{const t=g.positions.length;for(let t=0,i=e.length;t<i;t++)g.positions.push(e[t]);if(c)for(let e=t,i=t+b;e<i;e+=3)ar[0]=g.positions[e+0],ar[1]=g.positions[e+1],ar[2]=g.positions[e+2],d.transformPoint4(c,ar,nr),g.positions[e+0]=nr[0],g.positions[e+1]=nr[1],g.positions[e+2]=nr[2],d.expandAABB3Point3(this._modelAABB,nr),u?(d.transformPoint4(u,nr,lr),d.expandAABB3Point3(p,lr)):d.expandAABB3Point3(p,nr);else for(let e=t,i=t+b;e<i;e+=3)ar[0]=g.positions[e+0],ar[1]=g.positions[e+1],ar[2]=g.positions[e+2],d.expandAABB3Point3(this._modelAABB,ar),u?(d.transformPoint4(u,ar,nr),d.expandAABB3Point3(p,nr)):d.expandAABB3Point3(p,ar)}if(this._state.origin){const t=this._state.origin;p[0]+=t[0],p[1]+=t[1],p[2]+=t[2],p[3]+=t[0],p[4]+=t[1],p[5]+=t[2]}if(d.expandAABB3(this.aabb,p),i&&i.length>0)if(this._preCompressed)for(let t=0,e=i.length;t<e;t++)g.normals.push(i[t]);else{const t=rr;c?d.inverseMat4(d.transposeMat4(c,or),t):d.identityMat4(t,t),function(t,e,i,s,r){let o,a,n,l,h,c,u=new Float32Array([0,0,0,0]),p=new Float32Array([0,0,0,0]);for(c=0;c<i;c+=3)u[0]=e[c],u[1]=e[c+1],u[2]=e[c+2],d.transformVec3(t,u,p),d.normalizeVec3(p,p),n=o=tr(p,"floor","floor"),a=ir(o),l=h=sr(p,a),o=tr(p,"ceil","floor"),a=ir(o),l=sr(p,a),l>h&&(n=o,h=l),o=tr(p,"floor","ceil"),a=ir(o),l=sr(p,a),l>h&&(n=o,h=l),o=tr(p,"ceil","ceil"),a=ir(o),l=sr(p,a),l>h&&(n=o,h=l),s[r+c+0]=n[0],s[r+c+1]=n[1],s[r+c+2]=0}(t,i,i.length,g.normals,g.normals.length)}if(l)for(let t=0,e=l.length;t<e;t+=3)g.colors.push(255*l[t]),g.colors.push(255*l[t+1]),g.colors.push(255*l[t+2]),g.colors.push(255);else if(o){const t=o[0],e=o[1],i=o[2],s=h,r=null!=a?a:0,l=null!=n?n:255;for(let o=0;o<v;o++)g.colors.push(t),g.colors.push(e),g.colors.push(i),g.colors.push(s),g.metallicRoughness.push(r),g.metallicRoughness.push(l)}if(s)for(let t=0,e=s.length;t<e;t++)g.indices.push(s[t]+m);if(r)for(let t=0,e=r.length;t<e;t++)g.edgeIndices.push(r[t]+m);{const t=g.pickColors.length;for(let e=t,i=t+4*v;e<i;e+=4)g.pickColors.push(_[0]),g.pickColors.push(_[1]),g.pickColors.push(_[2]),g.pickColors.push(_[3])}if(f.entityOffsetsEnabled)for(let t=0;t<v;t++)g.offsets.push(0),g.offsets.push(0),g.offsets.push(0);const P=this._portions.length,y={vertsBase:m,numVerts:v};return f.pickSurfacePrecisionEnabled&&(s&&(y.indices=s),f.entityOffsetsEnabled&&(y.offset=new Float32Array(3))),this._portions.push(y),this._numPortions++,this.model.numPortions++,this._numVerts+=y.numVerts,P}finalize(){if(this._finalized)return void this.model.error("Already finalized");const t=this._state,e=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0){const s=this._preCompressed?new Uint16Array(i.positions):Js(i.positions,this._modelAABB,t.positionsDecodeMatrix);if(t.positionsBuf=new Mt(e,e.ARRAY_BUFFER,s,s.length,3,e.STATIC_DRAW),this.model.scene.pickSurfacePrecisionEnabled)for(let t=0,e=this._portions.length;t<e;t++){const e=this._portions[t],i=3*e.vertsBase,r=i+3*e.numVerts;e.quantizedPositions=s.slice(i,r)}}if(i.normals.length>0){const s=new Int8Array(i.normals);let r=!0;t.normalsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.normals.length,3,e.STATIC_DRAW,r)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let r=!1;t.colorsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.colors.length,4,e.DYNAMIC_DRAW,r)}if(i.metallicRoughness.length>0){const s=new Uint8Array(i.metallicRoughness);let r=!1;t.metallicRoughnessBuf=new Mt(e,e.ARRAY_BUFFER,s,i.metallicRoughness.length,2,e.STATIC_DRAW,r)}if(i.positions.length>0){const s=i.positions.length/3*4,r=new Uint8Array(s),o=new Uint8Array(s);let a=!1,n=!0;t.flagsBuf=new Mt(e,e.ARRAY_BUFFER,r,r.length,4,e.DYNAMIC_DRAW,a),t.flags2Buf=new Mt(e,e.ARRAY_BUFFER,o,o.length,4,e.DYNAMIC_DRAW,n)}if(i.pickColors.length>0){const s=new Uint8Array(i.pickColors);let r=!1;t.pickColorsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.pickColors.length,4,e.STATIC_DRAW,r)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);t.offsetsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.offsets.length,3,e.DYNAMIC_DRAW)}const s=ht.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(i.indices.length>0){const r=s?new Uint32Array(i.indices):new Uint16Array(i.indices);t.indicesBuf=new Mt(e,e.ELEMENT_ARRAY_BUFFER,r,i.indices.length,1,e.STATIC_DRAW)}if(i.edgeIndices.length>0){const r=s?new Uint32Array(i.edgeIndices):new Uint16Array(i.edgeIndices);t.edgeIndicesBuf=new Mt(e,e.ELEMENT_ARRAY_BUFFER,r,i.edgeIndices.length,1,e.STATIC_DRAW)}this._buffer=null,this._finalized=!0}isEmpty(){return!this._state.indicesBuf}initFlags(t,e,i){e&D&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&N&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&F&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&I&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&R&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&k&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&B&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&L&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(t,e,i,true),this._setFlags2(t,e,true)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(t,e,i){if(!this._finalized)throw"Not finalized";e&D?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)}setHighlighted(t,e,i){if(!this._finalized)throw"Not finalized";e&N?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)}setXRayed(t,e,i){if(!this._finalized)throw"Not finalized";e&F?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)}setSelected(t,e,i){if(!this._finalized)throw"Not finalized";e&I?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)}setEdges(t,e,i){if(!this._finalized)throw"Not finalized";e&k?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)}setClippable(t,e){if(!this._finalized)throw"Not finalized";e&R?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)}setCulled(t,e,i){if(!this._finalized)throw"Not finalized";e&L?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e,i){if(!this._finalized)throw"Not finalized";e&B?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(t,e,i)}setColor(t,e){if(!this._finalized)throw"Not finalized";const i=t,s=this._portions[i],r=4*s.vertsBase,o=4*s.numVerts,a=this._scratchMemory.getUInt8Array(o),n=e[0],l=e[1],h=e[2],c=e[3];for(let t=0;t<o;t+=4)a[t+0]=n,a[t+1]=l,a[t+2]=h,a[t+3]=c;this._state.colorsBuf&&this._state.colorsBuf.setData(a,r,o)}setTransparent(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)}_setFlags(t,e,i,s=!1){if(!this._finalized)throw"Not finalized";const r=t,o=this._portions[r],a=4*o.vertsBase,n=4*o.numVerts,l=!!(e&D),h=!!(e&F),c=!!(e&N),u=!!(e&I),d=!!(e&L);let p,_;p=!l||d||h?es:i?ss:is,_=!l||d?es:u?os:c?rs:h?as:es;let f=0;f=!l||d?es:u?cs:c?hs:h?us:!!(e&k)?i?ls:ns:es;let g=l&&!d&&!!(e&B)?ds:es;if(s){this._deferredFlagValues||(this._deferredFlagValues=new Uint8Array(4*this._numVerts));for(let t=a,e=a+n;t<e;t+=4)this._deferredFlagValues[t+0]=p,this._deferredFlagValues[t+1]=_,this._deferredFlagValues[t+2]=f,this._deferredFlagValues[t+3]=g}else if(this._state.flagsBuf){const t=this._scratchMemory.getUInt8Array(n);for(let e=0;e<n;e+=4)t[e+0]=p,t[e+1]=_,t[e+2]=f,t[e+3]=g;this._state.flagsBuf.setData(t,a,n)}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}_setFlags2(t,e,i=!1){if(!this._finalized)throw"Not finalized";const s=t,r=this._portions[s],o=4*r.vertsBase,a=4*r.numVerts,n=e&R?255:0;if(i){this._setDeferredFlag2Values||(this._setDeferredFlag2Values=new Uint8Array(4*this._numVerts));for(let t=o,e=o+a;t<e;t+=4)this._setDeferredFlag2Values[t]=n}else if(this._state.flags2Buf){const t=this._scratchMemory.getUInt8Array(a);for(let e=0;e<a;e+=4)t[e+0]=n;this._state.flags2Buf.setData(t,o,a)}}_setDeferredFlags2(){this._setDeferredFlag2Values&&(this._state.flags2Buf.setData(this._setDeferredFlag2Values),this._setDeferredFlag2Values=null)}setOffset(t,e){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const i=t,s=this._portions[i],r=3*s.vertsBase,o=3*s.numVerts,a=this._scratchMemory.getFloat32Array(o),n=e[0],l=e[1],h=e[2];for(let t=0;t<o;t+=3)a[t+0]=n,a[t+1]=l,a[t+2]=h;this._state.offsetsBuf&&this._state.offsetsBuf.setData(a,r,o),this.model.scene.pickSurfacePrecisionEnabled&&(s.offset[0]=e[0],s.offset[1]=e[1],s.offset[2]=e[2])}drawColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),e.withSAO&&this.model.saoEnabled?e.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._batchingRenderers.colorQualityRendererWithSAO&&this._batchingRenderers.colorQualityRendererWithSAO.drawLayer(e,this,is):this._state.normalsBuf?this._batchingRenderers.colorRendererWithSAO&&this._batchingRenderers.colorRendererWithSAO.drawLayer(e,this,is):this._batchingRenderers.flatColorRendererWithSAO&&this._batchingRenderers.flatColorRendererWithSAO.drawLayer(e,this,is):e.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._batchingRenderers.colorQualityRenderer&&this._batchingRenderers.colorQualityRenderer.drawLayer(e,this,is):this._state.normalsBuf?this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(e,this,is):this._batchingRenderers.flatColorRenderer&&this._batchingRenderers.flatColorRenderer.drawLayer(e,this,is))}_updateBackfaceCull(t,e){const i=this.model.backfaces||!this.solid||t.sectioned;if(e.backfaces!==i){const t=e.gl;i?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),e.backfaces=i}}drawColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),e.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._batchingRenderers.colorQualityRenderer&&this._batchingRenderers.colorQualityRenderer.drawLayer(e,this,ss):this._state.normalsBuf?this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(e,this,ss):this._batchingRenderers.flatColorRenderer&&this._batchingRenderers.flatColorRenderer.drawLayer(e,this,ss))}drawDepth(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.depthRenderer&&this._batchingRenderers.depthRenderer.drawLayer(e,this,is))}drawNormals(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.normalsRenderer&&this._batchingRenderers.normalsRenderer.drawLayer(e,this,is))}drawSilhouetteXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,as))}drawSilhouetteHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,rs))}drawSilhouetteSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,os))}drawEdgesColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._batchingRenderers.edgesColorRenderer&&this._batchingRenderers.edgesColorRenderer.drawLayer(e,this,ns)}drawEdgesColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&0!==this._numTransparentLayerPortions&&this._batchingRenderers.edgesColorRenderer&&this._batchingRenderers.edgesColorRenderer.drawLayer(e,this,ls)}drawEdgesHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(e,this,hs)}drawEdgesSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(e,this,cs)}drawEdgesXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._batchingRenderers.edgesRenderer&&this._batchingRenderers.edgesRenderer.drawLayer(e,this,us)}drawOcclusion(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.occlusionRenderer&&this._batchingRenderers.occlusionRenderer.drawLayer(e,this,is))}drawShadow(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.shadowRenderer&&this._batchingRenderers.shadowRenderer.drawLayer(e,this,is))}drawPickMesh(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.pickMeshRenderer&&this._batchingRenderers.pickMeshRenderer.drawLayer(e,this,ds))}drawPickDepths(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._batchingRenderers.pickDepthRenderer&&this._batchingRenderers.pickDepthRenderer.drawLayer(e,this,ds))}drawPickNormals(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._state.normalsBuf?this._batchingRenderers.pickNormalsRenderer&&this._batchingRenderers.pickNormalsRenderer.drawLayer(e,this,ds):this._batchingRenderers.pickNormalsFlatRenderer&&this._batchingRenderers.pickNormalsFlatRenderer.drawLayer(e,this,ds))}precisionRayPickSurface(t,e,i,s,r){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;const o=this._state,a=this._portions[t];if(!a)return this.model.error("portion not found: "+t),!1;const n=a.quantizedPositions,l=a.indices,h=o.origin,c=a.offset,u=cr,p=ur;u.set(h?d.subVec3(e,h,dr):e),p.set(i),c&&d.subVec3(u,c),d.transformRay(this.model.worldNormalMatrix,u,p,u,p);const _=pr,f=_r,g=fr;let m=!1,v=0;const b=gr;for(let t=0,i=l.length;t<i;t+=3){const i=3*l[t],a=3*l[t+1],P=3*l[t+2];if(_[0]=n[i],_[1]=n[i+1],_[2]=n[i+2],f[0]=n[a],f[1]=n[a+1],f[2]=n[a+2],g[0]=n[P],g[1]=n[P+1],g[2]=n[P+2],d.decompressPosition(_,o.positionsDecodeMatrix),d.decompressPosition(f,o.positionsDecodeMatrix),d.decompressPosition(g,o.positionsDecodeMatrix),d.rayTriangleIntersect(u,p,_,f,g,b)){d.transformPoint3(this.model.worldMatrix,b,b),c&&d.addVec3(b,c),h&&d.addVec3(b,h);const t=Math.abs(d.lenVec3(d.subVec3(b,e,[])));(!m||t>v)&&(v=t,s.set(b),r&&d.triangleNormal(_,f,g,r),m=!0)}}return m&&r&&(d.transformVec3(this.model.worldNormalMatrix,r,r),d.normalizeVec3(r)),m}destroy(){const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.normalsBuf&&(t.normalsBuf.destroy(),t.normalsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.metallicRoughnessBuf&&(t.metallicRoughnessBuf.destroy(),t.metallicRoughnessBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.edgeIndicesBuf&&(t.edgeIndicesBuf.destroy(),t.edgeIndicessBuf=null),t.destroy()}}const vr=d.vec4(),br=d.vec3();class Pr{constructor(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const t=this._scene;return[t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,br);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(n.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(n.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(n.modelNormalMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),t.drawElements++,l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let t=0,e=r.length;t<e;t++)switch(o=r[t],o.type){case"dir":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=null,this._uLightDir[t]=s.getLocation("lightDir"+t);break;case"point":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=null,this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t);break;case"spot":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=s.getLocation("lightDir"+t),this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t)}this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aOffset=s.getAttribute("offset"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=s.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=s.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=s.getAttribute("modelNormalMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene,i=e.canvas.gl,s=e._lightsState.lights,r=e.camera.project;this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,e._lightsState.getAmbientColorAndIntensity());for(let t=0,e=s.length;t<e;t++){const e=s[t];this._uLightColor[t]&&i.uniform4f(this._uLightColor[t],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[t]&&(i.uniform3fv(this._uLightPos[t],e.pos),this._uLightAttenuation[t]&&i.uniform1f(this._uLightAttenuation[t],e.attenuation)),this._uLightDir[t]&&i.uniform3fv(this._uLightDir[t],e.dir)}if(this._withSAO){const s=e.sao;if(s.possible){const e=i.drawingBufferWidth,r=i.drawingBufferHeight;vr[0]=e,vr[1]=r,vr[2]=s.blendCutoff,vr[3]=s.blendFactor,i.uniform4fv(this._uSAOParams,vr),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,0)}}if(e.logarithmicDepthBufferEnabled){const t=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState,i=t._lightsState,s=e.sectionPlanes.length>0;let r,o,a;const n=[];for(n.push("// Instancing geometry drawing vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("#extension GL_EXT_frag_depth : enable"),n.push("uniform int renderPass;"),n.push("attribute vec3 position;"),n.push("attribute vec2 normal;"),n.push("attribute vec4 color;"),n.push("attribute vec4 flags;"),n.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&n.push("attribute vec3 offset;"),n.push("attribute vec4 modelMatrixCol0;"),n.push("attribute vec4 modelMatrixCol1;"),n.push("attribute vec4 modelMatrixCol2;"),n.push("attribute vec4 modelNormalMatrixCol0;"),n.push("attribute vec4 modelNormalMatrixCol1;"),n.push("attribute vec4 modelNormalMatrixCol2;"),n.push("uniform mat4 worldMatrix;"),n.push("uniform mat4 worldNormalMatrix;"),n.push("uniform mat4 viewMatrix;"),n.push("uniform mat4 viewNormalMatrix;"),n.push("uniform mat4 projMatrix;"),n.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(n.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&n.push("varying float vFragDepth;"),n.push("bool isPerspectiveMatrix(mat4 m) {"),n.push("    return (m[2][3] == - 1.0);"),n.push("}"),n.push("varying float isPerspective;")),n.push("uniform vec4 lightAmbient;"),r=0,o=i.lights.length;r<o;r++)a=i.lights[r],"ambient"!==a.type&&(n.push("uniform vec4 lightColor"+r+";"),"dir"===a.type&&n.push("uniform vec3 lightDir"+r+";"),"point"===a.type&&n.push("uniform vec3 lightPos"+r+";"),"spot"===a.type&&(n.push("uniform vec3 lightPos"+r+";"),n.push("uniform vec3 lightDir"+r+";")));for(n.push("vec3 octDecode(vec2 oct) {"),n.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),n.push("    if (v.z < 0.0) {"),n.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),n.push("    }"),n.push("    return normalize(v);"),n.push("}"),s&&(n.push("varying vec4 vWorldPosition;"),n.push("varying vec4 vFlags2;")),n.push("varying vec4 vColor;"),n.push("void main(void) {"),n.push("if (int(flags.x) != renderPass) {"),n.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),n.push("} else {"),n.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),n.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&n.push("      worldPosition.xyz = worldPosition.xyz + offset;"),n.push("vec4 viewPosition  = viewMatrix * worldPosition; "),n.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),n.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),n.push("vec3 viewNormal = normalize(vec4(viewNormalMatrix * worldNormal).xyz);"),n.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),n.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),n.push("float lambertian = 1.0;"),r=0,o=i.lights.length;r<o;r++)if(a=i.lights[r],"ambient"!==a.type){if("dir"===a.type)"view"===a.space?n.push("viewLightDir = normalize(lightDir"+r+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+r+", 0.0)).xyz);");else if("point"===a.type)"view"===a.space?n.push("viewLightDir = -normalize(lightPos"+r+" - viewPosition.xyz);"):n.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+r+", 0.0)).xyz);");else{if("spot"!==a.type)continue;"view"===a.space?n.push("viewLightDir = normalize(lightDir"+r+");"):n.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+r+", 0.0)).xyz);")}n.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),n.push("reflectedColor += lambertian * (lightColor"+r+".rgb * lightColor"+r+".a);")}return n.push("vec3 rgb = (vec3(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0));"),n.push("vColor =  vec4((lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedColor * rgb), float(color.a) / 255.0);"),n.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?n.push("vFragDepth = 1.0 + clipPos.w;"):(n.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),n.push("clipPos.z *= clipPos.w;")),n.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(n.push("vWorldPosition = worldPosition;"),n.push("vFlags2 = flags2;")),n.push("gl_Position = clipPos;"),n.push("}"),n.push("}"),n}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Instancing geometry drawing fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),this._withSAO&&(s.push("uniform sampler2D uOcclusionTexture;"),s.push("uniform vec4      uSAOParams;"),s.push("const float       packUpscale = 256. / 255.;"),s.push("const float       unpackDownScale = 255. / 256.;"),s.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),s.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),s.push("float unpackRGBToFloat( const in vec4 v ) {"),s.push("    return dot( v, unPackFactors );"),s.push("}")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { "),s.push("      discard;"),s.push("  }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),this._withSAO?(s.push("   float viewportWidth     = uSAOParams[0];"),s.push("   float viewportHeight    = uSAOParams[1];"),s.push("   float blendCutoff       = uSAOParams[2];"),s.push("   float blendFactor       = uSAOParams[3];"),s.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),s.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),s.push("   gl_FragColor            = vec4(vColor.rgb * ambient, 1.0);")):s.push("    gl_FragColor           = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const yr=d.vec4(),Mr=d.vec3();class xr{constructor(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const t=this._scene;return[t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,Mr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(let t=0,e=r.length;t<e;t++)switch(o=r[t],o.type){case"dir":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=null,this._uLightDir[t]=s.getLocation("lightDir"+t);break;case"point":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=null,this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t);break;case"spot":this._uLightColor[t]=s.getLocation("lightColor"+t),this._uLightPos[t]=s.getLocation("lightPos"+t),this._uLightDir[t]=s.getLocation("lightDir"+t),this._uLightAttenuation[t]=s.getLocation("lightAttenuation"+t)}this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aOffset=s.getAttribute("offset"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene,i=e.canvas.gl,s=e._lightsState.lights,r=e.camera.project;this._program.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),this._uLightAmbient&&i.uniform4fv(this._uLightAmbient,e._lightsState.getAmbientColorAndIntensity());for(let t=0,e=s.length;t<e;t++){const e=s[t];this._uLightColor[t]&&i.uniform4f(this._uLightColor[t],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[t]&&(i.uniform3fv(this._uLightPos[t],e.pos),this._uLightAttenuation[t]&&i.uniform1f(this._uLightAttenuation[t],e.attenuation)),this._uLightDir[t]&&i.uniform3fv(this._uLightDir[t],e.dir)}if(this._withSAO){const s=e.sao;if(s.possible){const e=i.drawingBufferWidth,r=i.drawingBufferHeight;yr[0]=e,yr[1]=r,yr[2]=s.blendCutoff,yr[3]=s.blendFactor,i.uniform4fv(this._uSAOParams,yr),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,0)}}if(e.logarithmicDepthBufferEnabled){const t=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry flat-shading drawing vertex shader"),i.push("#extension GL_OES_standard_derivatives : enable"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vViewPosition = viewPosition;"),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=t._lightsState;let s,r;const o=e.sectionPlanes.length>0,a=[];if(a.push("// Instancing geometry flat-shading drawing fragment shader"),a.push("#extension GL_OES_standard_derivatives : enable"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("varying float isPerspective;"),a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;")),this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBToFloat( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),o){a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)a.push("uniform bool sectionPlaneActive"+t+";"),a.push("uniform vec3 sectionPlanePos"+t+";"),a.push("uniform vec3 sectionPlaneDir"+t+";")}for(a.push("uniform mat4 viewMatrix;"),a.push("uniform vec4 lightAmbient;"),s=0,r=i.lights.length;s<r;s++){const t=i.lights[s];"ambient"!==t.type&&(a.push("uniform vec4 lightColor"+s+";"),"dir"===t.type&&a.push("uniform vec3 lightDir"+s+";"),"point"===t.type&&a.push("uniform vec3 lightPos"+s+";"),"spot"===t.type&&(a.push("uniform vec3 lightPos"+s+";"),a.push("uniform vec3 lightDir"+s+";")))}if(a.push("varying vec4 vViewPosition;"),a.push("varying vec4 vColor;"),a.push("void main(void) {"),o){a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)a.push("if (sectionPlaneActive"+t+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),a.push("}");a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }"),a.push("}")}for(a.push("vec3 reflectedColor = vec3(0.0, 0.0, 0.0);"),a.push("vec3 viewLightDir = vec3(0.0, 0.0, -1.0);"),a.push("float lambertian = 1.0;"),a.push("vec3 xTangent = dFdx( vViewPosition.xyz );"),a.push("vec3 yTangent = dFdy( vViewPosition.xyz );"),a.push("vec3 viewNormal = normalize( cross( xTangent, yTangent ) );"),s=0,r=i.lights.length;s<r;s++){const t=i.lights[s];if("ambient"!==t.type){if("dir"===t.type)"view"===t.space?a.push("viewLightDir = normalize(lightDir"+s+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+s+", 0.0)).xyz);");else if("point"===t.type)"view"===t.space?a.push("viewLightDir = -normalize(lightPos"+s+" - viewPosition.xyz);"):a.push("viewLightDir = -normalize((viewMatrix * vec4(lightPos"+s+", 0.0)).xyz);");else{if("spot"!==t.type)continue;"view"===t.space?a.push("viewLightDir = normalize(lightDir"+s+");"):a.push("viewLightDir = normalize((viewMatrix * vec4(lightDir"+s+", 0.0)).xyz);")}a.push("lambertian = max(dot(-viewNormal, viewLightDir), 0.0);"),a.push("reflectedColor += lambertian * (lightColor"+s+".rgb * lightColor"+s+".a);")}}return a.push("vec4 fragColor = vec4((lightAmbient.rgb * lightAmbient.a * vColor.rgb) + (reflectedColor * vColor.rgb), vColor.a);"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture2D(uOcclusionTexture, uv))) * blendFactor;"),a.push("   gl_FragColor            = vec4(fragColor.rgb * ambient, 1.0);")):a.push("    gl_FragColor           = fragColor;"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const wr=d.vec3();class Er{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(e.model.scene),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===as){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===rs){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===os){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,d.vec3([1,1,1]));a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,wr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uColor=s.getLocation("color"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing fill vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("uniform vec4 color;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Instancing fill fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("uniform vec4 color;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = color;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ar=d.vec3(),Cr=new Float32Array([0,0,0,1]);class Sr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(e),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===us){const t=r.xrayMaterial._state,e=t.edgeColor,i=t.edgeAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===hs){const t=r.highlightMaterial._state,e=t.edgeColor,i=t.edgeAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===cs){const t=r.selectedMaterial._state,e=t.edgeColor,i=t.edgeAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,Cr);a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,Ar);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags&&(this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1)),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.edgeIndicesBuf.bind(),l.drawElementsInstancedANGLE(a.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0),this._aFlags&&l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uColor=s.getLocation("color"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles instancing edges vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("uniform vec4 color;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(color.r, color.g, color.b, color.a);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Dr=d.vec3();class Lr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,Dr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags&&(this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1)),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.edgeIndicesBuf.bind(),l.drawElementsInstancedANGLE(a.LINES,n.edgeIndicesBuf.numItems,n.edgeIndicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0),this._aFlags&&l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Triangles instancing edges vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.z) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vColor = vec4(float(color.r*0.5) / 255.0, float(color.g*0.5) / 255.0, float(color.b*0.5) / 255.0, float(color.a) / 255.0);"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry edges drawing fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = vColor;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Br=d.vec3();class Rr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i);const c=t.pickViewMatrix||o.viewMatrix,u=h?G(c,h):c;if(a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPickColor.bindArrayBuffer(n.pickColorsBuf),l.vertexAttribDivisorANGLE(this._aPickColor.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind();const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*d,o=s.renderFlags;for(let e=0;e<d;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,Br);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aPickColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._uRenderPass=s.getLocation("renderPass"),this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aPickColor=s.getAttribute("pickColor"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene.canvas.gl;this._program.bind(),e.uniform1i(this._uPickInvisible,t.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry picking vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 pickColor;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vPickColor;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry picking fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Tr=d.vec3();class Fr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,a=e._state,n=this._instanceExt,l=e._state.origin;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram());const h=r.camera;o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,t.pickInvisible);const c=t.pickViewMatrix||h.viewMatrix,u=l?G(c,l):c;if(o.uniformMatrix4fv(this._uViewMatrix,!1,u),o.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),o.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),o.uniform1f(this._uPickZNear,t.pickZNear),o.uniform1f(this._uPickZFar,t.pickZFar),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(t.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,e)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*d,a=s.renderFlags;for(let e=0;e<d;e++){const s=this._uSectionPlanes[e];if(s){const r=a.sectionPlanesActivePerLayer[i+e];if(o.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Tr);o.uniform3fv(s.pos,t)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.indicesBuf.bind(),n.drawElementsInstancedANGLE(o.TRIANGLES,a.indicesBuf.numItems,a.indicesBuf.itemType,0,a.numInstances),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),n.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry depth vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vViewPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("  vWorldPosition = worldPosition;"),i.push("  vFlags2 = flags2;")),i.push("  vViewPosition = viewPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry depth fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    gl_FragColor = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Nr=d.vec3();class Ir{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible);const c=t.pickViewMatrix||o.viewMatrix,u=h?G(c,h):c;if(a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*d,o=s.renderFlags;for(let e=0;e<d;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,Nr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(n.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(n.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(n.modelNormalMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=s.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=s.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=s.getAttribute("modelNormalMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry normals vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec2 normal;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("attribute vec4 modelNormalMatrixCol0;"),i.push("attribute vec4 modelNormalMatrixCol1;"),i.push("attribute vec4 modelNormalMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vWorldNormal;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 worldNormal = vec3(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2));"),i.push("  vWorldNormal = worldNormal;"),e&&i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry normals fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec3 vWorldNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4((vWorldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const kr=d.vec3();class Or{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,kr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aColor&&(this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1)),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aColor&&l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Instancing occlusion fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Vr=d.vec3();class zr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,Vr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry depth drawing vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec2 vHighPrecisionZW;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("vHighPrecisionZW = gl_Position.zw;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Instancing geometry depth drawing fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("precision highp float;"),o.push("precision highp int;"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("varying float isPerspective;"),o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(ht.SUPPORTED_EXTENSIONS.WEBGL_depth_texture||(o.push("const float   packUpScale = 256. / 255.;"),o.push("const float   unpackDownscale = 255. / 256.;"),o.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),o.push("const float   shiftRight8 = 1.0 / 256.;"),o.push("vec4 packDepthToRGBA( const in float v ) {"),o.push("    vec4 r = vec4( fract( v * packFactors ), v );"),o.push("    r.yzw -= r.xyz * shiftRight8;"),o.push("    return r * packUpScale;"),o.push("}")),o.push("varying vec2 vHighPrecisionZW;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;"),ht.SUPPORTED_EXTENSIONS.WEBGL_depth_texture?o.push("    gl_FragColor = vec4(vec3(1.0 - fragCoordZ), 1.0); "):o.push("    gl_FragColor = packDepthToRGBA(fragCoordZ); "),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ur=d.vec3();class Gr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,Ur);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2&&(this._aFlags2=s.getAttribute("flags2")),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry normals drawing vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec3 normal;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 worldNormalMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 viewNormalMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),i.push("vec3 octDecode(vec2 oct) {"),i.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),i.push("    if (v.z < 0.0) {"),i.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),i.push("    }"),i.push("    return normalize(v);"),i.push("}"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec3 vViewNormal;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vec4 worldNormal    = worldNormalMatrix * vec4(octDecode(normal.xy), 0.0); "),i.push("  vec3 viewNormal     = normalize((viewNormalMatrix * worldNormal).xyz);"),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  vViewNormal = viewNormal;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Instancing geometry depth drawing fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const jr=d.vec3();class Xr{constructor(t){this._scene=t,this._hash=this._getHash(),this._lastLightId=null,this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e){const i=e.model,s=i.scene,r=s.canvas.gl,o=e._state,a=this._instanceExt;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),a.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aColor.bindArrayBuffer(o.colorsBuf),a.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),a.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),a.vertexAttribDivisorANGLE(this._aFlags2.location,1));const n=s._sectionPlanesState.sectionPlanes.length;if(n>0){const t=s._sectionPlanesState.sectionPlanes,o=e.layerIndex*n,a=i.renderFlags,l=e._state.origin;for(let e=0;e<n;e++){const i=this._uSectionPlanes[e];if(i){const s=a.sectionPlanesActivePerLayer[o+e];if(r.uniform1i(i.active,s?1:0),s){const s=t[e];if(l){const t=W(s.dist,s.dir,l,jr);r.uniform3fv(i.pos,t)}else r.uniform3fv(i.pos,s.pos);r.uniform3fv(i.dir,s.dir)}}}}o.indicesBuf.bind(),a.drawElementsInstancedANGLE(r.TRIANGLES,o.indicesBuf.numItems,o.indicesBuf.itemType,0,o.numInstances),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),a.vertexAttribDivisorANGLE(this._aColor.location,0),a.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&a.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2")}_bindProgram(t,e){const i=this._scene.canvas.gl;this._program.bind(),i.uniformMatrix4fv(this._uShadowViewMatrix,!1,t.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,t.shadowProjMatrix),this._lastLightId=null}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry shadow drawing vertex shader"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Instancing geometry depth drawing fragment shader"),t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Wr=d.vec4(),Hr=d.vec3(),Yr={linear:"linearToLinear",sRGB:"sRGBToLinear",gamma:"gammaToLinear"};class Kr{constructor(t,e){this._scene=t,this._withSAO=e,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){const t=this._scene;return[t.gammaOutput,t._lightsState.getHash(),t._sectionPlanesState.getHash(),this._withSAO?"sao":"nosao"].join(";")}drawLayer(t,e,i){const s=e.model,r=this._scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uViewNormalMatrix,!1,o.viewNormalMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uWorldNormalMatrix,!1,s.worldNormalMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,Hr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aModelNormalMatrixCol0.bindArrayBuffer(n.modelNormalMatrixCol0Buf),this._aModelNormalMatrixCol1.bindArrayBuffer(n.modelNormalMatrixCol1Buf),this._aModelNormalMatrixCol2.bindArrayBuffer(n.modelNormalMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aNormal.bindArrayBuffer(n.normalsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aMetallicRoughness.bindArrayBuffer(n.metallicRoughnessBuf),l.vertexAttribDivisorANGLE(this._aMetallicRoughness.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),t.drawElements++,l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelNormalMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aMetallicRoughness.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._lightsState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uWorldNormalMatrix=s.getLocation("worldNormalMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uViewNormalMatrix=s.getLocation("viewNormalMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uGammaFactor=s.getLocation("gammaFactor"),this._uLightAmbient=s.getLocation("lightAmbient"),this._uLightColor=[],this._uLightDir=[],this._uLightPos=[],this._uLightAttenuation=[];const r=i.lights;let o;for(var a=0,n=r.length;a<n;a++)switch(o=r[a],o.type){case"dir":this._uLightColor[a]=s.getLocation("lightColor"+a),this._uLightPos[a]=null,this._uLightDir[a]=s.getLocation("lightDir"+a);break;case"point":this._uLightColor[a]=s.getLocation("lightColor"+a),this._uLightPos[a]=s.getLocation("lightPos"+a),this._uLightDir[a]=null,this._uLightAttenuation[a]=s.getLocation("lightAttenuation"+a);break;case"spot":this._uLightColor[a]=s.getLocation("lightColor"+a),this._uLightPos[a]=s.getLocation("lightPos"+a),this._uLightDir[a]=s.getLocation("lightDir"+a),this._uLightAttenuation[a]=s.getLocation("lightAttenuation"+a)}i.reflectionMaps.length>0&&(this._uReflectionMap="reflectionMap"),i.lightMaps.length>0&&(this._uLightMap="lightMap"),this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aNormal=s.getAttribute("normal"),this._aColor=s.getAttribute("color"),this._aMetallicRoughness=s.getAttribute("metallicRoughness"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aOffset=s.getAttribute("offset"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._aModelNormalMatrixCol0=s.getAttribute("modelNormalMatrixCol0"),this._aModelNormalMatrixCol1=s.getAttribute("modelNormalMatrixCol1"),this._aModelNormalMatrixCol2=s.getAttribute("modelNormalMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uSAOParams=s.getLocation("uSAOParams"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=ht.MAX_TEXTURE_UNITS,i=this._scene,s=i.canvas.gl,r=i._lightsState,o=r.lights,a=i.camera.project;this._program.bind(),s.uniformMatrix4fv(this._uProjMatrix,!1,a.matrix),this._uLightAmbient&&s.uniform4fv(this._uLightAmbient,i._lightsState.getAmbientColorAndIntensity());for(let t=0,e=o.length;t<e;t++){const e=o[t];this._uLightColor[t]&&s.uniform4f(this._uLightColor[t],e.color[0],e.color[1],e.color[2],e.intensity),this._uLightPos[t]&&(s.uniform3fv(this._uLightPos[t],e.pos),this._uLightAttenuation[t]&&s.uniform1f(this._uLightAttenuation[t],e.attenuation)),this._uLightDir[t]&&s.uniform3fv(this._uLightDir[t],e.dir)}if(r.reflectionMaps.length>0&&r.reflectionMaps[0].texture&&this._uReflectionMap&&(this._program.bindTexture(this._uReflectionMap,r.reflectionMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),r.lightMaps.length>0&&r.lightMaps[0].texture&&this._uLightMap&&(this._program.bindTexture(this._uLightMap,r.lightMaps[0].texture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++),this._withSAO){const r=i.sao;if(r.possible){const i=s.drawingBufferWidth,o=s.drawingBufferHeight;Wr[0]=i,Wr[1]=o,Wr[2]=r.blendCutoff,Wr[3]=r.blendFactor,s.uniform4fv(this._uSAOParams,Wr),this._program.bindTexture(this._uOcclusionTexture,t.occlusionTexture,t.textureUnit),t.textureUnit=(t.textureUnit+1)%e,t.bindTexture++}}if(i.logarithmicDepthBufferEnabled){const t=2/(Math.log(a.far+1)/Math.LN2);s.uniform1f(this._uLogDepthBufFC,t)}this._uGammaFactor&&s.uniform1f(this._uGammaFactor,i.gammaFactor)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState,i=t._lightsState,s=e.sectionPlanes.length>0,r=e.clippingCaps,o=[];return o.push("// Instancing geometry quality drawing vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("uniform int renderPass;"),o.push("attribute vec3 position;"),o.push("attribute vec2 normal;"),o.push("attribute vec4 color;"),o.push("attribute vec2 metallicRoughness;"),o.push("attribute vec4 flags;"),o.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&o.push("attribute vec3 offset;"),o.push("attribute vec4 modelMatrixCol0;"),o.push("attribute vec4 modelMatrixCol1;"),o.push("attribute vec4 modelMatrixCol2;"),o.push("attribute vec4 modelNormalMatrixCol0;"),o.push("attribute vec4 modelNormalMatrixCol1;"),o.push("attribute vec4 modelNormalMatrixCol2;"),o.push("uniform mat4 worldMatrix;"),o.push("uniform mat4 worldNormalMatrix;"),o.push("uniform mat4 viewMatrix;"),o.push("uniform mat4 viewNormalMatrix;"),o.push("uniform mat4 projMatrix;"),o.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(o.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("varying float vFragDepth;"),o.push("bool isPerspectiveMatrix(mat4 m) {"),o.push("    return (m[2][3] == - 1.0);"),o.push("}"),o.push("varying float isPerspective;")),o.push("vec3 octDecode(vec2 oct) {"),o.push("    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));"),o.push("    if (v.z < 0.0) {"),o.push("        v.xy = (1.0 - abs(v.yx)) * vec2(v.x >= 0.0 ? 1.0 : -1.0, v.y >= 0.0 ? 1.0 : -1.0);"),o.push("    }"),o.push("    return normalize(v);"),o.push("}"),o.push("varying vec4 vViewPosition;"),o.push("varying vec3 vViewNormal;"),o.push("varying vec4 vColor;"),o.push("varying vec2 vMetallicRoughness;"),i.lightMaps.length>0&&o.push("varying vec3 vWorldNormal;"),s&&(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),r&&o.push("varying vec4 vClipPosition;")),o.push("void main(void) {"),o.push("if (int(flags.x) != renderPass) {"),o.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),o.push("} else {"),o.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),o.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&o.push("      worldPosition.xyz = worldPosition.xyz + offset;"),o.push("vec4 viewPosition  = viewMatrix * worldPosition; "),o.push("vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); "),o.push("vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 0.0);"),o.push("vec3 viewNormal = vec4(viewNormalMatrix * worldNormal).xyz;"),o.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?o.push("vFragDepth = 1.0 + clipPos.w;"):(o.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),o.push("clipPos.z *= clipPos.w;")),o.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),s&&(o.push("vWorldPosition = worldPosition;"),o.push("vFlags2 = flags2;"),r&&o.push("vClipPosition = clipPos;")),o.push("vViewPosition = viewPosition;"),o.push("vViewNormal = viewNormal;"),o.push("vColor = color;"),o.push("vMetallicRoughness = metallicRoughness;"),i.lightMaps.length>0&&o.push("vWorldNormal = worldNormal.xyz;"),o.push("gl_Position = clipPos;"),o.push("}"),o.push("}"),o}_buildFragmentShader(){const t=this._scene,e=t.gammaOutput,i=t._sectionPlanesState,s=t._lightsState,r=i.sectionPlanes.length>0,o=i.clippingCaps,a=[];a.push("// Instancing geometry quality drawing fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("#extension GL_EXT_frag_depth : enable"),a.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),a.push("precision highp float;"),a.push("precision highp int;"),a.push("#else"),a.push("precision mediump float;"),a.push("precision mediump int;"),a.push("#endif"),t.logarithmicDepthBufferEnabled&&(a.push("varying float isPerspective;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(a.push("uniform float logDepthBufFC;"),a.push("varying float vFragDepth;"))),this._withSAO&&(a.push("uniform sampler2D uOcclusionTexture;"),a.push("uniform vec4      uSAOParams;"),a.push("const float       packUpscale = 256. / 255.;"),a.push("const float       unpackDownScale = 255. / 256.;"),a.push("const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),a.push("const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );"),a.push("float unpackRGBAToDepth( const in vec4 v ) {"),a.push("    return dot( v, unPackFactors );"),a.push("}")),s.reflectionMaps.length>0&&a.push("uniform samplerCube reflectionMap;"),s.lightMaps.length>0&&a.push("uniform samplerCube lightMap;"),a.push("uniform vec4 lightAmbient;");for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];"ambient"!==e.type&&(a.push("uniform vec4 lightColor"+t+";"),"dir"===e.type&&a.push("uniform vec3 lightDir"+t+";"),"point"===e.type&&a.push("uniform vec3 lightPos"+t+";"),"spot"===e.type&&(a.push("uniform vec3 lightPos"+t+";"),a.push("uniform vec3 lightDir"+t+";")))}if(a.push("uniform float gammaFactor;"),a.push("vec4 linearToLinear( in vec4 value ) {"),a.push("  return value;"),a.push("}"),a.push("vec4 sRGBToLinear( in vec4 value ) {"),a.push("  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );"),a.push("}"),a.push("vec4 gammaToLinear( in vec4 value) {"),a.push("  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );"),a.push("}"),e&&(a.push("vec4 linearToGamma( in vec4 value, in float gammaFactor ) {"),a.push("  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );"),a.push("}")),r){a.push("varying vec4 vWorldPosition;"),a.push("varying vec4 vFlags2;"),o&&a.push("varying vec4 vClipPosition;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)a.push("uniform bool sectionPlaneActive"+t+";"),a.push("uniform vec3 sectionPlanePos"+t+";"),a.push("uniform vec3 sectionPlaneDir"+t+";")}if(a.push("varying vec4 vViewPosition;"),a.push("varying vec3 vViewNormal;"),a.push("varying vec4 vColor;"),a.push("varying vec2 vMetallicRoughness;"),s.lightMaps.length>0&&a.push("varying vec3 vWorldNormal;"),a.push("uniform mat4 viewMatrix;"),a.push("#define PI 3.14159265359"),a.push("#define RECIPROCAL_PI 0.31830988618"),a.push("#define RECIPROCAL_PI2 0.15915494"),a.push("#define EPSILON 1e-6"),a.push("#define saturate(a) clamp( a, 0.0, 1.0 )"),a.push("vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {"),a.push("   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );"),a.push("}"),a.push("struct IncidentLight {"),a.push("   vec3 color;"),a.push("   vec3 direction;"),a.push("};"),a.push("struct ReflectedLight {"),a.push("   vec3 diffuse;"),a.push("   vec3 specular;"),a.push("};"),a.push("struct Geometry {"),a.push("   vec3 position;"),a.push("   vec3 viewNormal;"),a.push("   vec3 worldNormal;"),a.push("   vec3 viewEyeDir;"),a.push("};"),a.push("struct Material {"),a.push("   vec3    diffuseColor;"),a.push("   float   specularRoughness;"),a.push("   vec3    specularColor;"),a.push("   float   shine;"),a.push("};"),a.push("float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {"),a.push("   float r = ggxRoughness + 0.0001;"),a.push("   return (2.0 / (r * r) - 2.0);"),a.push("}"),a.push("float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float maxMIPLevelScalar = float( maxMIPLevel );"),a.push("   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );"),a.push("   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );"),a.push("}"),s.reflectionMaps.length>0&&(a.push("vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {"),a.push("   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);"),a.push("   vec3 envMapColor = "+Yr[s.reflectionMaps[0].encoding]+"(textureCube(reflectionMap, reflectVec, mipLevel)).rgb;"),a.push("  return envMapColor;"),a.push("}")),a.push("vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {"),a.push("   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );"),a.push("   return ( 1.0 - specularColor ) * fresnel + specularColor;"),a.push("}"),a.push("float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   return 1.0 / ( gl * gv );"),a.push("}"),a.push("float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );"),a.push("   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );"),a.push("   return 0.5 / max( gv + gl, EPSILON );"),a.push("}"),a.push("float D_GGX(const in float alpha, const in float dotNH) {"),a.push("   float a2 = ( alpha * alpha );"),a.push("   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;"),a.push("   return RECIPROCAL_PI * a2 / ( denom * denom);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float alpha = ( roughness * roughness );"),a.push("   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );"),a.push("   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );"),a.push("   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );"),a.push("   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );"),a.push("   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );"),a.push("   vec3  F = F_Schlick( specularColor, dotLH );"),a.push("   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );"),a.push("   float D = D_GGX( alpha, dotNH );"),a.push("   return F * (G * D);"),a.push("}"),a.push("vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {"),a.push("   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));"),a.push("   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);"),a.push("   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);"),a.push("   vec4 r = roughness * c0 + c1;"),a.push("   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;"),a.push("   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;"),a.push("   return specularColor * AB.x + AB.y;"),a.push("}"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&(a.push("void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),s.lightMaps.length>0&&(a.push("   vec3 irradiance = "+Yr[s.lightMaps[0].encoding]+"(textureCube(lightMap, geometry.worldNormal)).rgb;"),a.push("   irradiance *= PI;"),a.push("   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;")),s.reflectionMaps.length>0&&(a.push("   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);"),a.push("   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);"),a.push("   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);"),a.push("   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);"),a.push("   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);"),a.push("   reflectedLight.specular     += radiance * specularBRDFContrib;")),a.push("}")),a.push("void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {"),a.push("   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));"),a.push("   vec3 irradiance = dotNL * incidentLight.color * PI;"),a.push("   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);"),a.push("   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);"),a.push("}"),a.push("void main(void) {"),r){a.push("  bool clippable = (float(vFlags2.x) > 0.0);"),a.push("  if (clippable) {"),a.push("  float dist = 0.0;");for(let t=0,e=i.sectionPlanes.length;t<e;t++)a.push("if (sectionPlaneActive"+t+") {"),a.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),a.push("}");o?(a.push("  if (dist > (0.002 * vClipPosition.w)) {"),a.push("      discard;"),a.push("  }"),a.push("  if (dist > 0.0) { "),a.push("      gl_FragColor=vec4(1.0, 0.0, 0.0, 1.0);"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("  gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("  return;"),a.push("}")):(a.push("  if (dist > 0.0) { "),a.push("      discard;"),a.push("  }")),a.push("}")}a.push("IncidentLight  light;"),a.push("Material       material;"),a.push("Geometry       geometry;"),a.push("ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));"),a.push("vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));"),a.push("float alpha = float(vColor.a) / 255.0;"),a.push("vec3  diffuseColor = rgb;"),a.push("float specularF0 = 1.0;"),a.push("float metallic = float(vMetallicRoughness.r) / 255.0;"),a.push("float roughness = float(vMetallicRoughness.g) / 255.0;"),a.push("float dielectricSpecular = 0.16 * specularF0 * specularF0;"),a.push("material.diffuseColor      = diffuseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);"),a.push("material.specularRoughness = clamp(roughness, 0.04, 1.0);"),a.push("material.specularColor     = mix(vec3(dielectricSpecular), diffuseColor, metallic);"),a.push("geometry.position      = vViewPosition.xyz;"),a.push("geometry.viewNormal    = -normalize(vViewNormal);"),a.push("geometry.viewEyeDir    = normalize(vViewPosition.xyz);"),s.lightMaps.length>0&&a.push("geometry.worldNormal   = normalize(vWorldNormal);"),(s.lightMaps.length>0||s.reflectionMaps.length>0)&&a.push("computePBRLightMapping(geometry, material, reflectedLight);");for(let t=0,e=s.lights.length;t<e;t++){const e=s.lights[t];if("ambient"!==e.type){if("dir"===e.type)"view"===e.space?a.push("light.direction = normalize(lightDir"+t+");"):a.push("light.direction = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);");else if("point"===e.type)"view"===e.space?a.push("light.direction = normalize(lightPos"+t+" - vViewPosition.xyz);"):a.push("light.direction = normalize((viewMatrix * vec4(lightPos"+t+", 0.0)).xyz);");else{if("spot"!==e.type)continue;"view"===e.space?a.push("light.direction = normalize(lightDir"+t+");"):a.push("light.direction = normalize((viewMatrix * vec4(lightDir"+t+", 0.0)).xyz);")}a.push("light.color =  lightColor"+t+".rgb * lightColor"+t+".a;"),a.push("computePBRLighting(light, geometry, material, reflectedLight);")}}return a.push("vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular);"),a.push("vec4 fragColor;"),this._withSAO?(a.push("   float viewportWidth     = uSAOParams[0];"),a.push("   float viewportHeight    = uSAOParams[1];"),a.push("   float blendCutoff       = uSAOParams[2];"),a.push("   float blendFactor       = uSAOParams[3];"),a.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),a.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),a.push("   fragColor            = vec4(outgoingLight.rgb * ambient, alpha);")):a.push("   fragColor            = vec4(outgoingLight.rgb, alpha);"),e&&a.push("fragColor = linearToGamma(fragColor, gammaFactor);"),a.push("gl_FragColor = fragColor;"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&a.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),a.push("}"),a}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const qr=d.vec3();class Zr{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible);const c=t.pickViewMatrix||o.viewMatrix,u=h?G(c,h):c;if(a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*d,o=s.renderFlags;for(let e=0;e<d;e++){const s=this._uSectionPlanes[e],r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,qr);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.TRIANGLES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry normals vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform bool pickInvisible;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;"),i.push("bool isPerspectiveMatrix(mat4 m) {"),i.push("    return (m[2][3] == - 1.0);"),i.push("}"),i.push("varying float isPerspective;")),e&&i.push("varying vec4 vFlags2;"),i.push("varying vec4 vWorldPosition;"),i.push("void main(void) {"),i.push("if (int(flags.w) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("  vWorldPosition = worldPosition;"),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;")),i.push("isPerspective = float (isPerspectiveMatrix(projMatrix));")),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Batched geometry normals fragment shader"),s.push("#extension GL_OES_standard_derivatives : enable"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("varying float isPerspective;"),s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),s.push("varying vec4 vWorldPosition;"),i){s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec3 vWorldNormal;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("if (sectionPlaneActive"+r+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("    gl_FragDepthEXT = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("  vec3 xTangent = dFdx( vWorldPosition.xyz );"),s.push("  vec3 yTangent = dFdy( vWorldPosition.xyz );"),s.push("  vec3 worldNormal = normalize( cross( xTangent, yTangent ) );"),s.push("  gl_FragColor = vec4((worldNormal * 0.5) + 0.5, 1.0);"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Qr{constructor(t){this._scene=t}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._colorRendererWithSAO&&!this._colorRendererWithSAO.getValid()&&(this._colorRendererWithSAO.destroy(),this._colorRendererWithSAO=null),this._flatColorRenderer&&!this._flatColorRenderer.getValid()&&(this._flatColorRenderer.destroy(),this._flatColorRenderer=null),this._flatColorRendererWithSAO&&!this._flatColorRendererWithSAO.getValid()&&(this._flatColorRendererWithSAO.destroy(),this._flatColorRendererWithSAO=null),this._colorQualityRenderer&&!this._colorQualityRenderer.getValid()&&(this._colorQualityRenderer.destroy(),this._colorQualityRenderer=null),this._colorQualityRendererWithSAO&&!this._colorQualityRendererWithSAO.getValid()&&(this._colorQualityRendererWithSAO.destroy(),this._colorQualityRendererWithSAO=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._normalsRenderer&&!this._normalsRenderer.getValid()&&(this._normalsRenderer.destroy(),this._normalsRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._edgesRenderer&&!this._edgesRenderer.getValid()&&(this._edgesRenderer.destroy(),this._edgesRenderer=null),this._edgesColorRenderer&&!this._edgesColorRenderer.getValid()&&(this._edgesColorRenderer.destroy(),this._edgesColorRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._pickNormalsRenderer&&!1===this._pickNormalsRenderer.getValid()&&(this._pickNormalsRenderer.destroy(),this._pickNormalsRenderer=null),this._pickNormalsFlatRenderer&&!this._pickNormalsFlatRenderer.getValid()&&(this._pickNormalsFlatRenderer.destroy(),this._pickNormalsFlatRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Pr(this._scene,!1)),this._colorRenderer}get colorRendererWithSAO(){return this._colorRendererWithSAO||(this._colorRendererWithSAO=new Pr(this._scene,!0)),this._colorRendererWithSAO}get flatColorRenderer(){return this._flatColorRenderer||(this._flatColorRenderer=new xr(this._scene,!1)),this._flatColorRenderer}get flatColorRendererWithSAO(){return this._flatColorRendererWithSAO||(this._flatColorRendererWithSAO=new xr(this._scene,!0)),this._flatColorRendererWithSAO}get colorQualityRenderer(){return this._colorQualityRenderer||(this._colorQualityRenderer=new Kr(this._scene,!1)),this._colorQualityRenderer}get colorQualityRendererWithSAO(){return this._colorQualityRendererWithSAO||(this._colorQualityRendererWithSAO=new Kr(this._scene,!0)),this._colorQualityRendererWithSAO}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Er(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new zr(this._scene)),this._depthRenderer}get normalsRenderer(){return this._normalsRenderer||(this._normalsRenderer=new Gr(this._scene)),this._normalsRenderer}get edgesRenderer(){return this._edgesRenderer||(this._edgesRenderer=new Sr(this._scene)),this._edgesRenderer}get edgesColorRenderer(){return this._edgesColorRenderer||(this._edgesColorRenderer=new Lr(this._scene)),this._edgesColorRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Rr(this._scene)),this._pickMeshRenderer}get pickNormalsRenderer(){return this._pickNormalsRenderer||(this._pickNormalsRenderer=new Ir(this._scene)),this._pickNormalsRenderer}get pickNormalsFlatRenderer(){return this._pickNormalsFlatRenderer||(this._pickNormalsFlatRenderer=new Zr(this._scene)),this._pickNormalsFlatRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new Fr(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Or(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new Xr(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._colorRendererWithSAO&&this._colorRendererWithSAO.destroy(),this._flatColorRenderer&&this._flatColorRenderer.destroy(),this._flatColorRendererWithSAO&&this._flatColorRendererWithSAO.destroy(),this._colorQualityRenderer&&this._colorQualityRenderer.destroy(),this._colorQualityRendererWithSAO&&this._colorQualityRendererWithSAO.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._normalsRenderer&&this._normalsRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._edgesRenderer&&this._edgesRenderer.destroy(),this._edgesColorRenderer&&this._edgesColorRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._pickNormalsRenderer&&this._pickNormalsRenderer.destroy(),this._pickNormalsFlatRenderer&&this._pickNormalsFlatRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}const $r={};const Jr=ht.SUPPORTED_EXTENSIONS.OES_element_index_uint,to=new Uint8Array(4),eo=d.vec4([0,0,0,1]),io=d.vec4([0,0,0,1]),so=d.vec4([0,0,0,1]),ro=new Float32Array(3),oo=d.vec3(),ao=d.vec3(),no=d.vec3(),lo=d.vec3(),ho=d.vec3(),co=d.vec3(),uo=d.vec3();class po{constructor(t,e){this.sortId="TrianglesInstancingLayer"+(e.solid?"-solid":"-surface")+(e.normals?"-normals":"-autoNormals"),this.layerIndex=e.layerIndex,this._instancingRenderers=function(t){const e=t.id;let i=$r[e];return i||(i=new Qr(t),$r[e]=i,i._compile(),t.on("compile",(()=>{i._compile()})),t.on("destroyed",(()=>{delete $r[e],i._destroy()}))),i}(t.scene),this.model=t,this._aabb=d.collapseAABB3();const i={positionsDecodeMatrix:d.mat4(),numInstances:0,obb:d.OBB3(),origin:null},s=!!e.positionsDecodeMatrix,r=this.model.scene.pickSurfacePrecisionEnabled,o=this.model.scene.canvas.gl;if(e.positions)if(s){const t=!1;i.positionsBuf=new Mt(o,o.ARRAY_BUFFER,e.positions,e.positions.length,3,o.STATIC_DRAW,t),i.positionsDecodeMatrix.set(e.positionsDecodeMatrix);const s=d.collapseAABB3();d.expandAABB3Points3(s,e.positions),ve.decompressAABB(s,i.positionsDecodeMatrix),d.AABB3ToOBB3(s,i.obb),r&&(i.quantizedPositions=e.positions)}else{const t=e.positions.length,s=d.collapseAABB3();d.expandAABB3Points3(s,e.positions),d.AABB3ToOBB3(s,i.obb);const a=Js(e.positions,s,i.positionsDecodeMatrix);let n=!1;i.positionsBuf=new Mt(o,o.ARRAY_BUFFER,a,t,3,o.STATIC_DRAW,n),r&&(i.quantizedPositions=a)}if(e.normals&&e.normals.length>0)if(s){const t=!0;i.normalsBuf=new Mt(o,o.ARRAY_BUFFER,e.normals,e.normals.length,3,o.STATIC_DRAW,t)}else{const t=function(t){const e=t.length,i=new Int8Array(e);let s,r,o,a;for(let n=0;n<e;n+=3)r=s=er(t,n,"floor","floor"),ir(s),o=a=sr(t,n),s=er(t,n,"ceil","floor"),ir(s),o=sr(t,n),o>a&&(r=s,a=o),s=er(t,n,"floor","ceil"),ir(s),o=sr(t,n),o>a&&(r=s,a=o),s=er(t,n,"ceil","ceil"),ir(s),o=sr(t,n),o>a&&(r=s,a=o),i[n+0]=r[0],i[n+1]=r[1],i[n+2]=0;return new Int8Array(i)}(e.normals),s=!0;i.normalsBuf=new Mt(o,o.ARRAY_BUFFER,t,t.length,3,o.STATIC_DRAW,s)}e.indices&&(i.indicesBuf=new Mt(o,o.ELEMENT_ARRAY_BUFFER,Jr?new Uint32Array(e.indices):new Uint16Array(e.indices),e.indices.length,1,o.STATIC_DRAW),r&&(i.indices=e.indices));let a=e.edgeIndices;a||(a=ue(e.positions,e.indices,null,e.edgeThreshold||10)),i.edgeIndicesBuf=new Mt(o,o.ELEMENT_ARRAY_BUFFER,Jr?new Uint32Array(a):new Uint16Array(a),a.length,1,o.STATIC_DRAW),this._state=new Gt(i),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.indices?e.indices.length/3:0,this._colors=[],this._metallicRoughness=[],this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[],this._portions=[],e.origin&&(this._state.origin=d.vec3(e.origin)),this._finalized=!1,this.aabb=d.collapseAABB3(),this.solid=!!e.solid}createPortion(t){const e=t.color,i=t.metallic,s=t.roughness,r=t.opacity,o=t.meshMatrix,a=t.worldMatrix,n=t.aabb,l=t.pickColor;if(this._finalized)throw"Already finalized";const h=e[0],c=e[1],u=e[2];if(e[3],this._colors.push(h),this._colors.push(c),this._colors.push(u),this._colors.push(r),this._metallicRoughness.push(null!=i?i:0),this._metallicRoughness.push(null!=s?s:255),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(o[0]),this._modelMatrixCol0.push(o[4]),this._modelMatrixCol0.push(o[8]),this._modelMatrixCol0.push(o[12]),this._modelMatrixCol1.push(o[1]),this._modelMatrixCol1.push(o[5]),this._modelMatrixCol1.push(o[9]),this._modelMatrixCol1.push(o[13]),this._modelMatrixCol2.push(o[2]),this._modelMatrixCol2.push(o[6]),this._modelMatrixCol2.push(o[10]),this._modelMatrixCol2.push(o[14]),this._state.normalsBuf){let t=d.transposeMat4(o,d.mat4()),e=d.inverseMat4(t);this._modelNormalMatrixCol0.push(e[0]),this._modelNormalMatrixCol0.push(e[4]),this._modelNormalMatrixCol0.push(e[8]),this._modelNormalMatrixCol0.push(e[12]),this._modelNormalMatrixCol1.push(e[1]),this._modelNormalMatrixCol1.push(e[5]),this._modelNormalMatrixCol1.push(e[9]),this._modelNormalMatrixCol1.push(e[13]),this._modelNormalMatrixCol2.push(e[2]),this._modelNormalMatrixCol2.push(e[6]),this._modelNormalMatrixCol2.push(e[10]),this._modelNormalMatrixCol2.push(e[14])}this._pickColors.push(l[0]),this._pickColors.push(l[1]),this._pickColors.push(l[2]),this._pickColors.push(l[3]),d.collapseAABB3(n);const p=this._state.obb,_=p.length;for(let t=0;t<_;t+=4)eo[0]=p[t+0],eo[1]=p[t+1],eo[2]=p[t+2],d.transformPoint4(o,eo,io),a?(d.transformPoint4(a,io,so),d.expandAABB3Point3(n,so)):d.expandAABB3Point3(n,io);if(this._state.origin){const t=this._state.origin;n[0]+=t[0],n[1]+=t[1],n[2]+=t[2],n[3]+=t[0],n[4]+=t[1],n[5]+=t[2]}d.expandAABB3(this.aabb,n),this._state.numInstances++;const f=this._portions.length,g={};return this.model.scene.pickSurfacePrecisionEnabled&&(g.matrix=o.slice(),g.inverseMatrix=null,g.normalMatrix=null),this._portions.push(g),this._numPortions++,this.model.numPortions++,f}finalize(){if(this._finalized)throw"Already finalized";const t=this.model.scene.canvas.gl,e=this._colors.length,i=e;if(e>0){let e=!1;this._state.colorsBuf=new Mt(t,t.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,t.DYNAMIC_DRAW,e),this._colors=[]}if(this._metallicRoughness.length>0){const e=new Uint8Array(this._metallicRoughness);let i=!1;this._state.metallicRoughnessBuf=new Mt(t,t.ARRAY_BUFFER,e,this._metallicRoughness.length,2,t.STATIC_DRAW,i)}if(i>0){let e=!1,s=!0;this._state.flagsBuf=new Mt(t,t.ARRAY_BUFFER,new Uint8Array(i),i,4,t.DYNAMIC_DRAW,e),this._state.flags2Buf=new Mt(t,t.ARRAY_BUFFER,new Uint8Array(i),i,4,t.DYNAMIC_DRAW,s)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const e=!1;this._state.offsetsBuf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,t.DYNAMIC_DRAW,e),this._offsets=[]}if(this._modelMatrixCol0.length>0){const e=!1;this._state.modelMatrixCol0Buf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol1Buf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol2Buf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,t.STATIC_DRAW,e),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._state.normalsBuf&&(this._state.modelNormalMatrixCol0Buf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol0),this._modelNormalMatrixCol0.length,4,t.STATIC_DRAW,e),this._state.modelNormalMatrixCol1Buf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol1),this._modelNormalMatrixCol1.length,4,t.STATIC_DRAW,e),this._state.modelNormalMatrixCol2Buf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._modelNormalMatrixCol2),this._modelNormalMatrixCol2.length,4,t.STATIC_DRAW,e),this._modelNormalMatrixCol0=[],this._modelNormalMatrixCol1=[],this._modelNormalMatrixCol2=[])}if(this._pickColors.length>0){const e=!1;this._state.pickColorsBuf=new Mt(t,t.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,t.STATIC_DRAW,e),this._pickColors=[]}this._finalized=!0}initFlags(t,e,i){e&D&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&N&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&F&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&I&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&R&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&k&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&B&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&L&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)}setVisible(t,e,i){if(!this._finalized)throw"Not finalized";e&D?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)}setHighlighted(t,e,i){if(!this._finalized)throw"Not finalized";e&N?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)}setXRayed(t,e,i){if(!this._finalized)throw"Not finalized";e&F?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)}setSelected(t,e,i){if(!this._finalized)throw"Not finalized";e&I?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)}setEdges(t,e,i){if(!this._finalized)throw"Not finalized";e&k?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)}setClippable(t,e){if(!this._finalized)throw"Not finalized";e&R?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e,i){if(!this._finalized)throw"Not finalized";e&B?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(t,e,i)}setCulled(t,e,i){if(!this._finalized)throw"Not finalized";e&L?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)}setColor(t,e){if(!this._finalized)throw"Not finalized";to[0]=e[0],to[1]=e[1],to[2]=e[2],to[3]=e[3],this._state.colorsBuf&&this._state.colorsBuf.setData(to,4*t,4)}setTransparent(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)}_setFlags(t,e,i){if(!this._finalized)throw"Not finalized";const s=!!(e&D),r=!!(e&F),o=!!(e&N),a=!!(e&I),n=!!(e&L);let l,h;l=!s||n||r?es:i?ss:is,h=!s||n?es:a?os:o?rs:r?as:es;let c=0;c=!s||n?es:a?cs:o?hs:r?us:!!(e&k)?i?ls:ns:es;let u=s&&!n&&!!(e&B)?ds:es;to[0]=l,to[1]=h,to[2]=c,to[3]=u,this._state.flagsBuf&&this._state.flagsBuf.setData(to,4*t,4)}_setFlags2(t,e){if(!this._finalized)throw"Not finalized";const i=e&R?255:0;to[0]=i,this._state.flags2Buf&&this._state.flags2Buf.setData(to,4*t,4)}setOffset(t,e){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(ro[0]=e[0],ro[1]=e[1],ro[2]=e[2],this._state.offsetsBuf&&this._state.offsetsBuf.setData(ro,3*t,3)):this.model.error("Entity#offset not enabled for this Viewer")}drawColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),e.withSAO&&this.model.saoEnabled?e.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._instancingRenderers.colorQualityRendererWithSAO&&this._instancingRenderers.colorQualityRendererWithSAO.drawLayer(e,this,is):this._state.normalsBuf?this._instancingRenderers.colorRendererWithSAO&&this._instancingRenderers.colorRendererWithSAO.drawLayer(e,this,is):this._instancingRenderers.flatColorRendererWithSAO&&this._instancingRenderers.flatColorRendererWithSAO.drawLayer(e,this,is):e.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._instancingRenderers.colorQualityRenderer&&this._instancingRenderers.colorQualityRenderer.drawLayer(e,this,is):this._state.normalsBuf?this._instancingRenderers.colorRenderer&&this._instancingRenderers.colorRenderer.drawLayer(e,this,is):this._instancingRenderers.flatColorRenderer&&this._instancingRenderers.flatColorRenderer.drawLayer(e,this,is))}_updateBackfaceCull(t,e){const i=this.model.backfaces||!this.solid||t.sectioned;if(e.backfaces!==i){const t=e.gl;i?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),e.backfaces=i}}drawColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),e.pbrEnabled&&this.model.pbrEnabled&&this._state.normalsBuf?this._instancingRenderers.colorQualityRenderer&&this._instancingRenderers.colorQualityRenderer.drawLayer(e,this,ss):this._state.normalsBuf?this._instancingRenderers.colorRenderer&&this._instancingRenderers.colorRenderer.drawLayer(e,this,ss):this._instancingRenderers.flatColorRenderer&&this._instancingRenderers.flatColorRenderer.drawLayer(e,this,ss))}drawDepth(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.depthRenderer&&this._instancingRenderers.depthRenderer.drawLayer(e,this,is))}drawNormals(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.normalsRenderer&&this._instancingRenderers.normalsRenderer.drawLayer(e,this,is))}drawSilhouetteXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(e,this,as))}drawSilhouetteHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(e,this,rs))}drawSilhouetteSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.silhouetteRenderer&&this._instancingRenderers.silhouetteRenderer.drawLayer(e,this,os))}drawEdgesColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._instancingRenderers.edgesColorRenderer&&this._instancingRenderers.edgesColorRenderer.drawLayer(e,this,ns)}drawEdgesColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numEdgesLayerPortions&&this._instancingRenderers.edgesColorRenderer&&this._instancingRenderers.edgesColorRenderer.drawLayer(e,this,ls)}drawEdgesXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(e,this,us)}drawEdgesHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(e,this,hs)}drawEdgesSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._instancingRenderers.edgesRenderer&&this._instancingRenderers.edgesRenderer.drawLayer(e,this,cs)}drawOcclusion(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.occlusionRenderer&&this._instancingRenderers.occlusionRenderer.drawLayer(e,this,is))}drawShadow(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.shadowRenderer&&this._instancingRenderers.shadowRenderer.drawLayer(e,this,is))}drawPickMesh(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.pickMeshRenderer&&this._instancingRenderers.pickMeshRenderer.drawLayer(e,this,ds))}drawPickDepths(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.pickDepthRenderer&&this._instancingRenderers.pickDepthRenderer.drawLayer(e,this,ds))}drawPickNormals(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&(this._updateBackfaceCull(t,e),this._instancingRenderers.pickNormalsRenderer&&this._instancingRenderers.pickNormalsRenderer.drawLayer(e,this,ds))}precisionRayPickSurface(t,e,i,s,r){if(!this.model.scene.pickSurfacePrecisionEnabled)return!1;const o=this._state,a=this._portions[t];if(!a)return this.model.error("portion not found: "+t),!1;a.inverseMatrix||(a.inverseMatrix=d.inverseMat4(a.matrix,d.mat4())),r&&!a.normalMatrix&&(a.normalMatrix=d.transposeMat4(a.inverseMatrix,d.mat4()));const n=o.quantizedPositions,l=o.indices,h=o.origin,c=a.offset,u=oo,p=ao;u.set(h?d.subVec3(e,h,no):e),p.set(i),c&&d.subVec3(u,c),d.transformRay(this.model.worldNormalMatrix,u,p,u,p),d.transformRay(a.inverseMatrix,u,p,u,p);const _=lo,f=ho,g=co;let m=!1,v=0;const b=uo;for(let t=0,i=l.length;t<i;t+=3){const i=3*l[t+0],P=3*l[t+1],y=3*l[t+2];if(_[0]=n[i],_[1]=n[i+1],_[2]=n[i+2],f[0]=n[P],f[1]=n[P+1],f[2]=n[P+2],g[0]=n[y],g[1]=n[y+1],g[2]=n[y+2],d.decompressPosition(_,o.positionsDecodeMatrix),d.decompressPosition(f,o.positionsDecodeMatrix),d.decompressPosition(g,o.positionsDecodeMatrix),d.rayTriangleIntersect(u,p,_,f,g,b)){d.transformPoint3(a.matrix,b,b),d.transformPoint3(this.model.worldMatrix,b,b),c&&d.addVec3(b,c),h&&d.addVec3(b,h);const t=Math.abs(d.lenVec3(d.subVec3(b,e,[])));(!m||t>v)&&(v=t,s.set(b),r&&d.triangleNormal(_,f,g,r),m=!0)}}return m&&r&&(d.transformVec3(a.normalMatrix,r,r),d.transformVec3(this.model.worldNormalMatrix,r,r),d.normalizeVec3(r)),m}destroy(){const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.normalsBuf&&(t.normalsBuf.destroy(),t.normalsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.metallicRoughnessBuf&&(t.metallicRoughnessBuf.destroy(),t.metallicRoughnessBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.modelMatrixCol0Buf&&(t.modelMatrixCol0Buf.destroy(),t.modelMatrixCol0Buf=null),t.modelMatrixCol1Buf&&(t.modelMatrixCol1Buf.destroy(),t.modelMatrixCol1Buf=null),t.modelMatrixCol2Buf&&(t.modelMatrixCol2Buf.destroy(),t.modelMatrixCol2Buf=null),t.modelNormalMatrixCol0Buf&&(t.modelNormalMatrixCol0Buf.destroy(),t.modelNormalMatrixCol0Buf=null),t.modelNormalMatrixCol1Buf&&(t.modelNormalMatrixCol1Buf.destroy(),t.modelNormalMatrixCol1Buf=null),t.modelNormalMatrixCol2Buf&&(t.modelNormalMatrixCol2Buf.destroy(),t.modelNormalMatrixCol2Buf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.edgeIndicesBuf&&(t.edgeIndicesBuf.destroy(),t.edgeIndicessBuf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.destroy()}}const _o=d.vec3();class fo{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=this._scene,r=s.camera,o=e.model,a=s.canvas.gl,n=e._state,l=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?G(r.viewMatrix,l):r.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix),a.lineWidth(s.linesMaterial.lineWidth);const h=s._sectionPlanesState.sectionPlanes.length;if(h>0){const t=s._sectionPlanesState.sectionPlanes,i=e.layerIndex*h,r=o.renderFlags;for(let e=0;e<h;e++){const s=this._uSectionPlanes[e];if(s){const o=r.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,o?1:0),o){const i=t[e];if(l){const t=W(i.dist,i.dir,l,_o);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),n.indicesBuf.bind(),a.drawElements(a.LINES,n.indicesBuf.numItems,n.indicesBuf.itemType,0),t.drawElements++}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene,i=e.canvas.gl,s=this._program,r=e.camera.project;if(s.bind(),i.uniformMatrix4fv(this._uProjMatrix,!1,r.matrix),e.logarithmicDepthBufferEnabled){const t=2/(Math.log(r.far+1)/Math.LN2);i.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines batching color vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, float(color.a) / 255.0);"),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Lines batching color fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor            = vColor;"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const go=new Float32Array([1,1,1]),mo=d.vec3();class vo{constructor(t,e){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===as){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===rs){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===os){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,go);const h=l?G(o.viewMatrix,l):o.viewMatrix;a.uniformMatrix4fv(this._uViewMatrix,!1,h),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.lineWidth(r.linesMaterial.lineWidth);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,mo);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),n.indicesBuf.bind(),a.drawElements(a.LINES,n.indicesBuf.numItems,n.indicesBuf.itemType,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines batching silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform vec4 color;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Lines batching silhouette fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("uniform vec4 color;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = color;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class bo{constructor(t){this._scene=t}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new fo(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new vo(this._scene)),this._silhouetteRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy()}}const Po={};const yo=ht.SUPPORTED_EXTENSIONS.OES_element_index_uint;class Mo{constructor(t=5e6){yo?t>5e6&&(t=5e6):t>65530&&(t=65530),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.flags=[],this.flags2=[],this.offsets=[],this.indices=[]}}const xo=d.vec4([0,0,0,1]),wo=d.vec4([0,0,0,1]),Eo=d.vec4([0,0,0,1]),Ao=d.OBB3();class Co{constructor(t,e){this.layerIndex=e.layerIndex,this._batchingRenderers=function(t){const e=t.id;let i=Po[e];return i||(i=new bo(t),Po[e]=i,i._compile(),t.on("compile",(()=>{i._compile()})),t.on("destroyed",(()=>{delete Po[e],i._destroy()}))),i}(t.scene),this.model=t,this._buffer=new Mo(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Gt({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,flags2Buf:null,indicesBuf:null,positionsDecodeMatrix:d.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=d.collapseAABB3(),this._portions=[],this._numVerts=0,this._finalized=!1,this._positionsDecodeMatrix=e.positionsDecodeMatrix,this._preCompressed=!!this._positionsDecodeMatrix,e.origin&&(this._state.origin=d.vec3(e.origin)),this.aabb=d.collapseAABB3()}canCreatePortion(t,e){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+t<3*this._buffer.maxVerts&&this._buffer.indices.length+e<this._buffer.maxIndices}createPortion(t){if(this._finalized)throw"Already finalized";const e=t.positions,i=t.indices,s=t.color,r=t.opacity,o=t.meshMatrix,a=t.worldMatrix,n=t.worldAABB;t.pickColor;const l=this._buffer,h=l.positions.length/3,c=e.length/3,u=e.length;if(this._preCompressed){for(let t=0,i=e.length;t<i;t++)l.positions.push(e[t]);const t=ve.getPositionsBounds(e),i=ve.decompressPosition(t.min,this._positionsDecodeMatrix,[]),s=ve.decompressPosition(t.max,this._positionsDecodeMatrix,[]);n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=s[0],n[4]=s[1],n[5]=s[2],a&&(d.AABB3ToOBB3(n,Ao),d.transformOBB3(a,Ao),d.OBB3ToAABB3(Ao,n))}else{const t=l.positions.length;for(let t=0,i=e.length;t<i;t++)l.positions.push(e[t]);if(o)for(let e=t,i=t+u;e<i;e+=3)xo[0]=l.positions[e+0],xo[1]=l.positions[e+1],xo[2]=l.positions[e+2],d.transformPoint4(o,xo,wo),l.positions[e+0]=wo[0],l.positions[e+1]=wo[1],l.positions[e+2]=wo[2],d.expandAABB3Point3(this._modelAABB,wo),a?(d.transformPoint4(a,wo,Eo),d.expandAABB3Point3(n,Eo)):d.expandAABB3Point3(n,wo);else for(let e=t,i=t+u;e<i;e+=3)xo[0]=l.positions[e+0],xo[1]=l.positions[e+1],xo[2]=l.positions[e+2],d.expandAABB3Point3(this._modelAABB,xo),a?(d.transformPoint4(a,xo,wo),d.expandAABB3Point3(n,wo)):d.expandAABB3Point3(n,xo)}if(this._state.origin){const t=this._state.origin;n[0]+=t[0],n[1]+=t[1],n[2]+=t[2],n[3]+=t[0],n[4]+=t[1],n[5]+=t[2]}if(d.expandAABB3(this.aabb,n),s){const t=s[0],e=s[1],i=s[2],o=r;for(let s=0;s<c;s++)l.colors.push(t),l.colors.push(e),l.colors.push(i),l.colors.push(o)}if(i)for(let t=0,e=i.length;t<e;t++)l.indices.push(i[t]+h);if(this.model.scene.entityOffsetsEnabled)for(let t=0;t<c;t++)l.offsets.push(0),l.offsets.push(0),l.offsets.push(0);const p=this._portions.length/2;return this._portions.push(h),this._portions.push(c),this._numPortions++,this.model.numPortions++,this._numVerts+=c,p}finalize(){if(this._finalized)return void this.model.error("Already finalized");const t=this._state,e=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressed){t.positionsDecodeMatrix=this._positionsDecodeMatrix;const s=new Uint16Array(i.positions);t.positionsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.positions.length,3,e.STATIC_DRAW)}else{const s=Js(new Float32Array(i.positions),this._modelAABB,t.positionsDecodeMatrix);t.positionsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.positions.length,3,e.STATIC_DRAW)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let r=!1;t.colorsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.colors.length,4,e.DYNAMIC_DRAW,r)}if(i.colors.length>0){const s=i.colors.length,r=new Uint8Array(s),o=new Uint8Array(s);let a=!1,n=!0;t.flagsBuf=new Mt(e,e.ARRAY_BUFFER,r,r.length,4,e.DYNAMIC_DRAW,a),t.flags2Buf=new Mt(e,e.ARRAY_BUFFER,o,o.length,4,e.DYNAMIC_DRAW,n)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);t.offsetsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.offsets.length,3,e.DYNAMIC_DRAW)}const s=ht.SUPPORTED_EXTENSIONS.OES_element_index_uint;if(i.indices.length>0){const r=s?new Uint32Array(i.indices):new Uint16Array(i.indices);t.indicesBuf=new Mt(e,e.ELEMENT_ARRAY_BUFFER,r,i.indices.length,1,e.STATIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(t,e,i){e&D&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&N&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&F&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&I&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&R&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&k&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&B&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&L&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++);this._setFlags(t,e,i,true),this._setFlags2(t,e,true)}flushInitFlags(){this._setDeferredFlags(),this._setDeferredFlags2()}setVisible(t,e,i){if(!this._finalized)throw"Not finalized";e&D?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)}setHighlighted(t,e,i){if(!this._finalized)throw"Not finalized";e&N?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)}setXRayed(t,e,i){if(!this._finalized)throw"Not finalized";e&F?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)}setSelected(t,e,i){if(!this._finalized)throw"Not finalized";e&I?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)}setEdges(t,e,i){if(!this._finalized)throw"Not finalized";e&k?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)}setClippable(t,e){if(!this._finalized)throw"Not finalized";e&R?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)}setCulled(t,e,i){if(!this._finalized)throw"Not finalized";e&L?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e,i){if(!this._finalized)throw"Not finalized";e&B?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(t,e,i)}setColor(t,e){if(!this._finalized)throw"Not finalized";const i=2*t,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),a=e[0],n=e[1],l=e[2],h=e[3];for(let t=0;t<r;t+=4)o[t+0]=a,o[t+1]=n,o[t+2]=l,o[t+3]=h;this._state.colorsBuf.setData(o,s,r)}setTransparent(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)}_setFlags(t,e,i,s=!1){if(!this._finalized)throw"Not finalized";const r=2*t,o=4*this._portions[r],a=4*this._portions[r+1];this._scratchMemory.getUInt8Array(a);const n=!!(e&D),l=!!(e&F),h=!!(e&L);let c,u;c=!n||h||l?es:i?ss:is,u=!n||h?es:!!(e&I)?os:!!(e&N)?rs:l?as:es;let d=n&&!h&&!!(e&B)?ds:es;if(s){this._deferredFlagValues||(this._deferredFlagValues=new Uint8Array(4*this._numVerts));for(let t=o,e=o+a;t<e;t+=4)this._deferredFlagValues[t+0]=c,this._deferredFlagValues[t+1]=u,this._deferredFlagValues[t+2]=0,this._deferredFlagValues[t+3]=d}else if(this._state.flagsBuf){const t=this._scratchMemory.getUInt8Array(a);for(let e=0;e<a;e+=4)t[e+0]=c,t[e+1]=u,t[e+2]=0,t[e+3]=d;this._state.flagsBuf.setData(t,o,a)}}_setDeferredFlags(){this._deferredFlagValues&&(this._state.flagsBuf.setData(this._deferredFlagValues),this._deferredFlagValues=null)}_setFlags2(t,e,i=!1){if(!this._finalized)throw"Not finalized";const s=2*t,r=4*this._portions[s],o=4*this._portions[s+1],a=e&R?255:0;if(i){this._setDeferredFlag2Values||(this._setDeferredFlag2Values=new Uint8Array(4*this._numVerts));for(let t=r,e=r+o;t<e;t+=4)this._setDeferredFlag2Values[t]=a}else{const t=this._scratchMemory.getUInt8Array(o);for(let e=0;e<o;e+=4)t[e+0]=a;this._state.flags2Buf.setData(t,r,o)}}_setDeferredFlags2(){this._setDeferredFlag2Values&&(this._state.flags2Buf.setData(this._setDeferredFlag2Values),this._setDeferredFlag2Values=null)}setOffset(t,e){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const i=2*t,s=3*this._portions[i],r=3*this._portions[i+1],o=this._scratchMemory.getFloat32Array(r),a=e[0],n=e[1],l=e[2];for(let t=0;t<r;t+=3)o[t+0]=a,o[t+1]=n,o[t+2]=l;this._state.offsetsBuf.setData(o,s,r)}drawColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(e,this,is)}drawColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._batchingRenderers.colorRenderer&&this._batchingRenderers.colorRenderer.drawLayer(e,this,ss)}drawDepth(t,e){}drawNormals(t,e){}drawSilhouetteXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,as)}drawSilhouetteHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,rs)}drawSilhouetteSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._batchingRenderers.silhouetteRenderer&&this._batchingRenderers.silhouetteRenderer.drawLayer(e,this,os)}drawEdgesColorOpaque(t,e){}drawEdgesColorTransparent(t,e){}drawEdgesHighlighted(t,e){}drawEdgesSelected(t,e){}drawEdgesXRayed(t,e){}drawPickMesh(t){}drawPickDepths(t){}drawPickNormals(t){}drawOcclusion(t){}drawShadow(t){}destroy(){const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.destroy()}}const So=d.vec3();class Do{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.lineWidth(r.linesMaterial.lineWidth);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,So);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.LINES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),t.drawElements++,l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aColor=i.getAttribute("color"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aOffset=i.getAttribute("offset"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines instancing color vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("uniform vec4 lightAmbient;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("varying vec4 vColor;"),i.push("void main(void) {"),i.push("if (int(flags.x) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),i.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0,  float(color.a) / 255.0);"),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Lines instancing color fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("varying vec4 vColor;"),o.push("void main(void) {"),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return this._withSAO?(o.push("   float viewportWidth     = uSAOParams[0];"),o.push("   float viewportHeight    = uSAOParams[1];"),o.push("   float blendCutoff       = uSAOParams[2];"),o.push("   float blendFactor       = uSAOParams[3];"),o.push("   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);"),o.push("   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBAToDepth(texture2D(uOcclusionTexture, uv))) * blendFactor;"),o.push("   gl_FragColor            = vec4(vColor.rgb * ambient, vColor.a);")):o.push("    gl_FragColor           = vColor;"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Lo=d.vec3();class Bo{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin;if(!this._program&&(this._allocate(e.model.scene),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===as){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===rs){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===os){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,d.vec3([1,1,1]));a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.lineWidth(r.linesMaterial.lineWidth);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,o=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,Lo);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),n.indicesBuf.bind(),l.drawElementsInstancedANGLE(a.LINES,n.indicesBuf.numItems,n.indicesBuf.itemType,0,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uColor=s.getLocation("color"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Lines instancing silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("#extension GL_EXT_frag_depth : enable"),i.push("uniform int renderPass;"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 worldMatrix;"),i.push("uniform mat4 viewMatrix;"),i.push("uniform mat4 projMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),t.logarithmicDepthBufferEnabled&&(i.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&i.push("varying float vFragDepth;")),i.push("uniform vec4 color;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("if (int(flags.y) != renderPass) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?i.push("vFragDepth = 1.0 + clipPos.w;"):(i.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),i.push("clipPos.z *= clipPos.w;"))),i.push("gl_Position = clipPos;"),i.push("}"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Lines instancing silhouette fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("uniform vec4 color;"),s.push("void main(void) {"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = color;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class Ro{constructor(t){this._scene=t}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Do(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Bo(this._scene)),this._silhouetteRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy()}}const To={};const Fo=ht.SUPPORTED_EXTENSIONS.OES_element_index_uint,No=new Uint8Array(4),Io=d.vec4([0,0,0,1]),ko=d.vec4([0,0,0,1]),Oo=d.vec4([0,0,0,1]),Vo=new Float32Array(3);class zo{constructor(t,e){this.sortId="LinesInstancingLayer",this.layerIndex=e.layerIndex,this._linesInstancingRenderers=function(t){const e=t.id;let i=To[e];return i||(i=new Ro(t),To[e]=i,i._compile(),t.on("compile",(()=>{i._compile()})),t.on("destroyed",(()=>{delete To[e],i._destroy()}))),i}(t.scene),this.model=t,this._aabb=d.collapseAABB3();const i=t.scene.canvas.gl,s={positionsDecodeMatrix:d.mat4(),numInstances:0,obb:d.OBB3(),origin:null},r=!!e.positionsDecodeMatrix;if(e.positions)if(r){let t=!1;s.positionsBuf=new Mt(i,i.ARRAY_BUFFER,e.positions,e.positions.length,3,i.STATIC_DRAW,t),s.positionsDecodeMatrix.set(e.positionsDecodeMatrix);let r=d.collapseAABB3();d.expandAABB3Points3(r,e.positions),ve.decompressAABB(r,s.positionsDecodeMatrix),d.AABB3ToOBB3(r,s.obb)}else{let t=e.positions.length,r=d.collapseAABB3();d.expandAABB3Points3(r,e.positions),d.AABB3ToOBB3(r,s.obb);const o=Js(e.positions,r,s.positionsDecodeMatrix);let a=!1;s.positionsBuf=new Mt(i,i.ARRAY_BUFFER,o,t,3,i.STATIC_DRAW,a)}e.indices&&(s.indicesBuf=new Mt(i,i.ELEMENT_ARRAY_BUFFER,Fo?new Uint32Array(e.indices):new Uint16Array(e.indices),e.indices.length,1,i.STATIC_DRAW)),this._state=new Gt(s),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this.numIndices=e.indices?e.indices.length/3:0,this._colors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],e.origin&&(this._state.origin=d.vec3(e.origin)),this._finalized=!1,this.aabb=d.collapseAABB3()}createPortion(t){const e=t.color,i=t.opacity,s=t.meshMatrix,r=t.worldMatrix,o=t.aabb;if(this._finalized)throw"Already finalized";const a=e[0],n=e[1],l=e[2];e[3],this._colors.push(a),this._colors.push(n),this._colors.push(l),this._colors.push(i),this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(s[0]),this._modelMatrixCol0.push(s[4]),this._modelMatrixCol0.push(s[8]),this._modelMatrixCol0.push(s[12]),this._modelMatrixCol1.push(s[1]),this._modelMatrixCol1.push(s[5]),this._modelMatrixCol1.push(s[9]),this._modelMatrixCol1.push(s[13]),this._modelMatrixCol2.push(s[2]),this._modelMatrixCol2.push(s[6]),this._modelMatrixCol2.push(s[10]),this._modelMatrixCol2.push(s[14]),d.collapseAABB3(o);const h=this._state.obb,c=h.length;for(let t=0;t<c;t+=4)Io[0]=h[t+0],Io[1]=h[t+1],Io[2]=h[t+2],d.transformPoint4(s,Io,ko),r?(d.transformPoint4(r,ko,Oo),d.expandAABB3Point3(o,Oo)):d.expandAABB3Point3(o,ko);if(this._state.origin){const t=this._state.origin;o[0]+=t[0],o[1]+=t[1],o[2]+=t[2],o[3]+=t[0],o[4]+=t[1],o[5]+=t[2]}d.expandAABB3(this.aabb,o),this._state.numInstances++;const u=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,u}finalize(){if(this._finalized)throw"Already finalized";const t=this.model.scene.canvas.gl,e=this._colors.length,i=e;if(e>0){let e=!1;this._state.colorsBuf=new Mt(t,t.ARRAY_BUFFER,new Uint8Array(this._colors),this._colors.length,4,t.DYNAMIC_DRAW,e),this._colors=[]}if(i>0){let e=!1,s=!0;this._state.flagsBuf=new Mt(t,t.ARRAY_BUFFER,new Uint8Array(i),i,4,t.DYNAMIC_DRAW,e),this._state.flags2Buf=new Mt(t,t.ARRAY_BUFFER,new Uint8Array(i),i,4,t.DYNAMIC_DRAW,s)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const e=!1;this._state.offsetsBuf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,t.DYNAMIC_DRAW,e),this._offsets=[]}if(this._modelMatrixCol0.length>0){const e=!1;this._state.modelMatrixCol0Buf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol1Buf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol2Buf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,t.STATIC_DRAW,e),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}this._finalized=!0}initFlags(t,e,i){e&D&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&N&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&F&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&I&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&R&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&k&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&B&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&L&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)}setVisible(t,e,i){if(!this._finalized)throw"Not finalized";e&D?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)}setHighlighted(t,e,i){if(!this._finalized)throw"Not finalized";e&N?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)}setXRayed(t,e,i){if(!this._finalized)throw"Not finalized";e&F?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)}setSelected(t,e,i){if(!this._finalized)throw"Not finalized";e&I?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)}setEdges(t,e,i){if(!this._finalized)throw"Not finalized";e&k?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)}setClippable(t,e){if(!this._finalized)throw"Not finalized";e&R?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e,i){if(!this._finalized)throw"Not finalized";e&B?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(t,e,i)}setCulled(t,e,i){if(!this._finalized)throw"Not finalized";e&L?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)}setColor(t,e){if(!this._finalized)throw"Not finalized";No[0]=e[0],No[1]=e[1],No[2]=e[2],No[3]=e[3],this._state.colorsBuf.setData(No,4*t,4)}setTransparent(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)}_setFlags(t,e,i){if(!this._finalized)throw"Not finalized";const s=!!(e&D),r=!!(e&F),o=!!(e&N),a=!!(e&I),n=!!(e&L);let l,h;l=!s||n||r?es:i?ss:is,h=!s||n?es:a?os:o?rs:r?as:es;let c=0;c=!s||n?es:a?cs:o?hs:r?us:!!(e&k)?i?ls:ns:es;let u=s&&!n&&!!(e&B)?ds:es;No[0]=l,No[1]=h,No[2]=c,No[3]=u,this._state.flagsBuf.setData(No,4*t,4)}_setFlags2(t,e){if(!this._finalized)throw"Not finalized";const i=e&R?255:0;No[0]=i,this._state.flags2Buf.setData(No,4*t,4)}setOffset(t,e){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(Vo[0]=e[0],Vo[1]=e[1],Vo[2]=e[2],this._state.offsetsBuf.setData(Vo,3*t,3)):this.model.error("Entity#offset not enabled for this Viewer")}drawColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._linesInstancingRenderers.colorRenderer&&this._linesInstancingRenderers.colorRenderer.drawLayer(e,this,is)}drawColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._linesInstancingRenderers.colorRenderer&&this._linesInstancingRenderers.colorRenderer.drawLayer(e,this,ss)}drawDepth(t,e){}drawNormals(t,e){}drawSilhouetteXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(e,this,as)}drawSilhouetteHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(e,this,rs)}drawSilhouetteSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._linesInstancingRenderers.silhouetteRenderer&&this._linesInstancingRenderers.silhouetteRenderer.drawLayer(e,this,os)}drawEdgesColorOpaque(t,e){}drawEdgesColorTransparent(t,e){}drawEdgesXRayed(t,e){}drawEdgesHighlighted(t,e){}drawEdgesSelected(t,e){}drawOcclusion(t,e){}drawShadow(t,e){}drawPickMesh(t,e){}drawPickDepths(t,e){}drawPickNormals(t,e){}destroy(){const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.modelMatrixCol0Buf&&(t.modelMatrixCol0Buf.destroy(),t.modelMatrixCol0Buf=null),t.modelMatrixCol1Buf&&(t.modelMatrixCol1Buf.destroy(),t.modelMatrixCol1Buf=null),t.modelMatrixCol2Buf&&(t.modelMatrixCol2Buf.destroy(),t.modelMatrixCol2Buf=null),t.indicesBuf&&(t.indicesBuf.destroy(),t.indicessBuf=null),t.destroy()}}const Uo=d.vec3();class Go{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=this._scene,r=s.camera,o=e.model,a=s.canvas.gl,n=e._state,l=e._state.origin,h=s.pointsMaterial;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,l?G(r.viewMatrix,l):r.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,o.worldMatrix);const c=s._sectionPlanesState.sectionPlanes.length;if(c>0){const t=s._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,r=o.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const o=r.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,o?1:0),o){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Uo);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor&&this._aColor.bindArrayBuffer(n.colorsBuf),h.filterIntensity&&a.uniform2f(this._uIntensityRange,h.minIntensity,h.maxIntensity),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),a.uniform1f(this._uPointSize,h.pointSize);const u="ortho"===s.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*s.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,u),a.drawArrays(a.POINTS,0,n.positionsBuf.numItems),t.drawArrays++}_allocate(){const t=this._scene,e=t.pointsMaterial._state,i=t.canvas.gl;if(this._program=new yt(i,this._buildShader(t)),this._program.errors)return void(this.errors=this._program.errors);const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.filterIntensity&&(this._uIntensityRange=s.getLocation("intensityRange")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=this._program,s=t.camera.project;if(i.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,s.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(s.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial,s=[];return s.push("// Points batching color vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),s.push("attribute vec4 color;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),i.filterIntensity&&s.push("uniform vec2 intensityRange;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("varying vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),i.filterIntensity&&(s.push("float intensity = float(color.a) / 255.0;"),s.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {")),s.push("vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&s.push("worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),e&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),i.filterIntensity&&s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points batching color fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("  if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vColor;"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const jo=new Float32Array([1,1,1]),Xo=d.vec3();class Wo{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin,h=r.pointsMaterial._state;if(!this._program&&(this._allocate(),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===as){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===rs){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===os){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,jo);const c=l?G(o.viewMatrix,l):o.viewMatrix;a.uniformMatrix4fv(this._uViewMatrix,!1,c),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Xo);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),a.uniform1f(this._uPointSize,h.pointSize);const d="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,d),a.drawArrays(a.POINTS,0,n.positionsBuf.numItems)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uColor=i.getLocation("color"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points batching silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform vec4 color;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.y) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Points batching silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("uniform vec4 color;"),o.push("void main(void) {"),t.pointsMaterial.roundPoints&&(o.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("  float r = dot(cxy, cxy);"),o.push("  if (r > 1.0) {"),o.push("       discard;"),o.push("  }")),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("  if (dist > 0.0) { discard; }"),o.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("gl_FragColor = color;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ho=d.vec3();class Yo{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin,h=r.pointsMaterial._state;this._program||this._allocate(e),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=t.pickViewMatrix||o.viewMatrix,u=l?G(c,l):c;if(a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,u),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*d,o=s.renderFlags;for(let e=0;e<d;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Ho);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),this._aPickColor&&this._aPickColor.bindArrayBuffer(n.pickColorsBuf),a.uniform1f(this._uPointSize,h.pointSize);const p="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,p),a.drawArrays(a.POINTS,0,n.positionsBuf.numItems)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aPickColor=i.getAttribute("pickColor"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene.canvas.gl;this._program.bind(),e.uniform1i(this._uPickInvisible,t.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points batching pick mesh vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("attribute vec4 pickColor;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("      vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("gl_PointSize += 10.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points batching pick mesh vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("uniform bool sectionPlaneActive"+r+";"),s.push("uniform vec3 sectionPlanePos"+r+";"),s.push("uniform vec3 sectionPlaneDir"+r+";")}if(s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   gl_FragColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Ko=d.vec3();class qo{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=e._state.origin,h=r.pointsMaterial._state;this._program||this._allocate(),t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniform1i(this._uPickInvisible,t.pickInvisible);const c=t.pickViewMatrix||o.viewMatrix,u=l?G(c,l):c;if(a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,u),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),a.uniform1f(this._uPickZNear,t.pickZNear),a.uniform1f(this._uPickZFar,t.pickZFar),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(t.pickZFar+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,e)}const d=r._sectionPlanesState.sectionPlanes.length;if(d>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*d,o=s.renderFlags;for(let e=0;e<d;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Ko);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(n.offsetsBuf),this._aFlags&&this._aFlags.bindArrayBuffer(n.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(n.flags2Buf),a.uniform1f(this._uPointSize,h.pointSize);const p="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,p),a.drawArrays(a.POINTS,0,n.positionsBuf.numItems)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points batched pick depth vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("varying vec4 vViewPosition;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("gl_PointSize += 10.0;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points batched pick depth fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(var r=0;r<e.sectionPlanes.length;r++)s.push("      if (sectionPlaneActive"+r+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+r+".xyz, vWorldPosition.xyz - sectionPlanePos"+r+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    gl_FragColor = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const Zo=d.vec3();class Qo{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,a=e._state,n=r.camera,l=e._state.origin,h=r.pointsMaterial._state;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),o.uniform1i(this._uRenderPass,i),o.uniformMatrix4fv(this._uViewMatrix,!1,l?G(n.viewMatrix,l):n.viewMatrix),o.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const c=r._sectionPlanesState.sectionPlanes.length;if(c>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*c,a=s.renderFlags;for(let e=0;e<c;e++){const s=this._uSectionPlanes[e];if(s){const r=a.sectionPlanesActivePerLayer[i+e];if(o.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,Zo);o.uniform3fv(s.pos,t)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aOffset&&this._aOffset.bindArrayBuffer(a.offsetsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),this._aFlags2&&this._aFlags2.bindArrayBuffer(a.flags2Buf),o.uniform1f(this._uPointSize,h.pointSize);const u="ortho"===r.camera.projection?1:o.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));o.uniform1f(this._uNearPlaneHeight,u),o.drawArrays(o.POINTS,0,a.positionsBuf.numItems)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points batching occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("  } else {"),s.push("      vec4 worldPosition = worldMatrix * (positionsDecodeMatrix * vec4(position, 1.0)); "),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("      vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(s.push("      vWorldPosition = worldPosition;"),s.push("      vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("  gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("  }"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points batching occlusion fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("      float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("      if (sectionPlaneActive"+t+") {"),s.push("          dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("      }");s.push("      if (dist > 0.0) { discard; }"),s.push("  }")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class $o{constructor(t){this._scene=t}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new Go(this._scene)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new Wo(this._scene)),this._silhouetteRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new Yo(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new qo(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new Qo(this._scene)),this._occlusionRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy()}}const Jo={};const ta=ht.SUPPORTED_EXTENSIONS.OES_element_index_uint;class ea{constructor(t=5e6){ta?t>5e6&&(t=5e6):t>65530&&(t=65530),this.maxVerts=t,this.maxIndices=3*t,this.positions=[],this.colors=[],this.intensities=[],this.pickColors=[],this.flags=[],this.flags2=[],this.offsets=[]}}const ia=d.vec4(),sa=d.vec4(),ra=d.vec4([0,0,0,1]),oa=d.vec4([0,0,0,1]),aa=d.vec4([0,0,0,1]),na=d.OBB3();class la{constructor(t,e){this.sortId="PointsBatchingLayer",this.layerIndex=e.layerIndex,this._pointsBatchingRenderers=function(t){const e=t.id;let i=Jo[e];return i||(i=new $o(t),Jo[e]=i,i._compile(),t.on("compile",(()=>{i._compile()})),t.on("destroyed",(()=>{delete Jo[e],i._destroy()}))),i}(t.scene),this.model=t,this._buffer=new ea(e.maxGeometryBatchSize),this._scratchMemory=e.scratchMemory,this._state=new Gt({positionsBuf:null,offsetsBuf:null,colorsBuf:null,flagsBuf:null,flags2Buf:null,positionsDecodeMatrix:d.mat4(),origin:null}),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numSelectedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numClippableLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._modelAABB=d.collapseAABB3(),this._portions=[],this._finalized=!1,this._positionsDecodeMatrix=e.positionsDecodeMatrix,this._preCompressed=!!this._positionsDecodeMatrix,e.origin&&(this._state.origin=d.vec3(e.origin)),this.aabb=d.collapseAABB3()}canCreatePortion(t){if(this._finalized)throw"Already finalized";return this._buffer.positions.length+t<3*this._buffer.maxVerts}createPortion(t){if(this._finalized)throw"Already finalized";const e=t.positions,i=t.color,s=t.colorsCompressed,r=t.colors,o=t.meshMatrix,a=t.worldMatrix,n=t.worldAABB,l=t.pickColor,h=this._buffer,c=h.positions.length/3,u=e.length/3,p=e.length;if(this._preCompressed){for(let t=0,i=e.length;t<i;t++)h.positions.push(e[t]);const t=ve.getPositionsBounds(e),i=ve.decompressPosition(t.min,this._positionsDecodeMatrix,ia),s=ve.decompressPosition(t.max,this._positionsDecodeMatrix,sa);n[0]=i[0],n[1]=i[1],n[2]=i[2],n[3]=s[0],n[4]=s[1],n[5]=s[2],a&&(d.AABB3ToOBB3(n,na),d.transformOBB3(a,na),d.OBB3ToAABB3(na,n))}else{const t=h.positions.length;for(let t=0,i=e.length;t<i;t++)h.positions.push(e[t]);if(o)for(let e=t,i=t+p;e<i;e+=3)ra[0]=h.positions[e+0],ra[1]=h.positions[e+1],ra[2]=h.positions[e+2],d.transformPoint4(o,ra,oa),h.positions[e+0]=oa[0],h.positions[e+1]=oa[1],h.positions[e+2]=oa[2],d.expandAABB3Point3(this._modelAABB,oa),a?(d.transformPoint4(a,oa,aa),d.expandAABB3Point3(n,aa)):d.expandAABB3Point3(n,oa);else for(let e=t,i=t+p;e<i;e+=3)ra[0]=h.positions[e+0],ra[1]=h.positions[e+1],ra[2]=h.positions[e+2],d.expandAABB3Point3(this._modelAABB,ra),a?(d.transformPoint4(a,ra,oa),d.expandAABB3Point3(n,oa)):d.expandAABB3Point3(n,ra)}if(this._state.origin){const t=this._state.origin;n[0]+=t[0],n[1]+=t[1],n[2]+=t[2],n[3]+=t[0],n[4]+=t[1],n[5]+=t[2]}if(d.expandAABB3(this.aabb,n),s)for(let t=0,e=s.length;t<e;t++)h.colors.push(s[t]);else if(r)for(let t=0,e=r.length;t<e;t++)h.colors.push(255*r[t]);else if(i){const t=i[0],e=i[1],s=i[2],r=1;for(let i=0;i<u;i++)h.colors.push(t),h.colors.push(e),h.colors.push(s),h.colors.push(r)}{const t=h.pickColors.length;for(let e=t,i=t+4*u;e<i;e+=4)h.pickColors.push(l[0]),h.pickColors.push(l[1]),h.pickColors.push(l[2]),h.pickColors.push(l[3])}if(this.model.scene.entityOffsetsEnabled)for(let t=0;t<u;t++)h.offsets.push(0),h.offsets.push(0),h.offsets.push(0);const _=this._portions.length/2;return this._portions.push(c),this._portions.push(u),this._numPortions++,this.model.numPortions++,_}finalize(){if(this._finalized)return void this.model.error("Already finalized");const t=this._state,e=this.model.scene.canvas.gl,i=this._buffer;if(i.positions.length>0)if(this._preCompressed){t.positionsDecodeMatrix=this._positionsDecodeMatrix;const s=new Uint16Array(i.positions);t.positionsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.positions.length,3,e.STATIC_DRAW)}else{const s=Js(new Float32Array(i.positions),this._modelAABB,t.positionsDecodeMatrix);t.positionsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.positions.length,3,e.STATIC_DRAW)}if(i.colors.length>0){const s=new Uint8Array(i.colors);let r=!1;t.colorsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.colors.length,4,e.STATIC_DRAW,r)}if(i.positions.length>0){const s=i.positions.length/3*4,r=new Uint8Array(s),o=new Uint8Array(s);let a=!1,n=!0;t.flagsBuf=new Mt(e,e.ARRAY_BUFFER,r,r.length,4,e.DYNAMIC_DRAW,a),t.flags2Buf=new Mt(e,e.ARRAY_BUFFER,o,o.length,4,e.DYNAMIC_DRAW,n)}if(i.pickColors.length>0){const s=new Uint8Array(i.pickColors);let r=!1;t.pickColorsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.pickColors.length,4,e.STATIC_DRAW,r)}if(this.model.scene.entityOffsetsEnabled&&i.offsets.length>0){const s=new Float32Array(i.offsets);t.offsetsBuf=new Mt(e,e.ARRAY_BUFFER,s,i.offsets.length,3,e.DYNAMIC_DRAW)}this._buffer=null,this._finalized=!0}initFlags(t,e,i){e&D&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&N&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&F&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&I&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&R&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&B&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&L&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)}setVisible(t,e,i){if(!this._finalized)throw"Not finalized";e&D?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)}setHighlighted(t,e,i){if(!this._finalized)throw"Not finalized";e&N?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)}setXRayed(t,e,i){if(!this._finalized)throw"Not finalized";e&F?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)}setSelected(t,e,i){if(!this._finalized)throw"Not finalized";e&I?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)}setEdges(t,e,i){if(!this._finalized)throw"Not finalized"}setClippable(t,e){if(!this._finalized)throw"Not finalized";e&R?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)}setCulled(t,e,i){if(!this._finalized)throw"Not finalized";e&L?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e,i){if(!this._finalized)throw"Not finalized";e&B?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags(t,e,i)}setColor(t,e){if(!this._finalized)throw"Not finalized";const i=2*t,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),a=e[0],n=e[1],l=e[2];for(let t=0;t<r;t+=4)o[t+0]=a,o[t+1]=n,o[t+2]=l;this._state.colorsBuf.setData(o,s,r)}setTransparent(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)}_setFlags(t,e,i){if(!this._finalized)throw"Not finalized";const s=2*t,r=4*this._portions[s],o=4*this._portions[s+1],a=this._scratchMemory.getUInt8Array(o),n=!!(e&D),l=!!(e&F),h=!!(e&L);let c,u;c=!n||h||l?es:i?ss:is,u=!n||h?es:!!(e&I)?os:!!(e&N)?rs:l?as:es;let d=n&&!h&&!!(e&B)?ds:es;for(let t=0;t<o;t+=4)a[t+0]=c,a[t+1]=u,a[t+2]=0,a[t+3]=d;this._state.flagsBuf.setData(a,r,o)}_setFlags2(t,e){if(!this._finalized)throw"Not finalized";const i=2*t,s=4*this._portions[i],r=4*this._portions[i+1],o=this._scratchMemory.getUInt8Array(r),a=e&R?255:0;for(let t=0;t<r;t+=4)o[t+0]=a;this._state.flags2Buf.setData(o,s,r)}setOffset(t,e){if(!this._finalized)throw"Not finalized";if(!this.model.scene.entityOffsetsEnabled)return void this.model.error("Entity#offset not enabled for this Viewer");const i=2*t,s=3*this._portions[i],r=3*this._portions[i+1],o=this._scratchMemory.getFloat32Array(r),a=e[0],n=e[1],l=e[2];for(let t=0;t<r;t+=3)o[t+0]=a,o[t+1]=n,o[t+2]=l;this._state.offsetsBuf.setData(o,s,r)}drawColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsBatchingRenderers.colorRenderer&&this._pointsBatchingRenderers.colorRenderer.drawLayer(e,this,is)}drawColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsBatchingRenderers.colorRenderer&&this._pointsBatchingRenderers.colorRenderer.drawLayer(e,this,ss)}drawDepth(t,e){}drawNormals(t,e){}drawSilhouetteXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(e,this,as)}drawSilhouetteHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(e,this,rs)}drawSilhouetteSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._pointsBatchingRenderers.silhouetteRenderer&&this._pointsBatchingRenderers.silhouetteRenderer.drawLayer(e,this,os)}drawEdgesColorOpaque(t,e){}drawEdgesColorTransparent(t,e){}drawEdgesHighlighted(t,e){}drawEdgesSelected(t,e){}drawEdgesXRayed(t,e){}drawPickMesh(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.pickMeshRenderer&&this._pointsBatchingRenderers.pickMeshRenderer.drawLayer(e,this,ds)}drawPickDepths(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.pickDepthRenderer&&this._pointsBatchingRenderers.pickDepthRenderer.drawLayer(e,this,ds)}drawPickNormals(t,e){}drawOcclusion(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsBatchingRenderers.occlusionRenderer&&this._pointsBatchingRenderers.occlusionRenderer.drawLayer(e,this,is)}drawShadow(t,e){}destroy(){const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.destroy()}}const ha=d.vec3();class ca{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin,c=r.pointsMaterial._state;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aColor.bindArrayBuffer(n.colorsBuf),c.filterIntensity&&a.uniform2f(this._uIntensityRange,c.minIntensity,c.maxIntensity);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,ha);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.uniform1f(this._uPointSize,c.pointSize);const d="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,d),l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),t.drawArrays++,l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.pointsMaterial._state,i=t.canvas.gl;if(this._program=new yt(i,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=i.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,i=t._sectionPlanesState.sectionPlanes.length;e<i;e++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+e),pos:s.getLocation("sectionPlanePos"+e),dir:s.getLocation("sectionPlaneDir"+e)});this._aPosition=s.getAttribute("position"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aOffset=s.getAttribute("offset"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uOcclusionTexture="uOcclusionTexture",this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),e.filterIntensity&&(this._uIntensityRange=s.getLocation("intensityRange")),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points instancing color vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),s.push("attribute vec4 color;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 modelMatrixCol0;"),s.push("attribute vec4 modelMatrixCol1;"),s.push("attribute vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),i.filterIntensity&&s.push("uniform vec2 intensityRange;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("varying vec4 vColor;"),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),i.filterIntensity&&(s.push("float intensity = float(color.a) / 255.0;"),s.push("if (intensity < intensityRange[0] || intensity > intensityRange[1]) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {")),s.push("vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("vColor = vec4(float(color.r) / 255.0, float(color.g) / 255.0, float(color.b) / 255.0, 1.0);"),e&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),i.filterIntensity&&s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points instancing color fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vColor;"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vColor;"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ua=d.vec3();class da{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin,c=r.pointsMaterial._state;if(!this._program&&(this._allocate(e.model.scene),this.errors))return;if(t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),i===as){const t=r.xrayMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===rs){const t=r.highlightMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else if(i===os){const t=r.selectedMaterial._state,e=t.fillColor,i=t.fillAlpha;a.uniform4f(this._uColor,e[0],e[1],e[2],i)}else a.uniform4fv(this._uColor,d.vec3([1,1,1]));a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,ua);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf,a.UNSIGNED_BYTE,!0),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.uniform1f(this._uPointSize,c.pointSize);const p="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,p),l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uColor=s.getLocation("color"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points instancing silhouette vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("attribute vec4 modelMatrixCol0;"),s.push("attribute vec4 modelMatrixCol1;"),s.push("attribute vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),s.push("uniform vec4 color;"),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.y) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points instancing silhouette fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("uniform vec4 color;"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = color;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const pa=d.vec3();class _a{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin,c=r.pointsMaterial._state;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t)),a.uniform1i(this._uRenderPass,i);const u=t.pickViewMatrix||o.viewMatrix,d=h?G(u,h):u;if(a.uniformMatrix4fv(this._uViewMatrix,!1,d),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),r.logarithmicDepthBufferEnabled){const t=2/(Math.log(o.project.far+1)/Math.LN2);a.uniform1f(this._uLogDepthBufFC,t)}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPickColor.bindArrayBuffer(n.pickColorsBuf),l.vertexAttribDivisorANGLE(this._aPickColor.location,1),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),a.uniform1f(this._uPointSize,c.pointSize);const p="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,p);const _=r._sectionPlanesState.sectionPlanes.length;if(_>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*_,o=s.renderFlags;for(let e=0;e<_;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,pa);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aPickColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uPickInvisible=s.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._uRenderPass=s.getLocation("renderPass"),this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aPickColor=s.getAttribute("pickColor"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(t){const e=this._scene.canvas.gl;this._program.bind(),e.uniform1i(this._uPickInvisible,t.pickInvisible)}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points instancing pick mesh vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("attribute vec4 pickColor;"),s.push("attribute vec4 modelMatrixCol0;"),s.push("attribute vec4 modelMatrixCol1;"),s.push("attribute vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),s.push("  vPickColor = vec4(float(pickColor.r) / 255.0, float(pickColor.g) / 255.0, float(pickColor.b) / 255.0, float(pickColor.a) / 255.0);"),e&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points instancing pick mesh fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vPickColor;"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("gl_FragColor = vPickColor; "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const fa=d.vec3();class ga{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.canvas.gl,a=e._state,n=this._instanceExt,l=e._state.origin,h=r.pointsMaterial._state;if(!this._program&&(this._allocate(e),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram());const c=r.camera;o.uniform1i(this._uRenderPass,i),o.uniform1i(this._uPickInvisible,t.pickInvisible);const u=t.pickViewMatrix||c.viewMatrix,d=l?G(u,l):u;if(o.uniformMatrix4fv(this._uViewMatrix,!1,d),o.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),o.uniformMatrix4fv(this._uProjMatrix,!1,t.pickProjMatrix),o.uniform1f(this._uPickZNear,t.pickZNear),o.uniform1f(this._uPickZFar,t.pickZFar),r.logarithmicDepthBufferEnabled){const e=2/(Math.log(t.pickZFar+1)/Math.LN2);o.uniform1f(this._uLogDepthBufFC,e)}const p=r._sectionPlanesState.sectionPlanes.length;if(p>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*p,a=s.renderFlags;for(let e=0;e<p;e++){const s=this._uSectionPlanes[e];if(s){const r=a.sectionPlanesActivePerLayer[i+e];if(o.uniform1i(s.active,r?1:0),r){const i=t[e];if(l){const t=W(i.dist,i.dir,l,fa);o.uniform3fv(s.pos,t)}else o.uniform3fv(s.pos,i.pos);o.uniform3fv(s.dir,i.dir)}}}}o.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(a.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(a.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(a.modelMatrixCol2Buf),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(a.positionsBuf),this._aFlags.bindArrayBuffer(a.flagsBuf),n.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(a.flags2Buf),n.vertexAttribDivisorANGLE(this._aFlags2.location,1)),this._aOffset&&(this._aOffset.bindArrayBuffer(a.offsetsBuf),n.vertexAttribDivisorANGLE(this._aOffset.location,1)),o.uniform1f(this._uPointSize,h.pointSize);const _="ortho"===r.camera.projection?1:o.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));o.uniform1f(this._uNearPlaneHeight,_),n.drawArraysInstancedANGLE(o.POINTS,0,a.positionsBuf.numItems,a.numInstances),n.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),n.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),n.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&n.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&n.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPickInvisible=i.getLocation("pickInvisible"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPickZNear=i.getLocation("pickZNear"),this._uPickZFar=i.getLocation("pickZFar"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){this._program.bind()}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points instancing pick depth vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("attribute vec4 modelMatrixCol0;"),s.push("attribute vec4 modelMatrixCol1;"),s.push("attribute vec4 modelMatrixCol2;"),s.push("uniform bool pickInvisible;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("varying vec4 vViewPosition;"),s.push("void main(void) {"),s.push("if (int(flags.w) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(s.push("  vWorldPosition = worldPosition;"),s.push("  vFlags2 = flags2;")),s.push("  vViewPosition = viewPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points instancing pick depth fragment shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),s.push("uniform float pickZNear;"),s.push("uniform float pickZFar;"),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec4 vViewPosition;"),s.push("vec4 packDepth(const in float depth) {"),s.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);"),s.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);"),s.push("  vec4 res = fract(depth * bitShift);"),s.push("  res -= res.xxyz * bitMask;"),s.push("  return res;"),s.push("}"),s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    float zNormalizedDepth = abs((pickZNear + vViewPosition.z) / (pickZFar - pickZNear));"),s.push("    gl_FragColor = packDepth(zNormalizedDepth); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ma=d.vec3();class va{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin,c=r.pointsMaterial._state;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,ma);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aColor&&(this._aColor.bindArrayBuffer(n.colorsBuf),l.vertexAttribDivisorANGLE(this._aColor.location,1)),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),a.uniform1f(this._uPointSize,c.pointSize);const d="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,d),l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),this._aColor&&l.vertexAttribDivisorANGLE(this._aColor.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uRenderPass=s.getLocation("renderPass"),this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=s.getLocation("worldMatrix"),this._uViewMatrix=s.getLocation("viewMatrix"),this._uProjMatrix=s.getLocation("projMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize"),this._uNearPlaneHeight=s.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=s.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points instancing occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 color;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("attribute vec4 modelMatrixCol0;"),s.push("attribute vec4 modelMatrixCol1;"),s.push("attribute vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("      gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&s.push("  vWorldPosition = worldPosition;"),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Points instancing occlusion vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("void main(void) {"),t.pointsMaterial.roundPoints&&(s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }")),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0;t<e.sectionPlanes.length;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return s.push("   gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0); "),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ba=d.vec3();class Pa{constructor(t){this._scene=t,this._hash=this._getHash(),this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()+this._scene.pointsMaterial.hash}drawLayer(t,e,i){const s=e.model,r=s.scene,o=r.camera,a=r.canvas.gl,n=e._state,l=this._instanceExt,h=e._state.origin,c=r.pointsMaterial._state;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram()),a.uniform1i(this._uRenderPass,i),a.uniformMatrix4fv(this._uWorldMatrix,!1,s.worldMatrix),a.uniformMatrix4fv(this._uViewMatrix,!1,h?G(o.viewMatrix,h):o.viewMatrix);const u=r._sectionPlanesState.sectionPlanes.length;if(u>0){const t=r._sectionPlanesState.sectionPlanes,i=e.layerIndex*u,o=s.renderFlags;for(let e=0;e<u;e++){const s=this._uSectionPlanes[e];if(s){const r=o.sectionPlanesActivePerLayer[i+e];if(a.uniform1i(s.active,r?1:0),r){const i=t[e];if(h){const t=W(i.dist,i.dir,h,ba);a.uniform3fv(s.pos,t)}else a.uniform3fv(s.pos,i.pos);a.uniform3fv(s.dir,i.dir)}}}}this._aModelMatrixCol0.bindArrayBuffer(n.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(n.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(n.modelMatrixCol2Buf),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),a.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aPosition.bindArrayBuffer(n.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(n.offsetsBuf),l.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aFlags.bindArrayBuffer(n.flagsBuf),l.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(n.flags2Buf),l.vertexAttribDivisorANGLE(this._aFlags2.location,1)),a.uniform1f(this._uPointSize,c.pointSize);const d="ortho"===r.camera.projection?1:a.drawingBufferHeight/(2*Math.tan(.5*r.camera.perspective.fov*Math.PI/180));a.uniform1f(this._uNearPlaneHeight,d),l.drawArraysInstancedANGLE(a.POINTS,0,n.positionsBuf.numItems,n.numInstances),l.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),l.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),l.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&l.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&l.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const i=this._program;this._uRenderPass=i.getLocation("renderPass"),this._uPositionsDecodeMatrix=i.getLocation("positionsDecodeMatrix"),this._uWorldMatrix=i.getLocation("worldMatrix"),this._uViewMatrix=i.getLocation("viewMatrix"),this._uProjMatrix=i.getLocation("projMatrix"),this._uSectionPlanes=[];for(let e=0,s=t._sectionPlanesState.sectionPlanes.length;e<s;e++)this._uSectionPlanes.push({active:i.getLocation("sectionPlaneActive"+e),pos:i.getLocation("sectionPlanePos"+e),dir:i.getLocation("sectionPlaneDir"+e)});this._aPosition=i.getAttribute("position"),this._aOffset=i.getAttribute("offset"),this._aFlags=i.getAttribute("flags"),this._aFlags2=i.getAttribute("flags2"),this._aModelMatrixCol0=i.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=i.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=i.getAttribute("modelMatrixCol2"),this._uPointSize=i.getLocation("pointSize"),this._uNearPlaneHeight=i.getLocation("nearPlaneHeight"),t.logarithmicDepthBufferEnabled&&(this._uLogDepthBufFC=i.getLocation("logDepthBufFC"))}_bindProgram(){const t=this._scene,e=t.canvas.gl,i=t.camera.project;if(this._program.bind(),e.uniformMatrix4fv(this._uProjMatrix,!1,i.matrix),t.logarithmicDepthBufferEnabled){const t=2/(Math.log(i.far+1)/Math.LN2);e.uniform1f(this._uLogDepthBufFC,t)}}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=t.pointsMaterial._state,s=[];return s.push("// Points instancing depth vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("uniform int renderPass;"),s.push("attribute vec3 position;"),t.entityOffsetsEnabled&&s.push("attribute vec3 offset;"),s.push("attribute vec4 flags;"),s.push("attribute vec4 flags2;"),s.push("attribute vec4 modelMatrixCol0;"),s.push("attribute vec4 modelMatrixCol1;"),s.push("attribute vec4 modelMatrixCol2;"),s.push("uniform mat4 worldMatrix;"),s.push("uniform mat4 viewMatrix;"),s.push("uniform mat4 projMatrix;"),s.push("uniform mat4 positionsDecodeMatrix;"),s.push("uniform float pointSize;"),i.perspectivePoints&&s.push("uniform float nearPlaneHeight;"),t.logarithmicDepthBufferEnabled&&(s.push("uniform float logDepthBufFC;"),ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("varying float vFragDepth;")),e&&(s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;")),s.push("void main(void) {"),s.push("if (int(flags.x) != renderPass) {"),s.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),s.push("} else {"),s.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),s.push("  worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&s.push("      worldPosition.xyz = worldPosition.xyz + offset;"),s.push("  vec4 viewPosition  = viewMatrix * worldPosition; "),e&&(s.push("vWorldPosition = worldPosition;"),s.push("vFlags2 = flags2;")),s.push("vec4 clipPos = projMatrix * viewPosition;"),t.logarithmicDepthBufferEnabled&&(ht.SUPPORTED_EXTENSIONS.EXT_frag_depth?s.push("vFragDepth = 1.0 + clipPos.w;"):(s.push("clipPos.z = log2( max( 1e-6, clipPos.w + 1.0 ) ) * logDepthBufFC - 1.0;"),s.push("clipPos.z *= clipPos.w;"))),s.push("gl_Position = clipPos;"),i.perspectivePoints?(s.push("gl_PointSize = (nearPlaneHeight * pointSize) / clipPos.w;"),s.push("gl_PointSize = max(gl_PointSize, "+Math.floor(i.minPerspectivePointSize)+".0);"),s.push("gl_PointSize = min(gl_PointSize, "+Math.floor(i.maxPerspectivePointSize)+".0);")):s.push("gl_PointSize = pointSize;"),s.push("}"),s.push("}"),s}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState;let i,s;const r=e.sectionPlanes.length>0,o=[];if(o.push("// Points instancing depth vertex shader"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("#extension GL_EXT_frag_depth : enable"),o.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),o.push("precision highp float;"),o.push("precision highp int;"),o.push("#else"),o.push("precision mediump float;"),o.push("precision mediump int;"),o.push("#endif"),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(o.push("uniform float logDepthBufFC;"),o.push("varying float vFragDepth;")),r)for(o.push("varying vec4 vWorldPosition;"),o.push("varying vec4 vFlags2;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("uniform bool sectionPlaneActive"+i+";"),o.push("uniform vec3 sectionPlanePos"+i+";"),o.push("uniform vec3 sectionPlaneDir"+i+";");if(o.push("const float   packUpScale = 256. / 255.;"),o.push("const float   unpackDownscale = 255. / 256.;"),o.push("const vec3    packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );"),o.push("const vec4    unpackFactors = unpackDownscale / vec4( packFactors, 1. );"),o.push("const float   shiftRight8 = 1.0 / 256.;"),o.push("vec4 packDepthToRGBA( const in float v ) {"),o.push("    vec4 r = vec4( fract( v * packFactors ), v );"),o.push("    r.yzw -= r.xyz * shiftRight8;"),o.push("    return r * packUpScale;"),o.push("}"),o.push("void main(void) {"),t.pointsMaterial.roundPoints&&(o.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),o.push("  float r = dot(cxy, cxy);"),o.push("  if (r > 1.0) {"),o.push("       discard;"),o.push("  }")),r){for(o.push("  bool clippable = (float(vFlags2.x) > 0.0);"),o.push("  if (clippable) {"),o.push("  float dist = 0.0;"),i=0,s=e.sectionPlanes.length;i<s;i++)o.push("if (sectionPlaneActive"+i+") {"),o.push("   dist += clamp(dot(-sectionPlaneDir"+i+".xyz, vWorldPosition.xyz - sectionPlanePos"+i+".xyz), 0.0, 1000.0);"),o.push("}");o.push("if (dist > 0.0) { discard; }"),o.push("}")}return o.push("    gl_FragColor = packDepthToRGBA( gl_FragCoord.z); "),t.logarithmicDepthBufferEnabled&&ht.SUPPORTED_EXTENSIONS.EXT_frag_depth&&o.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),o.push("}"),o}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}const ya=d.vec3();class Ma{constructor(t){this._scene=t,this._hash=this._getHash(),this._lastLightId=null,this._allocate()}getValid(){return this._hash===this._getHash()}_getHash(){return this._scene._sectionPlanesState.getHash()}drawLayer(t,e){const i=e.model,s=i.scene,r=s.canvas.gl,o=e._state,a=this._instanceExt;if(!this._program&&(this._allocate(),this.errors))return;t.lastProgramId!==this._program.id&&(t.lastProgramId=this._program.id,this._bindProgram(t,e)),r.uniformMatrix4fv(this._uPositionsDecodeMatrix,!1,e._state.positionsDecodeMatrix),this._aModelMatrixCol0.bindArrayBuffer(o.modelMatrixCol0Buf),this._aModelMatrixCol1.bindArrayBuffer(o.modelMatrixCol1Buf),this._aModelMatrixCol2.bindArrayBuffer(o.modelMatrixCol2Buf),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,1),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,1),this._aPosition.bindArrayBuffer(o.positionsBuf),this._aOffset&&(this._aOffset.bindArrayBuffer(o.offsetsBuf),a.vertexAttribDivisorANGLE(this._aOffset.location,1)),this._aColor.bindArrayBuffer(o.colorsBuf),a.vertexAttribDivisorANGLE(this._aColor.location,1),this._aFlags.bindArrayBuffer(o.flagsBuf),a.vertexAttribDivisorANGLE(this._aFlags.location,1),this._aFlags2&&(this._aFlags2.bindArrayBuffer(o.flags2Buf),a.vertexAttribDivisorANGLE(this._aFlags2.location,1));const n=s._sectionPlanesState.sectionPlanes.length;if(n>0){const t=s._sectionPlanesState.sectionPlanes,o=e.layerIndex*n,a=i.renderFlags,l=e._state.origin;for(let e=0;e<n;e++){const i=this._uSectionPlanes[e];if(i){const s=a.sectionPlanesActivePerLayer[o+e];if(r.uniform1i(i.active,s?1:0),s){const s=t[e];if(l){const t=W(s.dist,s.dir,l,ya);r.uniform3fv(i.pos,t)}else r.uniform3fv(i.pos,s.pos);r.uniform3fv(i.dir,s.dir)}}}}r.uniform1f(this._uPointSize,10),a.drawArraysInstancedANGLE(r.POINTS,0,o.positionsBuf.numItems,o.numInstances),a.vertexAttribDivisorANGLE(this._aModelMatrixCol0.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol1.location,0),a.vertexAttribDivisorANGLE(this._aModelMatrixCol2.location,0),a.vertexAttribDivisorANGLE(this._aColor.location,0),a.vertexAttribDivisorANGLE(this._aFlags.location,0),this._aFlags2&&a.vertexAttribDivisorANGLE(this._aFlags2.location,0),this._aOffset&&a.vertexAttribDivisorANGLE(this._aOffset.location,0)}_allocate(){const t=this._scene,e=t.canvas.gl,i=t._sectionPlanesState;if(this._program=new yt(e,this._buildShader()),this._program.errors)return void(this.errors=this._program.errors);this._instanceExt=e.getExtension("ANGLE_instanced_arrays");const s=this._program;this._uPositionsDecodeMatrix=s.getLocation("positionsDecodeMatrix"),this._uShadowViewMatrix=s.getLocation("shadowViewMatrix"),this._uShadowProjMatrix=s.getLocation("shadowProjMatrix"),this._uSectionPlanes=[];for(let t=0,e=i.sectionPlanes.length;t<e;t++)this._uSectionPlanes.push({active:s.getLocation("sectionPlaneActive"+t),pos:s.getLocation("sectionPlanePos"+t),dir:s.getLocation("sectionPlaneDir"+t)});this._aPosition=s.getAttribute("position"),this._aOffset=s.getAttribute("offset"),this._aColor=s.getAttribute("color"),this._aFlags=s.getAttribute("flags"),this._aFlags2=s.getAttribute("flags2"),this._aModelMatrixCol0=s.getAttribute("modelMatrixCol0"),this._aModelMatrixCol1=s.getAttribute("modelMatrixCol1"),this._aModelMatrixCol2=s.getAttribute("modelMatrixCol2"),this._uPointSize=s.getLocation("pointSize")}_bindProgram(t,e){const i=this._scene.canvas.gl;this._program.bind(),i.uniformMatrix4fv(this._uShadowViewMatrix,!1,t.shadowViewMatrix),i.uniformMatrix4fv(this._uShadowProjMatrix,!1,t.shadowProjMatrix),this._lastLightId=null}_buildShader(){return{vertex:this._buildVertexShader(),fragment:this._buildFragmentShader()}}_buildVertexShader(){const t=this._scene,e=t._sectionPlanesState.sectionPlanes.length>0,i=[];return i.push("// Instancing geometry shadow drawing vertex shader"),i.push("attribute vec3 position;"),t.entityOffsetsEnabled&&i.push("attribute vec3 offset;"),i.push("attribute vec4 color;"),i.push("attribute vec4 flags;"),i.push("attribute vec4 flags2;"),i.push("attribute vec4 modelMatrixCol0;"),i.push("attribute vec4 modelMatrixCol1;"),i.push("attribute vec4 modelMatrixCol2;"),i.push("uniform mat4 shadowViewMatrix;"),i.push("uniform mat4 shadowProjMatrix;"),i.push("uniform mat4 positionsDecodeMatrix;"),i.push("uniform float pointSize;"),e&&(i.push("varying vec4 vWorldPosition;"),i.push("varying vec4 vFlags2;")),i.push("void main(void) {"),i.push("bool visible      = (float(flags.x) > 0.0);"),i.push("bool transparent  = ((float(color.a) / 255.0) < 1.0);"),i.push("if (!visible || transparent) {"),i.push("   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);"),i.push("} else {"),i.push("  vec4 worldPosition = positionsDecodeMatrix * vec4(position, 1.0); "),i.push("  worldPosition = vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);"),t.entityOffsetsEnabled&&i.push("      worldPosition.xyz = worldPosition.xyz + offset;"),i.push("  vec4 viewPosition  = shadowViewMatrix * worldPosition; "),e&&(i.push("vWorldPosition = worldPosition;"),i.push("vFlags2 = flags2;")),i.push("  gl_Position = shadowProjMatrix * viewPosition;"),i.push("}"),i.push("gl_PointSize = pointSize;"),i.push("}"),i}_buildFragmentShader(){const t=this._scene,e=t._sectionPlanesState,i=e.sectionPlanes.length>0,s=[];if(s.push("// Instancing geometry depth drawing fragment shader"),t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("#extension GL_EXT_frag_depth : enable"),s.push("#ifdef GL_FRAGMENT_PRECISION_HIGH"),s.push("precision highp float;"),s.push("precision highp int;"),s.push("#else"),s.push("precision mediump float;"),s.push("precision mediump int;"),s.push("#endif"),t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&(s.push("uniform float logDepthBufFC;"),s.push("varying float vFragDepth;")),i){s.push("varying vec4 vWorldPosition;"),s.push("varying vec4 vFlags2;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("uniform bool sectionPlaneActive"+t+";"),s.push("uniform vec3 sectionPlanePos"+t+";"),s.push("uniform vec3 sectionPlaneDir"+t+";")}if(s.push("varying vec3 vViewNormal;"),s.push("vec3 packNormalToRGB( const in vec3 normal ) {"),s.push("    return normalize( normal ) * 0.5 + 0.5;"),s.push("}"),s.push("void main(void) {"),s.push("  vec2 cxy = 2.0 * gl_PointCoord - 1.0;"),s.push("  float r = dot(cxy, cxy);"),s.push("  if (r > 1.0) {"),s.push("       discard;"),s.push("  }"),i){s.push("  bool clippable = (float(vFlags2.x) > 0.0);"),s.push("  if (clippable) {"),s.push("  float dist = 0.0;");for(let t=0,i=e.sectionPlanes.length;t<i;t++)s.push("if (sectionPlaneActive"+t+") {"),s.push("   dist += clamp(dot(-sectionPlaneDir"+t+".xyz, vWorldPosition.xyz - sectionPlanePos"+t+".xyz), 0.0, 1000.0);"),s.push("}");s.push("if (dist > 0.0) { discard; }"),s.push("}")}return t.logarithmicDepthBufferEnabled&&WEBGL_INFO.SUPPORTED_EXTENSIONS.EXT_frag_depth&&s.push("gl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;"),s.push("    gl_FragColor = vec4(packNormalToRGB(vViewNormal), 1.0); "),s.push("}"),s}webglContextRestored(){this._program=null}destroy(){this._program&&this._program.destroy(),this._program=null}}class xa{constructor(t){this._scene=t}_compile(){this._colorRenderer&&!this._colorRenderer.getValid()&&(this._colorRenderer.destroy(),this._colorRenderer=null),this._depthRenderer&&!this._depthRenderer.getValid()&&(this._depthRenderer.destroy(),this._depthRenderer=null),this._silhouetteRenderer&&!this._silhouetteRenderer.getValid()&&(this._silhouetteRenderer.destroy(),this._silhouetteRenderer=null),this._pickMeshRenderer&&!this._pickMeshRenderer.getValid()&&(this._pickMeshRenderer.destroy(),this._pickMeshRenderer=null),this._pickDepthRenderer&&!this._pickDepthRenderer.getValid()&&(this._pickDepthRenderer.destroy(),this._pickDepthRenderer=null),this._occlusionRenderer&&!1===this._occlusionRenderer.getValid()&&(this._occlusionRenderer.destroy(),this._occlusionRenderer=null),this._shadowRenderer&&!this._shadowRenderer.getValid()&&(this._shadowRenderer.destroy(),this._shadowRenderer=null)}get colorRenderer(){return this._colorRenderer||(this._colorRenderer=new ca(this._scene,!1)),this._colorRenderer}get silhouetteRenderer(){return this._silhouetteRenderer||(this._silhouetteRenderer=new da(this._scene)),this._silhouetteRenderer}get depthRenderer(){return this._depthRenderer||(this._depthRenderer=new Pa(this._scene)),this._depthRenderer}get pickMeshRenderer(){return this._pickMeshRenderer||(this._pickMeshRenderer=new _a(this._scene)),this._pickMeshRenderer}get pickDepthRenderer(){return this._pickDepthRenderer||(this._pickDepthRenderer=new ga(this._scene)),this._pickDepthRenderer}get occlusionRenderer(){return this._occlusionRenderer||(this._occlusionRenderer=new va(this._scene)),this._occlusionRenderer}get shadowRenderer(){return this._shadowRenderer||(this._shadowRenderer=new Ma(this._scene)),this._shadowRenderer}_destroy(){this._colorRenderer&&this._colorRenderer.destroy(),this._depthRenderer&&this._depthRenderer.destroy(),this._silhouetteRenderer&&this._silhouetteRenderer.destroy(),this._pickMeshRenderer&&this._pickMeshRenderer.destroy(),this._pickDepthRenderer&&this._pickDepthRenderer.destroy(),this._occlusionRenderer&&this._occlusionRenderer.destroy(),this._shadowRenderer&&this._shadowRenderer.destroy()}}const wa={};const Ea=new Uint8Array(4),Aa=d.vec4([0,0,0,1]),Ca=d.vec4([0,0,0,1]),Sa=d.vec4([0,0,0,1]),Da=new Float32Array(3);class La{constructor(t,e){this.sortId="PointsInstancingLayer",this.layerIndex=e.layerIndex,this._pointsInstancingRenderers=function(t){const e=t.id;let i=wa[e];return i||(i=new xa(t),wa[e]=i,i._compile(),t.on("compile",(()=>{i._compile()})),t.on("destroyed",(()=>{delete wa[e],i._destroy()}))),i}(t.scene),this.model=t,this._aabb=d.collapseAABB3();const i=t.scene.canvas.gl,s={positionsDecodeMatrix:d.mat4(),numInstances:0,obb:d.OBB3(),origin:null},r=!!e.positionsDecodeMatrix;if(!e.positions)throw"positions expected";const o=e.positions.length/3;if(r){let t=!1;s.positionsBuf=new Mt(i,i.ARRAY_BUFFER,e.positions,e.positions.length,3,i.STATIC_DRAW,t),s.positionsDecodeMatrix.set(e.positionsDecodeMatrix);let r=d.collapseAABB3();d.expandAABB3Points3(r,e.positions),ve.decompressAABB(r,s.positionsDecodeMatrix),d.AABB3ToOBB3(r,s.obb)}else{let t=e.positions.length,r=d.collapseAABB3();d.expandAABB3Points3(r,e.positions),d.AABB3ToOBB3(r,s.obb);const o=Js(e.positions,r,s.positionsDecodeMatrix);let a=!1;s.positionsBuf=new Mt(i,i.ARRAY_BUFFER,o,t,3,i.STATIC_DRAW,a)}if(e.colorsCompressed){const t=new Uint8Array(e.colorsCompressed);let r=!1;s.colorsBuf=new Mt(i,i.ARRAY_BUFFER,t,t.length,4,i.STATIC_DRAW,r)}else if(e.colors){const t=e.colors,r=new Uint8Array(t.length);for(let e=0,i=t.length;e<i;e++)r[e]=255*t[e];let o=!1;s.colorsBuf=new Mt(i,i.ARRAY_BUFFER,r,r.length,4,i.STATIC_DRAW,o)}else{const t=new Uint8Array(4*o);for(let e=0,i=4*o;e<i;e++)t[e]=255;let e=!1;s.colorsBuf=new Mt(i,i.ARRAY_BUFFER,t,t.length,4,i.STATIC_DRAW,e)}this._state=new Gt(s),this._numPortions=0,this._numVisibleLayerPortions=0,this._numTransparentLayerPortions=0,this._numXRayedLayerPortions=0,this._numHighlightedLayerPortions=0,this._numSelectedLayerPortions=0,this._numClippableLayerPortions=0,this._numEdgesLayerPortions=0,this._numPickableLayerPortions=0,this._numCulledLayerPortions=0,this._pickColors=[],this._offsets=[],this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[],this._portions=[],e.origin&&(this._state.origin=d.vec3(e.origin)),this._finalized=!1,this.aabb=d.collapseAABB3()}createPortion(t){const e=t.meshMatrix,i=t.worldMatrix,s=t.aabb,r=t.pickColor;if(this._finalized)throw"Already finalized";this.model.scene.entityOffsetsEnabled&&(this._offsets.push(0),this._offsets.push(0),this._offsets.push(0)),this._modelMatrixCol0.push(e[0]),this._modelMatrixCol0.push(e[4]),this._modelMatrixCol0.push(e[8]),this._modelMatrixCol0.push(e[12]),this._modelMatrixCol1.push(e[1]),this._modelMatrixCol1.push(e[5]),this._modelMatrixCol1.push(e[9]),this._modelMatrixCol1.push(e[13]),this._modelMatrixCol2.push(e[2]),this._modelMatrixCol2.push(e[6]),this._modelMatrixCol2.push(e[10]),this._modelMatrixCol2.push(e[14]),this._pickColors.push(r[0]),this._pickColors.push(r[1]),this._pickColors.push(r[2]),this._pickColors.push(r[3]),d.collapseAABB3(s);const o=this._state.obb,a=o.length;for(let t=0;t<a;t+=4)Aa[0]=o[t+0],Aa[1]=o[t+1],Aa[2]=o[t+2],d.transformPoint4(e,Aa,Ca),i?(d.transformPoint4(i,Ca,Sa),d.expandAABB3Point3(s,Sa)):d.expandAABB3Point3(s,Ca);if(this._state.origin){const t=this._state.origin;s[0]+=t[0],s[1]+=t[1],s[2]+=t[2],s[3]+=t[0],s[4]+=t[1],s[5]+=t[2]}d.expandAABB3(this.aabb,s),this._state.numInstances++;const n=this._portions.length;return this._portions.push({}),this._numPortions++,this.model.numPortions++,n}finalize(){if(this._finalized)throw"Already finalized";const t=this.model.scene.canvas.gl,e=this._pickColors.length;if(e>0){let i=!1,s=!0;this._state.flagsBuf=new Mt(t,t.ARRAY_BUFFER,new Uint8Array(e),e,4,t.DYNAMIC_DRAW,i),this._state.flags2Buf=new Mt(t,t.ARRAY_BUFFER,new Uint8Array(e),e,4,t.DYNAMIC_DRAW,s)}if(this.model.scene.entityOffsetsEnabled&&this._offsets.length>0){const e=!1;this._state.offsetsBuf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._offsets),this._offsets.length,3,t.DYNAMIC_DRAW,e),this._offsets=[]}if(this._modelMatrixCol0.length>0){const e=!1;this._state.modelMatrixCol0Buf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol0),this._modelMatrixCol0.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol1Buf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol1),this._modelMatrixCol1.length,4,t.STATIC_DRAW,e),this._state.modelMatrixCol2Buf=new Mt(t,t.ARRAY_BUFFER,new Float32Array(this._modelMatrixCol2),this._modelMatrixCol2.length,4,t.STATIC_DRAW,e),this._modelMatrixCol0=[],this._modelMatrixCol1=[],this._modelMatrixCol2=[]}if(this._pickColors.length>0){const e=!1;this._state.pickColorsBuf=new Mt(t,t.ARRAY_BUFFER,new Uint8Array(this._pickColors),this._pickColors.length,4,t.STATIC_DRAW,e),this._pickColors=[]}this._finalized=!0}initFlags(t,e,i){e&D&&(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++),e&N&&(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++),e&F&&(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++),e&I&&(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++),e&R&&(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++),e&k&&(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++),e&B&&(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++),e&L&&(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++),i&&(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++),this._setFlags(t,e,i),this._setFlags2(t,e)}setVisible(t,e,i){if(!this._finalized)throw"Not finalized";e&D?(this._numVisibleLayerPortions++,this.model.numVisibleLayerPortions++):(this._numVisibleLayerPortions--,this.model.numVisibleLayerPortions--),this._setFlags(t,e,i)}setHighlighted(t,e,i){if(!this._finalized)throw"Not finalized";e&N?(this._numHighlightedLayerPortions++,this.model.numHighlightedLayerPortions++):(this._numHighlightedLayerPortions--,this.model.numHighlightedLayerPortions--),this._setFlags(t,e,i)}setXRayed(t,e,i){if(!this._finalized)throw"Not finalized";e&F?(this._numXRayedLayerPortions++,this.model.numXRayedLayerPortions++):(this._numXRayedLayerPortions--,this.model.numXRayedLayerPortions--),this._setFlags(t,e,i)}setSelected(t,e,i){if(!this._finalized)throw"Not finalized";e&I?(this._numSelectedLayerPortions++,this.model.numSelectedLayerPortions++):(this._numSelectedLayerPortions--,this.model.numSelectedLayerPortions--),this._setFlags(t,e,i)}setEdges(t,e,i){if(!this._finalized)throw"Not finalized";e&k?(this._numEdgesLayerPortions++,this.model.numEdgesLayerPortions++):(this._numEdgesLayerPortions--,this.model.numEdgesLayerPortions--),this._setFlags(t,e,i)}setClippable(t,e){if(!this._finalized)throw"Not finalized";e&R?(this._numClippableLayerPortions++,this.model.numClippableLayerPortions++):(this._numClippableLayerPortions--,this.model.numClippableLayerPortions--),this._setFlags2(t,e)}setCollidable(t,e){if(!this._finalized)throw"Not finalized"}setPickable(t,e,i){if(!this._finalized)throw"Not finalized";e&B?(this._numPickableLayerPortions++,this.model.numPickableLayerPortions++):(this._numPickableLayerPortions--,this.model.numPickableLayerPortions--),this._setFlags2(t,e,i)}setCulled(t,e,i){if(!this._finalized)throw"Not finalized";e&L?(this._numCulledLayerPortions++,this.model.numCulledLayerPortions++):(this._numCulledLayerPortions--,this.model.numCulledLayerPortions--),this._setFlags(t,e,i)}setColor(t,e){if(!this._finalized)throw"Not finalized";Ea[0]=e[0],Ea[1]=e[1],Ea[2]=e[2],this._state.colorsBuf.setData(Ea,3*t,3)}setTransparent(t,e,i){i?(this._numTransparentLayerPortions++,this.model.numTransparentLayerPortions++):(this._numTransparentLayerPortions--,this.model.numTransparentLayerPortions--),this._setFlags(t,e,i)}_setFlags(t,e,i){if(!this._finalized)throw"Not finalized";const s=!!(e&D),r=!!(e&F),o=!!(e&N),a=!!(e&I),n=!!(e&L);let l,h;l=!s||n||r?es:i?ss:is,h=!s||n?es:a?os:o?rs:r?as:es;let c=0;c=!s||n?es:a?cs:o?hs:r?us:!!(e&k)?i?ls:ns:es;let u=s&&!n&&!!(e&B)?ds:es;Ea[0]=l,Ea[1]=h,Ea[2]=c,Ea[3]=u,this._state.flagsBuf.setData(Ea,4*t,4)}_setFlags2(t,e){if(!this._finalized)throw"Not finalized";const i=e&R?255:0;Ea[0]=i,this._state.flags2Buf.setData(Ea,4*t,4)}setOffset(t,e){if(!this._finalized)throw"Not finalized";this.model.scene.entityOffsetsEnabled?(Da[0]=e[0],Da[1]=e[1],Da[2]=e[2],this._state.offsetsBuf.setData(Da,3*t,3)):this.model.error("Entity#offset not enabled for this Viewer")}drawColorOpaque(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._numTransparentLayerPortions!==this._numPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsInstancingRenderers.colorRenderer&&this._pointsInstancingRenderers.colorRenderer.drawLayer(e,this,is)}drawColorTransparent(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numTransparentLayerPortions&&this._numXRayedLayerPortions!==this._numPortions&&this._pointsInstancingRenderers.colorRenderer&&this._pointsInstancingRenderers.colorRenderer.drawLayer(e,this,ss)}drawDepth(t,e){}drawNormals(t,e){}drawSilhouetteXRayed(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numXRayedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(e,this,as)}drawSilhouetteHighlighted(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numHighlightedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(e,this,rs)}drawSilhouetteSelected(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&0!==this._numSelectedLayerPortions&&this._pointsInstancingRenderers.silhouetteRenderer&&this._pointsInstancingRenderers.silhouetteRenderer.drawLayer(e,this,os)}drawEdgesColorOpaque(t,e){}drawEdgesColorTransparent(t,e){}drawEdgesHighlighted(t,e){}drawEdgesSelected(t,e){}drawEdgesXRayed(t,e){}drawOcclusion(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.occlusionRenderer&&this._pointsInstancingRenderers.occlusionRenderer.drawLayer(e,this,is)}drawShadow(t,e){}drawPickMesh(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.pickMeshRenderer&&this._pointsInstancingRenderers.pickMeshRenderer.drawLayer(e,this,ds)}drawPickDepths(t,e){this._numCulledLayerPortions!==this._numPortions&&0!==this._numVisibleLayerPortions&&this._pointsInstancingRenderers.pickDepthRenderer&&this._pointsInstancingRenderers.pickDepthRenderer.drawLayer(e,this,ds)}drawPickNormals(t,e){}destroy(){const t=this._state;t.positionsBuf&&(t.positionsBuf.destroy(),t.positionsBuf=null),t.colorsBuf&&(t.colorsBuf.destroy(),t.colorsBuf=null),t.flagsBuf&&(t.flagsBuf.destroy(),t.flagsBuf=null),t.flags2Buf&&(t.flags2Buf.destroy(),t.flags2Buf=null),t.offsetsBuf&&(t.offsetsBuf.destroy(),t.offsetsBuf=null),t.modelMatrixCol0Buf&&(t.modelMatrixCol0Buf.destroy(),t.modelMatrixCol0Buf=null),t.modelMatrixCol1Buf&&(t.modelMatrixCol1Buf.destroy(),t.modelMatrixCol1Buf=null),t.modelMatrixCol2Buf&&(t.modelMatrixCol2Buf.destroy(),t.modelMatrixCol2Buf=null),t.pickColorsBuf&&(t.pickColorsBuf.destroy(),t.pickColorsBuf=null),t.destroy()}}const Ba=ht.SUPPORTED_EXTENSIONS.ANGLE_instanced_arrays,Ra=d.vec3(),Ta=d.mat4(),Fa=d.vec3([1,1,1]),Na=d.vec3([0,0,0]),Ia=d.vec3([0,0,0]),ka=d.identityQuaternion();class Oa extends S{constructor(t,e={}){super(t,e),this._maxGeometryBatchSize=e.maxGeometryBatchSize,this._aabb=d.collapseAABB3(),this._aabbDirty=!1,this._layerList=[],this._nodeList=[],this._lastOrigin=null,this._lastDecodeMatrix=null,this._lastNormals=null,this._instancingLayers={},this._currentBatchingLayers={},this._scratchMemory=(ts++,Ji),this._meshes={},this._nodes={},this.renderFlags=new yi,this.numGeometries=0,this.numPortions=0,this.numVisibleLayerPortions=0,this.numTransparentLayerPortions=0,this.numXRayedLayerPortions=0,this.numHighlightedLayerPortions=0,this.numSelectedLayerPortions=0,this.numEdgesLayerPortions=0,this.numPickableLayerPortions=0,this.numClippableLayerPortions=0,this.numCulledLayerPortions=0,this.numEntities=0,this._numTriangles=0,this._numLines=0,this._numPoints=0,this._edgeThreshold=e.edgeThreshold||10,this.visible=e.visible,this.culled=e.culled,this.pickable=e.pickable,this.clippable=e.clippable,this.collidable=e.collidable,this.castsShadow=e.castsShadow,this.receivesShadow=e.receivesShadow,this.xrayed=e.xrayed,this.highlighted=e.highlighted,this.selected=e.selected,this.edges=e.edges,this.colorize=e.colorize,this.opacity=e.opacity,this.backfaces=e.backfaces,this._origin=d.vec3(e.origin||[0,0,0]),this._position=d.vec3(e.position||[0,0,0]),this._rotation=d.vec3(e.rotation||[0,0,0]),this._quaternion=d.vec4(e.quaternion||[0,0,0,1]),e.rotation&&d.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._scale=d.vec3(e.scale||[1,1,1]),this._worldMatrix=d.mat4(),d.composeMat4(this._position,this._quaternion,this._scale,this._worldMatrix),this._worldNormalMatrix=d.mat4(),d.inverseMat4(this._worldMatrix,this._worldNormalMatrix),d.transposeMat4(this._worldNormalMatrix),(e.matrix||e.position||e.rotation||e.scale||e.quaternion)&&(this._viewMatrix=d.mat4(),this._viewNormalMatrix=d.mat4(),this._viewMatrixDirty=!0,this._worldMatrixNonIdentity=!0),this._opacity=1,this._colorize=[1,1,1],this._saoEnabled=!1!==e.saoEnabled,this._pbrEnabled=!!e.pbrEnabled,this._isModel=e.isModel,this._isModel&&this.scene._registerModel(this),this._onCameraViewMatrix=this.scene.camera.on("matrix",(()=>{this._viewMatrixDirty=!0}))}get isPerformanceModel(){return!0}get objects(){return this._nodes}get origin(){return this._origin}get position(){return this._position}get rotation(){return this._rotation}get quaternion(){return this._quaternion}get scale(){return this._scale}get matrix(){return this._worldMatrix}get worldMatrix(){return this._worldMatrix}get worldNormalMatrix(){return this._worldNormalMatrix}get viewMatrix(){return this._viewMatrix?(this._viewMatrixDirty&&(d.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),d.inverseMat4(this._viewMatrix,this._viewNormalMatrix),d.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewMatrix):this.scene.camera.viewMatrix}get viewNormalMatrix(){return this._viewNormalMatrix?(this._viewMatrixDirty&&(d.mulMat4(this.scene.camera.viewMatrix,this._worldMatrix,this._viewMatrix),d.inverseMat4(this._viewMatrix,this._viewNormalMatrix),d.transposeMat4(this._viewNormalMatrix),this._viewMatrixDirty=!1),this._viewNormalMatrix):this.scene.camera.viewNormalMatrix}get backfaces(){return this._backfaces}set backfaces(t){t=!!t,this._backfaces=t,this.glRedraw()}get entityList(){return this._nodeList}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return!1}get aabb(){return this._aabbDirty&&this._rebuildAABB(),this._aabb}get numTriangles(){return this._numTriangles}get numLines(){return this._numLines}get numPoints(){return this._numPoints}get visible(){return this.numVisibleLayerPortions>0}set visible(t){t=!1!==t,this._visible=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].visible=t;this.glRedraw()}get xrayed(){return this.numXRayedLayerPortions>0}set xrayed(t){t=!!t,this._xrayed=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].xrayed=t;this.glRedraw()}get highlighted(){return this.numHighlightedLayerPortions>0}set highlighted(t){t=!!t,this._highlighted=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].highlighted=t;this.glRedraw()}get selected(){return this.numSelectedLayerPortions>0}set selected(t){t=!!t,this._selected=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].selected=t;this.glRedraw()}get edges(){return this.numEdgesLayerPortions>0}set edges(t){t=!!t,this._edges=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].edges=t;this.glRedraw()}get culled(){return this._culled}set culled(t){t=!!t,this._culled=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].culled=t;this.glRedraw()}get clippable(){return this._clippable}set clippable(t){t=!1!==t,this._clippable=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].clippable=t;this.glRedraw()}get collidable(){return this._collidable}set collidable(t){t=!1!==t,this._collidable=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].collidable=t}get pickable(){return this.numPickableLayerPortions>0}set pickable(t){t=!1!==t,this._pickable=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].pickable=t}get colorize(){return this._colorize}set colorize(t){this._colorize=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].colorize=t}get opacity(){return this._opacity}set opacity(t){this._opacity=t;for(let e=0,i=this._nodeList.length;e<i;e++)this._nodeList[e].opacity=t}get castsShadow(){return this._castsShadow}set castsShadow(t){(t=!1!==t)!==this._castsShadow&&(this._castsShadow=t,this.glRedraw())}get receivesShadow(){return this._receivesShadow}set receivesShadow(t){(t=!1!==t)!==this._receivesShadow&&(this._receivesShadow=t,this.glRedraw())}get saoEnabled(){return this._saoEnabled}get pbrEnabled(){return this._pbrEnabled}get isDrawable(){return!0}get isStateSortable(){return!1}get xrayMaterial(){return this.scene.xrayMaterial}get highlightMaterial(){return this.scene.highlightMaterial}get selectedMaterial(){return this.scene.selectedMaterial}get edgeMaterial(){return this.scene.edgeMaterial}getPickViewMatrix(t){return this._viewMatrix?this._viewMatrix:t}createGeometry(t){if(!Ba)return void this.error("WebGL instanced arrays not supported");const e=t.id;if(null==e)return void this.error("Config missing: id");if(this._instancingLayers[e])return void this.error("Geometry already created: "+e);let i;const s=t.primitive;if(null==s)return void this.error("Config missing: primitive");const r=t.origin||t.rtcCenter,o=r?d.addVec3(this._origin,r,Ra):this._origin;switch(s){case"triangles":case"solid":i=new po(this,m.apply({origin:o,layerIndex:0,solid:!0},t)),this._numTriangles+=t.indices?Math.round(t.indices.length/3):0;break;case"surface":i=new po(this,m.apply({origin:o,layerIndex:0,solid:!1},t)),this._numTriangles+=t.indices?Math.round(t.indices.length/3):0;break;case"lines":i=new zo(this,m.apply({origin:o,layerIndex:0},t)),this._numLines+=t.indices?Math.round(t.indices.length/2):0;break;case"points":i=new La(this,m.apply({origin:o,layerIndex:0},t)),this._numPoints+=t.positions?Math.round(t.positions.length/3):0}this._instancingLayers[e]=i,this._layerList.push(i),this.numGeometries++}createMesh(t){let e=t.id;if(null==e)return void this.error("Config missing: id");if(this._meshes[e])return void this.error("PerformanceModel already has a Mesh with this ID: "+e);const i=t.geometryId,s=void 0!==i;if(s){if(!Ba)return void this.error("WebGL instanced arrays not supported");if(!this._instancingLayers[i])return void this.error("Geometry not found: "+i+" - ensure that you create it first with createGeometry()")}let r,o;const a=t.color?new Uint8Array([Math.floor(255*t.color[0]),Math.floor(255*t.color[1]),Math.floor(255*t.color[2])]):[255,255,255],n=void 0!==t.opacity&&null!==t.opacity?Math.floor(255*t.opacity):255,l=void 0!==t.metallic&&null!==t.metallic?Math.floor(255*t.metallic):0,h=void 0!==t.roughness&&null!==t.roughness?Math.floor(255*t.roughness):255,c=new $i(this,e,a,n),u=c.pickId,p=new Uint8Array([255&u,u>>8&255,u>>16&255,u>>24&255]),_=d.collapseAABB3();if(s){let e,s=this._worldMatrixNonIdentity?this._worldMatrix:null;if(t.matrix)e=t.matrix;else{const i=t.scale||Fa,s=t.position||Na,r=t.rotation||Ia;d.eulerToQuaternion(r,"XYZ",ka),e=d.composeMat4(s,ka,i,Ta)}const u=this._instancingLayers[i];r=u,o=u.createPortion({color:a,metallic:l,roughness:h,opacity:n,meshMatrix:e,worldMatrix:s,aabb:_,pickColor:p}),d.expandAABB3(this._aabb,_);const f=Math.round(u.numIndices/3);this._numTriangles+=f,c.numTriangles=f,c.origin=u.origin}else{let e=t.primitive||"triangles";"points"!==e&&"lines"!==e&&"triangles"!==e&&"solid"!==e&&"surface"!==e&&(this.error(`Unsupported value for 'primitive': '${e}' - supported values are 'points', 'lines', 'triangles', 'solid' and 'surface'. Defaulting to 'triangles'.`),e="triangles");let i=t.positions;if(!i)return this.error("Config missing: positions (no meshIds provided, so expecting geometry arrays instead)"),null;let s=t.indices,u=t.edgeIndices;if(!t.indices&&"triangles"===e)return this.error("Config missing for triangles primitive: indices (no meshIds provided, so expecting geometry arrays instead)"),null;let f=!1,g=null;if(!t.positionsDecodeMatrix){const t=d.vec3(),e=[];X(i,e,t)&&(i=e,g=d.addVec3(this._origin,t,t))}const m=t.origin||t.rtcCenter;if(g=m?g?d.addVec3(this._origin,m,Ra):m:this._origin,g&&(this._lastOrigin?d.compareVec3(this._lastOrigin,g)||(f=!0,this._lastOrigin.set(g)):(f=!0,this._lastOrigin=d.vec3(g))),t.positionsDecodeMatrix&&(this._lastDecodeMatrix?d.compareMat4(this._lastDecodeMatrix,t.positionsDecodeMatrix)||(f=!0,this._lastDecodeMatrix.set(t.positionsDecodeMatrix)):(f=!0,this._lastDecodeMatrix=d.mat4(t.positionsDecodeMatrix))),f){for(let t in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(t)&&this._currentBatchingLayers[t].finalize();this._currentBatchingLayers={}}const v=!!t.normals&&t.normals.length>0;"triangles"!==e&&"solid"!==e&&"surface"!==e||(null!==this._lastNormals&&v!==this._lastNormals&&["triangles","solid","surface"].map((t=>{this._currentBatchingLayers[t]&&(this._currentBatchingLayers[t].finalize(),delete this._currentBatchingLayers[t])})),this._lastNormals=v);const b=this._worldMatrixNonIdentity?this._worldMatrix:null;let P;if(!t.positionsDecodeMatrix)if(t.matrix)P=t.matrix;else{const e=t.scale||Fa,i=t.position||Na,s=t.rotation||Ia;d.eulerToQuaternion(s,"XYZ",ka),P=d.composeMat4(i,ka,e,Ta)}switch(r=this._currentBatchingLayers[e],e){case"triangles":case"solid":case"surface":r&&(r.canCreatePortion(i.length,s.length)||(r.finalize(),delete this._currentBatchingLayers[e],r=null)),r||(r=new mr(this,{layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:t.positionsDecodeMatrix,origin:g,maxGeometryBatchSize:this._maxGeometryBatchSize,solid:"solid"===e,autoNormals:!v}),this._layerList.push(r),this._currentBatchingLayers[e]=r),u||(u=ue(i,s,null,this._edgeThreshold)),o=r.createPortion({positions:i,normals:t.normals,indices:s,edgeIndices:u,color:a,metallic:l,roughness:h,colors:t.colors,colorsCompressed:t.colorsCompressed,opacity:n,meshMatrix:P,worldMatrix:b,worldAABB:_,pickColor:p});const d=Math.round(s.length/3);this._numTriangles+=d,c.numTriangles=d;break;case"lines":r&&(r.canCreatePortion(i.length,s.length)||(r.finalize(),delete this._currentBatchingLayers[e],r=null)),r||(r=new Co(this,{layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:t.positionsDecodeMatrix,origin:g,maxGeometryBatchSize:this._maxGeometryBatchSize}),this._layerList.push(r),this._currentBatchingLayers[e]=r),o=r.createPortion({positions:i,indices:s,color:a,colors:t.colors,colorsCompressed:t.colorsCompressed,opacity:n,meshMatrix:P,worldMatrix:b,worldAABB:_,pickColor:p}),this._numLines+=Math.round(s.length/2);break;case"points":r&&(r.canCreatePortion(i.length)||(r.finalize(),delete this._currentBatchingLayers[e],r=null)),r||(r=new la(this,{layerIndex:0,scratchMemory:this._scratchMemory,positionsDecodeMatrix:t.positionsDecodeMatrix,origin:g,maxGeometryBatchSize:this._maxGeometryBatchSize}),this._layerList.push(r),this._currentBatchingLayers[e]=r),o=r.createPortion({positions:i,color:a,colors:t.colors,colorsCompressed:t.colorsCompressed,opacity:n,meshMatrix:P,worldMatrix:b,worldAABB:_,pickColor:p}),this._numPoints+=Math.round(i.length/3)}d.expandAABB3(this._aabb,_),this.numGeometries++,c.origin=g}c.parent=null,c._layer=r,c._portionId=o,c.aabb=_,this._meshes[e]=c}createEntity(t){let e=t.id;void 0===e?e=d.createUUID():this.scene.components[e]&&(this.error("Scene already has a Component with this ID: "+e+" - will assign random ID"),e=d.createUUID());const i=t.meshIds;if(void 0===i)return void this.error("Config missing: meshIds");let s=[];for(let t=0,e=i.length;t<e;t++){const e=i[t],r=this._meshes[e];r?r.parent?this.error("Mesh with ID "+e+" already belongs to object with ID "+r.parent.id+" - ignoring this mesh"):s.push(r):this.error("Mesh with this ID not found: "+e+" - ignoring this mesh")}let r,o=0;if(this._visible&&!1!==t.visible&&(o|=D),this._pickable&&!1!==t.pickable&&(o|=B),this._culled&&!1!==t.culled&&(o|=L),this._clippable&&!1!==t.clippable&&(o|=R),this._collidable&&!1!==t.collidable&&(o|=T),this._edges&&!1!==t.edges&&(o|=k),this._xrayed&&!1!==t.xrayed&&(o|=F),this._highlighted&&!1!==t.highlighted&&(o|=N),this._selected&&!1!==t.selected&&(o|=I),1===s.length)r=s[0].aabb;else{r=d.collapseAABB3();for(let t=0,e=s.length;t<e;t++)d.expandAABB3(r,s[t].aabb)}const a=new z(this,t.isObject,e,s,o,r);return this._nodeList.push(a),this._nodes[e]=a,this.numEntities++,a}finalize(){if(!this.destroyed){for(const t in this._instancingLayers)this._instancingLayers.hasOwnProperty(t)&&this._instancingLayers[t].finalize();for(let t in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(t)&&this._currentBatchingLayers[t].finalize();this._currentBatchingLayers={};for(let t=0,e=this._nodeList.length;t<e;t++){this._nodeList[t]._finalize()}for(let t=0,e=this._nodeList.length;t<e;t++){this._nodeList[t]._finalize2()}this._layerList.sort(((t,e)=>t.sortId<e.sortId?-1:t.sortId>e.sortId?1:0));for(let t=0,e=this._layerList.length;t<e;t++){this._layerList[t].layerIndex=t}this.glRedraw(),this.scene._aabbDirty=!0}}_rebuildAABB(){d.collapseAABB3(this._aabb);for(let t=0,e=this._nodeList.length;t<e;t++){const e=this._nodeList[t];d.expandAABB3(this._aabb,e.aabb)}this._aabbDirty=!1}stateSortCompare(t,e){}rebuildRenderFlags(){this.renderFlags.reset(),this._updateRenderFlagsVisibleLayers(),this.renderFlags.numLayers>0&&0===this.renderFlags.numVisibleLayers?this.renderFlags.culled=!0:this._updateRenderFlags()}_updateRenderFlagsVisibleLayers(){const t=this.renderFlags;t.numLayers=this._layerList.length,t.numVisibleLayers=0;for(let e=0,i=this._layerList.length;e<i;e++){const i=this._layerList[e];this._getActiveSectionPlanesForLayer(i)&&(t.visibleLayers[t.numVisibleLayers++]=e)}}_getActiveSectionPlanesForLayer(t){const e=this.renderFlags,i=this.scene._sectionPlanesState.sectionPlanes,s=i.length,r=t.layerIndex*s;if(s>0)for(let t=0;t<s;t++){i[t].active?(e.sectionPlanesActivePerLayer[r+t]=!0,e.sectioned=!0):e.sectionPlanesActivePerLayer[r+t]=!1}return!0}_updateRenderFlags(){if(0===this.numVisibleLayerPortions)return;if(this.numCulledLayerPortions===this.numPortions)return;const t=this.renderFlags;if(t.colorOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(t.colorTransparent=!0),this.numXRayedLayerPortions>0){const e=this.scene.xrayMaterial._state;e.fill&&(e.fillAlpha<1?t.xrayedSilhouetteTransparent=!0:t.xrayedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.xrayedEdgesTransparent=!0:t.xrayedEdgesOpaque=!0)}if(this.numEdgesLayerPortions>0){this.scene.edgeMaterial._state.edges&&(t.edgesOpaque=this.numTransparentLayerPortions<this.numPortions,this.numTransparentLayerPortions>0&&(t.edgesTransparent=!0))}if(this.numSelectedLayerPortions>0){const e=this.scene.selectedMaterial._state;e.fill&&(e.fillAlpha<1?t.selectedSilhouetteTransparent=!0:t.selectedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.selectedEdgesTransparent=!0:t.selectedEdgesOpaque=!0)}if(this.numHighlightedLayerPortions>0){const e=this.scene.highlightMaterial._state;e.fill&&(e.fillAlpha<1?t.highlightedSilhouetteTransparent=!0:t.highlightedSilhouetteOpaque=!0),e.edges&&(e.edgeAlpha<1?t.highlightedEdgesTransparent=!0:t.highlightedEdgesOpaque=!0)}}drawColorOpaque(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawColorOpaque(e,t)}}drawColorTransparent(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawColorTransparent(e,t)}}drawDepth(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawDepth(e,t)}}drawNormals(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawNormals(e,t)}}drawSilhouetteXRayed(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawSilhouetteXRayed(e,t)}}drawSilhouetteHighlighted(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawSilhouetteHighlighted(e,t)}}drawSilhouetteSelected(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawSilhouetteSelected(e,t)}}drawEdgesColorOpaque(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawEdgesColorOpaque(e,t)}}drawEdgesColorTransparent(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawEdgesColorTransparent(e,t)}}drawEdgesXRayed(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawEdgesXRayed(e,t)}}drawEdgesHighlighted(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawEdgesHighlighted(e,t)}}drawEdgesSelected(t){const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawEdgesSelected(e,t)}}drawOcclusion(t){if(0===this.numVisibleLayerPortions)return;const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawOcclusion(e,t)}}drawShadow(t){if(0===this.numVisibleLayerPortions)return;const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawShadow(e,t)}}drawPickMesh(t){if(0===this.numVisibleLayerPortions)return;const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawPickMesh(e,t)}}drawPickDepths(t){if(0===this.numVisibleLayerPortions)return;const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawPickDepths(e,t)}}drawPickNormals(t){if(0===this.numVisibleLayerPortions)return;const e=this.renderFlags;for(let i=0,s=e.visibleLayers.length;i<s;i++){const s=e.visibleLayers[i];this._layerList[s].drawPickNormals(e,t)}}destroy(){for(let t in this._currentBatchingLayers)this._currentBatchingLayers.hasOwnProperty(t)&&this._currentBatchingLayers[t].destroy();this._currentBatchingLayers={},this.scene.camera.off(this._onCameraViewMatrix);for(let t=0,e=this._layerList.length;t<e;t++)this._layerList[t].destroy();for(let t=0,e=this._nodeList.length;t<e;t++)this._nodeList[t]._destroy();this.scene._aabbDirty=!0,this._isModel&&this.scene._deregisterModel(this),0!==ts&&(ts--,0===ts&&Ji._clear()),super.destroy()}}const Va=d.vec4(4),za=d.vec4(),Ua=d.vec4(),Ga=d.vec3([1,0,0]),ja=d.vec3([0,1,0]),Xa=d.vec3([0,0,1]),Wa=d.vec3(3),Ha=d.vec3(3),Ya=d.identityMat4();class Ka extends S{constructor(t,e={}){if(super(t,e),this._parentNode=null,this._children=[],this._aabb=null,this._aabbDirty=!0,this.scene._aabbDirty=!0,this._numTriangles=0,this._scale=d.vec3(),this._quaternion=d.identityQuaternion(),this._rotation=d.vec3(),this._position=d.vec3(),this._offset=d.vec3(),this._localMatrix=d.identityMat4(),this._worldMatrix=d.identityMat4(),this._localMatrixDirty=!0,this._worldMatrixDirty=!0,e.matrix?this.matrix=e.matrix:(this.scale=e.scale,this.position=e.position,e.quaternion||(this.rotation=e.rotation)),this._isModel=e.isModel,this._isModel&&this.scene._registerModel(this),this._isObject=e.isObject,this._isObject&&this.scene._registerObject(this),this.origin=e.origin,this.visible=e.visible,this.culled=e.culled,this.pickable=e.pickable,this.clippable=e.clippable,this.collidable=e.collidable,this.castsShadow=e.castsShadow,this.receivesShadow=e.receivesShadow,this.xrayed=e.xrayed,this.highlighted=e.highlighted,this.selected=e.selected,this.edges=e.edges,this.colorize=e.colorize,this.opacity=e.opacity,this.offset=e.offset,e.children){const t=e.children;for(let i=0,s=t.length;i<s;i++)this.addChild(t[i],e.inheritStates)}if(e.parentId){const t=this.scene.components[e.parentId];t?t.isNode?t.addChild(this):this.error("Parent is not a Node: '"+e.parentId+"'"):this.error("Parent not found: '"+e.parentId+"'")}else e.parent&&(e.parent.isNode||this.error("Parent is not a Node"),e.parent.addChild(this))}get isEntity(){return!0}get isModel(){return this._isModel}get isObject(){return this._isObject}get aabb(){return this._aabbDirty&&this._updateAABB(),this._aabb}set origin(t){t?(this._origin||(this._origin=d.vec3()),this._origin.set(t)):this._origin&&(this._origin=null);for(let e=0,i=this._children.length;e<i;e++)this._children[e].origin=t;this.glRedraw()}get origin(){return this._origin}set rtcCenter(t){this.origin=t}get rtcCenter(){return this.origin}get numTriangles(){return this._numTriangles}set visible(t){t=!1!==t,this._visible=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].visible=t;this._isObject&&this.scene._objectVisibilityUpdated(this,t)}get visible(){return this._visible}set xrayed(t){t=!!t,this._xrayed=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].xrayed=t;this._isObject&&this.scene._objectXRayedUpdated(this,t)}get xrayed(){return this._xrayed}set highlighted(t){t=!!t,this._highlighted=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].highlighted=t;this._isObject&&this.scene._objectHighlightedUpdated(this,t)}get highlighted(){return this._highlighted}set selected(t){t=!!t,this._selected=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].selected=t;this._isObject&&this.scene._objectSelectedUpdated(this,t)}get selected(){return this._selected}set edges(t){t=!!t,this._edges=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].edges=t}get edges(){return this._edges}set culled(t){t=!!t,this._culled=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].culled=t}get culled(){return this._culled}set clippable(t){t=!1!==t,this._clippable=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].clippable=t}get clippable(){return this._clippable}set collidable(t){t=!1!==t,this._collidable=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].collidable=t}get collidable(){return this._collidable}set pickable(t){t=!1!==t,this._pickable=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].pickable=t}get pickable(){return this._pickable}set colorize(t){let e=this._colorize;e||(e=this._colorize=new Float32Array(4),e[3]=1),t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1);for(let t=0,i=this._children.length;t<i;t++)this._children[t].colorize=e;if(this._isObject){const e=!!t;this.scene._objectColorizeUpdated(this,e)}}get colorize(){return this._colorize.slice(0,3)}set opacity(t){let e=this._colorize;e||(e=this._colorize=new Float32Array(4),e[0]=1,e[1]=1,e[2]=1),e[3]=null!=t?t:1;for(let e=0,i=this._children.length;e<i;e++)this._children[e].opacity=t;if(this._isObject){const e=null!=t;this.scene._objectOpacityUpdated(this,e)}}get opacity(){return this._colorize[3]}set castsShadow(t){t=!!t,this._castsShadow=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].castsShadow=t}get castsShadow(){return this._castsShadow}set receivesShadow(t){t=!!t,this._receivesShadow=t;for(let e=0,i=this._children.length;e<i;e++)this._children[e].receivesShadow=t}get receivesShadow(){return this._receivesShadow}get saoEnabled(){return!1}set offset(t){t?(this._offset[0]=t[0],this._offset[1]=t[1],this._offset[2]=t[2]):(this._offset[0]=0,this._offset[1]=0,this._offset[2]=0);for(let t=0,e=this._children.length;t<e;t++)this._children[t].offset=this._offset;this._isObject&&this.scene._objectOffsetUpdated(this,t)}get offset(){return this._offset}get isNode(){return!0}_setLocalMatrixDirty(){this._localMatrixDirty=!0,this._setWorldMatrixDirty()}_setWorldMatrixDirty(){this._worldMatrixDirty=!0;for(let t=0,e=this._children.length;t<e;t++)this._children[t]._setWorldMatrixDirty()}_buildWorldMatrix(){const t=this.matrix;if(this._parentNode)d.mulMat4(this._parentNode.worldMatrix,t,this._worldMatrix);else for(let e=0,i=t.length;e<i;e++)this._worldMatrix[e]=t[e];this._worldMatrixDirty=!1}_setSubtreeAABBsDirty(t){if(t._aabbDirty=!0,t._children)for(let e=0,i=t._children.length;e<i;e++)this._setSubtreeAABBsDirty(t._children[e])}_setAABBDirty(){if(this._setSubtreeAABBsDirty(this),this.collidable)for(let t=this;t;t=t._parentNode)t._aabbDirty=!0}_updateAABB(){if(this.scene._aabbDirty=!0,this._aabb||(this._aabb=d.AABB3()),this._buildAABB)this._buildAABB(this.worldMatrix,this._aabb);else{let t;d.collapseAABB3(this._aabb);for(let e=0,i=this._children.length;e<i;e++)t=this._children[e],t.collidable&&d.expandAABB3(this._aabb,t.aabb)}this._aabbDirty=!1}addChild(t,e){if(m.isNumeric(t)||m.isString(t)){const e=t;if(!(t=this.scene.component[e]))return void this.warn("Component not found: "+m.inQuotes(e));if(!t.isNode&&!t.isMesh)return void this.error("Not a Node or Mesh: "+e)}else{if(!t.isNode&&!t.isMesh)return void this.error("Not a Node or Mesh: "+t.id);if(t._parentNode){if(t._parentNode.id===this.id)return void this.warn("Already a child: "+t.id);t._parentNode.removeChild(t)}}if(t.id,t.scene.id===this.scene.id)return this._children.push(t),t._parentNode=this,e&&(t.visible=this.visible,t.culled=this.culled,t.xrayed=this.xrayed,t.highlited=this.highlighted,t.selected=this.selected,t.edges=this.edges,t.clippable=this.clippable,t.pickable=this.pickable,t.collidable=this.collidable,t.castsShadow=this.castsShadow,t.receivesShadow=this.receivesShadow,t.colorize=this.colorize,t.opacity=this.opacity,t.offset=this.offset),t._setWorldMatrixDirty(),t._setAABBDirty(),this._numTriangles+=t.numTriangles,t;this.error("Child not in same Scene: "+t.id)}removeChild(t){for(let e=0,i=this._children.length;e<i;e++)if(this._children[e].id===t.id)return t._parentNode=null,this._children=this._children.splice(e,1),t._setWorldMatrixDirty(),t._setAABBDirty(),this._setAABBDirty(),void(this._numTriangles-=t.numTriangles)}removeChildren(){let t;for(let e=0,i=this._children.length;e<i;e++)t=this._children[e],t._parentNode=null,t._setWorldMatrixDirty(),t._setAABBDirty(),this._numTriangles-=t.numTriangles;this._children=[],this._setAABBDirty()}get numChildren(){return this._children.length}get children(){return this._children}set parent(t){if(m.isNumeric(t)||m.isString(t)){const e=t;if(!(t=this.scene.components[e]))return void this.warn("Node not found: "+m.inQuotes(e));if(!t.isNode)return void this.error("Not a Node: "+t.id)}t.scene.id===this.scene.id?this._parentNode&&this._parentNode.id===t.id?this.warn("Already a child of Node: "+t.id):t.addChild(this):this.error("Node not in same Scene: "+t.id)}get parent(){return this._parentNode}set position(t){this._position.set(t||[0,0,0]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get position(){return this._position}set rotation(t){this._rotation.set(t||[0,0,0]),d.eulerToQuaternion(this._rotation,"XYZ",this._quaternion),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get rotation(){return this._rotation}set quaternion(t){this._quaternion.set(t||[0,0,0,1]),d.quaternionToEuler(this._quaternion,"XYZ",this._rotation),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get quaternion(){return this._quaternion}set scale(t){this._scale.set(t||[1,1,1]),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get scale(){return this._scale}set matrix(t){this._localMatrix||(this._localMatrix=d.identityMat4()),this._localMatrix.set(t||Ya),d.decomposeMat4(this._localMatrix,this._position,this._quaternion,this._scale),this._localMatrixDirty=!1,this._setWorldMatrixDirty(),this._setAABBDirty(),this.glRedraw()}get matrix(){return this._localMatrixDirty&&(this._localMatrix||(this._localMatrix=d.identityMat4()),d.composeMat4(this._position,this._quaternion,this._scale,this._localMatrix),this._localMatrixDirty=!1),this._localMatrix}get worldMatrix(){return this._worldMatrixDirty&&this._buildWorldMatrix(),this._worldMatrix}rotate(t,e){return Va[0]=t[0],Va[1]=t[1],Va[2]=t[2],Va[3]=e*d.DEGTORAD,d.angleAxisToQuaternion(Va,za),d.mulQuaternions(this.quaternion,za,Ua),this.quaternion=Ua,this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}rotateOnWorldAxis(t,e){return Va[0]=t[0],Va[1]=t[1],Va[2]=t[2],Va[3]=e*d.DEGTORAD,d.angleAxisToQuaternion(Va,za),d.mulQuaternions(za,this.quaternion,za),this}rotateX(t){return this.rotate(Ga,t)}rotateY(t){return this.rotate(ja,t)}rotateZ(t){return this.rotate(Xa,t)}translate(t,e){return d.vec3ApplyQuaternion(this.quaternion,t,Wa),d.mulVec3Scalar(Wa,e,Ha),d.addVec3(this.position,Ha,this.position),this._setLocalMatrixDirty(),this._setAABBDirty(),this.glRedraw(),this}translateX(t){return this.translate(Ga,t)}translateY(t){return this.translate(ja,t)}translateZ(t){return this.translate(Xa,t)}get type(){return"Node"}destroy(){if(super.destroy(),this._parentNode&&this._parentNode.removeChild(this),this._isObject&&(this.scene._deregisterObject(this),this._visible&&this.scene._objectVisibilityUpdated(this,!1),this._xrayed&&this.scene._objectXRayedUpdated(this,!1),this._selected&&this.scene._objectSelectedUpdated(this,!1),this._highlighted&&this.scene._objectHighlightedUpdated(this,!1),this.scene._objectColorizeUpdated(this,!1),this.scene._objectOpacityUpdated(this,!1),this.scene._objectOffsetUpdated(this,!1)),this._isModel&&this.scene._deregisterModel(this),this._children.length){const t=this._children.splice();let e;for(let i=0,s=t.length;i<s;i++)e=t[i],e.destroy()}this._children=[],this._setAABBDirty(),this.scene._aabbDirty=!0}}const qa=_.memory,Za=ht.SUPPORTED_EXTENSIONS.OES_element_index_uint,Qa=Za?Uint32Array:Uint16Array,$a=d.AABB3();class Ja extends ce{get type(){return"VBOGeometry"}get isVBOGeometry(){return!0}constructor(t,e={}){super(t,e),this._state=new Gt({compressGeometry:!0,primitive:null,primitiveName:null,positionsDecodeMatrix:null,uvDecodeMatrix:null,positionsBuf:null,normalsBuf:null,colorsbuf:null,uvBuf:null,indicesBuf:null,hash:""}),this._numTriangles=0,this._edgeThreshold=e.edgeThreshold||10,this._aabb=null,this._obb=d.OBB3();const i=this._state,s=this.scene.canvas.gl;switch(e.primitive=e.primitive||"triangles",e.primitive){case"points":i.primitive=s.POINTS,i.primitiveName=e.primitive;break;case"lines":i.primitive=s.LINES,i.primitiveName=e.primitive;break;case"line-loop":i.primitive=s.LINE_LOOP,i.primitiveName=e.primitive;break;case"line-strip":i.primitive=s.LINE_STRIP,i.primitiveName=e.primitive;break;case"triangles":i.primitive=s.TRIANGLES,i.primitiveName=e.primitive;break;case"triangle-strip":i.primitive=s.TRIANGLE_STRIP,i.primitiveName=e.primitive;break;case"triangle-fan":i.primitive=s.TRIANGLE_FAN,i.primitiveName=e.primitive;break;default:this.error("Unsupported value for 'primitive': '"+e.primitive+"' - supported values are 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'. Defaulting to 'triangles'."),i.primitive=s.TRIANGLES,i.primitiveName=e.primitive}if(e.positions)if(e.indices){var r;if(e.positionsDecodeMatrix);else{const t=ve.getPositionsBounds(e.positions),o=ve.compressPositions(e.positions,t.min,t.max);r=o.quantized,i.positionsDecodeMatrix=o.decodeMatrix,i.positionsBuf=new Mt(s,s.ARRAY_BUFFER,r,r.length,3,s.STATIC_DRAW),qa.positions+=i.positionsBuf.numItems,d.positions3ToAABB3(e.positions,this._aabb),d.positions3ToAABB3(r,$a,i.positionsDecodeMatrix),d.AABB3ToOBB3($a,this._obb)}if(e.colors){const t=e.colors.constructor===Float32Array?e.colors:new Float32Array(e.colors);i.colorsBuf=new Mt(s,s.ARRAY_BUFFER,t,t.length,4,s.STATIC_DRAW),qa.colors+=i.colorsBuf.numItems}if(e.uv){const t=ve.getUVBounds(e.uv),r=ve.compressUVs(e.uv,t.min,t.max),o=r.quantized;i.uvDecodeMatrix=r.decodeMatrix,i.uvBuf=new Mt(s,s.ARRAY_BUFFER,o,o.length,2,s.STATIC_DRAW),qa.uvs+=i.uvBuf.numItems}if(e.normals){const t=ve.compressNormals(e.normals);let r=i.compressGeometry;i.normalsBuf=new Mt(s,s.ARRAY_BUFFER,t,t.length,3,s.STATIC_DRAW,r),qa.normals+=i.normalsBuf.numItems}if(Za||e.indices.constructor!==Uint32Array){{const t=e.indices.constructor===Uint32Array||e.indices.constructor===Uint16Array?e.indices:new Qa(e.indices);i.indicesBuf=new Mt(s,s.ELEMENT_ARRAY_BUFFER,t,t.length,1,s.STATIC_DRAW),qa.indices+=i.indicesBuf.numItems;const o=ue(r,t,i.positionsDecodeMatrix,this._edgeThreshold);this._edgeIndicesBuf=new Mt(s,s.ELEMENT_ARRAY_BUFFER,o,o.length,1,s.STATIC_DRAW),"triangles"===this._state.primitiveName&&(this._numTriangles=e.indices.length/3)}this._buildHash(),qa.meshes++}else this.error("This WebGL implementation does not support Uint32Array")}else this.error("Config expected: indices");else this.error("Config expected: positions")}_buildHash(){const t=this._state,e=["/g"];e.push("/"+t.primitive+";"),t.positionsBuf&&e.push("p"),t.colorsBuf&&e.push("c"),(t.normalsBuf||t.autoVertexNormals)&&e.push("n"),t.uvBuf&&e.push("u"),e.push("cp"),e.push(";"),t.hash=e.join("")}_getEdgeIndices(){return this._edgeIndicesBuf}get primitive(){return this._state.primitiveName}get aabb(){return this._aabb}get obb(){return this._obb}get numTriangles(){return this._numTriangles}_getState(){return this._state}destroy(){super.destroy();const t=this._state;t.indicesBuf&&t.indicesBuf.destroy(),t.positionsBuf&&t.positionsBuf.destroy(),t.normalsBuf&&t.normalsBuf.destroy(),t.uvBuf&&t.uvBuf.destroy(),t.colorsBuf&&t.colorsBuf.destroy(),this._edgeIndicesBuf&&this._edgeIndicesBuf.destroy(),t.destroy(),qa.meshes--}}const tn={opaque:0,mask:1,blend:2},en=["opaque","mask","blend"];class sn extends Ee{get type(){return"MetallicMaterial"}constructor(t,e={}){super(t,e),this._state=new Gt({type:"MetallicMaterial",baseColor:d.vec4([1,1,1]),emissive:d.vec4([0,0,0]),metallic:null,roughness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.baseColor=e.baseColor,this.metallic=e.metallic,this.roughness=e.roughness,this.specularF0=e.specularF0,this.emissive=e.emissive,this.alpha=e.alpha,e.baseColorMap&&(this._baseColorMap=this._checkComponent("Texture",e.baseColorMap)),e.metallicMap&&(this._metallicMap=this._checkComponent("Texture",e.metallicMap)),e.roughnessMap&&(this._roughnessMap=this._checkComponent("Texture",e.roughnessMap)),e.metallicRoughnessMap&&(this._metallicRoughnessMap=this._checkComponent("Texture",e.metallicRoughnessMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",e.emissiveMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",e.occlusionMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("Texture",e.alphaMap)),e.normalMap&&(this._normalMap=this._checkComponent("Texture",e.normalMap)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,this._makeHash()}_makeHash(){const t=this._state,e=["/met"];this._baseColorMap&&(e.push("/bm"),this._baseColorMap._state.hasMatrix&&e.push("/mat"),e.push("/"+this._baseColorMap._state.encoding)),this._metallicMap&&(e.push("/mm"),this._metallicMap._state.hasMatrix&&e.push("/mat")),this._roughnessMap&&(e.push("/rm"),this._roughnessMap._state.hasMatrix&&e.push("/mat")),this._metallicRoughnessMap&&(e.push("/mrm"),this._metallicRoughnessMap._state.hasMatrix&&e.push("/mat")),this._emissiveMap&&(e.push("/em"),this._emissiveMap._state.hasMatrix&&e.push("/mat")),this._occlusionMap&&(e.push("/ocm"),this._occlusionMap._state.hasMatrix&&e.push("/mat")),this._alphaMap&&(e.push("/am"),this._alphaMap._state.hasMatrix&&e.push("/mat")),this._normalMap&&(e.push("/nm"),this._normalMap._state.hasMatrix&&e.push("/mat")),e.push(";"),t.hash=e.join("")}set baseColor(t){let e=this._state.baseColor;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.baseColor=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get baseColor(){return this._state.baseColor}get baseColorMap(){return this._baseColorMap}set metallic(t){t=null!=t?t:1,this._state.metallic!==t&&(this._state.metallic=t,this.glRedraw())}get metallic(){return this._state.metallic}get metallicMap(){return this._attached.metallicMap}set roughness(t){t=null!=t?t:1,this._state.roughness!==t&&(this._state.roughness=t,this.glRedraw())}get roughness(){return this._state.roughness}get roughnessMap(){return this._attached.roughnessMap}get metallicRoughnessMap(){return this._attached.metallicRoughnessMap}set specularF0(t){t=null!=t?t:0,this._state.specularF0!==t&&(this._state.specularF0=t,this.glRedraw())}get specularF0(){return this._state.specularF0}set emissive(t){let e=this._state.emissive;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.emissive=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=0,e[1]=0,e[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}get emissiveMap(){return this._attached.emissiveMap}get occlusionMap(){return this._attached.occlusionMap}set alpha(t){t=null!=t?t:1,this._state.alpha!==t&&(this._state.alpha=t,this.glRedraw())}get alpha(){return this._state.alpha}get alphaMap(){return this._attached.alphaMap}get normalMap(){return this._attached.normalMap}set alphaMode(t){let e=tn[t=t||"opaque"];void 0===e&&(this.error("Unsupported value for 'alphaMode': "+t+" defaulting to 'opaque'"),e="opaque"),this._state.alphaMode!==e&&(this._state.alphaMode=e,this.glRedraw())}get alphaMode(){return en[this._state.alphaMode]}set alphaCutoff(t){null==t&&(t=.5),this._state.alphaCutoff!==t&&(this._state.alphaCutoff=t)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}set lineWidth(t){this._state.lineWidth=t||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(t){this._state.pointSize=t||1,this.glRedraw()}get pointSize(){return this._state.pointSize}destroy(){super.destroy(),this._state.destroy()}}const rn={opaque:0,mask:1,blend:2},on=["opaque","mask","blend"];class an extends Ee{get type(){return"SpecularMaterial"}constructor(t,e={}){super(t,e),this._state=new Gt({type:"SpecularMaterial",diffuse:d.vec3([1,1,1]),emissive:d.vec3([0,0,0]),specular:d.vec3([1,1,1]),glossiness:null,specularF0:null,alpha:null,alphaMode:null,alphaCutoff:null,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:null}),this.diffuse=e.diffuse,this.specular=e.specular,this.glossiness=e.glossiness,this.specularF0=e.specularF0,this.emissive=e.emissive,this.alpha=e.alpha,e.diffuseMap&&(this._diffuseMap=this._checkComponent("Texture",e.diffuseMap)),e.emissiveMap&&(this._emissiveMap=this._checkComponent("Texture",e.emissiveMap)),e.specularMap&&(this._specularMap=this._checkComponent("Texture",e.specularMap)),e.glossinessMap&&(this._glossinessMap=this._checkComponent("Texture",e.glossinessMap)),e.specularGlossinessMap&&(this._specularGlossinessMap=this._checkComponent("Texture",e.specularGlossinessMap)),e.occlusionMap&&(this._occlusionMap=this._checkComponent("Texture",e.occlusionMap)),e.alphaMap&&(this._alphaMap=this._checkComponent("Texture",e.alphaMap)),e.normalMap&&(this._normalMap=this._checkComponent("Texture",e.normalMap)),this.alphaMode=e.alphaMode,this.alphaCutoff=e.alphaCutoff,this.backfaces=e.backfaces,this.frontface=e.frontface,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,this._makeHash()}_makeHash(){const t=this._state,e=["/spe"];this._diffuseMap&&(e.push("/dm"),this._diffuseMap.hasMatrix&&e.push("/mat"),e.push("/"+this._diffuseMap.encoding)),this._emissiveMap&&(e.push("/em"),this._emissiveMap.hasMatrix&&e.push("/mat")),this._glossinessMap&&(e.push("/gm"),this._glossinessMap.hasMatrix&&e.push("/mat")),this._specularMap&&(e.push("/sm"),this._specularMap.hasMatrix&&e.push("/mat")),this._specularGlossinessMap&&(e.push("/sgm"),this._specularGlossinessMap.hasMatrix&&e.push("/mat")),this._occlusionMap&&(e.push("/ocm"),this._occlusionMap.hasMatrix&&e.push("/mat")),this._normalMap&&(e.push("/nm"),this._normalMap.hasMatrix&&e.push("/mat")),this._alphaMap&&(e.push("/opm"),this._alphaMap.hasMatrix&&e.push("/mat")),e.push(";"),t.hash=e.join("")}set diffuse(t){let e=this._state.diffuse;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.diffuse=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get diffuse(){return this._state.diffuse}get diffuseMap(){return this._diffuseMap}set specular(t){let e=this._state.specular;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.specular=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get specular(){return this._state.specular}get specularMap(){return this._specularMap}get specularGlossinessMap(){return this._specularGlossinessMap}set glossiness(t){t=null!=t?t:1,this._state.glossiness!==t&&(this._state.glossiness=t,this.glRedraw())}get glossiness(){return this._state.glossiness}get glossinessMap(){return this._glossinessMap}set specularF0(t){t=null!=t?t:0,this._state.specularF0!==t&&(this._state.specularF0=t,this.glRedraw())}get specularF0(){return this._state.specularF0}set emissive(t){let e=this._state.emissive;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.emissive=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=0,e[1]=0,e[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}get emissiveMap(){return this._emissiveMap}set alpha(t){t=null!=t?t:1,this._state.alpha!==t&&(this._state.alpha=t,this.glRedraw())}get alpha(){return this._state.alpha}get alphaMap(){return this._alphaMap}get normalMap(){return this._normalMap}get occlusionMap(){return this._occlusionMap}set alphaMode(t){let e=rn[t=t||"opaque"];void 0===e&&(this.error("Unsupported value for 'alphaMode': "+t+" defaulting to 'opaque'"),e="opaque"),this._state.alphaMode!==e&&(this._state.alphaMode=e,this.glRedraw())}get alphaMode(){return on[this._state.alphaMode]}set alphaCutoff(t){null==t&&(t=.5),this._state.alphaCutoff!==t&&(this._state.alphaCutoff=t)}get alphaCutoff(){return this._state.alphaCutoff}set backfaces(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}set lineWidth(t){this._state.lineWidth=t||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(t){this._state.pointSize=t||1,this.glRedraw()}get pointSize(){return this._state.pointSize}destroy(){super.destroy(),this._state.destroy()}}const nn={funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipmapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipmapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipmapLinear:"NEAREST_MIPMAP_LINEAR",linearMipmapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"};function ln(t,e,i){if(void 0===e)return i;const s=nn[e];return void 0===s?i:t[s]}const hn=new Uint8Array([0,0,0,1]);class cn{constructor(t,e){this.gl=t,this.target=e||t.TEXTURE_2D,this.texture=t.createTexture(),this.setPreloadColor([0,0,0,0]),this.allocated=!0}setPreloadColor(t){t?(hn[0]=Math.floor(255*t[0]),hn[1]=Math.floor(255*t[1]),hn[2]=Math.floor(255*t[2]),hn[3]=Math.floor(255*(void 0!==t[3]?t[3]:1))):(hn[0]=0,hn[1]=0,hn[2]=0,hn[3]=255);const e=this.gl;if(e.bindTexture(this.target,this.texture),e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,e.NEAREST),this.target===e.TEXTURE_CUBE_MAP){const t=[e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Z,e.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let i=0,s=t.length;i<s;i++)e.texImage2D(t[i],0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,hn)}else e.texImage2D(this.target,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,hn);e.bindTexture(this.target,null)}setTarget(t){this.target=t||this.gl.TEXTURE_2D}setImage(t,e){const i=this.gl;if(i.bindTexture(this.target,this.texture),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,e.flipY),this.target===i.TEXTURE_CUBE_MAP){if(m.isArray(t)){const e=t,s=[i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y,i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z];for(let t=0,r=s.length;t<r;t++)i.texImage2D(s[t],0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e[t])}}else i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t);i.bindTexture(this.target,null)}setProps(t){const e=this.gl;if(e.bindTexture(this.target,this.texture),t.minFilter){const i=ln(e,t.minFilter);i&&(e.texParameteri(this.target,e.TEXTURE_MIN_FILTER,i),i!==e.NEAREST_MIPMAP_NEAREST&&i!==e.LINEAR_MIPMAP_NEAREST&&i!==e.NEAREST_MIPMAP_LINEAR&&i!==e.LINEAR_MIPMAP_LINEAR||e.generateMipmap(this.target))}if(t.magFilter){const i=ln(e,t.magFilter);i&&e.texParameteri(this.target,e.TEXTURE_MAG_FILTER,i)}if(t.wrapS){const i=ln(e,t.wrapS);i&&e.texParameteri(this.target,e.TEXTURE_WRAP_S,i)}if(t.wrapT){const i=ln(e,t.wrapT);i&&e.texParameteri(this.target,e.TEXTURE_WRAP_T,i)}e.bindTexture(this.target,null)}bind(t){if(this.allocated){if(this.texture){const e=this.gl;return e.activeTexture(e["TEXTURE"+t]),e.bindTexture(this.target,this.texture),!0}return!1}}unbind(t){if(this.allocated&&this.texture){const e=this.gl;e.activeTexture(e["TEXTURE"+t]),e.bindTexture(this.target,null)}}destroy(){this.allocated&&this.texture&&(this.gl.deleteTexture(this.texture),this.texture=null)}}function un(t){if(!dn(t.width)||!dn(t.height)){const e=document.createElement("canvas");e.width=pn(t.width),e.height=pn(t.height);e.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e.width,e.height),t=e}return t}function dn(t){return 0==(t&t-1)}function pn(t){--t;for(let e=1;e<32;e<<=1)t|=t>>e;return t+1}class _n extends S{get type(){return"Texture"}constructor(t,e={}){super(t,e),this._state=new Gt({texture:new cn(this.scene.canvas.gl),matrix:d.identityMat4(),hasMatrix:e.translate&&(0!==e.translate[0]||0!==e.translate[1])||!!e.rotate||e.scale&&(0!==e.scale[0]||0!==e.scale[1]),minFilter:this._checkMinFilter(e.minFilter),magFilter:this._checkMagFilter(e.magFilter),wrapS:this._checkWrapS(e.wrapS),wrapT:this._checkWrapT(e.wrapT),flipY:this._checkFlipY(e.flipY),encoding:this._checkEncoding(e.encoding)}),this._src=null,this._image=null,this._translate=d.vec2([0,0]),this._scale=d.vec2([1,1]),this._rotate=d.vec2([0,0]),this._matrixDirty=!1,this.translate=e.translate,this.scale=e.scale,this.rotate=e.rotate,e.src?this.src=e.src:e.image&&(this.image=e.image),_.memory.textures++}_checkMinFilter(t){return"linear"!==(t=t||"linearMipmapLinear")&&"linearMipmapNearest"!==t&&"linearMipmapLinear"!==t&&"nearestMipmapLinear"!==t&&"nearestMipmapNearest"!==t&&(this.error("Unsupported value for 'minFilter': '"+t+"' - supported values are 'linear', 'linearMipmapNearest', 'nearestMipmapNearest', 'nearestMipmapLinear' and 'linearMipmapLinear'. Defaulting to 'linearMipmapLinear'."),t="linearMipmapLinear"),t}_checkMagFilter(t){return"linear"!==(t=t||"linear")&&"nearest"!==t&&(this.error("Unsupported value for 'magFilter': '"+t+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),t="linear"),t}_checkFilter(t){return"linear"!==(t=t||"linear")&&"nearest"!==t&&(this.error("Unsupported value for 'magFilter': '"+t+"' - supported values are 'linear' and 'nearest'. Defaulting to 'linear'."),t="linear"),t}_checkWrapS(t){return"clampToEdge"!==(t=t||"repeat")&&"mirroredRepeat"!==t&&"repeat"!==t&&(this.error("Unsupported value for 'wrapS': '"+t+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),t="repeat"),t}_checkWrapT(t){return"clampToEdge"!==(t=t||"repeat")&&"mirroredRepeat"!==t&&"repeat"!==t&&(this.error("Unsupported value for 'wrapT': '"+t+"' - supported values are 'clampToEdge', 'mirroredRepeat' and 'repeat'. Defaulting to 'repeat'."),t="repeat"),t}_checkFlipY(t){return!!t}_checkEncoding(t){return"linear"!==(t=t||"linear")&&"sRGB"!==t&&"gamma"!==t&&(this.error("Unsupported value for 'encoding': '"+t+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),t="linear"),t}_webglContextRestored(){this._state.texture=new cn(this.scene.canvas.gl),this._image?this.image=this._image:this._src&&(this.src=this._src)}_update(){const t=this._state;if(this._matrixDirty){let e,i;0===this._translate[0]&&0===this._translate[1]||(e=d.translationMat4v([this._translate[0],this._translate[1],0],this._state.matrix)),1===this._scale[0]&&1===this._scale[1]||(i=d.scalingMat4v([this._scale[0],this._scale[1],1]),e=e?d.mulMat4(e,i):i),0!==this._rotate&&(i=d.rotationMat4v(.0174532925*this._rotate,[0,0,1]),e=e?d.mulMat4(e,i):i),e&&(t.matrix=e),this._matrixDirty=!1}this.glRedraw()}set image(t){this._image=un(t),this._image.crossOrigin="Anonymous",this._state.texture.setImage(this._image,this._state),this._state.texture.setProps(this._state),this._src=null,this.glRedraw()}get image(){return this._image}set src(t){this.scene.loading++,this.scene.canvas.spinner.processes++;const e=this;let i=new Image;i.onload=function(){i=un(i),e._state.texture.setImage(i,e._state),e._state.texture.setProps(e._state),e.scene.loading--,e.glRedraw(),e.scene.canvas.spinner.processes--},i.src=t,this._src=t,this._image=null}get src(){return this._src}set translate(t){this._translate.set(t||[0,0]),this._matrixDirty=!0,this._needUpdate()}get translate(){return this._translate}set scale(t){this._scale.set(t||[1,1]),this._matrixDirty=!0,this._needUpdate()}get scale(){return this._scale}set rotate(t){t=t||0,this._rotate!==t&&(this._rotate=t,this._matrixDirty=!0,this._needUpdate())}get rotate(){return this._rotate}get minFilter(){return this._state.minFilter}get magFilter(){return this._state.magFilter}get wrapS(){return this._state.wrapS}get wrapT(){return this._state.wrapT}get flipY(){return this._state.flipY}get encoding(){return this._state.encoding}destroy(){super.destroy(),this._state.texture&&this._state.texture.destroy(),this._state.destroy(),_.memory.textures--}}class fn{constructor(t){}load(t,e,i,s,r,o){s=s||{};var a=e.scene.canvas.spinner;a.processes++,gn(t,e,i,s,(function(){a.processes--,A.scheduleTask((function(){e.scene.fire("modelLoaded",e.id),e.fire("loaded",!0,!1)})),r&&r()}),(function(t){a.processes--,e.error(t),o&&o(t),e.fire("error",t)}))}parse(t,e,i,s,r,o){s=s||{};var a=e.scene.canvas.spinner;a.processes++,mn(t,i,"",s,e,(function(){a.processes--,e.scene.fire("modelLoaded",e.id),e.fire("loaded",!0,!1),r&&r()}),(function(t){a.processes--,e.error(t),e.fire("error",t),o&&o(t)}))}}var gn=function(t,e,i,s,r,o){t.dataSource.getGLTF(i,(function(a){s.basePath=function(t){var e=t.lastIndexOf("/");return 0!==e?t.substring(0,e+1):""}(i),mn(t,a,i,s,e,r,o)}),o)},mn=function(){const t={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},e={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};return function(t,e,c,u,d,p){d.clear();var _={src:c,loadBuffer:u.loadBuffer,basePath:u.basePath,prioritizeGLTFNode:u.prioritizeGLTFNode,handleGLTFNode:u.handleGLTFNode,ignoreMaterials:!!u.ignoreMaterials,edgeThreshold:u.edgeThreshold,readableGeometry:!!u.readableGeometry,json:e,scene:d.scene,plugin:t,modelNode:d,modelNodeProps:{visible:d.visible,culled:d.culled,xrayed:d.xrayed,highlighted:d.highlighted,selected:d.selected,outlined:d.outlined,clippable:d.clippable,pickable:d.pickable,collidable:d.collidable,castsShadow:d.castsShadow,receivesShadow:d.receivesShadow,colorize:d.colorize,opacity:d.opacity,edges:d.edges}};d.scene.loading++,function(t,e){var s=t.json.buffers;if(s)for(var r=s.length,o=0,a=s.length;o<a;o++)i(t,s[o],(function(){0==--r&&e()}),(function(i){t.plugin.error(i),0==--r&&e()}));else e()}(_,(function(){!function(t){var e=t.json.bufferViews;if(e)for(var i=0,r=e.length;i<r;i++)s(t,e[i])}(_),function(t){var e=t.json.accessors;if(e)for(var i=0,s=e.length;i<s;i++)r(t,e[i])}(_),function(t){var e=t.json.textures;if(e)for(var i=0,s=e.length;i<s;i++)o(t,e[i])}(_),function(t){var e,i,s=t.json.materials;if(s)for(var r=0,o=s.length;r<o;r++)i=a(t,e=s[r]),e._material=i}(_),function(t){var e=t.json.meshes;if(e)for(var i=0,s=e.length;i<s;i++)n(t,e[i])}(_),function(t){var e=t.json,i=e.scene||0,s=e.scenes[i];if(!s)return void h(t,"glTF has no default scene");!function(t,e){var i=e.nodes;if(!i)return;for(var s,r=t.json,o=0,a=i.length;o<a;o++)(s=r.nodes[i[o]])?l(t,s,null,null):h(t,"Node not found: "+o)}(t,s)}(_),d.scene.loading--,p()}))};function i(t,e,i,s){var r=e.uri;r?t.plugin.dataSource.getArrayBuffer(t.src,r,(function(t){e._buffer=t,i()}),s):s("gltf/handleBuffer missing uri in "+JSON.stringify(e))}function s(t,e){var i=t.json.buffers[e.buffer];e._typedArray=null;var s=e.byteLength||0,r=e.byteOffset||0;e._buffer=i._buffer.slice(r,r+s)}function r(i,s){var r=i.json.bufferViews[s.bufferView],o=e[s.type],a=t[s.componentType],n=a.BYTES_PER_ELEMENT*o;s.byteStride&&s.byteStride!==n||(s._typedArray=new a(r._buffer,s.byteOffset||0,s.count*o),s._itemSize=o)}function o(t,e){e._texture=new _n(t.modelNode,{src:t.json.images[e.source].uri?t.basePath+t.json.images[e.source].uri:void 0,flipY:!!e.flipY,encoding:"sRGB"})}function a(t,e){var i,s=t.json,r={},o=e.normalTexture;o&&(i=s.textures[o.index])&&(r.normalMap=i._texture);var a=e.occlusionTexture;a&&(i=s.textures[a.index])&&(r.occlusionMap=i._texture);var n=e.emissiveTexture;n&&(i=s.textures[n.index])&&(r.emissiveMap=i._texture);var l=e.emissiveFactor;switch(l&&(r.emissive=l,r.specular=[0,0,0],r.diffuse=[0,0,0]),r.backfaces=!!e.doubleSided,e.alphaMode){case"NORMAL_OPAQUE":r.alphaMode="opaque";break;case"MASK":r.alphaMode="mask";break;case"BLEND":r.alphaMode="blend"}var h=e.alphaCutoff;void 0!==h&&(r.alphaCutoff=h);var c=e.extensions;if(c){var u=c.KHR_materials_pbrSpecularGlossiness;if(u){var d=u.diffuseFactor;null!=d&&(r.diffuse=d.slice(0,3),r.alpha=d[3]);var p=u.diffuseTexture;p&&(i=s.textures[p.index])&&(r.diffuseMap=i._texture);var _=u.specularFactor;null!=_&&(r.specular=_.slice(0,3));var f=u.glossinessFactor;null!=f&&(r.glossiness=f);var g=u.specularGlossinessTexture;return g&&(i=s.textures[g.index])&&(r.specularGlossinessMap=i._texture),new an(t.modelNode,r)}var v=c.KHR_materials_common;if(v){var b,P=v.technique,y=v.values||{},M="BLINN"===P,x="PHONG"===P,w="LAMBERT"===P,E=y.shininess;r.shininess=(M||x)&&null!=E?E:0;var A=y.diffuse;A&&(M||x||w)?m.isString(A)?(b=t.textures[A])&&(r.diffuseMap=b):r.diffuse=A.slice(0,3):r.diffuse=[0,0,0];var C=y.specular;C&&(M||x)?m.isString(C)?(b=t.textures[C])&&(r.specularMap=b):r.specular=C.slice(0,3):r.specular=[0,0,0];var S=y.emission;S?m.isString(S)?(b=t.textures[S])&&(r.emissiveMap=b):r.emissive=S.slice(0,3):r.emissive=[0,0,0];var D=y.transparency;return r.alpha=null!=D?D:1,y.transparent,new Se(t.scene,r)}}var L=e.pbrMetallicRoughness;if(L){var B=L.baseColorFactor;B&&(r.baseColor=B.slice(0,3),r.alpha=B[3]);var R=L.baseColorTexture;R&&(i=s.textures[R.index])&&(r.baseColorMap=i._texture);var T=L.metallicFactor;null!=T&&(r.metallic=T);var F=L.roughnessFactor;null!=F&&(r.roughness=F);var N=L.metallicRoughnessTexture;return N&&(i=s.textures[N.index])&&(r.metallicRoughnessMap=i._texture),new sn(t.scene,r)}return new Se(t.scene,r)}function n(t,e){var i,s,r,o,a=t.json,n=[],l=e.primitives;if(l)for(var h,c,u,d,p,_,f,g,m=0,v=l.length;m<v;m++)(h=l[m]).mode<4||(_={primitive:"triangles",compressGeometry:!0,edgeThreshold:t.edgeThreshold},null!=(c=h.indices)&&(r=a.accessors[c],_.indices=r._typedArray),(o=h.attributes)&&(null!=(u=o.POSITION)&&(r=a.accessors[u],_.positions=r._typedArray),null!=(d=o.NORMAL)&&(r=a.accessors[d],_.normals=r._typedArray),null!=(p=o.TEXCOORD_0)&&(r=a.accessors[p],_.uv=r._typedArray),f={},g=t.readableGeometry?new xe(t.modelNode,_):new Ja(t.modelNode,_),f.geometry=g,null!=(i=h.material)&&(s=a.materials[i])&&(f.material=s._material),n.push(f)));e._mesh=n}function l(t,e,i,s){var r;if(s=s||t.modelNode,t.prioritizeGLTFNode){const i=t.prioritizeGLTFNode(t.modelNode.id,e);if(null==i)return}if(t.handleGLTFNode){var o={};if(!t.handleGLTFNode(t.modelNode.id,e,o))return;o.createEntity&&(r=o.createEntity)}const a=t.json,n=t.modelNode,c=e.children&&e.children.length>0;var u;if(e.matrix&&(u=e.matrix,i=i?d.mulMat4(i,u,d.mat4()):u),e.translation&&(u=d.translationMat4v(e.translation),i=i?d.mulMat4(i,u,u):u),e.rotation&&(u=d.quaternionToMat4(e.rotation),i=i?d.mulMat4(i,u,u):u),e.scale&&(u=d.scalingMat4v(e.scale),i=i?d.mulMat4(i,u,u):u),void 0!==e.mesh){var p=a.meshes[e.mesh];if(p){var _,f,g=p._mesh,v=g.length;if(!r&&v>0&&!c){for(var b=0,P=v;b<P;b++){let e={geometry:(_=g[b]).geometry,matrix:i};m.apply(t.modelNodeProps,e),e.material=_.material,f=new Ri(n,e),s.addChild(f,!1)}return}if(r&&1===v&&!c){let e={geometry:(_=g[0]).geometry,matrix:i};return m.apply(t.modelNodeProps,e),e.material=_.material,m.apply(r,e),f=new Ri(n,e),void s.addChild(f,!1)}if(r&&v>0&&!c){let e={matrix:i};m.apply(t.modelNodeProps,e),m.apply(r,e);let o=new Ka(n,e);s.addChild(o,!1);for(let e=0,i=v;e<i;e++){_=g[e];let i={geometry:_.geometry};m.apply(t.modelNodeProps,i),i.material=_.material,m.apply(r,i),i.id=null,f=new Ri(n,i),o.addChild(f,!1)}return}if(!r&&v>0&&c){let e={matrix:i};m.apply(t.modelNodeProps,e);let r=new Ka(n,e);s.addChild(r,!1);for(let t=0,i=v;t<i;t++){_=g[t];let i={geometry:_.geometry};m.apply(e,i),i.id=null,i.matrix=null,i.material=_.material,f=new Ri(n,i),r.addChild(f,!1)}i=null,s=r}if(r&&0===v&&c){let e={matrix:i};m.apply(t.modelNodeProps,e),m.apply(r,e),r.matrix=i;let o=new Ka(n,e);s.addChild(o,!1),i=null,s=o}if(r&&v>0||c){let e={matrix:i};m.apply(t.modelNodeProps,e),r&&m.apply(r,e);let o=new Ka(n,e);s.addChild(o,!1);for(let e=0,i=v;e<i;e++){_=g[e];let i={geometry:_.geometry};m.apply(t.modelProps,i),i.material=_.material,r&&m.apply(r,i),i.id=null,f=new Ri(n,i),o.addChild(f,!1)}i=null,s=o}}}if(e.children){var y,M,x=e.children;for(let e=0,r=x.length;e<r;e++)M=x[e],(y=a.nodes[M])?l(t,y,i,s):h(t,"Node not found: "+e)}}function h(t,e){t.plugin.error(e)}}();class vn{constructor(t){}load(t,e,i,s,r,o){bn(t,e,i,s=s||{},(function(){A.scheduleTask((function(){e.scene.fire("modelLoaded",e.id),e.fire("loaded",!0,!1)})),r&&r()}),(function(i){t.error(i),o&&o(i),e.fire("error",i)}))}parse(t,e,i,s,r,o){Pn(t,i,"",s=s||{},e,(function(){e.scene.fire("modelLoaded",e.id),e.fire("loaded",!0,!1),r&&r()}),(function(t){e.error(t),e.fire("error",t),o&&o(t)}))}}const bn=function(t,e,i,s,r,o){const a=t.viewer.scene.canvas.spinner;a.processes++,t.dataSource.getGLTF(i,(function(n){a.processes--,Pn(t,n,i,s,e,r,o)}),o)},Pn=function(){const t={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},e={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};return function(t,e,n,l,c,u){const d={src:n,loadBuffer:l.loadBuffer,handleGLTFNode:l.handleGLTFNode,json:e,scene:c.scene,plugin:t,performanceModel:c,geometryCreated:{},numObjects:0,nodes:[]},p=t.viewer.scene.canvas.spinner;p.processes++,function(t,e){const s=t.json.buffers;if(s){let r=s.length;for(let o=0,a=s.length;o<a;o++)i(t,s[o],(function(){0==--r&&e()}),(function(i){t.plugin.error(i),0==--r&&e()}))}else e()}(d,(function(){!function(t){const e=t.json.bufferViews;if(e)for(let i=0,r=e.length;i<r;i++)s(t,e[i])}(d),function(t){const e=t.json.buffers;if(e)for(let t=0,i=e.length;t<i;t++)e[t]._buffer=null}(d),function(t){const e=t.json.materials;if(e)for(let i=0,s=e.length;i<s;i++){const s=e[i],o=r(t,s);s._rgbaColor=o}}(d),p.processes--,function(t){const e=t.json,i=e.scene||0,s=e.scenes[i];if(!s)return void h(t,"glTF has no default scene");(function(t,e){const i=e.nodes;if(!i)return;const s=t.json;for(let e=0,r=i.length;e<r;e++){s.nodes[i[e]]?o(t,e):h(t,"Node not found: "+e)}})(t,s),function(t,e){const i=e.nodes;if(!i)return;const s=t.json;for(let e=0,r=i.length;e<r;e++){const r=s.nodes[i[e]];r?o(t,r):h(t,"Node not found: "+e)}t.plugin.viewer.scene.canvas.spinner.processes++;for(let e=0,r=i.length;e<r;e++){a(t,s.nodes[i[e]],null)}t.plugin.viewer.scene.canvas.spinner.processes--}(t,s)}(d),c.finalize(),u()}))};function i(t,e,i,s){const r=e.uri;r?t.plugin.dataSource.getArrayBuffer(t.src,r,(function(t){e._buffer=t,i()}),s):s("gltf/handleBuffer missing uri in "+JSON.stringify(e))}function s(t,e){const i=t.json.buffers[e.buffer];e._typedArray=null;const s=e.byteLength||0,r=e.byteOffset||0;e._buffer=i._buffer.slice(r,r+s)}function r(t,e){const i=new Float32Array([1,1,1,1]),s=e.extensions;if(s){const t=s.KHR_materials_pbrSpecularGlossiness;if(t){const e=t.diffuseFactor;null!=e&&i.set(e)}const e=s.KHR_materials_common;if(e){const t=e.technique,s=e.values||{},r="BLINN"===t,o="PHONG"===t,a="LAMBERT"===t,n=s.diffuse;n&&(r||o||a)&&(m.isString(n)||i.set(n));const l=s.transparency;null!=l&&(i[3]=l);const h=s.transparent;null!=h&&(i[3]=h)}}const r=e.pbrMetallicRoughness;if(r){const t=r.baseColorFactor;t&&i.set(t)}return i}function o(t,e){const i=t.json;if(void 0!==e.mesh){const t=i.meshes[e.mesh];t&&(t.instances=t.instances?t.instances+1:1)}if(e.children){const s=e.children;for(let e=0,r=s.length;e<r;e++){const r=s[e],a=i.nodes[r];a?o(t,a):h(t,"Node not found: "+e)}}}function a(t,e,i){const s=t.json;let r;if(e.matrix&&(r=e.matrix,i=i?d.mulMat4(i,r,d.mat4()):r),e.translation&&(r=d.translationMat4v(e.translation),i=i?d.mulMat4(i,r,d.mat4()):r),e.rotation&&(r=d.quaternionToMat4(e.rotation),i=i?d.mulMat4(i,r,d.mat4()):r),e.scale&&(r=d.scalingMat4v(e.scale),i=i?d.mulMat4(i,r,d.mat4()):r),void 0!==e.mesh){const r=s.meshes[e.mesh];if(r){let o;if(t.handleGLTFNode){const i={};if(!t.handleGLTFNode(t.performanceModel.id,e,i))return;i.createEntity&&(o=i.createEntity)}const a=t.performanceModel,l=i?i.slice():d.identityMat4(),h=r.primitives.length;if(h>0){const e=[];for(let i=0;i<h;i++){const h=r.primitives[i];if(h.mode<4)continue;const c={id:a.id+"."+t.numObjects++},u=h.material;let p;null!=u&&(p=s.materials[u]),p?(c.color=p._rgbaColor,c.opacity=p._rgbaColor[3]):(c.color=new Float32Array([1,1,1]),c.opacity=1),o&&(o.colorize&&(c.color=o.colorize),void 0!==o.opacity&&null!==o.opacity&&(c.opacity=o.opacity)),n(t,h,c),d.transformPositions3(l,c.localPositions,c.positions);const _=d.vec3();X(c.positions,c.positions,_)&&(c.origin=_),a.createMesh(c),e.push(c.id)}o?a.createEntity(m.apply(o,{meshIds:e})):a.createEntity({meshIds:e})}}}if(e.children){const r=e.children;for(let e=0,o=r.length;e<o;e++){const o=r[e],n=s.nodes[o];n?a(t,n,i):h(t,"Node not found: "+e)}}}function n(t,e,i){const s=e.attributes;if(!s)return;i.primitive="triangles";const r=e.indices;if(null!=r){const e=t.json.accessors[r];i.indices=l(t,e)}const o=s.POSITION;if(null!=o){const e=t.json.accessors[o];i.localPositions=l(t,e),i.positions=new Float64Array(i.localPositions.length)}const a=s.NORMAL;if(null!=a){const e=t.json.accessors[a];i.normals=l(t,e)}i.indices&&(i.edgeIndices=ue(i.localPositions,i.indices,null,10))}function l(i,s){const r=i.json.bufferViews[s.bufferView],o=e[s.type],a=t[s.componentType],n=a.BYTES_PER_ELEMENT*o;if(!s.byteStride||s.byteStride===n)return new a(r._buffer,s.byteOffset||0,s.count*o);h("interleaved buffer!")}function h(t,e){t.plugin.error(e)}}(),yn={IfcOpeningElement:{pickable:!1,visible:!1},IfcSpace:{colorize:[.137255,.403922,.870588],pickable:!1,visible:!1,opacity:.4},IfcWindow:{colorize:[.137255,.403922,.870588],opacity:.3},IfcPlate:{colorize:[.8470588235,.427450980392,0,.5],opacity:.3},DEFAULT:{}};class Mn extends a{constructor(t,e={}){super("GLTFLoader",t,e),this._sceneGraphLoader=new fn(this,e),this._performanceModelLoader=new vn(this,e),this.dataSource=e.dataSource,this.objectDefaults=e.objectDefaults}set dataSource(t){this._dataSource=t||new Qi}get dataSource(){return this._dataSource}set objectDefaults(t){this._objectDefaults=t||yn}get objectDefaults(){return this._objectDefaults}load(t={}){t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);const e=!1!==t.performance,i=e?new Oa(this.viewer.scene,m.apply(t,{isModel:!0})):new Ka(this.viewer.scene,m.apply(t,{isModel:!0})),s=i.id;if(!t.src&&!t.gltf)return this.error("load() param expected: src or gltf"),i;const r=e?this._performanceModelLoader:this._sceneGraphLoader;if(t.metaModelSrc||t.metaModelData){const e=t.objectDefaults||this._objectDefaults||yn,o=o=>{var a;if(this.viewer.metaScene.createMetaModel(s,o,{includeTypes:t.includeTypes,excludeTypes:t.excludeTypes}),this.viewer.scene.canvas.spinner.processes--,t.includeTypes){a={};for(let e=0,i=t.includeTypes.length;e<i;e++)a[t.includeTypes[e]]=!0}if(t.excludeTypes){a||(a={});for(let e=0,i=t.excludeTypes.length;e<i;e++)a[t.excludeTypes[e]]=!0}t.readableGeometry=!1,t.handleGLTFNode=(t,i,s)=>{const r=i.name;if(!r)return!0;const o=r,a=this.viewer.metaScene.metaObjects[o],n=(a?a.type:"DEFAULT")||"DEFAULT";s.createEntity={id:o,isObject:!0};const l=e[n];return l&&(!1===l.visible&&(s.createEntity.visible=!1),l.colorize&&(s.createEntity.colorize=l.colorize),!1===l.pickable&&(s.createEntity.pickable=!1),void 0!==l.opacity&&null!==l.opacity&&(s.createEntity.opacity=l.opacity)),!0},t.src?r.load(this,i,t.src,t):r.parse(this,i,t.gltf,t)};if(t.metaModelSrc){const e=t.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(e,(t=>{this.viewer.scene.canvas.spinner.processes--,o(t)}),(t=>{this.error(`load(): Failed to load model metadata for model '${s} from  '${e}' - ${t}`),this.viewer.scene.canvas.spinner.processes--}))}else t.metaModelData&&o(t.metaModelData)}else t.handleGLTFNode=(t,e,i)=>{const s=e.name;if(!s)return!0;const r=s;return i.createEntity={id:r,isObject:!0},!0},t.src?r.load(this,i,t.src,t):r.parse(this,i,t.gltf,t);return i.once("destroyed",(()=>{this.viewer.metaScene.destroyMetaModel(s)})),i}destroy(){super.destroy()}}function xn(t,e={}){const i="lightgrey",s=e.hoverColor||"rgba(0,0,0,0.4)",r=500,o=r+r/3,a=o/24,n=[{boundary:[6,6,6,6],color:e.frontColor||e.color||"#55FF55"},{boundary:[18,6,6,6],color:e.backColor||e.color||"#55FF55"},{boundary:[12,6,6,6],color:e.leftColor||e.color||"#FF5555"},{boundary:[0,6,6,6],color:e.rightColor||e.color||"#FF5555"},{boundary:[6,0,6,6],color:e.topColor||e.color||"#7777FF"},{boundary:[6,12,6,6],color:e.bottomColor||e.color||"#7777FF"}],l=[{label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,1,0],up:[0,0,1]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,-1,0],up:[0,0,1]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,0,1]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,0,1]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,0,1],up:[0,-1,0]},{boundaries:[[7,5,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,0,-1],up:[1,0,1]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-1,-1],up:[0,-1,1]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,0,-1],up:[-1,0,1]},{boundaries:[[7,11,4,2]],dir:[0,1,1],up:[0,-1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,0,1],up:[-1,0,1]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,-1,1],up:[0,1,1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,0,1],up:[1,0,1]},{boundaries:[[5,7,2,4]],dir:[1,1,0],up:[0,0,1]},{boundaries:[[11,7,2,4]],dir:[-1,1,0],up:[0,0,1]},{boundaries:[[17,7,2,4]],dir:[-1,-1,0],up:[0,0,1]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,-1,0],up:[0,0,1]},{boundaries:[[5,11,2,2]],dir:[1,1,1],up:[-1,-1,1]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[1,-1,1],up:[-1,1,1]},{boundaries:[[5,5,2,2]],dir:[1,1,-1],up:[1,1,1]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-1,-1,1],up:[1,1,1]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-1,-1,-1],up:[-1,-1,1]},{boundaries:[[11,11,2,2]],dir:[-1,1,1],up:[1,-1,1]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[1,-1,-1],up:[1,-1,1]},{boundaries:[[11,5,2,2]],dir:[-1,1,-1],up:[-1,1,1]}];e.frontColor||e.color,e.backColor||e.color,e.leftColor||e.color,e.rightColor||e.color,e.topColor||e.color,e.bottomColor||e.color;const h=[{yUp:"",label:"NavCube.front",boundaries:[[7,7,4,4]],dir:[0,0,-1],up:[0,1,0]},{label:"NavCube.back",boundaries:[[19,7,4,4]],dir:[0,0,1],up:[0,1,0]},{label:"NavCube.right",boundaries:[[13,7,4,4]],dir:[-1,0,0],up:[0,1,0]},{label:"NavCube.left",boundaries:[[1,7,4,4]],dir:[1,0,0],up:[0,1,0]},{label:"NavCube.top",boundaries:[[7,1,4,4]],dir:[0,-1,0],up:[0,0,-1]},{label:"NavCube.bottom",boundaries:[[7,13,4,4]],dir:[0,1,0],up:[0,0,1]},{boundaries:[[7,5,4,2]],dir:[0,-.7071,-.7071],up:[0,.7071,-.7071]},{boundaries:[[1,6,4,1],[6,1,1,4]],dir:[1,-1,0],up:[1,1,0]},{boundaries:[[7,0,4,1],[19,6,4,1]],dir:[0,-.7071,.7071],up:[0,.7071,.7071]},{boundaries:[[13,6,4,1],[11,1,1,4]],dir:[-1,-1,0],up:[-1,1,0]},{boundaries:[[7,11,4,2]],dir:[0,1,-1],up:[0,1,1]},{boundaries:[[1,11,4,1],[6,13,1,4]],dir:[1,1,0],up:[-1,1,0]},{boundaries:[[7,17,4,1],[19,11,4,1]],dir:[0,1,1],up:[0,1,-1]},{boundaries:[[13,11,4,1],[11,13,1,4]],dir:[-1,1,0],up:[1,1,0]},{boundaries:[[5,7,2,4]],dir:[1,0,-1],up:[0,1,0]},{boundaries:[[11,7,2,4]],dir:[-1,0,-1],up:[0,1,0]},{boundaries:[[17,7,2,4]],dir:[-1,0,1],up:[0,1,0]},{boundaries:[[0,7,1,4],[23,7,1,4]],dir:[1,0,1],up:[0,1,0]},{boundaries:[[5,11,2,2]],dir:[.5,.7071,-.5],up:[-.5,.7071,.5]},{boundaries:[[23,11,1,1],[6,17,1,1],[0,11,1,1]],dir:[.5,.7071,.5],up:[-.5,.7071,-.5]},{boundaries:[[5,5,2,2]],dir:[.5,-.7071,-.5],up:[.5,.7071,-.5]},{boundaries:[[11,17,1,1],[17,11,2,1]],dir:[-.5,.7071,.5],up:[.5,.7071,-.5]},{boundaries:[[17,6,2,1],[11,0,1,1]],dir:[-.5,-.7071,.5],up:[-.5,.7071,.5]},{boundaries:[[11,11,2,2]],dir:[-.5,.7071,-.5],up:[.5,.7071,.5]},{boundaries:[[0,6,1,1],[6,0,1,1],[23,6,1,1]],dir:[.5,-.7071,.5],up:[.5,.7071,.5]},{boundaries:[[11,5,2,2]],dir:[-.5,-.7071,-.5],up:[-.5,.7071,-.5]}];for(let t=0,e=l.length;t<e;t++)d.normalizeVec3(l[t].dir,l[t].dir),d.normalizeVec3(l[t].up,l[t].up);for(let t=0,e=h.length;t<e;t++)d.normalizeVec3(h[t].dir,h[t].dir),d.normalizeVec3(h[t].up,h[t].up);var c=h;this._textureCanvas=document.createElement("canvas"),this._textureCanvas.width=o,this._textureCanvas.height=r,this._textureCanvas.style.width=o+"px",this._textureCanvas.style.height="500px",this._textureCanvas.style.padding="0",this._textureCanvas.style.margin="0",this._textureCanvas.style.top="0",this._textureCanvas.style.background=i,this._textureCanvas.style.position="absolute",this._textureCanvas.style.opacity="1.0",this._textureCanvas.style.visibility="hidden",this._textureCanvas.style["z-index"]=2e6;document.getElementsByTagName("body")[0].appendChild(this._textureCanvas);const u=this._textureCanvas.getContext("2d");let p=!1;function _(){for(let t=0,e=n.length;t<e;t++){const e=n[t],i=e.boundary,s=Math.round(i[0]*a),r=Math.round(i[1]*a),o=Math.round(i[2]*a),l=Math.round(i[3]*a);u.fillStyle=e.color,u.fillRect(s,r,o,l)}for(let t=0,n=c.length;t<n;t++){let n,h,d,p;const _=c[t],g=_.boundaries;for(var e=0,r=g.length;e<r;e++){const t=g[e];n=Math.round(t[0]*a),h=Math.round(t[1]*a),d=Math.round(t[2]*a),p=Math.round(t[3]*a),_.highlighted&&(u.fillStyle=_.highlighted?s:_.color||i,u.fillRect(n,h,d,p))}if(_.label){u.fillStyle="black",u.font="60px sans-serif",u.textAlign="center";var o=n+.5*d,l=h+.7*p;u.fillText(f(_.label),o,l,80)}}t.scene.glRedraw()}const f=function(){const e={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},i={"NavCube.front":"NavCube.front","NavCube.back":"NavCube.back","NavCube.right":"NavCube.right","NavCube.left":"NavCube.left","NavCube.top":"NavCube.top","NavCube.bottom":"NavCube.bottom"},s={"NavCube.front":"FRONT","NavCube.back":"BACK","NavCube.right":"RIGHT","NavCube.left":"LEFT","NavCube.top":"TOP","NavCube.bottom":"BOTTOM"};return function(r){const o=p?i:e,a=o?o[r]:null;return a?t.localeService.translate(a)||s[a]||a:r}}();this.setZUp=function(){p=!0,c=l,this.clear()},this.setYUp=function(){p=!1,c=h,this.clear()},this.clear=function(){u.fillStyle=i,u.fillRect(0,0,o,r);for(var t=0,e=c.length;t<e;t++){c[t].highlighted=!1}_()},this.getArea=function(t){const e=t[0]*o,i=r-t[1]*r;for(var s=0,n=c.length;s<n;s++){const t=c[s].boundaries;for(var l=0,h=t.length;l<h;l++){const r=t[l];if(e>=r[0]*a&&e<=(r[0]+r[2])*a&&i>=r[1]*a&&i<=(r[1]+r[3])*a)return s}}return-1},this.setAreaHighlighted=function(t,e){var i=c[t];if(!i)throw"Area not found: "+t;i.highlighted=!!e,_()},this.getAreaDir=function(t){var e=c[t];if(!e)throw"Unknown area: "+t;return e.dir},this.getAreaUp=function(t){var e=c[t];if(!e)throw"Unknown area: "+t;return e.up},this.getImage=function(){return this._textureCanvas},this.destroy=function(){this._textureCanvas&&(this._textureCanvas.parentNode.removeChild(this._textureCanvas),this._textureCanvas=null)}}class wn extends a{constructor(t,e={}){super("NavCube",t,e),t.navCube=this;try{this._navCubeScene=new Ue(t,{canvasId:e.canvasId,canvasElement:e.canvasElement,transparent:!0}),this._navCubeCanvas=this._navCubeScene.canvas.canvas,this._navCubeScene.input.keyboardEnabled=!1}catch(t){return void this.error(t)}const i=this._navCubeScene;i.clearLights(),new le(i,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new le(i,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new le(i,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._navCubeCamera=i.camera,this._navCubeCamera.ortho.scale=7,this._navCubeCamera.ortho.near=.1,this._navCubeCamera.ortho.far=2e3,i.edgeMaterial.edgeColor=[.2,.2,.2],i.edgeMaterial.edgeAlpha=.6,this._zUp=Boolean(t.camera.zUp);var s=this;this._synchCamera=function(){var e=d.rotationMat4c(-90*d.DEGTORAD,1,0,0),i=d.vec3(),r=d.vec3(),o=d.vec3();return function(){var a=t.camera.eye,n=t.camera.look,l=t.camera.up;i=d.mulVec3Scalar(d.normalizeVec3(d.subVec3(a,n,i)),5),s._zUp?(d.transformVec3(e,i,r),d.transformVec3(e,l,o),s._navCubeCamera.look=[0,0,0],s._navCubeCamera.eye=d.transformVec3(e,i,r),s._navCubeCamera.up=d.transformPoint3(e,l,o)):(s._navCubeCamera.look=[0,0,0],s._navCubeCamera.eye=i,s._navCubeCamera.up=l)}}(),this._cubeTextureCanvas=new xn(t,e),this._cubeSampler=new _n(i,{image:this._cubeTextureCanvas.getImage(),flipY:!0,wrapS:"clampToEdge",wrapT:"clampToEdge"}),this._cubeMesh=new Ri(i,{geometry:new xe(i,{primitive:"triangles",normals:[0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1],positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),material:new Se(i,{diffuse:[.4,.4,.4],specular:[.4,.4,.4],emissive:[.6,.6,.6],diffuseMap:this._cubeSampler,emissiveMap:this._cubeSampler}),visible:!0,edges:!0}),this._shadow=!1===e.shadowVisible?null:new Ri(i,{geometry:new xe(i,Fi({center:[0,0,0],radiusTop:.001,radiusBottom:1.4,height:.01,radialSegments:20,heightSegments:1,openEnded:!0})),material:new Se(i,{diffuse:[0,0,0],specular:[0,0,0],emissive:[0,0,0],alpha:.5}),position:[0,-1.5,0],visible:!0,pickable:!1,backfaces:!1}),this._onCameraMatrix=t.camera.on("matrix",this._synchCamera),this._onCameraWorldAxis=t.camera.on("worldAxis",(()=>{t.camera.zUp?(this._zUp=!0,this._cubeTextureCanvas.setZUp(),this._repaint(),this._synchCamera()):t.camera.yUp&&(this._zUp=!1,this._cubeTextureCanvas.setYUp(),this._repaint(),this._synchCamera())})),this._onCameraFOV=t.camera.perspective.on("fov",(t=>{this._synchProjection&&(this._navCubeCamera.perspective.fov=t)})),this._onCameraProjection=t.camera.on("projection",(t=>{this._synchProjection&&(this._navCubeCamera.projection="ortho"===t||"perspective"===t?t:"perspective")}));var r=-1;function o(t){var e=[0,0];if(t){for(var i=t.target,s=0,r=0;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e[0]=t.x,e[1]=t.y;return e}var a,n,l=null,h=null,c=!1,u=!1,p=.5;s._navCubeCanvas.addEventListener("mouseenter",s._onMouseEnter=function(t){u=!0}),s._navCubeCanvas.addEventListener("mouseleave",s._onMouseLeave=function(t){u=!1}),s._navCubeCanvas.addEventListener("mousedown",s._onMouseDown=function(t){if(1===t.which){l=t.x,h=t.y,a=t.clientX,n=t.clientY;var e=o(t),s=i.pick({canvasPos:e});c=!!s}}),document.addEventListener("mouseup",s._onMouseUp=function(t){if(1===t.which&&(c=!1,null!==l)){var e=o(t),a=i.pick({canvasPos:e,pickSurface:!0});if(a&&a.uv){var n=s._cubeTextureCanvas.getArea(a.uv);if(n>=0&&(document.body.style.cursor="pointer",r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1),n>=0)){if(s._cubeTextureCanvas.setAreaHighlighted(n,!0),r=n,s._repaint(),t.x<l-3||t.x>l+3||t.y<h-3||t.y>h+3)return;var u=s._cubeTextureCanvas.getAreaDir(n);if(u){var d=s._cubeTextureCanvas.getAreaUp(n);_(u,d,(function(){r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1),document.body.style.cursor="pointer",r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1),n>=0&&(s._cubeTextureCanvas.setAreaHighlighted(n,!1),r=-1,s._repaint())}))}}}}}),document.addEventListener("mousemove",s._onMouseMove=function(e){if(r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1),1!==e.buttons||c){if(c){var l=e.clientX,h=e.clientY;return document.body.style.cursor="move",void function(e,i){var s=(e-a)*-p,r=(i-n)*-p;t.camera.orbitYaw(s),t.camera.orbitPitch(-r),a=e,n=i}(l,h)}if(u){var d=o(e),_=i.pick({canvasPos:d,pickSurface:!0});if(_){if(_.uv){document.body.style.cursor="pointer";var f=s._cubeTextureCanvas.getArea(_.uv);if(f===r)return;r>=0&&s._cubeTextureCanvas.setAreaHighlighted(r,!1),f>=0&&(s._cubeTextureCanvas.setAreaHighlighted(f,!0),s._repaint(),r=f)}}else document.body.style.cursor="default",r>=0&&(s._cubeTextureCanvas.setAreaHighlighted(r,!1),s._repaint(),r=-1)}}});var _=function(){var e=d.vec3();return function(i,r,o){var a=s._fitVisible?t.scene.getAABB(t.scene.visibleObjectIds):t.scene.aabb,n=d.getAABB3Diag(a);d.getAABB3Center(a,e);var l=Math.abs(n/Math.tan(s._cameraFitFOV*d.DEGTORAD));t.cameraControl.pivotPos=e,s._cameraFly?t.cameraFlight.flyTo({look:e,eye:[e[0]-l*i[0],e[1]-l*i[1],e[2]-l*i[2]],up:r||[0,1,0],orthoScale:1.1*n,fitFOV:s._cameraFitFOV,duration:s._cameraFlyDuration},o):t.cameraFlight.jumpTo({look:e,eye:[e[0]-l*i[0],e[1]-l*i[1],e[2]-l*i[2]],up:r||[0,1,0],orthoScale:1.1*n,fitFOV:s._cameraFitFOV},o)}}();this._onUpdated=t.localeService.on("updated",(()=>{this._cubeTextureCanvas.clear(),this._repaint()})),this.setVisible(e.visible),this.setCameraFitFOV(e.cameraFitFOV),this.setCameraFly(e.cameraFly),this.setCameraFlyDuration(e.cameraFlyDuration),this.setFitVisible(e.fitVisible),this.setSynchProjection(e.synchProjection)}send(t,e){if("language"===t)this._cubeTextureCanvas.clear(),this._repaint()}_repaint(){const t=this._cubeTextureCanvas.getImage();this._cubeMesh.material.diffuseMap.image=t,this._cubeMesh.material.emissiveMap.image=t}setVisible(t=!0){this._navCubeCanvas&&(this._cubeMesh.visible=t,this._shadow&&(this._shadow.visible=t),this._navCubeCanvas.style.visibility=t?"visible":"hidden")}getVisible(){return!!this._navCubeCanvas&&this._cubeMesh.visible}setFitVisible(t=!1){this._fitVisible=t}getFitVisible(){return this._fitVisible}setCameraFly(t=!0){this._cameraFly=t}getCameraFly(){return this._cameraFly}setCameraFitFOV(t=45){this._cameraFitFOV=t}getCameraFitFOV(){return this._cameraFitFOV}setCameraFlyDuration(t=.5){this._cameraFlyDuration=t}getCameraFlyDuration(){return this._cameraFlyDuration}setSynchProjection(t=!1){this._synchProjection=t}getSynchProjection(){return this._synchProjection}destroy(){this._navCubeCanvas&&(this.viewer.localeService.off(this._onUpdated),this.viewer.camera.off(this._onCameraMatrix),this.viewer.camera.off(this._onCameraWorldAxis),this.viewer.camera.perspective.off(this._onCameraFOV),this.viewer.camera.off(this._onCameraProjection),this._navCubeCanvas.removeEventListener("mouseenter",this._onMouseEnter),this._navCubeCanvas.removeEventListener("mouseleave",this._onMouseLeave),this._navCubeCanvas.removeEventListener("mousedown",this._onMouseDown),document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),this._navCubeCanvas=null,this._cubeTextureCanvas.destroy(),this._cubeTextureCanvas=null,this._onMouseEnter=null,this._onMouseLeave=null,this._onMouseDown=null,this._onMouseMove=null,this._onMouseUp=null),this._navCubeScene.destroy(),this._navCubeScene=null,this._cubeMesh=null,this._shadow=null,super.destroy()}}function En(t={}){let e=t.radius||1;e<0&&(console.error("negative radius not allowed - will invert"),e*=-1),e*=.5;let i=t.tube||.3;i<0&&(console.error("negative tube not allowed - will invert"),i*=-1);let s=t.radialSegments||32;s<0&&(console.error("negative radialSegments not allowed - will invert"),s*=-1),s<4&&(s=4);let r=t.tubeSegments||24;r<0&&(console.error("negative tubeSegments not allowed - will invert"),r*=-1),r<4&&(r=4);let o=t.arc||2*Math.PI;o<0&&(console.warn("negative arc not allowed - will invert"),o*=-1),o>360&&(o=360);const a=t.center;let n=a?a[0]:0,l=a?a[1]:0;const h=a?a[2]:0,c=[],u=[],p=[],_=[];let f,g,v,b,P,y,M,x,w,E,A,C;for(x=0;x<=r;x++)for(M=0;M<=s;M++)f=M/s*o,g=.785398+x/r*Math.PI*2,n=e*Math.cos(f),l=e*Math.sin(f),v=(e+i*Math.cos(g))*Math.cos(f),b=(e+i*Math.cos(g))*Math.sin(f),P=i*Math.sin(g),c.push(v+n),c.push(b+l),c.push(P+h),p.push(1-M/s),p.push(x/r),y=d.normalizeVec3(d.subVec3([v,b,P],[n,l,h],[]),[]),u.push(y[0]),u.push(y[1]),u.push(y[2]);for(x=1;x<=r;x++)for(M=1;M<=s;M++)w=(s+1)*x+M-1,E=(s+1)*(x-1)+M-1,A=(s+1)*(x-1)+M,C=(s+1)*x+M,_.push(w),_.push(E),_.push(A),_.push(A),_.push(C),_.push(w);return m.apply(t,{positions:c,normals:u,uv:p,indices:_})}const An=new Float64Array([0,0,1]),Cn=new Float64Array(4);class Sn{constructor(t){this.id=null,this._viewer=t.viewer,this._visible=!1,this._pos=d.vec3(),this._origin=d.vec3(),this._rtcPos=d.vec3(),this._baseDir=d.vec3(),this._rootNode=null,this._displayMeshes=null,this._affordanceMeshes=null,this._ignoreNextSectionPlaneDirUpdate=!1,this._createNodes(),this._bindEvents()}_setSectionPlane(t){this._sectionPlane&&(this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._onSectionPlanePos=null,this._onSectionPlaneDir=null,this._sectionPlane=null),t&&(this.id=t.id,this._setPos(t.pos),this._setDir(t.dir),this._sectionPlane=t,this._onSectionPlanePos=t.on("pos",(()=>{this._setPos(this._sectionPlane.pos)})),this._onSectionPlaneDir=t.on("dir",(()=>{this._ignoreNextSectionPlaneDirUpdate?this._ignoreNextSectionPlaneDirUpdate=!1:this._setDir(this._sectionPlane.dir)})))}get sectionPlane(){return this._sectionPlane}_setPos(t){this._pos.set(t),j(this._pos,this._origin,this._rtcPos),this._rootNode.origin=this._origin,this._rootNode.position=this._rtcPos}_setDir(t){this._baseDir.set(t),this._rootNode.quaternion=d.vec3PairToQuaternion(An,t,Cn)}_setSectionPlaneDir(t){this._sectionPlane&&(this._ignoreNextSectionPlaneDirUpdate=!0,this._sectionPlane.dir=t)}setVisible(t=!0){if(this._visible!==t){var e;for(e in this._visible=t,this._displayMeshes)this._displayMeshes.hasOwnProperty(e)&&(this._displayMeshes[e].visible=t);if(!t)for(e in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(e)&&(this._affordanceMeshes[e].visible=t)}}getVisible(){return this._visible}setCulled(t){var e;for(e in this._displayMeshes)this._displayMeshes.hasOwnProperty(e)&&(this._displayMeshes[e].culled=t);if(!t)for(e in this._affordanceMeshes)this._affordanceMeshes.hasOwnProperty(e)&&(this._affordanceMeshes[e].culled=t)}_createNodes(){const t=!1,e=this._viewer.scene,i=.01;this._rootNode=new Ka(e,{position:[0,0,0],scale:[5,5,5]});const s=this._rootNode,r={arrowHead:new xe(s,Fi({radiusTop:.001,radiusBottom:.07,radialSegments:32,heightSegments:1,height:.2,openEnded:!1})),arrowHeadBig:new xe(s,Fi({radiusTop:.001,radiusBottom:.09,radialSegments:32,heightSegments:1,height:.25,openEnded:!1})),arrowHeadHandle:new xe(s,Fi({radiusTop:.09,radiusBottom:.09,radialSegments:8,heightSegments:1,height:.37,openEnded:!1})),curve:new xe(s,En({radius:.8,tube:i,radialSegments:64,tubeSegments:14,arc:2*Math.PI/4})),curveHandle:new xe(s,En({radius:.8,tube:.06,radialSegments:64,tubeSegments:14,arc:2*Math.PI/4})),hoop:new xe(s,En({radius:.8,tube:i,radialSegments:64,tubeSegments:8,arc:2*Math.PI})),axis:new xe(s,Fi({radiusTop:i,radiusBottom:i,radialSegments:20,heightSegments:1,height:1,openEnded:!1})),axisHandle:new xe(s,Fi({radiusTop:.08,radiusBottom:.08,radialSegments:20,heightSegments:1,height:1,openEnded:!1}))},o={pickable:new Se(s,{diffuse:[1,1,0],alpha:0,alphaMode:"blend"}),red:new Se(s,{diffuse:[1,0,0],emissive:[1,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightRed:new Le(s,{edges:!1,fill:!0,fillColor:[1,0,0],fillAlpha:.6}),green:new Se(s,{diffuse:[0,1,0],emissive:[0,1,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightGreen:new Le(s,{edges:!1,fill:!0,fillColor:[0,1,0],fillAlpha:.6}),blue:new Se(s,{diffuse:[0,0,1],emissive:[0,0,1],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80,lineWidth:2}),highlightBlue:new Le(s,{edges:!1,fill:!0,fillColor:[0,0,1],fillAlpha:.2}),center:new Se(s,{diffuse:[0,0,0],emissive:[0,0,0],ambient:[0,0,0],specular:[.6,.6,.3],shininess:80}),highlightBall:new Le(s,{edges:!1,fill:!0,fillColor:[.5,.5,.5],fillAlpha:.5,vertices:!1}),highlightPlane:new Le(s,{edges:!0,edgeWidth:3,fill:!1,fillColor:[.5,.5,.5],fillAlpha:.5,vertices:!1})};this._displayMeshes={plane:s.addChild(new Ri(s,{geometry:new xe(s,{primitive:"triangles",positions:[.5,.5,0,.5,-.5,0,-.5,-.5,0,-.5,.5,0,.5,.5,-0,.5,-.5,-0,-.5,-.5,-0,-.5,.5,-0],indices:[0,1,2,2,3,0]}),material:new Se(s,{emissive:[0,0,0],diffuse:[0,0,0],backfaces:!0}),opacity:.6,ghosted:!0,ghostMaterial:new Le(s,{edges:!1,filled:!0,fillColor:[1,1,0],edgeColor:[0,0,0],fillAlpha:.1,backfaces:!0}),pickable:!1,collidable:!0,clippable:!1,visible:!1,scale:[2.4,2.4,1]}),t),planeFrame:s.addChild(new Ri(s,{geometry:new xe(s,En({center:[0,0,0],radius:1.7,tube:.02,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new Se(s,{emissive:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],shininess:0}),highlightMaterial:new Le(s,{edges:!1,edgeColor:[0,0,0],filled:!0,fillColor:[.8,.8,.8],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,.1],rotation:[0,0,45]}),t),xCurve:s.addChild(new Ri(s,{geometry:r.curve,material:o.red,matrix:function(){const t=d.rotationMat4v(90*d.DEGTORAD,[0,1,0],d.identityMat4()),e=d.rotationMat4v(270*d.DEGTORAD,[1,0,0],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),t),xCurveHandle:s.addChild(new Ri(s,{geometry:r.curveHandle,material:o.pickable,matrix:function(){const t=d.rotationMat4v(90*d.DEGTORAD,[0,1,0],d.identityMat4()),e=d.rotationMat4v(270*d.DEGTORAD,[1,0,0],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),t),xCurveArrow1:s.addChild(new Ri(s,{geometry:r.arrowHead,material:o.red,matrix:function(){const t=d.translateMat4c(0,-.07,-.8,d.identityMat4()),e=d.scaleMat4v([.6,.6,.6],d.identityMat4()),i=d.rotationMat4v(0*d.DEGTORAD,[0,0,1],d.identityMat4());return d.mulMat4(d.mulMat4(t,e,d.identityMat4()),i,d.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),xCurveArrow2:s.addChild(new Ri(s,{geometry:r.arrowHead,material:o.red,matrix:function(){const t=d.translateMat4c(0,-.8,-.07,d.identityMat4()),e=d.scaleMat4v([.6,.6,.6],d.identityMat4()),i=d.rotationMat4v(90*d.DEGTORAD,[1,0,0],d.identityMat4());return d.mulMat4(d.mulMat4(t,e,d.identityMat4()),i,d.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),yCurve:s.addChild(new Ri(s,{geometry:r.curve,material:o.green,rotation:[-90,0,0],pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),t),yCurveHandle:s.addChild(new Ri(s,{geometry:r.curveHandle,material:o.pickable,rotation:[-90,0,0],pickable:!0,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),t),yCurveArrow1:s.addChild(new Ri(s,{geometry:r.arrowHead,material:o.green,matrix:function(){const t=d.translateMat4c(.07,0,-.8,d.identityMat4()),e=d.scaleMat4v([.6,.6,.6],d.identityMat4()),i=d.rotationMat4v(90*d.DEGTORAD,[0,0,1],d.identityMat4());return d.mulMat4(d.mulMat4(t,e,d.identityMat4()),i,d.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),yCurveArrow2:s.addChild(new Ri(s,{geometry:r.arrowHead,material:o.green,matrix:function(){const t=d.translateMat4c(.8,0,-.07,d.identityMat4()),e=d.scaleMat4v([.6,.6,.6],d.identityMat4()),i=d.rotationMat4v(90*d.DEGTORAD,[1,0,0],d.identityMat4());return d.mulMat4(d.mulMat4(t,e,d.identityMat4()),i,d.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),zCurve:s.addChild(new Ri(s,{geometry:r.curve,material:o.blue,matrix:d.rotationMat4v(180*d.DEGTORAD,[1,0,0],d.identityMat4()),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),zCurveHandle:s.addChild(new Ri(s,{geometry:r.curveHandle,material:o.pickable,matrix:d.rotationMat4v(180*d.DEGTORAD,[1,0,0],d.identityMat4()),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),zCurveCurveArrow1:s.addChild(new Ri(s,{geometry:r.arrowHead,material:o.blue,matrix:function(){const t=d.translateMat4c(.8,-.07,0,d.identityMat4()),e=d.scaleMat4v([.6,.6,.6],d.identityMat4());return d.mulMat4(t,e,d.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),zCurveArrow2:s.addChild(new Ri(s,{geometry:r.arrowHead,material:o.blue,matrix:function(){const t=d.translateMat4c(.05,-.8,0,d.identityMat4()),e=d.scaleMat4v([.6,.6,.6],d.identityMat4()),i=d.rotationMat4v(90*d.DEGTORAD,[0,0,1],d.identityMat4());return d.mulMat4(d.mulMat4(t,e,d.identityMat4()),i,d.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),center:s.addChild(new Ri(s,{geometry:new xe(s,Ni({radius:.05})),material:o.center,pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),xAxisArrow:s.addChild(new Ri(s,{geometry:r.arrowHead,material:o.red,matrix:function(){const t=d.translateMat4c(0,1.1,0,d.identityMat4()),e=d.rotationMat4v(-90*d.DEGTORAD,[0,0,1],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),xAxisArrowHandle:s.addChild(new Ri(s,{geometry:r.arrowHeadHandle,material:o.pickable,matrix:function(){const t=d.translateMat4c(0,1.1,0,d.identityMat4()),e=d.rotationMat4v(-90*d.DEGTORAD,[0,0,1],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),xAxis:s.addChild(new Ri(s,{geometry:r.axis,material:o.red,matrix:function(){const t=d.translateMat4c(0,.5,0,d.identityMat4()),e=d.rotationMat4v(-90*d.DEGTORAD,[0,0,1],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),xAxisHandle:s.addChild(new Ri(s,{geometry:r.axisHandle,material:o.pickable,matrix:function(){const t=d.translateMat4c(0,.5,0,d.identityMat4()),e=d.rotationMat4v(-90*d.DEGTORAD,[0,0,1],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),yAxisArrow:s.addChild(new Ri(s,{geometry:r.arrowHead,material:o.green,matrix:function(){const t=d.translateMat4c(0,1.1,0,d.identityMat4()),e=d.rotationMat4v(180*d.DEGTORAD,[1,0,0],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),yAxisArrowHandle:s.addChild(new Ri(s,{geometry:r.arrowHeadHandle,material:o.pickable,matrix:function(){const t=d.translateMat4c(0,1.1,0,d.identityMat4()),e=d.rotationMat4v(180*d.DEGTORAD,[1,0,0],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1,opacity:.2}),t),yShaft:s.addChild(new Ri(s,{geometry:r.axis,material:o.green,position:[0,-.5,0],pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),yShaftHandle:s.addChild(new Ri(s,{geometry:r.axisHandle,material:o.pickable,position:[0,-.5,0],pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),zAxisArrow:s.addChild(new Ri(s,{geometry:r.arrowHead,material:o.blue,matrix:function(){const t=d.translateMat4c(0,1.1,0,d.identityMat4()),e=d.rotationMat4v(-90*d.DEGTORAD,[.8,0,0],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),zAxisArrowHandle:s.addChild(new Ri(s,{geometry:r.arrowHeadHandle,material:o.pickable,matrix:function(){const t=d.translateMat4c(0,1.1,0,d.identityMat4()),e=d.rotationMat4v(-90*d.DEGTORAD,[.8,0,0],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!0,collidable:!0,clippable:!1,visible:!1}),t),zShaft:s.addChild(new Ri(s,{geometry:r.axis,material:o.blue,matrix:function(){const t=d.translateMat4c(0,.5,0,d.identityMat4()),e=d.rotationMat4v(-90*d.DEGTORAD,[1,0,0],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),clippable:!1,pickable:!1,collidable:!0,visible:!1}),t),zAxisHandle:s.addChild(new Ri(s,{geometry:r.axisHandle,material:o.pickable,matrix:function(){const t=d.translateMat4c(0,.5,0,d.identityMat4()),e=d.rotationMat4v(-90*d.DEGTORAD,[1,0,0],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),clippable:!1,pickable:!0,collidable:!0,visible:!1}),t)},this._affordanceMeshes={planeFrame:s.addChild(new Ri(s,{geometry:new xe(s,En({center:[0,0,0],radius:2,tube:i,radialSegments:4,tubeSegments:4,arc:2*Math.PI})),material:new Se(s,{ambient:[1,1,1],diffuse:[0,0,0],emissive:[1,1,0]}),highlighted:!0,highlightMaterial:new Le(s,{edges:!1,filled:!0,fillColor:[1,1,0],fillAlpha:1}),pickable:!1,collidable:!1,clippable:!1,visible:!1,scale:[1,1,1],rotation:[0,0,45]}),t),xHoop:s.addChild(new Ri(s,{geometry:r.hoop,material:o.red,highlighted:!0,highlightMaterial:o.highlightRed,matrix:function(){const t=d.rotationMat4v(90*d.DEGTORAD,[0,1,0],d.identityMat4()),e=d.rotationMat4v(270*d.DEGTORAD,[1,0,0],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),yHoop:s.addChild(new Ri(s,{geometry:r.hoop,material:o.green,highlighted:!0,highlightMaterial:o.highlightGreen,rotation:[-90,0,0],pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),zHoop:s.addChild(new Ri(s,{geometry:r.hoop,material:o.blue,highlighted:!0,highlightMaterial:o.highlightBlue,matrix:d.rotationMat4v(180*d.DEGTORAD,[1,0,0],d.identityMat4()),pickable:!1,collidable:!0,clippable:!1,backfaces:!0,visible:!1}),t),xAxisArrow:s.addChild(new Ri(s,{geometry:r.arrowHeadBig,material:o.red,matrix:function(){const t=d.translateMat4c(0,1.1,0,d.identityMat4()),e=d.rotationMat4v(-90*d.DEGTORAD,[0,0,1],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),yAxisArrow:s.addChild(new Ri(s,{geometry:r.arrowHeadBig,material:o.green,matrix:function(){const t=d.translateMat4c(0,1.1,0,d.identityMat4()),e=d.rotationMat4v(180*d.DEGTORAD,[1,0,0],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t),zAxisArrow:s.addChild(new Ri(s,{geometry:r.arrowHeadBig,material:o.blue,matrix:function(){const t=d.translateMat4c(0,1.1,0,d.identityMat4()),e=d.rotationMat4v(-90*d.DEGTORAD,[.8,0,0],d.identityMat4());return d.mulMat4(e,t,d.identityMat4())}(),pickable:!1,collidable:!0,clippable:!1,visible:!1}),t)}}_bindEvents(){const t=this;var e=!1;const i=-1,s=0,r=1,o=2,a=3,n=4,l=5,h=this._rootNode;var c=null,u=null;const p=d.vec2(),_=d.vec3([1,0,0]),f=d.vec3([0,1,0]),g=d.vec3([0,0,1]),m=this._viewer.scene.canvas.canvas,v=this._viewer.camera,b=this._viewer.scene;{const t=d.vec3([0,0,0]);let e=-1;this._onCameraViewMatrix=b.camera.on("viewMatrix",(()=>{})),this._onCameraProjMatrix=b.camera.on("projMatrix",(()=>{})),this._onSceneTick=b.on("tick",(()=>{const i=Math.abs(d.lenVec3(d.subVec3(b.camera.eye,this._pos,t)));if(i!==e&&"perspective"===v.projection){const t=.07*(Math.tan(v.perspective.fov*d.DEGTORAD)*i);h.scale=[t,t,t],e=i}if("ortho"===v.projection){const t=v.ortho.scale/10;h.scale=[t,t,t],e=i}}))}const P=function(){const t=new Float64Array(2);return function(e){if(e){for(var i=e.target,s=0,r=0;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;t[0]=e.pageX-s,t[1]=e.pageY-r}else e=window.event,t[0]=e.x,t[1]=e.y;return t}}(),y=function(){const e=d.mat4();return function(i,s){return d.quaternionToMat4(t._rootNode.quaternion,e),d.transformVec3(e,i,s),d.normalizeVec3(s),s}}();var M=function(){const t=d.vec3();return function(e){const i=Math.abs(e[0]);return i>Math.abs(e[1])&&i>Math.abs(e[2])?d.cross3Vec3(e,[0,1,0],t):d.cross3Vec3(e,[1,0,0],t),d.cross3Vec3(t,e,t),d.normalizeVec3(t),t}}();const x=function(){const e=d.vec3(),i=d.vec3(),s=d.vec4();return function(r,o,a){y(r,s);const n=M(s,o,a);E(o,n,e),E(a,n,i),d.subVec3(i,e);const l=d.dotVec3(i,s);t._pos[0]+=s[0]*l,t._pos[1]+=s[1]*l,t._pos[2]+=s[2]*l,t._rootNode.position=t._pos,t._sectionPlane&&(t._sectionPlane.pos=t._pos)}}();var w=function(){const e=d.vec4(),i=d.vec4(),s=d.vec4(),r=d.vec4();return function(o,a,n){y(o,r);if(!(E(a,r,e)&&E(n,r,i))){const t=M(r,a,n);E(a,t,e,1),E(n,t,i,1);var l=d.dotVec3(e,r);e[0]-=l*r[0],e[1]-=l*r[1],e[2]-=l*r[2],l=d.dotVec3(i,r),i[0]-=l*r[0],i[1]-=l*r[1],i[2]-=l*r[2]}d.normalizeVec3(e),d.normalizeVec3(i),l=d.dotVec3(e,i),l=d.clamp(l,-1,1);var h=Math.acos(l)*d.RADTODEG;d.cross3Vec3(e,i,s),d.dotVec3(s,r)<0&&(h=-h),t._rootNode.rotate(o,h),A()}}(),E=function(){const e=d.vec4([0,0,0,1]),i=d.mat4();return function(s,r,o,a){a=a||0,e[0]=s[0]/m.width*2-1,e[1]=-(s[1]/m.height*2-1),e[2]=0,e[3]=1,d.mulMat4(v.projMatrix,v.viewMatrix,i),d.inverseMat4(i),d.transformVec4(i,e,e),d.mulVec4Scalar(e,1/e[3]);var n=v.eye;d.subVec4(e,n,e);const l=t._sectionPlane.pos;var h=-d.dotVec3(l,r)-a,c=d.dotVec3(r,e);if(Math.abs(c)>.005){var u=-(d.dotVec3(r,n)+h)/c;return d.mulVec3Scalar(e,u,o),d.addVec3(o,n),d.subVec3(o,l,o),!0}return!1}}();const A=function(){const e=d.vec3(),i=d.mat4();return function(){t.sectionPlane&&(d.quaternionToMat4(h.quaternion,i),d.transformVec3(i,[0,0,1],e),t._setSectionPlaneDir(e))}}();var C,S=!1;this._onCameraControlHover=this._viewer.cameraControl.on("hoverEnter",(t=>{if(!this._visible)return;if(S)return;var h;e=!1,C&&(C.visible=!1);switch(t.entity.id){case this._displayMeshes.xAxisArrowHandle.id:case this._displayMeshes.xAxisHandle.id:h=this._affordanceMeshes.xAxisArrow,c=s;break;case this._displayMeshes.yAxisArrowHandle.id:case this._displayMeshes.yShaftHandle.id:h=this._affordanceMeshes.yAxisArrow,c=r;break;case this._displayMeshes.zAxisArrowHandle.id:case this._displayMeshes.zAxisHandle.id:h=this._affordanceMeshes.zAxisArrow,c=o;break;case this._displayMeshes.xCurveHandle.id:h=this._affordanceMeshes.xHoop,c=a;break;case this._displayMeshes.yCurveHandle.id:h=this._affordanceMeshes.yHoop,c=n;break;case this._displayMeshes.zCurveHandle.id:h=this._affordanceMeshes.zHoop,c=l;break;default:return void(c=i)}h&&(h.visible=!0),C=h,e=!0})),this._onCameraControlHoverLeave=this._viewer.cameraControl.on("hoverOut",(t=>{this._visible&&(C&&(C.visible=!1),C=null,c=i)})),m.addEventListener("mousedown",this._canvasMouseDownListener=t=>{if(t.preventDefault(),this._visible&&e&&(this._viewer.cameraControl.pointerEnabled=!1,1===t.which)){S=!0;var i=P(t);u=c,p[0]=i[0],p[1]=i[1]}}),m.addEventListener("mousemove",this._canvasMouseMoveListener=t=>{if(!this._visible)return;if(!S)return;var e=P(t);const i=e[0],h=e[1];switch(u){case s:x(_,p,e);break;case r:x(f,p,e);break;case o:x(g,p,e);break;case a:w(_,p,e);break;case n:w(f,p,e);break;case l:w(g,p,e)}p[0]=i,p[1]=h}),m.addEventListener("mouseup",this._canvasMouseUpListener=t=>{this._visible&&(this._viewer.cameraControl.pointerEnabled=!0,S&&(t.which,S=!1,e=!1))}),m.addEventListener("wheel",this._canvasWheelListener=t=>{if(this._visible)Math.max(-1,Math.min(1,40*-t.deltaY))})}_destroy(){this._unbindEvents(),this._destroyNodes()}_unbindEvents(){const t=this._viewer,e=t.scene,i=e.canvas.canvas,s=t.camera,r=t.cameraControl;e.off(this._onSceneTick),i.removeEventListener("mousedown",this._canvasMouseDownListener),i.removeEventListener("mousemove",this._canvasMouseMoveListener),i.removeEventListener("mouseup",this._canvasMouseUpListener),i.removeEventListener("wheel",this._canvasWheelListener),s.off(this._onCameraViewMatrix),s.off(this._onCameraProjMatrix),r.off(this._onCameraControlHover),r.off(this._onCameraControlHoverLeave)}_destroyNodes(){this._setSectionPlane(null),this._rootNode.destroy(),this._displayMeshes={},this._affordanceMeshes={}}}class Dn{constructor(t,e,i){this.id=i.id,this._sectionPlane=i,this._mesh=new Ri(e,{id:i.id,geometry:new xe(e,we({xSize:.5,ySize:.5,zSize:.001})),material:new Se(e,{emissive:[1,1,1],diffuse:[0,0,0],backfaces:!1}),edgeMaterial:new Re(e,{edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),highlightMaterial:new Le(e,{fill:!0,fillColor:[.5,1,.5],fillAlpha:.7,edges:!0,edgeColor:[0,0,0],edgeAlpha:1,edgeWidth:1}),selectedMaterial:new Le(e,{fill:!0,fillColor:[0,0,1],fillAlpha:.7,edges:!0,edgeColor:[1,0,0],edgeAlpha:1,edgeWidth:1}),highlighted:!0,scale:[3,3,3],position:[0,0,0],rotation:[0,0,0],opacity:.3,edges:!0});{const t=d.vec3([0,0,0]),e=d.vec3(),i=d.vec3([0,0,1]),s=d.vec4(4),r=d.vec3(),o=()=>{const o=this._sectionPlane.scene.center,a=[-this._sectionPlane.dir[0],-this._sectionPlane.dir[1],-this._sectionPlane.dir[2]];d.subVec3(o,this._sectionPlane.pos,t);const n=-d.dotVec3(a,t);d.normalizeVec3(a),d.mulVec3Scalar(a,n,e);const l=d.vec3PairToQuaternion(i,this._sectionPlane.dir,s);r[0]=.1*e[0],r[1]=.1*e[1],r[2]=.1*e[2],this._mesh.quaternion=l,this._mesh.position=r};this._onSectionPlanePos=this._sectionPlane.on("pos",o),this._onSectionPlaneDir=this._sectionPlane.on("dir",o)}this._highlighted=!1,this._selected=!1}setHighlighted(t){this._highlighted=!!t,this._mesh.highlighted=this._highlighted,this._mesh.highlightMaterial.fillColor=t?[0,.7,0]:[0,0,0]}getHighlighted(){return this._highlighted}setSelected(t){this._selected=!!t,this._mesh.edgeMaterial.edgeWidth=t?3:1,this._mesh.highlightMaterial.edgeWidth=t?3:1}getSelected(){return this._selected}destroy(){this._sectionPlane.off(this._onSectionPlanePos),this._sectionPlane.off(this._onSectionPlaneDir),this._mesh.destroy()}}class Ln{constructor(t,e){if(!(e.onHoverEnterPlane&&e.onHoverLeavePlane&&e.onClickedNothing&&e.onClickedPlane))throw"Missing config(s): onHoverEnterPlane, onHoverLeavePlane, onClickedNothing || onClickedPlane";this.plugin=t,this._viewer=t.viewer,this._onHoverEnterPlane=e.onHoverEnterPlane,this._onHoverLeavePlane=e.onHoverLeavePlane,this._onClickedNothing=e.onClickedNothing,this._onClickedPlane=e.onClickedPlane,this._visible=!0,this._planes={},this._canvas=e.overviewCanvas,this._scene=new Ue(this._viewer,{canvasId:this._canvas.id,transparent:!0}),this._scene.clearLights(),new le(this._scene,{dir:[.4,-.4,.8],color:[.8,1,1],intensity:1,space:"view"}),new le(this._scene,{dir:[-.8,-.3,-.4],color:[.8,.8,.8],intensity:1,space:"view"}),new le(this._scene,{dir:[.8,-.6,-.8],color:[1,1,1],intensity:1,space:"view"}),this._scene.camera,this._scene.camera.perspective.fov=70,this._zUp=!1;{const t=this._scene.camera,e=d.rotationMat4c(-90*d.DEGTORAD,1,0,0),i=d.vec3(),s=d.vec3(),r=d.vec3();this._synchCamera=()=>{const o=this._viewer.camera.eye,a=this._viewer.camera.look,n=this._viewer.camera.up;d.mulVec3Scalar(d.normalizeVec3(d.subVec3(o,a,i)),7),this._zUp?(d.transformVec3(e,i,s),d.transformVec3(e,n,r),t.look=[0,0,0],t.eye=d.transformVec3(e,i,s),t.up=d.transformPoint3(e,n,r)):(t.look=[0,0,0],t.eye=i,t.up=n)}}this._onViewerCameraMatrix=this._viewer.camera.on("matrix",this._synchCamera),this._onViewerCameraWorldAxis=this._viewer.camera.on("worldAxis",this._synchCamera),this._onViewerCameraFOV=this._viewer.camera.perspective.on("fov",(t=>{this._scene.camera.perspective.fov=t}));var i=null;this._onInputMouseMove=this._scene.input.on("mousemove",(t=>{const e=this._scene.pick({canvasPos:t});if(e){if(!i||e.entity.id!==i.id){if(i){this._planes[i.id]&&this._onHoverLeavePlane(i.id)}i=e.entity;this._planes[i.id]&&this._onHoverEnterPlane(i.id)}}else i&&(this._onHoverLeavePlane(i.id),i=null)})),this._scene.canvas.canvas.addEventListener("mouseup",this._onCanvasMouseUp=()=>{if(i){this._planes[i.id]&&this._onClickedPlane(i.id)}else this._onClickedNothing()}),this._scene.canvas.canvas.addEventListener("mouseout",this._onCanvasMouseOut=()=>{i&&(this._onHoverLeavePlane(i.id),i=null)}),this.setVisible(e.overviewVisible)}addSectionPlane(t){this._planes[t.id]=new Dn(this,this._scene,t)}setPlaneHighlighted(t,e){const i=this._planes[t];i&&i.setHighlighted(e)}setPlaneSelected(t,e){const i=this._planes[t];i&&i.setSelected(e)}removeSectionPlane(t){const e=this._planes[t.id];e&&(e.destroy(),delete this._planes[t.id])}setVisible(t=!0){this._visible=t,this._canvas.style.visibility=t?"visible":"hidden"}getVisible(){return this._visible}destroy(){this._viewer.camera.off(this._onViewerCameraMatrix),this._viewer.camera.off(this._onViewerCameraWorldAxis),this._viewer.camera.perspective.off(this._onViewerCameraFOV),this._scene.input.off(this._onInputMouseMove),this._scene.canvas.canvas.removeEventListener("mouseup",this._onCanvasMouseUp),this._scene.canvas.canvas.removeEventListener("mouseout",this._onCanvasMouseOut),this._scene.destroy()}}const Bn=d.AABB3(),Rn=d.vec3();class Tn extends a{constructor(t,e={}){if(super("SectionPlanes",t),this._freeControls=[],this._sectionPlanes=t.scene.sectionPlanes,this._controls={},this._shownControlId=null,null!==e.overviewCanvasId&&void 0!==e.overviewCanvasId){const t=document.getElementById(e.overviewCanvasId);t?this._overview=new Ln(this,{overviewCanvas:t,visible:e.overviewVisible,onHoverEnterPlane:t=>{this._overview.setPlaneHighlighted(t,!0)},onHoverLeavePlane:t=>{this._overview.setPlaneHighlighted(t,!1)},onClickedPlane:t=>{if(this.getShownControl()===t)return void this.hideControl();this.showControl(t);const e=this.sectionPlanes[t].pos;Bn.set(this.viewer.scene.aabb),d.getAABB3Center(Bn,Rn),Bn[0]+=e[0]-Rn[0],Bn[1]+=e[1]-Rn[1],Bn[2]+=e[2]-Rn[2],Bn[3]+=e[0]-Rn[0],Bn[4]+=e[1]-Rn[1],Bn[5]+=e[2]-Rn[2],this.viewer.cameraFlight.flyTo({aabb:Bn,fitFOV:65})},onClickedNothing:()=>{this.hideControl()}}):this.warn("Can't find overview canvas: '"+e.overviewCanvasId+"' - will create plugin without overview")}this._onSceneSectionPlaneCreated=t.scene.on("sectionPlaneCreated",(t=>{this._sectionPlaneCreated(t)}))}setOverviewVisible(t){this._overview&&this._overview.setVisible(t)}getOverviewVisible(){if(this._overview)return this._overview.getVisible()}get sectionPlanes(){return this._sectionPlanes}createSectionPlane(t={}){void 0!==t.id&&null!==t.id&&this.viewer.scene.components[t.id]&&(this.error("Viewer component with this ID already exists: "+t.id),delete t.id);return new Vi(this.viewer.scene,{id:t.id,pos:t.pos,dir:t.dir,active:!0})}_sectionPlaneCreated(t){const e=this._freeControls.length>0?this._freeControls.pop():new Sn(this);e._setSectionPlane(t),e.setVisible(!1),this._controls[t.id]=e,this._overview&&this._overview.addSectionPlane(t),t.once("destroyed",(()=>{this._sectionPlaneDestroyed(t)}))}flipSectionPlanes(){const t=this.viewer.scene.sectionPlanes;for(let e in t){t[e].flipDir()}}showControl(t){const e=this._controls[t];e?(this.hideControl(),e.setVisible(!0),this._overview&&this._overview.setPlaneSelected(t,!0),this._shownControlId=t):this.error("Control not found: "+t)}getShownControl(){return this._shownControlId}hideControl(){for(var t in this._controls)this._controls.hasOwnProperty(t)&&(this._controls[t].setVisible(!1),this._overview&&this._overview.setPlaneSelected(t,!1));this._shownControlId=null}destroySectionPlane(t){var e=this.viewer.scene.sectionPlanes[t];e?(this._sectionPlaneDestroyed(e),e.destroy(),t===this._shownControlId&&(this._shownControlId=null)):this.error("SectionPlane not found: "+t)}_sectionPlaneDestroyed(t){this._overview&&this._overview.removeSectionPlane(t);const e=this._controls[t.id];e&&(e.setVisible(!1),e._setSectionPlane(null),delete this._controls[t.id],this._freeControls.push(e))}clear(){const t=Object.keys(this._sectionPlanes);for(var e=0,i=t.length;e<i;e++)this.destroySectionPlane(t[e])}send(t,e){switch(t){case"snapshotStarting":for(let t in this._controls)this._controls.hasOwnProperty(t)&&this._controls[t].setCulled(!0);break;case"snapshotFinished":for(let t in this._controls)this._controls.hasOwnProperty(t)&&this._controls[t].setCulled(!1);break;case"clearSectionPlanes":this.clear()}}destroy(){this.clear(),this._overview&&this._overview.destroy(),this._destroyFreeControls(),super.destroy()}_destroyFreeControls(){for(var t=this._freeControls.pop();t;)t._destroy(),t=this._freeControls.pop();this.viewer.scene.off(this._onSceneSectionPlaneCreated)}}class Fn{constructor(){}getMetaModel(t,e,i){m.loadJSON(t,(t=>{e(t)}),(function(t){i(t)}))}getXKT(t,e,i){var s=()=>{};e=e||s,i=i||s;const r=t.match(/^data:(.*?)(;base64)?,(.*)$/);if(r){const t=!!r[2];var o=r[3];o=window.decodeURIComponent(o),t&&(o=window.atob(o));try{const t=new ArrayBuffer(o.length),i=new Uint8Array(t);for(var a=0;a<o.length;a++)i[a]=o.charCodeAt(a);e(t)}catch(t){i(t)}}else{const s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onreadystatechange=function(){4===s.readyState&&(200===s.status?e(s.response):i("getXKT error : "+s.response))},s.send(null)}}}!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).pako=t()}}((function(){return function t(e,i,s){function r(a,n){if(!i[a]){if(!e[a]){var l="function"==typeof require&&require;if(!n&&l)return l(a,!0);if(o)return o(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var c=i[a]={exports:{}};e[a][0].call(c.exports,(function(t){return r(e[a][1][t]||t)}),c,c.exports,t,e,i,s)}return i[a].exports}for(var o="function"==typeof require&&require,a=0;a<s.length;a++)r(s[a]);return r}({1:[function(t,e,i){var s=t("./zlib/deflate"),r=t("./utils/common"),o=t("./utils/strings"),a=t("./zlib/messages"),n=t("./zlib/zstream"),l=Object.prototype.toString;function h(t){if(!(this instanceof h))return new h(t);this.options=r.assign({level:-1,method:8,chunkSize:16384,windowBits:15,memLevel:8,strategy:0,to:""},t||{});var e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new n,this.strm.avail_out=0;var i=s.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(0!==i)throw new Error(a[i]);if(e.header&&s.deflateSetHeader(this.strm,e.header),e.dictionary){var c;if(c="string"==typeof e.dictionary?o.string2buf(e.dictionary):"[object ArrayBuffer]"===l.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,0!==(i=s.deflateSetDictionary(this.strm,c)))throw new Error(a[i]);this._dict_set=!0}}function c(t,e){var i=new h(e);if(i.push(t,!0),i.err)throw i.msg||a[i.err];return i.result}h.prototype.push=function(t,e){var i,a,n=this.strm,h=this.options.chunkSize;if(this.ended)return!1;a=e===~~e?e:!0===e?4:0,"string"==typeof t?n.input=o.string2buf(t):"[object ArrayBuffer]"===l.call(t)?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;do{if(0===n.avail_out&&(n.output=new r.Buf8(h),n.next_out=0,n.avail_out=h),1!==(i=s.deflate(n,a))&&0!==i)return this.onEnd(i),this.ended=!0,!1;0!==n.avail_out&&(0!==n.avail_in||4!==a&&2!==a)||("string"===this.options.to?this.onData(o.buf2binstring(r.shrinkBuf(n.output,n.next_out))):this.onData(r.shrinkBuf(n.output,n.next_out)))}while((n.avail_in>0||0===n.avail_out)&&1!==i);return 4===a?(i=s.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,0===i):2!==a||(this.onEnd(0),n.avail_out=0,!0)},h.prototype.onData=function(t){this.chunks.push(t)},h.prototype.onEnd=function(t){0===t&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},i.Deflate=h,i.deflate=c,i.deflateRaw=function(t,e){return(e=e||{}).raw=!0,c(t,e)},i.gzip=function(t,e){return(e=e||{}).gzip=!0,c(t,e)}},{"./utils/common":3,"./utils/strings":4,"./zlib/deflate":8,"./zlib/messages":13,"./zlib/zstream":15}],2:[function(t,e,i){var s=t("./zlib/inflate"),r=t("./utils/common"),o=t("./utils/strings"),a=t("./zlib/constants"),n=t("./zlib/messages"),l=t("./zlib/zstream"),h=t("./zlib/gzheader"),c=Object.prototype.toString;function u(t){if(!(this instanceof u))return new u(t);this.options=r.assign({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&0==(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var i=s.inflateInit2(this.strm,e.windowBits);if(i!==a.Z_OK)throw new Error(n[i]);if(this.header=new h,s.inflateGetHeader(this.strm,this.header),e.dictionary&&("string"==typeof e.dictionary?e.dictionary=o.string2buf(e.dictionary):"[object ArrayBuffer]"===c.call(e.dictionary)&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(i=s.inflateSetDictionary(this.strm,e.dictionary))!==a.Z_OK))throw new Error(n[i])}function d(t,e){var i=new u(e);if(i.push(t,!0),i.err)throw i.msg||n[i.err];return i.result}u.prototype.push=function(t,e){var i,n,l,h,u,d=this.strm,p=this.options.chunkSize,_=this.options.dictionary,f=!1;if(this.ended)return!1;n=e===~~e?e:!0===e?a.Z_FINISH:a.Z_NO_FLUSH,"string"==typeof t?d.input=o.binstring2buf(t):"[object ArrayBuffer]"===c.call(t)?d.input=new Uint8Array(t):d.input=t,d.next_in=0,d.avail_in=d.input.length;do{if(0===d.avail_out&&(d.output=new r.Buf8(p),d.next_out=0,d.avail_out=p),(i=s.inflate(d,a.Z_NO_FLUSH))===a.Z_NEED_DICT&&_&&(i=s.inflateSetDictionary(this.strm,_)),i===a.Z_BUF_ERROR&&!0===f&&(i=a.Z_OK,f=!1),i!==a.Z_STREAM_END&&i!==a.Z_OK)return this.onEnd(i),this.ended=!0,!1;d.next_out&&(0!==d.avail_out&&i!==a.Z_STREAM_END&&(0!==d.avail_in||n!==a.Z_FINISH&&n!==a.Z_SYNC_FLUSH)||("string"===this.options.to?(l=o.utf8border(d.output,d.next_out),h=d.next_out-l,u=o.buf2string(d.output,l),d.next_out=h,d.avail_out=p-h,h&&r.arraySet(d.output,d.output,l,h,0),this.onData(u)):this.onData(r.shrinkBuf(d.output,d.next_out)))),0===d.avail_in&&0===d.avail_out&&(f=!0)}while((d.avail_in>0||0===d.avail_out)&&i!==a.Z_STREAM_END);return i===a.Z_STREAM_END&&(n=a.Z_FINISH),n===a.Z_FINISH?(i=s.inflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===a.Z_OK):n!==a.Z_SYNC_FLUSH||(this.onEnd(a.Z_OK),d.avail_out=0,!0)},u.prototype.onData=function(t){this.chunks.push(t)},u.prototype.onEnd=function(t){t===a.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=r.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg},i.Inflate=u,i.inflate=d,i.inflateRaw=function(t,e){return(e=e||{}).raw=!0,d(t,e)},i.ungzip=d},{"./utils/common":3,"./utils/strings":4,"./zlib/constants":6,"./zlib/gzheader":9,"./zlib/inflate":11,"./zlib/messages":13,"./zlib/zstream":15}],3:[function(t,e,i){var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function r(t,e){return Object.prototype.hasOwnProperty.call(t,e)}i.assign=function(t){for(var e=Array.prototype.slice.call(arguments,1);e.length;){var i=e.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(var s in i)r(i,s)&&(t[s]=i[s])}}return t},i.shrinkBuf=function(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t)};var o={arraySet:function(t,e,i,s,r){if(e.subarray&&t.subarray)t.set(e.subarray(i,i+s),r);else for(var o=0;o<s;o++)t[r+o]=e[i+o]},flattenChunks:function(t){var e,i,s,r,o,a;for(s=0,e=0,i=t.length;e<i;e++)s+=t[e].length;for(a=new Uint8Array(s),r=0,e=0,i=t.length;e<i;e++)o=t[e],a.set(o,r),r+=o.length;return a}},a={arraySet:function(t,e,i,s,r){for(var o=0;o<s;o++)t[r+o]=e[i+o]},flattenChunks:function(t){return[].concat.apply([],t)}};i.setTyped=function(t){t?(i.Buf8=Uint8Array,i.Buf16=Uint16Array,i.Buf32=Int32Array,i.assign(i,o)):(i.Buf8=Array,i.Buf16=Array,i.Buf32=Array,i.assign(i,a))},i.setTyped(s)},{}],4:[function(t,e,i){var s=t("./common"),r=!0,o=!0;try{String.fromCharCode.apply(null,[0])}catch(t){r=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(t){o=!1}for(var a=new s.Buf8(256),n=0;n<256;n++)a[n]=n>=252?6:n>=248?5:n>=240?4:n>=224?3:n>=192?2:1;function l(t,e){if(e<65534&&(t.subarray&&o||!t.subarray&&r))return String.fromCharCode.apply(null,s.shrinkBuf(t,e));for(var i="",a=0;a<e;a++)i+=String.fromCharCode(t[a]);return i}a[254]=a[254]=1,i.string2buf=function(t){var e,i,r,o,a,n=t.length,l=0;for(o=0;o<n;o++)55296==(64512&(i=t.charCodeAt(o)))&&o+1<n&&56320==(64512&(r=t.charCodeAt(o+1)))&&(i=65536+(i-55296<<10)+(r-56320),o++),l+=i<128?1:i<2048?2:i<65536?3:4;for(e=new s.Buf8(l),a=0,o=0;a<l;o++)55296==(64512&(i=t.charCodeAt(o)))&&o+1<n&&56320==(64512&(r=t.charCodeAt(o+1)))&&(i=65536+(i-55296<<10)+(r-56320),o++),i<128?e[a++]=i:i<2048?(e[a++]=192|i>>>6,e[a++]=128|63&i):i<65536?(e[a++]=224|i>>>12,e[a++]=128|i>>>6&63,e[a++]=128|63&i):(e[a++]=240|i>>>18,e[a++]=128|i>>>12&63,e[a++]=128|i>>>6&63,e[a++]=128|63&i);return e},i.buf2binstring=function(t){return l(t,t.length)},i.binstring2buf=function(t){for(var e=new s.Buf8(t.length),i=0,r=e.length;i<r;i++)e[i]=t.charCodeAt(i);return e},i.buf2string=function(t,e){var i,s,r,o,n=e||t.length,h=new Array(2*n);for(s=0,i=0;i<n;)if((r=t[i++])<128)h[s++]=r;else if((o=a[r])>4)h[s++]=65533,i+=o-1;else{for(r&=2===o?31:3===o?15:7;o>1&&i<n;)r=r<<6|63&t[i++],o--;o>1?h[s++]=65533:r<65536?h[s++]=r:(r-=65536,h[s++]=55296|r>>10&1023,h[s++]=56320|1023&r)}return l(h,s)},i.utf8border=function(t,e){var i;for((e=e||t.length)>t.length&&(e=t.length),i=e-1;i>=0&&128==(192&t[i]);)i--;return i<0||0===i?e:i+a[t[i]]>e?i:e}},{"./common":3}],5:[function(t,e,i){e.exports=function(t,e,i,s){for(var r=65535&t|0,o=t>>>16&65535|0,a=0;0!==i;){i-=a=i>2e3?2e3:i;do{o=o+(r=r+e[s++]|0)|0}while(--a);r%=65521,o%=65521}return r|o<<16|0}},{}],6:[function(t,e,i){e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],7:[function(t,e,i){var s=function(){for(var t,e=[],i=0;i<256;i++){t=i;for(var s=0;s<8;s++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e}();e.exports=function(t,e,i,r){var o=s,a=r+i;t^=-1;for(var n=r;n<a;n++)t=t>>>8^o[255&(t^e[n])];return-1^t}},{}],8:[function(t,e,i){var s,r=t("../utils/common"),o=t("./trees"),a=t("./adler32"),n=t("./crc32"),l=t("./messages"),h=-2,c=258,u=262,d=103,p=113,_=666;function f(t,e){return t.msg=l[e],e}function g(t){return(t<<1)-(t>4?9:0)}function m(t){for(var e=t.length;--e>=0;)t[e]=0}function v(t){var e=t.state,i=e.pending;i>t.avail_out&&(i=t.avail_out),0!==i&&(r.arraySet(t.output,e.pending_buf,e.pending_out,i,t.next_out),t.next_out+=i,e.pending_out+=i,t.total_out+=i,t.avail_out-=i,e.pending-=i,0===e.pending&&(e.pending_out=0))}function b(t,e){o._tr_flush_block(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,v(t.strm)}function P(t,e){t.pending_buf[t.pending++]=e}function y(t,e){t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e}function M(t,e){var i,s,r=t.max_chain_length,o=t.strstart,a=t.prev_length,n=t.nice_match,l=t.strstart>t.w_size-u?t.strstart-(t.w_size-u):0,h=t.window,d=t.w_mask,p=t.prev,_=t.strstart+c,f=h[o+a-1],g=h[o+a];t.prev_length>=t.good_match&&(r>>=2),n>t.lookahead&&(n=t.lookahead);do{if(h[(i=e)+a]===g&&h[i+a-1]===f&&h[i]===h[o]&&h[++i]===h[o+1]){o+=2,i++;do{}while(h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&h[++o]===h[++i]&&o<_);if(s=c-(_-o),o=_-c,s>a){if(t.match_start=e,a=s,s>=n)break;f=h[o+a-1],g=h[o+a]}}}while((e=p[e&d])>l&&0!=--r);return a<=t.lookahead?a:t.lookahead}function x(t){var e,i,s,o,l,h,c,d,p,_,f=t.w_size;do{if(o=t.window_size-t.lookahead-t.strstart,t.strstart>=f+(f-u)){r.arraySet(t.window,t.window,f,f,0),t.match_start-=f,t.strstart-=f,t.block_start-=f,e=i=t.hash_size;do{s=t.head[--e],t.head[e]=s>=f?s-f:0}while(--i);e=i=f;do{s=t.prev[--e],t.prev[e]=s>=f?s-f:0}while(--i);o+=f}if(0===t.strm.avail_in)break;if(h=t.strm,c=t.window,d=t.strstart+t.lookahead,p=o,_=void 0,(_=h.avail_in)>p&&(_=p),i=0===_?0:(h.avail_in-=_,r.arraySet(c,h.input,h.next_in,_,d),1===h.state.wrap?h.adler=a(h.adler,c,_,d):2===h.state.wrap&&(h.adler=n(h.adler,c,_,d)),h.next_in+=_,h.total_in+=_,_),t.lookahead+=i,t.lookahead+t.insert>=3)for(l=t.strstart-t.insert,t.ins_h=t.window[l],t.ins_h=(t.ins_h<<t.hash_shift^t.window[l+1])&t.hash_mask;t.insert&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[l+3-1])&t.hash_mask,t.prev[l&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=l,l++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<u&&0!==t.strm.avail_in)}function w(t,e){for(var i,s;;){if(t.lookahead<u){if(x(t),t.lookahead<u&&0===e)return 1;if(0===t.lookahead)break}if(i=0,t.lookahead>=3&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==i&&t.strstart-i<=t.w_size-u&&(t.match_length=M(t,i)),t.match_length>=3)if(s=o._tr_tally(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do{t.strstart++,t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!=--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+1])&t.hash_mask;else s=o._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(s&&(b(t,!1),0===t.strm.avail_out))return 1}return t.insert=t.strstart<2?t.strstart:2,4===e?(b(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(b(t,!1),0===t.strm.avail_out)?1:2}function E(t,e){for(var i,s,r;;){if(t.lookahead<u){if(x(t),t.lookahead<u&&0===e)return 1;if(0===t.lookahead)break}if(i=0,t.lookahead>=3&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,0!==i&&t.prev_length<t.max_lazy_match&&t.strstart-i<=t.w_size-u&&(t.match_length=M(t,i),t.match_length<=5&&(1===t.strategy||3===t.match_length&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){r=t.strstart+t.lookahead-3,s=o._tr_tally(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=r&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+3-1])&t.hash_mask,i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!=--t.prev_length);if(t.match_available=0,t.match_length=2,t.strstart++,s&&(b(t,!1),0===t.strm.avail_out))return 1}else if(t.match_available){if((s=o._tr_tally(t,0,t.window[t.strstart-1]))&&b(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(s=o._tr_tally(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,4===e?(b(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(b(t,!1),0===t.strm.avail_out)?1:2}function A(t,e,i,s,r){this.good_length=t,this.max_lazy=e,this.nice_length=i,this.max_chain=s,this.func=r}function C(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=8,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new r.Buf16(1146),this.dyn_dtree=new r.Buf16(122),this.bl_tree=new r.Buf16(78),m(this.dyn_ltree),m(this.dyn_dtree),m(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new r.Buf16(16),this.heap=new r.Buf16(573),m(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new r.Buf16(573),m(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function S(t){var e;return t&&t.state?(t.total_in=t.total_out=0,t.data_type=2,(e=t.state).pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?42:p,t.adler=2===e.wrap?0:1,e.last_flush=0,o._tr_init(e),0):f(t,h)}function D(t){var e,i=S(t);return 0===i&&((e=t.state).window_size=2*e.w_size,m(e.head),e.max_lazy_match=s[e.level].max_lazy,e.good_match=s[e.level].good_length,e.nice_match=s[e.level].nice_length,e.max_chain_length=s[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=2,e.match_available=0,e.ins_h=0),i}function L(t,e,i,s,o,a){if(!t)return h;var n=1;if(-1===e&&(e=6),s<0?(n=0,s=-s):s>15&&(n=2,s-=16),o<1||o>9||8!==i||s<8||s>15||e<0||e>9||a<0||a>4)return f(t,h);8===s&&(s=9);var l=new C;return t.state=l,l.strm=t,l.wrap=n,l.gzhead=null,l.w_bits=s,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=o+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+3-1)/3),l.window=new r.Buf8(2*l.w_size),l.head=new r.Buf16(l.hash_size),l.prev=new r.Buf16(l.w_size),l.lit_bufsize=1<<o+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new r.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=e,l.strategy=a,l.method=i,D(t)}s=[new A(0,0,0,0,(function(t,e){var i=65535;for(i>t.pending_buf_size-5&&(i=t.pending_buf_size-5);;){if(t.lookahead<=1){if(x(t),0===t.lookahead&&0===e)return 1;if(0===t.lookahead)break}t.strstart+=t.lookahead,t.lookahead=0;var s=t.block_start+i;if((0===t.strstart||t.strstart>=s)&&(t.lookahead=t.strstart-s,t.strstart=s,b(t,!1),0===t.strm.avail_out))return 1;if(t.strstart-t.block_start>=t.w_size-u&&(b(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,4===e?(b(t,!0),0===t.strm.avail_out?3:4):(t.strstart>t.block_start&&(b(t,!1),t.strm.avail_out),1)})),new A(4,4,8,4,w),new A(4,5,16,8,w),new A(4,6,32,32,w),new A(4,4,16,16,E),new A(8,16,32,32,E),new A(8,16,128,128,E),new A(8,32,128,256,E),new A(32,128,258,1024,E),new A(32,258,258,4096,E)],i.deflateInit=function(t,e){return L(t,e,8,15,8,0)},i.deflateInit2=L,i.deflateReset=D,i.deflateResetKeep=S,i.deflateSetHeader=function(t,e){return t&&t.state?2!==t.state.wrap?h:(t.state.gzhead=e,0):h},i.deflate=function(t,e){var i,r,a,l;if(!t||!t.state||e>5||e<0)return t?f(t,h):h;if(r=t.state,!t.output||!t.input&&0!==t.avail_in||r.status===_&&4!==e)return f(t,0===t.avail_out?-5:h);if(r.strm=t,i=r.last_flush,r.last_flush=e,42===r.status)if(2===r.wrap)t.adler=0,P(r,31),P(r,139),P(r,8),r.gzhead?(P(r,(r.gzhead.text?1:0)+(r.gzhead.hcrc?2:0)+(r.gzhead.extra?4:0)+(r.gzhead.name?8:0)+(r.gzhead.comment?16:0)),P(r,255&r.gzhead.time),P(r,r.gzhead.time>>8&255),P(r,r.gzhead.time>>16&255),P(r,r.gzhead.time>>24&255),P(r,9===r.level?2:r.strategy>=2||r.level<2?4:0),P(r,255&r.gzhead.os),r.gzhead.extra&&r.gzhead.extra.length&&(P(r,255&r.gzhead.extra.length),P(r,r.gzhead.extra.length>>8&255)),r.gzhead.hcrc&&(t.adler=n(t.adler,r.pending_buf,r.pending,0)),r.gzindex=0,r.status=69):(P(r,0),P(r,0),P(r,0),P(r,0),P(r,0),P(r,9===r.level?2:r.strategy>=2||r.level<2?4:0),P(r,3),r.status=p);else{var u=8+(r.w_bits-8<<4)<<8;u|=(r.strategy>=2||r.level<2?0:r.level<6?1:6===r.level?2:3)<<6,0!==r.strstart&&(u|=32),u+=31-u%31,r.status=p,y(r,u),0!==r.strstart&&(y(r,t.adler>>>16),y(r,65535&t.adler)),t.adler=1}if(69===r.status)if(r.gzhead.extra){for(a=r.pending;r.gzindex<(65535&r.gzhead.extra.length)&&(r.pending!==r.pending_buf_size||(r.gzhead.hcrc&&r.pending>a&&(t.adler=n(t.adler,r.pending_buf,r.pending-a,a)),v(t),a=r.pending,r.pending!==r.pending_buf_size));)P(r,255&r.gzhead.extra[r.gzindex]),r.gzindex++;r.gzhead.hcrc&&r.pending>a&&(t.adler=n(t.adler,r.pending_buf,r.pending-a,a)),r.gzindex===r.gzhead.extra.length&&(r.gzindex=0,r.status=73)}else r.status=73;if(73===r.status)if(r.gzhead.name){a=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>a&&(t.adler=n(t.adler,r.pending_buf,r.pending-a,a)),v(t),a=r.pending,r.pending===r.pending_buf_size)){l=1;break}l=r.gzindex<r.gzhead.name.length?255&r.gzhead.name.charCodeAt(r.gzindex++):0,P(r,l)}while(0!==l);r.gzhead.hcrc&&r.pending>a&&(t.adler=n(t.adler,r.pending_buf,r.pending-a,a)),0===l&&(r.gzindex=0,r.status=91)}else r.status=91;if(91===r.status)if(r.gzhead.comment){a=r.pending;do{if(r.pending===r.pending_buf_size&&(r.gzhead.hcrc&&r.pending>a&&(t.adler=n(t.adler,r.pending_buf,r.pending-a,a)),v(t),a=r.pending,r.pending===r.pending_buf_size)){l=1;break}l=r.gzindex<r.gzhead.comment.length?255&r.gzhead.comment.charCodeAt(r.gzindex++):0,P(r,l)}while(0!==l);r.gzhead.hcrc&&r.pending>a&&(t.adler=n(t.adler,r.pending_buf,r.pending-a,a)),0===l&&(r.status=d)}else r.status=d;if(r.status===d&&(r.gzhead.hcrc?(r.pending+2>r.pending_buf_size&&v(t),r.pending+2<=r.pending_buf_size&&(P(r,255&t.adler),P(r,t.adler>>8&255),t.adler=0,r.status=p)):r.status=p),0!==r.pending){if(v(t),0===t.avail_out)return r.last_flush=-1,0}else if(0===t.avail_in&&g(e)<=g(i)&&4!==e)return f(t,-5);if(r.status===_&&0!==t.avail_in)return f(t,-5);if(0!==t.avail_in||0!==r.lookahead||0!==e&&r.status!==_){var M=2===r.strategy?function(t,e){for(var i;;){if(0===t.lookahead&&(x(t),0===t.lookahead)){if(0===e)return 1;break}if(t.match_length=0,i=o._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,i&&(b(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,4===e?(b(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(b(t,!1),0===t.strm.avail_out)?1:2}(r,e):3===r.strategy?function(t,e){for(var i,s,r,a,n=t.window;;){if(t.lookahead<=c){if(x(t),t.lookahead<=c&&0===e)return 1;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=3&&t.strstart>0&&(s=n[r=t.strstart-1])===n[++r]&&s===n[++r]&&s===n[++r]){a=t.strstart+c;do{}while(s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&s===n[++r]&&r<a);t.match_length=c-(a-r),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=3?(i=o._tr_tally(t,1,t.match_length-3),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(i=o._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),i&&(b(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,4===e?(b(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(b(t,!1),0===t.strm.avail_out)?1:2}(r,e):s[r.level].func(r,e);if(3!==M&&4!==M||(r.status=_),1===M||3===M)return 0===t.avail_out&&(r.last_flush=-1),0;if(2===M&&(1===e?o._tr_align(r):5!==e&&(o._tr_stored_block(r,0,0,!1),3===e&&(m(r.head),0===r.lookahead&&(r.strstart=0,r.block_start=0,r.insert=0))),v(t),0===t.avail_out))return r.last_flush=-1,0}return 4!==e?0:r.wrap<=0?1:(2===r.wrap?(P(r,255&t.adler),P(r,t.adler>>8&255),P(r,t.adler>>16&255),P(r,t.adler>>24&255),P(r,255&t.total_in),P(r,t.total_in>>8&255),P(r,t.total_in>>16&255),P(r,t.total_in>>24&255)):(y(r,t.adler>>>16),y(r,65535&t.adler)),v(t),r.wrap>0&&(r.wrap=-r.wrap),0!==r.pending?0:1)},i.deflateEnd=function(t){var e;return t&&t.state?42!==(e=t.state.status)&&69!==e&&73!==e&&91!==e&&e!==d&&e!==p&&e!==_?f(t,h):(t.state=null,e===p?f(t,-3):0):h},i.deflateSetDictionary=function(t,e){var i,s,o,n,l,c,u,d,p=e.length;if(!t||!t.state)return h;if(2===(n=(i=t.state).wrap)||1===n&&42!==i.status||i.lookahead)return h;for(1===n&&(t.adler=a(t.adler,e,p,0)),i.wrap=0,p>=i.w_size&&(0===n&&(m(i.head),i.strstart=0,i.block_start=0,i.insert=0),d=new r.Buf8(i.w_size),r.arraySet(d,e,p-i.w_size,i.w_size,0),e=d,p=i.w_size),l=t.avail_in,c=t.next_in,u=t.input,t.avail_in=p,t.next_in=0,t.input=e,x(i);i.lookahead>=3;){s=i.strstart,o=i.lookahead-2;do{i.ins_h=(i.ins_h<<i.hash_shift^i.window[s+3-1])&i.hash_mask,i.prev[s&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=s,s++}while(--o);i.strstart=s,i.lookahead=2,x(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,t.next_in=c,t.input=u,t.avail_in=l,i.wrap=n,0},i.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./messages":13,"./trees":14}],9:[function(t,e,i){e.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],10:[function(t,e,i){e.exports=function(t,e){var i,s,r,o,a,n,l,h,c,u,d,p,_,f,g,m,v,b,P,y,M,x,w,E,A;i=t.state,s=t.next_in,E=t.input,r=s+(t.avail_in-5),o=t.next_out,A=t.output,a=o-(e-t.avail_out),n=o+(t.avail_out-257),l=i.dmax,h=i.wsize,c=i.whave,u=i.wnext,d=i.window,p=i.hold,_=i.bits,f=i.lencode,g=i.distcode,m=(1<<i.lenbits)-1,v=(1<<i.distbits)-1;t:do{_<15&&(p+=E[s++]<<_,_+=8,p+=E[s++]<<_,_+=8),b=f[p&m];e:for(;;){if(p>>>=P=b>>>24,_-=P,0===(P=b>>>16&255))A[o++]=65535&b;else{if(!(16&P)){if(0==(64&P)){b=f[(65535&b)+(p&(1<<P)-1)];continue e}if(32&P){i.mode=12;break t}t.msg="invalid literal/length code",i.mode=30;break t}y=65535&b,(P&=15)&&(_<P&&(p+=E[s++]<<_,_+=8),y+=p&(1<<P)-1,p>>>=P,_-=P),_<15&&(p+=E[s++]<<_,_+=8,p+=E[s++]<<_,_+=8),b=g[p&v];i:for(;;){if(p>>>=P=b>>>24,_-=P,!(16&(P=b>>>16&255))){if(0==(64&P)){b=g[(65535&b)+(p&(1<<P)-1)];continue i}t.msg="invalid distance code",i.mode=30;break t}if(M=65535&b,_<(P&=15)&&(p+=E[s++]<<_,(_+=8)<P&&(p+=E[s++]<<_,_+=8)),(M+=p&(1<<P)-1)>l){t.msg="invalid distance too far back",i.mode=30;break t}if(p>>>=P,_-=P,M>(P=o-a)){if((P=M-P)>c&&i.sane){t.msg="invalid distance too far back",i.mode=30;break t}if(x=0,w=d,0===u){if(x+=h-P,P<y){y-=P;do{A[o++]=d[x++]}while(--P);x=o-M,w=A}}else if(u<P){if(x+=h+u-P,(P-=u)<y){y-=P;do{A[o++]=d[x++]}while(--P);if(x=0,u<y){y-=P=u;do{A[o++]=d[x++]}while(--P);x=o-M,w=A}}}else if(x+=u-P,P<y){y-=P;do{A[o++]=d[x++]}while(--P);x=o-M,w=A}for(;y>2;)A[o++]=w[x++],A[o++]=w[x++],A[o++]=w[x++],y-=3;y&&(A[o++]=w[x++],y>1&&(A[o++]=w[x++]))}else{x=o-M;do{A[o++]=A[x++],A[o++]=A[x++],A[o++]=A[x++],y-=3}while(y>2);y&&(A[o++]=A[x++],y>1&&(A[o++]=A[x++]))}break}}break}}while(s<r&&o<n);s-=y=_>>3,p&=(1<<(_-=y<<3))-1,t.next_in=s,t.next_out=o,t.avail_in=s<r?r-s+5:5-(s-r),t.avail_out=o<n?n-o+257:257-(o-n),i.hold=p,i.bits=_}},{}],11:[function(t,e,i){var s=t("../utils/common"),r=t("./adler32"),o=t("./crc32"),a=t("./inffast"),n=t("./inftrees"),l=-2,h=12,c=30;function u(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24)}function d(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new s.Buf16(320),this.work=new s.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function p(t){var e;return t&&t.state?(e=t.state,t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=1,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new s.Buf32(852),e.distcode=e.distdyn=new s.Buf32(592),e.sane=1,e.back=-1,0):l}function _(t){var e;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,p(t)):l}function f(t,e){var i,s;return t&&t.state?(s=t.state,e<0?(i=0,e=-e):(i=1+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?l:(null!==s.window&&s.wbits!==e&&(s.window=null),s.wrap=i,s.wbits=e,_(t))):l}function g(t,e){var i,s;return t?(s=new d,t.state=s,s.window=null,0!==(i=f(t,e))&&(t.state=null),i):l}var m,v,b=!0;function P(t){if(b){var e;for(m=new s.Buf32(512),v=new s.Buf32(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(n(1,t.lens,0,288,m,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;n(2,t.lens,0,32,v,0,t.work,{bits:5}),b=!1}t.lencode=m,t.lenbits=9,t.distcode=v,t.distbits=5}function y(t,e,i,r){var o,a=t.state;return null===a.window&&(a.wsize=1<<a.wbits,a.wnext=0,a.whave=0,a.window=new s.Buf8(a.wsize)),r>=a.wsize?(s.arraySet(a.window,e,i-a.wsize,a.wsize,0),a.wnext=0,a.whave=a.wsize):((o=a.wsize-a.wnext)>r&&(o=r),s.arraySet(a.window,e,i-r,o,a.wnext),(r-=o)?(s.arraySet(a.window,e,i-r,r,0),a.wnext=r,a.whave=a.wsize):(a.wnext+=o,a.wnext===a.wsize&&(a.wnext=0),a.whave<a.wsize&&(a.whave+=o))),0}i.inflateReset=_,i.inflateReset2=f,i.inflateResetKeep=p,i.inflateInit=function(t){return g(t,15)},i.inflateInit2=g,i.inflate=function(t,e){var i,d,p,_,f,g,m,v,b,M,x,w,E,A,C,S,D,L,B,R,T,F,N,I,k=0,O=new s.Buf8(4),V=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return l;(i=t.state).mode===h&&(i.mode=13),f=t.next_out,p=t.output,m=t.avail_out,_=t.next_in,d=t.input,g=t.avail_in,v=i.hold,b=i.bits,M=g,x=m,F=0;t:for(;;)switch(i.mode){case 1:if(0===i.wrap){i.mode=13;break}for(;b<16;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}if(2&i.wrap&&35615===v){i.check=0,O[0]=255&v,O[1]=v>>>8&255,i.check=o(i.check,O,2,0),v=0,b=0,i.mode=2;break}if(i.flags=0,i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&v)<<8)+(v>>8))%31){t.msg="incorrect header check",i.mode=c;break}if(8!=(15&v)){t.msg="unknown compression method",i.mode=c;break}if(b-=4,T=8+(15&(v>>>=4)),0===i.wbits)i.wbits=T;else if(T>i.wbits){t.msg="invalid window size",i.mode=c;break}i.dmax=1<<T,t.adler=i.check=1,i.mode=512&v?10:h,v=0,b=0;break;case 2:for(;b<16;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}if(i.flags=v,8!=(255&i.flags)){t.msg="unknown compression method",i.mode=c;break}if(57344&i.flags){t.msg="unknown header flags set",i.mode=c;break}i.head&&(i.head.text=v>>8&1),512&i.flags&&(O[0]=255&v,O[1]=v>>>8&255,i.check=o(i.check,O,2,0)),v=0,b=0,i.mode=3;case 3:for(;b<32;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}i.head&&(i.head.time=v),512&i.flags&&(O[0]=255&v,O[1]=v>>>8&255,O[2]=v>>>16&255,O[3]=v>>>24&255,i.check=o(i.check,O,4,0)),v=0,b=0,i.mode=4;case 4:for(;b<16;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}i.head&&(i.head.xflags=255&v,i.head.os=v>>8),512&i.flags&&(O[0]=255&v,O[1]=v>>>8&255,i.check=o(i.check,O,2,0)),v=0,b=0,i.mode=5;case 5:if(1024&i.flags){for(;b<16;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}i.length=v,i.head&&(i.head.extra_len=v),512&i.flags&&(O[0]=255&v,O[1]=v>>>8&255,i.check=o(i.check,O,2,0)),v=0,b=0}else i.head&&(i.head.extra=null);i.mode=6;case 6:if(1024&i.flags&&((w=i.length)>g&&(w=g),w&&(i.head&&(T=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Array(i.head.extra_len)),s.arraySet(i.head.extra,d,_,w,T)),512&i.flags&&(i.check=o(i.check,d,w,_)),g-=w,_+=w,i.length-=w),i.length))break t;i.length=0,i.mode=7;case 7:if(2048&i.flags){if(0===g)break t;w=0;do{T=d[_+w++],i.head&&T&&i.length<65536&&(i.head.name+=String.fromCharCode(T))}while(T&&w<g);if(512&i.flags&&(i.check=o(i.check,d,w,_)),g-=w,_+=w,T)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=8;case 8:if(4096&i.flags){if(0===g)break t;w=0;do{T=d[_+w++],i.head&&T&&i.length<65536&&(i.head.comment+=String.fromCharCode(T))}while(T&&w<g);if(512&i.flags&&(i.check=o(i.check,d,w,_)),g-=w,_+=w,T)break t}else i.head&&(i.head.comment=null);i.mode=9;case 9:if(512&i.flags){for(;b<16;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}if(v!==(65535&i.check)){t.msg="header crc mismatch",i.mode=c;break}v=0,b=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),t.adler=i.check=0,i.mode=h;break;case 10:for(;b<32;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}t.adler=i.check=u(v),v=0,b=0,i.mode=11;case 11:if(0===i.havedict)return t.next_out=f,t.avail_out=m,t.next_in=_,t.avail_in=g,i.hold=v,i.bits=b,2;t.adler=i.check=1,i.mode=h;case h:if(5===e||6===e)break t;case 13:if(i.last){v>>>=7&b,b-=7&b,i.mode=27;break}for(;b<3;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}switch(i.last=1&v,b-=1,3&(v>>>=1)){case 0:i.mode=14;break;case 1:if(P(i),i.mode=20,6===e){v>>>=2,b-=2;break t}break;case 2:i.mode=17;break;case 3:t.msg="invalid block type",i.mode=c}v>>>=2,b-=2;break;case 14:for(v>>>=7&b,b-=7&b;b<32;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}if((65535&v)!=(v>>>16^65535)){t.msg="invalid stored block lengths",i.mode=c;break}if(i.length=65535&v,v=0,b=0,i.mode=15,6===e)break t;case 15:i.mode=16;case 16:if(w=i.length){if(w>g&&(w=g),w>m&&(w=m),0===w)break t;s.arraySet(p,d,_,w,f),g-=w,_+=w,m-=w,f+=w,i.length-=w;break}i.mode=h;break;case 17:for(;b<14;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}if(i.nlen=257+(31&v),v>>>=5,b-=5,i.ndist=1+(31&v),v>>>=5,b-=5,i.ncode=4+(15&v),v>>>=4,b-=4,i.nlen>286||i.ndist>30){t.msg="too many length or distance symbols",i.mode=c;break}i.have=0,i.mode=18;case 18:for(;i.have<i.ncode;){for(;b<3;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}i.lens[V[i.have++]]=7&v,v>>>=3,b-=3}for(;i.have<19;)i.lens[V[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,N={bits:i.lenbits},F=n(0,i.lens,0,19,i.lencode,0,i.work,N),i.lenbits=N.bits,F){t.msg="invalid code lengths set",i.mode=c;break}i.have=0,i.mode=19;case 19:for(;i.have<i.nlen+i.ndist;){for(;S=(k=i.lencode[v&(1<<i.lenbits)-1])>>>16&255,D=65535&k,!((C=k>>>24)<=b);){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}if(D<16)v>>>=C,b-=C,i.lens[i.have++]=D;else{if(16===D){for(I=C+2;b<I;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}if(v>>>=C,b-=C,0===i.have){t.msg="invalid bit length repeat",i.mode=c;break}T=i.lens[i.have-1],w=3+(3&v),v>>>=2,b-=2}else if(17===D){for(I=C+3;b<I;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}b-=C,T=0,w=3+(7&(v>>>=C)),v>>>=3,b-=3}else{for(I=C+7;b<I;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}b-=C,T=0,w=11+(127&(v>>>=C)),v>>>=7,b-=7}if(i.have+w>i.nlen+i.ndist){t.msg="invalid bit length repeat",i.mode=c;break}for(;w--;)i.lens[i.have++]=T}}if(i.mode===c)break;if(0===i.lens[256]){t.msg="invalid code -- missing end-of-block",i.mode=c;break}if(i.lenbits=9,N={bits:i.lenbits},F=n(1,i.lens,0,i.nlen,i.lencode,0,i.work,N),i.lenbits=N.bits,F){t.msg="invalid literal/lengths set",i.mode=c;break}if(i.distbits=6,i.distcode=i.distdyn,N={bits:i.distbits},F=n(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,N),i.distbits=N.bits,F){t.msg="invalid distances set",i.mode=c;break}if(i.mode=20,6===e)break t;case 20:i.mode=21;case 21:if(g>=6&&m>=258){t.next_out=f,t.avail_out=m,t.next_in=_,t.avail_in=g,i.hold=v,i.bits=b,a(t,x),f=t.next_out,p=t.output,m=t.avail_out,_=t.next_in,d=t.input,g=t.avail_in,v=i.hold,b=i.bits,i.mode===h&&(i.back=-1);break}for(i.back=0;S=(k=i.lencode[v&(1<<i.lenbits)-1])>>>16&255,D=65535&k,!((C=k>>>24)<=b);){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}if(S&&0==(240&S)){for(L=C,B=S,R=D;S=(k=i.lencode[R+((v&(1<<L+B)-1)>>L)])>>>16&255,D=65535&k,!(L+(C=k>>>24)<=b);){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}v>>>=L,b-=L,i.back+=L}if(v>>>=C,b-=C,i.back+=C,i.length=D,0===S){i.mode=26;break}if(32&S){i.back=-1,i.mode=h;break}if(64&S){t.msg="invalid literal/length code",i.mode=c;break}i.extra=15&S,i.mode=22;case 22:if(i.extra){for(I=i.extra;b<I;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}i.length+=v&(1<<i.extra)-1,v>>>=i.extra,b-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=23;case 23:for(;S=(k=i.distcode[v&(1<<i.distbits)-1])>>>16&255,D=65535&k,!((C=k>>>24)<=b);){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}if(0==(240&S)){for(L=C,B=S,R=D;S=(k=i.distcode[R+((v&(1<<L+B)-1)>>L)])>>>16&255,D=65535&k,!(L+(C=k>>>24)<=b);){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}v>>>=L,b-=L,i.back+=L}if(v>>>=C,b-=C,i.back+=C,64&S){t.msg="invalid distance code",i.mode=c;break}i.offset=D,i.extra=15&S,i.mode=24;case 24:if(i.extra){for(I=i.extra;b<I;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}i.offset+=v&(1<<i.extra)-1,v>>>=i.extra,b-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){t.msg="invalid distance too far back",i.mode=c;break}i.mode=25;case 25:if(0===m)break t;if(w=x-m,i.offset>w){if((w=i.offset-w)>i.whave&&i.sane){t.msg="invalid distance too far back",i.mode=c;break}w>i.wnext?(w-=i.wnext,E=i.wsize-w):E=i.wnext-w,w>i.length&&(w=i.length),A=i.window}else A=p,E=f-i.offset,w=i.length;w>m&&(w=m),m-=w,i.length-=w;do{p[f++]=A[E++]}while(--w);0===i.length&&(i.mode=21);break;case 26:if(0===m)break t;p[f++]=i.length,m--,i.mode=21;break;case 27:if(i.wrap){for(;b<32;){if(0===g)break t;g--,v|=d[_++]<<b,b+=8}if(x-=m,t.total_out+=x,i.total+=x,x&&(t.adler=i.check=i.flags?o(i.check,p,x,f-x):r(i.check,p,x,f-x)),x=m,(i.flags?v:u(v))!==i.check){t.msg="incorrect data check",i.mode=c;break}v=0,b=0}i.mode=28;case 28:if(i.wrap&&i.flags){for(;b<32;){if(0===g)break t;g--,v+=d[_++]<<b,b+=8}if(v!==(4294967295&i.total)){t.msg="incorrect length check",i.mode=c;break}v=0,b=0}i.mode=29;case 29:F=1;break t;case c:F=-3;break t;case 31:return-4;default:return l}return t.next_out=f,t.avail_out=m,t.next_in=_,t.avail_in=g,i.hold=v,i.bits=b,(i.wsize||x!==t.avail_out&&i.mode<c&&(i.mode<27||4!==e))&&y(t,t.output,t.next_out,x-t.avail_out),M-=t.avail_in,x-=t.avail_out,t.total_in+=M,t.total_out+=x,i.total+=x,i.wrap&&x&&(t.adler=i.check=i.flags?o(i.check,p,x,t.next_out-x):r(i.check,p,x,t.next_out-x)),t.data_type=i.bits+(i.last?64:0)+(i.mode===h?128:0)+(20===i.mode||15===i.mode?256:0),(0===M&&0===x||4===e)&&0===F&&(F=-5),F},i.inflateEnd=function(t){if(!t||!t.state)return l;var e=t.state;return e.window&&(e.window=null),t.state=null,0},i.inflateGetHeader=function(t,e){var i;return t&&t.state?0==(2&(i=t.state).wrap)?l:(i.head=e,e.done=!1,0):l},i.inflateSetDictionary=function(t,e){var i,s=e.length;return t&&t.state?0!==(i=t.state).wrap&&11!==i.mode?l:11===i.mode&&r(1,e,s,0)!==i.check?-3:y(t,e,s,s)?(i.mode=31,-4):(i.havedict=1,0):l},i.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":3,"./adler32":5,"./crc32":7,"./inffast":10,"./inftrees":12}],12:[function(t,e,i){var s=t("../utils/common"),r=15,o=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],a=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],n=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],l=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(t,e,i,h,c,u,d,p){var _,f,g,m,v,b,P,y,M,x=p.bits,w=0,E=0,A=0,C=0,S=0,D=0,L=0,B=0,R=0,T=0,F=null,N=0,I=new s.Buf16(16),k=new s.Buf16(16),O=null,V=0;for(w=0;w<=r;w++)I[w]=0;for(E=0;E<h;E++)I[e[i+E]]++;for(S=x,C=r;C>=1&&0===I[C];C--);if(S>C&&(S=C),0===C)return c[u++]=20971520,c[u++]=20971520,p.bits=1,0;for(A=1;A<C&&0===I[A];A++);for(S<A&&(S=A),B=1,w=1;w<=r;w++)if(B<<=1,(B-=I[w])<0)return-1;if(B>0&&(0===t||1!==C))return-1;for(k[1]=0,w=1;w<r;w++)k[w+1]=k[w]+I[w];for(E=0;E<h;E++)0!==e[i+E]&&(d[k[e[i+E]]++]=E);if(0===t?(F=O=d,b=19):1===t?(F=o,N-=257,O=a,V-=257,b=256):(F=n,O=l,b=-1),T=0,E=0,w=A,v=u,D=S,L=0,g=-1,m=(R=1<<S)-1,1===t&&R>852||2===t&&R>592)return 1;for(;;){P=w-L,d[E]<b?(y=0,M=d[E]):d[E]>b?(y=O[V+d[E]],M=F[N+d[E]]):(y=96,M=0),_=1<<w-L,A=f=1<<D;do{c[v+(T>>L)+(f-=_)]=P<<24|y<<16|M|0}while(0!==f);for(_=1<<w-1;T&_;)_>>=1;if(0!==_?(T&=_-1,T+=_):T=0,E++,0==--I[w]){if(w===C)break;w=e[i+d[E]]}if(w>S&&(T&m)!==g){for(0===L&&(L=S),v+=A,B=1<<(D=w-L);D+L<C&&!((B-=I[D+L])<=0);)D++,B<<=1;if(R+=1<<D,1===t&&R>852||2===t&&R>592)return 1;c[g=T&m]=S<<24|D<<16|v-u|0}}return 0!==T&&(c[v+T]=w-L<<24|64<<16|0),p.bits=S,0}},{"../utils/common":3}],13:[function(t,e,i){e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],14:[function(t,e,i){var s=t("../utils/common");function r(t){for(var e=t.length;--e>=0;)t[e]=0}var o=256,a=286,n=30,l=15,h=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],c=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],d=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],p=new Array(576);r(p);var _=new Array(60);r(_);var f=new Array(512);r(f);var g=new Array(256);r(g);var m=new Array(29);r(m);var v,b,P,y=new Array(n);function M(t,e,i,s,r){this.static_tree=t,this.extra_bits=e,this.extra_base=i,this.elems=s,this.max_length=r,this.has_stree=t&&t.length}function x(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}function w(t){return t<256?f[t]:f[256+(t>>>7)]}function E(t,e){t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255}function A(t,e,i){t.bi_valid>16-i?(t.bi_buf|=e<<t.bi_valid&65535,E(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=i-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=i)}function C(t,e,i){A(t,i[2*e],i[2*e+1])}function S(t,e){var i=0;do{i|=1&t,t>>>=1,i<<=1}while(--e>0);return i>>>1}function D(t,e,i){var s,r,o=new Array(16),a=0;for(s=1;s<=l;s++)o[s]=a=a+i[s-1]<<1;for(r=0;r<=e;r++){var n=t[2*r+1];0!==n&&(t[2*r]=S(o[n]++,n))}}function L(t){var e;for(e=0;e<a;e++)t.dyn_ltree[2*e]=0;for(e=0;e<n;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0}function B(t){t.bi_valid>8?E(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0}function R(t,e,i,s){var r=2*e,o=2*i;return t[r]<t[o]||t[r]===t[o]&&s[e]<=s[i]}function T(t,e,i){for(var s=t.heap[i],r=i<<1;r<=t.heap_len&&(r<t.heap_len&&R(e,t.heap[r+1],t.heap[r],t.depth)&&r++,!R(e,s,t.heap[r],t.depth));)t.heap[i]=t.heap[r],i=r,r<<=1;t.heap[i]=s}function F(t,e,i){var s,r,a,n,l=0;if(0!==t.last_lit)do{s=t.pending_buf[t.d_buf+2*l]<<8|t.pending_buf[t.d_buf+2*l+1],r=t.pending_buf[t.l_buf+l],l++,0===s?C(t,r,e):(C(t,(a=g[r])+o+1,e),0!==(n=h[a])&&A(t,r-=m[a],n),C(t,a=w(--s),i),0!==(n=c[a])&&A(t,s-=y[a],n))}while(l<t.last_lit);C(t,256,e)}function N(t,e){var i,s,r,o=e.dyn_tree,a=e.stat_desc.static_tree,n=e.stat_desc.has_stree,h=e.stat_desc.elems,c=-1;for(t.heap_len=0,t.heap_max=573,i=0;i<h;i++)0!==o[2*i]?(t.heap[++t.heap_len]=c=i,t.depth[i]=0):o[2*i+1]=0;for(;t.heap_len<2;)o[2*(r=t.heap[++t.heap_len]=c<2?++c:0)]=1,t.depth[r]=0,t.opt_len--,n&&(t.static_len-=a[2*r+1]);for(e.max_code=c,i=t.heap_len>>1;i>=1;i--)T(t,o,i);r=h;do{i=t.heap[1],t.heap[1]=t.heap[t.heap_len--],T(t,o,1),s=t.heap[1],t.heap[--t.heap_max]=i,t.heap[--t.heap_max]=s,o[2*r]=o[2*i]+o[2*s],t.depth[r]=(t.depth[i]>=t.depth[s]?t.depth[i]:t.depth[s])+1,o[2*i+1]=o[2*s+1]=r,t.heap[1]=r++,T(t,o,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],function(t,e){var i,s,r,o,a,n,h=e.dyn_tree,c=e.max_code,u=e.stat_desc.static_tree,d=e.stat_desc.has_stree,p=e.stat_desc.extra_bits,_=e.stat_desc.extra_base,f=e.stat_desc.max_length,g=0;for(o=0;o<=l;o++)t.bl_count[o]=0;for(h[2*t.heap[t.heap_max]+1]=0,i=t.heap_max+1;i<573;i++)(o=h[2*h[2*(s=t.heap[i])+1]+1]+1)>f&&(o=f,g++),h[2*s+1]=o,s>c||(t.bl_count[o]++,a=0,s>=_&&(a=p[s-_]),n=h[2*s],t.opt_len+=n*(o+a),d&&(t.static_len+=n*(u[2*s+1]+a)));if(0!==g){do{for(o=f-1;0===t.bl_count[o];)o--;t.bl_count[o]--,t.bl_count[o+1]+=2,t.bl_count[f]--,g-=2}while(g>0);for(o=f;0!==o;o--)for(s=t.bl_count[o];0!==s;)(r=t.heap[--i])>c||(h[2*r+1]!==o&&(t.opt_len+=(o-h[2*r+1])*h[2*r],h[2*r+1]=o),s--)}}(t,e),D(o,c,t.bl_count)}function I(t,e,i){var s,r,o=-1,a=e[1],n=0,l=7,h=4;for(0===a&&(l=138,h=3),e[2*(i+1)+1]=65535,s=0;s<=i;s++)r=a,a=e[2*(s+1)+1],++n<l&&r===a||(n<h?t.bl_tree[2*r]+=n:0!==r?(r!==o&&t.bl_tree[2*r]++,t.bl_tree[32]++):n<=10?t.bl_tree[34]++:t.bl_tree[36]++,n=0,o=r,0===a?(l=138,h=3):r===a?(l=6,h=3):(l=7,h=4))}function k(t,e,i){var s,r,o=-1,a=e[1],n=0,l=7,h=4;for(0===a&&(l=138,h=3),s=0;s<=i;s++)if(r=a,a=e[2*(s+1)+1],!(++n<l&&r===a)){if(n<h)do{C(t,r,t.bl_tree)}while(0!=--n);else 0!==r?(r!==o&&(C(t,r,t.bl_tree),n--),C(t,16,t.bl_tree),A(t,n-3,2)):n<=10?(C(t,17,t.bl_tree),A(t,n-3,3)):(C(t,18,t.bl_tree),A(t,n-11,7));n=0,o=r,0===a?(l=138,h=3):r===a?(l=6,h=3):(l=7,h=4)}}r(y);var O=!1;function V(t,e,i,r){A(t,0+(r?1:0),3),function(t,e,i,r){B(t),r&&(E(t,i),E(t,~i)),s.arraySet(t.pending_buf,t.window,e,i,t.pending),t.pending+=i}(t,e,i,!0)}i._tr_init=function(t){O||(!function(){var t,e,i,s,r,o=new Array(16);for(i=0,s=0;s<28;s++)for(m[s]=i,t=0;t<1<<h[s];t++)g[i++]=s;for(g[i-1]=s,r=0,s=0;s<16;s++)for(y[s]=r,t=0;t<1<<c[s];t++)f[r++]=s;for(r>>=7;s<n;s++)for(y[s]=r<<7,t=0;t<1<<c[s]-7;t++)f[256+r++]=s;for(e=0;e<=l;e++)o[e]=0;for(t=0;t<=143;)p[2*t+1]=8,t++,o[8]++;for(;t<=255;)p[2*t+1]=9,t++,o[9]++;for(;t<=279;)p[2*t+1]=7,t++,o[7]++;for(;t<=287;)p[2*t+1]=8,t++,o[8]++;for(D(p,287,o),t=0;t<n;t++)_[2*t+1]=5,_[2*t]=S(t,5);v=new M(p,h,257,a,l),b=new M(_,c,0,n,l),P=new M(new Array(0),u,0,19,7)}(),O=!0),t.l_desc=new x(t.dyn_ltree,v),t.d_desc=new x(t.dyn_dtree,b),t.bl_desc=new x(t.bl_tree,P),t.bi_buf=0,t.bi_valid=0,L(t)},i._tr_stored_block=V,i._tr_flush_block=function(t,e,i,s){var r,a,n=0;t.level>0?(2===t.strm.data_type&&(t.strm.data_type=function(t){var e,i=4093624447;for(e=0;e<=31;e++,i>>>=1)if(1&i&&0!==t.dyn_ltree[2*e])return 0;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return 1;for(e=32;e<o;e++)if(0!==t.dyn_ltree[2*e])return 1;return 0}(t)),N(t,t.l_desc),N(t,t.d_desc),n=function(t){var e;for(I(t,t.dyn_ltree,t.l_desc.max_code),I(t,t.dyn_dtree,t.d_desc.max_code),N(t,t.bl_desc),e=18;e>=3&&0===t.bl_tree[2*d[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e}(t),r=t.opt_len+3+7>>>3,(a=t.static_len+3+7>>>3)<=r&&(r=a)):r=a=i+5,i+4<=r&&-1!==e?V(t,e,i,s):4===t.strategy||a===r?(A(t,2+(s?1:0),3),F(t,p,_)):(A(t,4+(s?1:0),3),function(t,e,i,s){var r;for(A(t,e-257,5),A(t,i-1,5),A(t,s-4,4),r=0;r<s;r++)A(t,t.bl_tree[2*d[r]+1],3);k(t,t.dyn_ltree,e-1),k(t,t.dyn_dtree,i-1)}(t,t.l_desc.max_code+1,t.d_desc.max_code+1,n+1),F(t,t.dyn_ltree,t.dyn_dtree)),L(t),s&&B(t)},i._tr_tally=function(t,e,i){return t.pending_buf[t.d_buf+2*t.last_lit]=e>>>8&255,t.pending_buf[t.d_buf+2*t.last_lit+1]=255&e,t.pending_buf[t.l_buf+t.last_lit]=255&i,t.last_lit++,0===e?t.dyn_ltree[2*i]++:(t.matches++,e--,t.dyn_ltree[2*(g[i]+o+1)]++,t.dyn_dtree[2*w(e)]++),t.last_lit===t.lit_bufsize-1},i._tr_align=function(t){A(t,2,3),C(t,256,p),function(t){16===t.bi_valid?(E(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)}(t)}},{"../utils/common":3}],15:[function(t,e,i){e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}],"/":[function(t,e,i){var s={};(0,t("./lib/utils/common").assign)(s,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),e.exports=s},{"./lib/deflate":1,"./lib/inflate":2,"./lib/utils/common":3,"./lib/zlib/constants":6}]},{},[])("/")}));var Nn=Object.freeze({__proto__:null});let In=window.pako||Nn;In.inflate||(In=In.default);const kn=function(){const t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();const On={version:1,parse:function(t,e,i,s){const r=function(t){return{positions:t[0],normals:t[1],indices:t[2],edgeIndices:t[3],meshPositions:t[4],meshIndices:t[5],meshEdgesIndices:t[6],meshColors:t[7],entityIDs:t[8],entityMeshes:t[9],entityIsObjects:t[10],positionsDecodeMatrix:t[11]}}(i),o=function(t){return{positions:new Uint16Array(In.inflate(t.positions).buffer),normals:new Int8Array(In.inflate(t.normals).buffer),indices:new Uint32Array(In.inflate(t.indices).buffer),edgeIndices:new Uint32Array(In.inflate(t.edgeIndices).buffer),meshPositions:new Uint32Array(In.inflate(t.meshPositions).buffer),meshIndices:new Uint32Array(In.inflate(t.meshIndices).buffer),meshEdgesIndices:new Uint32Array(In.inflate(t.meshEdgesIndices).buffer),meshColors:new Uint8Array(In.inflate(t.meshColors).buffer),entityIDs:In.inflate(t.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(In.inflate(t.entityMeshes).buffer),entityIsObjects:new Uint8Array(In.inflate(t.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(In.inflate(t.positionsDecodeMatrix).buffer)}}(r);!function(t,e,i,s){s.positionsCompression="precompressed",s.normalsCompression="precompressed";const r=i.positions,o=i.normals,a=i.indices,n=i.edgeIndices,l=i.meshPositions,h=i.meshIndices,c=i.meshEdgesIndices,u=i.meshColors,p=JSON.parse(i.entityIDs),_=i.entityMeshes,f=i.entityIsObjects,g=l.length,v=_.length;for(let b=0;b<v;b++){const P=p[b],y=e.globalizeObjectIds?d.globalizeObjectId(s.id,P):P,M=t.metaScene.metaObjects[y],x={},w={};if(M){if(e.excludeTypesMap&&M.type&&e.excludeTypesMap[M.type])continue;if(e.includeTypesMap&&M.type&&!e.includeTypesMap[M.type])continue;const t=e.objectDefaults?e.objectDefaults[M.type]||e.objectDefaults.DEFAULT:null;t&&(!1===t.visible&&(x.visible=!1),!1===t.pickable&&(x.pickable=!1),t.colorize&&(w.color=t.colorize),void 0!==t.opacity&&null!==t.opacity&&(w.opacity=t.opacity))}else if(e.excludeUnclassifiedObjects)continue;const E=b===v-1,A=[];for(let t=_[b],e=E?_.length:_[b+1];t<e;t++){const e=t===g-1,d=y+".mesh."+t,p=kn(u.subarray(4*t,4*t+3)),_=u[4*t+3]/255;s.createMesh(m.apply(w,{id:d,primitive:"triangles",positions:r.subarray(l[t],e?r.length:l[t+1]),normals:o.subarray(l[t],e?r.length:l[t+1]),indices:a.subarray(h[t],e?a.length:h[t+1]),edgeIndices:n.subarray(c[t],e?n.length:c[t+1]),positionsDecodeMatrix:i.positionsDecodeMatrix,color:p,opacity:_})),A.push(d)}s.createEntity(m.apply(x,{id:y,isObject:1===f[b],meshIds:A}))}}(t,e,o,s)}};let Vn=window.pako||Nn;Vn.inflate||(Vn=Vn.default);const zn=function(){const t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();const Un={version:2,parse:function(t,e,i,s){const r=function(t){return{positions:t[0],normals:t[1],indices:t[2],edgeIndices:t[3],meshPositions:t[4],meshIndices:t[5],meshEdgesIndices:t[6],meshColors:t[7],entityIDs:t[8],entityMeshes:t[9],entityIsObjects:t[10],positionsDecodeMatrix:t[11],entityMeshIds:t[12],entityMatrices:t[13],entityUsesInstancing:t[14]}}(i),o=function(t){return{positions:new Uint16Array(Vn.inflate(t.positions).buffer),normals:new Int8Array(Vn.inflate(t.normals).buffer),indices:new Uint32Array(Vn.inflate(t.indices).buffer),edgeIndices:new Uint32Array(Vn.inflate(t.edgeIndices).buffer),meshPositions:new Uint32Array(Vn.inflate(t.meshPositions).buffer),meshIndices:new Uint32Array(Vn.inflate(t.meshIndices).buffer),meshEdgesIndices:new Uint32Array(Vn.inflate(t.meshEdgesIndices).buffer),meshColors:new Uint8Array(Vn.inflate(t.meshColors).buffer),entityIDs:Vn.inflate(t.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(Vn.inflate(t.entityMeshes).buffer),entityIsObjects:new Uint8Array(Vn.inflate(t.entityIsObjects).buffer),positionsDecodeMatrix:new Float32Array(Vn.inflate(t.positionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(Vn.inflate(t.entityMeshIds).buffer),entityMatrices:new Float32Array(Vn.inflate(t.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(Vn.inflate(t.entityUsesInstancing).buffer)}}(r);!function(t,e,i,s){s.positionsCompression="precompressed",s.normalsCompression="precompressed";const r=i.positions,o=i.normals,a=i.indices,n=i.edgeIndices,l=i.meshPositions,h=i.meshIndices,c=i.meshEdgesIndices,u=i.meshColors,p=JSON.parse(i.entityIDs),_=i.entityMeshes,f=i.entityIsObjects,g=i.entityMeshIds,v=i.entityMatrices,b=i.entityUsesInstancing,P=l.length,y=_.length,M={};for(let x=0;x<y;x++){const w=p[x],E=e.globalizeObjectIds?d.globalizeObjectId(s.id,w):w,A=t.metaScene.metaObjects[E],C={},S={},D=v.subarray(16*x,16*x+16);if(A){if(e.excludeTypesMap&&A.type&&e.excludeTypesMap[A.type])continue;if(e.includeTypesMap&&A.type&&!e.includeTypesMap[A.type])continue;const t=e.objectDefaults?e.objectDefaults[A.type]||e.objectDefaults.DEFAULT:null;t&&(!1===t.visible&&(C.visible=!1),!1===t.pickable&&(C.pickable=!1),t.colorize&&(S.color=t.colorize),void 0!==t.opacity&&null!==t.opacity&&(S.opacity=t.opacity))}else if(e.excludeUnclassifiedObjects)continue;const L=x===y-1,B=[];for(let t=_[x],e=L?g.length:_[x+1];t<e;t++){const e=g[t],d=e===P-1,p=E+".mesh."+e,_=zn(u.subarray(4*e,4*e+3)),f=u[4*e+3]/255,v=r.subarray(l[e],d?r.length:l[e+1]),y=o.subarray(l[e],d?r.length:l[e+1]),w=a.subarray(h[e],d?a.length:h[e+1]),A=n.subarray(c[e],d?n.length:c[e+1]);if(1===b[x]){const t="geometry."+e;t in M||(s.createGeometry({id:t,positions:v,normals:y,indices:w,edgeIndices:A,primitive:"triangles",positionsDecodeMatrix:i.positionsDecodeMatrix}),M[t]=!0),s.createMesh(m.apply(S,{id:p,color:_,opacity:f,matrix:D,geometryId:t})),B.push(p)}else s.createMesh(m.apply(S,{id:p,primitive:"triangles",positions:v,normals:y,indices:w,edgeIndices:A,positionsDecodeMatrix:i.positionsDecodeMatrix,color:_,opacity:f})),B.push(p)}B.length&&s.createEntity(m.apply(C,{id:E,isObject:1===f[x],meshIds:B}))}}(t,e,o,s)}};let Gn=window.pako||Nn;Gn.inflate||(Gn=Gn.default);const jn=function(){const t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();const Xn={version:3,parse:function(t,e,i,s){const r=function(t){return{positions:t[0],normals:t[1],indices:t[2],edgeIndices:t[3],meshPositions:t[4],meshIndices:t[5],meshEdgesIndices:t[6],meshColors:t[7],entityIDs:t[8],entityMeshes:t[9],entityIsObjects:t[10],instancedPositionsDecodeMatrix:t[11],batchedPositionsDecodeMatrix:t[12],entityMeshIds:t[13],entityMatrices:t[14],entityUsesInstancing:t[15]}}(i),o=function(t){return{positions:new Uint16Array(Gn.inflate(t.positions).buffer),normals:new Int8Array(Gn.inflate(t.normals).buffer),indices:new Uint32Array(Gn.inflate(t.indices).buffer),edgeIndices:new Uint32Array(Gn.inflate(t.edgeIndices).buffer),meshPositions:new Uint32Array(Gn.inflate(t.meshPositions).buffer),meshIndices:new Uint32Array(Gn.inflate(t.meshIndices).buffer),meshEdgesIndices:new Uint32Array(Gn.inflate(t.meshEdgesIndices).buffer),meshColors:new Uint8Array(Gn.inflate(t.meshColors).buffer),entityIDs:Gn.inflate(t.entityIDs,{to:"string"}),entityMeshes:new Uint32Array(Gn.inflate(t.entityMeshes).buffer),entityIsObjects:new Uint8Array(Gn.inflate(t.entityIsObjects).buffer),instancedPositionsDecodeMatrix:new Float32Array(Gn.inflate(t.instancedPositionsDecodeMatrix).buffer),batchedPositionsDecodeMatrix:new Float32Array(Gn.inflate(t.batchedPositionsDecodeMatrix).buffer),entityMeshIds:new Uint32Array(Gn.inflate(t.entityMeshIds).buffer),entityMatrices:new Float32Array(Gn.inflate(t.entityMatrices).buffer),entityUsesInstancing:new Uint8Array(Gn.inflate(t.entityUsesInstancing).buffer)}}(r);!function(t,e,i,s){s.positionsCompression="precompressed",s.normalsCompression="precompressed";const r=i.positions,o=i.normals,a=i.indices,n=i.edgeIndices,l=i.meshPositions,h=i.meshIndices,c=i.meshEdgesIndices,u=i.meshColors,p=JSON.parse(i.entityIDs),_=i.entityMeshes,f=i.entityIsObjects,g=i.entityMeshIds,v=i.entityMatrices,b=i.entityUsesInstancing,P=l.length,y=_.length,M={};for(let D=0;D<y;D++){const L=p[D],B=e.globalizeObjectIds?d.globalizeObjectId(s.id,L):L,R=t.metaScene.metaObjects[B],T={},F={},N=v.subarray(16*D,16*D+16);if(R){if(e.excludeTypesMap&&R.type&&e.excludeTypesMap[R.type])continue;if(e.includeTypesMap&&R.type&&!e.includeTypesMap[R.type])continue;const t=e.objectDefaults?e.objectDefaults[R.type]||e.objectDefaults.DEFAULT:null;t&&(!1===t.visible&&(T.visible=!1),!1===t.pickable&&(T.pickable=!1),t.colorize&&(F.color=t.colorize),void 0!==t.opacity&&null!==t.opacity&&(F.opacity=t.opacity))}else if(e.excludeUnclassifiedObjects)continue;const I=D===y-1,k=[];for(let t=_[D],e=I?g.length:_[D+1];t<e;t++){var x=g[t];const e=x===P-1,d=B+".mesh."+x,p=jn(u.subarray(4*x,4*x+3)),_=u[4*x+3]/255;var w=r.subarray(l[x],e?r.length:l[x+1]),E=o.subarray(l[x],e?r.length:l[x+1]),A=a.subarray(h[x],e?a.length:h[x+1]),C=n.subarray(c[x],e?n.length:c[x+1]);if(1===b[D]){var S="geometry."+x;S in M||(s.createGeometry({id:S,positions:w,normals:E,indices:A,edgeIndices:C,primitive:"triangles",positionsDecodeMatrix:i.instancedPositionsDecodeMatrix}),M[S]=!0),s.createMesh(m.apply(F,{id:d,color:p,opacity:_,matrix:N,geometryId:S})),k.push(d)}else s.createMesh(m.apply(F,{id:d,primitive:"triangles",positions:w,normals:E,indices:A,edgeIndices:C,positionsDecodeMatrix:i.batchedPositionsDecodeMatrix,color:p,opacity:_})),k.push(d)}k.length&&s.createEntity(m.apply(T,{id:B,isObject:1===f[D],meshIds:k}))}}(t,e,o,s)}};let Wn=window.pako||Nn;Wn.inflate||(Wn=Wn.default);const Hn=function(){const t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();const Yn={version:4,parse:function(t,e,i,s){const r=function(t){return{positions:t[0],normals:t[1],indices:t[2],edgeIndices:t[3],decodeMatrices:t[4],matrices:t[5],eachPrimitivePositionsAndNormalsPortion:t[6],eachPrimitiveIndicesPortion:t[7],eachPrimitiveEdgeIndicesPortion:t[8],eachPrimitiveDecodeMatricesPortion:t[9],eachPrimitiveColor:t[10],primitiveInstances:t[11],eachEntityId:t[12],eachEntityPrimitiveInstancesPortion:t[13],eachEntityMatricesPortion:t[14],eachEntityMatrix:t[15]}}(i),o=function(t){return{positions:new Uint16Array(Wn.inflate(t.positions).buffer),normals:new Int8Array(Wn.inflate(t.normals).buffer),indices:new Uint32Array(Wn.inflate(t.indices).buffer),edgeIndices:new Uint32Array(Wn.inflate(t.edgeIndices).buffer),decodeMatrices:new Float32Array(Wn.inflate(t.decodeMatrices).buffer),matrices:new Float32Array(Wn.inflate(t.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(Wn.inflate(t.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(Wn.inflate(t.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(Wn.inflate(t.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveDecodeMatricesPortion:new Uint32Array(Wn.inflate(t.eachPrimitiveDecodeMatricesPortion).buffer),eachPrimitiveColor:new Uint8Array(Wn.inflate(t.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(Wn.inflate(t.primitiveInstances).buffer),eachEntityId:Wn.inflate(t.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(Wn.inflate(t.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(Wn.inflate(t.eachEntityMatricesPortion).buffer)}}(r);!function(t,e,i,s){s.positionsCompression="precompressed",s.normalsCompression="precompressed";const r=i.positions,o=i.normals,a=i.indices,n=i.edgeIndices,l=i.decodeMatrices,h=i.matrices,c=i.eachPrimitivePositionsAndNormalsPortion,u=i.eachPrimitiveIndicesPortion,d=i.eachPrimitiveEdgeIndicesPortion,p=i.eachPrimitiveDecodeMatricesPortion,_=i.eachPrimitiveColor,f=i.primitiveInstances,g=JSON.parse(i.eachEntityId),v=i.eachEntityPrimitiveInstancesPortion,b=i.eachEntityMatricesPortion,P=c.length,y=f.length,M=new Uint8Array(P),x=new Uint32Array(P),w=g.length;for(let t=0;t<P;t++)x[t]=t;x.sort(((t,e)=>p[t]<p[e]?-1:p[t]>p[e]?1:0));for(let t=0;t<y;t++)M[f[t]]++;const E={};for(let t=0;t<w;t++){const e=w-1,i=t===e,s=v[t],r=i?v[e]:v[t+1];for(let e=s;e<r;e++){const i=f[e];M[i]>1||(E[i]=t)}}for(let t=0;t<P;t++){const e=x[t],i=e===P-1,h=M[e]>1,f=Hn(_.subarray(4*e,4*e+3)),v=_[4*e+3]/255,b=r.subarray(c[e],i?r.length:c[e+1]),y=o.subarray(c[e],i?o.length:c[e+1]),w=a.subarray(u[e],i?a.length:u[e+1]),C=n.subarray(d[e],i?n.length:d[e+1]),S=l.subarray(p[e],p[e]+16);if(h){var A="geometry"+e;s.createGeometry({id:A,primitive:"triangles",positions:b,normals:y,indices:w,edgeIndices:C,positionsDecodeMatrix:S})}else{const t=e;g[E[e]];const i={};s.createMesh(m.apply(i,{id:t,primitive:"triangles",positions:b,normals:y,indices:w,edgeIndices:C,positionsDecodeMatrix:S,color:f,opacity:v}))}}let C=0;for(let t=0;t<w;t++){const e=w-1,i=t===e,r=g[t],o=v[t],a=i?v[e]:v[t+1],n=[];for(let e=o;e<a;e++){const i=f[e];if(M[i]>1){const e={},r="instance."+C++,o="geometry"+i,a=16*b[t],l=h.subarray(a,a+16);s.createMesh(m.apply(e,{id:r,geometryId:o,matrix:l})),n.push(r)}else n.push(i)}if(n.length>0){const t={};s.createEntity(m.apply(t,{id:r,isObject:!0,meshIds:n}))}}}(0,0,o,s)}};let Kn=window.pako||Nn;Kn.inflate||(Kn=Kn.default);const qn=function(){const t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();const Zn={version:5,parse:function(t,e,i,s){const r=function(t){return{positions:t[0],normals:t[1],indices:t[2],edgeIndices:t[3],matrices:t[4],eachPrimitivePositionsAndNormalsPortion:t[5],eachPrimitiveIndicesPortion:t[6],eachPrimitiveEdgeIndicesPortion:t[7],eachPrimitiveColor:t[8],primitiveInstances:t[9],eachEntityId:t[10],eachEntityPrimitiveInstancesPortion:t[11],eachEntityMatricesPortion:t[12]}}(i),o=function(t){return{positions:new Float32Array(Kn.inflate(t.positions).buffer),normals:new Int8Array(Kn.inflate(t.normals).buffer),indices:new Uint32Array(Kn.inflate(t.indices).buffer),edgeIndices:new Uint32Array(Kn.inflate(t.edgeIndices).buffer),matrices:new Float32Array(Kn.inflate(t.matrices).buffer),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(Kn.inflate(t.eachPrimitivePositionsAndNormalsPortion).buffer),eachPrimitiveIndicesPortion:new Uint32Array(Kn.inflate(t.eachPrimitiveIndicesPortion).buffer),eachPrimitiveEdgeIndicesPortion:new Uint32Array(Kn.inflate(t.eachPrimitiveEdgeIndicesPortion).buffer),eachPrimitiveColor:new Uint8Array(Kn.inflate(t.eachPrimitiveColor).buffer),primitiveInstances:new Uint32Array(Kn.inflate(t.primitiveInstances).buffer),eachEntityId:Kn.inflate(t.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(Kn.inflate(t.eachEntityPrimitiveInstancesPortion).buffer),eachEntityMatricesPortion:new Uint32Array(Kn.inflate(t.eachEntityMatricesPortion).buffer)}}(r);!function(t,e,i,s){s.positionsCompression="disabled",s.normalsCompression="precompressed";const r=i.positions,o=i.normals,a=i.indices,n=i.edgeIndices,l=i.matrices,h=i.eachPrimitivePositionsAndNormalsPortion,c=i.eachPrimitiveIndicesPortion,u=i.eachPrimitiveEdgeIndicesPortion,d=i.eachPrimitiveColor,p=i.primitiveInstances,_=JSON.parse(i.eachEntityId),f=i.eachEntityPrimitiveInstancesPortion,g=i.eachEntityMatricesPortion,v=h.length,b=p.length,P=new Uint8Array(v),y=_.length;for(let t=0;t<b;t++)P[p[t]]++;const M={};for(let t=0;t<y;t++){const e=y-1,i=t===e,s=f[t],r=i?f[e]:f[t+1];for(let e=s;e<r;e++){const i=p[e];P[i]>1||(M[i]=t)}}for(let t=0;t<v;t++){const e=t===v-1,i=P[t]>1,l=qn(d.subarray(4*t,4*t+3)),p=d[4*t+3]/255,f=r.subarray(h[t],e?r.length:h[t+1]),g=o.subarray(h[t],e?o.length:h[t+1]),b=a.subarray(c[t],e?a.length:c[t+1]),y=n.subarray(u[t],e?n.length:u[t+1]);if(i){var x="geometry"+t;s.createGeometry({id:x,primitive:"triangles",positions:f,normals:g,indices:b,edgeIndices:y})}else{const e=t;_[M[t]];const i={};s.createMesh(m.apply(i,{id:e,primitive:"triangles",positions:f,normals:g,indices:b,edgeIndices:y,color:l,opacity:p}))}}let w=0;for(let t=0;t<y;t++){const e=y-1,i=t===e,r=_[t],o=f[t],a=i?f[e]:f[t+1],n=[];for(let e=o;e<a;e++){const i=p[e];if(P[i]>1){const e={},r="instance."+w++,o="geometry"+i,a=16*g[t],h=l.subarray(a,a+16);s.createMesh(m.apply(e,{id:r,geometryId:o,matrix:h})),n.push(r)}else n.push(i)}if(n.length>0){const t={};s.createEntity(m.apply(t,{id:r,isObject:!0,meshIds:n}))}}}(0,0,o,s)}};let Qn=window.pako||Nn;Qn.inflate||(Qn=Qn.default);const $n=function(){const t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();const Jn={version:6,parse:function(t,e,i,s){const r=function(t){return{positions:t[0],normals:t[1],indices:t[2],edgeIndices:t[3],matrices:t[4],reusedPrimitivesDecodeMatrix:t[5],eachPrimitivePositionsAndNormalsPortion:t[6],eachPrimitiveIndicesPortion:t[7],eachPrimitiveEdgeIndicesPortion:t[8],eachPrimitiveColorAndOpacity:t[9],primitiveInstances:t[10],eachEntityId:t[11],eachEntityPrimitiveInstancesPortion:t[12],eachEntityMatricesPortion:t[13],eachTileAABB:t[14],eachTileEntitiesPortion:t[15]}}(i),o=function(t){function e(t,e){return 0===t.length?[]:Qn.inflate(t,e).buffer}return{positions:new Uint16Array(e(t.positions)),normals:new Int8Array(e(t.normals)),indices:new Uint32Array(e(t.indices)),edgeIndices:new Uint32Array(e(t.edgeIndices)),matrices:new Float32Array(e(t.matrices)),reusedPrimitivesDecodeMatrix:new Float32Array(e(t.reusedPrimitivesDecodeMatrix)),eachPrimitivePositionsAndNormalsPortion:new Uint32Array(e(t.eachPrimitivePositionsAndNormalsPortion)),eachPrimitiveIndicesPortion:new Uint32Array(e(t.eachPrimitiveIndicesPortion)),eachPrimitiveEdgeIndicesPortion:new Uint32Array(e(t.eachPrimitiveEdgeIndicesPortion)),eachPrimitiveColorAndOpacity:new Uint8Array(e(t.eachPrimitiveColorAndOpacity)),primitiveInstances:new Uint32Array(e(t.primitiveInstances)),eachEntityId:Qn.inflate(t.eachEntityId,{to:"string"}),eachEntityPrimitiveInstancesPortion:new Uint32Array(e(t.eachEntityPrimitiveInstancesPortion)),eachEntityMatricesPortion:new Uint32Array(e(t.eachEntityMatricesPortion)),eachTileAABB:new Float64Array(e(t.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(t.eachTileEntitiesPortion))}}(r);!function(t,e,i,s){const r=i.positions,o=i.normals,a=i.indices,n=i.edgeIndices,l=i.matrices,h=i.reusedPrimitivesDecodeMatrix,c=i.eachPrimitivePositionsAndNormalsPortion,u=i.eachPrimitiveIndicesPortion,p=i.eachPrimitiveEdgeIndicesPortion,_=i.eachPrimitiveColorAndOpacity,f=i.primitiveInstances,g=JSON.parse(i.eachEntityId),v=i.eachEntityPrimitiveInstancesPortion,b=i.eachEntityMatricesPortion,P=i.eachTileAABB,y=i.eachTileEntitiesPortion,M=c.length,x=f.length,w=g.length,E=y.length;let A=0;const C=new Uint32Array(M);for(let t=0;t<x;t++){const e=f[t];void 0!==C[e]?C[e]++:C[e]=1}const S=d.vec3(),D=d.AABB3();for(let i=0;i<E;i++){const x=i===E-1,L=y[i],B=x?w:y[i+1],R=6*i,T=P.subarray(R,R+6);d.getAABB3Center(T,S),D[0]=T[0]-S[0],D[1]=T[1]-S[1],D[2]=T[2]-S[2],D[3]=T[3]-S[0],D[4]=T[4]-S[1],D[5]=T[5]-S[2];const F=ve.createPositionsDecodeMatrix(D),N={};for(let P=L;P<B;P++){const y=g[P],x=e.globalizeObjectIds?d.globalizeObjectId(s.id,y):y,E=b[P],D=l.slice(E,E+16),L=P===w-1,B=v[P],R=L?f.length:v[P+1],T=[],I=t.metaScene.metaObjects[x],k={},O={};if(I){if(e.excludeTypesMap&&I.type&&e.excludeTypesMap[I.type])continue;if(e.includeTypesMap&&I.type&&!e.includeTypesMap[I.type])continue;const t=e.objectDefaults?e.objectDefaults[I.type]||e.objectDefaults.DEFAULT:null;t&&(!1===t.visible&&(k.visible=!1),!1===t.pickable&&(k.pickable=!1),t.colorize&&(O.color=t.colorize),void 0!==t.opacity&&null!==t.opacity&&(O.opacity=t.opacity))}else if(e.excludeUnclassifiedObjects)continue;for(let t=B;t<R;t++){const e=f[t],l=C[e]>1,d=e===M-1,g=r.subarray(c[e],d?r.length:c[e+1]),v=o.subarray(c[e],d?o.length:c[e+1]),b=a.subarray(u[e],d?a.length:u[e+1]),P=n.subarray(p[e],d?n.length:p[e+1]),y=$n(_.subarray(4*e,4*e+3)),x=_[4*e+3]/255,w=A++;if(l){const t="geometry."+i+"."+e;N[t]||(s.createGeometry({id:t,origin:S,primitive:"triangles",positions:g,normals:v,indices:b,edgeIndices:P,positionsDecodeMatrix:h}),N[t]=!0),s.createMesh(m.apply(O,{id:w,geometryId:t,matrix:D,color:y,opacity:x})),T.push(w)}else s.createMesh(m.apply(O,{id:w,origin:S,primitive:"triangles",positions:g,normals:v,indices:b,edgeIndices:P,positionsDecodeMatrix:F,color:y,opacity:x})),T.push(w)}T.length>0&&s.createEntity(m.apply(k,{id:x,isObject:!0,meshIds:T}))}}}(t,e,o,s)}};let tl=window.pako||Nn;tl.inflate||(tl=tl.default);const el=function(){const t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();function il(t){const e=[];for(let i=0,s=t.length;i<s;i+=3)e.push(t[i]),e.push(t[i+1]),e.push(t[i+2]),e.push(1);return e}const sl={version:7,parse:function(t,e,i,s){const r=function(t){return{positions:t[0],normals:t[1],colors:t[2],indices:t[3],edgeIndices:t[4],matrices:t[5],reusedGeometriesDecodeMatrix:t[6],eachGeometryPrimitiveType:t[7],eachGeometryPositionsPortion:t[8],eachGeometryNormalsPortion:t[9],eachGeometryColorsPortion:t[10],eachGeometryIndicesPortion:t[11],eachGeometryEdgeIndicesPortion:t[12],eachMeshGeometriesPortion:t[13],eachMeshMatricesPortion:t[14],eachMeshMaterial:t[15],eachEntityId:t[16],eachEntityMeshesPortion:t[17],eachTileAABB:t[18],eachTileEntitiesPortion:t[19]}}(i),o=function(t){function e(t,e){return 0===t.length?[]:tl.inflate(t,e).buffer}return{positions:new Uint16Array(e(t.positions)),normals:new Int8Array(e(t.normals)),colors:new Uint8Array(e(t.colors)),indices:new Uint32Array(e(t.indices)),edgeIndices:new Uint32Array(e(t.edgeIndices)),matrices:new Float32Array(e(t.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(t.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(t.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(t.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(t.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(t.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(t.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(t.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(t.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(t.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(t.eachMeshMaterial)),eachEntityId:tl.inflate(t.eachEntityId,{to:"string"}),eachEntityMeshesPortion:new Uint32Array(e(t.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(t.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(t.eachTileEntitiesPortion))}}(r);!function(t,e,i,s){const r=i.positions,o=i.normals,a=i.colors,n=i.indices,l=i.edgeIndices,h=i.matrices,c=i.reusedGeometriesDecodeMatrix,u=i.eachGeometryPrimitiveType,p=i.eachGeometryPositionsPortion,_=i.eachGeometryNormalsPortion,f=i.eachGeometryColorsPortion,g=i.eachGeometryIndicesPortion,v=i.eachGeometryEdgeIndicesPortion,b=i.eachMeshGeometriesPortion,P=i.eachMeshMatricesPortion,y=i.eachMeshMaterial,M=JSON.parse(i.eachEntityId),x=i.eachEntityMeshesPortion,w=i.eachTileAABB,E=i.eachTileEntitiesPortion,A=p.length,C=b.length,S=M.length,D=E.length;let L=0;const B=new Uint32Array(A);for(let t=0;t<C;t++){const e=b[t];void 0!==B[e]?B[e]++:B[e]=1}const R=d.vec3(),T=d.AABB3();for(let i=0;i<D;i++){const C=i===D-1,F=E[i],N=C?S:E[i+1],I=6*i,k=w.subarray(I,I+6);d.getAABB3Center(k,R),T[0]=k[0]-R[0],T[1]=k[1]-R[1],T[2]=k[2]-R[2],T[3]=k[3]-R[0],T[4]=k[4]-R[1],T[5]=k[5]-R[2];const O=ve.createPositionsDecodeMatrix(T),V={};for(let w=F;w<N;w++){const E=M[w],C=e.globalizeObjectIds?d.globalizeObjectId(s.id,E):E,D=w===S-1,T=x[w],F=D?b.length:x[w+1],N=[],I=t.metaScene.metaObjects[C],k={},z={};if(I){if(e.excludeTypesMap&&I.type&&e.excludeTypesMap[I.type])continue;if(e.includeTypesMap&&I.type&&!e.includeTypesMap[I.type])continue;const t=e.objectDefaults?e.objectDefaults[I.type]||e.objectDefaults.DEFAULT:null;t&&(!1===t.visible&&(k.visible=!1),!1===t.pickable&&(k.pickable=!1),t.colorize&&(z.color=t.colorize),void 0!==t.opacity&&null!==t.opacity&&(z.opacity=t.opacity),void 0!==t.metallic&&null!==t.metallic&&(z.metallic=t.metallic),void 0!==t.roughness&&null!==t.roughness&&(z.roughness=t.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let t=T;t<F;t++){const e=b[t],d=B[e]>1,M=e===A-1,x=el(y.subarray(6*t,6*t+3)),w=y[6*t+3]/255,E=y[6*t+4]/255,C=y[6*t+5]/255,S=L++;if(d){const d=P[t],b=h.slice(d,d+16),y="geometry."+i+"."+e;if(!V[y]){let t,i,h,d,m,b;switch(u[e]){case 0:t="solid",i=r.subarray(p[e],M?r.length:p[e+1]),h=o.subarray(_[e],M?o.length:_[e+1]),m=n.subarray(g[e],M?n.length:g[e+1]),b=l.subarray(v[e],M?l.length:v[e+1]);break;case 1:t="surface",i=r.subarray(p[e],M?r.length:p[e+1]),h=o.subarray(_[e],M?o.length:_[e+1]),m=n.subarray(g[e],M?n.length:g[e+1]),b=l.subarray(v[e],M?l.length:v[e+1]);break;case 2:t="points",i=r.subarray(p[e],M?r.length:p[e+1]),d=il(a.subarray(f[e],M?a.length:f[e+1]));break;case 3:t="lines",i=r.subarray(p[e],M?r.length:p[e+1]),m=n.subarray(g[e],M?n.length:g[e+1]);break;default:continue}s.createGeometry({id:y,origin:R,primitive:t,positions:i,normals:h,colors:d,indices:m,edgeIndices:b,positionsDecodeMatrix:c}),V[y]=!0}s.createMesh(m.apply(z,{id:S,geometryId:y,matrix:b,color:x,metallic:E,roughness:C,opacity:w})),N.push(S)}else{let t,i,h,c,d,b;switch(u[e]){case 0:t="solid",i=r.subarray(p[e],M?r.length:p[e+1]),h=o.subarray(_[e],M?o.length:_[e+1]),d=n.subarray(g[e],M?n.length:g[e+1]),b=l.subarray(v[e],M?l.length:v[e+1]);break;case 1:t="surface",i=r.subarray(p[e],M?r.length:p[e+1]),h=o.subarray(_[e],M?o.length:_[e+1]),d=n.subarray(g[e],M?n.length:g[e+1]),b=l.subarray(v[e],M?l.length:v[e+1]);break;case 2:t="points",i=r.subarray(p[e],M?r.length:p[e+1]),c=il(a.subarray(f[e],M?a.length:f[e+1]));break;case 3:t="lines",i=r.subarray(p[e],M?r.length:p[e+1]),d=n.subarray(g[e],M?n.length:g[e+1]);break;default:continue}s.createMesh(m.apply(z,{id:S,origin:R,primitive:t,positions:i,normals:h,colors:c,indices:d,edgeIndices:b,positionsDecodeMatrix:O,color:x,metallic:E,roughness:C,opacity:w})),N.push(S)}}N.length>0&&s.createEntity(m.apply(k,{id:C,isObject:!0,meshIds:N}))}}}(t,e,o,s)}};let rl=window.pako||Nn;rl.inflate||(rl=rl.default);const ol=d.vec4(),al=d.vec4();const nl=function(){const t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();function ll(t){const e=[];for(let i=0,s=t.length;i<s;i+=3)e.push(t[i]),e.push(t[i+1]),e.push(t[i+2]),e.push(1);return e}const hl={version:8,parse:function(t,e,i,s){const r=function(t){return{types:t[0],eachMetaObjectId:t[1],eachMetaObjectType:t[2],eachMetaObjectName:t[3],eachMetaObjectParent:t[4],positions:t[5],normals:t[6],colors:t[7],indices:t[8],edgeIndices:t[9],matrices:t[10],reusedGeometriesDecodeMatrix:t[11],eachGeometryPrimitiveType:t[12],eachGeometryPositionsPortion:t[13],eachGeometryNormalsPortion:t[14],eachGeometryColorsPortion:t[15],eachGeometryIndicesPortion:t[16],eachGeometryEdgeIndicesPortion:t[17],eachMeshGeometriesPortion:t[18],eachMeshMatricesPortion:t[19],eachMeshMaterial:t[20],eachEntityMetaObject:t[21],eachEntityMeshesPortion:t[22],eachTileAABB:t[23],eachTileEntitiesPortion:t[24]}}(i),o=function(t){function e(t,e){return 0===t.length?[]:rl.inflate(t,e).buffer}return{types:rl.inflate(t.types,{to:"string"}),eachMetaObjectId:rl.inflate(t.eachMetaObjectId,{to:"string"}),eachMetaObjectType:new Uint32Array(e(t.eachMetaObjectType)),eachMetaObjectName:rl.inflate(t.eachMetaObjectName,{to:"string"}),eachMetaObjectParent:new Uint32Array(e(t.eachMetaObjectParent)),positions:new Uint16Array(e(t.positions)),normals:new Int8Array(e(t.normals)),colors:new Uint8Array(e(t.colors)),indices:new Uint32Array(e(t.indices)),edgeIndices:new Uint32Array(e(t.edgeIndices)),matrices:new Float32Array(e(t.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(t.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(t.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(t.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(t.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(t.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(t.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(t.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(t.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(t.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(t.eachMeshMaterial)),eachEntityMetaObject:new Uint32Array(e(t.eachEntityMetaObject)),eachEntityMeshesPortion:new Uint32Array(e(t.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(t.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(t.eachTileEntitiesPortion))}}(r);!function(t,e,i,s){const r=JSON.parse(i.types),o=JSON.parse(i.eachMetaObjectId),a=i.eachMetaObjectType,n=JSON.parse(i.eachMetaObjectName),l=i.eachMetaObjectParent,h=i.positions,c=i.normals,u=i.colors,p=i.indices,_=i.edgeIndices,f=i.matrices,g=i.reusedGeometriesDecodeMatrix,v=i.eachGeometryPrimitiveType,b=i.eachGeometryPositionsPortion,P=i.eachGeometryNormalsPortion,y=i.eachGeometryColorsPortion,M=i.eachGeometryIndicesPortion,x=i.eachGeometryEdgeIndicesPortion,w=i.eachMeshGeometriesPortion,E=i.eachMeshMatricesPortion,A=i.eachMeshMaterial,C=i.eachEntityMetaObject,S=i.eachEntityMeshesPortion,D=i.eachTileAABB,L=i.eachTileEntitiesPortion,B=o.length,R=b.length,T=w.length,F=C.length,N=L.length;let I=0;const k=s.id;if(!t.metaScene.metaModels[k]){const i={metaObjects:[]};for(let t=0;t<B;t++){const e=o[t],s=r[a[t]]||"default",h=n[t],c=l[t],u=c!==t?o[c]:null;i.metaObjects.push({id:e,type:s,name:h,parent:u})}t.metaScene.createMetaModel(k,i,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds}),s.once("destroyed",(()=>{t.metaScene.destroyMetaModel(k)}))}const O=new Uint32Array(R);for(let t=0;t<T;t++){const e=w[t];void 0!==O[e]?O[e]++:O[e]=1}const V=d.vec3(),z=d.AABB3(),U={};for(let i=0;i<N;i++){const r=i===N-1,a=L[i],n=r?F:L[i+1],l=6*i,B=D.subarray(l,l+6);d.getAABB3Center(B,V),z[0]=B[0]-V[0],z[1]=B[1]-V[1],z[2]=B[2]-V[2],z[3]=B[3]-V[0],z[4]=B[4]-V[1],z[5]=B[5]-V[2];const T=ve.createPositionsDecodeMatrix(z),k={};for(let r=a;r<n;r++){const a=o[C[r]],n=e.globalizeObjectIds?d.globalizeObjectId(s.id,a):a,l=r===F-1,D=S[r],L=l?w.length:S[r+1],B=[],N=t.metaScene.metaObjects[n],G={},j={};if(N){if(e.excludeTypesMap&&N.type&&e.excludeTypesMap[N.type])continue;if(e.includeTypesMap&&N.type&&!e.includeTypesMap[N.type])continue;const t=e.objectDefaults?e.objectDefaults[N.type]||e.objectDefaults.DEFAULT:null;t&&(!1===t.visible&&(G.visible=!1),!1===t.pickable&&(G.pickable=!1),t.colorize&&(j.color=t.colorize),void 0!==t.opacity&&null!==t.opacity&&(j.opacity=t.opacity),void 0!==t.metallic&&null!==t.metallic&&(j.metallic=t.metallic),void 0!==t.roughness&&null!==t.roughness&&(j.roughness=t.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let t=D;t<L;t++){const r=w[t],o=O[r]>1,a=r===R-1,n=nl(A.subarray(6*t,6*t+3)),l=A[6*t+3]/255,C=A[6*t+4]/255,S=A[6*t+5]/255,D=I++;if(o){const o=E[t],w=f.slice(o,o+16),A="geometry."+i+"."+r;let L=U[A];if(!L){L={batchThisMesh:!e.reuseGeometries};let t=!1;switch(v[r]){case 0:L.primitiveName="solid",L.geometryPositions=h.subarray(b[r],a?h.length:b[r+1]),L.geometryNormals=c.subarray(P[r],a?c.length:P[r+1]),L.geometryIndices=p.subarray(M[r],a?p.length:M[r+1]),L.geometryEdgeIndices=_.subarray(x[r],a?_.length:x[r+1]),t=L.geometryPositions.length>0&&L.geometryIndices.length>0;break;case 1:L.primitiveName="surface",L.geometryPositions=h.subarray(b[r],a?h.length:b[r+1]),L.geometryNormals=c.subarray(P[r],a?c.length:P[r+1]),L.geometryIndices=p.subarray(M[r],a?p.length:M[r+1]),L.geometryEdgeIndices=_.subarray(x[r],a?_.length:x[r+1]),t=L.geometryPositions.length>0&&L.geometryIndices.length>0;break;case 2:L.primitiveName="points",L.geometryPositions=h.subarray(b[r],a?h.length:b[r+1]),L.geometryColors=ll(u.subarray(y[r],a?u.length:y[r+1])),t=L.geometryPositions.length>0;break;case 3:L.primitiveName="lines",L.geometryPositions=h.subarray(b[r],a?h.length:b[r+1]),L.geometryIndices=p.subarray(M[r],a?p.length:M[r+1]),t=L.geometryPositions.length>0&&L.geometryIndices.length>0;break;default:continue}if(t||(L=null),L&&(L.geometryPositions.length,L.batchThisMesh)){L.decompressedPositions=new Float32Array(L.geometryPositions.length);const t=L.geometryPositions,e=L.decompressedPositions;for(let i=0,s=t.length;i<s;i+=3)e[i+0]=t[i+0]*g[0]+g[12],e[i+1]=t[i+1]*g[5]+g[13],e[i+2]=t[i+2]*g[10]+g[14];L.geometryPositions=null,U[A]=L}}if(L)if(L.batchThisMesh){const t=L.decompressedPositions,e=new Uint16Array(t.length);for(let i=0,s=t.length;i<s;i+=3)ol[0]=t[i+0],ol[1]=t[i+1],ol[2]=t[i+2],ol[3]=1,d.transformVec4(w,ol,al),ve.compressPosition(al,z,ol),e[i+0]=ol[0],e[i+1]=ol[1],e[i+2]=ol[2];s.createMesh(m.apply(j,{id:D,origin:V,primitive:L.primitiveName,positions:e,normals:L.geometryNormals,colorsCompressed:L.geometryColors,indices:L.geometryIndices,edgeIndices:L.geometryEdgeIndices,positionsDecodeMatrix:T,color:n,metallic:C,roughness:S,opacity:l})),B.push(D)}else k[A]||(s.createGeometry({id:A,origin:V,primitive:L.primitiveName,positions:L.geometryPositions,normals:L.geometryNormals,colorsCompressed:L.geometryColors,indices:L.geometryIndices,edgeIndices:L.geometryEdgeIndices,positionsDecodeMatrix:g}),k[A]=!0),s.createMesh(m.apply(j,{id:D,geometryId:A,matrix:w,color:n,metallic:C,roughness:S,opacity:l})),B.push(D)}else{let t,e,i,o,d,f,g=!1;switch(v[r]){case 0:t="solid",e=h.subarray(b[r],a?h.length:b[r+1]),i=c.subarray(P[r],a?c.length:P[r+1]),d=p.subarray(M[r],a?p.length:M[r+1]),f=_.subarray(x[r],a?_.length:x[r+1]),g=e.length>0&&d.length>0;break;case 1:t="surface",e=h.subarray(b[r],a?h.length:b[r+1]),i=c.subarray(P[r],a?c.length:P[r+1]),d=p.subarray(M[r],a?p.length:M[r+1]),f=_.subarray(x[r],a?_.length:x[r+1]),g=e.length>0&&d.length>0;break;case 2:t="points",e=h.subarray(b[r],a?h.length:b[r+1]),o=ll(u.subarray(y[r],a?u.length:y[r+1])),g=e.length>0;break;case 3:t="lines",e=h.subarray(b[r],a?h.length:b[r+1]),d=p.subarray(M[r],a?p.length:M[r+1]),g=e.length>0&&d.length>0;break;default:continue}g&&(s.createMesh(m.apply(j,{id:D,origin:V,primitive:t,positions:e,normals:i,colorsCompressed:o,indices:d,edgeIndices:f,positionsDecodeMatrix:T,color:n,metallic:C,roughness:S,opacity:l})),B.push(D))}}B.length>0&&s.createEntity(m.apply(G,{id:n,isObject:!0,meshIds:B}))}}}(t,e,o,s)}};let cl=window.pako||Nn;cl.inflate||(cl=cl.default);const ul=d.vec4(),dl=d.vec4();const pl=function(){const t=new Float32Array(3);return function(e){return t[0]=e[0]/255,t[1]=e[1]/255,t[2]=e[2]/255,t}}();const _l={version:9,parse:function(t,e,i,s){const r=function(t){return{metadata:t[0],positions:t[1],normals:t[2],colors:t[3],indices:t[4],edgeIndices:t[5],matrices:t[6],reusedGeometriesDecodeMatrix:t[7],eachGeometryPrimitiveType:t[8],eachGeometryPositionsPortion:t[9],eachGeometryNormalsPortion:t[10],eachGeometryColorsPortion:t[11],eachGeometryIndicesPortion:t[12],eachGeometryEdgeIndicesPortion:t[13],eachMeshGeometriesPortion:t[14],eachMeshMatricesPortion:t[15],eachMeshMaterial:t[16],eachEntityId:t[17],eachEntityMeshesPortion:t[18],eachTileAABB:t[19],eachTileEntitiesPortion:t[20]}}(i),o=function(t){function e(t,e){return 0===t.length?[]:cl.inflate(t,e).buffer}return{metadata:JSON.parse(cl.inflate(t.metadata,{to:"string"})),positions:new Uint16Array(e(t.positions)),normals:new Int8Array(e(t.normals)),colors:new Uint8Array(e(t.colors)),indices:new Uint32Array(e(t.indices)),edgeIndices:new Uint32Array(e(t.edgeIndices)),matrices:new Float32Array(e(t.matrices)),reusedGeometriesDecodeMatrix:new Float32Array(e(t.reusedGeometriesDecodeMatrix)),eachGeometryPrimitiveType:new Uint8Array(e(t.eachGeometryPrimitiveType)),eachGeometryPositionsPortion:new Uint32Array(e(t.eachGeometryPositionsPortion)),eachGeometryNormalsPortion:new Uint32Array(e(t.eachGeometryNormalsPortion)),eachGeometryColorsPortion:new Uint32Array(e(t.eachGeometryColorsPortion)),eachGeometryIndicesPortion:new Uint32Array(e(t.eachGeometryIndicesPortion)),eachGeometryEdgeIndicesPortion:new Uint32Array(e(t.eachGeometryEdgeIndicesPortion)),eachMeshGeometriesPortion:new Uint32Array(e(t.eachMeshGeometriesPortion)),eachMeshMatricesPortion:new Uint32Array(e(t.eachMeshMatricesPortion)),eachMeshMaterial:new Uint8Array(e(t.eachMeshMaterial)),eachEntityId:JSON.parse(cl.inflate(t.eachEntityId,{to:"string"})),eachEntityMeshesPortion:new Uint32Array(e(t.eachEntityMeshesPortion)),eachTileAABB:new Float64Array(e(t.eachTileAABB)),eachTileEntitiesPortion:new Uint32Array(e(t.eachTileEntitiesPortion))}}(r);!function(t,e,i,s){const r=i.metadata,o=i.positions,a=i.normals,n=i.colors,l=i.indices,h=i.edgeIndices,c=i.matrices,u=i.reusedGeometriesDecodeMatrix,p=i.eachGeometryPrimitiveType,_=i.eachGeometryPositionsPortion,f=i.eachGeometryNormalsPortion,g=i.eachGeometryColorsPortion,v=i.eachGeometryIndicesPortion,b=i.eachGeometryEdgeIndicesPortion,P=i.eachMeshGeometriesPortion,y=i.eachMeshMatricesPortion,M=i.eachMeshMaterial,x=i.eachEntityId,w=i.eachEntityMeshesPortion,E=i.eachTileAABB,A=i.eachTileEntitiesPortion,C=_.length,S=P.length,D=w.length,L=A.length;let B=0;const R=s.id;t.metaScene.metaModels[R]||(t.metaScene.createMetaModel(R,r,{includeTypes:e.includeTypes,excludeTypes:e.excludeTypes,globalizeObjectIds:e.globalizeObjectIds}),s.once("destroyed",(()=>{t.metaScene.destroyMetaModel(R)})));const T=new Uint32Array(C);for(let t=0;t<S;t++){const e=P[t];void 0!==T[e]?T[e]++:T[e]=1}const F=d.vec3(),N=d.AABB3(),I={};for(let i=0;i<L;i++){const r=i===L-1,S=A[i],R=r?D-1:A[i+1]-1,k=6*i,O=E.subarray(k,k+6);d.getAABB3Center(O,F),N[0]=O[0]-F[0],N[1]=O[1]-F[1],N[2]=O[2]-F[2],N[3]=O[3]-F[0],N[4]=O[4]-F[1],N[5]=O[5]-F[2];const V=ve.createPositionsDecodeMatrix(N),z={};for(let r=S;r<=R;r++){const E=x[r],A=e.globalizeObjectIds?d.globalizeObjectId(s.id,E):E,S=r===D-1,L=w[r],R=S?P.length-1:w[r+1]-1,k=[],O=t.metaScene.metaObjects[A],U={},G={};if(O){if(e.excludeTypesMap&&O.type&&e.excludeTypesMap[O.type])continue;if(e.includeTypesMap&&O.type&&!e.includeTypesMap[O.type])continue;const t=e.objectDefaults?e.objectDefaults[O.type]||e.objectDefaults.DEFAULT:null;t&&(!1===t.visible&&(U.visible=!1),!1===t.pickable&&(U.pickable=!1),t.colorize&&(G.color=t.colorize),void 0!==t.opacity&&null!==t.opacity&&(G.opacity=t.opacity),void 0!==t.metallic&&null!==t.metallic&&(G.metallic=t.metallic),void 0!==t.roughness&&null!==t.roughness&&(G.roughness=t.roughness))}else if(e.excludeUnclassifiedObjects)continue;for(let t=L;t<=R;t++){const r=P[t],x=T[r]>1,w=r===C-1,E=pl(M.subarray(6*t,6*t+3)),A=M[6*t+3]/255,S=M[6*t+4]/255,D=M[6*t+5]/255,L=B++;if(x){const P=y[t],M=c.slice(P,P+16),x="geometry."+i+"."+r;let C=I[x];if(!C){C={batchThisMesh:!e.reuseGeometries};let t=!1;switch(p[r]){case 0:C.primitiveName="solid",C.geometryPositions=o.subarray(_[r],w?o.length:_[r+1]),C.geometryNormals=a.subarray(f[r],w?a.length:f[r+1]),C.geometryIndices=l.subarray(v[r],w?l.length:v[r+1]),C.geometryEdgeIndices=h.subarray(b[r],w?h.length:b[r+1]),t=C.geometryPositions.length>0&&C.geometryIndices.length>0;break;case 1:C.primitiveName="surface",C.geometryPositions=o.subarray(_[r],w?o.length:_[r+1]),C.geometryNormals=a.subarray(f[r],w?a.length:f[r+1]),C.geometryIndices=l.subarray(v[r],w?l.length:v[r+1]),C.geometryEdgeIndices=h.subarray(b[r],w?h.length:b[r+1]),t=C.geometryPositions.length>0&&C.geometryIndices.length>0;break;case 2:C.primitiveName="points",C.geometryPositions=o.subarray(_[r],w?o.length:_[r+1]),C.geometryColors=n.subarray(g[r],w?n.length:g[r+1]),t=C.geometryPositions.length>0;break;case 3:C.primitiveName="lines",C.geometryPositions=o.subarray(_[r],w?o.length:_[r+1]),C.geometryIndices=l.subarray(v[r],w?l.length:v[r+1]),t=C.geometryPositions.length>0&&C.geometryIndices.length>0;break;default:continue}if(t||(C=null),C&&(C.geometryPositions.length,C.batchThisMesh)){C.decompressedPositions=new Float32Array(C.geometryPositions.length),C.transformedAndRecompressedPositions=new Uint16Array(C.geometryPositions.length);const t=C.geometryPositions,e=C.decompressedPositions;for(let i=0,s=t.length;i<s;i+=3)e[i+0]=t[i+0]*u[0]+u[12],e[i+1]=t[i+1]*u[5]+u[13],e[i+2]=t[i+2]*u[10]+u[14];C.geometryPositions=null,I[x]=C}}if(C)if(C.batchThisMesh){const t=C.decompressedPositions,e=C.transformedAndRecompressedPositions;for(let i=0,s=t.length;i<s;i+=3)ul[0]=t[i+0],ul[1]=t[i+1],ul[2]=t[i+2],ul[3]=1,d.transformVec4(M,ul,dl),ve.compressPosition(dl,N,ul),e[i+0]=ul[0],e[i+1]=ul[1],e[i+2]=ul[2];s.createMesh(m.apply(G,{id:L,origin:F,primitive:C.primitiveName,positions:e,normals:C.geometryNormals,colorsCompressed:C.geometryColors,indices:C.geometryIndices,edgeIndices:C.geometryEdgeIndices,positionsDecodeMatrix:V,color:E,metallic:S,roughness:D,opacity:A})),k.push(L)}else z[x]||(s.createGeometry({id:x,origin:F,primitive:C.primitiveName,positions:C.geometryPositions,normals:C.geometryNormals,colorsCompressed:C.geometryColors,indices:C.geometryIndices,edgeIndices:C.geometryEdgeIndices,positionsDecodeMatrix:u}),z[x]=!0),s.createMesh(m.apply(G,{id:L,geometryId:x,matrix:M,color:E,metallic:S,roughness:D,opacity:A})),k.push(L)}else{let t,e,i,c,u,d,P=!1;switch(p[r]){case 0:t="solid",e=o.subarray(_[r],w?o.length:_[r+1]),i=a.subarray(f[r],w?a.length:f[r+1]),u=l.subarray(v[r],w?l.length:v[r+1]),d=h.subarray(b[r],w?h.length:b[r+1]),P=e.length>0&&u.length>0;break;case 1:t="surface",e=o.subarray(_[r],w?o.length:_[r+1]),i=a.subarray(f[r],w?a.length:f[r+1]),u=l.subarray(v[r],w?l.length:v[r+1]),d=h.subarray(b[r],w?h.length:b[r+1]),P=e.length>0&&u.length>0;break;case 2:t="points",e=o.subarray(_[r],w?o.length:_[r+1]),c=n.subarray(g[r],w?n.length:g[r+1]),P=e.length>0;break;case 3:t="lines",e=o.subarray(_[r],w?o.length:_[r+1]),u=l.subarray(v[r],w?l.length:v[r+1]),P=e.length>0&&u.length>0;break;default:continue}P&&(s.createMesh(m.apply(G,{id:L,origin:F,primitive:t,positions:e,normals:i,colorsCompressed:c,indices:u,edgeIndices:d,positionsDecodeMatrix:V,color:E,metallic:S,roughness:D,opacity:A})),k.push(L))}}k.length>0&&s.createEntity(m.apply(U,{id:A,isObject:!0,meshIds:k}))}}}(t,e,o,s)}},fl={};fl[On.version]=On,fl[Un.version]=Un,fl[Xn.version]=Xn,fl[Yn.version]=Yn,fl[Zn.version]=Zn,fl[Jn.version]=Jn,fl[sl.version]=sl,fl[hl.version]=hl,fl[_l.version]=_l;class gl extends a{constructor(t,e={}){super("XKTLoader",t,e),this._maxGeometryBatchSize=e.maxGeometryBatchSize,this.dataSource=e.dataSource,this.objectDefaults=e.objectDefaults,this.includeTypes=e.includeTypes,this.excludeTypes=e.excludeTypes,this.excludeUnclassifiedObjects=e.excludeUnclassifiedObjects,this.reuseGeometries=e.reuseGeometries}get supportedVersions(){return Object.keys(fl)}get dataSource(){return this._dataSource}set dataSource(t){this._dataSource=t||new Fn}get objectDefaults(){return this._objectDefaults}set objectDefaults(t){this._objectDefaults=t||yn}get includeTypes(){return this._includeTypes}set includeTypes(t){this._includeTypes=t}get excludeTypes(){return this._excludeTypes}set excludeTypes(t){this._excludeTypes=t}get excludeUnclassifiedObjects(){return this._excludeUnclassifiedObjects}set excludeUnclassifiedObjects(t){this._excludeUnclassifiedObjects=!!t}get globalizeObjectIds(){return this._globalizeObjectIds}set globalizeObjectIds(t){this._globalizeObjectIds=!!t}get reuseGeometries(){return this._reuseGeometries}set reuseGeometries(t){this._reuseGeometries=!1!==t}load(t={}){t.id&&this.viewer.scene.components[t.id]&&(this.error("Component with this ID already exists in viewer: "+t.id+" - will autogenerate this ID"),delete t.id);const e=new Oa(this.viewer.scene,m.apply(t,{isModel:!0,maxGeometryBatchSize:this._maxGeometryBatchSize,origin:t.origin})),i=e.id;if(!t.src&&!t.xkt)return this.error("load() param expected: src or xkt"),e;const s={},r=t.includeTypes||this._includeTypes,o=t.excludeTypes||this._excludeTypes,a=t.objectDefaults||this._objectDefaults;if(s.reuseGeometries=null!==t.reuseGeometries&&void 0!==t.reuseGeometries?t.reuseGeometries:!1!==this._reuseGeometries,r){s.includeTypesMap={};for(let t=0,e=r.length;t<e;t++)s.includeTypesMap[r[t]]=!0}if(o){s.excludeTypesMap={};for(let t=0,e=o.length;t<e;t++)s.excludeTypesMap[o[t]]=!0}if(a&&(s.objectDefaults=a),s.excludeUnclassifiedObjects=void 0!==t.excludeUnclassifiedObjects?!!t.excludeUnclassifiedObjects:this._excludeUnclassifiedObjects,s.globalizeObjectIds=void 0!==t.globalizeObjectIds?!!t.globalizeObjectIds:this._globalizeObjectIds,t.metaModelSrc||t.metaModelData){const a=a=>!!this.viewer.metaScene.createMetaModel(i,a,{includeTypes:r,excludeTypes:o,globalizeObjectIds:this.globalizeObjectIds})&&(t.src?this._loadModel(t.src,t,s,e):this._parseModel(t.xkt,t,s,e),e.once("destroyed",(()=>{this.viewer.metaScene.destroyMetaModel(e.id)})),!0);if(t.metaModelSrc){const s=t.metaModelSrc;this.viewer.scene.canvas.spinner.processes++,this._dataSource.getMetaModel(s,(t=>{e.destroyed||(a(t)||(this.error(`load(): Failed to load model metadata for model '${i} from '${s}' - metadata not valid`),e.fire("error","Metadata not valid")),this.viewer.scene.canvas.spinner.processes--)}),(t=>{this.error(`load(): Failed to load model metadata for model '${i} from  '${s}' - ${t}`),e.fire("error",`Failed to load model metadata from  '${s}' - ${t}`),this.viewer.scene.canvas.spinner.processes--}))}else t.metaModelData&&(a(t.metaModelData)||(this.error(`load(): Failed to load model metadata for model '${i} from '${t.metaModelSrc}' - metadata not valid`),e.fire("error","Metadata not valid")))}else t.src?this._loadModel(t.src,t,s,e):this._parseModel(t.xkt,t,s,e);return e}_loadModel(t,e,i,s){const r=this.viewer.scene.canvas.spinner;r.processes++,this._dataSource.getXKT(e.src,(t=>{this._parseModel(t,e,i,s),r.processes--}),(t=>{r.processes--,this.error(t),s.fire("error",t)}))}_parseModel(t,e,i,s){if(s.destroyed)return;const r=new DataView(t),o=new Uint8Array(t),a=r.getUint32(0,!0),n=fl[a];if(!n)return void this.error("Unsupported .XKT file version: "+a+" - this XKTLoaderPlugin supports versions "+Object.keys(fl));this.log("Loading .xkt V"+a);const l=r.getUint32(4,!0),h=[];let c=4*(l+2);for(let t=0;t<l;t++){const e=r.getUint32(4*(t+2),!0);h.push(o.subarray(c,c+e)),c+=e}n.parse(this.viewer,i,h,s),s.finalize(),this._createDefaultMetaModelIfNeeded(s,e,i),s.scene.once("tick",(()=>{s.destroyed||(s.scene.fire("modelLoaded",s.id),s.fire("loaded",!0,!1))}))}_createDefaultMetaModelIfNeeded(t,e,i){const s=t.id;if(!this.viewer.metaScene.metaModels[s]){const r={metaObjects:[]};r.metaObjects.push({id:s,type:"default",name:s,parent:null});const o=t.entityList;for(let t=0,e=o.length;t<e;t++){const e=o[t];e.isObject&&r.metaObjects.push({id:e.id,type:"default",name:e.id,parent:s})}const a=e.src;this.viewer.metaScene.createMetaModel(s,r,{includeTypes:i.includeTypes,excludeTypes:i.excludeTypes,globalizeObjectIds:i.globalizeObjectIds,getProperties:async t=>await this._dataSource.getProperties(a,t)}),t.once("destroyed",(()=>{this.viewer.metaScene.destroyMetaModel(s)}))}}}class ml{constructor(t={}){this._eventSubIDMap=null,this._eventSubEvents=null,this._eventSubs=null,this._events=null,this._locale="en",this._messages={},this._locales=[],this._locale="en",this.messages=t.messages,this.locale=t.locale}set messages(t){this._messages=t||{},this._locales=Object.keys(this._messages),this.fire("updated",this)}loadMessages(t={}){for(let e in t)this._messages[e]=t[e];this.messages=this._messages}clearMessages(){this.messages={}}get locales(){return this._locales}set locale(t){t=t||"de",this._locale!==t&&(this._locale=t,this.fire("updated",t))}get locale(){return this._locale}translate(t,e){const i=this._messages[this._locale];if(!i)return null;const s=vl(t,i);return s?e?bl(s,e):s:null}translatePlurals(t,e,i){const s=this._messages[this._locale];if(!s)return null;let r=vl(t,s);return r=0===(e=parseInt(""+e,10))?r.zero:e>1?r.other:r.one,r?(r=bl(r,[e]),i&&(r=bl(r,i)),r):null}fire(t,e,i){this._events||(this._events={}),this._eventSubs||(this._eventSubs={}),!0!==i&&(this._events[t]=e||!0);const s=this._eventSubs[t];if(s)for(const t in s)if(s.hasOwnProperty(t)){s[t].callback(e)}}on(e,i){this._events||(this._events={}),this._eventSubIDMap||(this._eventSubIDMap=new t),this._eventSubEvents||(this._eventSubEvents={}),this._eventSubs||(this._eventSubs={});let s=this._eventSubs[e];s||(s={},this._eventSubs[e]=s);const r=this._eventSubIDMap.addItem();s[r]={callback:i},this._eventSubEvents[r]=e;const o=this._events[e];return void 0!==o&&i(o),r}off(t){if(null==t)return;if(!this._eventSubEvents)return;const e=this._eventSubEvents[t];if(e){delete this._eventSubEvents[t];const i=this._eventSubs[e];i&&delete i[t],this._eventSubIDMap.removeItem(t)}}}function vl(t,e){if(e[t])return e[t];const i=t.split(".");let s=e;for(let t=0,e=i.length;s&&t<e;t++){s=s[i[t]]}return s}function bl(t,e=[]){return t.replace(/\{\{|\}\}|\{(\d+)\}/g,(function(t,i){return"{{"===t?"{":"}}"===t?"}":e[i]}))}class Pl extends S{constructor(t,e={}){super(t,e),this.t=e.t}set t(t){t=t||0,this._t=t<0?0:t>1?1:t}get t(){return this._t}get tangent(){return this.getTangent(this._t)}get length(){var t=this._getLengths();return t[t.length-1]}getTangent(t){var e=1e-4;void 0===t&&(t=this._t);var i=t-e,s=t+e;i<0&&(i=0),s>1&&(s=1);var r=this.getPoint(i),o=this.getPoint(s),a=d.subVec3(o,r,[]);return d.normalizeVec3(a,[])}getPointAt(t){var e=this.getUToTMapping(t);return this.getPoint(e)}getPoints(t){t||(t=5);var e,i=[];for(e=0;e<=t;e++)i.push(this.getPoint(e/t));return i}_getLengths(t){if(t||(t=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var e,i,s=[],r=this.getPoint(0),o=0;for(s.push(0),i=1;i<=t;i++)e=this.getPoint(i/t),o+=d.lenVec3(d.subVec3(e,r,[])),s.push(o),r=e;return this.cacheArcLengths=s,s}_updateArcLengths(){this.needsUpdate=!0,this._getLengths()}getUToTMapping(t,e){var i,s=this._getLengths(),r=0,o=s.length;i=e||t*s[o-1];for(var a,n=0,l=o-1;n<=l;)if((a=s[r=Math.floor(n+(l-n)/2)]-i)<0)n=r+1;else{if(!(a>0)){l=r;break}l=r-1}if(s[r=l]===i)return r/(o-1);var h=s[r];return(r+(i-h)/(s[r+1]-h))/(o-1)}}class yl extends Pl{constructor(t,e={}){super(t,e),this.points=e.points,this.t=e.t}set points(t){this._points=t||[]}get points(){return this._points}set t(t){t=t||0,this._t=t<0?0:t>1?1:t}get t(){return this._t}get point(){return this.getPoint(this._t)}getPoint(t){var e=this.points;if(!(e.length<3)){var i=(e.length-1)*t,s=Math.floor(i),r=i-s,o=e[0===s?s:s-1],a=e[s],n=e[s>e.length-2?e.length-1:s+1],l=e[s>e.length-3?e.length-1:s+2],h=d.vec3();return h[0]=d.catmullRomInterpolate(o[0],a[0],n[0],l[0],r),h[1]=d.catmullRomInterpolate(o[1],a[1],n[1],l[1],r),h[2]=d.catmullRomInterpolate(o[2],a[2],n[2],l[2],r),h}this.error("Can't sample point from SplineCurve - not enough points on curve - returning [0,0,0].")}getJSON(){return{points:points,t:this._t}}}const Ml=d.vec3();class xl extends S{get type(){return"CameraPath"}constructor(t,e={}){super(t,e),this._frames=[],this._eyeCurve=new yl(this),this._lookCurve=new yl(this),this._upCurve=new yl(this),e.frames&&(this.addFrames(e.frames),this.smoothFrameTimes(1))}get frames(){return this._frames}get eyeCurve(){return this._eyeCurve}get lookCurve(){return this._lookCurve}get upCurve(){return this._upCurve}saveFrame(t){const e=this.scene.camera;this.addFrame(t,e.eye,e.look,e.up)}addFrame(t,e,i,s){const r={t:t,eye:e.slice(0),look:i.slice(0),up:s.slice(0)};this._frames.push(r),this._eyeCurve.points.push(r.eye),this._lookCurve.points.push(r.look),this._upCurve.points.push(r.up)}addFrames(t){let e;for(let i=0,s=t.length;i<s;i++)e=t[i],this.addFrame(e.t||0,e.eye,e.look,e.up)}loadFrame(t){const e=this.scene.camera;t=(t/=this._frames[this._frames.length-1].t-this._frames[0].t)<0?0:t>1?1:t,e.eye=this._eyeCurve.getPoint(t,Ml),e.look=this._lookCurve.getPoint(t,Ml),e.up=this._upCurve.getPoint(t,Ml)}sampleFrame(t,e,i,s){t=t<0?0:t>1?1:t,this._eyeCurve.getPoint(t,e),this._lookCurve.getPoint(t,i),this._upCurve.getPoint(t,s)}smoothFrameTimes(t){if(0===this._frames.length)return;const e=d.vec3();var i=0;this._frames[0].t=0;const s=[];for(let t=1,o=this._frames.length;t<o;t++){var r=d.lenVec3(d.subVec3(this._frames[t].eye,this._frames[t-1].eye,e));s[t]=r,i+=r}for(let e=1,r=this._frames.length;e<r;e++){const r=s[e]/i*t;this._frames[e].t=this._frames[e-1].t+r}}clearFrames(){this._frames=[],this._eyeCurve.points=[],this._lookCurve.points=[],this._upCurve.points=[]}}const wl=d.vec3(),El=d.vec3(),Al=d.vec3(),Cl=d.vec3(),Sl=d.vec3();class Dl extends S{get type(){return"CameraFlightAnimation"}constructor(t,e={}){super(t,e),this._look1=d.vec3(),this._eye1=d.vec3(),this._up1=d.vec3(),this._look2=d.vec3(),this._eye2=d.vec3(),this._up2=d.vec3(),this._orthoScale1=1,this._orthoScale2=1,this._flying=!1,this._flyEyeLookUp=!1,this._flyingEye=!1,this._flyingLook=!1,this._callback=null,this._callbackScope=null,this._time1=null,this._time2=null,this.easing=!1!==e.easing,this.duration=e.duration,this.fit=e.fit,this.fitFOV=e.fitFOV,this.trail=e.trail}flyTo(t,e,i){t=t||this.scene,this._flying&&this.stop(),this._flying=!1,this._flyingEye=!1,this._flyingLook=!1,this._flyingEyeLookUp=!1,this._callback=e,this._callbackScope=i;const s=this.scene.camera,r=!!t.projection&&t.projection!==s.projection;let o,a,n,l,h;if(this._eye1[0]=s.eye[0],this._eye1[1]=s.eye[1],this._eye1[2]=s.eye[2],this._look1[0]=s.look[0],this._look1[1]=s.look[1],this._look1[2]=s.look[2],this._up1[0]=s.up[0],this._up1[1]=s.up[1],this._up1[2]=s.up[2],this._orthoScale1=s.ortho.scale,this._orthoScale2=t.orthoScale||this._orthoScale1,t.aabb)o=t.aabb;else if(6===t.length)o=t;else if(t.eye&&t.look||t.up)a=t.eye,n=t.look,l=t.up;else if(t.eye)a=t.eye;else if(t.look)n=t.look;else{let s=t;if((m.isNumeric(s)||m.isString(s))&&(h=s,s=this.scene.components[h],!s))return this.error("Component not found: "+m.inQuotes(h)),void(e&&(i?e.call(i):e()));r||(o=s.aabb||this.scene.aabb)}const c=t.poi;if(o){if(o[3]<o[0]||o[4]<o[1]||o[5]<o[2])return;if(o[3]===o[0]&&o[4]===o[1]&&o[5]===o[2])return;o=o.slice();const e=d.getAABB3Center(o);this._look2=c||e;const i=d.subVec3(this._eye1,this._look1,wl),s=d.normalizeVec3(i),r=c?d.getAABB3DiagPoint(o,c):d.getAABB3Diag(o),a=t.fitFOV||this._fitFOV,n=Math.abs(r/Math.tan(a*d.DEGTORAD));this._orthoScale2=1.1*r,this._eye2[0]=this._look2[0]+s[0]*n,this._eye2[1]=this._look2[1]+s[1]*n,this._eye2[2]=this._look2[2]+s[2]*n,this._up2[0]=this._up1[0],this._up2[1]=this._up1[1],this._up2[2]=this._up1[2],this._flyingEyeLookUp=!0}else(a||n||l)&&(this._flyingEyeLookUp=!!a&&!!n&&!!l,this._flyingEye=!!a&&!n,this._flyingLook=!!n&&!a,a&&(this._eye2[0]=a[0],this._eye2[1]=a[1],this._eye2[2]=a[2]),n&&(this._look2[0]=n[0],this._look2[1]=n[1],this._look2[2]=n[2]),l&&(this._up2[0]=l[0],this._up2[1]=l[1],this._up2[2]=l[2]));r?("ortho"===t.projection&&"ortho"!==s.projection&&(this._projection2="ortho",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.ortho.matrix.slice(),s.projection="customProjection"),"perspective"===t.projection&&"perspective"!==s.projection&&(this._projection2="perspective",this._projMatrix1=s.projMatrix.slice(),this._projMatrix2=s.perspective.matrix.slice(),s.projection="customProjection")):this._projection2=null,this.fire("started",t,!0),this._time1=Date.now(),this._time2=this._time1+(t.duration?1e3*t.duration:this._duration),this._flying=!0,A.scheduleTask(this._update,this)}jumpTo(t){this._jumpTo(t)}_jumpTo(t){this._flying&&this.stop();const e=this.scene.camera;var i,s,r,o,a;if(t.aabb)i=t.aabb;else if(6===t.length)i=t;else if(t.eye||t.look||t.up)r=t.eye,o=t.look,a=t.up;else{let e=t;if((m.isNumeric(e)||m.isString(e))&&(s=e,e=this.scene.components[s],!e))return void this.error("Component not found: "+m.inQuotes(s));i=e.aabb||this.scene.aabb}const n=t.poi;if(i){if(i[3]<=i[0]||i[4]<=i[1]||i[5]<=i[2])return;var l=n?d.getAABB3DiagPoint(i,n):d.getAABB3Diag(i);let s;o=n||d.getAABB3Center(i,o),this._trail?d.subVec3(e.look,o,Sl):d.subVec3(e.eye,e.look,Sl),d.normalizeVec3(Sl);s=(void 0!==t.fit?t.fit:this._fit)?Math.abs(l/Math.tan((t.fitFOV||this._fitFOV)*d.DEGTORAD)):d.lenVec3(d.subVec3(e.eye,e.look,wl)),d.mulVec3Scalar(Sl,s),e.eye=d.addVec3(o,Sl,wl),e.look=o,this.scene.camera.ortho.scale=1.1*l}else(r||o||a)&&(r&&(e.eye=r),o&&(e.look=o),a&&(e.up=a));t.projection&&(e.projection=t.projection)}_update(){if(!this._flying)return;let t=(Date.now()-this._time1)/(this._time2-this._time1);const e=t>=1;t>1&&(t=1);const i=this.easing?Dl._ease(t,0,1,1):t,s=this.scene.camera;if(this._flyingEye||this._flyingLook?this._flyingEye?(d.subVec3(s.eye,s.look,Sl),s.eye=d.lerpVec3(i,0,1,this._eye1,this._eye2,Al),s.look=d.subVec3(Al,Sl,El)):this._flyingLook&&(s.look=d.lerpVec3(i,0,1,this._look1,this._look2,El),s.up=d.lerpVec3(i,0,1,this._up1,this._up2,Cl)):this._flyingEyeLookUp&&(s.eye=d.lerpVec3(i,0,1,this._eye1,this._eye2,Al),s.look=d.lerpVec3(i,0,1,this._look1,this._look2,El),s.up=d.lerpVec3(i,0,1,this._up1,this._up2,Cl)),this._projection2){const e="ortho"===this._projection2?Dl._easeOutExpo(t,0,1,1):Dl._easeInCubic(t,0,1,1);s.customProjection.matrix=d.lerpMat4(e,0,1,this._projMatrix1,this._projMatrix2)}else s.ortho.scale=this._orthoScale1+t*(this._orthoScale2-this._orthoScale1);if(e)return s.ortho.scale=this._orthoScale2,void this.stop();A.scheduleTask(this._update,this)}static _ease(t,e,i,s){return-i*(t/=s)*(t-2)+e}static _easeInCubic(t,e,i,s){return i*(t/=s)*t*t+e}static _easeOutExpo(t,e,i,s){return i*(1-Math.pow(2,-10*t/s))+e}stop(){if(!this._flying)return;this._flying=!1,this._time1=null,this._time2=null,this._projection2&&(this.scene.camera.projection=this._projection2);const t=this._callback;t&&(this._callback=null,this._callbackScope?t.call(this._callbackScope):t()),this.fire("stopped",!0,!0)}cancel(){this._flying&&(this._flying=!1,this._time1=null,this._time2=null,this._callback&&(this._callback=null),this.fire("canceled",!0,!0))}set duration(t){this._duration=t?1e3*t:500,this.stop()}get duration(){return this._duration/1e3}set fit(t){this._fit=!1!==t}get fit(){return this._fit}set fitFOV(t){this._fitFOV=t||45}get fitFOV(){return this._fitFOV}set trail(t){this._trail=!!t}get trail(){return this._trail}destroy(){this.stop(),super.destroy()}}class Ll extends S{get type(){return"CameraPathAnimation"}constructor(t,e={}){super(t,e),this._cameraFlightAnimation=new Dl(this),this._t=0,this.state=Ll.SCRUBBING,this._playingFromT=0,this._playingToT=0,this._playingRate=e.playingRate||1,this._playingDir=1,this._lastTime=null,this.cameraPath=e.cameraPath,this._tick=this.scene.on("tick",this._updateT,this)}_updateT(){const t=this._cameraPath;if(!t)return;let e,i;const s=performance.now(),r=this._lastTime?.001*(s-this._lastTime):0;if(this._lastTime=s,0!==r)switch(this.state){case Ll.SCRUBBING:return;case Ll.PLAYING:if(this._t+=this._playingRate*r,e=this._cameraPath.frames.length,0===e||this._playingDir<0&&this._t<=0||this._playingDir>0&&this._t>=this._cameraPath.frames[e-1].t)return this.state=Ll.SCRUBBING,this._t=this._cameraPath.frames[e-1].t,void this.fire("stopped");t.loadFrame(this._t);break;case Ll.PLAYING_TO:i=this._t+this._playingRate*r*this._playingDir,(this._playingDir<0&&i<=this._playingToT||this._playingDir>0&&i>=this._playingToT)&&(i=this._playingToT,this.state=Ll.SCRUBBING,this.fire("stopped")),this._t=i,t.loadFrame(this._t)}}_ease(t,e,i,s){return-i*(t/=s)*(t-2)+e}set cameraPath(t){this._cameraPath=t}get cameraPath(){return this._cameraPath}set rate(t){this._playingRate=t}get rate(){return this._playingRate}play(){this._cameraPath&&(this._lastTime=null,this.state=Ll.PLAYING)}playToT(t){this._cameraPath&&(this._playingFromT=this._t,this._playingToT=t,this._playingDir=this._playingToT-this._playingFromT<0?-1:1,this._lastTime=null,this.state=Ll.PLAYING_TO)}playToFrame(t){const e=this._cameraPath;if(!e)return;const i=e.frames[t];i?this.playToT(i.t):this.error("playToFrame - frame index out of range: "+t)}flyToFrame(t,e){const i=this._cameraPath;if(!i)return;const s=i.frames[t];s?(this.state=Ll.SCRUBBING,this._cameraFlightAnimation.flyTo(s,e)):this.error("flyToFrame - frame index out of range: "+t)}scrubToT(t){const e=this._cameraPath;if(!e)return;this.scene.camera&&(this._t=t,e.loadFrame(this._t),this.state=Ll.SCRUBBING)}scrubToFrame(t){const e=this._cameraPath;if(!e)return;if(!this.scene.camera)return;e.frames[t]?(e.loadFrame(this._t),this.state=Ll.SCRUBBING):this.error("playToFrame - frame index out of range: "+t)}stop(){this.state=Ll.SCRUBBING,this.fire("stopped")}destroy(){super.destroy(),this.scene.off(this._tick)}}Ll.STOPPED=0,Ll.SCRUBBING=1,Ll.PLAYING=2,Ll.PLAYING_TO=3;var Bl={};function Rl(t,e={}){return new Promise((function(i,s){e.src||(console.error("load3DSGeometry: Parameter expected: src"),s());var r=t.canvas.spinner;r.processes++,m.loadArraybuffer(e.src,(function(t){t.byteLength||(console.error("load3DSGeometry: no data loaded"),r.processes--,s());var o=Bl.parse.from3DS(t).edit.objects[0].mesh,a=o.vertices,n=o.uvt,l=o.indices;r.processes--,i(m.apply(e,{primitive:"triangles",positions:a,normals:null,uv:n,indices:l}))}),(function(t){console.error("load3DSGeometry: "+t),r.processes--,s()}))}))}function Tl(t,e={}){return new Promise((function(i,s){e.src||(console.error("loadOBJGeometry: Parameter expected: src"),s());var r=t.canvas.spinner;r.processes++,m.loadArraybuffer(e.src,(function(t){t.byteLength||(console.error("loadOBJGeometry: no data loaded"),r.processes--,s());for(var o=Bl.parse.fromOBJ(t),a=Bl.edit.unwrap(o.i_verts,o.c_verts,3),n=Bl.edit.unwrap(o.i_norms,o.c_norms,3),l=Bl.edit.unwrap(o.i_uvt,o.c_uvt,2),h=new Int32Array(o.i_verts.length),c=0;c<o.i_verts.length;c++)h[c]=c;r.processes--,i(m.apply(e,{primitive:"triangles",positions:a,normals:n.length>0?n:null,autoNormals:0===n.length,uv:l,indices:h}))}),(function(t){console.error("loadOBJGeometry: "+t),r.processes--,s()}))}))}function Fl(t={}){let e=t.xSize||1;e<0&&(console.error("negative xSize not allowed - will invert"),e*=-1);let i=t.ySize||1;i<0&&(console.error("negative ySize not allowed - will invert"),i*=-1);let s=t.zSize||1;s<0&&(console.error("negative zSize not allowed - will invert"),s*=-1);const r=t.center,o=r?r[0]:0,a=r?r[1]:0,n=r?r[2]:0,l=-e+o,h=-i+a,c=-s+n,u=e+o,d=i+a,p=s+n;return m.apply(t,{primitive:"lines",positions:[l,h,c,l,h,p,l,d,c,l,d,p,u,h,c,u,h,p,u,d,c,u,d,p],indices:[0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,2,6,3,7]})}function Nl(t={}){let e=t.size||1;e<0&&(console.error("negative size not allowed - will invert"),e*=-1);let i=t.divisions||1;i<0&&(console.error("negative divisions not allowed - will invert"),i*=-1),i<1&&(i=1),e=e||10,i=i||10;const s=e/i,r=e/2,o=[],a=[];let n=0;for(let t=0,e=-r;t<=i;t++,e+=s)o.push(-r),o.push(0),o.push(e),o.push(r),o.push(0),o.push(e),o.push(e),o.push(0),o.push(-r),o.push(e),o.push(0),o.push(r),a.push(n++),a.push(n++),a.push(n++),a.push(n++);return m.apply(t,{primitive:"lines",positions:o,indices:a})}function Il(t={}){let e=t.xSize||1;e<0&&(console.error("negative xSize not allowed - will invert"),e*=-1);let i=t.zSize||1;i<0&&(console.error("negative zSize not allowed - will invert"),i*=-1);let s=t.xSegments||1;s<0&&(console.error("negative xSegments not allowed - will invert"),s*=-1),s<1&&(s=1);let r=t.xSegments||1;r<0&&(console.error("negative zSegments not allowed - will invert"),r*=-1),r<1&&(r=1);const o=t.center,a=o?o[0]:0,n=o?o[1]:0,l=o?o[2]:0,h=e/2,c=i/2,u=Math.floor(s)||1,d=Math.floor(r)||1,p=u+1,_=d+1,f=e/u,g=i/d,v=new Float32Array(p*_*3),b=new Float32Array(p*_*3),P=new Float32Array(p*_*2);let y,M,x,w,E,A,C,S=0,D=0;for(y=0;y<_;y++){const t=y*g-c;for(M=0;M<p;M++)x=M*f-h,v[S]=x+a,v[S+1]=n,v[S+2]=-t+l,b[S+2]=-1,P[D]=M/u,P[D+1]=(d-y)/d,S+=3,D+=2}S=0;const L=new(v.length/3>65535?Uint32Array:Uint16Array)(u*d*6);for(y=0;y<d;y++)for(M=0;M<u;M++)w=M+p*y,E=M+p*(y+1),A=M+1+p*(y+1),C=M+1+p*y,L[S]=C,L[S+1]=E,L[S+2]=w,L[S+3]=C,L[S+4]=A,L[S+5]=E,S+=6;return m.apply(t,{positions:v,normals:b,uv:P,indices:L})}Bl.load=function(t,e){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(t){e(t.target.response)},i.send()},Bl.save=function(t,e){var i="data:application/octet-stream;base64,"+btoa(Bl.parse._buffToStr(t));window.location.href=i},Bl.clone=function(t){return JSON.parse(JSON.stringify(t))},Bl.bin={},Bl.bin.f=new Float32Array(1),Bl.bin.fb=new Uint8Array(Bl.bin.f.buffer),Bl.bin.rf=function(t,e){for(var i=Bl.bin.f,s=Bl.bin.fb,r=0;r<4;r++)s[r]=t[e+r];return i[0]},Bl.bin.rsl=function(t,e){return t[e]|t[e+1]<<8},Bl.bin.ril=function(t,e){return t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24},Bl.bin.rASCII0=function(t,e){for(var i="";0!=t[e];)i+=String.fromCharCode(t[e++]);return i},Bl.bin.wf=function(t,e,i){new Float32Array(t.buffer,e,1)[0]=i},Bl.bin.wsl=function(t,e,i){t[e]=i,t[e+1]=i>>8},Bl.bin.wil=function(t,e,i){t[e]=i,t[e+1]=i>>8,t[e+2]=i>>16,t[e+3]},Bl.parse={},Bl.parse._buffToStr=function(t){for(var e=new Uint8Array(t),i="",s=0;s<e.length;s++)i=i.concat(String.fromCharCode(e[s]));return i},Bl.parse._strToBuff=function(t){for(var e=new ArrayBuffer(t.length),i=new Uint8Array(e),s=0;s<t.length;s++)i[s]=t.charCodeAt(s);return e},Bl.parse._readLine=function(t,e){for(var i="";10!=t[e];)i+=String.fromCharCode(t[e++]);return i},Bl.parse.fromJSON=function(t){return JSON.parse(Bl.parse._buffToStr(t))},Bl.parse.toJSON=function(t){var e=JSON.stringify(t);return Bl.parse._strToBuff(e)},Bl.parse.fromOBJ=function(t){for(var e={groups:{},c_verts:[],c_uvt:[],c_norms:[],i_verts:[],i_uvt:[],i_norms:[]},i={from:0,to:0},s=0,r=new Uint8Array(t);s<r.length;){var o=Bl.parse._readLine(r,s);s+=o.length+1;var a=(o=(o=o.replace(/ +(?= )/g,"")).replace(/(^\s+|\s+$)/g,"")).split(" ");if("g"==a[0]&&(i.to=e.i_verts.length,null==e.groups[a[1]]&&(e.groups[a[1]]={from:e.i_verts.length,to:0}),i=e.groups[a[1]]),"v"==a[0]){var n=parseFloat(a[1]),l=parseFloat(a[2]),h=parseFloat(a[3]);e.c_verts.push(n,l,h)}if("vt"==a[0]){n=parseFloat(a[1]),l=1-parseFloat(a[2]);e.c_uvt.push(n,l)}if("vn"==a[0]){n=parseFloat(a[1]),l=parseFloat(a[2]),h=parseFloat(a[3]);e.c_norms.push(n,l,h)}if("f"==a[0]){var c=a[1].split("/"),u=a[2].split("/"),d=a[3].split("/"),p=parseInt(c[0])-1,_=parseInt(u[0])-1,f=parseInt(d[0])-1,g=parseInt(c[1])-1,m=parseInt(u[1])-1,v=parseInt(d[1])-1,b=parseInt(c[2])-1,P=parseInt(u[2])-1,y=parseInt(d[2])-1,M=e.c_verts.length/3,x=e.c_uvt.length/2,w=e.c_norms.length/3;if(p<0&&(p=M+p+1),_<0&&(_=M+_+1),f<0&&(f=M+f+1),g<0&&(g=x+g+1),m<0&&(m=x+m+1),v<0&&(v=x+v+1),b<0&&(b=w+b+1),P<0&&(P=w+P+1),y<0&&(y=w+y+1),e.i_verts.push(p,_,f),e.i_uvt.push(g,m,v),e.i_norms.push(b,P,y),5==a.length){var E=a[4].split("/"),A=parseInt(E[0])-1,C=parseInt(E[1])-1,S=parseInt(E[2])-1;A<0&&(A=M+A+1),C<0&&(C=x+C+1),S<0&&(S=w+S+1),e.i_verts.push(p,f,A),e.i_uvt.push(g,v,C),e.i_norms.push(b,y,S)}}}return i.to=e.i_verts.length,e},Bl.parse.fromMD2=function(t){t=new Uint8Array(t);var e={},i={};i.ident=Bl.bin.ril(t,0),i.version=Bl.bin.ril(t,4),i.skinwidth=Bl.bin.ril(t,8),i.skinheight=Bl.bin.ril(t,12),i.framesize=Bl.bin.ril(t,16),i.num_skins=Bl.bin.ril(t,20),i.num_vertices=Bl.bin.ril(t,24),i.num_st=Bl.bin.ril(t,28),i.num_tris=Bl.bin.ril(t,32),i.num_glcmds=Bl.bin.ril(t,36),i.num_frames=Bl.bin.ril(t,40),i.offset_skins=Bl.bin.ril(t,44),i.offset_st=Bl.bin.ril(t,48),i.offset_tris=Bl.bin.ril(t,52),i.offset_frames=Bl.bin.ril(t,56),i.offset_glcmds=Bl.bin.ril(t,60),i.offset_end=Bl.bin.ril(t,64);var s=i.offset_st;e.c_uvt=[];for(var r=0;r<i.num_st;r++){var o=Bl.bin.rsl(t,s)/i.skinwidth,a=Bl.bin.rsl(t,s+2)/i.skinheight;e.c_uvt.push(o,a),s+=4}s=i.offset_tris;var n=[],l=[];e.i_verts=n,e.i_uvt=l;for(r=0;r<i.num_tris;r++)n.push(Bl.bin.rsl(t,s),Bl.bin.rsl(t,s+2),Bl.bin.rsl(t,s+4)),l.push(Bl.bin.rsl(t,s+6),Bl.bin.rsl(t,s+8),Bl.bin.rsl(t,s+10)),s+=12;s=i.offset_skins;e.skins=[];for(r=0;r<i.num_skins;r++)e.skins.push(Bl.bin.rASCII0(t,s)),s+=64;s=i.offset_frames;e.frames=[];var h=Bl.parse.fromMD2._normals;for(r=0;r<i.num_frames;r++){var c={},u=Bl.bin.rf(t,s),d=Bl.bin.rf(t,s+4),p=Bl.bin.rf(t,s+8);s+=12;var _=Bl.bin.rf(t,s),f=Bl.bin.rf(t,s+4),g=Bl.bin.rf(t,s+8);s+=12,c.name=Bl.bin.rASCII0(t,s),s+=16,c.verts=[],c.norms=[];for(var m=0;m<i.num_vertices;m++)c.verts.push(t[s]*u+_,t[s+1]*d+f,t[s+2]*p+g),c.norms.push(h[3*t[s+3]],h[3*t[s+3]+1],h[3*t[s+3]+2]),s+=4;e.frames.push(c)}return e},Bl.parse.fromMD2._normals=[-.525731,0,.850651,-.442863,.238856,.864188,-.295242,0,.955423,-.309017,.5,.809017,-.16246,.262866,.951056,0,0,1,0,.850651,.525731,-.147621,.716567,.681718,.147621,.716567,.681718,0,.525731,.850651,.309017,.5,.809017,.525731,0,.850651,.295242,0,.955423,.442863,.238856,.864188,.16246,.262866,.951056,-.681718,.147621,.716567,-.809017,.309017,.5,-.587785,.425325,.688191,-.850651,.525731,0,-.864188,.442863,.238856,-.716567,.681718,.147621,-.688191,.587785,.425325,-.5,.809017,.309017,-.238856,.864188,.442863,-.425325,.688191,.587785,-.716567,.681718,-.147621,-.5,.809017,-.309017,-.525731,.850651,0,0,.850651,-.525731,-.238856,.864188,-.442863,0,.955423,-.295242,-.262866,.951056,-.16246,0,1,0,0,.955423,.295242,-.262866,.951056,.16246,.238856,.864188,.442863,.262866,.951056,.16246,.5,.809017,.309017,.238856,.864188,-.442863,.262866,.951056,-.16246,.5,.809017,-.309017,.850651,.525731,0,.716567,.681718,.147621,.716567,.681718,-.147621,.525731,.850651,0,.425325,.688191,.587785,.864188,.442863,.238856,.688191,.587785,.425325,.809017,.309017,.5,.681718,.147621,.716567,.587785,.425325,.688191,.955423,.295242,0,1,0,0,.951056,.16246,.262866,.850651,-.525731,0,.955423,-.295242,0,.864188,-.442863,.238856,.951056,-.16246,.262866,.809017,-.309017,.5,.681718,-.147621,.716567,.850651,0,.525731,.864188,.442863,-.238856,.809017,.309017,-.5,.951056,.16246,-.262866,.525731,0,-.850651,.681718,.147621,-.716567,.681718,-.147621,-.716567,.850651,0,-.525731,.809017,-.309017,-.5,.864188,-.442863,-.238856,.951056,-.16246,-.262866,.147621,.716567,-.681718,.309017,.5,-.809017,.425325,.688191,-.587785,.442863,.238856,-.864188,.587785,.425325,-.688191,.688191,.587785,-.425325,-.147621,.716567,-.681718,-.309017,.5,-.809017,0,.525731,-.850651,-.525731,0,-.850651,-.442863,.238856,-.864188,-.295242,0,-.955423,-.16246,.262866,-.951056,0,0,-1,.295242,0,-.955423,.16246,.262866,-.951056,-.442863,-.238856,-.864188,-.309017,-.5,-.809017,-.16246,-.262866,-.951056,0,-.850651,-.525731,-.147621,-.716567,-.681718,.147621,-.716567,-.681718,0,-.525731,-.850651,.309017,-.5,-.809017,.442863,-.238856,-.864188,.16246,-.262866,-.951056,.238856,-.864188,-.442863,.5,-.809017,-.309017,.425325,-.688191,-.587785,.716567,-.681718,-.147621,.688191,-.587785,-.425325,.587785,-.425325,-.688191,0,-.955423,-.295242,0,-1,0,.262866,-.951056,-.16246,0,-.850651,.525731,0,-.955423,.295242,.238856,-.864188,.442863,.262866,-.951056,.16246,.5,-.809017,.309017,.716567,-.681718,.147621,.525731,-.850651,0,-.238856,-.864188,-.442863,-.5,-.809017,-.309017,-.262866,-.951056,-.16246,-.850651,-.525731,0,-.716567,-.681718,-.147621,-.716567,-.681718,.147621,-.525731,-.850651,0,-.5,-.809017,.309017,-.238856,-.864188,.442863,-.262866,-.951056,.16246,-.864188,-.442863,.238856,-.809017,-.309017,.5,-.688191,-.587785,.425325,-.681718,-.147621,.716567,-.442863,-.238856,.864188,-.587785,-.425325,.688191,-.309017,-.5,.809017,-.147621,-.716567,.681718,-.425325,-.688191,.587785,-.16246,-.262866,.951056,.442863,-.238856,.864188,.16246,-.262866,.951056,.309017,-.5,.809017,.147621,-.716567,.681718,0,-.525731,.850651,.425325,-.688191,.587785,.587785,-.425325,.688191,.688191,-.587785,.425325,-.955423,.295242,0,-.951056,.16246,.262866,-1,0,0,-.850651,0,.525731,-.955423,-.295242,0,-.951056,-.16246,.262866,-.864188,.442863,-.238856,-.951056,.16246,-.262866,-.809017,.309017,-.5,-.864188,-.442863,-.238856,-.951056,-.16246,-.262866,-.809017,-.309017,-.5,-.681718,.147621,-.716567,-.681718,-.147621,-.716567,-.850651,0,-.525731,-.688191,.587785,-.425325,-.587785,.425325,-.688191,-.425325,.688191,-.587785,-.425325,-.688191,-.587785,-.587785,-.425325,-.688191,-.688191,-.587785,-.425325],Bl.parse.fromCollada=function(t){var e=Bl.parse._buffToStr(t),i=(new DOMParser).parseFromString(e,"text/xml"),s={},r=(i=i.childNodes[0]).getElementsByTagName("asset")[0],o=i.getElementsByTagName("library_geometries")[0],a=i.getElementsByTagName("library_images")[0],n=i.getElementsByTagName("library_materials")[0],l=i.getElementsByTagName("library_effects")[0];return r&&(s.asset=Bl.parse.fromCollada._asset(r)),o&&(s.geometries=Bl.parse.fromCollada._libGeometries(o)),a&&(s.images=Bl.parse.fromCollada._libImages(a)),n&&(s.materials=Bl.parse.fromCollada._libMaterials(n)),l&&(s.effects=Bl.parse.fromCollada._libEffects(l)),s},Bl.parse.fromCollada._asset=function(t){return{created:t.getElementsByTagName("created")[0].textContent,modified:t.getElementsByTagName("modified")[0].textContent,up_axis:t.getElementsByTagName("up_axis")[0].textContent}},Bl.parse.fromCollada._libGeometries=function(t){t=t.getElementsByTagName("geometry");for(var e=[],i=0;i<t.length;i++){var s=t[i],r=Bl.parse.fromCollada._getMesh(s.getElementsByTagName("mesh")[0]);e.push(r)}return e},Bl.parse.fromCollada._getMesh=function(t){for(var e={},i=t.getElementsByTagName("source"),s=e.sources={},r=0;r<i.length;r++){for(var o=i[r].getElementsByTagName("float_array")[0].textContent.split(" "),a=o.length-(""==o[o.length-1]?1:0),n=new Array(a),l=0;l<a;l++)n[l]=parseFloat(o[l]);s[i[r].getAttribute("id")]=n}e.triangles=[];var h=t.getElementsByTagName("triangles");if(null==h)return e;for(r=0;r<h.length;r++){var c={},u=h[r];c.material=u.getAttribute("material");var d=u.getElementsByTagName("input"),p=[];for(l=0;l<d.length;l++){var _=d[l];n=[];p[parseInt(_.getAttribute("offset"))]=n;var f=_.getAttribute("semantic");c["s_"+f]="VERTEX"==f?t.getElementsByTagName("vertices")[0].getElementsByTagName("input")[0].getAttribute("source").substring(1):_.getAttribute("source").substring(1),c["i_"+f]=n,s[c["s_"+f]]}var g=u.getElementsByTagName("p")[0].textContent.split(" "),m=3*Math.floor(g.length/3);for(l=0;l<m;l++)p[l%d.length].push(parseInt(g[l]));e.triangles.push(c)}return e},Bl.parse.fromCollada._libImages=function(t){t=t.getElementsByTagName("image");for(var e={},i=0;i<t.length;i++)e[t[i].getAttribute("id")]=t[i].getElementsByTagName("init_from")[0].textContent;return e},Bl.parse.fromCollada._libMaterials=function(t){t=t.getElementsByTagName("material");for(var e={},i=0;i<t.length;i++)e[t[i].getAttribute("name")]=t[i].getElementsByTagName("instance_effect")[0].getAttribute("url").substring(1);return e},Bl.parse.fromCollada._libEffects=function(t){t=t.getElementsByTagName("effect");for(var e={},i=0;i<t.length;i++){for(var s={},r=t[i].getElementsByTagName("newparam"),o=0;o<r.length;o++){var a=r[o].getElementsByTagName("surface")[0];a&&(s.surface=a.getElementsByTagName("init_from")[0].textContent)}e[t[i].getAttribute("id")]=s}return e},Bl.parse.from3DS=function(t){t=new Uint8Array(t);var e={};if(19789!=Bl.bin.rsl(t,0))return null;for(var i=Bl.bin.ril(t,2),s=6;s<i;){var r=Bl.bin.rsl(t,s),o=Bl.bin.ril(t,s+2);15677==r&&(e.edit=Bl.parse.from3DS._edit3ds(t,s,o)),45056==r&&(e.keyf=Bl.parse.from3DS._keyf3ds(t,s,o)),s+=o}return e},Bl.parse.from3DS._edit3ds=function(t,e,i){for(var s={},r=e+6;r<e+i;){var o=Bl.bin.rsl(t,r),a=Bl.bin.ril(t,r+2);16384==o&&(null==s.objects&&(s.objects=[]),s.objects.push(Bl.parse.from3DS._edit_object(t,r,a))),r+=a}return s},Bl.parse.from3DS._keyf3ds=function(t,e,i){for(var s={},r=e+6;r<e+i;){var o=Bl.bin.rsl(t,r),a=Bl.bin.ril(t,r+2);45058==o&&(null==s.desc&&(s.desc=[]),s.desc.push(Bl.parse.from3DS._keyf_objdes(t,r,a))),r+=a}return s},Bl.parse.from3DS._keyf_objdes=function(t,e,i){for(var s={},r=e+6;r<e+i;){var o=Bl.bin.rsl(t,r),a=Bl.bin.ril(t,r+2);45072==o&&(s.hierarchy=Bl.parse.from3DS._keyf_objhierarch(t,r,a)),45073==o&&(s.dummy_name=Bl.bin.rASCII0(t,r+6)),r+=a}return s},Bl.parse.from3DS._keyf_objhierarch=function(t,e,i){var s={},r=e+6;return s.name=Bl.bin.rASCII0(t,r),r+=s.name.length+1,s.hierarchy=Bl.bin.rsl(t,r+4),s},Bl.parse.from3DS._edit_object=function(t,e,i){var s={},r=e+6;for(s.name=Bl.bin.rASCII0(t,r),r+=s.name.length+1;r<e+i;){var o=Bl.bin.rsl(t,r),a=Bl.bin.ril(t,r+2);16640==o&&(s.mesh=Bl.parse.from3DS._obj_trimesh(t,r,a)),r+=a}return s},Bl.parse.from3DS._obj_trimesh=function(t,e,i){for(var s={},r=e+6;r<e+i;){var o=Bl.bin.rsl(t,r),a=Bl.bin.ril(t,r+2);16656==o&&(s.vertices=Bl.parse.from3DS._tri_vertexl(t,r,a)),16672==o&&(s.indices=Bl.parse.from3DS._tri_facel1(t,r,a)),16704==o&&(s.uvt=Bl.parse.from3DS._tri_mappingcoors(t,r,a)),16736==o&&(s.local=Bl.parse.from3DS._tri_local(t,r,a)),r+=a}return s},Bl.parse.from3DS._tri_vertexl=function(t,e,i){var s=[],r=e+6,o=Bl.bin.rsl(t,r);r+=2;for(var a=0;a<o;a++)s.push(Bl.bin.rf(t,r)),s.push(Bl.bin.rf(t,r+4)),s.push(Bl.bin.rf(t,r+8)),r+=12;return s},Bl.parse.from3DS._tri_facel1=function(t,e,i){var s=[],r=e+6,o=Bl.bin.rsl(t,r);r+=2;for(var a=0;a<o;a++)s.push(Bl.bin.rsl(t,r)),s.push(Bl.bin.rsl(t,r+2)),s.push(Bl.bin.rsl(t,r+4)),r+=8;return s},Bl.parse.from3DS._tri_mappingcoors=function(t,e,i){var s=[],r=e+6,o=Bl.bin.rsl(t,r);r+=2;for(var a=0;a<o;a++)s.push(Bl.bin.rf(t,r)),s.push(1-Bl.bin.rf(t,r+4)),r+=8;return s},Bl.parse.from3DS._tri_local=function(t,e,i){var s={},r=e+6;return s.X=[Bl.bin.rf(t,r),Bl.bin.rf(t,r+4),Bl.bin.rf(t,r+8)],r+=12,s.Y=[Bl.bin.rf(t,r),Bl.bin.rf(t,r+4),Bl.bin.rf(t,r+8)],r+=12,s.Z=[Bl.bin.rf(t,r),Bl.bin.rf(t,r+4),Bl.bin.rf(t,r+8)],r+=12,s.C=[Bl.bin.rf(t,r),Bl.bin.rf(t,r+4),Bl.bin.rf(t,r+8)],r+=12,s},Bl.parse.fromBIV=function(t){t=new Uint8Array(t);var e={},i={};return i.id=Bl.bin.ril(t,0),i.verS=Bl.bin.ril(t,4),i.texS=Bl.bin.ril(t,8),i.indS=Bl.bin.ril(t,12),i.verO=Bl.bin.ril(t,16),i.verL=Bl.bin.ril(t,20),i.texO=Bl.bin.ril(t,24),i.texL=Bl.bin.ril(t,28),i.indO=Bl.bin.ril(t,32),i.indL=Bl.bin.ril(t,36),0!=i.verO&&(e.vertices=Bl.parse.fromBIV._readFloats(t,i.verO,i.verL)),0!=i.texO&&(e.uvt=Bl.parse.fromBIV._readFloats(t,i.texO,i.texL)),0!=i.indO&&(e.indices=Bl.parse.fromBIV._readInts(t,i.indO,i.indL,i.indS)),e},Bl.parse.toBIV=function(t){for(var e=0,i=0;i<t.indices.length;i++)e=Math.max(e,t.indices[i]);var s=32;e<=65535&&(s=16);var r=40;t.vertices&&(r+=4*t.vertices.length),t.uvt&&(r+=4*t.uvt.length),t.indices&&(r+=t.indices.length*s/8);var o=new Uint8Array(r);Bl.bin.wil(o,0,1769365870),Bl.bin.wil(o,4,32),Bl.bin.wil(o,8,32),Bl.bin.wil(o,12,s);var a=40;return t.vertices&&(Bl.bin.wil(o,16,a),Bl.bin.wil(o,20,4*t.vertices.length),Bl.parse.fromBIV._writeFloats(o,a,t.vertices),a+=4*t.vertices.length),t.uvt&&(Bl.bin.wil(o,24,a),Bl.bin.wil(o,28,4*t.uvt.length),Bl.parse.fromBIV._writeFloats(o,a,t.uvt),a+=4*t.uvt.length),t.indices&&(Bl.bin.wil(o,32,a),Bl.bin.wil(o,36,4*t.indices.length),Bl.parse.fromBIV._writeInts(o,a,t.indices,s)),o.buffer},Bl.parse.fromBIV._readFloats=function(t,e,i){for(var s=[],r=0;r<i/4;r++)s.push(Bl.bin.rf(t,e+4*r));return s},Bl.parse.fromBIV._writeFloats=function(t,e,i){for(var s=0;s<i.length;s++)Bl.bin.wf(t,e+4*s,i[s])},Bl.parse.fromBIV._readInts=function(t,e,i,s){for(var r=[],o=0;o<i/4;o++)16==s&&r.push(Bl.bin.rsl(t,e+2*o)),32==s&&r.push(Bl.bin.ril(t,e+4*o));return r},Bl.parse.fromBIV._writeInts=function(t,e,i,s){for(var r=0;r<i.length;r++)16==s&&Bl.bin.wsl(t,e+2*r,i[r]),32==s&&Bl.bin.wil(t,e+4*r,i[r])},Bl.gen={},Bl.gen.Plane=function(t,e,i,s){i||(i=1),s||(s=1);for(var r={verts:[],inds:[],uvt:[]},o=t+1,a=e+1,n=0;n<a;n++)for(var l=0;l<o;l++){var h=l*(2/t)-1,c=n*(2/e)-1;r.verts.push(h,c,0),r.uvt.push(i*l/t,s*n/e),n<e&&l<t&&r.inds.push(n*o+l,n*o+l+1,(n+1)*o+l,n*o+l+1,(n+1)*o+l,(n+1)*o+l+1)}return r},Bl.gen.Cube=function(){return{verts:[-1,1,-1,1,1,-1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,-1,1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],inds:[0,1,2,1,2,3,4,5,6,5,6,7,8,9,10,9,10,11,12,13,14,13,14,15,16,17,18,17,18,19,20,21,22,21,22,23],uvt:[1/4,1/4,.5,1/4,1/4,.5,.5,.5,1,1/4,3/4,1/4,1,.5,3/4,.5,0,1/4,1/4,1/4,0,.5,1/4,.5,3/4,1/4,.5,1/4,3/4,.5,.5,.5,1/4,1/4,.5,1/4,1/4,0,.5,0,1/4,.5,.5,.5,1/4,3/4,.5,3/4]}},Bl.gen.Sphere=function(t,e){for(var i={verts:[],inds:[],uvt:[]},s=t+1,r=e+1,o=0;o<r;o++)for(var a=0;a<s;a++){var n=-Math.PI/2+o*Math.PI/e,l=2*a*Math.PI/t,h=Math.cos(n)*Math.cos(l),c=Math.sin(n),u=Math.cos(n)*Math.sin(l);i.verts.push(h,c,u),i.uvt.push(a/t,o/e),o<e&&a<t&&i.inds.push(s*o+a,s*o+a+1,s*(o+1)+a,s*o+a+1,s*(o+1)+a,s*(o+1)+a+1)}return i},Bl.mat={},Bl.mat.scale=function(t,e,i){return[t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1]},Bl.mat.translate=function(t,e,i){return[1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1]},Bl.mat.rotateDeg=function(t,e,i){var s=Math.PI/180;return Bl.mat.rotate(t*s,e*s,i*s)},Bl.mat.rotate=function(t,e,i){var s=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],r=t,o=e,a=i,n=Math.cos(r),l=Math.cos(o),h=Math.cos(a),c=Math.sin(r),u=Math.sin(o),d=Math.sin(a);return s[0]=l*h,s[1]=-l*d,s[2]=u,s[4]=n*d+c*u*h,s[5]=n*h-c*u*d,s[6]=-c*l,s[8]=c*d-n*u*h,s[9]=c*h+n*u*d,s[10]=n*l,s},Bl.edit={},Bl.edit.interpolate=function(t,e,i,s){for(var r=0;r<t.length;r++)i[r]=t[r]+s*(e[r]-t[r])},Bl.edit.transform=function(t,e){for(var i=0;i<t.length;i+=3){var s=t[i],r=t[i+1],o=t[i+2];t[i+0]=e[0]*s+e[4]*r+e[8]*o+e[12],t[i+1]=e[1]*s+e[5]*r+e[9]*o+e[13],t[i+2]=e[2]*s+e[6]*r+e[10]*o+e[14]}},Bl.edit.unwrap=function(t,e,i){for(var s=new Array(Math.floor(t.length/3)*i),r=0;r<t.length;r++)for(var o=0;o<i;o++)s[r*i+o]=e[t[r]*i+o];return s},Bl.edit.remap=function(t,e,i,s){for(var r=new Array(i.length),o=0;o<t.length;o++)for(var a=0;a<s;a++)r[e[o]*s+a]=i[t[o]*s+a];return r},Bl.utils={},Bl.utils.getAABB=function(t){var e,i,s,r,o,a;r=o=a=-(e=i=s=999999999);for(var n=0;n<t.length;n+=3){var l=t[n+0],h=t[n+1],c=t[n+2];l<e&&(e=l),l>r&&(r=l),h<i&&(i=h),h>o&&(o=h),c<s&&(s=c),h>a&&(a=c)}return{min:{x:e,y:i,z:s},max:{x:r,y:o,z:a}}};const kl=d.vec3(),Ol=d.vec3();d.vec3();const Vl=d.vec3([0,-1,0]),zl=d.vec4([0,0,0,1]);class Ul extends S{constructor(t,e={}){super(t,e),this._src=null,this._image=null,this._pos=d.vec3(),this._origin=d.vec3(),this._rtcPos=d.vec3(),this._dir=d.vec3(),this._size=1,this._imageSize=d.vec2(),this._texture=new _n(this),this._plane=new Ri(this,{geometry:new xe(this,Il({center:[0,0,0],xSize:1,zSize:1,xSegments:10,zSegments:10})),material:new Se(this,{diffuse:[0,0,0],ambient:[0,0,0],specular:[0,0,0],diffuseMap:this._texture,emissiveMap:this._texture,backfaces:!0}),clippable:e.clippable}),this._grid=new Ri(this,{geometry:new xe(this,Nl({size:1,divisions:10})),material:new Se(this,{diffuse:[0,0,0],ambient:[0,0,0],emissive:[.2,.8,.2]}),position:[0,.001,0],clippable:e.clippable}),this._node=new Ka(this,{rotation:[0,0,0],position:[0,0,0],scale:[1,1,1],clippable:!1,children:[this._plane,this._grid]}),this._gridVisible=!1,this.visible=!0,this.gridVisible=e.gridVisible,this.position=e.position,this.rotation=e.rotation,this.dir=e.dir,this.size=e.size,this.collidable=e.collidable,this.clippable=e.clippable,this.pickable=e.pickable,this.opacity=e.opacity,e.image?this.image=e.image:this.src=e.src}set visible(t){this._plane.visible=t,this._grid.visible=this._gridVisible&&t}get visible(){return this._plane.visible}set gridVisible(t){t=!1!==t,this._gridVisible=t,this._grid.visible=this._gridVisible&&this.visible}get gridVisible(){return this._gridVisible}set image(t){this._image=t,this._image&&(this._imageSize[0]=t.width,this._imageSize[1]=t.height,this._updatePlaneSizeFromImage(),this._src=null,this._texture.image=this._image)}get image(){return this._image}set src(t){if(this._src=t,this._src){this._image=null;const t=new Image;t.onload=()=>{this._texture.image=t,this._imageSize[0]=t.width,this._imageSize[1]=t.height,this._updatePlaneSizeFromImage()},t.src=this._src}}get src(){return this._src}set position(t){this._pos.set(t||[0,0,0]),j(this._pos,this._origin,this._rtcPos),this._node.origin=this._origin,this._node.position=this._rtcPos}get position(){return this._pos}set rotation(t){this._node.rotation=t}get rotation(){return this._node.rotation}set size(t){this._size=null==t?1:t,this._image&&this._updatePlaneSizeFromImage()}get size(){return this._size}set dir(t){if(this._dir.set(t||[0,0,-1]),t){const e=this.scene.center,i=[-this._dir[0],-this._dir[1],-this._dir[2]];d.subVec3(e,this.position,kl);const s=-d.dotVec3(i,kl);d.normalizeVec3(i),d.mulVec3Scalar(i,s,Ol),d.vec3PairToQuaternion(Vl,t,zl),this._node.quaternion=zl}}get dir(){return this._dir}set collidable(t){this._node.collidable=!1!==t}get collidable(){return this._node.collidable}set clippable(t){this._node.clippable=!1!==t}get clippable(){return this._node.clippable}set pickable(t){this._node.pickable=!1!==t}get pickable(){return this._node.pickable}set opacity(t){this._node.opacity=t}get opacity(){return this._node.opacity}destroy(){super.destroy()}_updatePlaneSizeFromImage(){const t=this._size,e=this._imageSize[0],i=this._imageSize[1],s=i/e;this._node.scale=e>i?[t,1,t*s]:[t*s,1,t]}}class Gl extends ne{get type(){return"PointLight"}constructor(t,e={}){super(t,e);const i=this;this._shadowRenderBuf=null,this._shadowViewMatrix=null,this._shadowProjMatrix=null,this._shadowViewMatrixDirty=!0,this._shadowProjMatrixDirty=!0;const s=this.scene.camera,r=this.scene.canvas;this._onCameraViewMatrix=s.on("viewMatrix",(()=>{this._shadowViewMatrixDirty=!0})),this._onCameraProjMatrix=s.on("projMatrix",(()=>{this._shadowProjMatrixDirty=!0})),this._onCanvasBoundary=r.on("boundary",(()=>{this._shadowProjMatrixDirty=!0})),this._state=new Gt({type:"point",pos:d.vec3([1,1,1]),color:d.vec3([.7,.7,.8]),intensity:1,attenuation:[0,0,0],space:e.space||"view",castsShadow:!1,getShadowViewMatrix:()=>{if(i._shadowViewMatrixDirty){i._shadowViewMatrix||(i._shadowViewMatrix=d.identityMat4());const t=i._state.pos,e=s.look,r=s.up;d.lookAtMat4v(t,e,r,i._shadowViewMatrix),i._shadowViewMatrixDirty=!1}return i._shadowViewMatrix},getShadowProjMatrix:()=>{if(i._shadowProjMatrixDirty){i._shadowProjMatrix||(i._shadowProjMatrix=d.identityMat4());const t=i.scene.canvas.canvas;d.perspectiveMat4(Math.PI/180*70,t.clientWidth/t.clientHeight,.1,500,i._shadowProjMatrix),i._shadowProjMatrixDirty=!1}return i._shadowProjMatrix},getShadowRenderBuf:()=>(i._shadowRenderBuf||(i._shadowRenderBuf=new kt(i.scene.canvas.canvas,i.scene.canvas.gl,{size:[1024,1024]})),i._shadowRenderBuf)}),this.pos=e.pos,this.color=e.color,this.intensity=e.intensity,this.constantAttenuation=e.constantAttenuation,this.linearAttenuation=e.linearAttenuation,this.quadraticAttenuation=e.quadraticAttenuation,this.castsShadow=e.castsShadow,this.scene._lightCreated(this)}set pos(t){this._state.pos.set(t||[1,1,1]),this._shadowViewMatrixDirty=!0,this.glRedraw()}get pos(){return this._state.pos}set color(t){this._state.color.set(t||[.7,.7,.8]),this.glRedraw()}get color(){return this._state.color}set intensity(t){t=void 0!==t?t:1,this._state.intensity=t,this.glRedraw()}get intensity(){return this._state.intensity}set constantAttenuation(t){this._state.attenuation[0]=t||0,this.glRedraw()}get constantAttenuation(){return this._state.attenuation[0]}set linearAttenuation(t){this._state.attenuation[1]=t||0,this.glRedraw()}get linearAttenuation(){return this._state.attenuation[1]}set quadraticAttenuation(t){this._state.attenuation[2]=t||0,this.glRedraw()}get quadraticAttenuation(){return this._state.attenuation[2]}set castsShadow(t){t=!!t,this._state.castsShadow!==t&&(this._state.castsShadow=t,this._shadowViewMatrixDirty=!0,this.glRedraw())}get castsShadow(){return this._state.castsShadow}destroy(){const t=this.scene.camera,e=this.scene.canvas;t.off(this._onCameraViewMatrix),t.off(this._onCameraProjMatrix),e.off(this._onCanvasBoundary),super.destroy(),this._state.destroy(),this._shadowRenderBuf&&this._shadowRenderBuf.destroy(),this.scene._lightDestroyed(this),this.glRedraw()}}function jl(t){if(!Xl(t.width)||!Xl(t.height)){const e=document.createElement("canvas");e.width=Wl(t.width),e.height=Wl(t.height);e.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e.width,e.height),t=e}return t}function Xl(t){return 0==(t&t-1)}function Wl(t){--t;for(let e=1;e<32;e<<=1)t|=t>>e;return t+1}class Hl extends S{get type(){return"CubeTexture"}constructor(t,e={}){super(t,e);const i=this.scene.canvas.gl;this._state=new Gt({texture:new cn(i,i.TEXTURE_CUBE_MAP),flipY:this._checkFlipY(e.minFilter),encoding:this._checkEncoding(e.encoding),minFilter:"linearMipmapLinear",magFilter:"linear",wrapS:"clampToEdge",wrapT:"clampToEdge",mipmaps:!0}),this._src=e.src,this._images=[],this._loadSrc(e.src),_.memory.textures++}_checkFlipY(t){return!!t}_checkEncoding(t){return"linear"!==(t=t||"linear")&&"sRGB"!==t&&"gamma"!==t&&(this.error("Unsupported value for 'encoding': '"+t+"' - supported values are 'linear', 'sRGB', 'gamma'. Defaulting to 'linear'."),t="linear"),t}_webglContextRestored(){this.scene.canvas.gl,this._state.texture=null,this._src&&this._loadSrc(this._src)}_loadSrc(t){const e=this,i=this.scene.canvas.gl;this._images=[];let s=!1,r=0;for(let o=0;o<t.length;o++){const a=new Image;a.onload=function(){let t=a;const n=o;return function(){if(!s&&(t=jl(t),e._images[n]=t,r++,6===r)){let t=e._state.texture;t||(t=new cn(i,i.TEXTURE_CUBE_MAP),e._state.texture=t),t.setImage(e._images,e._state),t.setProps(e._state),e.fire("loaded",e._src,!1),e.glRedraw()}}}(),a.onerror=function(){s=!0},a.src=t[o]}}destroy(){super.destroy(),this._state.texture&&this._state.texture.destroy(),_.memory.textures--,this._state.destroy()}}class Yl extends Hl{get type(){return"ReflectionMap"}constructor(t,e={}){super(t,e),this.scene._lightsState.addReflectionMap(this._state),this.scene._reflectionMapCreated(this)}destroy(){super.destroy(),this.scene._reflectionMapDestroyed(this)}}class Kl extends Hl{get type(){return"LightMap"}constructor(t,e={}){super(t,e),this.scene._lightMapCreated(this)}destroy(){super.destroy(),this.scene._lightMapDestroyed(this)}}class ql extends Ee{get type(){return"LambertMaterial"}constructor(t,e={}){super(t,e),this._state=new Gt({type:"LambertMaterial",ambient:d.vec3([1,1,1]),color:d.vec3([1,1,1]),emissive:d.vec3([0,0,0]),alpha:null,alphaMode:0,lineWidth:null,pointSize:null,backfaces:null,frontface:null,hash:"/lam;"}),this.ambient=e.ambient,this.color=e.color,this.emissive=e.emissive,this.alpha=e.alpha,this.lineWidth=e.lineWidth,this.pointSize=e.pointSize,this.backfaces=e.backfaces,this.frontface=e.frontface}set ambient(t){let e=this._state.ambient;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.ambient=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=.2,e[1]=.2,e[2]=.2),this.glRedraw()}get ambient(){return this._state.ambient}set color(t){let e=this._state.color;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.color=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=1,e[1]=1,e[2]=1),this.glRedraw()}get color(){return this._state.color}set emissive(t){let e=this._state.emissive;if(e){if(t&&e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2])return}else e=this._state.emissive=new Float32Array(3);t?(e[0]=t[0],e[1]=t[1],e[2]=t[2]):(e[0]=0,e[1]=0,e[2]=0),this.glRedraw()}get emissive(){return this._state.emissive}set alpha(t){t=null!=t?t:1,this._state.alpha!==t&&(this._state.alpha=t,this._state.alphaMode=t<1?2:0,this.glRedraw())}get alpha(){return this._state.alpha}set lineWidth(t){this._state.lineWidth=t||1,this.glRedraw()}get lineWidth(){return this._state.lineWidth}set pointSize(t){this._state.pointSize=t||1,this.glRedraw()}get pointSize(){return this._state.pointSize}set backfaces(t){t=!!t,this._state.backfaces!==t&&(this._state.backfaces=t,this.glRedraw())}get backfaces(){return this._state.backfaces}set frontface(t){t="cw"!==t,this._state.frontface!==t&&(this._state.frontface=t,this.glRedraw())}get frontface(){return this._state.frontface?"ccw":"cw"}_getState(){return this._state}destroy(){super.destroy(),this._state.destroy()}}class Zl extends S{get type(){return"Fresnel"}constructor(t,e={}){super(t,e),this._state=new Gt({edgeColor:d.vec3([0,0,0]),centerColor:d.vec3([1,1,1]),edgeBias:0,centerBias:1,power:1}),this.edgeColor=e.edgeColor,this.centerColor=e.centerColor,this.edgeBias=e.edgeBias,this.centerBias=e.centerBias,this.power=e.power}set edgeColor(t){this._state.edgeColor.set(t||[0,0,0]),this.glRedraw()}get edgeColor(){return this._state.edgeColor}set centerColor(t){this._state.centerColor.set(t||[1,1,1]),this.glRedraw()}get centerColor(){return this._state.centerColor}set edgeBias(t){this._state.edgeBias=t||0,this.glRedraw()}get edgeBias(){return this._state.edgeBias}set centerBias(t){this._state.centerBias=null!=t?t:1,this.glRedraw()}get centerBias(){return this._state.centerBias}set power(t){this._state.power=null!=t?t:1,this.glRedraw()}get power(){return this._state.power}destroy(){super.destroy(),this._state.destroy()}}class Ql extends K{constructor(t,e={}){super(t,{entity:e.entity,occludable:e.occludable,worldPos:e.worldPos}),this._occluded=!1,this._visible=!0,this._src=null,this._image=null,this._pos=d.vec3(),this._origin=d.vec3(),this._rtcPos=d.vec3(),this._dir=d.vec3(),this._size=1,this._imageSize=d.vec2(),this._texture=new _n(this,{src:e.src}),this._geometry=new xe(this,{primitive:"triangles",positions:[3,3,0,-3,3,0,-3,-3,0,3,-3,0],normals:[-1,0,0,-1,0,0,-1,0,0,-1,0,0],uv:[1,-1,0,-1,0,0,1,0],indices:[0,1,2,0,2,3]}),this._mesh=new Ri(this,{geometry:this._geometry,material:new Se(this,{ambient:[.9,.3,.9],shininess:30,diffuseMap:this._texture,backfaces:!0}),scale:[1,1,1],position:e.worldPos,rotation:[90,0,0],billboard:"spherical",occluder:!1}),this.visible=!0,this.collidable=e.collidable,this.clippable=e.clippable,this.pickable=e.pickable,this.opacity=e.opacity,this.size=e.size,e.image?this.image=e.image:this.src=e.src}_setVisible(t){this._occluded=!t,this._mesh.visible=this._visible&&!this._occluded,super._setVisible(t)}set visible(t){this._visible=null==t||t,this._mesh.visible=this._visible&&!this._occluded}get visible(){return this._visible}set image(t){this._image=t,this._image&&(this._imageSize[0]=this._image.width,this._imageSize[1]=this._image.height,this._updatePlaneSizeFromImage(),this._src=null,this._texture.image=this._image)}get image(){return this._image}set src(t){if(this._src=t,this._src){this._image=null;const t=new Image;t.onload=()=>{this._texture.image=t,this._imageSize[0]=t.width,this._imageSize[1]=t.height,this._updatePlaneSizeFromImage()},t.src=this._src}}get src(){return this._src}set size(t){this._size=null==t?1:t,this._image&&this._updatePlaneSizeFromImage()}get size(){return this._size}set collidable(t){this._mesh.collidable=!1!==t}get collidable(){return this._mesh.collidable}set clippable(t){this._mesh.clippable=!1!==t}get clippable(){return this._mesh.clippable}set pickable(t){this._mesh.pickable=!1!==t}get pickable(){return this._mesh.pickable}set opacity(t){this._mesh.opacity=t}get opacity(){return this._mesh.opacity}_updatePlaneSizeFromImage(){const t=.5*this._size,e=this._imageSize[0],i=this._imageSize[1],s=i/e;this._geometry.positions=e>i?[t,t*s,0,-t,t*s,0,-t,-t*s,0,t,-t*s,0]:[t/s,t,0,-t/s,t,0,-t/s,-t,0,t/s,-t,0]}}class $l{constructor(t){this._eye=d.vec3(),this._look=d.vec3(),this._up=d.vec3(),this._projection={},t&&this.saveCamera(t)}saveCamera(t){const e=t.camera,i=e.project;switch(this._eye.set(e.eye),this._look.set(e.look),this._up.set(e.up),e.projection){case"perspective":this._projection={projection:"perspective",fov:i.fov,fovAxis:i.fovAxis,near:i.near,far:i.far};break;case"ortho":this._projection={projection:"ortho",scale:i.scale,near:i.near,far:i.far};break;case"frustum":this._projection={projection:"frustum",left:i.left,right:i.right,top:i.top,bottom:i.bottom,near:i.near,far:i.far};break;case"custom":this._projection={projection:"custom",matrix:i.matrix.slice()}}}restoreCamera(t,e){const i=t.camera,s=this._projection;function r(){switch(s.type){case"perspective":i.perspective.fov=s.fov,i.perspective.fovAxis=s.fovAxis,i.perspective.near=s.near,i.perspective.far=s.far;break;case"ortho":i.ortho.scale=s.scale,i.ortho.near=s.near,i.ortho.far=s.far;break;case"frustum":i.frustum.left=s.left,i.frustum.right=s.right,i.frustum.top=s.top,i.frustum.bottom=s.bottom,i.frustum.near=s.near,i.frustum.far=s.far;break;case"custom":i.customProjection.matrix=s.matrix}}e?t.viewer.cameraFlight.flyTo({eye:this._eye,look:this._look,up:this._up,orthoScale:s.scale,projection:s.projection},(()=>{r(),e()})):(i.eye=this._eye,i.look=this._look,i.up=this._up,r(),i.projection=s.projection)}}const Jl=d.vec3();class th{constructor(t){if(this.objectsVisible=[],this.objectsEdges=[],this.objectsXrayed=[],this.objectsHighlighted=[],this.objectsSelected=[],this.objectsClippable=[],this.objectsPickable=[],this.objectsColorize=[],this.objectsOpacity=[],this.numObjects=0,t){const e=t.metaScene.scene;this.saveObjects(e,t)}}saveObjects(t,e,i){const s=e.rootMetaObject;if(!s)return;const r=s.getObjectIDsInSubtree();this.numObjects=0,this._mask=i?m.apply(i,{}):null;const o=t.objects,a=!i||i.visible,n=!i||i.edges,l=!i||i.xrayed,h=!i||i.highlighted,c=!i||i.selected,u=!i||i.clippable,d=!i||i.pickable,p=!i||i.colorize,_=!i||i.opacity;for(var f=0,g=r.length;f<g;f++){const t=o[r[f]];if(t){if(a&&(this.objectsVisible[f]=t.visible),n&&(this.objectsEdges[f]=t.edges),l&&(this.objectsXrayed[f]=t.xrayed),h&&(this.objectsHighlighted[f]=t.highlighted),c&&(this.objectsSelected[f]=t.selected),u&&(this.objectsClippable[f]=t.clippable),d&&(this.objectsPickable[f]=t.pickable),p){const e=t.colorize;this.objectsColorize[3*f+0]=e[0],this.objectsColorize[3*f+1]=e[1],this.objectsColorize[3*f+2]=e[2]}_&&(this.objectsOpacity[f]=t.opacity),this.numObjects++}}}restoreObjects(t,e){const i=e.rootMetaObject;if(!i)return;const s=i.getObjectIDsInSubtree(),r=this._mask,o=!r||r.visible,a=!r||r.edges,n=!r||r.xrayed,l=!r||r.highlighted,h=!r||r.selected,c=!r||r.clippable,u=!r||r.pickable,d=!r||r.colorize,p=!r||r.opacity,_=t.objects;for(var f=0,g=s.length;f<g;f++){const t=_[s[f]];t&&(o&&(t.visible=this.objectsVisible[f]),a&&(t.edges=this.objectsEdges[f]),n&&(t.xrayed=this.objectsXrayed[f]),l&&(t.highlighted=this.objectsHighlighted[f]),h&&(t.selected=this.objectsSelected[f]),c&&(t.clippable=this.objectsClippable[f]),u&&(t.pickable=this.objectsPickable[f]),d&&(Jl[0]=this.objectsColorize[3*f+0],Jl[1]=this.objectsColorize[3*f+1],Jl[2]=this.objectsColorize[3*f+2],t.colorize=Jl),p&&(t.opacity=this.objectsOpacity[f]))}}}const eh=d.vec3();class ih{constructor(){this.objectsVisible=[],this.objectsEdges=[],this.objectsXrayed=[],this.objectsHighlighted=[],this.objectsSelected=[],this.objectsClippable=[],this.objectsPickable=[],this.objectsColorize=[],this.objectsHasColorize=[],this.objectsOpacity=[],this.numObjects=0}saveObjects(t,e){this.numObjects=0,this._mask=e?m.apply(e,{}):null;const i=t.objects,s=!e||e.visible,r=!e||e.edges,o=!e||e.xrayed,a=!e||e.highlighted,n=!e||e.selected,l=!e||e.clippable,h=!e||e.pickable,c=!e||e.colorize,u=!e||e.opacity;for(let t in i)if(i.hasOwnProperty(t)){const e=i[t],d=this.numObjects;if(s&&(this.objectsVisible[d]=e.visible),r&&(this.objectsEdges[d]=e.edges),o&&(this.objectsXrayed[d]=e.xrayed),a&&(this.objectsHighlighted[d]=e.highlighted),n&&(this.objectsSelected[d]=e.selected),l&&(this.objectsClippable[d]=e.clippable),h&&(this.objectsPickable[d]=e.pickable),c){const t=e.colorize;t?(this.objectsColorize[3*d+0]=t[0],this.objectsColorize[3*d+1]=t[1],this.objectsColorize[3*d+2]=t[2],this.objectsHasColorize[d]=!0):this.objectsHasColorize[d]=!1}u&&(this.objectsOpacity[d]=e.opacity),this.numObjects++}}restoreObjects(t){const e=this._mask,i=!e||e.visible,s=!e||e.edges,r=!e||e.xrayed,o=!e||e.highlighted,a=!e||e.selected,n=!e||e.clippable,l=!e||e.pickable,h=!e||e.colorize,c=!e||e.opacity;var u=0;const d=t.objects;for(let t in d)if(d.hasOwnProperty(t)){const e=d[t];i&&(e.visible=this.objectsVisible[u]),s&&(e.edges=this.objectsEdges[u]),r&&(e.xrayed=this.objectsXrayed[u]),o&&(e.highlighted=this.objectsHighlighted[u]),a&&(e.selected=this.objectsSelected[u]),n&&(e.clippable=this.objectsClippable[u]),l&&(e.pickable=this.objectsPickable[u]),h&&(this.objectsHasColorize[u]?(eh[0]=this.objectsColorize[3*u+0],eh[1]=this.objectsColorize[3*u+1],eh[2]=this.objectsColorize[3*u+2],e.colorize=eh):e.colorize=null),c&&(e.opacity=this.objectsOpacity[u]),u++}}}class sh extends Pl{constructor(t,e={}){super(t,e),this.v0=e.v0,this.v1=e.v1,this.v2=e.v2,this.v3=e.v3,this.t=e.t}set v0(t){this._v0=t||d.vec3([0,0,0])}get v0(){return this._v0}set v1(t){this._v1=t||d.vec3([0,0,0])}get v1(){return this._v1}set v2(t){this._v2=t||d.vec3([0,0,0])}get v2(){return this._v2}set v3(t){this.fire("v3",this._v3=t||d.vec3([0,0,0]))}get v3(){return this._v3}set t(t){t=t||0,this._t=t<0?0:t>1?1:t}get t(){return this._t}get point(){return this.getPoint(this._t)}getPoint(t){var e=d.vec3();return e[0]=d.b3(t,this._v0[0],this._v1[0],this._v2[0],this._v3[0]),e[1]=d.b3(t,this._v0[1],this._v1[1],this._v2[1],this._v3[1]),e[2]=d.b3(t,this._v0[2],this._v1[2],this._v2[2],this._v3[2]),e}getJSON(){return{v0:this._v0,v1:this._v1,v2:this._v2,v3:this._v3,t:this._t}}}class rh extends Pl{constructor(t,e={}){super(t,e),this._cachedLengths=[],this._dirty=!0,this._curves=[],this._t=0,this._dirtySubs=[],this._destroyedSubs=[],this.curves=e.curves||[],this.t=e.t}addCurve(t){this._curves.push(t),this._dirty=!0}set curves(t){var e,i,s;for(t=t||[],i=0,s=this._curves.length;i<s;i++)(e=this._curves[i]).off(this._dirtySubs[i]),e.off(this._destroyedSubs[i]);this._curves=[],this._dirtySubs=[],this._destroyedSubs=[];var r=this;function o(){r._dirty=!0}function a(){var t=this.id;for(i=0,s=r._curves.length;i<s;i++)if(r._curves[i].id===t)return r._curves=r._curves.slice(i,i+1),r._dirtySubs=r._dirtySubs.slice(i,i+1),r._destroyedSubs=r._destroyedSubs.slice(i,i+1),void(r._dirty=!0)}for(i=0,s=t.length;i<s;i++){if(e=t[i],m.isNumeric(e)||m.isString(e)){var n=e;if(!(e=this.scene.components[n])){this.error("Component not found: "+_inQuotes(n));continue}}var l=e.type;"xeokit.SplineCurve"===l||"xeokit.Path"===l||"xeokit.CubicBezierCurve"===l||"xeokit.QuadraticBezierCurve"===l?(this._curves.push(e),this._dirtySubs.push(e.on("dirty",o)),this._destroyedSubs.push(e.once("destroyed",a))):this.error("Component "+_inQuotes(e.id)+" is not a xeokit.SplineCurve, xeokit.Path or xeokit.QuadraticBezierCurve")}this._dirty=!0}get curves(){return this._curves}set t(t){t=t||0,this._t=t<0?0:t>1?1:t}get t(){return this._t}get point(){return this.getPoint(this._t)}get length(){var t=this._getCurveLengths();return t[t.length-1]}getPoint(t){for(var e,i=t*this.length,s=this._getCurveLengths(),r=0;r<s.length;){if(s[r]>=i){var o=1-(s[r]-i)/(e=this._curves[r]).length;return e.getPointAt(o)}r++}return null}_getCurveLengths(){if(!this._dirty)return this._cachedLengths;var t,e=[],i=0,s=this._curves.length;for(t=0;t<s;t++)i+=this._curves[t].length,e.push(i);return this._cachedLengths=e,this._dirty=!1,e}_getJSON(){for(var t=[],e=0,i=this._curves.length;e<i;e++)t.push(this._curves[e].id);return{curves:t,t:this._t}}destroy(){var t,e,i;for(super.destroy(),t=0,e=this._curves.length;t<e;t++)(i=this._curves[t]).off(this._dirtySubs[t]),i.off(this._destroyedSubs[t])}}class oh extends Pl{constructor(t,e={}){super(t,e),this.v0=e.v0,this.v1=e.v1,this.v2=e.v2,this.t=e.t}set v0(t){this._v0=t||d.vec3([0,0,0])}get v0(){return this._v0}set v1(t){this._v1=t||d.vec3([0,0,0])}get v1(){return this._v1}set v2(t){this._v2=t||d.vec3([0,0,0])}get v2(){return this._v2}set t(t){t=t||0,this._t=t<0?0:t>1?1:t}get t(){return this._t}get point(){return this.getPoint(this._t)}getPoint(t){var e=d.vec3();return e[0]=d.b2(t,this._v0[0],this._v1[0],this._v2[0]),e[1]=d.b2(t,this._v0[1],this._v1[1],this._v2[1]),e[2]=d.b2(t,this._v0[2],this._v1[2],this._v2[2]),e}getJSON(){return{v0:this._v0,v1:this._v1,v2:this._v2,t:this._t}}}class ah extends S{constructor(t,e={}){super(t,e),this._skyboxMesh=new Ri(this,{geometry:new xe(this,{primitive:"triangles",positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}),background:!0,scale:[2e3,2e3,2e3],rotation:[0,-90,0],material:new Se(this,{ambient:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],emissive:[1,1,1],emissiveMap:new _n(this,{src:e.src,flipY:!0,wrapS:"clampToEdge",wrapT:"clampToEdge",encoding:e.encoding||"sRGB"}),backfaces:!0}),visible:!1,pickable:!1,clippable:!1,collidable:!1}),this.size=e.size,this.active=e.active}set size(t){this._size=t||1e3,this._skyboxMesh.scale=[this._size,this._size,this._size]}get size(){return this._size}set active(t){this._skyboxMesh.visible=t}get active(){return this._skyboxMesh.visible}}const nh=d.vec4(),lh=d.vec4(),hh=d.vec3(),ch=d.vec3(),uh=d.vec3(),dh=d.vec4(),ph=d.vec4(),_h=d.vec4();class fh{constructor(t){this._scene=t}dollyToCanvasPos(t,e,i){let s=!1;const r=this._scene.camera;if(t){const e=d.subVec3(t,r.eye,hh);s=d.lenVec3(e)<i}if("perspective"===r.projection){r.ortho.scale=r.ortho.scale-i;const s=this._unproject(e,dh),o=d.subVec3(s,r.eye,_h),a=d.mulVec3Scalar(d.normalizeVec3(o),-i,[]);if(r.eye=[r.eye[0]-a[0],r.eye[1]-a[1],r.eye[2]-a[2]],r.look=[r.look[0]-a[0],r.look[1]-a[1],r.look[2]-a[2]],t){const e=d.subVec3(t,r.eye,hh),i=d.lenVec3(e),s=d.mulVec3Scalar(d.normalizeVec3(d.subVec3(r.look,r.eye,ch)),i);r.look=[r.eye[0]+s[0],r.eye[1]+s[1],r.eye[2]+s[2]]}}else if("ortho"===r.projection){const t=this._unproject(e,dh);r.ortho.scale=r.ortho.scale-i,r.ortho._update();const s=this._unproject(e,ph),o=d.subVec3(s,t,_h),a=d.mulVec3Scalar(d.normalizeVec3(d.subVec3(r.look,r.eye,hh)),-i,ch),n=d.addVec3(o,a,uh);r.eye=[r.eye[0]-n[0],r.eye[1]-n[1],r.eye[2]-n[2]],r.look=[r.look[0]-n[0],r.look[1]-n[1],r.look[2]-n[2]]}return s}_unproject(t,e){const i=this._scene.camera,s=i.project.transposedMatrix,r=s.subarray(8,12),o=s.subarray(12),a=[0,0,-1,1],n=d.dotVec4(a,r)/d.dotVec4(a,o);return i.project.unproject(t,n,nh,lh,e),e}destroy(){}}const gh=d.vec3(),mh=d.vec3(),vh=d.vec3(),bh=d.vec4(),Ph=d.vec4(),yh=d.vec4();class Mh{constructor(t,e){this._scene=t,this._configs=e,this._pivotWorldPos=d.vec3(),this._cameraOffset=d.vec3(),this._azimuth=0,this._polar=0,this._radius=0,this._pivotPosSet=!1,this._pivoting=!1,this._shown=!1,this._pivotSphereEnabled=!1,this._pivotSphere=null,this._pivotSphereSize=1,this._pivotSphereGeometry=null,this._pivotSphereMaterial=null,this._rtcCenter=d.vec3(),this._rtcPos=d.vec3(),this._pivotViewPos=d.vec4(),this._pivotProjPos=d.vec4(),this._pivotCanvasPos=d.vec2(),this._cameraDirty=!0,this._onViewMatrix=this._scene.camera.on("viewMatrix",(()=>{this._cameraDirty=!0})),this._onProjMatrix=this._scene.camera.on("projMatrix",(()=>{this._cameraDirty=!0})),this._onTick=this._scene.on("tick",(()=>{this.updatePivotElement(),this.updatePivotSphere()}))}createPivotSphere(){const t=this.getPivotPos(),e=d.vec3();d.decomposeMat4(d.inverseMat4(this._scene.viewer.camera.viewMatrix,d.mat4()),e,d.vec4(),d.vec3());const i=d.distVec3(e,t),s=Math.tan(Math.PI/500)*i*this._pivotSphereSize;j(t,this._rtcCenter,this._rtcPos),this._pivotSphereGeometry=new Ja(this._scene,Ni({radius:s})),this._pivotSphere=new Ri(this._scene,{geometry:this._pivotSphereGeometry,material:this._pivotSphereMaterial,pickable:!1,position:this._rtcPos,rtcCenter:this._rtcCenter})}destroyPivotSphere(){this._pivotSphere&&(this._pivotSphere.destroy(),this._pivotSphere=null),this._pivotSphereGeometry&&(this._pivotSphereGeometry.destroy(),this._pivotSphereGeometry=null)}updatePivotElement(){const t=this._scene.camera,e=this._scene.canvas;if(this._pivoting&&this._cameraDirty){d.transformPoint3(t.viewMatrix,this.getPivotPos(),this._pivotViewPos),this._pivotViewPos[3]=1,d.transformPoint4(t.projMatrix,this._pivotViewPos,this._pivotProjPos);const i=e.boundary,s=i[2],r=i[3];if(this._pivotCanvasPos[0]=Math.floor((1+this._pivotProjPos[0]/this._pivotProjPos[3])*s/2),this._pivotCanvasPos[1]=Math.floor((1-this._pivotProjPos[1]/this._pivotProjPos[3])*r/2),this._pivotElement){const t=e.canvas.getBoundingClientRect();this._pivotElement.style.left=Math.floor(t.left+this._pivotCanvasPos[0])-this._pivotElement.clientWidth/2+window.scrollX+"px",this._pivotElement.style.top=Math.floor(t.top+this._pivotCanvasPos[1])-this._pivotElement.clientHeight/2+window.scrollY+"px"}this._cameraDirty=!1}}updatePivotSphere(){this._pivoting&&this._pivotSphere&&(j(this.getPivotPos(),this._rtcCenter,this._rtcPos),d.compareVec3(this._rtcPos,this._pivotSphere.position)||(this.destroyPivotSphere(),this.createPivotSphere()))}setPivotElement(t){this._pivotElement=t}enablePivotSphere(t={}){this.destroyPivotSphere(),this._pivotSphereEnabled=!0,t.size&&(this._pivotSphereSize=t.size);const e=t.color||[1,0,0];this._pivotSphereMaterial=new Se(this._scene,{emissive:e,ambient:e,specular:[0,0,0],diffuse:[0,0,0]})}disablePivotSphere(){this.destroyPivotSphere(),this._pivotSphereEnabled=!1}startPivot(){if(this._cameraLookingDownwards())return this._pivoting=!1,!1;const t=this._scene.camera;let e=d.lookAtMat4v(t.eye,t.look,t.worldUp);d.transformPoint3(e,this.getPivotPos(),this._cameraOffset);const i=this.getPivotPos();this._cameraOffset[2]+=d.distVec3(t.eye,i),e=d.inverseMat4(e);const s=d.transformVec3(e,this._cameraOffset),r=d.vec3();if(d.subVec3(t.eye,i,r),d.addVec3(r,s),t.zUp){const t=r[1];r[1]=r[2],r[2]=t}this._radius=d.lenVec3(r),this._polar=Math.acos(r[1]/this._radius),this._azimuth=Math.atan2(r[0],r[2]),this._pivoting=!0}_cameraLookingDownwards(){const t=this._scene.camera,e=d.normalizeVec3(d.subVec3(t.look,t.eye,gh)),i=d.cross3Vec3(e,t.worldUp,mh);return d.sqLenVec3(i)<=1e-4}getPivoting(){return this._pivoting}setPivotPos(t){this._pivotWorldPos.set(t),this._pivotPosSet=!0}setCanvasPivotPos(t){const e=this._scene.camera,i=Math.abs(d.distVec3(this._scene.center,e.eye)),s=e.project.transposedMatrix,r=s.subarray(8,12),o=s.subarray(12),a=[0,0,-1,1],n=d.dotVec4(a,r)/d.dotVec4(a,o),l=bh;e.project.unproject(t,n,Ph,yh,l);const h=d.normalizeVec3(d.subVec3(l,e.eye,gh)),c=d.addVec3(e.eye,d.mulVec3Scalar(h,i,mh),vh);this.setPivotPos(c)}getPivotPos(){return this._pivotPosSet?this._pivotWorldPos:this._scene.camera.look}continuePivot(t,e){if(!this._pivoting)return;if(0===t&&0===e)return;const i=this._scene.camera;var s=-t;const r=-e;1===i.worldUp[2]&&(s=-s),this._azimuth+=.01*-s,this._polar+=.01*r,this._polar=d.clamp(this._polar,.001,Math.PI-.001);const o=[this._radius*Math.sin(this._polar)*Math.sin(this._azimuth),this._radius*Math.cos(this._polar),this._radius*Math.sin(this._polar)*Math.cos(this._azimuth)];if(1===i.worldUp[2]){const t=o[1];o[1]=o[2],o[2]=t}const a=d.lenVec3(d.subVec3(i.look,i.eye,d.vec3())),n=this.getPivotPos();d.addVec3(o,n);let l=d.lookAtMat4v(o,n,i.worldUp);l=d.inverseMat4(l);const h=d.transformVec3(l,this._cameraOffset);l[12]-=h[0],l[13]-=h[1],l[14]-=h[2];const c=[l[8],l[9],l[10]];i.eye=[l[12],l[13],l[14]],d.subVec3(i.eye,d.mulVec3Scalar(c,a),i.look),i.up=[l[4],l[5],l[6]],this.showPivot()}showPivot(){this._shown?this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=window.setTimeout((()=>{this.hidePivot()}),1e3)):(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this.updatePivotElement(),this._pivotElement.style.visibility="visible"),this._pivotSphereEnabled&&(this.destroyPivotSphere(),this.createPivotSphere()),this._shown=!0,this._hideTimeout=window.setTimeout((()=>{this.hidePivot()}),1e3))}hidePivot(){this._shown&&(null!==this._hideTimeout&&(window.clearTimeout(this._hideTimeout),this._hideTimeout=null),this._pivotElement&&(this._pivotElement.style.visibility="hidden"),this._pivotSphereEnabled&&this.destroyPivotSphere(),this._shown=!1,this.endPivot())}endPivot(){this._pivoting=!1}destroy(){this.destroyPivotSphere(),this._scene.camera.off(this._onViewMatrix),this._scene.camera.off(this._onProjMatrix),this._scene.off(this._onTick)}}class xh{constructor(t,e){this._scene=t.scene,this._cameraControl=t,this._scene.canvas.canvas.oncontextmenu=function(t){t.preventDefault()},this._configs=e,this.schedulePickEntity=!1,this.schedulePickSurface=!1,this.pickCursorPos=d.vec2(),this.picked=!1,this.pickedSurface=!1,this.pickResult=null,this._lastPickedEntityId=null,this._needFireEvents=!1}update(){if(!this._configs.pointerEnabled)return;if(!this.schedulePickEntity&&!this.schedulePickSurface)return;this.picked=!1,this.pickedSurface=!1,this._needFireEvents=!1;const t=this._cameraControl.hasSubs("hoverSurface");if(this.schedulePickSurface&&this.pickResult&&this.pickResult.worldPos){const e=this.pickResult.canvasPos;if(e[0]===this.pickCursorPos[0]&&e[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!0,this._needFireEvents=t,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}if(this.schedulePickEntity&&this.pickResult){const t=this.pickResult.canvasPos;if(t[0]===this.pickCursorPos[0]&&t[1]===this.pickCursorPos[1])return this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!1,this.schedulePickEntity=!1,void(this.schedulePickSurface=!1)}this.schedulePickSurface?(this.pickResult=this._scene.pick({pickSurface:!0,pickSurfaceNormal:!1,canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!0,this._needFireEvents=!0)):(this.pickResult=this._scene.pick({canvasPos:this.pickCursorPos}),this.pickResult&&(this.picked=!0,this.pickedSurface=!1,this._needFireEvents=!0)),this.schedulePickEntity=!1,this.schedulePickSurface=!1}fireEvents(){if(this._needFireEvents){if(this.picked&&this.pickResult&&this.pickResult.entity){const t=this.pickResult.entity.id;this._lastPickedEntityId!==t&&(void 0!==this._lastPickedEntityId&&this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._cameraControl.fire("hoverEnter",this.pickResult,!0),this._lastPickedEntityId=t),this._cameraControl.fire("hover",this.pickResult,!0),this.pickResult.worldPos&&(this.pickedSurface=!0,this._cameraControl.fire("hoverSurface",this.pickResult,!0))}else void 0!==this._lastPickedEntityId&&(this._cameraControl.fire("hoverOut",{entity:this._scene.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),this._cameraControl.fire("hoverOff",{canvasPos:this.pickCursorPos},!0);this.pickResult=null,this._needFireEvents=!1}}destroy(){}}const wh=d.vec2();class Eh{constructor(t,e,i,s,r){this._scene=t;const o=e.pickController;let a,n,l,h=0,c=0,u=0,p=0,_=!1;const f=d.vec3();let g=!0;const m=this._scene.canvas.canvas,v=[];function b(t=!0){m.style.cursor="move",h=s.pointerCanvasPos[0],c=s.pointerCanvasPos[1],u=s.pointerCanvasPos[0],p=s.pointerCanvasPos[1],t&&(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickSurface=!0,o.update(),o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(_=!0,f.set(o.pickResult.worldPos)):_=!1)}document.addEventListener("keydown",this._documentKeyDownHandler=e=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;const s=e.keyCode;v[s]=!0}),document.addEventListener("keyup",this._documentKeyUpHandler=e=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;const s=e.keyCode;v[s]=!1}),m.addEventListener("mousedown",this._mouseDownHandler=e=>{if(i.active&&i.pointerEnabled)switch(e.which){case 1:v[t.input.KEY_SHIFT]||i.planView?(a=!0,b()):(a=!0,b(!1));break;case 2:n=!0,b();break;case 3:l=!0,i.panRightClick&&b()}}),document.addEventListener("mousemove",this._documentMouseMoveHandler=()=>{if(!i.active||!i.pointerEnabled)return;if(!a&&!n&&!l)return;const e=t.canvas.boundary,o=e[2]-e[0],u=e[3]-e[1],p=s.pointerCanvasPos[0],g=s.pointerCanvasPos[1];if(v[t.input.KEY_SHIFT]||i.planView||!i.panRightClick&&n||i.panRightClick&&l){const e=p-h,i=g-c,s=t.camera;if("perspective"===s.projection){const o=Math.abs(_?d.lenVec3(d.subVec3(f,t.camera.eye,[])):t.camera.eyeLookDist)*Math.tan(s.perspective.fov/2*Math.PI/180);r.panDeltaX+=1.5*e*o/u,r.panDeltaY+=1.5*i*o/u}else r.panDeltaX+=.5*s.ortho.scale*(e/u),r.panDeltaY+=.5*s.ortho.scale*(i/u)}else!a||n||l||i.planView||(i.firstPerson?(r.rotateDeltaY-=(p-h)/o*i.dragRotationRate/2,r.rotateDeltaX+=(g-c)/u*(i.dragRotationRate/4)):(r.rotateDeltaY-=(p-h)/o*(1.5*i.dragRotationRate),r.rotateDeltaX+=(g-c)/u*(1.5*i.dragRotationRate)));h=p,c=g}),m.addEventListener("mousemove",this._canvasMouseMoveHandler=t=>{i.active&&i.pointerEnabled&&s.mouseover&&(g=!0)}),document.addEventListener("mouseup",this._documentMouseUpHandler=t=>{if(i.active&&i.pointerEnabled)switch(t.which){case 1:case 2:case 3:a=!1,n=!1,l=!1}}),m.addEventListener("mouseup",this._mouseUpHandler=t=>{if(i.active&&i.pointerEnabled){if(3===t.which){!function(t,e){if(t){let i=t.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e[0]=t.x,e[1]=t.y}(t,wh);const i=wh[0],s=wh[1];Math.abs(i-u)<3&&Math.abs(s-p)<3&&e.cameraControl.fire("rightClick",{pagePos:[Math.round(t.pageX),Math.round(t.pageY)],canvasPos:wh,event:t},!0)}m.style.removeProperty("cursor")}}),m.addEventListener("mouseenter",this._mouseEnterHandler=()=>{i.active&&i.pointerEnabled});const P=1/60;let y=null;m.addEventListener("wheel",this._mouseWheelHandler=t=>{if(!i.active||!i.pointerEnabled)return;const e=performance.now()/1e3;var o=null!==y?e-y:0;y=e,o>.05&&(o=.05),o<P&&(o=P);const a=Math.max(-1,Math.min(1,40*-t.deltaY));if(0===a)return;const n=a/Math.abs(a);r.dollyDelta+=-n*o*i.mouseWheelDollyRate,g&&(s.followPointerDirty=!0,g=!1)},{passive:!0})}reset(){}destroy(){const t=this._scene.canvas.canvas;document.removeEventListener("keydown",this._documentKeyDownHandler),document.removeEventListener("keyup",this._documentKeyUpHandler),t.removeEventListener("mousedown",this._mouseDownHandler),document.removeEventListener("mousemove",this._documentMouseMoveHandler),t.removeEventListener("mousemove",this._canvasMouseMoveHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),t.removeEventListener("mouseup",this._mouseUpHandler),t.removeEventListener("mouseenter",this._mouseEnterHandler),t.removeEventListener("wheel",this._mouseWheelHandler)}}const Ah=d.vec3(),Ch=d.vec3(),Sh=d.vec3(),Dh=d.vec3(),Lh=d.vec3(),Bh={eye:d.vec3(),look:d.vec3(),up:d.vec3()};class Rh{constructor(t,e,i,s){this._scene=t;const r=e.cameraControl,o=t.camera;this._onSceneKeyDown=t.input.on("keydown",(()=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;if(!s.mouseover)return;const a=r._isKeyDownForAction(r.AXIS_VIEW_RIGHT),n=r._isKeyDownForAction(r.AXIS_VIEW_BACK),l=r._isKeyDownForAction(r.AXIS_VIEW_LEFT),h=r._isKeyDownForAction(r.AXIS_VIEW_FRONT),c=r._isKeyDownForAction(r.AXIS_VIEW_TOP),u=r._isKeyDownForAction(r.AXIS_VIEW_BOTTOM);if(!(a||n||l||h||c||u))return;const p=t.aabb,_=d.getAABB3Diag(p);d.getAABB3Center(p,Ah);const f=Math.abs(_/Math.tan(e.cameraFlight.fitFOV*d.DEGTORAD)),g=1.1*_;Bh.orthoScale=g,a?(Bh.eye.set(d.addVec3(Ah,d.mulVec3Scalar(o.worldRight,f,Ch),Lh)),Bh.look.set(Ah),Bh.up.set(o.worldUp)):n?(Bh.eye.set(d.addVec3(Ah,d.mulVec3Scalar(o.worldForward,f,Ch),Lh)),Bh.look.set(Ah),Bh.up.set(o.worldUp)):l?(Bh.eye.set(d.addVec3(Ah,d.mulVec3Scalar(o.worldRight,-f,Ch),Lh)),Bh.look.set(Ah),Bh.up.set(o.worldUp)):h?(Bh.eye.set(d.addVec3(Ah,d.mulVec3Scalar(o.worldForward,-f,Ch),Lh)),Bh.look.set(Ah),Bh.up.set(o.worldUp)):c?(Bh.eye.set(d.addVec3(Ah,d.mulVec3Scalar(o.worldUp,f,Ch),Lh)),Bh.look.set(Ah),Bh.up.set(d.normalizeVec3(d.mulVec3Scalar(o.worldForward,1,Sh),Dh))):u&&(Bh.eye.set(d.addVec3(Ah,d.mulVec3Scalar(o.worldUp,-f,Ch),Lh)),Bh.look.set(Ah),Bh.up.set(d.normalizeVec3(d.mulVec3Scalar(o.worldForward,-1,Sh)))),!i.firstPerson&&i.followPointer&&e.pivotController.setPivotPos(Ah),e.cameraFlight.duration>0?e.cameraFlight.flyTo(Bh,(()=>{e.pivotController.getPivoting()&&i.followPointer&&e.pivotController.showPivot()})):(e.cameraFlight.jumpTo(Bh),e.pivotController.getPivoting()&&i.followPointer&&e.pivotController.showPivot())}))}reset(){}destroy(){this._scene.input.off(this._onSceneKeyDown)}}class Th{constructor(t,e,i,s,r){this._scene=t;const o=e.pickController,a=e.pivotController,n=e.cameraControl;this._clicks=0,this._timeout=null,this._lastPickedEntityId=null;let l=!1,h=!1;const c=this._scene.canvas.canvas,u=i=>{let s;i&&i.worldPos&&(s=i.worldPos);const r=i&&i.entity?i.entity.aabb:t.aabb;if(s){const i=t.camera;d.subVec3(i.eye,i.look,[]),e.cameraFlight.flyTo({aabb:r})}else e.cameraFlight.flyTo({aabb:r})};c.addEventListener("mousemove",this._canvasMouseMoveHandler=e=>{if(!i.active||!i.pointerEnabled)return;if(l||h)return;const r=n.hasSubs("hover"),a=n.hasSubs("hoverOut"),c=n.hasSubs("hoverOff"),u=n.hasSubs("hoverSurface");if(r||a||c||u)if(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=!0,o.schedulePickSurface=u,o.update(),o.pickResult){const e=o.pickResult.entity.id;this._lastPickedEntityId!==e&&(void 0!==this._lastPickedEntityId&&n.fire("hoverOut",{entity:t.objects[this._lastPickedEntityId]},!0),n.fire("hoverEnter",o.pickResult,!0),this._lastPickedEntityId=e),n.fire("hover",o.pickResult,!0),o.pickResult.worldPos&&n.fire("hoverSurface",o.pickResult,!0)}else void 0!==this._lastPickedEntityId&&(n.fire("hoverOut",{entity:t.objects[this._lastPickedEntityId]},!0),this._lastPickedEntityId=void 0),n.fire("hoverOff",{canvasPos:o.pickCursorPos},!0)}),c.addEventListener("mousedown",this._canvasMouseDownHandler=e=>{1===e.which&&(l=!0),3===e.which&&(h=!0);if(1===e.which&&i.active&&i.pointerEnabled&&(s.mouseDownClientX=e.clientX,s.mouseDownClientY=e.clientY,s.mouseDownCursorX=s.pointerCanvasPos[0],s.mouseDownCursorY=s.pointerCanvasPos[1],!i.firstPerson&&i.followPointer&&(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickSurface=!0,o.update(),1===e.which))){const e=o.pickResult;e&&e.worldPos?(a.setPivotPos(e.worldPos),a.startPivot()):(i.smartPivot?a.setCanvasPivotPos(s.pointerCanvasPos):a.setPivotPos(t.camera.look),a.startPivot())}}),document.addEventListener("mouseup",this._documentMouseUpHandler=t=>{1===t.which&&(l=!1),3===t.which&&(h=!1)}),c.addEventListener("mouseup",this._canvasMouseUpHandler=r=>{if(!i.active||!i.pointerEnabled)return;if(!(1===r.which))return;if(a.hidePivot(),Math.abs(r.clientX-s.mouseDownClientX)>3||Math.abs(r.clientY-s.mouseDownClientY)>3)return;const l=n.hasSubs("picked"),h=n.hasSubs("pickedNothing"),c=n.hasSubs("pickedSurface"),p=n.hasSubs("doublePicked"),_=n.hasSubs("doublePickedSurface"),f=n.hasSubs("doublePickedNothing");if(!(i.doublePickFlyTo||p||_||f))return(l||h||c)&&(o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=!0,o.schedulePickSurface=c,o.update(),o.pickResult?(n.fire("picked",o.pickResult,!0),o.pickedSurface&&n.fire("pickedSurface",o.pickResult,!0)):n.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0)),void(this._clicks=0);if(this._clicks++,1===this._clicks)this._timeout=setTimeout((()=>{o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=i.doublePickFlyTo,o.schedulePickSurface=c,o.update(),o.pickResult?(n.fire("picked",o.pickResult,!0),o.pickedSurface&&(n.fire("pickedSurface",o.pickResult,!0),!i.firstPerson&&i.followPointer&&(e.pivotController.setPivotPos(o.pickResult.worldPos),e.pivotController.startPivot()&&e.pivotController.showPivot()))):n.fire("pickedNothing",{canvasPos:s.pointerCanvasPos},!0),this._clicks=0}),250);else{if(null!==this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null),o.pickCursorPos=s.pointerCanvasPos,o.schedulePickEntity=i.doublePickFlyTo||p||_,o.schedulePickSurface=o.schedulePickEntity&&_,o.update(),o.pickResult){if(n.fire("doublePicked",o.pickResult,!0),o.pickedSurface&&n.fire("doublePickedSurface",o.pickResult,!0),i.doublePickFlyTo&&(u(o.pickResult),!i.firstPerson&&i.followPointer)){const t=o.pickResult.entity.aabb,i=d.getAABB3Center(t);e.pivotController.setPivotPos(i),e.pivotController.startPivot()&&e.pivotController.showPivot()}}else if(n.fire("doublePickedNothing",{canvasPos:s.pointerCanvasPos},!0),i.doublePickFlyTo&&(u(),!i.firstPerson&&i.followPointer)){const i=t.aabb,s=d.getAABB3Center(i);e.pivotController.setPivotPos(s),e.pivotController.startPivot()&&e.pivotController.showPivot()}this._clicks=0}},!1)}reset(){this._clicks=0,this._lastPickedEntityId=null,this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}destroy(){const t=this._scene.canvas.canvas;t.removeEventListener("mousemove",this._canvasMouseMoveHandler),t.removeEventListener("mousedown",this._canvasMouseDownHandler),document.removeEventListener("mouseup",this._documentMouseUpHandler),t.removeEventListener("mouseup",this._canvasMouseUpHandler),this._timeout&&(window.clearTimeout(this._timeout),this._timeout=null)}}class Fh{constructor(t,e,i,s,r){this._scene=t;const o=t.input,a=[],n=t.canvas.canvas;let l=!0;this._onSceneMouseMove=o.on("mousemove",(()=>{l=!0})),this._onSceneKeyDown=o.on("keydown",(e=>{i.active&&i.pointerEnabled&&t.input.keyboardEnabled&&s.mouseover&&(a[e]=!0,e===o.KEY_SHIFT&&(n.style.cursor="move"))})),this._onSceneKeyUp=o.on("keyup",(e=>{i.active&&i.pointerEnabled&&t.input.keyboardEnabled&&s.mouseover&&(a[e]=!1,e===o.KEY_SHIFT&&(n.style.cursor=null))})),this._onTick=t.on("tick",(n=>{if(!i.active||!i.pointerEnabled||!t.input.keyboardEnabled)return;if(!s.mouseover)return;const h=e.cameraControl,c=n.deltaTime/1e3;if(!i.planView){const t=h._isKeyDownForAction(h.ROTATE_Y_POS,a),s=h._isKeyDownForAction(h.ROTATE_Y_NEG,a),o=h._isKeyDownForAction(h.ROTATE_X_POS,a),n=h._isKeyDownForAction(h.ROTATE_X_NEG,a),l=c*i.keyboardRotationRate;(t||s||o||n)&&(!i.firstPerson&&i.followPointer&&e.pivotController.startPivot(),t?r.rotateDeltaY+=l:s&&(r.rotateDeltaY-=l),o?r.rotateDeltaX+=l:n&&(r.rotateDeltaX-=l),!i.firstPerson&&i.followPointer&&e.pivotController.startPivot())}if(!a[o.KEY_CTRL]&&!a[o.KEY_ALT]){const t=h._isKeyDownForAction(h.DOLLY_BACKWARDS,a),o=h._isKeyDownForAction(h.DOLLY_FORWARDS,a);if(t||o){const a=c*i.keyboardDollyRate;!i.firstPerson&&i.followPointer&&e.pivotController.startPivot(),o?r.dollyDelta-=a:t&&(r.dollyDelta+=a),l&&(s.followPointerDirty=!0,l=!1)}}const u=h._isKeyDownForAction(h.PAN_FORWARDS,a),d=h._isKeyDownForAction(h.PAN_BACKWARDS,a),p=h._isKeyDownForAction(h.PAN_LEFT,a),_=h._isKeyDownForAction(h.PAN_RIGHT,a),f=h._isKeyDownForAction(h.PAN_UP,a),g=h._isKeyDownForAction(h.PAN_DOWN,a),m=(a[o.KEY_ALT]?.3:1)*c*i.keyboardPanRate;(u||d||p||_||f||g)&&(!i.firstPerson&&i.followPointer&&e.pivotController.startPivot(),g?r.panDeltaY+=m:f&&(r.panDeltaY+=-m),_?r.panDeltaX+=-m:p&&(r.panDeltaX+=m),d?r.panDeltaZ+=m:u&&(r.panDeltaZ+=-m))}))}reset(){}destroy(){this._scene.off(this._onTick),this._scene.input.off(this._onSceneMouseMove),this._scene.input.off(this._onSceneKeyDown),this._scene.input.off(this._onSceneKeyUp)}}const Nh=d.vec3();class Ih{constructor(t,e,i,s,r){this._scene=t;const o=t.camera,a=e.pickController,n=e.pivotController,l=e.panController;let h=1,c=1,u=null;this._onTick=t.on("tick",(()=>{if(!i.active||!i.pointerEnabled)return;let e="default";if(Math.abs(r.dollyDelta)<.001&&(r.dollyDelta=0),Math.abs(r.rotateDeltaX)<.001&&(r.rotateDeltaX=0),Math.abs(r.rotateDeltaY)<.001&&(r.rotateDeltaY=0),0===r.rotateDeltaX&&0===r.rotateDeltaY||(r.dollyDelta=0),i.followPointer&&--h<=0&&(h=1,0!==r.dollyDelta)){if(0===r.rotateDeltaY&&0===r.rotateDeltaX&&i.followPointer&&s.followPointerDirty&&(a.pickCursorPos=s.pointerCanvasPos,a.schedulePickSurface=!0,a.update(),a.pickResult&&a.pickResult.worldPos?u=a.pickResult.worldPos:(c=1,u=null),s.followPointerDirty=!1),u){const e=Math.abs(d.lenVec3(d.subVec3(u,t.camera.eye,Nh)));c=e/i.dollyProximityThreshold}c<i.dollyMinSpeed&&(c=i.dollyMinSpeed)}const p=r.dollyDelta*c;if(0===r.rotateDeltaY&&0===r.rotateDeltaX||(!i.firstPerson&&i.followPointer&&n.getPivoting()?(n.continuePivot(r.rotateDeltaY,r.rotateDeltaX),n.showPivot()):(0!==r.rotateDeltaX&&(i.firstPerson?o.pitch(-r.rotateDeltaX):o.orbitPitch(r.rotateDeltaX)),0!==r.rotateDeltaY&&(i.firstPerson?o.yaw(r.rotateDeltaY):o.orbitYaw(r.rotateDeltaY))),r.rotateDeltaX*=i.rotationInertia,r.rotateDeltaY*=i.rotationInertia,e="grabbing"),Math.abs(r.panDeltaX)<.001&&(r.panDeltaX=0),Math.abs(r.panDeltaY)<.001&&(r.panDeltaY=0),Math.abs(r.panDeltaZ)<.001&&(r.panDeltaZ=0),0!==r.panDeltaX||0!==r.panDeltaY||0!==r.panDeltaZ){const t=d.vec3();let s,a;if(t[0]=r.panDeltaX,t[1]=r.panDeltaY,t[2]=r.panDeltaZ,i.constrainVertical){o.xUp?(s=o.eye[0],a=o.look[0]):o.yUp?(s=o.eye[1],a=o.look[1]):o.zUp&&(s=o.eye[2],a=o.look[2]),o.pan(t);const e=o.eye,i=o.look;o.xUp?(e[0]=s,i[0]=a):o.yUp?(e[1]=s,i[1]=a):o.zUp&&(e[2]=s,i[2]=a),o.eye=e,o.look=i}else o.pan(t);e="grabbing"}if(r.panDeltaX*=i.panInertia,r.panDeltaY*=i.panInertia,r.panDeltaZ*=i.panInertia,0!==p){if(e=p<0?"zoom-in":"zoom-out",i.firstPerson){let t,e;if(i.constrainVertical&&(o.xUp?(t=o.eye[0],e=o.look[0]):o.yUp?(t=o.eye[1],e=o.look[1]):o.zUp&&(t=o.eye[2],e=o.look[2])),i.followPointer){l.dollyToCanvasPos(u,s.pointerCanvasPos,-p)&&(s.followPointerDirty=!0)}else o.pan([0,0,p]),o.ortho.scale=o.ortho.scale-p;if(i.constrainVertical){const i=o.eye,s=o.look;o.xUp?(i[0]=t,s[0]=e):o.yUp?(i[1]=t,s[1]=e):o.zUp&&(i[2]=t,s[2]=e),o.eye=i,o.look=s}}else if(i.planView)if(i.followPointer){l.dollyToCanvasPos(u,s.pointerCanvasPos,-p)&&(s.followPointerDirty=!0)}else o.ortho.scale=o.ortho.scale+p,o.zoom(p);else if(i.followPointer){l.dollyToCanvasPos(u,s.pointerCanvasPos,-p)&&(s.followPointerDirty=!0)}else o.ortho.scale=o.ortho.scale+p,o.zoom(p);r.dollyDelta*=i.dollyInertia}a.fireEvents(),document.body.style.cursor=e}))}destroy(){this._scene.off(this._onTick)}}class kh{constructor(t,e,i,s,r){this._scene=t;const o=this._scene.canvas.canvas;o.addEventListener("mouseenter",this._mouseEnterHandler=()=>{s.mouseover=!0}),o.addEventListener("mouseleave",this._mouseLeaveHandler=()=>{s.mouseover=!1,o.style.cursor=null}),document.addEventListener("mousemove",this._mouseMoveHandler=t=>{Oh(t,o,s.pointerCanvasPos)}),o.addEventListener("mousedown",this._mouseDownHandler=t=>{i.active&&i.pointerEnabled&&(Oh(t,o,s.pointerCanvasPos),s.mouseover=!0)}),o.addEventListener("mouseup",this._mouseUpHandler=t=>{i.active&&i.pointerEnabled})}reset(){}destroy(){const t=this._scene.canvas.canvas;document.removeEventListener("mousemove",this._mouseMoveHandler),t.removeEventListener("mouseenter",this._mouseEnterHandler),t.removeEventListener("mouseleave",this._mouseLeaveHandler),t.removeEventListener("mousedown",this._mouseDownHandler),t.removeEventListener("mouseup",this._mouseUpHandler)}}function Oh(t,e,i){if(t){const{x:s,y:r}=e.getBoundingClientRect();i[0]=t.clientX-s,i[1]=t.clientY-r}else t=window.event,i[0]=t.x,i[1]=t.y;return i}const Vh=function(t,e){if(t){let i=t.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e[0]=t.x,e[1]=t.y;return e};class zh{constructor(t,e,i,s,r){this._scene=t;const o=e.pickController,a=e.pivotController,n=d.vec2(),l=d.vec2(),h=d.vec2(),c=d.vec2(),u=[],p=this._scene.canvas.canvas;let _=0,f=!1;this._onTick=t.on("tick",(()=>{f=!1})),p.addEventListener("touchstart",this._canvasTouchStartHandler=e=>{if(!i.active||!i.pointerEnabled)return;e.preventDefault();const r=e.touches,l=e.changedTouches;for(s.touchStartTime=Date.now(),1===r.length&&1===l.length&&(s.touchStartTime,Vh(r[0],n),i.followPointer&&(o.pickCursorPos=n,o.schedulePickSurface=!0,o.update(),i.planView||(o.picked&&o.pickedSurface&&o.pickResult&&o.pickResult.worldPos?(a.setPivotPos(o.pickResult.worldPos),!i.firstPerson&&a.startPivot()&&a.showPivot()):(i.smartPivot?a.setCanvasPivotPos(s.pointerCanvasPos):a.setPivotPos(t.camera.look),!i.firstPerson&&a.startPivot()&&a.showPivot()))));u.length<r.length;)u.push(d.vec2());for(let t=0,e=r.length;t<e;++t)Vh(r[t],u[t]);_=r.length}),p.addEventListener("touchmove",this._canvasTouchMoveHandler=e=>{if(!i.active||!i.pointerEnabled)return;if(e.stopPropagation(),e.preventDefault(),f)return;f=!0;const a=t.canvas.boundary,n=a[2]-a[0],p=a[3]-a[1],g=e.touches;if(e.touches.length===_){if(1===_){Vh(g[0],l),d.subVec2(l,u[0],c);const e=c[0],o=c[1];if(null!==s.longTouchTimeout&&(Math.abs(e)>i.longTapRadius||Math.abs(o)>i.longTapRadius)&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null),i.planView){const s=t.camera;if("perspective"===s.projection){const a=Math.abs(t.camera.eyeLookDist)*Math.tan(s.perspective.fov/2*Math.PI/180);r.panDeltaX+=e*a/p*i.touchPanRate,r.panDeltaY+=o*a/p*i.touchPanRate}else r.panDeltaX+=.5*s.ortho.scale*(e/p)*i.touchPanRate,r.panDeltaY+=.5*s.ortho.scale*(o/p)*i.touchPanRate}else r.rotateDeltaY-=e/n*(1*i.dragRotationRate),r.rotateDeltaX+=o/p*(1.5*i.dragRotationRate)}else if(2===_){const e=g[0],a=g[1];Vh(e,l),Vh(a,h);const n=d.geometricMeanVec2(u[0],u[1]),c=d.geometricMeanVec2(l,h),_=d.vec2();d.subVec2(n,c,_);const f=_[0],m=_[1],v=t.camera,b=d.distVec2([e.pageX,e.pageY],[a.pageX,a.pageY]),P=(d.distVec2(u[0],u[1])-b)*i.touchDollyRate;if(r.dollyDelta=P,Math.abs(P)<1)if("perspective"===v.projection){const e=o.pickResult?o.pickResult.worldPos:t.center,s=Math.abs(d.lenVec3(d.subVec3(e,t.camera.eye,[])))*Math.tan(v.perspective.fov/2*Math.PI/180);r.panDeltaX-=f*s/p*i.touchPanRate,r.panDeltaY-=m*s/p*i.touchPanRate}else r.panDeltaX-=.5*v.ortho.scale*(f/p)*i.touchPanRate,r.panDeltaY-=.5*v.ortho.scale*(m/p)*i.touchPanRate;s.pointerCanvasPos=c}for(let t=0;t<_;++t)Vh(g[t],u[t])}})}reset(){}destroy(){const t=this._scene.canvas.canvas;t.removeEventListener("touchstart",this._canvasTouchStartHandler),t.removeEventListener("touchmove",this._canvasTouchMoveHandler),this._scene.off(this._onTick)}}const Uh=function(t,e){if(t){let i=t.target,s=0,r=0;for(;i.offsetParent;)s+=i.offsetLeft,r+=i.offsetTop,i=i.offsetParent;e[0]=t.pageX-s,e[1]=t.pageY-r}else t=window.event,e[0]=t.x,e[1]=t.y;return e};class Gh{constructor(t,e,i,s,r){this._scene=t;const o=e.pickController,a=e.cameraControl;let n;const l=[],h=new Float32Array(2);let c=-1,u=-1;const p=this._scene.canvas.canvas,_=i=>{let s;i&&i.worldPos&&(s=i.worldPos);const r=i?i.entity.aabb:t.aabb;if(s){const i=t.camera;d.subVec3(i.eye,i.look,[]),e.cameraFlight.flyTo({aabb:r})}else e.cameraFlight.flyTo({aabb:r})};p.addEventListener("touchstart",this._canvasTouchStartHandler=t=>{if(!i.active||!i.pointerEnabled)return;null!==s.longTouchTimeout&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null);const r=t.touches,o=t.changedTouches;if(n=Date.now(),1===r.length&&1===o.length){c=n,Uh(r[0],h);const o=h[0],a=h[1],l=r[0].pageX,u=r[0].pageY;s.longTouchTimeout=setTimeout((()=>{e.cameraControl.fire("rightClick",{pagePos:[Math.round(l),Math.round(u)],canvasPos:[Math.round(o),Math.round(a)],event:t},!0),s.longTouchTimeout=null}),i.longTapTimeout)}else c=-1;for(;l.length<r.length;)l.push(new Float32Array(2));for(let t=0,e=r.length;t<e;++t)Uh(r[t],l[t]);l.length=r.length},{passive:!0}),p.addEventListener("touchend",this._canvasTouchEndHandler=t=>{if(!i.active||!i.pointerEnabled)return;const e=Date.now(),r=t.touches,n=t.changedTouches,p=a.hasSubs("pickedSurface");null!==s.longTouchTimeout&&(clearTimeout(s.longTouchTimeout),s.longTouchTimeout=null),0===r.length&&1===n.length&&c>-1&&e-c<150&&(u>-1&&c-u<325?(Uh(n[0],o.pickCursorPos),o.schedulePickEntity=!0,o.schedulePickSurface=p,o.update(),o.pickResult?(a.fire("doublePicked",o.pickResult),o.pickedSurface&&a.fire("doublePickedSurface",o.pickResult),i.doublePickFlyTo&&_(o.pickResult)):(a.fire("doublePickedNothing"),i.doublePickFlyTo&&_()),u=-1):d.distVec2(l[0],h)<4&&(Uh(n[0],o.pickCursorPos),o.schedulePickEntity=!0,o.schedulePickSurface=p,o.update(),o.pickResult?(a.fire("picked",o.pickResult),o.pickedSurface&&a.fire("pickedSurface",o.pickResult)):a.fire("pickedNothing"),u=e),c=-1),l.length=r.length;for(let t=0,e=r.length;t<e;++t)l[t][0]=r[t].pageX,l[t][1]=r[t].pageY;t.stopPropagation()},{passive:!0})}reset(){}destroy(){const t=this._scene.canvas.canvas;t.removeEventListener("touchstart",this._canvasTouchStartHandler),t.removeEventListener("touchend",this._canvasTouchEndHandler)}}class jh extends S{constructor(t,e={}){super(t,e),this.PAN_LEFT=0,this.PAN_RIGHT=1,this.PAN_UP=2,this.PAN_DOWN=3,this.PAN_FORWARDS=4,this.PAN_BACKWARDS=5,this.ROTATE_X_POS=6,this.ROTATE_X_NEG=7,this.ROTATE_Y_POS=8,this.ROTATE_Y_NEG=9,this.DOLLY_FORWARDS=10,this.DOLLY_BACKWARDS=11,this.AXIS_VIEW_RIGHT=12,this.AXIS_VIEW_BACK=13,this.AXIS_VIEW_LEFT=14,this.AXIS_VIEW_FRONT=15,this.AXIS_VIEW_TOP=16,this.AXIS_VIEW_BOTTOM=17,this._keyMap={},this.scene.canvas.canvas.oncontextmenu=t=>{t.preventDefault()},this._configs={longTapTimeout:600,longTapRadius:5,active:!0,keyboardLayout:"qwerty",navMode:"orbit",planView:!1,firstPerson:!1,followPointer:!0,doublePickFlyTo:!0,panRightClick:!0,showPivot:!1,pointerEnabled:!0,constrainVertical:!1,smartPivot:!1,dragRotationRate:360,keyboardRotationRate:90,rotationInertia:0,keyboardPanRate:1,touchPanRate:1,panInertia:.5,keyboardDollyRate:10,mouseWheelDollyRate:100,touchDollyRate:.2,dollyInertia:0,dollyProximityThreshold:30,dollyMinSpeed:.04},this._states={pointerCanvasPos:d.vec2(),mouseover:!1,followPointerDirty:!0,mouseDownClientX:0,mouseDownClientY:0,mouseDownCursorX:0,mouseDownCursorY:0,touchStartTime:null,activeTouches:[],tapStartPos:d.vec2(),tapStartTime:-1,lastTapTime:-1,longTouchTimeout:null},this._updates={rotateDeltaX:0,rotateDeltaY:0,panDeltaX:0,panDeltaY:0,panDeltaZ:0,dollyDelta:0};const i=this.scene;this._controllers={cameraControl:this,pickController:new xh(this,this._configs),pivotController:new Mh(i,this._configs),panController:new fh(i),cameraFlight:new Dl(this,{duration:.5})},this._handlers=[new kh(this.scene,this._controllers,this._configs,this._states,this._updates),new zh(this.scene,this._controllers,this._configs,this._states,this._updates),new Eh(this.scene,this._controllers,this._configs,this._states,this._updates),new Rh(this.scene,this._controllers,this._configs,this._states,this._updates),new Th(this.scene,this._controllers,this._configs,this._states,this._updates),new Gh(this.scene,this._controllers,this._configs,this._states,this._updates),new Fh(this.scene,this._controllers,this._configs,this._states,this._updates)],this._cameraUpdater=new Ih(this.scene,this._controllers,this._configs,this._states,this._updates),this.navMode=e.navMode,e.planView&&(this.planView=e.planView),this.constrainVertical=e.constrainVertical,e.keyboardLayout?this.keyboardLayout=e.keyboardLayout:this.keyMap=e.keyMap,this.doublePickFlyTo=e.doublePickFlyTo,this.panRightClick=e.panRightClick,this.active=e.active,this.followPointer=e.followPointer,this.rotationInertia=e.rotationInertia,this.keyboardPanRate=e.keyboardPanRate,this.touchPanRate=e.touchPanRate,this.keyboardRotationRate=e.keyboardRotationRate,this.dragRotationRate=e.dragRotationRate,this.touchDollyRate=e.touchDollyRate,this.dollyInertia=e.dollyInertia,this.dollyProximityThreshold=e.dollyProximityThreshold,this.dollyMinSpeed=e.dollyMinSpeed,this.panInertia=e.panInertia,this.pointerEnabled=!0,this.keyboardDollyRate=e.keyboardDollyRate,this.mouseWheelDollyRate=e.mouseWheelDollyRate}set keyMap(t){if(t=t||"qwerty",m.isString(t)){const e=this.scene.input,i={};switch(t){default:this.error("Unsupported value for 'keyMap': "+t+" defaulting to 'qwerty'");case"qwerty":i[this.PAN_LEFT]=[e.KEY_A],i[this.PAN_RIGHT]=[e.KEY_D],i[this.PAN_UP]=[e.KEY_Z],i[this.PAN_DOWN]=[e.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[e.KEY_W,e.KEY_ADD],i[this.DOLLY_BACKWARDS]=[e.KEY_S,e.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[e.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[e.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[e.KEY_Q,e.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[e.KEY_E,e.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[e.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[e.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[e.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[e.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[e.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[e.KEY_NUM_6];break;case"azerty":i[this.PAN_LEFT]=[e.KEY_Q],i[this.PAN_RIGHT]=[e.KEY_D],i[this.PAN_UP]=[e.KEY_W],i[this.PAN_DOWN]=[e.KEY_X],i[this.PAN_BACKWARDS]=[],i[this.PAN_FORWARDS]=[],i[this.DOLLY_FORWARDS]=[e.KEY_Z,e.KEY_ADD],i[this.DOLLY_BACKWARDS]=[e.KEY_S,e.KEY_SUBTRACT],i[this.ROTATE_X_POS]=[e.KEY_DOWN_ARROW],i[this.ROTATE_X_NEG]=[e.KEY_UP_ARROW],i[this.ROTATE_Y_POS]=[e.KEY_A,e.KEY_LEFT_ARROW],i[this.ROTATE_Y_NEG]=[e.KEY_E,e.KEY_RIGHT_ARROW],i[this.AXIS_VIEW_RIGHT]=[e.KEY_NUM_1],i[this.AXIS_VIEW_BACK]=[e.KEY_NUM_2],i[this.AXIS_VIEW_LEFT]=[e.KEY_NUM_3],i[this.AXIS_VIEW_FRONT]=[e.KEY_NUM_4],i[this.AXIS_VIEW_TOP]=[e.KEY_NUM_5],i[this.AXIS_VIEW_BOTTOM]=[e.KEY_NUM_6]}this._keyMap=i}else{const e=t;this._keyMap=e}}get keyMap(){return this._keyMap}_isKeyDownForAction(t,e){const i=this._keyMap[t];if(!i)return!1;e||(e=this.scene.input.keyDown);for(let t=0,s=i.length;t<s;t++){if(e[i[t]])return!0}return!1}set pivotElement(t){this._controllers.pivotController.setPivotElement(t)}set active(t){this._configs.active=!1!==t}get active(){return this._configs.active}set navMode(t){"firstPerson"!==(t=t||"orbit")&&"orbit"!==t&&"planView"!==t&&(this.error("Unsupported value for navMode: "+t+" - supported values are 'orbit', 'firstPerson' and 'planView' - defaulting to 'orbit'"),t="orbit"),this._configs.firstPerson="firstPerson"===t,this._configs.planView="planView"===t,(this._configs.firstPerson||this._configs.planView)&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this._configs.navMode=t}get navMode(){return this._configs.navMode}set pointerEnabled(t){this._reset(),this._configs.pointerEnabled=!!t}_reset(){for(let t=0,e=this._handlers.length;t<e;t++){const e=this._handlers[t];e.reset&&e.reset()}this._updates.panDeltaX=0,this._updates.panDeltaY=0,this._updates.rotateDeltaX=0,this._updates.rotateDeltaY=0,this._updates.dolyDelta=0}get pointerEnabled(){return this._configs.pointerEnabled}set followPointer(t){this._configs.followPointer=!1!==t}get followPointer(){return this._configs.followPointer}set pivotPos(t){this._controllers.pivotController.setPivotPos(t)}get pivotPos(){return this._controllers.pivotController.getPivotPos()}set dollyToPointer(t){this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer=t}get dollyToPointer(){return this.warn("dollyToPointer property is deprecated - replaced with followPointer"),this.followPointer}set panToPointer(t){this.warn("panToPointer property is deprecated - replaced with followPointer")}get panToPointer(){return this.warn("panToPointer property is deprecated - replaced with followPointer"),!1}set planView(t){this._configs.planView=!!t,this._configs.firstPerson=!1,this._configs.planView&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot()),this.warn("planView property is deprecated - replaced with navMode")}get planView(){return this.warn("planView property is deprecated - replaced with navMode"),this._configs.planView}set firstPerson(t){this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson=!!t,this._configs.planView=!1,this._configs.firstPerson&&(this._controllers.pivotController.hidePivot(),this._controllers.pivotController.endPivot())}get firstPerson(){return this.warn("firstPerson property is deprecated - replaced with navMode"),this._configs.firstPerson}set constrainVertical(t){this._configs.constrainVertical=!!t}get constrainVertical(){return this._configs.constrainVertical}set doublePickFlyTo(t){this._configs.doublePickFlyTo=!1!==t}get doublePickFlyTo(){return this._configs.doublePickFlyTo}set panRightClick(t){this._configs.panRightClick=!1!==t}get panRightClick(){return this._configs.panRightClick}set rotationInertia(t){this._configs.rotationInertia=null!=t?t:0}get rotationInertia(){return this._configs.rotationInertia}set keyboardPanRate(t){this._configs.keyboardPanRate=null!=t?t:5}set touchPanRate(t){this._configs.touchPanRate=null!=t?t:1}get touchPanRate(){return this._configs.touchPanRate}get keyboardPanRate(){return this._configs.keyboardPanRate}set keyboardRotationRate(t){this._configs.keyboardRotationRate=null!=t?t:90}get keyboardRotationRate(){return this._configs.keyboardRotationRate}set dragRotationRate(t){this._configs.dragRotationRate=null!=t?t:360}get dragRotationRate(){return this._configs.dragRotationRate}set keyboardDollyRate(t){this._configs.keyboardDollyRate=null!=t?t:15}get keyboardDollyRate(){return this._configs.keyboardDollyRate}set touchDollyRate(t){this._configs.touchDollyRate=null!=t?t:.2}get touchDollyRate(){return this._configs.touchDollyRate}set mouseWheelDollyRate(t){this._configs.mouseWheelDollyRate=null!=t?t:100}get mouseWheelDollyRate(){return this._configs.mouseWheelDollyRate}set dollyInertia(t){this._configs.dollyInertia=null!=t?t:0}get dollyInertia(){return this._configs.dollyInertia}set dollyProximityThreshold(t){this._configs.dollyProximityThreshold=null!=t?t:35}get dollyProximityThreshold(){return this._configs.dollyProximityThreshold}set dollyMinSpeed(t){this._configs.dollyMinSpeed=null!=t?t:.04}get dollyMinSpeed(){return this._configs.dollyMinSpeed}set panInertia(t){this._configs.panInertia=null!=t?t:.5}get panInertia(){return this._configs.panInertia}set keyboardLayout(t){"qwerty"!==(t=t||"qwerty")&&"azerty"!==t&&(this.error("Unsupported value for keyboardLayout - defaulting to 'qwerty'"),t="qwerty"),this._configs.keyboardLayout=t,this.keyMap=this._configs.keyboardLayout}get keyboardLayout(){return this._configs.keyboardLayout}enablePivotSphere(t={}){this._controllers.pivotController.enablePivotSphere(t)}disablePivotSphere(){this._controllers.pivotController.disablePivotSphere()}set smartPivot(t){this._configs.smartPivot=!1!==t}get smartPivot(){return this._configs.smartPivot}destroy(){this._destroyHandlers(),this._destroyControllers(),this._cameraUpdater.destroy(),super.destroy()}_destroyHandlers(){for(let t=0,e=this._handlers.length;t<e;t++){const e=this._handlers[t];e.destroy&&e.destroy()}}_destroyControllers(){for(let t=0,e=this._controllers.length;t<e;t++){const e=this._controllers[t];e.destroy&&e.destroy()}}}class Xh{constructor(t,e,i,s,r,o,a,n,l,h){this.id=e,this.projectId=i,this.revisionId=s,this.author=r,this.createdAt=o,this.creatingApplication=a,this.schema=n,this.metaScene=t,this.propertySets=l,this.rootMetaObject=h}getJSON(){const t=[];!function e(i){const s={id:i.id,extId:i.extId,type:i.type,name:i.name};i.parent&&(s.parent=i.parent.id),t.push(s);const r=i.children;if(r)for(let t=0,i=r.length;t<i;t++)e(r[t])}(this.rootMetaObject);return{id:this.id,projectId:this.projectId,revisionId:this.revisionId,metaObjects:t}}}class Wh{constructor(t,e,i,s,r,o,a,n,l){this.metaModel=t,this.id=e,this.originalSystemId=i,this.name=s,this.type=r,this.propertySets=o,null!=a&&(this.parent=a),null!=n&&(this.children=n),null!=l&&(this.external=l)}getObjectIDsInSubtree(){const t=[];return function e(i){if(!i)return;t.push(i.id);const s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)e(s[r])}(this),t}withMetaObjectsInSubtree(t){!function e(i){if(!i)return;t(i);const s=i.children;if(s)for(var r=0,o=s.length;r<o;r++)e(s[r])}(this)}getObjectIDsInSubtreeByType(t){const e={};for(var i=0,s=t.length;i<s;i++)e[t[i]]=t[i];const r=[];return function t(i){if(!i)return;e[i.type]&&r.push(i.id);const s=i.children;if(s)for(var o=0,a=s.length;o<a;o++)t(s[o])}(this),r}getJSON(){var t={id:this.id,type:this.type,name:this.name};return this.parent&&(t.parent=this.parent.id),t}}class Hh{constructor(t,e,i,s,r){this.name=t,this.type=i,this.value=e,this.valueType=s,this.description=r}}class Yh{constructor(t,e,i,s,r){if(this.id=t,this.originalSystemId=e,this.name=i,this.type=s,this.properties=[],r)for(let t=0,e=r.length;t<e;t++){const e=r[t];this.properties.push(new Hh(e.name,e.value,e.type,e.valueType,e.description))}}}class Kh{constructor(t,e){this.viewer=t,this.scene=e,this.metaModels={},this.propertySets={},this.metaObjects={},this.metaObjectsByType={},this._typeCounts={},this._eventSubs={}}on(t,e){let i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)}fire(t,e){const i=this._eventSubs[t];if(i)for(let t=0,s=i.length;t<s;t++)i[t](e)}off(t){}createMetaModel(t,e,i={}){const s=e.projectId||"none",r=e.revisionId||"none",o=e.propertySets||[],a=e.metaObjects||[],n=e.author,l=e.createdAt,h=e.creatingApplication,c=e.schema,u=new Xh(this,t,s,r,n,l,h,c,[],null);this.metaModels[t]=u;for(let t=0,e=o.length;t<e;t++){const e=o[t],i=e.id,s=new Yh(i,e.originalSystemId,e.name,e.type,e.properties);u.propertySets[i]=s,this.propertySets[i]=s}const p=[];for(let t=0,e=a.length;t<e;t++){const e=a[t];void 0!==e.parent&&null!==e.parent||p.push(e)}if(0===p.length){this.scene.error("Cyclic containment hierarchy found in metamodel - will flatten the hierarchy and insert fake 'Model' root");const e={id:t+".fakeRoot",name:t,type:"Model",parent:null};for(let t=0,i=a.length;t<i;t++)a[t].parent=e.id;a.push(e)}if(p.length>1){this.scene.error("Multiple containment hierarchy root found in metamodel - will insert fake 'Model' root");const e={id:t+".fakeRoot",name:t,type:"Model",parent:null};a.push(e);for(let t=0,i=p.length;t<i;t++)p[t].parent=e.id}for(let e=0,s=a.length;e<s;e++){const s=a[e],r=s.type,o=i.globalizeObjectIds?d.globalizeObjectId(t,s.id):s.id,n=s.id,l=s.name,h=[];if(s.propertySetIds&&s.propertySetIds.length>0)for(let t=0,e=s.propertySetIds.length;t<e;t++){const e=s.propertySetIds[t],i=u.propertySets[e];i&&h.push(i)}const c=null,p=null,_=s.external,f=new Wh(u,o,n,l,r,h,c,p,_);this.metaObjects[o]=f,(this.metaObjectsByType[r]||(this.metaObjectsByType[r]={}))[o]=f,void 0===this._typeCounts[r]?this._typeCounts[r]=1:this._typeCounts[r]++}for(let e=0,s=a.length;e<s;e++){const s=a[e],r=i.globalizeObjectIds?d.globalizeObjectId(t,s.id):s.id,o=this.metaObjects[r];if(o)if(void 0===s.parent||null===s.parent)u.rootMetaObject=o;else if(s.parent){const e=i.globalizeObjectIds?d.globalizeObjectId(t,s.parent):s.parent;let r=this.metaObjects[e];r&&(o.parent=r,r.children=r.children||[],r.children.push(o))}}return this.fire("metaModelCreated",t),u}destroyMetaModel(t){const e=this.metaModels[t];e&&(this._removeMetaModel(e),this.fire("metaModelDestroyed",t))}_removeMetaModel(t){const e=this.metaObjects,i=this.metaObjectsByType;let s=t=>{delete e[t.id];const r=i[t.type];r&&r[t.id]&&(delete r[t.id],0==--this._typeCounts[t.type]&&(delete this._typeCounts[t.type],delete i[t.type]));const o=t.children;if(o)for(let t=0,e=o.length;t<e;t++){const e=o[t];s(e)}};s(t.rootMetaObject);for(let e in t.propertySets)t.propertySets.hasOwnProperty(e)&&delete this.propertySets[e];delete this.metaModels[t.id]}getObjectIDsByType(t){const e=this.metaObjectsByType[t];return e?Object.keys(e):[]}getObjectIDsInSubtree(t,e,i){const s=[],r=this.metaObjects[t],o=e&&e.length>0?qh(e):null,a=i&&i.length>0?qh(i):null;return function t(e){if(!e)return;var i=!0;(a&&a[e.type]||o&&!o[e.type])&&(i=!1),i&&s.push(e.id);const r=e.children;if(r)for(var n=0,l=r.length;n<l;n++)t(r[n])}(r),s}withMetaObjectsInSubtree(t,e){const i=this.metaObjects[t];i&&i.withMetaObjectsInSubtree(e)}}function qh(t){const e={};for(var i=0,s=t.length;i<s;i++)e[t[i]]=!0;return e}class Zh{constructor(t){this.language="en",this.localeService=t.localeService||new ml,this.scene=new Ue(this,{canvasId:t.canvasId,canvasElement:t.canvasElement,keyboardEventsElement:t.keyboardEventsElement,webgl2:!1,contextAttr:{preserveDrawingBuffer:!1!==t.preserveDrawingBuffer,premultipliedAlpha:!!t.premultipliedAlpha,antialias:!1!==t.antialias},spinnerElementId:t.spinnerElementId,transparent:!1!==t.transparent,gammaInput:!0,gammaOutput:!1,backgroundColor:t.backgroundColor,backgroundColorFromAmbientLight:t.backgroundColorFromAmbientLight,ticksPerRender:1,ticksPerOcclusionTest:20,units:t.units,scale:t.scale,origin:t.origin,saoEnabled:t.saoEnabled,alphaDepthMask:!1!==t.alphaDepthMask,entityOffsetsEnabled:!!t.entityOffsetsEnabled,pickSurfacePrecisionEnabled:!!t.pickSurfacePrecisionEnabled,logarithmicDepthBufferEnabled:!!t.logarithmicDepthBufferEnabled,pbrEnabled:!!t.pbrEnabled}),this.metaScene=new Kh(this,this.scene),this.id=t.id||this.scene.id,this.camera=this.scene.camera,this.cameraFlight=new Dl(this.scene,{duration:.5}),this.cameraControl=new jh(this.scene,{doublePickFlyTo:!0}),this._plugins=[],this._eventSubs={}}on(t,e){let i=this._eventSubs[t];i||(i=[],this._eventSubs[t]=i),i.push(e)}fire(t,e){const i=this._eventSubs[t];if(i)for(let t=0,s=i.length;t<s;t++)i[t](e)}off(t){}log(t){console.log(`[xeokit viewer ${this.id}]: ${t}`)}error(t){console.error(`[xeokit viewer ${this.id}]: ${t}`)}addPlugin(t){this._plugins.push(t)}removePlugin(t){for(let e=0,i=this._plugins.length;e<i;e++){const i=this._plugins[e];if(i===t)return i.clear&&i.clear(),void this._plugins.splice(e,1)}}sendToPlugins(t,e){for(let i=0,s=this._plugins.length;i<s;i++){const s=this._plugins[i];s.send&&s.send(t,e)}}clear(){throw'Viewer#clear() no longer implemented - use \'#sendToPlugins("clear") instead'}resetView(){throw"Viewer#resetView() no longer implemented - use CameraMemento & ObjectsMemento classes instead"}beginSnapshot(){this._snapshotBegun||(this.scene._renderer.beginSnapshot(),this._snapshotBegun=!0)}getSnapshot(t={}){const e=!this._snapshotBegun;this._snapshotBegun||this.beginSnapshot(),t.includeGizmos||this.sendToPlugins("snapshotStarting");const i=void 0!==t.width&&void 0!==t.height,s=this.scene.canvas.canvas,r=s.clientWidth,o=s.clientHeight,a=s.style.width,n=s.style.height,l=t.width?Math.floor(t.width):s.width,h=t.height?Math.floor(t.height):s.height;i&&(s.style.width=l+"px",s.style.height=h+"px"),this.scene._renderer.renderSnapshot();const c=this.scene._renderer.readSnapshot(t);return i&&(s.style.width=a,s.style.height=n,s.width=r,s.height=o,this.scene.glRedraw()),t.includeGizmos||this.sendToPlugins("snapshotFinished"),e&&this.endSnapshot(),c}endSnapshot(){this._snapshotBegun&&(this.scene._renderer.endSnapshot(),this.scene._renderer.render({force:!0}),this._snapshotBegun=!1)}destroy(){const t=this._plugins.slice();for(let e=0,i=t.length;e<i;e++){t[e].destroy()}this.scene.destroy()}}class Qh{constructor(){}set doublePrecisionEnabled(t){d.setDoublePrecisionEnabled(t)}get doublePrecisionEnabled(){return d.getDoublePrecisionEnabled()}}export{he as AmbientLight,it as AngleMeasurementsPlugin,nt as AnnotationsPlugin,Oi as AxisGizmoPlugin,Ui as BCFViewpointsPlugin,$l as CameraMemento,xl as CameraPath,Ll as CameraPathAnimation,S as Component,Qh as Configs,o as ContextMenu,sh as CubicBezierCurve,Pl as Curve,le as DirLight,Zi as DistanceMeasurementsPlugin,Re as EdgeMaterial,Le as EmphasisMaterial,Zl as Fresnel,Qi as GLTFDefaultDataSource,Mn as GLTFLoaderPlugin,Ul as ImagePlane,ql as LambertMaterial,Kl as LightMap,ml as LocaleService,t as Map,K as Marker,Ri as Mesh,sn as MetallicMaterial,th as ModelMemento,wn as NavCubePlugin,Ka as Node,ih as ObjectsMemento,rh as Path,Oa as PerformanceModel,Se as PhongMaterial,a as Plugin,Gl as PointLight,oh as QuadraticBezierCurve,p as Queue,xe as ReadableGeometry,Yl as ReflectionMap,Vi as SectionPlane,Tn as SectionPlanesPlugin,ah as Skybox,an as SpecularMaterial,yl as SplineCurve,Ql as SpriteMarker,_n as Texture,Ja as VBOGeometry,Zh as Viewer,Fn as XKTDefaultDataSource,gl as XKTLoaderPlugin,we as buildBoxGeometry,Fl as buildBoxLinesGeometry,Fi as buildCylinderGeometry,Nl as buildGridGeometry,Il as buildPlaneGeometry,Ni as buildSphereGeometry,En as buildTorusGeometry,ki as buildVectorTextGeometry,Rl as load3DSGeometry,Tl as loadOBJGeometry,d as math,_ as stats,m as utils};
