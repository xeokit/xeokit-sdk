<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">viewer/plugins/BIMServerModelsPlugin/BIMServerModelsPlugin.js | xeokit-sdk</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="SDK for building high-performance visualizations on xeogl"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="xeokit-sdk"><meta property="twitter:description" content="SDK for building high-performance visualizations on xeogl"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/xeolabs/xeokit-sdk"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/viewer/ModelsPlugin.js~ModelsPlugin.html">ModelsPlugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/viewer/Plugin.js~Plugin.html">Plugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/viewer/Viewer.js~Viewer.html">Viewer</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-axisgizmoplugin">plugins/AxisGizmoPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/viewer/plugins/AxisGizmoPlugin/AxisGizmoPlugin.js~AxisGizmoPlugin.html">AxisGizmoPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-bcfviewpointsplugin">plugins/BCFViewpointsPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/viewer/plugins/BCFViewpointsPlugin/BCFViewpointsPlugin.js~BCFViewpointsPlugin.html">BCFViewpointsPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-bimservermodelsplugin">plugins/BIMServerModelsPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/viewer/plugins/BIMServerModelsPlugin/BIMServerModelsPlugin.js~BIMServerModelsPlugin.html">BIMServerModelsPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-gltfbigmodelsplugin">plugins/GLTFBigModelsPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/viewer/plugins/GLTFBigModelsPlugin/GLTFBigModelsPlugin.js~GLTFBigModelsPlugin.html">GLTFBigModelsPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-gltfmodelsplugin">plugins/GLTFModelsPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/viewer/plugins/GLTFModelsPlugin/GLTFModelsPlugin.js~GLTFModelsPlugin.html">GLTFModelsPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-objmodelsplugin">plugins/OBJModelsPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/viewer/plugins/OBJModelsPlugin/OBJModelsPlugin.js~OBJModelsPlugin.html">OBJModelsPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-stlmodelsplugin">plugins/STLModelsPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/viewer/plugins/STLModelsPlugin/STLModelsPlugin.js~STLModelsPlugin.html">STLModelsPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-xml3dmodelsplugin">plugins/XML3DModelsPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/viewer/plugins/XML3DModelsPlugin/XML3DModelsPlugin.js~XML3DModelsPlugin.html">XML3DModelsPlugin</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">viewer/plugins/BIMServerModelsPlugin/BIMServerModelsPlugin.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {Plugin} from &quot;./../../Plugin.js&quot;;
import {Geometry, Object as xeoglObjectClass, Model as xeoglModelClass, Mesh} from &quot;./../../../../libs/xeogl/xeogl.module.js&quot;;
import {preloadQuery} from &quot;./lib/preloadQuery.js&quot;;
import {BIMServerGeometryLoader} from &quot;./lib/BIMServerGeometryLoader.js&quot;;
import {defaultMaterials} from &quot;./lib/defaultMaterials.js&quot;;
import {BIMServerModel} from &quot;./lib/BIMServerModel.js&quot;;
import {utils} from &quot;./lib/utils.js&quot;;

/**
 A viewer plugin that loads models from a [BIMServer](http://bimserver.org) instance.

 @class BIMServerModelsPlugin
 @constructor
 @param viewer {Viewer} The xeoviewer viewer
 @param bimServerAPI {Object} The BIMServer client API
 */
class BIMServerModelsPlugin extends Plugin {

    constructor(viewer, bimServerAPI) {

        super(&quot;bimServerModels&quot;, viewer);

        /**
         * Version of BIMServer supported by this plugin.
         * @type {string}
         */
        this.BIMSERVER_VERSION = &quot;1.5&quot;;

        /**
         * The BIMServer API.
         */
        this.bimServerAPI = bimServerAPI;

        /**
         * IFC types that are hidden by default.
         * @type {{IfcOpeningElement: boolean, IfcSpace: boolean}}
         */
        this.hiddenTypes = {
            &quot;IfcOpeningElement&quot;: true,
            &quot;IfcSpace&quot;: true
        };

        this._idMapping = { // This are arrays as multiple models might be loaded or unloaded.
            &apos;toGuid&apos;: [],
            &apos;toId&apos;: []
        };

    }

    /**
     * Loads a model from BIMServer into the viewer via the plugin&apos;s BIMServer API client.
     * @param params
     * @returns {Promise}
     */
    load(params) {
        if (!params.id) {
            this.error(&quot;load() param expected: id&quot;);
            return;
        }
        if (this.viewer.scene.components[params.id]) {
            this.error(&quot;Component with this ID already exists in viewer: &quot; + id);
            return;
        }
        const bimServerAPI = this.bimServerAPI;
        const self = this;
        return new Promise((resolve, reject) =&gt; {
            bimServerAPI.getModel(params.poid, params.roid, params.schema, false,
                apiModel =&gt; {  // TODO: Preload not necessary combined with the bruteforce tree
                    let fired = false;
                    apiModel.query(preloadQuery, () =&gt; {
                        if (!fired) {
                            fired = true;
                            const bimServerModel = new BIMServerModel(bimServerAPI, apiModel);
                            self._loadModel(params, bimServerModel);
                            resolve(bimServerModel);
                        }
                    });
                });
        });
    };

    /**
     * @private
     */
    _loadModel(params, bimServerModel) {

        const bimServerAPI = this.bimServerAPI;
        const viewer = this.viewer;
        const self = this;
        let onTick;

        bimServerModel.getTree().then(function (tree) {

            const oids = [];
            const oidToGuid = {};
            const guidToOid = {};

            const visit = n =&gt; {
                if (self.BIMSERVER_VERSION == &quot;1.4&quot;) {
                    oids.push(n.id);
                } else {
                    oids[n.gid] = n.id;
                }
                oidToGuid[n.id] = n.guid;
                guidToOid[n.guid] = n.id;
                for (let i = 0; i &lt; (n.children || []).length; ++i) {
                    visit(n.children[i]);
                }
            };

            visit(tree);

            self._idMapping.toGuid.push(oidToGuid);
            self._idMapping.toId.push(guidToOid);

            const models = {};

            models[bimServerModel.apiModel.roid] = bimServerModel.apiModel; // TODO: Ugh. Undecorate some of the newly created classes

            const modelId = params.id;

            var xeoglModel = self._createModel(modelId);

            const roid = params.roid;

            const loader = new BIMServerGeometryLoader(bimServerAPI, self.viewer, bimServerModel, roid);

            loader.addProgressListener((progress, nrObjectsRead, totalNrObjects) =&gt; {
                if (progress == &quot;start&quot;) {
                    self.log(&quot;Started loading geometries&quot;);
                } else if (progress == &quot;done&quot;) {
                    self.log(`Finished loading geometries (${totalNrObjects} objects received)`);
                    viewer.scene.off(onTick);
                }
            });

            loader.setLoadOids(oids);
            //loader.setLoadOids([bimServerModel.apiModel.roid], oids);

            onTick = viewer.scene.on(&quot;tick&quot;, () =&gt; {
                loader.process();
            });

            loader.start();
        });
    };

    /**
     * @private
     */
    _createModel(modelId) {
        const viewer = this.viewer;
        const scene = viewer.scene;
        if (scene.models[modelId]) {
            this.log(`Can&apos;t create model within viewer - scene model with id ${modelId} already exists`);
            return;
        }
        if (scene.components[modelId]) {
            this.log(`Can&apos;t create model within viewer - scene component with this ID already exists: ${modelId}`);
            return;
        }
        const xeoglModel = new xeoglModelClass(scene, {
            id: modelId
        });
        return xeoglModel;
    }

    /**
     * @private
     */
    _createGeometry(modelId, geometryId, positions, normals, colors, indices) {
        const scene = this.scene;
        const model = scene.models[modelId];
        if (!model) {
            this.error(`Can&apos;t create geometry - model not found: ${modelId}`);
            return;
        }
        new Geometry(model, { // Geometry will be destroyed with the Model
            id: `${modelId}.${geometryId}`,
            primitive: &quot;triangles&quot;,
            positions,
            normals,
            colors,
            indices
        });
    }

    /**
     * Called by BimServerGeometryLoader
     * @private
     */
    _createObject(modelId, roid, oid, objectId, geometryIds, ifcType, matrix) {
        const viewer = this.viewer;
        const scene = viewer.scene;
        const model = scene.models[modelId];
        if (!model) {
            this.error(`Can&apos;t create object - model not found: ${modelId}`);
            return;
        }
        objectId = `${modelId}.${objectId}`;
        if (scene.entities[objectId]) {
            this.error(`Can&apos;t create object - object with id ${objectId} already exists`);
            return;
        }
        if (scene.components[objectId]) {
            this.error(`Can&apos;t create object - scene component with this ID already exists: ${objectId}`);
            return;
        }
        ifcType = ifcType || &quot;DEFAULT&quot;;
        const guid = (objectId.includes(&quot;#&quot;)) ? utils.CompressGuid(objectId.split(&quot;#&quot;)[1].substr(8, 36).replace(/-/g, &quot;&quot;)) : null; // TODO: Computing GUID looks like a performance bottleneck
        const color = defaultMaterials[ifcType] || defaultMaterials[&quot;DEFAULT&quot;];
        const object = new xeoglObjectClass(model, { // Object will be destroyed with the Model
            id: objectId,
            guid,
            entityType: ifcType, // xeogl semantic models are generic, not limited to IFC
            matrix,
            colorize: color, // RGB
            opacity: color[3], // A
            visibility: !this.hiddenTypes[ifcType]
        });
        // TODO: Call model._addComponent to register child Object?
        model.addChild(object, false); // Object is child of Model, does not inherit visible states from Model
        for (let i = 0, len = geometryIds.length; i &lt; len; i++) { // Create child Meshes of Object
            const mesh = new Mesh(model, { // Each Mesh will be destroyed with the Model
                geometry: `${modelId}.${geometryIds[i]}`
            });
            mesh.colorize = color; // HACK: Overrides state inheritance
            object.addChild(mesh, true); // Mesh is child of Object, inherits visibility states from Object
        }
        return object;
    }

    /**
     * @private
     */
    send(name, value) {
        //...
    }

    /**
     * @private
     */
    writeBookmark(bookmark) {
        //...
    }

    /**
     * @private
     */
    readBookmark(bookmark, done) {
        //...
        done();
    }

    /**
     * Destroys this plugin.
     */
    destroy() {
        super.destroy();
    }
}

export {BIMServerModelsPlugin}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
