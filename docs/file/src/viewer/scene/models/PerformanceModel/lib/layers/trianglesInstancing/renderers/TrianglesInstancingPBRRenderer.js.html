<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../../../../../../../">
  <title data-ice="title">src/viewer/scene/models/PerformanceModel/lib/layers/trianglesInstancing/renderers/TrianglesInstancingPBRRenderer.js | xeokit-sdk</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="3D engineering graphics in the browser"><meta property="og:type" content="website"><meta property="og:url" content="http://xeokit.io"><meta property="og:site_name" content="xeokit-sdk"><meta property="og:title" content="xeokit-sdk"><meta property="og:image" content="./images/logo.jpg"><meta property="og:description" content="3D engineering graphics in the browser"><meta property="og:author" content="http://xeolabs.com"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="xeokit-sdk"><meta property="twitter:description" content="3D engineering graphics in the browser"><meta property="twitter:image" content="./images/logo.jpg"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.jpg" style="width:34px;"></a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/xeokit/xeokit-sdk"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#extras-contextmenu">extras/ContextMenu</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/extras/ContextMenu/ContextMenu.js~ContextMenu.html">ContextMenu</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-anglemeasurementsplugin">plugins/AngleMeasurementsPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/AngleMeasurementsPlugin/AngleMeasurement.js~AngleMeasurement.html">AngleMeasurement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/AngleMeasurementsPlugin/AngleMeasurementsControl.js~AngleMeasurementsControl.html">AngleMeasurementsControl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/AngleMeasurementsPlugin/AngleMeasurementsPlugin.js~AngleMeasurementsPlugin.html">AngleMeasurementsPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-annotationsplugin">plugins/AnnotationsPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/AnnotationsPlugin/Annotation.js~Annotation.html">Annotation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/AnnotationsPlugin/AnnotationsPlugin.js~AnnotationsPlugin.html">AnnotationsPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-axisgizmoplugin">plugins/AxisGizmoPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/AxisGizmoPlugin/AxisGizmoPlugin.js~AxisGizmoPlugin.html">AxisGizmoPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-bcfviewpointsplugin">plugins/BCFViewpointsPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/BCFViewpointsPlugin/BCFViewpointsPlugin.js~BCFViewpointsPlugin.html">BCFViewpointsPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-cityjsonloaderplugin">plugins/CityJSONLoaderPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/CityJSONLoaderPlugin/CityJSONDefaultDataSource.js~CityJSONDefaultDataSource.html">CityJSONDefaultDataSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/CityJSONLoaderPlugin/CityJSONLoaderPlugin.js~CityJSONLoaderPlugin.html">CityJSONLoaderPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-distancemeasurementsplugin">plugins/DistanceMeasurementsPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/DistanceMeasurementsPlugin/DistanceMeasurement.js~DistanceMeasurement.html">DistanceMeasurement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/DistanceMeasurementsPlugin/DistanceMeasurementsControl.js~DistanceMeasurementsControl.html">DistanceMeasurementsControl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/DistanceMeasurementsPlugin/DistanceMeasurementsPlugin.js~DistanceMeasurementsPlugin.html">DistanceMeasurementsPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-fastnavplugin">plugins/FastNavPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/FastNavPlugin/FastNavPlugin.js~FastNavPlugin.html">FastNavPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-gltfloaderplugin">plugins/GLTFLoaderPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/GLTFLoaderPlugin/GLTFDefaultDataSource.js~GLTFDefaultDataSource.html">GLTFDefaultDataSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/GLTFLoaderPlugin/GLTFLoaderPlugin.js~GLTFLoaderPlugin.html">GLTFLoaderPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-lasloaderplugin">plugins/LASLoaderPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/LASLoaderPlugin/LASDefaultDataSource.js~LASDefaultDataSource.html">LASDefaultDataSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/LASLoaderPlugin/LASLoaderPlugin.js~LASLoaderPlugin.html">LASLoaderPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-navcubeplugin">plugins/NavCubePlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/NavCubePlugin/NavCubePlugin.js~NavCubePlugin.html">NavCubePlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-objloaderplugin">plugins/OBJLoaderPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/OBJLoaderPlugin/OBJLoaderPlugin.js~OBJLoaderPlugin.html">OBJLoaderPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-stlloaderplugin">plugins/STLLoaderPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/STLLoaderPlugin/STLDefaultDataSource.js~STLDefaultDataSource.html">STLDefaultDataSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/STLLoaderPlugin/STLLoaderPlugin.js~STLLoaderPlugin.html">STLLoaderPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-sectionplanesplugin">plugins/SectionPlanesPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/SectionPlanesPlugin/SectionPlanesPlugin.js~SectionPlanesPlugin.html">SectionPlanesPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-skyboxesplugin">plugins/SkyboxesPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/SkyboxesPlugin/SkyboxesPlugin.js~SkyboxesPlugin.html">SkyboxesPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-storeyviewsplugin">plugins/StoreyViewsPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/StoreyViewsPlugin/Storey.js~Storey.html">Storey</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/StoreyViewsPlugin/StoreyMap.js~StoreyMap.html">StoreyMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/StoreyViewsPlugin/StoreyViewsPlugin.js~StoreyViewsPlugin.html">StoreyViewsPlugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-IFCStoreyPlanObjectStates">IFCStoreyPlanObjectStates</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-treeviewplugin">plugins/TreeViewPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/TreeViewPlugin/ModelTreeView.js~ModelTreeView.html">ModelTreeView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/TreeViewPlugin/TreeViewPlugin.js~TreeViewPlugin.html">TreeViewPlugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/src/plugins/TreeViewPlugin/TreeViewNode.js~TreeViewNode.html">TreeViewNode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validateMetaModelForTreeViewContainmentHierarchy">validateMetaModelForTreeViewContainmentHierarchy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validateMetaModelForTreeViewStoreysHierarchy">validateMetaModelForTreeViewStoreysHierarchy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-validateMetaModelForTreeViewTypesHierarchy">validateMetaModelForTreeViewTypesHierarchy</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-viewcullplugin">plugins/ViewCullPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/ViewCullPlugin/ViewCullPlugin.js~ViewCullPlugin.html">ViewCullPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-webifcloaderplugin">plugins/WebIFCLoaderPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/WebIFCLoaderPlugin/WebIFCDefaultDataSource.js~WebIFCDefaultDataSource.html">WebIFCDefaultDataSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/WebIFCLoaderPlugin/WebIFCLoaderPlugin.js~WebIFCLoaderPlugin.html">WebIFCLoaderPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-xktloaderplugin">plugins/XKTLoaderPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/XKTLoaderPlugin/XKTDefaultDataSource.js~XKTDefaultDataSource.html">XKTDefaultDataSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/XKTLoaderPlugin/XKTLoaderPlugin.js~XKTLoaderPlugin.html">XKTLoaderPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#plugins-xml3dloaderplugin">plugins/XML3DLoaderPlugin</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/plugins/XML3DLoaderPlugin/XML3DLoaderPlugin.js~XML3DLoaderPlugin.html">XML3DLoaderPlugin</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer">viewer</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/Configs.js~Configs.html">Configs</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/Plugin.js~Plugin.html">Plugin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/Viewer.js~Viewer.html">Viewer</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-localization">viewer/localization</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/localization/LocaleService.js~LocaleService.html">LocaleService</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-metadata">viewer/metadata</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/metadata/MetaModel.js~MetaModel.html">MetaModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/metadata/MetaObject.js~MetaObject.html">MetaObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/metadata/MetaScene.js~MetaScene.html">MetaScene</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/metadata/Property.js~Property.html">Property</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/metadata/PropertySet.js~PropertySet.html">PropertySet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-IFCObjectDefaultColors">IFCObjectDefaultColors</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-IFCObjectDefaults">IFCObjectDefaults</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene">viewer/scene</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/Component.js~Component.html">Component</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/src/viewer/scene/Entity.js~Entity.html">Entity</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-stats">stats</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-cameracontrol">viewer/scene/CameraControl</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/CameraControl/CameraControl.js~CameraControl.html">CameraControl</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-imageplane">viewer/scene/ImagePlane</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/ImagePlane/ImagePlane.js~ImagePlane.html">ImagePlane</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-camera">viewer/scene/camera</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/camera/Camera.js~Camera.html">Camera</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/camera/CameraFlightAnimation.js~CameraFlightAnimation.html">CameraFlightAnimation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/camera/CameraPath.js~CameraPath.html">CameraPath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/camera/CameraPathAnimation.js~CameraPathAnimation.html">CameraPathAnimation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/camera/CustomProjection.js~CustomProjection.html">CustomProjection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/camera/Frustum.js~Frustum.html">Frustum</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/camera/Ortho.js~Ortho.html">Ortho</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/camera/Perspective.js~Perspective.html">Perspective</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-canvas">viewer/scene/canvas</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/canvas/Canvas.js~Canvas.html">Canvas</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/canvas/Spinner.js~Spinner.html">Spinner</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-geometry">viewer/scene/geometry</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/geometry/Geometry.js~Geometry.html">Geometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/geometry/ReadableGeometry.js~ReadableGeometry.html">ReadableGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/geometry/VBOGeometry.js~VBOGeometry.html">VBOGeometry</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-geometry-builders">viewer/scene/geometry/builders</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildBoxGeometry">buildBoxGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildBoxLinesGeometry">buildBoxLinesGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildCylinderGeometry">buildCylinderGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildGridGeometry">buildGridGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildPlaneGeometry">buildPlaneGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildSphereGeometry">buildSphereGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildTorusGeometry">buildTorusGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildVectorTextGeometry">buildVectorTextGeometry</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-geometry-loaders">viewer/scene/geometry/loaders</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-load3DSGeometry">load3DSGeometry</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-loadOBJGeometry">loadOBJGeometry</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-input">viewer/scene/input</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/input/Input.js~Input.html">Input</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-lights">viewer/scene/lights</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/lights/AmbientLight.js~AmbientLight.html">AmbientLight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/lights/CubeTexture.js~CubeTexture.html">CubeTexture</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/lights/DirLight.js~DirLight.html">DirLight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/lights/Light.js~Light.html">Light</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/lights/LightMap.js~LightMap.html">LightMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/lights/PointLight.js~PointLight.html">PointLight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/lights/ReflectionMap.js~ReflectionMap.html">ReflectionMap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/lights/Shadow.js~Shadow.html">Shadow</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-marker">viewer/scene/marker</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/marker/Marker.js~Marker.html">Marker</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/marker/SpriteMarker.js~SpriteMarker.html">SpriteMarker</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-materials">viewer/scene/materials</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/materials/EdgeMaterial.js~EdgeMaterial.html">EdgeMaterial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/materials/EmphasisMaterial.js~EmphasisMaterial.html">EmphasisMaterial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/materials/Fresnel.js~Fresnel.html">Fresnel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/materials/LambertMaterial.js~LambertMaterial.html">LambertMaterial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/materials/LinesMaterial.js~LinesMaterial.html">LinesMaterial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/materials/Material.js~Material.html">Material</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/materials/MetallicMaterial.js~MetallicMaterial.html">MetallicMaterial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/materials/PhongMaterial.js~PhongMaterial.html">PhongMaterial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/materials/PointsMaterial.js~PointsMaterial.html">PointsMaterial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/materials/SpecularMaterial.js~SpecularMaterial.html">SpecularMaterial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/materials/Texture.js~Texture.html">Texture</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-mementos">viewer/scene/mementos</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/mementos/CameraMemento.js~CameraMemento.html">CameraMemento</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/mementos/ModelMemento.js~ModelMemento.html">ModelMemento</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/mementos/ObjectsMemento.js~ObjectsMemento.html">ObjectsMemento</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-mesh">viewer/scene/mesh</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/mesh/Mesh.js~Mesh.html">Mesh</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-mesh-pick">viewer/scene/mesh/pick</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/mesh/pick/PickTriangleShaderSource.js~PickTriangleShaderSource.html">PickTriangleShaderSource</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-metriqs">viewer/scene/metriqs</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/metriqs/Metriqs.js~Metrics.html">Metrics</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-models-performancemodel">viewer/scene/models/PerformanceModel</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/models/PerformanceModel/PerformanceModel.js~PerformanceModel.html">PerformanceModel</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-nodes">viewer/scene/nodes</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/nodes/Node.js~Node.html">Node</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-paths">viewer/scene/paths</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/paths/CubicBezierCurve.js~CubicBezierCurve.html">CubicBezierCurve</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/paths/Curve.js~Curve.html">Curve</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/paths/Path.js~Path.html">Path</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/paths/QuadraticBezierCurve.js~QuadraticBezierCurve.html">QuadraticBezierCurve</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/paths/SplineCurve.js~SplineCurve.html">SplineCurve</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-postfx">viewer/scene/postfx</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/postfx/SAO.js~SAO.html">SAO</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-scene">viewer/scene/scene</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/scene/Scene.js~Scene.html">Scene</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-sectionplane">viewer/scene/sectionPlane</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/sectionPlane/SectionPlane.js~SectionPlane.html">SectionPlane</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-skybox">viewer/scene/skybox</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/skybox/Skybox.js~Skybox.html">Skybox</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-viewport">viewer/scene/viewport</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/viewport/Viewport.js~Viewport.html">Viewport</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-webgl">viewer/scene/webgl</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/webgl/PickResult.js~PickResult.html">PickResult</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#viewer-scene-webgl-occlusion">viewer/scene/webgl/occlusion</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/webgl/occlusion/OcclusionLayer.js~OcclusionLayer.html">OcclusionLayer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/viewer/scene/webgl/occlusion/OcclusionTester.js~OcclusionTester.html">OcclusionTester</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/viewer/scene/models/PerformanceModel/lib/layers/trianglesInstancing/renderers/TrianglesInstancingPBRRenderer.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import {Program} from &quot;../../../../../../webgl/Program.js&quot;;
import {math} from &quot;../../../../../../math/math.js&quot;;
import {createRTCViewMat, getPlaneRTCPos} from &quot;../../../../../../math/rtcCoords.js&quot;;
import {WEBGL_INFO} from &quot;../../../../../../webglInfo.js&quot;;

const tempVec4 = math.vec4();
const tempVec3a = math.vec3();

const TEXTURE_DECODE_FUNCS = {
    &quot;linear&quot;: &quot;linearToLinear&quot;,
    &quot;sRGB&quot;: &quot;sRGBToLinear&quot;,
    &quot;gamma&quot;: &quot;gammaToLinear&quot;
};

/**
 * @private
 */
class TrianglesInstancingPBRRenderer {

    constructor(scene, withSAO) {
        this._scene = scene;
        this._withSAO = withSAO;
        this._hash = this._getHash();
        this._allocate();
    }

    getValid() {
        return this._hash === this._getHash();
    };

    _getHash() {
        const scene = this._scene;
        return [scene.gammaOutput, scene._lightsState.getHash(), scene._sectionPlanesState.getHash(), (this._withSAO ? &quot;sao&quot; : &quot;nosao&quot;)].join(&quot;;&quot;);
    }

    drawLayer(frameCtx, instancingLayer, renderPass) {

        const maxTextureUnits = WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS;

        const model = instancingLayer.model;
        const scene = this._scene;
        const camera = scene.camera;
        const gl = scene.canvas.gl;
        const state = instancingLayer._state;
        const origin = state.origin;
        const textureSet = state.textureSet;
        const geometry = state.geometry;
        const lightsState = scene._lightsState;

        if (!this._program) {
            this._allocate();
            if (this.errors) {
                return;
            }
        }

        if (frameCtx.lastProgramId !== this._program.id) {
            frameCtx.lastProgramId = this._program.id;
            this._bindProgram(frameCtx);
        }

        gl.uniform1i(this._uRenderPass, renderPass);

        gl.uniformMatrix4fv(this._uViewMatrix, false, (origin) ? createRTCViewMat(camera.viewMatrix, origin) : camera.viewMatrix);
        gl.uniformMatrix4fv(this._uViewNormalMatrix, false, camera.viewNormalMatrix);

        gl.uniformMatrix4fv(this._uWorldMatrix, false, model.worldMatrix);
        gl.uniformMatrix4fv(this._uWorldNormalMatrix, false, model.worldNormalMatrix);

        const numSectionPlanes = scene._sectionPlanesState.sectionPlanes.length;
        if (numSectionPlanes &gt; 0) {
            const sectionPlanes = scene._sectionPlanesState.sectionPlanes;
            const baseIndex = instancingLayer.layerIndex * numSectionPlanes;
            const renderFlags = model.renderFlags;
            for (let sectionPlaneIndex = 0; sectionPlaneIndex &lt; numSectionPlanes; sectionPlaneIndex++) {
                const sectionPlaneUniforms = this._uSectionPlanes[sectionPlaneIndex];
                if (sectionPlaneUniforms) {
                    const active = renderFlags.sectionPlanesActivePerLayer[baseIndex + sectionPlaneIndex];
                    gl.uniform1i(sectionPlaneUniforms.active, active ? 1 : 0);
                    if (active) {
                        const sectionPlane = sectionPlanes[sectionPlaneIndex];
                        if (origin) {
                            const rtcSectionPlanePos = getPlaneRTCPos(sectionPlane.dist, sectionPlane.dir, origin, tempVec3a);
                            gl.uniform3fv(sectionPlaneUniforms.pos, rtcSectionPlanePos);
                        } else {
                            gl.uniform3fv(sectionPlaneUniforms.pos, sectionPlane.pos);
                        }
                        gl.uniform3fv(sectionPlaneUniforms.dir, sectionPlane.dir);
                    }
                }
            }
        }

        gl.uniformMatrix4fv(this._uPositionsDecodeMatrix, false, geometry.positionsDecodeMatrix);

        if (this._uUVDecodeMatrix) {
            gl.uniformMatrix3fv(this._uUVDecodeMatrix, false, geometry.uvDecodeMatrix);
        }

        this._aModelMatrixCol0.bindArrayBuffer(state.modelMatrixCol0Buf);
        this._aModelMatrixCol1.bindArrayBuffer(state.modelMatrixCol1Buf);
        this._aModelMatrixCol2.bindArrayBuffer(state.modelMatrixCol2Buf);

        gl.vertexAttribDivisor(this._aModelMatrixCol0.location, 1);
        gl.vertexAttribDivisor(this._aModelMatrixCol1.location, 1);
        gl.vertexAttribDivisor(this._aModelMatrixCol2.location, 1);

        this._aModelNormalMatrixCol0.bindArrayBuffer(state.modelNormalMatrixCol0Buf);
        this._aModelNormalMatrixCol1.bindArrayBuffer(state.modelNormalMatrixCol1Buf);
        this._aModelNormalMatrixCol2.bindArrayBuffer(state.modelNormalMatrixCol2Buf);

        gl.vertexAttribDivisor(this._aModelNormalMatrixCol0.location, 1);
        gl.vertexAttribDivisor(this._aModelNormalMatrixCol1.location, 1);
        gl.vertexAttribDivisor(this._aModelNormalMatrixCol2.location, 1);

        this._aPosition.bindArrayBuffer(geometry.positionsBuf);
        this._aNormal.bindArrayBuffer(geometry.normalsBuf);

        if (this._aUV) {
            this._aUV.bindArrayBuffer(geometry.uvBuf);
        }
        this._aColor.bindArrayBuffer(state.colorsBuf);
        gl.vertexAttribDivisor(this._aColor.location, 1);

        this._aMetallicRoughness.bindArrayBuffer(state.metallicRoughnessBuf);
        gl.vertexAttribDivisor(this._aMetallicRoughness.location, 1);

        this._aFlags.bindArrayBuffer(state.flagsBuf);
        gl.vertexAttribDivisor(this._aFlags.location, 1);

        if (this._aFlags2) {
            this._aFlags2.bindArrayBuffer(state.flags2Buf);
            gl.vertexAttribDivisor(this._aFlags2.location, 1);
        }

        if (this._aOffset) {
            this._aOffset.bindArrayBuffer(state.offsetsBuf);
            gl.vertexAttribDivisor(this._aOffset.location, 1);
        }

        if (lightsState.reflectionMaps.length &gt; 0 &amp;&amp; lightsState.reflectionMaps[0].texture &amp;&amp; this._uReflectionMap) {
            this._program.bindTexture(this._uReflectionMap, lightsState.reflectionMaps[0].texture, frameCtx.textureUnit);
            frameCtx.textureUnit = (frameCtx.textureUnit + 1) % maxTextureUnits;
            frameCtx.bindTexture++;
        }

        if (lightsState.lightMaps.length &gt; 0 &amp;&amp; lightsState.lightMaps[0].texture &amp;&amp; this._uLightMap) {
            this._program.bindTexture(this._uLightMap, lightsState.lightMaps[0].texture, frameCtx.textureUnit);
            frameCtx.textureUnit = (frameCtx.textureUnit + 1) % maxTextureUnits;
            frameCtx.bindTexture++;
        }

        if (this._withSAO) {
            const sao = scene.sao;
            const saoEnabled = sao.possible;
            if (saoEnabled) {
                const viewportWidth = gl.drawingBufferWidth;
                const viewportHeight = gl.drawingBufferHeight;
                tempVec4[0] = viewportWidth;
                tempVec4[1] = viewportHeight;
                tempVec4[2] = sao.blendCutoff;
                tempVec4[3] = sao.blendFactor;
                gl.uniform4fv(this._uSAOParams, tempVec4);
                this._program.bindTexture(this._uOcclusionTexture, frameCtx.occlusionTexture, frameCtx.textureUnit);
                frameCtx.textureUnit = (frameCtx.textureUnit + 1) % maxTextureUnits;
                frameCtx.bindTexture++;
            }
        }

        if (textureSet) {
            this._program.bindTexture(this._uBaseColorMap, textureSet.colorTexture.texture, frameCtx.textureUnit);
            frameCtx.textureUnit = (frameCtx.textureUnit + 1) % maxTextureUnits;
            this._program.bindTexture(this._uMetallicRoughMap, textureSet.metallicRoughnessTexture.texture, frameCtx.textureUnit);
            frameCtx.textureUnit = (frameCtx.textureUnit + 1) % maxTextureUnits;
            this._program.bindTexture(this._uEmissiveMap, textureSet.emissiveTexture.texture, frameCtx.textureUnit);
            frameCtx.textureUnit = (frameCtx.textureUnit + 1) % maxTextureUnits;
            this._program.bindTexture(this._uNormalMap, textureSet.normalsTexture.texture, frameCtx.textureUnit);
            frameCtx.textureUnit = (frameCtx.textureUnit + 1) % maxTextureUnits;
        }

        geometry.indicesBuf.bind();

        gl.drawElementsInstanced(gl.TRIANGLES, geometry.indicesBuf.numItems, geometry.indicesBuf.itemType, 0, state.numInstances);

        frameCtx.drawElements++;

        gl.vertexAttribDivisor(this._aModelMatrixCol0.location, 0);
        gl.vertexAttribDivisor(this._aModelMatrixCol1.location, 0);
        gl.vertexAttribDivisor(this._aModelMatrixCol2.location, 0);
        gl.vertexAttribDivisor(this._aModelNormalMatrixCol0.location, 0);
        gl.vertexAttribDivisor(this._aModelNormalMatrixCol1.location, 0);
        gl.vertexAttribDivisor(this._aModelNormalMatrixCol2.location, 0);
        gl.vertexAttribDivisor(this._aColor.location, 0);
        gl.vertexAttribDivisor(this._aMetallicRoughness.location, 0);
        gl.vertexAttribDivisor(this._aFlags.location, 0);

        if (this._aFlags2) { // Won&apos;t be in shader when not clipping
            gl.vertexAttribDivisor(this._aFlags2.location, 0);
        }

        if (this._aOffset) {
            gl.vertexAttribDivisor(this._aOffset.location, 0);
        }
    }

    _allocate() {

        const scene = this._scene;
        const gl = scene.canvas.gl;
        const lightsState = scene._lightsState;

        this._program = new Program(gl, this._buildShader());

        if (this._program.errors) {
            this.errors = this._program.errors;
            return;
        }

        const program = this._program;

        this._uRenderPass = program.getLocation(&quot;renderPass&quot;);

        this._uPositionsDecodeMatrix = program.getLocation(&quot;positionsDecodeMatrix&quot;);
        this._uUVDecodeMatrix = program.getLocation(&quot;uvDecodeMatrix&quot;);
        this._uWorldMatrix = program.getLocation(&quot;worldMatrix&quot;);
        this._uWorldNormalMatrix = program.getLocation(&quot;worldNormalMatrix&quot;);

        this._uViewMatrix = program.getLocation(&quot;viewMatrix&quot;);
        this._uViewNormalMatrix = program.getLocation(&quot;viewNormalMatrix&quot;);
        this._uProjMatrix = program.getLocation(&quot;projMatrix&quot;);

        this._uGammaFactor = program.getLocation(&quot;gammaFactor&quot;);

        this._uLightAmbient = program.getLocation(&quot;lightAmbient&quot;);
        this._uLightColor = [];
        this._uLightDir = [];
        this._uLightPos = [];
        this._uLightAttenuation = [];

        const lights = lightsState.lights;
        let light;

        for (var i = 0, len = lights.length; i &lt; len; i++) {
            light = lights[i];
            switch (light.type) {
                case &quot;dir&quot;:
                    this._uLightColor[i] = program.getLocation(&quot;lightColor&quot; + i);
                    this._uLightPos[i] = null;
                    this._uLightDir[i] = program.getLocation(&quot;lightDir&quot; + i);
                    break;
                case &quot;point&quot;:
                    this._uLightColor[i] = program.getLocation(&quot;lightColor&quot; + i);
                    this._uLightPos[i] = program.getLocation(&quot;lightPos&quot; + i);
                    this._uLightDir[i] = null;
                    this._uLightAttenuation[i] = program.getLocation(&quot;lightAttenuation&quot; + i);
                    break;
                case &quot;spot&quot;:
                    this._uLightColor[i] = program.getLocation(&quot;lightColor&quot; + i);
                    this._uLightPos[i] = program.getLocation(&quot;lightPos&quot; + i);
                    this._uLightDir[i] = program.getLocation(&quot;lightDir&quot; + i);
                    this._uLightAttenuation[i] = program.getLocation(&quot;lightAttenuation&quot; + i);
                    break;
            }
        }

        if (lightsState.reflectionMaps.length &gt; 0) {
            this._uReflectionMap = &quot;reflectionMap&quot;;
        }

        if (lightsState.lightMaps.length &gt; 0) {
            this._uLightMap = &quot;lightMap&quot;;
        }

        this._uSectionPlanes = [];

        for (let i = 0, len = scene._sectionPlanesState.sectionPlanes.length; i &lt; len; i++) {
            this._uSectionPlanes.push({
                active: program.getLocation(&quot;sectionPlaneActive&quot; + i),
                pos: program.getLocation(&quot;sectionPlanePos&quot; + i),
                dir: program.getLocation(&quot;sectionPlaneDir&quot; + i)
            });
        }

        this._aPosition = program.getAttribute(&quot;position&quot;);
        this._aNormal = program.getAttribute(&quot;normal&quot;);
        this._aUV = program.getAttribute(&quot;uv&quot;);
        this._aColor = program.getAttribute(&quot;color&quot;);
        this._aMetallicRoughness = program.getAttribute(&quot;metallicRoughness&quot;);
        this._aFlags = program.getAttribute(&quot;flags&quot;);
        this._aFlags2 = program.getAttribute(&quot;flags2&quot;);
        this._aOffset = program.getAttribute(&quot;offset&quot;);

        this._uBaseColorMap = &quot;uBaseColorMap&quot;;
        this._uMetallicRoughMap = &quot;uMetallicRoughMap&quot;;
        this._uEmissiveMap = &quot;uEmissiveMap&quot;;
        this._uNormalMap = &quot;uNormalMap&quot;;

        this._aModelMatrixCol0 = program.getAttribute(&quot;modelMatrixCol0&quot;);
        this._aModelMatrixCol1 = program.getAttribute(&quot;modelMatrixCol1&quot;);
        this._aModelMatrixCol2 = program.getAttribute(&quot;modelMatrixCol2&quot;);

        this._aModelNormalMatrixCol0 = program.getAttribute(&quot;modelNormalMatrixCol0&quot;);
        this._aModelNormalMatrixCol1 = program.getAttribute(&quot;modelNormalMatrixCol1&quot;);
        this._aModelNormalMatrixCol2 = program.getAttribute(&quot;modelNormalMatrixCol2&quot;);

        this._uOcclusionTexture = &quot;uOcclusionTexture&quot;;
        this._uSAOParams = program.getLocation(&quot;uSAOParams&quot;);

        if (scene.logarithmicDepthBufferEnabled) {
            this._uLogDepthBufFC = program.getLocation(&quot;logDepthBufFC&quot;);
        }
    }

    _bindProgram(frameCtx) {

        const maxTextureUnits = WEBGL_INFO.MAX_TEXTURE_IMAGE_UNITS;
        const scene = this._scene;
        const gl = scene.canvas.gl;
        const lightsState = scene._lightsState;
        const lights = lightsState.lights;
        const project = scene.camera.project;

        this._program.bind();

        gl.uniformMatrix4fv(this._uProjMatrix, false, project.matrix);

        if (this._uLightAmbient) {
            gl.uniform4fv(this._uLightAmbient, scene._lightsState.getAmbientColorAndIntensity());
        }

        for (let i = 0, len = lights.length; i &lt; len; i++) {
            const light = lights[i];
            if (this._uLightColor[i]) {
                gl.uniform4f(this._uLightColor[i], light.color[0], light.color[1], light.color[2], light.intensity);
            }
            if (this._uLightPos[i]) {
                gl.uniform3fv(this._uLightPos[i], light.pos);
                if (this._uLightAttenuation[i]) {
                    gl.uniform1f(this._uLightAttenuation[i], light.attenuation);
                }
            }
            if (this._uLightDir[i]) {
                gl.uniform3fv(this._uLightDir[i], light.dir);
            }
        }

        if (scene.logarithmicDepthBufferEnabled) {
            const logDepthBufFC = 2.0 / (Math.log(project.far + 1.0) / Math.LN2);
            gl.uniform1f(this._uLogDepthBufFC, logDepthBufFC);
        }

        if (this._uGammaFactor) {
            gl.uniform1f(this._uGammaFactor, scene.gammaFactor);
        }
    }

    _buildShader() {
        return {
            vertex: this._buildVertexShader(),
            fragment: this._buildFragmentShader()
        };
    }

    _buildVertexShader() {

        const scene = this._scene;
        const sectionPlanesState = scene._sectionPlanesState;
        const lightsState = scene._lightsState;
        const clipping = sectionPlanesState.sectionPlanes.length &gt; 0;
        const clippingCaps = sectionPlanesState.clippingCaps;
        const src = [];
        src.push(&quot;#version 300 es&quot;);
        src.push(&quot;// Instancing geometry quality drawing vertex shader&quot;);


        src.push(&quot;uniform int renderPass;&quot;);

        src.push(&quot;in vec3 position;&quot;);
        src.push(&quot;in vec3 normal;&quot;);
        src.push(&quot;in vec4 color;&quot;);
        src.push(&quot;in vec2 uv;&quot;);
        src.push(&quot;in vec2 metallicRoughness;&quot;);
        src.push(&quot;in vec4 flags;&quot;);
        src.push(&quot;in vec4 flags2;&quot;);

        if (scene.entityOffsetsEnabled) {
            src.push(&quot;in vec3 offset;&quot;);
        }

        src.push(&quot;in vec4 modelMatrixCol0;&quot;); // Modeling matrix
        src.push(&quot;in vec4 modelMatrixCol1;&quot;);
        src.push(&quot;in vec4 modelMatrixCol2;&quot;);

        src.push(&quot;in vec4 modelNormalMatrixCol0;&quot;);
        src.push(&quot;in vec4 modelNormalMatrixCol1;&quot;);
        src.push(&quot;in vec4 modelNormalMatrixCol2;&quot;);

        src.push(&quot;uniform mat4 worldMatrix;&quot;);
        src.push(&quot;uniform mat4 worldNormalMatrix;&quot;);
        src.push(&quot;uniform mat4 viewMatrix;&quot;);
        src.push(&quot;uniform mat4 viewNormalMatrix;&quot;);
        src.push(&quot;uniform mat4 projMatrix;&quot;);
        src.push(&quot;uniform mat4 positionsDecodeMatrix;&quot;);
        src.push(&quot;uniform mat3 uvDecodeMatrix;&quot;)

        if (scene.logarithmicDepthBufferEnabled) {
            src.push(&quot;uniform float logDepthBufFC;&quot;);
            src.push(&quot;out float vFragDepth;&quot;);
            src.push(&quot;bool isPerspectiveMatrix(mat4 m) {&quot;);
            src.push(&quot;    return (m[2][3] == - 1.0);&quot;);
            src.push(&quot;}&quot;);
            src.push(&quot;out float isPerspective;&quot;);
        }

        src.push(&quot;vec3 octDecode(vec2 oct) {&quot;);
        src.push(&quot;    vec3 v = vec3(oct.xy, 1.0 - abs(oct.x) - abs(oct.y));&quot;);
        src.push(&quot;    if (v.z &lt; 0.0) {&quot;);
        src.push(&quot;        v.xy = (1.0 - abs(v.yx)) * vec2(v.x &gt;= 0.0 ? 1.0 : -1.0, v.y &gt;= 0.0 ? 1.0 : -1.0);&quot;);
        src.push(&quot;    }&quot;);
        src.push(&quot;    return normalize(v);&quot;);
        src.push(&quot;}&quot;);

        src.push(&quot;out vec4 vViewPosition;&quot;);
        src.push(&quot;out vec3 vViewNormal;&quot;);
        src.push(&quot;out vec4 vColor;&quot;);
        src.push(&quot;out vec2 vUV;&quot;);
        src.push(&quot;out vec2 vMetallicRoughness;&quot;);

        if (lightsState.lightMaps.length &gt; 0) {
            src.push(&quot;out vec3 vWorldNormal;&quot;);
        }

        if (clipping) {
            src.push(&quot;out vec4 vWorldPosition;&quot;);
            src.push(&quot;out vec4 vFlags2;&quot;);
            if (clippingCaps) {
                src.push(&quot;out vec4 vClipPosition;&quot;);
            }
        }

        src.push(&quot;void main(void) {&quot;);

        // flags.x = NOT_RENDERED | COLOR_OPAQUE | COLOR_TRANSPARENT
        // renderPass = COLOR_OPAQUE | COLOR_TRANSPARENT

        src.push(`if (int(flags.x) != renderPass) {`);
        src.push(&quot;   gl_Position = vec4(0.0, 0.0, 0.0, 0.0);&quot;); // Cull vertex

        src.push(&quot;} else {&quot;);

        src.push(&quot;vec4 worldPosition =  positionsDecodeMatrix * vec4(position, 1.0); &quot;);
        src.push(&quot;worldPosition = worldMatrix * vec4(dot(worldPosition, modelMatrixCol0), dot(worldPosition, modelMatrixCol1), dot(worldPosition, modelMatrixCol2), 1.0);&quot;);
        if (scene.entityOffsetsEnabled) {
            src.push(&quot;      worldPosition.xyz = worldPosition.xyz + offset;&quot;);
        }

        src.push(&quot;vec4 viewPosition  = viewMatrix * worldPosition; &quot;);

        src.push(&quot;vec4 modelNormal = vec4(octDecode(normal.xy), 0.0); &quot;);
        src.push(&quot;vec4 worldNormal = worldNormalMatrix * vec4(dot(modelNormal, modelNormalMatrixCol0), dot(modelNormal, modelNormalMatrixCol1), dot(modelNormal, modelNormalMatrixCol2), 1.0);&quot;);
        src.push(&quot;vec3 viewNormal = vec4(viewNormalMatrix * worldNormal).xyz;&quot;);

        src.push(&quot;vec4 clipPos = projMatrix * viewPosition;&quot;);
        if (scene.logarithmicDepthBufferEnabled) {
            src.push(&quot;vFragDepth = 1.0 + clipPos.w;&quot;);
            src.push(&quot;isPerspective = float (isPerspectiveMatrix(projMatrix));&quot;);
        }

        if (clipping) {
            src.push(&quot;vWorldPosition = worldPosition;&quot;);
            src.push(&quot;vFlags2 = flags2;&quot;);
            if (clippingCaps) {
                src.push(&quot;vClipPosition = clipPos;&quot;);
            }
        }

        src.push(&quot;vViewPosition = viewPosition;&quot;);
        src.push(&quot;vViewNormal = viewNormal;&quot;);
        src.push(&quot;vColor = color;&quot;);
        src.push(&quot;vUV = (uvDecodeMatrix * vec3(uv, 1.0)).xy;&quot;);
        src.push(&quot;vMetallicRoughness = metallicRoughness;&quot;);

        if (lightsState.lightMaps.length &gt; 0) {
            src.push(&quot;vWorldNormal = worldNormal.xyz;&quot;);
        }

        src.push(&quot;gl_Position = clipPos;&quot;);
        src.push(&quot;}&quot;);
        src.push(&quot;}&quot;);
        return src;
    }

    _buildFragmentShader() {

        const scene = this._scene;
        const gammaOutput = scene.gammaOutput; // If set, then it expects that all textures and colors need to be outputted in premultiplied gamma. Default is false.
        const sectionPlanesState = scene._sectionPlanesState;
        const lightsState = scene._lightsState;
        const clipping = sectionPlanesState.sectionPlanes.length &gt; 0;
        const clippingCaps = sectionPlanesState.clippingCaps;
        const src = [];
        src.push(&quot;#version 300 es&quot;);
        src.push(&quot;// Instancing geometry quality drawing fragment shader&quot;);


        src.push(&quot;#ifdef GL_FRAGMENT_PRECISION_HIGH&quot;);
        src.push(&quot;precision highp float;&quot;);
        src.push(&quot;precision highp int;&quot;);
        src.push(&quot;#else&quot;);
        src.push(&quot;precision mediump float;&quot;);
        src.push(&quot;precision mediump int;&quot;);
        src.push(&quot;#endif&quot;);

        if (scene.logarithmicDepthBufferEnabled) {
            src.push(&quot;in float isPerspective;&quot;);
            src.push(&quot;uniform float logDepthBufFC;&quot;);
            src.push(&quot;in float vFragDepth;&quot;);
        }

        src.push(&quot;uniform sampler2D uBaseColorMap;&quot;);
        src.push(&quot;uniform sampler2D uMetallicRoughMap;&quot;);
        src.push(&quot;uniform sampler2D uEmissiveMap;&quot;);
        src.push(&quot;uniform sampler2D uNormalMap;&quot;);

        if (this._withSAO) {
            src.push(&quot;uniform sampler2D uOcclusionTexture;&quot;);
            src.push(&quot;uniform vec4      uSAOParams;&quot;);

            src.push(&quot;const float       packUpscale = 256. / 255.;&quot;);
            src.push(&quot;const float       unpackDownScale = 255. / 256.;&quot;);
            src.push(&quot;const vec3        packFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );&quot;);
            src.push(&quot;const vec4        unPackFactors = unpackDownScale / vec4( packFactors, 1. );&quot;);

            src.push(&quot;float unpackRGBToFloat( const in vec4 v ) {&quot;);
            src.push(&quot;    return dot( v, unPackFactors );&quot;);
            src.push(&quot;}&quot;);
        }

        if (lightsState.reflectionMaps.length &gt; 0) {
            src.push(&quot;uniform samplerCube reflectionMap;&quot;);
        }

        if (lightsState.lightMaps.length &gt; 0) {
            src.push(&quot;uniform samplerCube lightMap;&quot;);
        }

        src.push(&quot;uniform vec4 lightAmbient;&quot;);

        for (let i = 0, len = lightsState.lights.length; i &lt; len; i++) {
            const light = lightsState.lights[i];
            if (light.type === &quot;ambient&quot;) {
                continue;
            }
            src.push(&quot;uniform vec4 lightColor&quot; + i + &quot;;&quot;);
            if (light.type === &quot;dir&quot;) {
                src.push(&quot;uniform vec3 lightDir&quot; + i + &quot;;&quot;);
            }
            if (light.type === &quot;point&quot;) {
                src.push(&quot;uniform vec3 lightPos&quot; + i + &quot;;&quot;);
            }
            if (light.type === &quot;spot&quot;) {
                src.push(&quot;uniform vec3 lightPos&quot; + i + &quot;;&quot;);
                src.push(&quot;uniform vec3 lightDir&quot; + i + &quot;;&quot;);
            }
        }

        src.push(&quot;uniform float gammaFactor;&quot;);
        src.push(&quot;vec4 linearToLinear( in vec4 value ) {&quot;);
        src.push(&quot;  return value;&quot;);
        src.push(&quot;}&quot;);
        src.push(&quot;vec4 sRGBToLinear( in vec4 value ) {&quot;);
        src.push(&quot;  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );&quot;);
        src.push(&quot;}&quot;);
        src.push(&quot;vec4 gammaToLinear( in vec4 value) {&quot;);
        src.push(&quot;  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );&quot;);
        src.push(&quot;}&quot;);
        if (gammaOutput) {
            src.push(&quot;vec4 linearToGamma( in vec4 value, in float gammaFactor ) {&quot;);
            src.push(&quot;  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );&quot;);
            src.push(&quot;}&quot;);
        }

        if (clipping) {
            src.push(&quot;in vec4 vWorldPosition;&quot;);
            src.push(&quot;in vec4 vFlags2;&quot;);
            if (clippingCaps) {
                src.push(&quot;in vec4 vClipPosition;&quot;);
            }
            for (let i = 0, len = sectionPlanesState.sectionPlanes.length; i &lt; len; i++) {
                src.push(&quot;uniform bool sectionPlaneActive&quot; + i + &quot;;&quot;);
                src.push(&quot;uniform vec3 sectionPlanePos&quot; + i + &quot;;&quot;);
                src.push(&quot;uniform vec3 sectionPlaneDir&quot; + i + &quot;;&quot;);
            }
        }

        src.push(&quot;in vec4 vViewPosition;&quot;);
        src.push(&quot;in vec3 vViewNormal;&quot;);
        src.push(&quot;in vec4 vColor;&quot;);
        src.push(&quot;in vec2 vUV;&quot;);
        src.push(&quot;in vec2 vMetallicRoughness;&quot;);

        if (lightsState.lightMaps.length &gt; 0) {
            src.push(&quot;in vec3 vWorldNormal;&quot;);
        }

        src.push(&quot;uniform mat4 viewMatrix;&quot;);

        // CONSTANT DEFINITIONS

        src.push(&quot;#define PI 3.14159265359&quot;);
        src.push(&quot;#define RECIPROCAL_PI 0.31830988618&quot;);
        src.push(&quot;#define RECIPROCAL_PI2 0.15915494&quot;);
        src.push(&quot;#define EPSILON 1e-6&quot;);

        src.push(&quot;#define saturate(a) clamp( a, 0.0, 1.0 )&quot;);

        // UTILITY DEFINITIONS

        src.push(&quot;vec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {&quot;);
        src.push(&quot;       vec3 texel = texture( uNormalMap, uv ).xyz;&quot;);
        src.push(&quot;       if (texel.r == 0.0 &amp;&amp; texel.g == 0.0 &amp;&amp; texel.b == 0.0) {&quot;);
        src.push(&quot;              return normalize(surf_norm );&quot;);
        src.push(&quot;       }&quot;);
        src.push(&quot;      vec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );&quot;);
        src.push(&quot;      vec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );&quot;);
        src.push(&quot;      vec2 st0 = dFdx( uv.st );&quot;);
        src.push(&quot;      vec2 st1 = dFdy( uv.st );&quot;);
        src.push(&quot;      vec3 S = normalize( q0 * st1.t - q1 * st0.t );&quot;);
        src.push(&quot;      vec3 T = normalize( -q0 * st1.s + q1 * st0.s );&quot;);
        src.push(&quot;      vec3 N = normalize( surf_norm );&quot;);
        src.push(&quot;      vec3 mapN = texel.xyz * 2.0 - 1.0;&quot;);
        src.push(&quot;      mat3 tsn = mat3( S, T, N );&quot;);
        //     src.push(&quot;      mapN *= 3.0;&quot;);
        src.push(&quot;      return normalize( tsn * mapN );&quot;);
        src.push(&quot;}&quot;);

        src.push(&quot;vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {&quot;);
        src.push(&quot;   return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );&quot;);
        src.push(&quot;}&quot;);

        // STRUCTURES

        src.push(&quot;struct IncidentLight {&quot;);
        src.push(&quot;   vec3 color;&quot;);
        src.push(&quot;   vec3 direction;&quot;);
        src.push(&quot;};&quot;);

        src.push(&quot;struct ReflectedLight {&quot;);
        src.push(&quot;   vec3 diffuse;&quot;);
        src.push(&quot;   vec3 specular;&quot;);
        src.push(&quot;};&quot;);

        src.push(&quot;struct Geometry {&quot;);
        src.push(&quot;   vec3 position;&quot;);
        src.push(&quot;   vec3 viewNormal;&quot;);
        src.push(&quot;   vec3 worldNormal;&quot;);
        src.push(&quot;   vec3 viewEyeDir;&quot;);
        src.push(&quot;};&quot;);

        src.push(&quot;struct Material {&quot;);
        src.push(&quot;   vec3    diffuseColor;&quot;);
        src.push(&quot;   float   specularRoughness;&quot;);
        src.push(&quot;   vec3    specularColor;&quot;);
        src.push(&quot;   float   shine;&quot;); // Only used for Phong
        src.push(&quot;};&quot;);

        // IRRADIANCE EVALUATION

        src.push(&quot;float GGXRoughnessToBlinnExponent(const in float ggxRoughness) {&quot;);
        src.push(&quot;   float r = ggxRoughness + 0.0001;&quot;);
        src.push(&quot;   return (2.0 / (r * r) - 2.0);&quot;);
        src.push(&quot;}&quot;);

        src.push(&quot;float getSpecularMIPLevel(const in float blinnShininessExponent, const in int maxMIPLevel) {&quot;);
        src.push(&quot;   float maxMIPLevelScalar = float( maxMIPLevel );&quot;);
        src.push(&quot;   float desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( ( blinnShininessExponent * blinnShininessExponent ) + 1.0 );&quot;);
        src.push(&quot;   return clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );&quot;);
        src.push(&quot;}&quot;);

        if (lightsState.reflectionMaps.length &gt; 0) {
            src.push(&quot;vec3 getLightProbeIndirectRadiance(const in vec3 reflectVec, const in float blinnShininessExponent, const in int maxMIPLevel) {&quot;);
            src.push(&quot;   float mipLevel = 0.5 * getSpecularMIPLevel(blinnShininessExponent, maxMIPLevel);&quot;); //TODO: a random factor - fix this
            src.push(&quot;   vec3 envMapColor = &quot; + TEXTURE_DECODE_FUNCS[lightsState.reflectionMaps[0].encoding] + &quot;(texture(reflectionMap, reflectVec, mipLevel)).rgb;&quot;);
            src.push(&quot;  return envMapColor;&quot;);
            src.push(&quot;}&quot;);
        }

        // SPECULAR BRDF EVALUATION

        src.push(&quot;vec3 F_Schlick(const in vec3 specularColor, const in float dotLH) {&quot;);
        src.push(&quot;   float fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );&quot;);
        src.push(&quot;   return ( 1.0 - specularColor ) * fresnel + specularColor;&quot;);
        src.push(&quot;}&quot;);

        src.push(&quot;float G_GGX_Smith(const in float alpha, const in float dotNL, const in float dotNV) {&quot;);
        src.push(&quot;   float a2 = ( alpha * alpha );&quot;);
        src.push(&quot;   float gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );&quot;);
        src.push(&quot;   float gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );&quot;);
        src.push(&quot;   return 1.0 / ( gl * gv );&quot;);
        src.push(&quot;}&quot;);

        src.push(&quot;float G_GGX_SmithCorrelated(const in float alpha, const in float dotNL, const in float dotNV) {&quot;);
        src.push(&quot;   float a2 = ( alpha * alpha );&quot;);
        src.push(&quot;   float gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * ( dotNV * dotNV ) );&quot;);
        src.push(&quot;   float gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * ( dotNL * dotNL ) );&quot;);
        src.push(&quot;   return 0.5 / max( gv + gl, EPSILON );&quot;);
        src.push(&quot;}&quot;);

        src.push(&quot;float D_GGX(const in float alpha, const in float dotNH) {&quot;);
        src.push(&quot;   float a2 = ( alpha * alpha );&quot;);
        src.push(&quot;   float denom = ( dotNH * dotNH) * ( a2 - 1.0 ) + 1.0;&quot;);
        src.push(&quot;   return RECIPROCAL_PI * a2 / ( denom * denom);&quot;);
        src.push(&quot;}&quot;);

        src.push(&quot;vec3 BRDF_Specular_GGX(const in IncidentLight incidentLight, const in Geometry geometry, const in vec3 specularColor, const in float roughness) {&quot;);
        src.push(&quot;   float alpha = ( roughness * roughness );&quot;);
        src.push(&quot;   vec3 halfDir = normalize( incidentLight.direction + geometry.viewEyeDir );&quot;);
        src.push(&quot;   float dotNL = saturate( dot( geometry.viewNormal, incidentLight.direction ) );&quot;);
        src.push(&quot;   float dotNV = saturate( dot( geometry.viewNormal, geometry.viewEyeDir ) );&quot;);
        src.push(&quot;   float dotNH = saturate( dot( geometry.viewNormal, halfDir ) );&quot;);
        src.push(&quot;   float dotLH = saturate( dot( incidentLight.direction, halfDir ) );&quot;);
        src.push(&quot;   vec3  F = F_Schlick( specularColor, dotLH );&quot;);
        src.push(&quot;   float G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );&quot;);
        src.push(&quot;   float D = D_GGX( alpha, dotNH );&quot;);
        src.push(&quot;   return F * (G * D);&quot;);
        src.push(&quot;}&quot;);

        src.push(&quot;vec3 BRDF_Specular_GGX_Environment(const in Geometry geometry, const in vec3 specularColor, const in float roughness) {&quot;);
        src.push(&quot;   float dotNV = saturate(dot(geometry.viewNormal, geometry.viewEyeDir));&quot;);
        src.push(&quot;   const vec4 c0 = vec4( -1, -0.0275, -0.572,  0.022);&quot;);
        src.push(&quot;   const vec4 c1 = vec4(  1,  0.0425,   1.04, -0.04);&quot;);
        src.push(&quot;   vec4 r = roughness * c0 + c1;&quot;);
        src.push(&quot;   float a004 = min(r.x * r.x, exp2(-9.28 * dotNV)) * r.x + r.y;&quot;);
        src.push(&quot;   vec2 AB    = vec2(-1.04, 1.04) * a004 + r.zw;&quot;);
        src.push(&quot;   return specularColor * AB.x + AB.y;&quot;);
        src.push(&quot;}&quot;);

        if (lightsState.lightMaps.length &gt; 0 || lightsState.reflectionMaps.length &gt; 0) {

            src.push(&quot;void computePBRLightMapping(const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {&quot;);

            if (lightsState.lightMaps.length &gt; 0) {
                src.push(&quot;   vec3 irradiance = &quot; + TEXTURE_DECODE_FUNCS[lightsState.lightMaps[0].encoding] + &quot;(texture(lightMap, geometry.worldNormal)).rgb;&quot;);
                src.push(&quot;   irradiance *= PI;&quot;);
                src.push(&quot;   vec3 diffuseBRDFContrib = (RECIPROCAL_PI * material.diffuseColor);&quot;);
                src.push(&quot;   reflectedLight.diffuse += irradiance * diffuseBRDFContrib;&quot;);
            }

            if (lightsState.reflectionMaps.length &gt; 0) {
                src.push(&quot;   vec3 reflectVec             = reflect(geometry.viewEyeDir, geometry.viewNormal);&quot;);
                src.push(&quot;   reflectVec                  = inverseTransformDirection(reflectVec, viewMatrix);&quot;);
                src.push(&quot;   float blinnExpFromRoughness = GGXRoughnessToBlinnExponent(material.specularRoughness);&quot;);
                src.push(&quot;   vec3 radiance               = getLightProbeIndirectRadiance(reflectVec, blinnExpFromRoughness, 8);&quot;);
                src.push(&quot;   vec3 specularBRDFContrib    = BRDF_Specular_GGX_Environment(geometry, material.specularColor, material.specularRoughness);&quot;);
                src.push(&quot;   reflectedLight.specular     += radiance * specularBRDFContrib;&quot;);
            }

            src.push(&quot;}&quot;);
        }

        // MAIN LIGHTING COMPUTATION FUNCTION

        src.push(&quot;void computePBRLighting(const in IncidentLight incidentLight, const in Geometry geometry, const in Material material, inout ReflectedLight reflectedLight) {&quot;);
        src.push(&quot;   float dotNL     = saturate(dot(geometry.viewNormal, incidentLight.direction));&quot;);
        src.push(&quot;   vec3 irradiance = dotNL * incidentLight.color * PI;&quot;);
        src.push(&quot;   reflectedLight.diffuse  += irradiance * (RECIPROCAL_PI * material.diffuseColor);&quot;);
        src.push(&quot;   reflectedLight.specular += irradiance * BRDF_Specular_GGX(incidentLight, geometry, material.specularColor, material.specularRoughness);&quot;);
        src.push(&quot;}&quot;);

        src.push(&quot;out vec4 outColor;&quot;);

        src.push(&quot;void main(void) {&quot;);

        if (clipping) {
            src.push(&quot;  bool clippable = (float(vFlags2.x) &gt; 0.0);&quot;);
            src.push(&quot;  if (clippable) {&quot;);
            src.push(&quot;  float dist = 0.0;&quot;);
            for (let i = 0, len = sectionPlanesState.sectionPlanes.length; i &lt; len; i++) {
                src.push(&quot;if (sectionPlaneActive&quot; + i + &quot;) {&quot;);
                src.push(&quot;   dist += clamp(dot(-sectionPlaneDir&quot; + i + &quot;.xyz, vWorldPosition.xyz - sectionPlanePos&quot; + i + &quot;.xyz), 0.0, 1000.0);&quot;);
                src.push(&quot;}&quot;);
            }
            if (clippingCaps) {
                src.push(&quot;  if (dist &gt; (0.002 * vClipPosition.w)) {&quot;);
                src.push(&quot;      discard;&quot;);
                src.push(&quot;  }&quot;);
                src.push(&quot;  if (dist &gt; 0.0) { &quot;);
                src.push(&quot;      outColor=vec4(1.0, 0.0, 0.0, 1.0);&quot;);
                if (scene.logarithmicDepthBufferEnabled) {
                    src.push(&quot;  gl_FragDepth = log2( vFragDepth ) * logDepthBufFC * 0.5;&quot;);
                }
                src.push(&quot;  return;&quot;);
                src.push(&quot;}&quot;);
            } else {
                src.push(&quot;  if (dist &gt; 0.0) { &quot;);
                src.push(&quot;      discard;&quot;)
                src.push(&quot;  }&quot;);
            }
            src.push(&quot;}&quot;);
        }

        src.push(&quot;IncidentLight  light;&quot;);
        src.push(&quot;Material       material;&quot;);
        src.push(&quot;Geometry       geometry;&quot;);
        src.push(&quot;ReflectedLight reflectedLight = ReflectedLight(vec3(0.0,0.0,0.0), vec3(0.0,0.0,0.0));&quot;);

        src.push(&quot;vec3 rgb = (vec3(float(vColor.r) / 255.0, float(vColor.g) / 255.0, float(vColor.b) / 255.0));&quot;);
        src.push(&quot;float opacity = float(vColor.a) / 255.0;&quot;);

        src.push(&quot;vec3  baseColor = rgb;&quot;);
        src.push(&quot;float specularF0 = 1.0;&quot;);
        src.push(&quot;float metallic = float(vMetallicRoughness.r) / 255.0;&quot;);
        src.push(&quot;float roughness = float(vMetallicRoughness.g) / 255.0;&quot;);
        src.push(&quot;float dielectricSpecular = 0.16 * specularF0 * specularF0;&quot;);

        src.push(&quot;vec4 baseColorTexel = sRGBToLinear(texture(uBaseColorMap, vUV));&quot;);
        src.push(&quot;baseColor *= baseColorTexel.rgb;&quot;);
        // src.push(&quot;opacity = baseColorTexel.a;&quot;);

        src.push(&quot;vec3 metalRoughTexel = texture(uMetallicRoughMap, vUV).rgb;&quot;);
        src.push(&quot;metallic *= metalRoughTexel.b;&quot;);
        src.push(&quot;roughness *= metalRoughTexel.g;&quot;);

        src.push(&quot;vec3 viewNormal = perturbNormal2Arb( vViewPosition.xyz, normalize(vViewNormal), vUV );&quot;);

        src.push(&quot;material.diffuseColor      = baseColor * (1.0 - dielectricSpecular) * (1.0 - metallic);&quot;);
        src.push(&quot;material.specularRoughness = clamp(roughness, 0.04, 1.0);&quot;);
        src.push(&quot;material.specularColor     = mix(vec3(dielectricSpecular), baseColor, metallic);&quot;);

        src.push(&quot;geometry.position      = vViewPosition.xyz;&quot;);
        src.push(&quot;geometry.viewNormal    = -normalize(viewNormal);&quot;);
        src.push(&quot;geometry.viewEyeDir    = normalize(vViewPosition.xyz);&quot;);

        if (lightsState.lightMaps.length &gt; 0) {
            src.push(&quot;geometry.worldNormal   = normalize(vWorldNormal);&quot;);
        }

        if (lightsState.lightMaps.length &gt; 0 || lightsState.reflectionMaps.length &gt; 0) {
            src.push(&quot;computePBRLightMapping(geometry, material, reflectedLight);&quot;);
        }

        for (let i = 0, len = lightsState.lights.length; i &lt; len; i++) {

            const light = lightsState.lights[i];

            if (light.type === &quot;ambient&quot;) {
                continue;
            }
            if (light.type === &quot;dir&quot;) {
                if (light.space === &quot;view&quot;) {
                    src.push(&quot;light.direction = normalize(lightDir&quot; + i + &quot;);&quot;);
                } else {
                    src.push(&quot;light.direction = normalize((viewMatrix * vec4(lightDir&quot; + i + &quot;, 0.0)).xyz);&quot;);
                }
            } else if (light.type === &quot;point&quot;) {
                if (light.space === &quot;view&quot;) {
                    src.push(&quot;light.direction = normalize(lightPos&quot; + i + &quot; - vViewPosition.xyz);&quot;);
                } else {
                    src.push(&quot;light.direction = normalize((viewMatrix * vec4(lightPos&quot; + i + &quot;, 0.0)).xyz);&quot;);
                }
            } else if (light.type === &quot;spot&quot;) {
                if (light.space === &quot;view&quot;) {
                    src.push(&quot;light.direction = normalize(lightDir&quot; + i + &quot;);&quot;);
                } else {
                    src.push(&quot;light.direction = normalize((viewMatrix * vec4(lightDir&quot; + i + &quot;, 0.0)).xyz);&quot;);
                }
            } else {
                continue;
            }

            src.push(&quot;light.color =  lightColor&quot; + i + &quot;.rgb * lightColor&quot; + i + &quot;.a;&quot;); // a is intensity

            src.push(&quot;computePBRLighting(light, geometry, material, reflectedLight);&quot;);
        }

        src.push(&quot;vec3 emissiveColor = sRGBToLinear(texture(uEmissiveMap, vUV)).rgb;&quot;); // TODO: correct gamma function

        src.push(&quot;vec3 outgoingLight = (lightAmbient.rgb * lightAmbient.a * baseColor * opacity * rgb) + (reflectedLight.diffuse) + (reflectedLight.specular) + emissiveColor;&quot;);
        src.push(&quot;vec4 fragColor;&quot;);

        if (this._withSAO) {
            // Doing SAO blend in the main solid fill draw shader just so that edge lines can be drawn over the top
            // Would be more efficient to defer this, then render lines later, using same depth buffer for Z-reject
            src.push(&quot;   float viewportWidth     = uSAOParams[0];&quot;);
            src.push(&quot;   float viewportHeight    = uSAOParams[1];&quot;);
            src.push(&quot;   float blendCutoff       = uSAOParams[2];&quot;);
            src.push(&quot;   float blendFactor       = uSAOParams[3];&quot;);
            src.push(&quot;   vec2 uv                 = vec2(gl_FragCoord.x / viewportWidth, gl_FragCoord.y / viewportHeight);&quot;);
            src.push(&quot;   float ambient           = smoothstep(blendCutoff, 1.0, unpackRGBToFloat(texture(uOcclusionTexture, uv))) * blendFactor;&quot;);
            src.push(&quot;   fragColor            = vec4(outgoingLight.rgb * ambient, opacity);&quot;);
        } else {
            src.push(&quot;   fragColor            = vec4(outgoingLight.rgb, opacity);&quot;);
        }

        if (gammaOutput) {
            src.push(&quot;fragColor = linearToGamma(fragColor, gammaFactor);&quot;);
        }

        src.push(&quot;outColor = fragColor;&quot;);

        if (scene.logarithmicDepthBufferEnabled) {
            src.push(&quot;    gl_FragDepth = isPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;&quot;);
        }

        src.push(&quot;}&quot;);
        return src;
    }

    webglContextRestored() {
        this._program = null;
    }

    destroy() {
        if (this._program) {
            this._program.destroy();
        }
        this._program = null;
    }
}

export {TrianglesInstancingPBRRenderer};</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
